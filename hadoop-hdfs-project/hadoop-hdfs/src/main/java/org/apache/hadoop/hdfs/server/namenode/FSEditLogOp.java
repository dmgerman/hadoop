begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/**  * Licensed to the Apache Software Foundation (ASF) under one  * or more contributor license agreements.  See the NOTICE file  * distributed with this work for additional information  * regarding copyright ownership.  The ASF licenses this file  * to you under the Apache License, Version 2.0 (the  * "License"); you may not use this file except in compliance  * with the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
DECL|package|org.apache.hadoop.hdfs.server.namenode
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|server
operator|.
name|namenode
package|;
end_package

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|zip
operator|.
name|CheckedInputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|zip
operator|.
name|Checksum
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Arrays
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|EnumMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|codec
operator|.
name|DecoderException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|codec
operator|.
name|binary
operator|.
name|Hex
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|ChecksumException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|classification
operator|.
name|InterfaceAudience
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|classification
operator|.
name|InterfaceStability
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|security
operator|.
name|token
operator|.
name|delegation
operator|.
name|DelegationTokenIdentifier
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|Options
operator|.
name|Rename
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|permission
operator|.
name|FsPermission
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|permission
operator|.
name|PermissionStatus
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|Block
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|DatanodeID
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|HdfsConstants
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|LayoutVersion
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|LayoutVersion
operator|.
name|Feature
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|util
operator|.
name|PureJavaCrc32
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|server
operator|.
name|namenode
operator|.
name|FSEditLogOpCodes
operator|.
name|*
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|token
operator|.
name|delegation
operator|.
name|DelegationKey
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|BytesWritable
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|DataOutputBuffer
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|ArrayWritable
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|Text
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|Writable
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|WritableFactories
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|WritableFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|util
operator|.
name|XMLUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|util
operator|.
name|XMLUtils
operator|.
name|InvalidXmlException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|util
operator|.
name|XMLUtils
operator|.
name|Stanza
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|DeprecatedUTF8
import|;
end_import

begin_import
import|import
name|org
operator|.
name|xml
operator|.
name|sax
operator|.
name|ContentHandler
import|;
end_import

begin_import
import|import
name|org
operator|.
name|xml
operator|.
name|sax
operator|.
name|SAXException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|xml
operator|.
name|sax
operator|.
name|helpers
operator|.
name|AttributesImpl
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|base
operator|.
name|Preconditions
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|DataInput
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|DataOutput
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|DataInputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|DataOutputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|EOFException
import|;
end_import

begin_comment
comment|/**  * Helper classes for reading the ops from an InputStream.  * All ops derive from FSEditLogOp and are only  * instantiated from Reader#readOp()  */
end_comment

begin_class
annotation|@
name|InterfaceAudience
operator|.
name|Private
annotation|@
name|InterfaceStability
operator|.
name|Unstable
DECL|class|FSEditLogOp
specifier|public
specifier|abstract
class|class
name|FSEditLogOp
block|{
DECL|field|opCode
specifier|public
specifier|final
name|FSEditLogOpCodes
name|opCode
decl_stmt|;
DECL|field|txid
name|long
name|txid
decl_stmt|;
comment|/**    * Opcode size is limited to 1.5 megabytes    */
DECL|field|MAX_OP_SIZE
specifier|public
specifier|static
specifier|final
name|int
name|MAX_OP_SIZE
init|=
operator|(
literal|3
operator|*
literal|1024
operator|*
literal|1024
operator|)
operator|/
literal|2
decl_stmt|;
annotation|@
name|SuppressWarnings
argument_list|(
literal|"deprecation"
argument_list|)
DECL|class|OpInstanceCache
specifier|final
specifier|public
specifier|static
class|class
name|OpInstanceCache
block|{
DECL|field|inst
specifier|private
name|EnumMap
argument_list|<
name|FSEditLogOpCodes
argument_list|,
name|FSEditLogOp
argument_list|>
name|inst
init|=
operator|new
name|EnumMap
argument_list|<
name|FSEditLogOpCodes
argument_list|,
name|FSEditLogOp
argument_list|>
argument_list|(
name|FSEditLogOpCodes
operator|.
name|class
argument_list|)
decl_stmt|;
DECL|method|OpInstanceCache ()
specifier|public
name|OpInstanceCache
parameter_list|()
block|{
name|inst
operator|.
name|put
argument_list|(
name|OP_ADD
argument_list|,
operator|new
name|AddOp
argument_list|()
argument_list|)
expr_stmt|;
name|inst
operator|.
name|put
argument_list|(
name|OP_CLOSE
argument_list|,
operator|new
name|CloseOp
argument_list|()
argument_list|)
expr_stmt|;
name|inst
operator|.
name|put
argument_list|(
name|OP_SET_REPLICATION
argument_list|,
operator|new
name|SetReplicationOp
argument_list|()
argument_list|)
expr_stmt|;
name|inst
operator|.
name|put
argument_list|(
name|OP_CONCAT_DELETE
argument_list|,
operator|new
name|ConcatDeleteOp
argument_list|()
argument_list|)
expr_stmt|;
name|inst
operator|.
name|put
argument_list|(
name|OP_RENAME_OLD
argument_list|,
operator|new
name|RenameOldOp
argument_list|()
argument_list|)
expr_stmt|;
name|inst
operator|.
name|put
argument_list|(
name|OP_DELETE
argument_list|,
operator|new
name|DeleteOp
argument_list|()
argument_list|)
expr_stmt|;
name|inst
operator|.
name|put
argument_list|(
name|OP_MKDIR
argument_list|,
operator|new
name|MkdirOp
argument_list|()
argument_list|)
expr_stmt|;
name|inst
operator|.
name|put
argument_list|(
name|OP_SET_GENSTAMP
argument_list|,
operator|new
name|SetGenstampOp
argument_list|()
argument_list|)
expr_stmt|;
name|inst
operator|.
name|put
argument_list|(
name|OP_SET_PERMISSIONS
argument_list|,
operator|new
name|SetPermissionsOp
argument_list|()
argument_list|)
expr_stmt|;
name|inst
operator|.
name|put
argument_list|(
name|OP_SET_OWNER
argument_list|,
operator|new
name|SetOwnerOp
argument_list|()
argument_list|)
expr_stmt|;
name|inst
operator|.
name|put
argument_list|(
name|OP_SET_NS_QUOTA
argument_list|,
operator|new
name|SetNSQuotaOp
argument_list|()
argument_list|)
expr_stmt|;
name|inst
operator|.
name|put
argument_list|(
name|OP_CLEAR_NS_QUOTA
argument_list|,
operator|new
name|ClearNSQuotaOp
argument_list|()
argument_list|)
expr_stmt|;
name|inst
operator|.
name|put
argument_list|(
name|OP_SET_QUOTA
argument_list|,
operator|new
name|SetQuotaOp
argument_list|()
argument_list|)
expr_stmt|;
name|inst
operator|.
name|put
argument_list|(
name|OP_TIMES
argument_list|,
operator|new
name|TimesOp
argument_list|()
argument_list|)
expr_stmt|;
name|inst
operator|.
name|put
argument_list|(
name|OP_SYMLINK
argument_list|,
operator|new
name|SymlinkOp
argument_list|()
argument_list|)
expr_stmt|;
name|inst
operator|.
name|put
argument_list|(
name|OP_RENAME
argument_list|,
operator|new
name|RenameOp
argument_list|()
argument_list|)
expr_stmt|;
name|inst
operator|.
name|put
argument_list|(
name|OP_REASSIGN_LEASE
argument_list|,
operator|new
name|ReassignLeaseOp
argument_list|()
argument_list|)
expr_stmt|;
name|inst
operator|.
name|put
argument_list|(
name|OP_GET_DELEGATION_TOKEN
argument_list|,
operator|new
name|GetDelegationTokenOp
argument_list|()
argument_list|)
expr_stmt|;
name|inst
operator|.
name|put
argument_list|(
name|OP_RENEW_DELEGATION_TOKEN
argument_list|,
operator|new
name|RenewDelegationTokenOp
argument_list|()
argument_list|)
expr_stmt|;
name|inst
operator|.
name|put
argument_list|(
name|OP_CANCEL_DELEGATION_TOKEN
argument_list|,
operator|new
name|CancelDelegationTokenOp
argument_list|()
argument_list|)
expr_stmt|;
name|inst
operator|.
name|put
argument_list|(
name|OP_UPDATE_MASTER_KEY
argument_list|,
operator|new
name|UpdateMasterKeyOp
argument_list|()
argument_list|)
expr_stmt|;
name|inst
operator|.
name|put
argument_list|(
name|OP_START_LOG_SEGMENT
argument_list|,
operator|new
name|LogSegmentOp
argument_list|(
name|OP_START_LOG_SEGMENT
argument_list|)
argument_list|)
expr_stmt|;
name|inst
operator|.
name|put
argument_list|(
name|OP_END_LOG_SEGMENT
argument_list|,
operator|new
name|LogSegmentOp
argument_list|(
name|OP_END_LOG_SEGMENT
argument_list|)
argument_list|)
expr_stmt|;
name|inst
operator|.
name|put
argument_list|(
name|OP_UPDATE_BLOCKS
argument_list|,
operator|new
name|UpdateBlocksOp
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|get (FSEditLogOpCodes opcode)
specifier|public
name|FSEditLogOp
name|get
parameter_list|(
name|FSEditLogOpCodes
name|opcode
parameter_list|)
block|{
return|return
name|inst
operator|.
name|get
argument_list|(
name|opcode
argument_list|)
return|;
block|}
block|}
comment|/**    * Constructor for an EditLog Op. EditLog ops cannot be constructed    * directly, but only through Reader#readOp.    */
DECL|method|FSEditLogOp (FSEditLogOpCodes opCode)
specifier|private
name|FSEditLogOp
parameter_list|(
name|FSEditLogOpCodes
name|opCode
parameter_list|)
block|{
name|this
operator|.
name|opCode
operator|=
name|opCode
expr_stmt|;
name|this
operator|.
name|txid
operator|=
name|HdfsConstants
operator|.
name|INVALID_TXID
expr_stmt|;
block|}
DECL|method|getTransactionId ()
specifier|public
name|long
name|getTransactionId
parameter_list|()
block|{
name|Preconditions
operator|.
name|checkState
argument_list|(
name|txid
operator|!=
name|HdfsConstants
operator|.
name|INVALID_TXID
argument_list|)
expr_stmt|;
return|return
name|txid
return|;
block|}
DECL|method|getTransactionIdStr ()
specifier|public
name|String
name|getTransactionIdStr
parameter_list|()
block|{
return|return
operator|(
name|txid
operator|==
name|HdfsConstants
operator|.
name|INVALID_TXID
operator|)
condition|?
literal|"(none)"
else|:
literal|""
operator|+
name|txid
return|;
block|}
DECL|method|hasTransactionId ()
specifier|public
name|boolean
name|hasTransactionId
parameter_list|()
block|{
return|return
operator|(
name|txid
operator|!=
name|HdfsConstants
operator|.
name|INVALID_TXID
operator|)
return|;
block|}
DECL|method|setTransactionId (long txid)
specifier|public
name|void
name|setTransactionId
parameter_list|(
name|long
name|txid
parameter_list|)
block|{
name|this
operator|.
name|txid
operator|=
name|txid
expr_stmt|;
block|}
DECL|method|readFields (DataInputStream in, int logVersion)
specifier|abstract
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
function_decl|;
DECL|method|writeFields (DataOutputStream out)
specifier|public
specifier|abstract
name|void
name|writeFields
parameter_list|(
name|DataOutputStream
name|out
parameter_list|)
throws|throws
name|IOException
function_decl|;
DECL|interface|BlockListUpdatingOp
specifier|static
interface|interface
name|BlockListUpdatingOp
block|{
DECL|method|getBlocks ()
name|Block
index|[]
name|getBlocks
parameter_list|()
function_decl|;
DECL|method|getPath ()
name|String
name|getPath
parameter_list|()
function_decl|;
DECL|method|shouldCompleteLastBlock ()
name|boolean
name|shouldCompleteLastBlock
parameter_list|()
function_decl|;
block|}
annotation|@
name|SuppressWarnings
argument_list|(
literal|"unchecked"
argument_list|)
DECL|class|AddCloseOp
specifier|static
specifier|abstract
class|class
name|AddCloseOp
extends|extends
name|FSEditLogOp
implements|implements
name|BlockListUpdatingOp
block|{
DECL|field|length
name|int
name|length
decl_stmt|;
DECL|field|path
name|String
name|path
decl_stmt|;
DECL|field|replication
name|short
name|replication
decl_stmt|;
DECL|field|mtime
name|long
name|mtime
decl_stmt|;
DECL|field|atime
name|long
name|atime
decl_stmt|;
DECL|field|blockSize
name|long
name|blockSize
decl_stmt|;
DECL|field|blocks
name|Block
index|[]
name|blocks
decl_stmt|;
DECL|field|permissions
name|PermissionStatus
name|permissions
decl_stmt|;
DECL|field|clientName
name|String
name|clientName
decl_stmt|;
DECL|field|clientMachine
name|String
name|clientMachine
decl_stmt|;
DECL|method|AddCloseOp (FSEditLogOpCodes opCode)
specifier|private
name|AddCloseOp
parameter_list|(
name|FSEditLogOpCodes
name|opCode
parameter_list|)
block|{
name|super
argument_list|(
name|opCode
argument_list|)
expr_stmt|;
assert|assert
operator|(
name|opCode
operator|==
name|OP_ADD
operator|||
name|opCode
operator|==
name|OP_CLOSE
operator|)
assert|;
block|}
DECL|method|setPath (String path)
parameter_list|<
name|T
extends|extends
name|AddCloseOp
parameter_list|>
name|T
name|setPath
parameter_list|(
name|String
name|path
parameter_list|)
block|{
name|this
operator|.
name|path
operator|=
name|path
expr_stmt|;
return|return
operator|(
name|T
operator|)
name|this
return|;
block|}
DECL|method|getPath ()
specifier|public
name|String
name|getPath
parameter_list|()
block|{
return|return
name|path
return|;
block|}
DECL|method|setReplication (short replication)
parameter_list|<
name|T
extends|extends
name|AddCloseOp
parameter_list|>
name|T
name|setReplication
parameter_list|(
name|short
name|replication
parameter_list|)
block|{
name|this
operator|.
name|replication
operator|=
name|replication
expr_stmt|;
return|return
operator|(
name|T
operator|)
name|this
return|;
block|}
DECL|method|setModificationTime (long mtime)
parameter_list|<
name|T
extends|extends
name|AddCloseOp
parameter_list|>
name|T
name|setModificationTime
parameter_list|(
name|long
name|mtime
parameter_list|)
block|{
name|this
operator|.
name|mtime
operator|=
name|mtime
expr_stmt|;
return|return
operator|(
name|T
operator|)
name|this
return|;
block|}
DECL|method|setAccessTime (long atime)
parameter_list|<
name|T
extends|extends
name|AddCloseOp
parameter_list|>
name|T
name|setAccessTime
parameter_list|(
name|long
name|atime
parameter_list|)
block|{
name|this
operator|.
name|atime
operator|=
name|atime
expr_stmt|;
return|return
operator|(
name|T
operator|)
name|this
return|;
block|}
DECL|method|setBlockSize (long blockSize)
parameter_list|<
name|T
extends|extends
name|AddCloseOp
parameter_list|>
name|T
name|setBlockSize
parameter_list|(
name|long
name|blockSize
parameter_list|)
block|{
name|this
operator|.
name|blockSize
operator|=
name|blockSize
expr_stmt|;
return|return
operator|(
name|T
operator|)
name|this
return|;
block|}
DECL|method|setBlocks (Block[] blocks)
parameter_list|<
name|T
extends|extends
name|AddCloseOp
parameter_list|>
name|T
name|setBlocks
parameter_list|(
name|Block
index|[]
name|blocks
parameter_list|)
block|{
if|if
condition|(
name|blocks
operator|.
name|length
operator|>
name|MAX_BLOCKS
condition|)
block|{
throw|throw
operator|new
name|RuntimeException
argument_list|(
literal|"Can't have more than "
operator|+
name|MAX_BLOCKS
operator|+
literal|" in an AddCloseOp."
argument_list|)
throw|;
block|}
name|this
operator|.
name|blocks
operator|=
name|blocks
expr_stmt|;
return|return
operator|(
name|T
operator|)
name|this
return|;
block|}
DECL|method|getBlocks ()
specifier|public
name|Block
index|[]
name|getBlocks
parameter_list|()
block|{
return|return
name|blocks
return|;
block|}
DECL|method|setPermissionStatus (PermissionStatus permissions)
parameter_list|<
name|T
extends|extends
name|AddCloseOp
parameter_list|>
name|T
name|setPermissionStatus
parameter_list|(
name|PermissionStatus
name|permissions
parameter_list|)
block|{
name|this
operator|.
name|permissions
operator|=
name|permissions
expr_stmt|;
return|return
operator|(
name|T
operator|)
name|this
return|;
block|}
DECL|method|setClientName (String clientName)
parameter_list|<
name|T
extends|extends
name|AddCloseOp
parameter_list|>
name|T
name|setClientName
parameter_list|(
name|String
name|clientName
parameter_list|)
block|{
name|this
operator|.
name|clientName
operator|=
name|clientName
expr_stmt|;
return|return
operator|(
name|T
operator|)
name|this
return|;
block|}
DECL|method|setClientMachine (String clientMachine)
parameter_list|<
name|T
extends|extends
name|AddCloseOp
parameter_list|>
name|T
name|setClientMachine
parameter_list|(
name|String
name|clientMachine
parameter_list|)
block|{
name|this
operator|.
name|clientMachine
operator|=
name|clientMachine
expr_stmt|;
return|return
operator|(
name|T
operator|)
name|this
return|;
block|}
annotation|@
name|Override
specifier|public
DECL|method|writeFields (DataOutputStream out)
name|void
name|writeFields
parameter_list|(
name|DataOutputStream
name|out
parameter_list|)
throws|throws
name|IOException
block|{
name|FSImageSerialization
operator|.
name|writeString
argument_list|(
name|path
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|FSImageSerialization
operator|.
name|writeShort
argument_list|(
name|replication
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|FSImageSerialization
operator|.
name|writeLong
argument_list|(
name|mtime
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|FSImageSerialization
operator|.
name|writeLong
argument_list|(
name|atime
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|FSImageSerialization
operator|.
name|writeLong
argument_list|(
name|blockSize
argument_list|,
name|out
argument_list|)
expr_stmt|;
operator|new
name|ArrayWritable
argument_list|(
name|Block
operator|.
name|class
argument_list|,
name|blocks
argument_list|)
operator|.
name|write
argument_list|(
name|out
argument_list|)
expr_stmt|;
name|permissions
operator|.
name|write
argument_list|(
name|out
argument_list|)
expr_stmt|;
if|if
condition|(
name|this
operator|.
name|opCode
operator|==
name|OP_ADD
condition|)
block|{
name|FSImageSerialization
operator|.
name|writeString
argument_list|(
name|clientName
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|FSImageSerialization
operator|.
name|writeString
argument_list|(
name|clientMachine
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|readFields (DataInputStream in, int logVersion)
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
operator|!
name|LayoutVersion
operator|.
name|supports
argument_list|(
name|Feature
operator|.
name|EDITLOG_OP_OPTIMIZATION
argument_list|,
name|logVersion
argument_list|)
condition|)
block|{
name|this
operator|.
name|length
operator|=
name|in
operator|.
name|readInt
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|-
literal|17
operator|<
name|logVersion
operator|&&
name|length
operator|!=
literal|4
operator|)
operator|||
operator|(
name|logVersion
operator|<=
operator|-
literal|17
operator|&&
name|length
operator|!=
literal|5
operator|&&
operator|!
name|LayoutVersion
operator|.
name|supports
argument_list|(
name|Feature
operator|.
name|EDITLOG_OP_OPTIMIZATION
argument_list|,
name|logVersion
argument_list|)
operator|)
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Incorrect data format."
operator|+
literal|" logVersion is "
operator|+
name|logVersion
operator|+
literal|" but writables.length is "
operator|+
name|length
operator|+
literal|". "
argument_list|)
throw|;
block|}
name|this
operator|.
name|path
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
if|if
condition|(
name|LayoutVersion
operator|.
name|supports
argument_list|(
name|Feature
operator|.
name|EDITLOG_OP_OPTIMIZATION
argument_list|,
name|logVersion
argument_list|)
condition|)
block|{
name|this
operator|.
name|replication
operator|=
name|FSImageSerialization
operator|.
name|readShort
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|mtime
operator|=
name|FSImageSerialization
operator|.
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|replication
operator|=
name|readShort
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|mtime
operator|=
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|LayoutVersion
operator|.
name|supports
argument_list|(
name|Feature
operator|.
name|FILE_ACCESS_TIME
argument_list|,
name|logVersion
argument_list|)
condition|)
block|{
if|if
condition|(
name|LayoutVersion
operator|.
name|supports
argument_list|(
name|Feature
operator|.
name|EDITLOG_OP_OPTIMIZATION
argument_list|,
name|logVersion
argument_list|)
condition|)
block|{
name|this
operator|.
name|atime
operator|=
name|FSImageSerialization
operator|.
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|atime
operator|=
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|this
operator|.
name|atime
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|LayoutVersion
operator|.
name|supports
argument_list|(
name|Feature
operator|.
name|EDITLOG_OP_OPTIMIZATION
argument_list|,
name|logVersion
argument_list|)
condition|)
block|{
name|this
operator|.
name|blockSize
operator|=
name|FSImageSerialization
operator|.
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|blockSize
operator|=
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
name|this
operator|.
name|blocks
operator|=
name|readBlocks
argument_list|(
name|in
argument_list|,
name|logVersion
argument_list|)
expr_stmt|;
name|this
operator|.
name|permissions
operator|=
name|PermissionStatus
operator|.
name|read
argument_list|(
name|in
argument_list|)
expr_stmt|;
comment|// clientname, clientMachine and block locations of last block.
if|if
condition|(
name|this
operator|.
name|opCode
operator|==
name|OP_ADD
condition|)
block|{
name|this
operator|.
name|clientName
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|clientMachine
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|clientName
operator|=
literal|""
expr_stmt|;
name|this
operator|.
name|clientMachine
operator|=
literal|""
expr_stmt|;
block|}
block|}
DECL|field|MAX_BLOCKS
specifier|static
specifier|final
specifier|public
name|int
name|MAX_BLOCKS
init|=
literal|1024
operator|*
literal|1024
operator|*
literal|64
decl_stmt|;
DECL|method|readBlocks ( DataInputStream in, int logVersion)
specifier|private
specifier|static
name|Block
index|[]
name|readBlocks
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|int
name|numBlocks
init|=
name|in
operator|.
name|readInt
argument_list|()
decl_stmt|;
if|if
condition|(
name|numBlocks
operator|<
literal|0
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"invalid negative number of blocks"
argument_list|)
throw|;
block|}
elseif|else
if|if
condition|(
name|numBlocks
operator|>
name|MAX_BLOCKS
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"invalid number of blocks: "
operator|+
name|numBlocks
operator|+
literal|".  The maximum number of blocks per file is "
operator|+
name|MAX_BLOCKS
argument_list|)
throw|;
block|}
name|Block
index|[]
name|blocks
init|=
operator|new
name|Block
index|[
name|numBlocks
index|]
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|numBlocks
condition|;
name|i
operator|++
control|)
block|{
name|Block
name|blk
init|=
operator|new
name|Block
argument_list|()
decl_stmt|;
name|blk
operator|.
name|readFields
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|blocks
index|[
name|i
index|]
operator|=
name|blk
expr_stmt|;
block|}
return|return
name|blocks
return|;
block|}
DECL|method|stringifyMembers ()
specifier|public
name|String
name|stringifyMembers
parameter_list|()
block|{
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"[length="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|length
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", path="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", replication="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|replication
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", mtime="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|mtime
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", atime="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|atime
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", blockSize="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|blockSize
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", blocks="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|Arrays
operator|.
name|toString
argument_list|(
name|blocks
argument_list|)
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", permissions="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|permissions
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", clientName="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|clientName
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", clientMachine="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|clientMachine
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", opCode="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|opCode
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", txid="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|txid
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|toString
argument_list|()
return|;
block|}
annotation|@
name|Override
DECL|method|toXml (ContentHandler contentHandler)
specifier|protected
name|void
name|toXml
parameter_list|(
name|ContentHandler
name|contentHandler
parameter_list|)
throws|throws
name|SAXException
block|{
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"LENGTH"
argument_list|,
name|Integer
operator|.
name|valueOf
argument_list|(
name|length
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"PATH"
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"REPLICATION"
argument_list|,
name|Short
operator|.
name|valueOf
argument_list|(
name|replication
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"MTIME"
argument_list|,
name|Long
operator|.
name|valueOf
argument_list|(
name|mtime
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"ATIME"
argument_list|,
name|Long
operator|.
name|valueOf
argument_list|(
name|atime
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"BLOCKSIZE"
argument_list|,
name|Long
operator|.
name|valueOf
argument_list|(
name|blockSize
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"CLIENT_NAME"
argument_list|,
name|clientName
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"CLIENT_MACHINE"
argument_list|,
name|clientMachine
argument_list|)
expr_stmt|;
for|for
control|(
name|Block
name|b
range|:
name|blocks
control|)
block|{
name|FSEditLogOp
operator|.
name|blockToXml
argument_list|(
name|contentHandler
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
name|FSEditLogOp
operator|.
name|permissionStatusToXml
argument_list|(
name|contentHandler
argument_list|,
name|permissions
argument_list|)
expr_stmt|;
block|}
DECL|method|fromXml (Stanza st)
annotation|@
name|Override
name|void
name|fromXml
parameter_list|(
name|Stanza
name|st
parameter_list|)
throws|throws
name|InvalidXmlException
block|{
name|this
operator|.
name|length
operator|=
name|Integer
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"LENGTH"
argument_list|)
argument_list|)
expr_stmt|;
name|this
operator|.
name|path
operator|=
name|st
operator|.
name|getValue
argument_list|(
literal|"PATH"
argument_list|)
expr_stmt|;
name|this
operator|.
name|replication
operator|=
name|Short
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"REPLICATION"
argument_list|)
argument_list|)
expr_stmt|;
name|this
operator|.
name|mtime
operator|=
name|Long
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"MTIME"
argument_list|)
argument_list|)
expr_stmt|;
name|this
operator|.
name|atime
operator|=
name|Long
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"ATIME"
argument_list|)
argument_list|)
expr_stmt|;
name|this
operator|.
name|blockSize
operator|=
name|Long
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"BLOCKSIZE"
argument_list|)
argument_list|)
expr_stmt|;
name|this
operator|.
name|clientName
operator|=
name|st
operator|.
name|getValue
argument_list|(
literal|"CLIENT_NAME"
argument_list|)
expr_stmt|;
name|this
operator|.
name|clientMachine
operator|=
name|st
operator|.
name|getValue
argument_list|(
literal|"CLIENT_MACHINE"
argument_list|)
expr_stmt|;
if|if
condition|(
name|st
operator|.
name|hasChildren
argument_list|(
literal|"BLOCK"
argument_list|)
condition|)
block|{
name|List
argument_list|<
name|Stanza
argument_list|>
name|blocks
init|=
name|st
operator|.
name|getChildren
argument_list|(
literal|"BLOCK"
argument_list|)
decl_stmt|;
name|this
operator|.
name|blocks
operator|=
operator|new
name|Block
index|[
name|blocks
operator|.
name|size
argument_list|()
index|]
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|blocks
operator|.
name|size
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|this
operator|.
name|blocks
index|[
name|i
index|]
operator|=
name|FSEditLogOp
operator|.
name|blockFromXml
argument_list|(
name|blocks
operator|.
name|get
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|this
operator|.
name|blocks
operator|=
operator|new
name|Block
index|[
literal|0
index|]
expr_stmt|;
block|}
name|this
operator|.
name|permissions
operator|=
name|permissionStatusFromXml
argument_list|(
name|st
operator|.
name|getChildren
argument_list|(
literal|"PERMISSION_STATUS"
argument_list|)
operator|.
name|get
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|AddOp
specifier|static
class|class
name|AddOp
extends|extends
name|AddCloseOp
block|{
DECL|method|AddOp ()
specifier|private
name|AddOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_ADD
argument_list|)
expr_stmt|;
block|}
DECL|method|getInstance (OpInstanceCache cache)
specifier|static
name|AddOp
name|getInstance
parameter_list|(
name|OpInstanceCache
name|cache
parameter_list|)
block|{
return|return
operator|(
name|AddOp
operator|)
name|cache
operator|.
name|get
argument_list|(
name|OP_ADD
argument_list|)
return|;
block|}
DECL|method|shouldCompleteLastBlock ()
specifier|public
name|boolean
name|shouldCompleteLastBlock
parameter_list|()
block|{
return|return
literal|false
return|;
block|}
annotation|@
name|Override
DECL|method|toString ()
specifier|public
name|String
name|toString
parameter_list|()
block|{
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"AddOp "
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|stringifyMembers
argument_list|()
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|toString
argument_list|()
return|;
block|}
block|}
DECL|class|CloseOp
specifier|static
class|class
name|CloseOp
extends|extends
name|AddCloseOp
block|{
DECL|method|CloseOp ()
specifier|private
name|CloseOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_CLOSE
argument_list|)
expr_stmt|;
block|}
DECL|method|getInstance (OpInstanceCache cache)
specifier|static
name|CloseOp
name|getInstance
parameter_list|(
name|OpInstanceCache
name|cache
parameter_list|)
block|{
return|return
operator|(
name|CloseOp
operator|)
name|cache
operator|.
name|get
argument_list|(
name|OP_CLOSE
argument_list|)
return|;
block|}
DECL|method|shouldCompleteLastBlock ()
specifier|public
name|boolean
name|shouldCompleteLastBlock
parameter_list|()
block|{
return|return
literal|true
return|;
block|}
annotation|@
name|Override
DECL|method|toString ()
specifier|public
name|String
name|toString
parameter_list|()
block|{
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"CloseOp "
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|stringifyMembers
argument_list|()
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|toString
argument_list|()
return|;
block|}
block|}
DECL|class|UpdateBlocksOp
specifier|static
class|class
name|UpdateBlocksOp
extends|extends
name|FSEditLogOp
implements|implements
name|BlockListUpdatingOp
block|{
DECL|field|path
name|String
name|path
decl_stmt|;
DECL|field|blocks
name|Block
index|[]
name|blocks
decl_stmt|;
DECL|method|UpdateBlocksOp ()
specifier|private
name|UpdateBlocksOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_UPDATE_BLOCKS
argument_list|)
expr_stmt|;
block|}
DECL|method|getInstance (OpInstanceCache cache)
specifier|static
name|UpdateBlocksOp
name|getInstance
parameter_list|(
name|OpInstanceCache
name|cache
parameter_list|)
block|{
return|return
operator|(
name|UpdateBlocksOp
operator|)
name|cache
operator|.
name|get
argument_list|(
name|OP_UPDATE_BLOCKS
argument_list|)
return|;
block|}
DECL|method|setPath (String path)
name|UpdateBlocksOp
name|setPath
parameter_list|(
name|String
name|path
parameter_list|)
block|{
name|this
operator|.
name|path
operator|=
name|path
expr_stmt|;
return|return
name|this
return|;
block|}
DECL|method|getPath ()
specifier|public
name|String
name|getPath
parameter_list|()
block|{
return|return
name|path
return|;
block|}
DECL|method|setBlocks (Block[] blocks)
name|UpdateBlocksOp
name|setBlocks
parameter_list|(
name|Block
index|[]
name|blocks
parameter_list|)
block|{
name|this
operator|.
name|blocks
operator|=
name|blocks
expr_stmt|;
return|return
name|this
return|;
block|}
DECL|method|getBlocks ()
specifier|public
name|Block
index|[]
name|getBlocks
parameter_list|()
block|{
return|return
name|blocks
return|;
block|}
annotation|@
name|Override
specifier|public
DECL|method|writeFields (DataOutputStream out)
name|void
name|writeFields
parameter_list|(
name|DataOutputStream
name|out
parameter_list|)
throws|throws
name|IOException
block|{
name|FSImageSerialization
operator|.
name|writeString
argument_list|(
name|path
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|FSImageSerialization
operator|.
name|writeCompactBlockArray
argument_list|(
name|blocks
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|readFields (DataInputStream in, int logVersion)
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|path
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|blocks
operator|=
name|FSImageSerialization
operator|.
name|readCompactBlockArray
argument_list|(
name|in
argument_list|,
name|logVersion
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|shouldCompleteLastBlock ()
specifier|public
name|boolean
name|shouldCompleteLastBlock
parameter_list|()
block|{
return|return
literal|false
return|;
block|}
annotation|@
name|Override
DECL|method|toString ()
specifier|public
name|String
name|toString
parameter_list|()
block|{
name|StringBuilder
name|sb
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|sb
operator|.
name|append
argument_list|(
literal|"UpdateBlocksOp [path="
argument_list|)
operator|.
name|append
argument_list|(
name|path
argument_list|)
operator|.
name|append
argument_list|(
literal|", blocks="
argument_list|)
operator|.
name|append
argument_list|(
name|Arrays
operator|.
name|toString
argument_list|(
name|blocks
argument_list|)
argument_list|)
operator|.
name|append
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
return|return
name|sb
operator|.
name|toString
argument_list|()
return|;
block|}
annotation|@
name|Override
DECL|method|toXml (ContentHandler contentHandler)
specifier|protected
name|void
name|toXml
parameter_list|(
name|ContentHandler
name|contentHandler
parameter_list|)
throws|throws
name|SAXException
block|{
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"PATH"
argument_list|,
name|path
argument_list|)
expr_stmt|;
for|for
control|(
name|Block
name|b
range|:
name|blocks
control|)
block|{
name|FSEditLogOp
operator|.
name|blockToXml
argument_list|(
name|contentHandler
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|fromXml (Stanza st)
annotation|@
name|Override
name|void
name|fromXml
parameter_list|(
name|Stanza
name|st
parameter_list|)
throws|throws
name|InvalidXmlException
block|{
name|this
operator|.
name|path
operator|=
name|st
operator|.
name|getValue
argument_list|(
literal|"PATH"
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|Stanza
argument_list|>
name|blocks
init|=
name|st
operator|.
name|getChildren
argument_list|(
literal|"BLOCK"
argument_list|)
decl_stmt|;
name|this
operator|.
name|blocks
operator|=
operator|new
name|Block
index|[
name|blocks
operator|.
name|size
argument_list|()
index|]
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|blocks
operator|.
name|size
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|this
operator|.
name|blocks
index|[
name|i
index|]
operator|=
name|FSEditLogOp
operator|.
name|blockFromXml
argument_list|(
name|blocks
operator|.
name|get
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
DECL|class|SetReplicationOp
specifier|static
class|class
name|SetReplicationOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|path
name|String
name|path
decl_stmt|;
DECL|field|replication
name|short
name|replication
decl_stmt|;
DECL|method|SetReplicationOp ()
specifier|private
name|SetReplicationOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_SET_REPLICATION
argument_list|)
expr_stmt|;
block|}
DECL|method|getInstance (OpInstanceCache cache)
specifier|static
name|SetReplicationOp
name|getInstance
parameter_list|(
name|OpInstanceCache
name|cache
parameter_list|)
block|{
return|return
operator|(
name|SetReplicationOp
operator|)
name|cache
operator|.
name|get
argument_list|(
name|OP_SET_REPLICATION
argument_list|)
return|;
block|}
DECL|method|setPath (String path)
name|SetReplicationOp
name|setPath
parameter_list|(
name|String
name|path
parameter_list|)
block|{
name|this
operator|.
name|path
operator|=
name|path
expr_stmt|;
return|return
name|this
return|;
block|}
DECL|method|setReplication (short replication)
name|SetReplicationOp
name|setReplication
parameter_list|(
name|short
name|replication
parameter_list|)
block|{
name|this
operator|.
name|replication
operator|=
name|replication
expr_stmt|;
return|return
name|this
return|;
block|}
annotation|@
name|Override
specifier|public
DECL|method|writeFields (DataOutputStream out)
name|void
name|writeFields
parameter_list|(
name|DataOutputStream
name|out
parameter_list|)
throws|throws
name|IOException
block|{
name|FSImageSerialization
operator|.
name|writeString
argument_list|(
name|path
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|FSImageSerialization
operator|.
name|writeShort
argument_list|(
name|replication
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|readFields (DataInputStream in, int logVersion)
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|path
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
if|if
condition|(
name|LayoutVersion
operator|.
name|supports
argument_list|(
name|Feature
operator|.
name|EDITLOG_OP_OPTIMIZATION
argument_list|,
name|logVersion
argument_list|)
condition|)
block|{
name|this
operator|.
name|replication
operator|=
name|FSImageSerialization
operator|.
name|readShort
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|replication
operator|=
name|readShort
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|toString ()
specifier|public
name|String
name|toString
parameter_list|()
block|{
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"SetReplicationOp [path="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", replication="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|replication
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", opCode="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|opCode
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", txid="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|txid
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|toString
argument_list|()
return|;
block|}
annotation|@
name|Override
DECL|method|toXml (ContentHandler contentHandler)
specifier|protected
name|void
name|toXml
parameter_list|(
name|ContentHandler
name|contentHandler
parameter_list|)
throws|throws
name|SAXException
block|{
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"PATH"
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"REPLICATION"
argument_list|,
name|Short
operator|.
name|valueOf
argument_list|(
name|replication
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|fromXml (Stanza st)
annotation|@
name|Override
name|void
name|fromXml
parameter_list|(
name|Stanza
name|st
parameter_list|)
throws|throws
name|InvalidXmlException
block|{
name|this
operator|.
name|path
operator|=
name|st
operator|.
name|getValue
argument_list|(
literal|"PATH"
argument_list|)
expr_stmt|;
name|this
operator|.
name|replication
operator|=
name|Short
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"REPLICATION"
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|ConcatDeleteOp
specifier|static
class|class
name|ConcatDeleteOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|length
name|int
name|length
decl_stmt|;
DECL|field|trg
name|String
name|trg
decl_stmt|;
DECL|field|srcs
name|String
index|[]
name|srcs
decl_stmt|;
DECL|field|timestamp
name|long
name|timestamp
decl_stmt|;
DECL|field|MAX_CONCAT_SRC
specifier|final
specifier|static
specifier|public
name|int
name|MAX_CONCAT_SRC
init|=
literal|1024
operator|*
literal|1024
decl_stmt|;
DECL|method|ConcatDeleteOp ()
specifier|private
name|ConcatDeleteOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_CONCAT_DELETE
argument_list|)
expr_stmt|;
block|}
DECL|method|getInstance (OpInstanceCache cache)
specifier|static
name|ConcatDeleteOp
name|getInstance
parameter_list|(
name|OpInstanceCache
name|cache
parameter_list|)
block|{
return|return
operator|(
name|ConcatDeleteOp
operator|)
name|cache
operator|.
name|get
argument_list|(
name|OP_CONCAT_DELETE
argument_list|)
return|;
block|}
DECL|method|setTarget (String trg)
name|ConcatDeleteOp
name|setTarget
parameter_list|(
name|String
name|trg
parameter_list|)
block|{
name|this
operator|.
name|trg
operator|=
name|trg
expr_stmt|;
return|return
name|this
return|;
block|}
DECL|method|setSources (String[] srcs)
name|ConcatDeleteOp
name|setSources
parameter_list|(
name|String
index|[]
name|srcs
parameter_list|)
block|{
if|if
condition|(
name|srcs
operator|.
name|length
operator|>
name|MAX_CONCAT_SRC
condition|)
block|{
throw|throw
operator|new
name|RuntimeException
argument_list|(
literal|"ConcatDeleteOp can only have "
operator|+
name|MAX_CONCAT_SRC
operator|+
literal|" sources at most."
argument_list|)
throw|;
block|}
name|this
operator|.
name|srcs
operator|=
name|srcs
expr_stmt|;
return|return
name|this
return|;
block|}
DECL|method|setTimestamp (long timestamp)
name|ConcatDeleteOp
name|setTimestamp
parameter_list|(
name|long
name|timestamp
parameter_list|)
block|{
name|this
operator|.
name|timestamp
operator|=
name|timestamp
expr_stmt|;
return|return
name|this
return|;
block|}
annotation|@
name|Override
specifier|public
DECL|method|writeFields (DataOutputStream out)
name|void
name|writeFields
parameter_list|(
name|DataOutputStream
name|out
parameter_list|)
throws|throws
name|IOException
block|{
name|FSImageSerialization
operator|.
name|writeString
argument_list|(
name|trg
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|DeprecatedUTF8
name|info
index|[]
init|=
operator|new
name|DeprecatedUTF8
index|[
name|srcs
operator|.
name|length
index|]
decl_stmt|;
name|int
name|idx
init|=
literal|0
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|srcs
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|info
index|[
name|idx
operator|++
index|]
operator|=
operator|new
name|DeprecatedUTF8
argument_list|(
name|srcs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
operator|new
name|ArrayWritable
argument_list|(
name|DeprecatedUTF8
operator|.
name|class
argument_list|,
name|info
argument_list|)
operator|.
name|write
argument_list|(
name|out
argument_list|)
expr_stmt|;
name|FSImageSerialization
operator|.
name|writeLong
argument_list|(
name|timestamp
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|readFields (DataInputStream in, int logVersion)
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
operator|!
name|LayoutVersion
operator|.
name|supports
argument_list|(
name|Feature
operator|.
name|EDITLOG_OP_OPTIMIZATION
argument_list|,
name|logVersion
argument_list|)
condition|)
block|{
name|this
operator|.
name|length
operator|=
name|in
operator|.
name|readInt
argument_list|()
expr_stmt|;
if|if
condition|(
name|length
operator|<
literal|3
condition|)
block|{
comment|// trg, srcs.., timestamp
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Incorrect data format "
operator|+
literal|"for ConcatDeleteOp."
argument_list|)
throw|;
block|}
block|}
name|this
operator|.
name|trg
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|int
name|srcSize
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|LayoutVersion
operator|.
name|supports
argument_list|(
name|Feature
operator|.
name|EDITLOG_OP_OPTIMIZATION
argument_list|,
name|logVersion
argument_list|)
condition|)
block|{
name|srcSize
operator|=
name|in
operator|.
name|readInt
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|srcSize
operator|=
name|this
operator|.
name|length
operator|-
literal|1
operator|-
literal|1
expr_stmt|;
comment|// trg and timestamp
block|}
if|if
condition|(
name|srcSize
operator|<
literal|0
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Incorrect data format. "
operator|+
literal|"ConcatDeleteOp cannot have a negative number of data "
operator|+
literal|" sources."
argument_list|)
throw|;
block|}
elseif|else
if|if
condition|(
name|srcSize
operator|>
name|MAX_CONCAT_SRC
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Incorrect data format. "
operator|+
literal|"ConcatDeleteOp can have at most "
operator|+
name|MAX_CONCAT_SRC
operator|+
literal|" sources, but we tried to have "
operator|+
operator|(
name|length
operator|-
literal|3
operator|)
operator|+
literal|" sources."
argument_list|)
throw|;
block|}
name|this
operator|.
name|srcs
operator|=
operator|new
name|String
index|[
name|srcSize
index|]
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|srcSize
condition|;
name|i
operator|++
control|)
block|{
name|srcs
index|[
name|i
index|]
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|LayoutVersion
operator|.
name|supports
argument_list|(
name|Feature
operator|.
name|EDITLOG_OP_OPTIMIZATION
argument_list|,
name|logVersion
argument_list|)
condition|)
block|{
name|this
operator|.
name|timestamp
operator|=
name|FSImageSerialization
operator|.
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|timestamp
operator|=
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|toString ()
specifier|public
name|String
name|toString
parameter_list|()
block|{
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"ConcatDeleteOp [length="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|length
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", trg="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|trg
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", srcs="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|Arrays
operator|.
name|toString
argument_list|(
name|srcs
argument_list|)
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", timestamp="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|timestamp
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", opCode="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|opCode
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", txid="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|txid
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|toString
argument_list|()
return|;
block|}
annotation|@
name|Override
DECL|method|toXml (ContentHandler contentHandler)
specifier|protected
name|void
name|toXml
parameter_list|(
name|ContentHandler
name|contentHandler
parameter_list|)
throws|throws
name|SAXException
block|{
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"LENGTH"
argument_list|,
name|Integer
operator|.
name|valueOf
argument_list|(
name|length
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"TRG"
argument_list|,
name|trg
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"TIMESTAMP"
argument_list|,
name|Long
operator|.
name|valueOf
argument_list|(
name|timestamp
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|contentHandler
operator|.
name|startElement
argument_list|(
literal|""
argument_list|,
literal|""
argument_list|,
literal|"SOURCES"
argument_list|,
operator|new
name|AttributesImpl
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|srcs
operator|.
name|length
condition|;
operator|++
name|i
control|)
block|{
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"SOURCE"
operator|+
operator|(
name|i
operator|+
literal|1
operator|)
argument_list|,
name|srcs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|contentHandler
operator|.
name|endElement
argument_list|(
literal|""
argument_list|,
literal|""
argument_list|,
literal|"SOURCES"
argument_list|)
expr_stmt|;
block|}
DECL|method|fromXml (Stanza st)
annotation|@
name|Override
name|void
name|fromXml
parameter_list|(
name|Stanza
name|st
parameter_list|)
throws|throws
name|InvalidXmlException
block|{
name|this
operator|.
name|length
operator|=
name|Integer
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"LENGTH"
argument_list|)
argument_list|)
expr_stmt|;
name|this
operator|.
name|trg
operator|=
name|st
operator|.
name|getValue
argument_list|(
literal|"TRG"
argument_list|)
expr_stmt|;
name|this
operator|.
name|timestamp
operator|=
name|Long
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"TIMESTAMP"
argument_list|)
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|Stanza
argument_list|>
name|sources
init|=
name|st
operator|.
name|getChildren
argument_list|(
literal|"SOURCES"
argument_list|)
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
while|while
condition|(
literal|true
condition|)
block|{
if|if
condition|(
operator|!
name|sources
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|.
name|hasChildren
argument_list|(
literal|"SOURCE"
operator|+
operator|(
name|i
operator|+
literal|1
operator|)
argument_list|)
condition|)
break|break;
name|i
operator|++
expr_stmt|;
block|}
name|srcs
operator|=
operator|new
name|String
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|srcs
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|srcs
index|[
name|i
index|]
operator|=
name|sources
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|.
name|getValue
argument_list|(
literal|"SOURCE"
operator|+
operator|(
name|i
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
DECL|class|RenameOldOp
specifier|static
class|class
name|RenameOldOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|length
name|int
name|length
decl_stmt|;
DECL|field|src
name|String
name|src
decl_stmt|;
DECL|field|dst
name|String
name|dst
decl_stmt|;
DECL|field|timestamp
name|long
name|timestamp
decl_stmt|;
DECL|method|RenameOldOp ()
specifier|private
name|RenameOldOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_RENAME_OLD
argument_list|)
expr_stmt|;
block|}
DECL|method|getInstance (OpInstanceCache cache)
specifier|static
name|RenameOldOp
name|getInstance
parameter_list|(
name|OpInstanceCache
name|cache
parameter_list|)
block|{
return|return
operator|(
name|RenameOldOp
operator|)
name|cache
operator|.
name|get
argument_list|(
name|OP_RENAME_OLD
argument_list|)
return|;
block|}
DECL|method|setSource (String src)
name|RenameOldOp
name|setSource
parameter_list|(
name|String
name|src
parameter_list|)
block|{
name|this
operator|.
name|src
operator|=
name|src
expr_stmt|;
return|return
name|this
return|;
block|}
DECL|method|setDestination (String dst)
name|RenameOldOp
name|setDestination
parameter_list|(
name|String
name|dst
parameter_list|)
block|{
name|this
operator|.
name|dst
operator|=
name|dst
expr_stmt|;
return|return
name|this
return|;
block|}
DECL|method|setTimestamp (long timestamp)
name|RenameOldOp
name|setTimestamp
parameter_list|(
name|long
name|timestamp
parameter_list|)
block|{
name|this
operator|.
name|timestamp
operator|=
name|timestamp
expr_stmt|;
return|return
name|this
return|;
block|}
annotation|@
name|Override
specifier|public
DECL|method|writeFields (DataOutputStream out)
name|void
name|writeFields
parameter_list|(
name|DataOutputStream
name|out
parameter_list|)
throws|throws
name|IOException
block|{
name|FSImageSerialization
operator|.
name|writeString
argument_list|(
name|src
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|FSImageSerialization
operator|.
name|writeString
argument_list|(
name|dst
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|FSImageSerialization
operator|.
name|writeLong
argument_list|(
name|timestamp
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|readFields (DataInputStream in, int logVersion)
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
operator|!
name|LayoutVersion
operator|.
name|supports
argument_list|(
name|Feature
operator|.
name|EDITLOG_OP_OPTIMIZATION
argument_list|,
name|logVersion
argument_list|)
condition|)
block|{
name|this
operator|.
name|length
operator|=
name|in
operator|.
name|readInt
argument_list|()
expr_stmt|;
if|if
condition|(
name|this
operator|.
name|length
operator|!=
literal|3
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Incorrect data format. "
operator|+
literal|"Old rename operation."
argument_list|)
throw|;
block|}
block|}
name|this
operator|.
name|src
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|dst
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
if|if
condition|(
name|LayoutVersion
operator|.
name|supports
argument_list|(
name|Feature
operator|.
name|EDITLOG_OP_OPTIMIZATION
argument_list|,
name|logVersion
argument_list|)
condition|)
block|{
name|this
operator|.
name|timestamp
operator|=
name|FSImageSerialization
operator|.
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|timestamp
operator|=
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|toString ()
specifier|public
name|String
name|toString
parameter_list|()
block|{
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"RenameOldOp [length="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|length
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", src="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", dst="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|dst
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", timestamp="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|timestamp
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", opCode="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|opCode
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", txid="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|txid
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|toString
argument_list|()
return|;
block|}
annotation|@
name|Override
DECL|method|toXml (ContentHandler contentHandler)
specifier|protected
name|void
name|toXml
parameter_list|(
name|ContentHandler
name|contentHandler
parameter_list|)
throws|throws
name|SAXException
block|{
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"LENGTH"
argument_list|,
name|Integer
operator|.
name|valueOf
argument_list|(
name|length
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"SRC"
argument_list|,
name|src
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"DST"
argument_list|,
name|dst
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"TIMESTAMP"
argument_list|,
name|Long
operator|.
name|valueOf
argument_list|(
name|timestamp
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|fromXml (Stanza st)
annotation|@
name|Override
name|void
name|fromXml
parameter_list|(
name|Stanza
name|st
parameter_list|)
throws|throws
name|InvalidXmlException
block|{
name|this
operator|.
name|length
operator|=
name|Integer
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"LENGTH"
argument_list|)
argument_list|)
expr_stmt|;
name|this
operator|.
name|src
operator|=
name|st
operator|.
name|getValue
argument_list|(
literal|"SRC"
argument_list|)
expr_stmt|;
name|this
operator|.
name|dst
operator|=
name|st
operator|.
name|getValue
argument_list|(
literal|"DST"
argument_list|)
expr_stmt|;
name|this
operator|.
name|timestamp
operator|=
name|Long
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"TIMESTAMP"
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|DeleteOp
specifier|static
class|class
name|DeleteOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|length
name|int
name|length
decl_stmt|;
DECL|field|path
name|String
name|path
decl_stmt|;
DECL|field|timestamp
name|long
name|timestamp
decl_stmt|;
DECL|method|DeleteOp ()
specifier|private
name|DeleteOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_DELETE
argument_list|)
expr_stmt|;
block|}
DECL|method|getInstance (OpInstanceCache cache)
specifier|static
name|DeleteOp
name|getInstance
parameter_list|(
name|OpInstanceCache
name|cache
parameter_list|)
block|{
return|return
operator|(
name|DeleteOp
operator|)
name|cache
operator|.
name|get
argument_list|(
name|OP_DELETE
argument_list|)
return|;
block|}
DECL|method|setPath (String path)
name|DeleteOp
name|setPath
parameter_list|(
name|String
name|path
parameter_list|)
block|{
name|this
operator|.
name|path
operator|=
name|path
expr_stmt|;
return|return
name|this
return|;
block|}
DECL|method|setTimestamp (long timestamp)
name|DeleteOp
name|setTimestamp
parameter_list|(
name|long
name|timestamp
parameter_list|)
block|{
name|this
operator|.
name|timestamp
operator|=
name|timestamp
expr_stmt|;
return|return
name|this
return|;
block|}
annotation|@
name|Override
specifier|public
DECL|method|writeFields (DataOutputStream out)
name|void
name|writeFields
parameter_list|(
name|DataOutputStream
name|out
parameter_list|)
throws|throws
name|IOException
block|{
name|FSImageSerialization
operator|.
name|writeString
argument_list|(
name|path
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|FSImageSerialization
operator|.
name|writeLong
argument_list|(
name|timestamp
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|readFields (DataInputStream in, int logVersion)
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
operator|!
name|LayoutVersion
operator|.
name|supports
argument_list|(
name|Feature
operator|.
name|EDITLOG_OP_OPTIMIZATION
argument_list|,
name|logVersion
argument_list|)
condition|)
block|{
name|this
operator|.
name|length
operator|=
name|in
operator|.
name|readInt
argument_list|()
expr_stmt|;
if|if
condition|(
name|this
operator|.
name|length
operator|!=
literal|2
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Incorrect data format. "
operator|+
literal|"delete operation."
argument_list|)
throw|;
block|}
block|}
name|this
operator|.
name|path
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
if|if
condition|(
name|LayoutVersion
operator|.
name|supports
argument_list|(
name|Feature
operator|.
name|EDITLOG_OP_OPTIMIZATION
argument_list|,
name|logVersion
argument_list|)
condition|)
block|{
name|this
operator|.
name|timestamp
operator|=
name|FSImageSerialization
operator|.
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|timestamp
operator|=
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|toString ()
specifier|public
name|String
name|toString
parameter_list|()
block|{
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"DeleteOp [length="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|length
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", path="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", timestamp="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|timestamp
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", opCode="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|opCode
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", txid="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|txid
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|toString
argument_list|()
return|;
block|}
annotation|@
name|Override
DECL|method|toXml (ContentHandler contentHandler)
specifier|protected
name|void
name|toXml
parameter_list|(
name|ContentHandler
name|contentHandler
parameter_list|)
throws|throws
name|SAXException
block|{
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"LENGTH"
argument_list|,
name|Integer
operator|.
name|valueOf
argument_list|(
name|length
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"PATH"
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"TIMESTAMP"
argument_list|,
name|Long
operator|.
name|valueOf
argument_list|(
name|timestamp
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|fromXml (Stanza st)
annotation|@
name|Override
name|void
name|fromXml
parameter_list|(
name|Stanza
name|st
parameter_list|)
throws|throws
name|InvalidXmlException
block|{
name|this
operator|.
name|length
operator|=
name|Integer
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"LENGTH"
argument_list|)
argument_list|)
expr_stmt|;
name|this
operator|.
name|path
operator|=
name|st
operator|.
name|getValue
argument_list|(
literal|"PATH"
argument_list|)
expr_stmt|;
name|this
operator|.
name|timestamp
operator|=
name|Long
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"TIMESTAMP"
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|MkdirOp
specifier|static
class|class
name|MkdirOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|length
name|int
name|length
decl_stmt|;
DECL|field|path
name|String
name|path
decl_stmt|;
DECL|field|timestamp
name|long
name|timestamp
decl_stmt|;
DECL|field|permissions
name|PermissionStatus
name|permissions
decl_stmt|;
DECL|method|MkdirOp ()
specifier|private
name|MkdirOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_MKDIR
argument_list|)
expr_stmt|;
block|}
DECL|method|getInstance (OpInstanceCache cache)
specifier|static
name|MkdirOp
name|getInstance
parameter_list|(
name|OpInstanceCache
name|cache
parameter_list|)
block|{
return|return
operator|(
name|MkdirOp
operator|)
name|cache
operator|.
name|get
argument_list|(
name|OP_MKDIR
argument_list|)
return|;
block|}
DECL|method|setPath (String path)
name|MkdirOp
name|setPath
parameter_list|(
name|String
name|path
parameter_list|)
block|{
name|this
operator|.
name|path
operator|=
name|path
expr_stmt|;
return|return
name|this
return|;
block|}
DECL|method|setTimestamp (long timestamp)
name|MkdirOp
name|setTimestamp
parameter_list|(
name|long
name|timestamp
parameter_list|)
block|{
name|this
operator|.
name|timestamp
operator|=
name|timestamp
expr_stmt|;
return|return
name|this
return|;
block|}
DECL|method|setPermissionStatus (PermissionStatus permissions)
name|MkdirOp
name|setPermissionStatus
parameter_list|(
name|PermissionStatus
name|permissions
parameter_list|)
block|{
name|this
operator|.
name|permissions
operator|=
name|permissions
expr_stmt|;
return|return
name|this
return|;
block|}
annotation|@
name|Override
specifier|public
DECL|method|writeFields (DataOutputStream out)
name|void
name|writeFields
parameter_list|(
name|DataOutputStream
name|out
parameter_list|)
throws|throws
name|IOException
block|{
name|FSImageSerialization
operator|.
name|writeString
argument_list|(
name|path
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|FSImageSerialization
operator|.
name|writeLong
argument_list|(
name|timestamp
argument_list|,
name|out
argument_list|)
expr_stmt|;
comment|// mtime
name|FSImageSerialization
operator|.
name|writeLong
argument_list|(
name|timestamp
argument_list|,
name|out
argument_list|)
expr_stmt|;
comment|// atime, unused at this
name|permissions
operator|.
name|write
argument_list|(
name|out
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|readFields (DataInputStream in, int logVersion)
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
operator|!
name|LayoutVersion
operator|.
name|supports
argument_list|(
name|Feature
operator|.
name|EDITLOG_OP_OPTIMIZATION
argument_list|,
name|logVersion
argument_list|)
condition|)
block|{
name|this
operator|.
name|length
operator|=
name|in
operator|.
name|readInt
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|-
literal|17
operator|<
name|logVersion
operator|&&
name|length
operator|!=
literal|2
operator|||
name|logVersion
operator|<=
operator|-
literal|17
operator|&&
name|length
operator|!=
literal|3
operator|&&
operator|!
name|LayoutVersion
operator|.
name|supports
argument_list|(
name|Feature
operator|.
name|EDITLOG_OP_OPTIMIZATION
argument_list|,
name|logVersion
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Incorrect data format. Mkdir operation."
argument_list|)
throw|;
block|}
name|this
operator|.
name|path
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
if|if
condition|(
name|LayoutVersion
operator|.
name|supports
argument_list|(
name|Feature
operator|.
name|EDITLOG_OP_OPTIMIZATION
argument_list|,
name|logVersion
argument_list|)
condition|)
block|{
name|this
operator|.
name|timestamp
operator|=
name|FSImageSerialization
operator|.
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|timestamp
operator|=
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
comment|// The disk format stores atimes for directories as well.
comment|// However, currently this is not being updated/used because of
comment|// performance reasons.
if|if
condition|(
name|LayoutVersion
operator|.
name|supports
argument_list|(
name|Feature
operator|.
name|FILE_ACCESS_TIME
argument_list|,
name|logVersion
argument_list|)
condition|)
block|{
if|if
condition|(
name|LayoutVersion
operator|.
name|supports
argument_list|(
name|Feature
operator|.
name|EDITLOG_OP_OPTIMIZATION
argument_list|,
name|logVersion
argument_list|)
condition|)
block|{
name|FSImageSerialization
operator|.
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
block|}
name|this
operator|.
name|permissions
operator|=
name|PermissionStatus
operator|.
name|read
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|toString ()
specifier|public
name|String
name|toString
parameter_list|()
block|{
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"MkdirOp [length="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|length
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", path="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", timestamp="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|timestamp
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", permissions="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|permissions
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", opCode="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|opCode
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", txid="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|txid
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|toString
argument_list|()
return|;
block|}
annotation|@
name|Override
DECL|method|toXml (ContentHandler contentHandler)
specifier|protected
name|void
name|toXml
parameter_list|(
name|ContentHandler
name|contentHandler
parameter_list|)
throws|throws
name|SAXException
block|{
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"LENGTH"
argument_list|,
name|Integer
operator|.
name|valueOf
argument_list|(
name|length
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"PATH"
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"TIMESTAMP"
argument_list|,
name|Long
operator|.
name|valueOf
argument_list|(
name|timestamp
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|FSEditLogOp
operator|.
name|permissionStatusToXml
argument_list|(
name|contentHandler
argument_list|,
name|permissions
argument_list|)
expr_stmt|;
block|}
DECL|method|fromXml (Stanza st)
annotation|@
name|Override
name|void
name|fromXml
parameter_list|(
name|Stanza
name|st
parameter_list|)
throws|throws
name|InvalidXmlException
block|{
name|this
operator|.
name|length
operator|=
name|Integer
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"LENGTH"
argument_list|)
argument_list|)
expr_stmt|;
name|this
operator|.
name|path
operator|=
name|st
operator|.
name|getValue
argument_list|(
literal|"PATH"
argument_list|)
expr_stmt|;
name|this
operator|.
name|timestamp
operator|=
name|Long
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"TIMESTAMP"
argument_list|)
argument_list|)
expr_stmt|;
name|this
operator|.
name|permissions
operator|=
name|permissionStatusFromXml
argument_list|(
name|st
operator|.
name|getChildren
argument_list|(
literal|"PERMISSION_STATUS"
argument_list|)
operator|.
name|get
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|SetGenstampOp
specifier|static
class|class
name|SetGenstampOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|genStamp
name|long
name|genStamp
decl_stmt|;
DECL|method|SetGenstampOp ()
specifier|private
name|SetGenstampOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_SET_GENSTAMP
argument_list|)
expr_stmt|;
block|}
DECL|method|getInstance (OpInstanceCache cache)
specifier|static
name|SetGenstampOp
name|getInstance
parameter_list|(
name|OpInstanceCache
name|cache
parameter_list|)
block|{
return|return
operator|(
name|SetGenstampOp
operator|)
name|cache
operator|.
name|get
argument_list|(
name|OP_SET_GENSTAMP
argument_list|)
return|;
block|}
DECL|method|setGenerationStamp (long genStamp)
name|SetGenstampOp
name|setGenerationStamp
parameter_list|(
name|long
name|genStamp
parameter_list|)
block|{
name|this
operator|.
name|genStamp
operator|=
name|genStamp
expr_stmt|;
return|return
name|this
return|;
block|}
annotation|@
name|Override
specifier|public
DECL|method|writeFields (DataOutputStream out)
name|void
name|writeFields
parameter_list|(
name|DataOutputStream
name|out
parameter_list|)
throws|throws
name|IOException
block|{
name|FSImageSerialization
operator|.
name|writeLong
argument_list|(
name|genStamp
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|readFields (DataInputStream in, int logVersion)
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|genStamp
operator|=
name|FSImageSerialization
operator|.
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|toString ()
specifier|public
name|String
name|toString
parameter_list|()
block|{
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"SetGenstampOp [genStamp="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|genStamp
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", opCode="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|opCode
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", txid="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|txid
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|toString
argument_list|()
return|;
block|}
annotation|@
name|Override
DECL|method|toXml (ContentHandler contentHandler)
specifier|protected
name|void
name|toXml
parameter_list|(
name|ContentHandler
name|contentHandler
parameter_list|)
throws|throws
name|SAXException
block|{
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"GENSTAMP"
argument_list|,
name|Long
operator|.
name|valueOf
argument_list|(
name|genStamp
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|fromXml (Stanza st)
annotation|@
name|Override
name|void
name|fromXml
parameter_list|(
name|Stanza
name|st
parameter_list|)
throws|throws
name|InvalidXmlException
block|{
name|this
operator|.
name|genStamp
operator|=
name|Long
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"GENSTAMP"
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|SetPermissionsOp
specifier|static
class|class
name|SetPermissionsOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|src
name|String
name|src
decl_stmt|;
DECL|field|permissions
name|FsPermission
name|permissions
decl_stmt|;
DECL|method|SetPermissionsOp ()
specifier|private
name|SetPermissionsOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_SET_PERMISSIONS
argument_list|)
expr_stmt|;
block|}
DECL|method|getInstance (OpInstanceCache cache)
specifier|static
name|SetPermissionsOp
name|getInstance
parameter_list|(
name|OpInstanceCache
name|cache
parameter_list|)
block|{
return|return
operator|(
name|SetPermissionsOp
operator|)
name|cache
operator|.
name|get
argument_list|(
name|OP_SET_PERMISSIONS
argument_list|)
return|;
block|}
DECL|method|setSource (String src)
name|SetPermissionsOp
name|setSource
parameter_list|(
name|String
name|src
parameter_list|)
block|{
name|this
operator|.
name|src
operator|=
name|src
expr_stmt|;
return|return
name|this
return|;
block|}
DECL|method|setPermissions (FsPermission permissions)
name|SetPermissionsOp
name|setPermissions
parameter_list|(
name|FsPermission
name|permissions
parameter_list|)
block|{
name|this
operator|.
name|permissions
operator|=
name|permissions
expr_stmt|;
return|return
name|this
return|;
block|}
annotation|@
name|Override
specifier|public
DECL|method|writeFields (DataOutputStream out)
name|void
name|writeFields
parameter_list|(
name|DataOutputStream
name|out
parameter_list|)
throws|throws
name|IOException
block|{
name|FSImageSerialization
operator|.
name|writeString
argument_list|(
name|src
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|permissions
operator|.
name|write
argument_list|(
name|out
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|readFields (DataInputStream in, int logVersion)
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|src
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|permissions
operator|=
name|FsPermission
operator|.
name|read
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|toString ()
specifier|public
name|String
name|toString
parameter_list|()
block|{
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"SetPermissionsOp [src="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", permissions="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|permissions
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", opCode="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|opCode
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", txid="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|txid
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|toString
argument_list|()
return|;
block|}
annotation|@
name|Override
DECL|method|toXml (ContentHandler contentHandler)
specifier|protected
name|void
name|toXml
parameter_list|(
name|ContentHandler
name|contentHandler
parameter_list|)
throws|throws
name|SAXException
block|{
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"SRC"
argument_list|,
name|src
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"MODE"
argument_list|,
name|Short
operator|.
name|valueOf
argument_list|(
name|permissions
operator|.
name|toShort
argument_list|()
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|fromXml (Stanza st)
annotation|@
name|Override
name|void
name|fromXml
parameter_list|(
name|Stanza
name|st
parameter_list|)
throws|throws
name|InvalidXmlException
block|{
name|this
operator|.
name|src
operator|=
name|st
operator|.
name|getValue
argument_list|(
literal|"SRC"
argument_list|)
expr_stmt|;
name|this
operator|.
name|permissions
operator|=
operator|new
name|FsPermission
argument_list|(
name|Short
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"MODE"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|SetOwnerOp
specifier|static
class|class
name|SetOwnerOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|src
name|String
name|src
decl_stmt|;
DECL|field|username
name|String
name|username
decl_stmt|;
DECL|field|groupname
name|String
name|groupname
decl_stmt|;
DECL|method|SetOwnerOp ()
specifier|private
name|SetOwnerOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_SET_OWNER
argument_list|)
expr_stmt|;
block|}
DECL|method|getInstance (OpInstanceCache cache)
specifier|static
name|SetOwnerOp
name|getInstance
parameter_list|(
name|OpInstanceCache
name|cache
parameter_list|)
block|{
return|return
operator|(
name|SetOwnerOp
operator|)
name|cache
operator|.
name|get
argument_list|(
name|OP_SET_OWNER
argument_list|)
return|;
block|}
DECL|method|setSource (String src)
name|SetOwnerOp
name|setSource
parameter_list|(
name|String
name|src
parameter_list|)
block|{
name|this
operator|.
name|src
operator|=
name|src
expr_stmt|;
return|return
name|this
return|;
block|}
DECL|method|setUser (String username)
name|SetOwnerOp
name|setUser
parameter_list|(
name|String
name|username
parameter_list|)
block|{
name|this
operator|.
name|username
operator|=
name|username
expr_stmt|;
return|return
name|this
return|;
block|}
DECL|method|setGroup (String groupname)
name|SetOwnerOp
name|setGroup
parameter_list|(
name|String
name|groupname
parameter_list|)
block|{
name|this
operator|.
name|groupname
operator|=
name|groupname
expr_stmt|;
return|return
name|this
return|;
block|}
annotation|@
name|Override
specifier|public
DECL|method|writeFields (DataOutputStream out)
name|void
name|writeFields
parameter_list|(
name|DataOutputStream
name|out
parameter_list|)
throws|throws
name|IOException
block|{
name|FSImageSerialization
operator|.
name|writeString
argument_list|(
name|src
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|FSImageSerialization
operator|.
name|writeString
argument_list|(
name|username
operator|==
literal|null
condition|?
literal|""
else|:
name|username
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|FSImageSerialization
operator|.
name|writeString
argument_list|(
name|groupname
operator|==
literal|null
condition|?
literal|""
else|:
name|groupname
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|readFields (DataInputStream in, int logVersion)
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|src
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|username
operator|=
name|FSImageSerialization
operator|.
name|readString_EmptyAsNull
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|groupname
operator|=
name|FSImageSerialization
operator|.
name|readString_EmptyAsNull
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|toString ()
specifier|public
name|String
name|toString
parameter_list|()
block|{
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"SetOwnerOp [src="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", username="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|username
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", groupname="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|groupname
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", opCode="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|opCode
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", txid="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|txid
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|toString
argument_list|()
return|;
block|}
annotation|@
name|Override
DECL|method|toXml (ContentHandler contentHandler)
specifier|protected
name|void
name|toXml
parameter_list|(
name|ContentHandler
name|contentHandler
parameter_list|)
throws|throws
name|SAXException
block|{
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"SRC"
argument_list|,
name|src
argument_list|)
expr_stmt|;
if|if
condition|(
name|username
operator|!=
literal|null
condition|)
block|{
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"USERNAME"
argument_list|,
name|username
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|groupname
operator|!=
literal|null
condition|)
block|{
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"GROUPNAME"
argument_list|,
name|groupname
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|fromXml (Stanza st)
annotation|@
name|Override
name|void
name|fromXml
parameter_list|(
name|Stanza
name|st
parameter_list|)
throws|throws
name|InvalidXmlException
block|{
name|this
operator|.
name|src
operator|=
name|st
operator|.
name|getValue
argument_list|(
literal|"SRC"
argument_list|)
expr_stmt|;
name|this
operator|.
name|username
operator|=
operator|(
name|st
operator|.
name|hasChildren
argument_list|(
literal|"USERNAME"
argument_list|)
operator|)
condition|?
name|st
operator|.
name|getValue
argument_list|(
literal|"USERNAME"
argument_list|)
else|:
literal|null
expr_stmt|;
name|this
operator|.
name|groupname
operator|=
operator|(
name|st
operator|.
name|hasChildren
argument_list|(
literal|"GROUPNAME"
argument_list|)
operator|)
condition|?
name|st
operator|.
name|getValue
argument_list|(
literal|"GROUPNAME"
argument_list|)
else|:
literal|null
expr_stmt|;
block|}
block|}
DECL|class|SetNSQuotaOp
specifier|static
class|class
name|SetNSQuotaOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|src
name|String
name|src
decl_stmt|;
DECL|field|nsQuota
name|long
name|nsQuota
decl_stmt|;
DECL|method|SetNSQuotaOp ()
specifier|private
name|SetNSQuotaOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_SET_NS_QUOTA
argument_list|)
expr_stmt|;
block|}
DECL|method|getInstance (OpInstanceCache cache)
specifier|static
name|SetNSQuotaOp
name|getInstance
parameter_list|(
name|OpInstanceCache
name|cache
parameter_list|)
block|{
return|return
operator|(
name|SetNSQuotaOp
operator|)
name|cache
operator|.
name|get
argument_list|(
name|OP_SET_NS_QUOTA
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
DECL|method|writeFields (DataOutputStream out)
name|void
name|writeFields
parameter_list|(
name|DataOutputStream
name|out
parameter_list|)
throws|throws
name|IOException
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Deprecated"
argument_list|)
throw|;
block|}
annotation|@
name|Override
DECL|method|readFields (DataInputStream in, int logVersion)
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|src
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|nsQuota
operator|=
name|FSImageSerialization
operator|.
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|toString ()
specifier|public
name|String
name|toString
parameter_list|()
block|{
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"SetNSQuotaOp [src="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", nsQuota="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|nsQuota
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", opCode="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|opCode
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", txid="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|txid
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|toString
argument_list|()
return|;
block|}
annotation|@
name|Override
DECL|method|toXml (ContentHandler contentHandler)
specifier|protected
name|void
name|toXml
parameter_list|(
name|ContentHandler
name|contentHandler
parameter_list|)
throws|throws
name|SAXException
block|{
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"SRC"
argument_list|,
name|src
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"NSQUOTA"
argument_list|,
name|Long
operator|.
name|valueOf
argument_list|(
name|nsQuota
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|fromXml (Stanza st)
annotation|@
name|Override
name|void
name|fromXml
parameter_list|(
name|Stanza
name|st
parameter_list|)
throws|throws
name|InvalidXmlException
block|{
name|this
operator|.
name|src
operator|=
name|st
operator|.
name|getValue
argument_list|(
literal|"SRC"
argument_list|)
expr_stmt|;
name|this
operator|.
name|nsQuota
operator|=
name|Long
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"NSQUOTA"
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|ClearNSQuotaOp
specifier|static
class|class
name|ClearNSQuotaOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|src
name|String
name|src
decl_stmt|;
DECL|method|ClearNSQuotaOp ()
specifier|private
name|ClearNSQuotaOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_CLEAR_NS_QUOTA
argument_list|)
expr_stmt|;
block|}
DECL|method|getInstance (OpInstanceCache cache)
specifier|static
name|ClearNSQuotaOp
name|getInstance
parameter_list|(
name|OpInstanceCache
name|cache
parameter_list|)
block|{
return|return
operator|(
name|ClearNSQuotaOp
operator|)
name|cache
operator|.
name|get
argument_list|(
name|OP_CLEAR_NS_QUOTA
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
DECL|method|writeFields (DataOutputStream out)
name|void
name|writeFields
parameter_list|(
name|DataOutputStream
name|out
parameter_list|)
throws|throws
name|IOException
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Deprecated"
argument_list|)
throw|;
block|}
annotation|@
name|Override
DECL|method|readFields (DataInputStream in, int logVersion)
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|src
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|toString ()
specifier|public
name|String
name|toString
parameter_list|()
block|{
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"ClearNSQuotaOp [src="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", opCode="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|opCode
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", txid="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|txid
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|toString
argument_list|()
return|;
block|}
annotation|@
name|Override
DECL|method|toXml (ContentHandler contentHandler)
specifier|protected
name|void
name|toXml
parameter_list|(
name|ContentHandler
name|contentHandler
parameter_list|)
throws|throws
name|SAXException
block|{
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"SRC"
argument_list|,
name|src
argument_list|)
expr_stmt|;
block|}
DECL|method|fromXml (Stanza st)
annotation|@
name|Override
name|void
name|fromXml
parameter_list|(
name|Stanza
name|st
parameter_list|)
throws|throws
name|InvalidXmlException
block|{
name|this
operator|.
name|src
operator|=
name|st
operator|.
name|getValue
argument_list|(
literal|"SRC"
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|SetQuotaOp
specifier|static
class|class
name|SetQuotaOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|src
name|String
name|src
decl_stmt|;
DECL|field|nsQuota
name|long
name|nsQuota
decl_stmt|;
DECL|field|dsQuota
name|long
name|dsQuota
decl_stmt|;
DECL|method|SetQuotaOp ()
specifier|private
name|SetQuotaOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_SET_QUOTA
argument_list|)
expr_stmt|;
block|}
DECL|method|getInstance (OpInstanceCache cache)
specifier|static
name|SetQuotaOp
name|getInstance
parameter_list|(
name|OpInstanceCache
name|cache
parameter_list|)
block|{
return|return
operator|(
name|SetQuotaOp
operator|)
name|cache
operator|.
name|get
argument_list|(
name|OP_SET_QUOTA
argument_list|)
return|;
block|}
DECL|method|setSource (String src)
name|SetQuotaOp
name|setSource
parameter_list|(
name|String
name|src
parameter_list|)
block|{
name|this
operator|.
name|src
operator|=
name|src
expr_stmt|;
return|return
name|this
return|;
block|}
DECL|method|setNSQuota (long nsQuota)
name|SetQuotaOp
name|setNSQuota
parameter_list|(
name|long
name|nsQuota
parameter_list|)
block|{
name|this
operator|.
name|nsQuota
operator|=
name|nsQuota
expr_stmt|;
return|return
name|this
return|;
block|}
DECL|method|setDSQuota (long dsQuota)
name|SetQuotaOp
name|setDSQuota
parameter_list|(
name|long
name|dsQuota
parameter_list|)
block|{
name|this
operator|.
name|dsQuota
operator|=
name|dsQuota
expr_stmt|;
return|return
name|this
return|;
block|}
annotation|@
name|Override
specifier|public
DECL|method|writeFields (DataOutputStream out)
name|void
name|writeFields
parameter_list|(
name|DataOutputStream
name|out
parameter_list|)
throws|throws
name|IOException
block|{
name|FSImageSerialization
operator|.
name|writeString
argument_list|(
name|src
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|FSImageSerialization
operator|.
name|writeLong
argument_list|(
name|nsQuota
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|FSImageSerialization
operator|.
name|writeLong
argument_list|(
name|dsQuota
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|readFields (DataInputStream in, int logVersion)
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|src
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|nsQuota
operator|=
name|FSImageSerialization
operator|.
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|dsQuota
operator|=
name|FSImageSerialization
operator|.
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|toString ()
specifier|public
name|String
name|toString
parameter_list|()
block|{
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"SetQuotaOp [src="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", nsQuota="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|nsQuota
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", dsQuota="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|dsQuota
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", opCode="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|opCode
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", txid="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|txid
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|toString
argument_list|()
return|;
block|}
annotation|@
name|Override
DECL|method|toXml (ContentHandler contentHandler)
specifier|protected
name|void
name|toXml
parameter_list|(
name|ContentHandler
name|contentHandler
parameter_list|)
throws|throws
name|SAXException
block|{
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"SRC"
argument_list|,
name|src
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"NSQUOTA"
argument_list|,
name|Long
operator|.
name|valueOf
argument_list|(
name|nsQuota
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"DSQUOTA"
argument_list|,
name|Long
operator|.
name|valueOf
argument_list|(
name|dsQuota
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|fromXml (Stanza st)
annotation|@
name|Override
name|void
name|fromXml
parameter_list|(
name|Stanza
name|st
parameter_list|)
throws|throws
name|InvalidXmlException
block|{
name|this
operator|.
name|src
operator|=
name|st
operator|.
name|getValue
argument_list|(
literal|"SRC"
argument_list|)
expr_stmt|;
name|this
operator|.
name|nsQuota
operator|=
name|Long
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"NSQUOTA"
argument_list|)
argument_list|)
expr_stmt|;
name|this
operator|.
name|dsQuota
operator|=
name|Long
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"DSQUOTA"
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|TimesOp
specifier|static
class|class
name|TimesOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|length
name|int
name|length
decl_stmt|;
DECL|field|path
name|String
name|path
decl_stmt|;
DECL|field|mtime
name|long
name|mtime
decl_stmt|;
DECL|field|atime
name|long
name|atime
decl_stmt|;
DECL|method|TimesOp ()
specifier|private
name|TimesOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_TIMES
argument_list|)
expr_stmt|;
block|}
DECL|method|getInstance (OpInstanceCache cache)
specifier|static
name|TimesOp
name|getInstance
parameter_list|(
name|OpInstanceCache
name|cache
parameter_list|)
block|{
return|return
operator|(
name|TimesOp
operator|)
name|cache
operator|.
name|get
argument_list|(
name|OP_TIMES
argument_list|)
return|;
block|}
DECL|method|setPath (String path)
name|TimesOp
name|setPath
parameter_list|(
name|String
name|path
parameter_list|)
block|{
name|this
operator|.
name|path
operator|=
name|path
expr_stmt|;
return|return
name|this
return|;
block|}
DECL|method|setModificationTime (long mtime)
name|TimesOp
name|setModificationTime
parameter_list|(
name|long
name|mtime
parameter_list|)
block|{
name|this
operator|.
name|mtime
operator|=
name|mtime
expr_stmt|;
return|return
name|this
return|;
block|}
DECL|method|setAccessTime (long atime)
name|TimesOp
name|setAccessTime
parameter_list|(
name|long
name|atime
parameter_list|)
block|{
name|this
operator|.
name|atime
operator|=
name|atime
expr_stmt|;
return|return
name|this
return|;
block|}
annotation|@
name|Override
specifier|public
DECL|method|writeFields (DataOutputStream out)
name|void
name|writeFields
parameter_list|(
name|DataOutputStream
name|out
parameter_list|)
throws|throws
name|IOException
block|{
name|FSImageSerialization
operator|.
name|writeString
argument_list|(
name|path
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|FSImageSerialization
operator|.
name|writeLong
argument_list|(
name|mtime
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|FSImageSerialization
operator|.
name|writeLong
argument_list|(
name|atime
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|readFields (DataInputStream in, int logVersion)
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
operator|!
name|LayoutVersion
operator|.
name|supports
argument_list|(
name|Feature
operator|.
name|EDITLOG_OP_OPTIMIZATION
argument_list|,
name|logVersion
argument_list|)
condition|)
block|{
name|this
operator|.
name|length
operator|=
name|in
operator|.
name|readInt
argument_list|()
expr_stmt|;
if|if
condition|(
name|length
operator|!=
literal|3
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Incorrect data format. "
operator|+
literal|"times operation."
argument_list|)
throw|;
block|}
block|}
name|this
operator|.
name|path
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
if|if
condition|(
name|LayoutVersion
operator|.
name|supports
argument_list|(
name|Feature
operator|.
name|EDITLOG_OP_OPTIMIZATION
argument_list|,
name|logVersion
argument_list|)
condition|)
block|{
name|this
operator|.
name|mtime
operator|=
name|FSImageSerialization
operator|.
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|atime
operator|=
name|FSImageSerialization
operator|.
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|mtime
operator|=
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|atime
operator|=
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|toString ()
specifier|public
name|String
name|toString
parameter_list|()
block|{
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"TimesOp [length="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|length
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", path="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", mtime="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|mtime
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", atime="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|atime
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", opCode="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|opCode
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", txid="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|txid
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|toString
argument_list|()
return|;
block|}
annotation|@
name|Override
DECL|method|toXml (ContentHandler contentHandler)
specifier|protected
name|void
name|toXml
parameter_list|(
name|ContentHandler
name|contentHandler
parameter_list|)
throws|throws
name|SAXException
block|{
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"LENGTH"
argument_list|,
name|Integer
operator|.
name|valueOf
argument_list|(
name|length
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"PATH"
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"MTIME"
argument_list|,
name|Long
operator|.
name|valueOf
argument_list|(
name|mtime
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"ATIME"
argument_list|,
name|Long
operator|.
name|valueOf
argument_list|(
name|atime
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|fromXml (Stanza st)
annotation|@
name|Override
name|void
name|fromXml
parameter_list|(
name|Stanza
name|st
parameter_list|)
throws|throws
name|InvalidXmlException
block|{
name|this
operator|.
name|length
operator|=
name|Integer
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"LENGTH"
argument_list|)
argument_list|)
expr_stmt|;
name|this
operator|.
name|path
operator|=
name|st
operator|.
name|getValue
argument_list|(
literal|"PATH"
argument_list|)
expr_stmt|;
name|this
operator|.
name|mtime
operator|=
name|Long
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"MTIME"
argument_list|)
argument_list|)
expr_stmt|;
name|this
operator|.
name|atime
operator|=
name|Long
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"ATIME"
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|SymlinkOp
specifier|static
class|class
name|SymlinkOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|length
name|int
name|length
decl_stmt|;
DECL|field|path
name|String
name|path
decl_stmt|;
DECL|field|value
name|String
name|value
decl_stmt|;
DECL|field|mtime
name|long
name|mtime
decl_stmt|;
DECL|field|atime
name|long
name|atime
decl_stmt|;
DECL|field|permissionStatus
name|PermissionStatus
name|permissionStatus
decl_stmt|;
DECL|method|SymlinkOp ()
specifier|private
name|SymlinkOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_SYMLINK
argument_list|)
expr_stmt|;
block|}
DECL|method|getInstance (OpInstanceCache cache)
specifier|static
name|SymlinkOp
name|getInstance
parameter_list|(
name|OpInstanceCache
name|cache
parameter_list|)
block|{
return|return
operator|(
name|SymlinkOp
operator|)
name|cache
operator|.
name|get
argument_list|(
name|OP_SYMLINK
argument_list|)
return|;
block|}
DECL|method|setPath (String path)
name|SymlinkOp
name|setPath
parameter_list|(
name|String
name|path
parameter_list|)
block|{
name|this
operator|.
name|path
operator|=
name|path
expr_stmt|;
return|return
name|this
return|;
block|}
DECL|method|setValue (String value)
name|SymlinkOp
name|setValue
parameter_list|(
name|String
name|value
parameter_list|)
block|{
name|this
operator|.
name|value
operator|=
name|value
expr_stmt|;
return|return
name|this
return|;
block|}
DECL|method|setModificationTime (long mtime)
name|SymlinkOp
name|setModificationTime
parameter_list|(
name|long
name|mtime
parameter_list|)
block|{
name|this
operator|.
name|mtime
operator|=
name|mtime
expr_stmt|;
return|return
name|this
return|;
block|}
DECL|method|setAccessTime (long atime)
name|SymlinkOp
name|setAccessTime
parameter_list|(
name|long
name|atime
parameter_list|)
block|{
name|this
operator|.
name|atime
operator|=
name|atime
expr_stmt|;
return|return
name|this
return|;
block|}
DECL|method|setPermissionStatus (PermissionStatus permissionStatus)
name|SymlinkOp
name|setPermissionStatus
parameter_list|(
name|PermissionStatus
name|permissionStatus
parameter_list|)
block|{
name|this
operator|.
name|permissionStatus
operator|=
name|permissionStatus
expr_stmt|;
return|return
name|this
return|;
block|}
annotation|@
name|Override
specifier|public
DECL|method|writeFields (DataOutputStream out)
name|void
name|writeFields
parameter_list|(
name|DataOutputStream
name|out
parameter_list|)
throws|throws
name|IOException
block|{
name|FSImageSerialization
operator|.
name|writeString
argument_list|(
name|path
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|FSImageSerialization
operator|.
name|writeString
argument_list|(
name|value
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|FSImageSerialization
operator|.
name|writeLong
argument_list|(
name|mtime
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|FSImageSerialization
operator|.
name|writeLong
argument_list|(
name|atime
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|permissionStatus
operator|.
name|write
argument_list|(
name|out
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|readFields (DataInputStream in, int logVersion)
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
operator|!
name|LayoutVersion
operator|.
name|supports
argument_list|(
name|Feature
operator|.
name|EDITLOG_OP_OPTIMIZATION
argument_list|,
name|logVersion
argument_list|)
condition|)
block|{
name|this
operator|.
name|length
operator|=
name|in
operator|.
name|readInt
argument_list|()
expr_stmt|;
if|if
condition|(
name|this
operator|.
name|length
operator|!=
literal|4
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Incorrect data format. "
operator|+
literal|"symlink operation."
argument_list|)
throw|;
block|}
block|}
name|this
operator|.
name|path
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|value
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
if|if
condition|(
name|LayoutVersion
operator|.
name|supports
argument_list|(
name|Feature
operator|.
name|EDITLOG_OP_OPTIMIZATION
argument_list|,
name|logVersion
argument_list|)
condition|)
block|{
name|this
operator|.
name|mtime
operator|=
name|FSImageSerialization
operator|.
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|atime
operator|=
name|FSImageSerialization
operator|.
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|mtime
operator|=
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|atime
operator|=
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
name|this
operator|.
name|permissionStatus
operator|=
name|PermissionStatus
operator|.
name|read
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|toString ()
specifier|public
name|String
name|toString
parameter_list|()
block|{
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"SymlinkOp [length="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|length
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", path="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", value="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", mtime="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|mtime
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", atime="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|atime
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", permissionStatus="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|permissionStatus
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", opCode="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|opCode
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", txid="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|txid
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|toString
argument_list|()
return|;
block|}
annotation|@
name|Override
DECL|method|toXml (ContentHandler contentHandler)
specifier|protected
name|void
name|toXml
parameter_list|(
name|ContentHandler
name|contentHandler
parameter_list|)
throws|throws
name|SAXException
block|{
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"LENGTH"
argument_list|,
name|Integer
operator|.
name|valueOf
argument_list|(
name|length
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"PATH"
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"VALUE"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"MTIME"
argument_list|,
name|Long
operator|.
name|valueOf
argument_list|(
name|mtime
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"ATIME"
argument_list|,
name|Long
operator|.
name|valueOf
argument_list|(
name|atime
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|FSEditLogOp
operator|.
name|permissionStatusToXml
argument_list|(
name|contentHandler
argument_list|,
name|permissionStatus
argument_list|)
expr_stmt|;
block|}
DECL|method|fromXml (Stanza st)
annotation|@
name|Override
name|void
name|fromXml
parameter_list|(
name|Stanza
name|st
parameter_list|)
throws|throws
name|InvalidXmlException
block|{
name|this
operator|.
name|length
operator|=
name|Integer
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"LENGTH"
argument_list|)
argument_list|)
expr_stmt|;
name|this
operator|.
name|path
operator|=
name|st
operator|.
name|getValue
argument_list|(
literal|"PATH"
argument_list|)
expr_stmt|;
name|this
operator|.
name|value
operator|=
name|st
operator|.
name|getValue
argument_list|(
literal|"VALUE"
argument_list|)
expr_stmt|;
name|this
operator|.
name|mtime
operator|=
name|Long
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"MTIME"
argument_list|)
argument_list|)
expr_stmt|;
name|this
operator|.
name|atime
operator|=
name|Long
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"ATIME"
argument_list|)
argument_list|)
expr_stmt|;
name|this
operator|.
name|permissionStatus
operator|=
name|permissionStatusFromXml
argument_list|(
name|st
operator|.
name|getChildren
argument_list|(
literal|"PERMISSION_STATUS"
argument_list|)
operator|.
name|get
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|RenameOp
specifier|static
class|class
name|RenameOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|length
name|int
name|length
decl_stmt|;
DECL|field|src
name|String
name|src
decl_stmt|;
DECL|field|dst
name|String
name|dst
decl_stmt|;
DECL|field|timestamp
name|long
name|timestamp
decl_stmt|;
DECL|field|options
name|Rename
index|[]
name|options
decl_stmt|;
DECL|method|RenameOp ()
specifier|private
name|RenameOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_RENAME
argument_list|)
expr_stmt|;
block|}
DECL|method|getInstance (OpInstanceCache cache)
specifier|static
name|RenameOp
name|getInstance
parameter_list|(
name|OpInstanceCache
name|cache
parameter_list|)
block|{
return|return
operator|(
name|RenameOp
operator|)
name|cache
operator|.
name|get
argument_list|(
name|OP_RENAME
argument_list|)
return|;
block|}
DECL|method|setSource (String src)
name|RenameOp
name|setSource
parameter_list|(
name|String
name|src
parameter_list|)
block|{
name|this
operator|.
name|src
operator|=
name|src
expr_stmt|;
return|return
name|this
return|;
block|}
DECL|method|setDestination (String dst)
name|RenameOp
name|setDestination
parameter_list|(
name|String
name|dst
parameter_list|)
block|{
name|this
operator|.
name|dst
operator|=
name|dst
expr_stmt|;
return|return
name|this
return|;
block|}
DECL|method|setTimestamp (long timestamp)
name|RenameOp
name|setTimestamp
parameter_list|(
name|long
name|timestamp
parameter_list|)
block|{
name|this
operator|.
name|timestamp
operator|=
name|timestamp
expr_stmt|;
return|return
name|this
return|;
block|}
DECL|method|setOptions (Rename[] options)
name|RenameOp
name|setOptions
parameter_list|(
name|Rename
index|[]
name|options
parameter_list|)
block|{
name|this
operator|.
name|options
operator|=
name|options
expr_stmt|;
return|return
name|this
return|;
block|}
annotation|@
name|Override
specifier|public
DECL|method|writeFields (DataOutputStream out)
name|void
name|writeFields
parameter_list|(
name|DataOutputStream
name|out
parameter_list|)
throws|throws
name|IOException
block|{
name|FSImageSerialization
operator|.
name|writeString
argument_list|(
name|src
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|FSImageSerialization
operator|.
name|writeString
argument_list|(
name|dst
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|FSImageSerialization
operator|.
name|writeLong
argument_list|(
name|timestamp
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|toBytesWritable
argument_list|(
name|options
argument_list|)
operator|.
name|write
argument_list|(
name|out
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|readFields (DataInputStream in, int logVersion)
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
operator|!
name|LayoutVersion
operator|.
name|supports
argument_list|(
name|Feature
operator|.
name|EDITLOG_OP_OPTIMIZATION
argument_list|,
name|logVersion
argument_list|)
condition|)
block|{
name|this
operator|.
name|length
operator|=
name|in
operator|.
name|readInt
argument_list|()
expr_stmt|;
if|if
condition|(
name|this
operator|.
name|length
operator|!=
literal|3
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Incorrect data format. "
operator|+
literal|"Rename operation."
argument_list|)
throw|;
block|}
block|}
name|this
operator|.
name|src
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|dst
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
if|if
condition|(
name|LayoutVersion
operator|.
name|supports
argument_list|(
name|Feature
operator|.
name|EDITLOG_OP_OPTIMIZATION
argument_list|,
name|logVersion
argument_list|)
condition|)
block|{
name|this
operator|.
name|timestamp
operator|=
name|FSImageSerialization
operator|.
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|timestamp
operator|=
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
name|this
operator|.
name|options
operator|=
name|readRenameOptions
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
DECL|method|readRenameOptions (DataInputStream in)
specifier|private
specifier|static
name|Rename
index|[]
name|readRenameOptions
parameter_list|(
name|DataInputStream
name|in
parameter_list|)
throws|throws
name|IOException
block|{
name|BytesWritable
name|writable
init|=
operator|new
name|BytesWritable
argument_list|()
decl_stmt|;
name|writable
operator|.
name|readFields
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|byte
index|[]
name|bytes
init|=
name|writable
operator|.
name|getBytes
argument_list|()
decl_stmt|;
name|Rename
index|[]
name|options
init|=
operator|new
name|Rename
index|[
name|bytes
operator|.
name|length
index|]
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|bytes
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|options
index|[
name|i
index|]
operator|=
name|Rename
operator|.
name|valueOf
argument_list|(
name|bytes
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
return|return
name|options
return|;
block|}
DECL|method|toBytesWritable (Rename... options)
specifier|static
name|BytesWritable
name|toBytesWritable
parameter_list|(
name|Rename
modifier|...
name|options
parameter_list|)
block|{
name|byte
index|[]
name|bytes
init|=
operator|new
name|byte
index|[
name|options
operator|.
name|length
index|]
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|options
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|bytes
index|[
name|i
index|]
operator|=
name|options
index|[
name|i
index|]
operator|.
name|value
argument_list|()
expr_stmt|;
block|}
return|return
operator|new
name|BytesWritable
argument_list|(
name|bytes
argument_list|)
return|;
block|}
annotation|@
name|Override
DECL|method|toString ()
specifier|public
name|String
name|toString
parameter_list|()
block|{
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"RenameOp [length="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|length
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", src="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", dst="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|dst
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", timestamp="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|timestamp
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", options="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|Arrays
operator|.
name|toString
argument_list|(
name|options
argument_list|)
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", opCode="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|opCode
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", txid="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|txid
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|toString
argument_list|()
return|;
block|}
annotation|@
name|Override
DECL|method|toXml (ContentHandler contentHandler)
specifier|protected
name|void
name|toXml
parameter_list|(
name|ContentHandler
name|contentHandler
parameter_list|)
throws|throws
name|SAXException
block|{
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"LENGTH"
argument_list|,
name|Integer
operator|.
name|valueOf
argument_list|(
name|length
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"SRC"
argument_list|,
name|src
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"DST"
argument_list|,
name|dst
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"TIMESTAMP"
argument_list|,
name|Long
operator|.
name|valueOf
argument_list|(
name|timestamp
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|StringBuilder
name|bld
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|String
name|prefix
init|=
literal|""
decl_stmt|;
for|for
control|(
name|Rename
name|r
range|:
name|options
control|)
block|{
name|bld
operator|.
name|append
argument_list|(
name|prefix
argument_list|)
operator|.
name|append
argument_list|(
name|r
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|prefix
operator|=
literal|"|"
expr_stmt|;
block|}
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"OPTIONS"
argument_list|,
name|bld
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|fromXml (Stanza st)
annotation|@
name|Override
name|void
name|fromXml
parameter_list|(
name|Stanza
name|st
parameter_list|)
throws|throws
name|InvalidXmlException
block|{
name|this
operator|.
name|length
operator|=
name|Integer
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"LENGTH"
argument_list|)
argument_list|)
expr_stmt|;
name|this
operator|.
name|src
operator|=
name|st
operator|.
name|getValue
argument_list|(
literal|"SRC"
argument_list|)
expr_stmt|;
name|this
operator|.
name|dst
operator|=
name|st
operator|.
name|getValue
argument_list|(
literal|"DST"
argument_list|)
expr_stmt|;
name|this
operator|.
name|timestamp
operator|=
name|Long
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"TIMESTAMP"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|opts
init|=
name|st
operator|.
name|getValue
argument_list|(
literal|"OPTIONS"
argument_list|)
decl_stmt|;
name|String
name|o
index|[]
init|=
name|opts
operator|.
name|split
argument_list|(
literal|"\\|"
argument_list|)
decl_stmt|;
name|this
operator|.
name|options
operator|=
operator|new
name|Rename
index|[
name|o
operator|.
name|length
index|]
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|o
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|o
index|[
name|i
index|]
operator|.
name|equals
argument_list|(
literal|""
argument_list|)
condition|)
continue|continue;
try|try
block|{
name|this
operator|.
name|options
index|[
name|i
index|]
operator|=
name|Rename
operator|.
name|valueOf
argument_list|(
name|o
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
name|this
operator|.
name|options
index|[
name|i
index|]
operator|==
literal|null
condition|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"error parsing Rename value: \""
operator|+
name|o
index|[
name|i
index|]
operator|+
literal|"\""
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
DECL|class|ReassignLeaseOp
specifier|static
class|class
name|ReassignLeaseOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|leaseHolder
name|String
name|leaseHolder
decl_stmt|;
DECL|field|path
name|String
name|path
decl_stmt|;
DECL|field|newHolder
name|String
name|newHolder
decl_stmt|;
DECL|method|ReassignLeaseOp ()
specifier|private
name|ReassignLeaseOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_REASSIGN_LEASE
argument_list|)
expr_stmt|;
block|}
DECL|method|getInstance (OpInstanceCache cache)
specifier|static
name|ReassignLeaseOp
name|getInstance
parameter_list|(
name|OpInstanceCache
name|cache
parameter_list|)
block|{
return|return
operator|(
name|ReassignLeaseOp
operator|)
name|cache
operator|.
name|get
argument_list|(
name|OP_REASSIGN_LEASE
argument_list|)
return|;
block|}
DECL|method|setLeaseHolder (String leaseHolder)
name|ReassignLeaseOp
name|setLeaseHolder
parameter_list|(
name|String
name|leaseHolder
parameter_list|)
block|{
name|this
operator|.
name|leaseHolder
operator|=
name|leaseHolder
expr_stmt|;
return|return
name|this
return|;
block|}
DECL|method|setPath (String path)
name|ReassignLeaseOp
name|setPath
parameter_list|(
name|String
name|path
parameter_list|)
block|{
name|this
operator|.
name|path
operator|=
name|path
expr_stmt|;
return|return
name|this
return|;
block|}
DECL|method|setNewHolder (String newHolder)
name|ReassignLeaseOp
name|setNewHolder
parameter_list|(
name|String
name|newHolder
parameter_list|)
block|{
name|this
operator|.
name|newHolder
operator|=
name|newHolder
expr_stmt|;
return|return
name|this
return|;
block|}
annotation|@
name|Override
specifier|public
DECL|method|writeFields (DataOutputStream out)
name|void
name|writeFields
parameter_list|(
name|DataOutputStream
name|out
parameter_list|)
throws|throws
name|IOException
block|{
name|FSImageSerialization
operator|.
name|writeString
argument_list|(
name|leaseHolder
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|FSImageSerialization
operator|.
name|writeString
argument_list|(
name|path
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|FSImageSerialization
operator|.
name|writeString
argument_list|(
name|newHolder
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|readFields (DataInputStream in, int logVersion)
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|leaseHolder
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|path
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|newHolder
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|toString ()
specifier|public
name|String
name|toString
parameter_list|()
block|{
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"ReassignLeaseOp [leaseHolder="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|leaseHolder
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", path="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", newHolder="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|newHolder
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", opCode="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|opCode
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", txid="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|txid
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|toString
argument_list|()
return|;
block|}
annotation|@
name|Override
DECL|method|toXml (ContentHandler contentHandler)
specifier|protected
name|void
name|toXml
parameter_list|(
name|ContentHandler
name|contentHandler
parameter_list|)
throws|throws
name|SAXException
block|{
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"LEASEHOLDER"
argument_list|,
name|leaseHolder
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"PATH"
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"NEWHOLDER"
argument_list|,
name|newHolder
argument_list|)
expr_stmt|;
block|}
DECL|method|fromXml (Stanza st)
annotation|@
name|Override
name|void
name|fromXml
parameter_list|(
name|Stanza
name|st
parameter_list|)
throws|throws
name|InvalidXmlException
block|{
name|this
operator|.
name|leaseHolder
operator|=
name|st
operator|.
name|getValue
argument_list|(
literal|"LEASEHOLDER"
argument_list|)
expr_stmt|;
name|this
operator|.
name|path
operator|=
name|st
operator|.
name|getValue
argument_list|(
literal|"PATH"
argument_list|)
expr_stmt|;
name|this
operator|.
name|newHolder
operator|=
name|st
operator|.
name|getValue
argument_list|(
literal|"NEWHOLDER"
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|GetDelegationTokenOp
specifier|static
class|class
name|GetDelegationTokenOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|token
name|DelegationTokenIdentifier
name|token
decl_stmt|;
DECL|field|expiryTime
name|long
name|expiryTime
decl_stmt|;
DECL|method|GetDelegationTokenOp ()
specifier|private
name|GetDelegationTokenOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_GET_DELEGATION_TOKEN
argument_list|)
expr_stmt|;
block|}
DECL|method|getInstance (OpInstanceCache cache)
specifier|static
name|GetDelegationTokenOp
name|getInstance
parameter_list|(
name|OpInstanceCache
name|cache
parameter_list|)
block|{
return|return
operator|(
name|GetDelegationTokenOp
operator|)
name|cache
operator|.
name|get
argument_list|(
name|OP_GET_DELEGATION_TOKEN
argument_list|)
return|;
block|}
DECL|method|setDelegationTokenIdentifier ( DelegationTokenIdentifier token)
name|GetDelegationTokenOp
name|setDelegationTokenIdentifier
parameter_list|(
name|DelegationTokenIdentifier
name|token
parameter_list|)
block|{
name|this
operator|.
name|token
operator|=
name|token
expr_stmt|;
return|return
name|this
return|;
block|}
DECL|method|setExpiryTime (long expiryTime)
name|GetDelegationTokenOp
name|setExpiryTime
parameter_list|(
name|long
name|expiryTime
parameter_list|)
block|{
name|this
operator|.
name|expiryTime
operator|=
name|expiryTime
expr_stmt|;
return|return
name|this
return|;
block|}
annotation|@
name|Override
specifier|public
DECL|method|writeFields (DataOutputStream out)
name|void
name|writeFields
parameter_list|(
name|DataOutputStream
name|out
parameter_list|)
throws|throws
name|IOException
block|{
name|token
operator|.
name|write
argument_list|(
name|out
argument_list|)
expr_stmt|;
name|FSImageSerialization
operator|.
name|writeLong
argument_list|(
name|expiryTime
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|readFields (DataInputStream in, int logVersion)
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|token
operator|=
operator|new
name|DelegationTokenIdentifier
argument_list|()
expr_stmt|;
name|this
operator|.
name|token
operator|.
name|readFields
argument_list|(
name|in
argument_list|)
expr_stmt|;
if|if
condition|(
name|LayoutVersion
operator|.
name|supports
argument_list|(
name|Feature
operator|.
name|EDITLOG_OP_OPTIMIZATION
argument_list|,
name|logVersion
argument_list|)
condition|)
block|{
name|this
operator|.
name|expiryTime
operator|=
name|FSImageSerialization
operator|.
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|expiryTime
operator|=
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|toString ()
specifier|public
name|String
name|toString
parameter_list|()
block|{
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"GetDelegationTokenOp [token="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|token
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", expiryTime="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|expiryTime
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", opCode="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|opCode
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", txid="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|txid
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|toString
argument_list|()
return|;
block|}
annotation|@
name|Override
DECL|method|toXml (ContentHandler contentHandler)
specifier|protected
name|void
name|toXml
parameter_list|(
name|ContentHandler
name|contentHandler
parameter_list|)
throws|throws
name|SAXException
block|{
name|FSEditLogOp
operator|.
name|delegationTokenToXml
argument_list|(
name|contentHandler
argument_list|,
name|token
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"EXPIRY_TIME"
argument_list|,
name|Long
operator|.
name|valueOf
argument_list|(
name|expiryTime
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|fromXml (Stanza st)
annotation|@
name|Override
name|void
name|fromXml
parameter_list|(
name|Stanza
name|st
parameter_list|)
throws|throws
name|InvalidXmlException
block|{
name|this
operator|.
name|token
operator|=
name|delegationTokenFromXml
argument_list|(
name|st
operator|.
name|getChildren
argument_list|(
literal|"DELEGATION_TOKEN_IDENTIFIER"
argument_list|)
operator|.
name|get
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|this
operator|.
name|expiryTime
operator|=
name|Long
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"EXPIRY_TIME"
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|RenewDelegationTokenOp
specifier|static
class|class
name|RenewDelegationTokenOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|token
name|DelegationTokenIdentifier
name|token
decl_stmt|;
DECL|field|expiryTime
name|long
name|expiryTime
decl_stmt|;
DECL|method|RenewDelegationTokenOp ()
specifier|private
name|RenewDelegationTokenOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_RENEW_DELEGATION_TOKEN
argument_list|)
expr_stmt|;
block|}
DECL|method|getInstance (OpInstanceCache cache)
specifier|static
name|RenewDelegationTokenOp
name|getInstance
parameter_list|(
name|OpInstanceCache
name|cache
parameter_list|)
block|{
return|return
operator|(
name|RenewDelegationTokenOp
operator|)
name|cache
operator|.
name|get
argument_list|(
name|OP_RENEW_DELEGATION_TOKEN
argument_list|)
return|;
block|}
DECL|method|setDelegationTokenIdentifier ( DelegationTokenIdentifier token)
name|RenewDelegationTokenOp
name|setDelegationTokenIdentifier
parameter_list|(
name|DelegationTokenIdentifier
name|token
parameter_list|)
block|{
name|this
operator|.
name|token
operator|=
name|token
expr_stmt|;
return|return
name|this
return|;
block|}
DECL|method|setExpiryTime (long expiryTime)
name|RenewDelegationTokenOp
name|setExpiryTime
parameter_list|(
name|long
name|expiryTime
parameter_list|)
block|{
name|this
operator|.
name|expiryTime
operator|=
name|expiryTime
expr_stmt|;
return|return
name|this
return|;
block|}
annotation|@
name|Override
specifier|public
DECL|method|writeFields (DataOutputStream out)
name|void
name|writeFields
parameter_list|(
name|DataOutputStream
name|out
parameter_list|)
throws|throws
name|IOException
block|{
name|token
operator|.
name|write
argument_list|(
name|out
argument_list|)
expr_stmt|;
name|FSImageSerialization
operator|.
name|writeLong
argument_list|(
name|expiryTime
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|readFields (DataInputStream in, int logVersion)
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|token
operator|=
operator|new
name|DelegationTokenIdentifier
argument_list|()
expr_stmt|;
name|this
operator|.
name|token
operator|.
name|readFields
argument_list|(
name|in
argument_list|)
expr_stmt|;
if|if
condition|(
name|LayoutVersion
operator|.
name|supports
argument_list|(
name|Feature
operator|.
name|EDITLOG_OP_OPTIMIZATION
argument_list|,
name|logVersion
argument_list|)
condition|)
block|{
name|this
operator|.
name|expiryTime
operator|=
name|FSImageSerialization
operator|.
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|expiryTime
operator|=
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|toString ()
specifier|public
name|String
name|toString
parameter_list|()
block|{
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"RenewDelegationTokenOp [token="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|token
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", expiryTime="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|expiryTime
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", opCode="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|opCode
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", txid="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|txid
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|toString
argument_list|()
return|;
block|}
annotation|@
name|Override
DECL|method|toXml (ContentHandler contentHandler)
specifier|protected
name|void
name|toXml
parameter_list|(
name|ContentHandler
name|contentHandler
parameter_list|)
throws|throws
name|SAXException
block|{
name|FSEditLogOp
operator|.
name|delegationTokenToXml
argument_list|(
name|contentHandler
argument_list|,
name|token
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"EXPIRY_TIME"
argument_list|,
name|Long
operator|.
name|valueOf
argument_list|(
name|expiryTime
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|fromXml (Stanza st)
annotation|@
name|Override
name|void
name|fromXml
parameter_list|(
name|Stanza
name|st
parameter_list|)
throws|throws
name|InvalidXmlException
block|{
name|this
operator|.
name|token
operator|=
name|delegationTokenFromXml
argument_list|(
name|st
operator|.
name|getChildren
argument_list|(
literal|"DELEGATION_TOKEN_IDENTIFIER"
argument_list|)
operator|.
name|get
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|this
operator|.
name|expiryTime
operator|=
name|Long
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"EXPIRY_TIME"
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|CancelDelegationTokenOp
specifier|static
class|class
name|CancelDelegationTokenOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|token
name|DelegationTokenIdentifier
name|token
decl_stmt|;
DECL|method|CancelDelegationTokenOp ()
specifier|private
name|CancelDelegationTokenOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_CANCEL_DELEGATION_TOKEN
argument_list|)
expr_stmt|;
block|}
DECL|method|getInstance (OpInstanceCache cache)
specifier|static
name|CancelDelegationTokenOp
name|getInstance
parameter_list|(
name|OpInstanceCache
name|cache
parameter_list|)
block|{
return|return
operator|(
name|CancelDelegationTokenOp
operator|)
name|cache
operator|.
name|get
argument_list|(
name|OP_CANCEL_DELEGATION_TOKEN
argument_list|)
return|;
block|}
DECL|method|setDelegationTokenIdentifier ( DelegationTokenIdentifier token)
name|CancelDelegationTokenOp
name|setDelegationTokenIdentifier
parameter_list|(
name|DelegationTokenIdentifier
name|token
parameter_list|)
block|{
name|this
operator|.
name|token
operator|=
name|token
expr_stmt|;
return|return
name|this
return|;
block|}
annotation|@
name|Override
specifier|public
DECL|method|writeFields (DataOutputStream out)
name|void
name|writeFields
parameter_list|(
name|DataOutputStream
name|out
parameter_list|)
throws|throws
name|IOException
block|{
name|token
operator|.
name|write
argument_list|(
name|out
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|readFields (DataInputStream in, int logVersion)
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|token
operator|=
operator|new
name|DelegationTokenIdentifier
argument_list|()
expr_stmt|;
name|this
operator|.
name|token
operator|.
name|readFields
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|toString ()
specifier|public
name|String
name|toString
parameter_list|()
block|{
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"CancelDelegationTokenOp [token="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|token
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", opCode="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|opCode
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", txid="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|txid
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|toString
argument_list|()
return|;
block|}
annotation|@
name|Override
DECL|method|toXml (ContentHandler contentHandler)
specifier|protected
name|void
name|toXml
parameter_list|(
name|ContentHandler
name|contentHandler
parameter_list|)
throws|throws
name|SAXException
block|{
name|FSEditLogOp
operator|.
name|delegationTokenToXml
argument_list|(
name|contentHandler
argument_list|,
name|token
argument_list|)
expr_stmt|;
block|}
DECL|method|fromXml (Stanza st)
annotation|@
name|Override
name|void
name|fromXml
parameter_list|(
name|Stanza
name|st
parameter_list|)
throws|throws
name|InvalidXmlException
block|{
name|this
operator|.
name|token
operator|=
name|delegationTokenFromXml
argument_list|(
name|st
operator|.
name|getChildren
argument_list|(
literal|"DELEGATION_TOKEN_IDENTIFIER"
argument_list|)
operator|.
name|get
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|UpdateMasterKeyOp
specifier|static
class|class
name|UpdateMasterKeyOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|key
name|DelegationKey
name|key
decl_stmt|;
DECL|method|UpdateMasterKeyOp ()
specifier|private
name|UpdateMasterKeyOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_UPDATE_MASTER_KEY
argument_list|)
expr_stmt|;
block|}
DECL|method|getInstance (OpInstanceCache cache)
specifier|static
name|UpdateMasterKeyOp
name|getInstance
parameter_list|(
name|OpInstanceCache
name|cache
parameter_list|)
block|{
return|return
operator|(
name|UpdateMasterKeyOp
operator|)
name|cache
operator|.
name|get
argument_list|(
name|OP_UPDATE_MASTER_KEY
argument_list|)
return|;
block|}
DECL|method|setDelegationKey (DelegationKey key)
name|UpdateMasterKeyOp
name|setDelegationKey
parameter_list|(
name|DelegationKey
name|key
parameter_list|)
block|{
name|this
operator|.
name|key
operator|=
name|key
expr_stmt|;
return|return
name|this
return|;
block|}
annotation|@
name|Override
specifier|public
DECL|method|writeFields (DataOutputStream out)
name|void
name|writeFields
parameter_list|(
name|DataOutputStream
name|out
parameter_list|)
throws|throws
name|IOException
block|{
name|key
operator|.
name|write
argument_list|(
name|out
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|readFields (DataInputStream in, int logVersion)
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|key
operator|=
operator|new
name|DelegationKey
argument_list|()
expr_stmt|;
name|this
operator|.
name|key
operator|.
name|readFields
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|toString ()
specifier|public
name|String
name|toString
parameter_list|()
block|{
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"UpdateMasterKeyOp [key="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|key
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", opCode="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|opCode
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", txid="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|txid
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|toString
argument_list|()
return|;
block|}
annotation|@
name|Override
DECL|method|toXml (ContentHandler contentHandler)
specifier|protected
name|void
name|toXml
parameter_list|(
name|ContentHandler
name|contentHandler
parameter_list|)
throws|throws
name|SAXException
block|{
name|FSEditLogOp
operator|.
name|delegationKeyToXml
argument_list|(
name|contentHandler
argument_list|,
name|key
argument_list|)
expr_stmt|;
block|}
DECL|method|fromXml (Stanza st)
annotation|@
name|Override
name|void
name|fromXml
parameter_list|(
name|Stanza
name|st
parameter_list|)
throws|throws
name|InvalidXmlException
block|{
name|this
operator|.
name|key
operator|=
name|delegationKeyFromXml
argument_list|(
name|st
operator|.
name|getChildren
argument_list|(
literal|"DELEGATION_KEY"
argument_list|)
operator|.
name|get
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|LogSegmentOp
specifier|static
class|class
name|LogSegmentOp
extends|extends
name|FSEditLogOp
block|{
DECL|method|LogSegmentOp (FSEditLogOpCodes code)
specifier|private
name|LogSegmentOp
parameter_list|(
name|FSEditLogOpCodes
name|code
parameter_list|)
block|{
name|super
argument_list|(
name|code
argument_list|)
expr_stmt|;
assert|assert
name|code
operator|==
name|OP_START_LOG_SEGMENT
operator|||
name|code
operator|==
name|OP_END_LOG_SEGMENT
operator|:
literal|"Bad op: "
operator|+
name|code
assert|;
block|}
DECL|method|getInstance (OpInstanceCache cache, FSEditLogOpCodes code)
specifier|static
name|LogSegmentOp
name|getInstance
parameter_list|(
name|OpInstanceCache
name|cache
parameter_list|,
name|FSEditLogOpCodes
name|code
parameter_list|)
block|{
return|return
operator|(
name|LogSegmentOp
operator|)
name|cache
operator|.
name|get
argument_list|(
name|code
argument_list|)
return|;
block|}
DECL|method|readFields (DataInputStream in, int logVersion)
specifier|public
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
comment|// no data stored in these ops yet
block|}
annotation|@
name|Override
specifier|public
DECL|method|writeFields (DataOutputStream out)
name|void
name|writeFields
parameter_list|(
name|DataOutputStream
name|out
parameter_list|)
throws|throws
name|IOException
block|{
comment|// no data stored
block|}
annotation|@
name|Override
DECL|method|toString ()
specifier|public
name|String
name|toString
parameter_list|()
block|{
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"LogSegmentOp [opCode="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|opCode
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", txid="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|txid
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|toString
argument_list|()
return|;
block|}
annotation|@
name|Override
DECL|method|toXml (ContentHandler contentHandler)
specifier|protected
name|void
name|toXml
parameter_list|(
name|ContentHandler
name|contentHandler
parameter_list|)
throws|throws
name|SAXException
block|{
comment|// no data stored
block|}
DECL|method|fromXml (Stanza st)
annotation|@
name|Override
name|void
name|fromXml
parameter_list|(
name|Stanza
name|st
parameter_list|)
throws|throws
name|InvalidXmlException
block|{
comment|// do nothing
block|}
block|}
DECL|class|InvalidOp
specifier|static
class|class
name|InvalidOp
extends|extends
name|FSEditLogOp
block|{
DECL|method|InvalidOp ()
specifier|private
name|InvalidOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_INVALID
argument_list|)
expr_stmt|;
block|}
DECL|method|getInstance (OpInstanceCache cache)
specifier|static
name|InvalidOp
name|getInstance
parameter_list|(
name|OpInstanceCache
name|cache
parameter_list|)
block|{
return|return
operator|(
name|InvalidOp
operator|)
name|cache
operator|.
name|get
argument_list|(
name|OP_INVALID
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
DECL|method|writeFields (DataOutputStream out)
name|void
name|writeFields
parameter_list|(
name|DataOutputStream
name|out
parameter_list|)
throws|throws
name|IOException
block|{     }
annotation|@
name|Override
DECL|method|readFields (DataInputStream in, int logVersion)
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
comment|// nothing to read
block|}
annotation|@
name|Override
DECL|method|toString ()
specifier|public
name|String
name|toString
parameter_list|()
block|{
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"InvalidOp [opCode="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|opCode
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|", txid="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|txid
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|toString
argument_list|()
return|;
block|}
annotation|@
name|Override
DECL|method|toXml (ContentHandler contentHandler)
specifier|protected
name|void
name|toXml
parameter_list|(
name|ContentHandler
name|contentHandler
parameter_list|)
throws|throws
name|SAXException
block|{
comment|// no data stored
block|}
DECL|method|fromXml (Stanza st)
annotation|@
name|Override
name|void
name|fromXml
parameter_list|(
name|Stanza
name|st
parameter_list|)
throws|throws
name|InvalidXmlException
block|{
comment|// do nothing
block|}
block|}
DECL|method|readShort (DataInputStream in)
specifier|static
specifier|private
name|short
name|readShort
parameter_list|(
name|DataInputStream
name|in
parameter_list|)
throws|throws
name|IOException
block|{
return|return
name|Short
operator|.
name|parseShort
argument_list|(
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
argument_list|)
return|;
block|}
DECL|method|readLong (DataInputStream in)
specifier|static
specifier|private
name|long
name|readLong
parameter_list|(
name|DataInputStream
name|in
parameter_list|)
throws|throws
name|IOException
block|{
return|return
name|Long
operator|.
name|parseLong
argument_list|(
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
argument_list|)
return|;
block|}
comment|/**    * A class to read in blocks stored in the old format. The only two    * fields in the block were blockid and length.    */
DECL|class|BlockTwo
specifier|static
class|class
name|BlockTwo
implements|implements
name|Writable
block|{
DECL|field|blkid
name|long
name|blkid
decl_stmt|;
DECL|field|len
name|long
name|len
decl_stmt|;
static|static
block|{
comment|// register a ctor
name|WritableFactories
operator|.
name|setFactory
argument_list|(
name|BlockTwo
operator|.
name|class
argument_list|,
operator|new
name|WritableFactory
argument_list|()
block|{
specifier|public
name|Writable
name|newInstance
parameter_list|()
block|{
return|return
operator|new
name|BlockTwo
argument_list|()
return|;
block|}
block|}
argument_list|)
expr_stmt|;
block|}
DECL|method|BlockTwo ()
name|BlockTwo
parameter_list|()
block|{
name|blkid
operator|=
literal|0
expr_stmt|;
name|len
operator|=
literal|0
expr_stmt|;
block|}
comment|/////////////////////////////////////
comment|// Writable
comment|/////////////////////////////////////
DECL|method|write (DataOutput out)
specifier|public
name|void
name|write
parameter_list|(
name|DataOutput
name|out
parameter_list|)
throws|throws
name|IOException
block|{
name|out
operator|.
name|writeLong
argument_list|(
name|blkid
argument_list|)
expr_stmt|;
name|out
operator|.
name|writeLong
argument_list|(
name|len
argument_list|)
expr_stmt|;
block|}
DECL|method|readFields (DataInput in)
specifier|public
name|void
name|readFields
parameter_list|(
name|DataInput
name|in
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|blkid
operator|=
name|in
operator|.
name|readLong
argument_list|()
expr_stmt|;
name|this
operator|.
name|len
operator|=
name|in
operator|.
name|readLong
argument_list|()
expr_stmt|;
block|}
block|}
comment|/**    * Class for writing editlog ops    */
DECL|class|Writer
specifier|public
specifier|static
class|class
name|Writer
block|{
DECL|field|buf
specifier|private
specifier|final
name|DataOutputBuffer
name|buf
decl_stmt|;
DECL|field|checksum
specifier|private
specifier|final
name|Checksum
name|checksum
decl_stmt|;
DECL|method|Writer (DataOutputBuffer out)
specifier|public
name|Writer
parameter_list|(
name|DataOutputBuffer
name|out
parameter_list|)
block|{
name|this
operator|.
name|buf
operator|=
name|out
expr_stmt|;
name|this
operator|.
name|checksum
operator|=
operator|new
name|PureJavaCrc32
argument_list|()
expr_stmt|;
block|}
comment|/**      * Write an operation to the output stream      *       * @param op The operation to write      * @throws IOException if an error occurs during writing.      */
DECL|method|writeOp (FSEditLogOp op)
specifier|public
name|void
name|writeOp
parameter_list|(
name|FSEditLogOp
name|op
parameter_list|)
throws|throws
name|IOException
block|{
name|int
name|start
init|=
name|buf
operator|.
name|getLength
argument_list|()
decl_stmt|;
name|buf
operator|.
name|writeByte
argument_list|(
name|op
operator|.
name|opCode
operator|.
name|getOpCode
argument_list|()
argument_list|)
expr_stmt|;
name|buf
operator|.
name|writeLong
argument_list|(
name|op
operator|.
name|txid
argument_list|)
expr_stmt|;
name|op
operator|.
name|writeFields
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|int
name|end
init|=
name|buf
operator|.
name|getLength
argument_list|()
decl_stmt|;
name|checksum
operator|.
name|reset
argument_list|()
expr_stmt|;
name|checksum
operator|.
name|update
argument_list|(
name|buf
operator|.
name|getData
argument_list|()
argument_list|,
name|start
argument_list|,
name|end
operator|-
name|start
argument_list|)
expr_stmt|;
name|int
name|sum
init|=
operator|(
name|int
operator|)
name|checksum
operator|.
name|getValue
argument_list|()
decl_stmt|;
name|buf
operator|.
name|writeInt
argument_list|(
name|sum
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**    * Class for reading editlog ops from a stream    */
DECL|class|Reader
specifier|public
specifier|static
class|class
name|Reader
block|{
DECL|field|in
specifier|private
specifier|final
name|DataInputStream
name|in
decl_stmt|;
DECL|field|limiter
specifier|private
specifier|final
name|StreamLimiter
name|limiter
decl_stmt|;
DECL|field|logVersion
specifier|private
specifier|final
name|int
name|logVersion
decl_stmt|;
DECL|field|checksum
specifier|private
specifier|final
name|Checksum
name|checksum
decl_stmt|;
DECL|field|cache
specifier|private
specifier|final
name|OpInstanceCache
name|cache
decl_stmt|;
comment|/**      * Construct the reader      * @param in The stream to read from.      * @param logVersion The version of the data coming from the stream.      */
annotation|@
name|SuppressWarnings
argument_list|(
literal|"deprecation"
argument_list|)
DECL|method|Reader (DataInputStream in, StreamLimiter limiter, int logVersion)
specifier|public
name|Reader
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|StreamLimiter
name|limiter
parameter_list|,
name|int
name|logVersion
parameter_list|)
block|{
name|this
operator|.
name|logVersion
operator|=
name|logVersion
expr_stmt|;
if|if
condition|(
name|LayoutVersion
operator|.
name|supports
argument_list|(
name|Feature
operator|.
name|EDITS_CHESKUM
argument_list|,
name|logVersion
argument_list|)
condition|)
block|{
name|this
operator|.
name|checksum
operator|=
operator|new
name|PureJavaCrc32
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|checksum
operator|=
literal|null
expr_stmt|;
block|}
if|if
condition|(
name|this
operator|.
name|checksum
operator|!=
literal|null
condition|)
block|{
name|this
operator|.
name|in
operator|=
operator|new
name|DataInputStream
argument_list|(
operator|new
name|CheckedInputStream
argument_list|(
name|in
argument_list|,
name|this
operator|.
name|checksum
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|in
operator|=
name|in
expr_stmt|;
block|}
name|this
operator|.
name|limiter
operator|=
name|limiter
expr_stmt|;
name|this
operator|.
name|cache
operator|=
operator|new
name|OpInstanceCache
argument_list|()
expr_stmt|;
block|}
comment|/**      * Read an operation from the input stream.      *       * Note that the objects returned from this method may be re-used by future      * calls to the same method.      *       * @param skipBrokenEdits    If true, attempt to skip over damaged parts of      * the input stream, rather than throwing an IOException      * @return the operation read from the stream, or null at the end of the       *         file      * @throws IOException on error.  This function should only throw an      *         exception when skipBrokenEdits is false.      */
DECL|method|readOp (boolean skipBrokenEdits)
specifier|public
name|FSEditLogOp
name|readOp
parameter_list|(
name|boolean
name|skipBrokenEdits
parameter_list|)
throws|throws
name|IOException
block|{
while|while
condition|(
literal|true
condition|)
block|{
try|try
block|{
name|limiter
operator|.
name|setLimit
argument_list|(
name|MAX_OP_SIZE
argument_list|)
expr_stmt|;
name|in
operator|.
name|mark
argument_list|(
name|MAX_OP_SIZE
argument_list|)
expr_stmt|;
return|return
name|decodeOp
argument_list|()
return|;
block|}
catch|catch
parameter_list|(
name|GarbageAfterTerminatorException
name|e
parameter_list|)
block|{
name|in
operator|.
name|reset
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|skipBrokenEdits
condition|)
block|{
throw|throw
name|e
throw|;
block|}
comment|// If we saw a terminator opcode followed by a long region of 0x00 or
comment|// 0xff, we want to skip over that region, because there's nothing
comment|// interesting there.
name|long
name|numSkip
init|=
name|e
operator|.
name|getNumAfterTerminator
argument_list|()
decl_stmt|;
if|if
condition|(
name|in
operator|.
name|skip
argument_list|(
name|numSkip
argument_list|)
operator|<
name|numSkip
condition|)
block|{
name|FSImage
operator|.
name|LOG
operator|.
name|error
argument_list|(
literal|"Failed to skip "
operator|+
name|numSkip
operator|+
literal|" bytes of "
operator|+
literal|"garbage after an OP_INVALID.  Unexpected early EOF."
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|in
operator|.
name|reset
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|skipBrokenEdits
condition|)
block|{
throw|throw
name|e
throw|;
block|}
block|}
catch|catch
parameter_list|(
name|RuntimeException
name|e
parameter_list|)
block|{
comment|// FSEditLogOp#decodeOp is not supposed to throw RuntimeException.
comment|// However, we handle it here for recovery mode, just to be more
comment|// robust.
name|in
operator|.
name|reset
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|skipBrokenEdits
condition|)
block|{
throw|throw
name|e
throw|;
block|}
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
name|in
operator|.
name|reset
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|skipBrokenEdits
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"got unexpected exception "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
comment|// Move ahead one byte and re-try the decode process.
if|if
condition|(
name|in
operator|.
name|skip
argument_list|(
literal|1
argument_list|)
operator|<
literal|1
condition|)
block|{
return|return
literal|null
return|;
block|}
block|}
block|}
DECL|method|verifyTerminator ()
specifier|private
name|void
name|verifyTerminator
parameter_list|()
throws|throws
name|IOException
block|{
name|long
name|off
init|=
literal|0
decl_stmt|;
comment|/** The end of the edit log should contain only 0x00 or 0xff bytes.        * If it contains other bytes, the log itself may be corrupt.        * It is important to check this; if we don't, a stray OP_INVALID byte         * could make us stop reading the edit log halfway through, and we'd never        * know that we had lost data.        */
name|byte
index|[]
name|buf
init|=
operator|new
name|byte
index|[
literal|4096
index|]
decl_stmt|;
while|while
condition|(
literal|true
condition|)
block|{
name|int
name|numRead
init|=
name|in
operator|.
name|read
argument_list|(
name|buf
argument_list|)
decl_stmt|;
if|if
condition|(
name|numRead
operator|==
operator|-
literal|1
condition|)
block|{
return|return;
block|}
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|numRead
condition|;
name|i
operator|++
operator|,
name|off
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|buf
index|[
name|i
index|]
operator|!=
operator|(
name|byte
operator|)
literal|0
operator|)
operator|&&
operator|(
name|buf
index|[
name|i
index|]
operator|!=
operator|(
name|byte
operator|)
operator|-
literal|1
operator|)
condition|)
block|{
throw|throw
operator|new
name|GarbageAfterTerminatorException
argument_list|(
literal|"Read garbage after "
operator|+
literal|"the terminator!"
argument_list|,
name|off
argument_list|)
throw|;
block|}
block|}
block|}
block|}
DECL|method|decodeOp ()
specifier|private
name|FSEditLogOp
name|decodeOp
parameter_list|()
throws|throws
name|IOException
block|{
if|if
condition|(
name|checksum
operator|!=
literal|null
condition|)
block|{
name|checksum
operator|.
name|reset
argument_list|()
expr_stmt|;
block|}
name|byte
name|opCodeByte
decl_stmt|;
try|try
block|{
name|opCodeByte
operator|=
name|in
operator|.
name|readByte
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|EOFException
name|eof
parameter_list|)
block|{
comment|// EOF at an opcode boundary is expected.
return|return
literal|null
return|;
block|}
name|FSEditLogOpCodes
name|opCode
init|=
name|FSEditLogOpCodes
operator|.
name|fromByte
argument_list|(
name|opCodeByte
argument_list|)
decl_stmt|;
if|if
condition|(
name|opCode
operator|==
name|OP_INVALID
condition|)
block|{
name|verifyTerminator
argument_list|()
expr_stmt|;
return|return
literal|null
return|;
block|}
name|FSEditLogOp
name|op
init|=
name|cache
operator|.
name|get
argument_list|(
name|opCode
argument_list|)
decl_stmt|;
if|if
condition|(
name|op
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Read invalid opcode "
operator|+
name|opCode
argument_list|)
throw|;
block|}
if|if
condition|(
name|LayoutVersion
operator|.
name|supports
argument_list|(
name|Feature
operator|.
name|STORED_TXIDS
argument_list|,
name|logVersion
argument_list|)
condition|)
block|{
comment|// Read the txid
name|op
operator|.
name|setTransactionId
argument_list|(
name|in
operator|.
name|readLong
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|op
operator|.
name|setTransactionId
argument_list|(
name|HdfsConstants
operator|.
name|INVALID_TXID
argument_list|)
expr_stmt|;
block|}
name|op
operator|.
name|readFields
argument_list|(
name|in
argument_list|,
name|logVersion
argument_list|)
expr_stmt|;
name|validateChecksum
argument_list|(
name|in
argument_list|,
name|checksum
argument_list|,
name|op
operator|.
name|txid
argument_list|)
expr_stmt|;
return|return
name|op
return|;
block|}
comment|/**      * Validate a transaction's checksum      */
DECL|method|validateChecksum (DataInputStream in, Checksum checksum, long txid)
specifier|private
name|void
name|validateChecksum
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|Checksum
name|checksum
parameter_list|,
name|long
name|txid
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
name|checksum
operator|!=
literal|null
condition|)
block|{
name|int
name|calculatedChecksum
init|=
operator|(
name|int
operator|)
name|checksum
operator|.
name|getValue
argument_list|()
decl_stmt|;
name|int
name|readChecksum
init|=
name|in
operator|.
name|readInt
argument_list|()
decl_stmt|;
comment|// read in checksum
if|if
condition|(
name|readChecksum
operator|!=
name|calculatedChecksum
condition|)
block|{
throw|throw
operator|new
name|ChecksumException
argument_list|(
literal|"Transaction is corrupt. Calculated checksum is "
operator|+
name|calculatedChecksum
operator|+
literal|" but read checksum "
operator|+
name|readChecksum
argument_list|,
name|txid
argument_list|)
throw|;
block|}
block|}
block|}
block|}
DECL|method|outputToXml (ContentHandler contentHandler)
specifier|public
name|void
name|outputToXml
parameter_list|(
name|ContentHandler
name|contentHandler
parameter_list|)
throws|throws
name|SAXException
block|{
name|contentHandler
operator|.
name|startElement
argument_list|(
literal|""
argument_list|,
literal|""
argument_list|,
literal|"RECORD"
argument_list|,
operator|new
name|AttributesImpl
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"OPCODE"
argument_list|,
name|opCode
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|contentHandler
operator|.
name|startElement
argument_list|(
literal|""
argument_list|,
literal|""
argument_list|,
literal|"DATA"
argument_list|,
operator|new
name|AttributesImpl
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"TXID"
argument_list|,
literal|""
operator|+
name|txid
argument_list|)
expr_stmt|;
name|toXml
argument_list|(
name|contentHandler
argument_list|)
expr_stmt|;
name|contentHandler
operator|.
name|endElement
argument_list|(
literal|""
argument_list|,
literal|""
argument_list|,
literal|"DATA"
argument_list|)
expr_stmt|;
name|contentHandler
operator|.
name|endElement
argument_list|(
literal|""
argument_list|,
literal|""
argument_list|,
literal|"RECORD"
argument_list|)
expr_stmt|;
block|}
DECL|method|toXml (ContentHandler contentHandler)
specifier|protected
specifier|abstract
name|void
name|toXml
parameter_list|(
name|ContentHandler
name|contentHandler
parameter_list|)
throws|throws
name|SAXException
function_decl|;
DECL|method|fromXml (Stanza st)
specifier|abstract
name|void
name|fromXml
parameter_list|(
name|Stanza
name|st
parameter_list|)
throws|throws
name|InvalidXmlException
function_decl|;
DECL|method|decodeXml (Stanza st)
specifier|public
name|void
name|decodeXml
parameter_list|(
name|Stanza
name|st
parameter_list|)
throws|throws
name|InvalidXmlException
block|{
name|this
operator|.
name|txid
operator|=
name|Long
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"TXID"
argument_list|)
argument_list|)
expr_stmt|;
name|fromXml
argument_list|(
name|st
argument_list|)
expr_stmt|;
block|}
DECL|method|blockToXml (ContentHandler contentHandler, Block block)
specifier|public
specifier|static
name|void
name|blockToXml
parameter_list|(
name|ContentHandler
name|contentHandler
parameter_list|,
name|Block
name|block
parameter_list|)
throws|throws
name|SAXException
block|{
name|contentHandler
operator|.
name|startElement
argument_list|(
literal|""
argument_list|,
literal|""
argument_list|,
literal|"BLOCK"
argument_list|,
operator|new
name|AttributesImpl
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"BLOCK_ID"
argument_list|,
name|Long
operator|.
name|valueOf
argument_list|(
name|block
operator|.
name|getBlockId
argument_list|()
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"NUM_BYTES"
argument_list|,
name|Long
operator|.
name|valueOf
argument_list|(
name|block
operator|.
name|getNumBytes
argument_list|()
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"GENSTAMP"
argument_list|,
name|Long
operator|.
name|valueOf
argument_list|(
name|block
operator|.
name|getGenerationStamp
argument_list|()
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|contentHandler
operator|.
name|endElement
argument_list|(
literal|""
argument_list|,
literal|""
argument_list|,
literal|"BLOCK"
argument_list|)
expr_stmt|;
block|}
DECL|method|blockFromXml (Stanza st)
specifier|public
specifier|static
name|Block
name|blockFromXml
parameter_list|(
name|Stanza
name|st
parameter_list|)
throws|throws
name|InvalidXmlException
block|{
name|long
name|blockId
init|=
name|Long
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"BLOCK_ID"
argument_list|)
argument_list|)
decl_stmt|;
name|long
name|numBytes
init|=
name|Long
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"NUM_BYTES"
argument_list|)
argument_list|)
decl_stmt|;
name|long
name|generationStamp
init|=
name|Long
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"GENSTAMP"
argument_list|)
argument_list|)
decl_stmt|;
return|return
operator|new
name|Block
argument_list|(
name|blockId
argument_list|,
name|numBytes
argument_list|,
name|generationStamp
argument_list|)
return|;
block|}
DECL|method|delegationTokenToXml (ContentHandler contentHandler, DelegationTokenIdentifier token)
specifier|public
specifier|static
name|void
name|delegationTokenToXml
parameter_list|(
name|ContentHandler
name|contentHandler
parameter_list|,
name|DelegationTokenIdentifier
name|token
parameter_list|)
throws|throws
name|SAXException
block|{
name|contentHandler
operator|.
name|startElement
argument_list|(
literal|""
argument_list|,
literal|""
argument_list|,
literal|"DELEGATION_TOKEN_IDENTIFIER"
argument_list|,
operator|new
name|AttributesImpl
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"KIND"
argument_list|,
name|token
operator|.
name|getKind
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"SEQUENCE_NUMBER"
argument_list|,
name|Integer
operator|.
name|valueOf
argument_list|(
name|token
operator|.
name|getSequenceNumber
argument_list|()
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"OWNER"
argument_list|,
name|token
operator|.
name|getOwner
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"RENEWER"
argument_list|,
name|token
operator|.
name|getRenewer
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"REALUSER"
argument_list|,
name|token
operator|.
name|getRealUser
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"ISSUE_DATE"
argument_list|,
name|Long
operator|.
name|valueOf
argument_list|(
name|token
operator|.
name|getIssueDate
argument_list|()
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"MAX_DATE"
argument_list|,
name|Long
operator|.
name|valueOf
argument_list|(
name|token
operator|.
name|getMaxDate
argument_list|()
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"MASTER_KEY_ID"
argument_list|,
name|Integer
operator|.
name|valueOf
argument_list|(
name|token
operator|.
name|getMasterKeyId
argument_list|()
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|contentHandler
operator|.
name|endElement
argument_list|(
literal|""
argument_list|,
literal|""
argument_list|,
literal|"DELEGATION_TOKEN_IDENTIFIER"
argument_list|)
expr_stmt|;
block|}
DECL|method|delegationTokenFromXml (Stanza st)
specifier|public
specifier|static
name|DelegationTokenIdentifier
name|delegationTokenFromXml
parameter_list|(
name|Stanza
name|st
parameter_list|)
throws|throws
name|InvalidXmlException
block|{
name|String
name|kind
init|=
name|st
operator|.
name|getValue
argument_list|(
literal|"KIND"
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|kind
operator|.
name|equals
argument_list|(
name|DelegationTokenIdentifier
operator|.
name|HDFS_DELEGATION_KIND
operator|.
name|toString
argument_list|()
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|InvalidXmlException
argument_list|(
literal|"can't understand "
operator|+
literal|"DelegationTokenIdentifier KIND "
operator|+
name|kind
argument_list|)
throw|;
block|}
name|int
name|seqNum
init|=
name|Integer
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"SEQUENCE_NUMBER"
argument_list|)
argument_list|)
decl_stmt|;
name|String
name|owner
init|=
name|st
operator|.
name|getValue
argument_list|(
literal|"OWNER"
argument_list|)
decl_stmt|;
name|String
name|renewer
init|=
name|st
operator|.
name|getValue
argument_list|(
literal|"RENEWER"
argument_list|)
decl_stmt|;
name|String
name|realuser
init|=
name|st
operator|.
name|getValue
argument_list|(
literal|"REALUSER"
argument_list|)
decl_stmt|;
name|long
name|issueDate
init|=
name|Long
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"ISSUE_DATE"
argument_list|)
argument_list|)
decl_stmt|;
name|long
name|maxDate
init|=
name|Long
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"MAX_DATE"
argument_list|)
argument_list|)
decl_stmt|;
name|int
name|masterKeyId
init|=
name|Integer
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"MASTER_KEY_ID"
argument_list|)
argument_list|)
decl_stmt|;
name|DelegationTokenIdentifier
name|token
init|=
operator|new
name|DelegationTokenIdentifier
argument_list|(
operator|new
name|Text
argument_list|(
name|owner
argument_list|)
argument_list|,
operator|new
name|Text
argument_list|(
name|renewer
argument_list|)
argument_list|,
operator|new
name|Text
argument_list|(
name|realuser
argument_list|)
argument_list|)
decl_stmt|;
name|token
operator|.
name|setSequenceNumber
argument_list|(
name|seqNum
argument_list|)
expr_stmt|;
name|token
operator|.
name|setIssueDate
argument_list|(
name|issueDate
argument_list|)
expr_stmt|;
name|token
operator|.
name|setMaxDate
argument_list|(
name|maxDate
argument_list|)
expr_stmt|;
name|token
operator|.
name|setMasterKeyId
argument_list|(
name|masterKeyId
argument_list|)
expr_stmt|;
return|return
name|token
return|;
block|}
DECL|method|delegationKeyToXml (ContentHandler contentHandler, DelegationKey key)
specifier|public
specifier|static
name|void
name|delegationKeyToXml
parameter_list|(
name|ContentHandler
name|contentHandler
parameter_list|,
name|DelegationKey
name|key
parameter_list|)
throws|throws
name|SAXException
block|{
name|contentHandler
operator|.
name|startElement
argument_list|(
literal|""
argument_list|,
literal|""
argument_list|,
literal|"DELEGATION_KEY"
argument_list|,
operator|new
name|AttributesImpl
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"KEY_ID"
argument_list|,
name|Integer
operator|.
name|valueOf
argument_list|(
name|key
operator|.
name|getKeyId
argument_list|()
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"EXPIRY_DATE"
argument_list|,
name|Long
operator|.
name|valueOf
argument_list|(
name|key
operator|.
name|getExpiryDate
argument_list|()
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|.
name|getEncodedKey
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"KEY"
argument_list|,
name|Hex
operator|.
name|encodeHexString
argument_list|(
name|key
operator|.
name|getEncodedKey
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|contentHandler
operator|.
name|endElement
argument_list|(
literal|""
argument_list|,
literal|""
argument_list|,
literal|"DELEGATION_KEY"
argument_list|)
expr_stmt|;
block|}
DECL|method|delegationKeyFromXml (Stanza st)
specifier|public
specifier|static
name|DelegationKey
name|delegationKeyFromXml
parameter_list|(
name|Stanza
name|st
parameter_list|)
throws|throws
name|InvalidXmlException
block|{
name|int
name|keyId
init|=
name|Integer
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"KEY_ID"
argument_list|)
argument_list|)
decl_stmt|;
name|long
name|expiryDate
init|=
name|Long
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"EXPIRY_DATE"
argument_list|)
argument_list|)
decl_stmt|;
name|byte
name|key
index|[]
init|=
literal|null
decl_stmt|;
try|try
block|{
name|key
operator|=
name|Hex
operator|.
name|decodeHex
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"KEY"
argument_list|)
operator|.
name|toCharArray
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|DecoderException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|InvalidXmlException
argument_list|(
name|e
operator|.
name|toString
argument_list|()
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
name|InvalidXmlException
name|e
parameter_list|)
block|{     }
return|return
operator|new
name|DelegationKey
argument_list|(
name|keyId
argument_list|,
name|expiryDate
argument_list|,
name|key
argument_list|)
return|;
block|}
DECL|method|permissionStatusToXml (ContentHandler contentHandler, PermissionStatus perm)
specifier|public
specifier|static
name|void
name|permissionStatusToXml
parameter_list|(
name|ContentHandler
name|contentHandler
parameter_list|,
name|PermissionStatus
name|perm
parameter_list|)
throws|throws
name|SAXException
block|{
name|contentHandler
operator|.
name|startElement
argument_list|(
literal|""
argument_list|,
literal|""
argument_list|,
literal|"PERMISSION_STATUS"
argument_list|,
operator|new
name|AttributesImpl
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"USERNAME"
argument_list|,
name|perm
operator|.
name|getUserName
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"GROUPNAME"
argument_list|,
name|perm
operator|.
name|getGroupName
argument_list|()
argument_list|)
expr_stmt|;
name|XMLUtils
operator|.
name|addSaxString
argument_list|(
name|contentHandler
argument_list|,
literal|"MODE"
argument_list|,
name|Short
operator|.
name|valueOf
argument_list|(
name|perm
operator|.
name|getPermission
argument_list|()
operator|.
name|toShort
argument_list|()
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|contentHandler
operator|.
name|endElement
argument_list|(
literal|""
argument_list|,
literal|""
argument_list|,
literal|"PERMISSION_STATUS"
argument_list|)
expr_stmt|;
block|}
DECL|method|permissionStatusFromXml (Stanza st)
specifier|public
specifier|static
name|PermissionStatus
name|permissionStatusFromXml
parameter_list|(
name|Stanza
name|st
parameter_list|)
throws|throws
name|InvalidXmlException
block|{
name|String
name|username
init|=
name|st
operator|.
name|getValue
argument_list|(
literal|"USERNAME"
argument_list|)
decl_stmt|;
name|String
name|groupname
init|=
name|st
operator|.
name|getValue
argument_list|(
literal|"GROUPNAME"
argument_list|)
decl_stmt|;
name|short
name|mode
init|=
name|Short
operator|.
name|valueOf
argument_list|(
name|st
operator|.
name|getValue
argument_list|(
literal|"MODE"
argument_list|)
argument_list|)
decl_stmt|;
return|return
operator|new
name|PermissionStatus
argument_list|(
name|username
argument_list|,
name|groupname
argument_list|,
operator|new
name|FsPermission
argument_list|(
name|mode
argument_list|)
argument_list|)
return|;
block|}
comment|/**    * Exception indicating that we found an OP_INVALID followed by some     * garbage.  An OP_INVALID should signify the end of the file... if there     * is additional content after that, then the edit log is corrupt.     */
DECL|class|GarbageAfterTerminatorException
specifier|static
class|class
name|GarbageAfterTerminatorException
extends|extends
name|IOException
block|{
DECL|field|serialVersionUID
specifier|private
specifier|static
specifier|final
name|long
name|serialVersionUID
init|=
literal|1L
decl_stmt|;
DECL|field|numAfterTerminator
specifier|private
specifier|final
name|long
name|numAfterTerminator
decl_stmt|;
DECL|method|GarbageAfterTerminatorException (String str, long numAfterTerminator)
specifier|public
name|GarbageAfterTerminatorException
parameter_list|(
name|String
name|str
parameter_list|,
name|long
name|numAfterTerminator
parameter_list|)
block|{
name|super
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|this
operator|.
name|numAfterTerminator
operator|=
name|numAfterTerminator
expr_stmt|;
block|}
comment|/**      * Get the number of bytes after the terminator at which the garbage      * appeared.      *      * So if you had an OP_INVALID followed immediately by another valid opcode,      * this would be 0.      * If you had an OP_INVALID followed by some padding bytes, followed by a      * stray byte at the end, this would be the number of padding bytes.      *       * @return numAfterTerminator      */
DECL|method|getNumAfterTerminator ()
specifier|public
name|long
name|getNumAfterTerminator
parameter_list|()
block|{
return|return
name|numAfterTerminator
return|;
block|}
block|}
block|}
end_class

end_unit

