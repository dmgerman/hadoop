begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/**  * Licensed to the Apache Software Foundation (ASF) under one  * or more contributor license agreements.  See the NOTICE file  * distributed with this work for additional information  * regarding copyright ownership.  The ASF licenses this file  * to you under the Apache License, Version 2.0 (the  * "License"); you may not use this file except in compliance  * with the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
DECL|package|org.apache.hadoop.hdfs.server.federation.router
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|server
operator|.
name|federation
operator|.
name|router
package|;
end_package

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|DFSConfigKeys
operator|.
name|DFS_ROUTER_HANDLER_COUNT_DEFAULT
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|DFSConfigKeys
operator|.
name|DFS_ROUTER_HANDLER_COUNT_KEY
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|DFSConfigKeys
operator|.
name|DFS_ROUTER_HANDLER_QUEUE_SIZE_DEFAULT
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|DFSConfigKeys
operator|.
name|DFS_ROUTER_HANDLER_QUEUE_SIZE_KEY
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|DFSConfigKeys
operator|.
name|DFS_ROUTER_READER_COUNT_DEFAULT
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|DFSConfigKeys
operator|.
name|DFS_ROUTER_READER_COUNT_KEY
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|DFSConfigKeys
operator|.
name|DFS_ROUTER_READER_QUEUE_SIZE_DEFAULT
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|DFSConfigKeys
operator|.
name|DFS_ROUTER_READER_QUEUE_SIZE_KEY
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|FileNotFoundException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|InetSocketAddress
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collection
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|EnumSet
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Iterator
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|LinkedHashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|LinkedList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
operator|.
name|Entry
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Set
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|TreeMap
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|conf
operator|.
name|Configuration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|crypto
operator|.
name|CryptoProtocolVersion
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|BatchedRemoteIterator
operator|.
name|BatchedEntries
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|CacheFlag
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|CommonConfigurationKeys
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|ContentSummary
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|CreateFlag
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|FileAlreadyExistsException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|FsServerDefaults
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|Options
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|Path
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|QuotaUsage
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|StorageType
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|XAttr
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|XAttrSetFlag
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|permission
operator|.
name|AclEntry
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|permission
operator|.
name|AclStatus
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|permission
operator|.
name|FsAction
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|permission
operator|.
name|FsPermission
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|AddBlockFlag
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|DFSConfigKeys
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|DFSUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|inotify
operator|.
name|EventBatchList
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|AddErasureCodingPolicyResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|BlockStoragePolicy
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|CacheDirectiveEntry
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|CacheDirectiveInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|CachePoolEntry
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|CachePoolInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|ClientProtocol
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|CorruptFileBlocks
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|DatanodeID
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|DatanodeInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|DirectoryListing
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|ECBlockGroupStats
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|EncryptionZone
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|ErasureCodingPolicy
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|ErasureCodingPolicyInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|ExtendedBlock
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|HdfsConstants
operator|.
name|DatanodeReportType
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|HdfsConstants
operator|.
name|ReencryptAction
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|HdfsConstants
operator|.
name|RollingUpgradeAction
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|HdfsConstants
operator|.
name|SafeModeAction
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|HdfsFileStatus
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|LastBlockWithStatus
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|LocatedBlock
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|LocatedBlocks
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|OpenFileEntry
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|ReplicatedBlockStats
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|RollingUpgradeInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|SnapshotDiffReport
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|SnapshotDiffReportListing
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|SnapshottableDirectoryStatus
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|ZoneReencryptionStatus
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|proto
operator|.
name|ClientNamenodeProtocolProtos
operator|.
name|ClientNamenodeProtocol
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocolPB
operator|.
name|ClientNamenodeProtocolPB
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocolPB
operator|.
name|ClientNamenodeProtocolServerSideTranslatorPB
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|security
operator|.
name|token
operator|.
name|block
operator|.
name|DataEncryptionKey
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|security
operator|.
name|token
operator|.
name|delegation
operator|.
name|DelegationTokenIdentifier
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|server
operator|.
name|federation
operator|.
name|resolver
operator|.
name|ActiveNamenodeResolver
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|server
operator|.
name|federation
operator|.
name|resolver
operator|.
name|FederationNamespaceInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|server
operator|.
name|federation
operator|.
name|resolver
operator|.
name|FileSubclusterResolver
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|server
operator|.
name|federation
operator|.
name|resolver
operator|.
name|PathLocation
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|server
operator|.
name|federation
operator|.
name|resolver
operator|.
name|RemoteLocation
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|server
operator|.
name|namenode
operator|.
name|LeaseExpiredException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|server
operator|.
name|namenode
operator|.
name|NameNode
operator|.
name|OperationCategory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|server
operator|.
name|namenode
operator|.
name|NotReplicatedYetException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|server
operator|.
name|namenode
operator|.
name|SafeModeException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|server
operator|.
name|protocol
operator|.
name|DatanodeStorageReport
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|EnumSetWritable
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|Text
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|ipc
operator|.
name|ProtobufRpcEngine
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|ipc
operator|.
name|RPC
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|ipc
operator|.
name|RPC
operator|.
name|Server
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|ipc
operator|.
name|RemoteException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|ipc
operator|.
name|StandbyException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|net
operator|.
name|NodeBase
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|AccessControlException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|UserGroupInformation
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|token
operator|.
name|Token
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|service
operator|.
name|AbstractService
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|util
operator|.
name|ReflectionUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|Logger
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|LoggerFactory
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|annotations
operator|.
name|VisibleForTesting
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|protobuf
operator|.
name|BlockingService
import|;
end_import

begin_comment
comment|/**  * This class is responsible for handling all of the RPC calls to the It is  * created, started, and stopped by {@link Router}. It implements the  * {@link ClientProtocol} to mimic a  * {@link org.apache.hadoop.hdfs.server.namenode.NameNode NameNode} and proxies  * the requests to the active  * {@link org.apache.hadoop.hdfs.server.namenode.NameNode NameNode}.  */
end_comment

begin_class
DECL|class|RouterRpcServer
specifier|public
class|class
name|RouterRpcServer
extends|extends
name|AbstractService
implements|implements
name|ClientProtocol
block|{
DECL|field|LOG
specifier|private
specifier|static
specifier|final
name|Logger
name|LOG
init|=
name|LoggerFactory
operator|.
name|getLogger
argument_list|(
name|RouterRpcServer
operator|.
name|class
argument_list|)
decl_stmt|;
comment|/** Configuration for the RPC server. */
DECL|field|conf
specifier|private
name|Configuration
name|conf
decl_stmt|;
comment|/** Identifier for the super user. */
DECL|field|superUser
specifier|private
specifier|final
name|String
name|superUser
decl_stmt|;
comment|/** Identifier for the super group. */
DECL|field|superGroup
specifier|private
specifier|final
name|String
name|superGroup
decl_stmt|;
comment|/** Router using this RPC server. */
DECL|field|router
specifier|private
specifier|final
name|Router
name|router
decl_stmt|;
comment|/** The RPC server that listens to requests from clients. */
DECL|field|rpcServer
specifier|private
specifier|final
name|Server
name|rpcServer
decl_stmt|;
comment|/** The address for this RPC server. */
DECL|field|rpcAddress
specifier|private
specifier|final
name|InetSocketAddress
name|rpcAddress
decl_stmt|;
comment|/** RPC clients to connect to the Namenodes. */
DECL|field|rpcClient
specifier|private
specifier|final
name|RouterRpcClient
name|rpcClient
decl_stmt|;
comment|/** Monitor metrics for the RPC calls. */
DECL|field|rpcMonitor
specifier|private
specifier|final
name|RouterRpcMonitor
name|rpcMonitor
decl_stmt|;
comment|/** Interface to identify the active NN for a nameservice or blockpool ID. */
DECL|field|namenodeResolver
specifier|private
specifier|final
name|ActiveNamenodeResolver
name|namenodeResolver
decl_stmt|;
comment|/** Interface to map global name space to HDFS subcluster name spaces. */
DECL|field|subclusterResolver
specifier|private
specifier|final
name|FileSubclusterResolver
name|subclusterResolver
decl_stmt|;
comment|/** Category of the operation that a thread is executing. */
DECL|field|opCategory
specifier|private
specifier|final
name|ThreadLocal
argument_list|<
name|OperationCategory
argument_list|>
name|opCategory
init|=
operator|new
name|ThreadLocal
argument_list|<>
argument_list|()
decl_stmt|;
comment|/**    * Construct a router RPC server.    *    * @param configuration HDFS Configuration.    * @param nnResolver The NN resolver instance to determine active NNs in HA.    * @param fileResolver File resolver to resolve file paths to subclusters.    * @throws IOException If the RPC server could not be created.    */
DECL|method|RouterRpcServer (Configuration configuration, Router router, ActiveNamenodeResolver nnResolver, FileSubclusterResolver fileResolver)
specifier|public
name|RouterRpcServer
parameter_list|(
name|Configuration
name|configuration
parameter_list|,
name|Router
name|router
parameter_list|,
name|ActiveNamenodeResolver
name|nnResolver
parameter_list|,
name|FileSubclusterResolver
name|fileResolver
parameter_list|)
throws|throws
name|IOException
block|{
name|super
argument_list|(
name|RouterRpcServer
operator|.
name|class
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|this
operator|.
name|conf
operator|=
name|configuration
expr_stmt|;
name|this
operator|.
name|router
operator|=
name|router
expr_stmt|;
name|this
operator|.
name|namenodeResolver
operator|=
name|nnResolver
expr_stmt|;
name|this
operator|.
name|subclusterResolver
operator|=
name|fileResolver
expr_stmt|;
comment|// User and group for reporting
name|this
operator|.
name|superUser
operator|=
name|System
operator|.
name|getProperty
argument_list|(
literal|"user.name"
argument_list|)
expr_stmt|;
name|this
operator|.
name|superGroup
operator|=
name|this
operator|.
name|conf
operator|.
name|get
argument_list|(
name|DFSConfigKeys
operator|.
name|DFS_PERMISSIONS_SUPERUSERGROUP_KEY
argument_list|,
name|DFSConfigKeys
operator|.
name|DFS_PERMISSIONS_SUPERUSERGROUP_DEFAULT
argument_list|)
expr_stmt|;
comment|// RPC server settings
name|int
name|handlerCount
init|=
name|this
operator|.
name|conf
operator|.
name|getInt
argument_list|(
name|DFS_ROUTER_HANDLER_COUNT_KEY
argument_list|,
name|DFS_ROUTER_HANDLER_COUNT_DEFAULT
argument_list|)
decl_stmt|;
name|int
name|readerCount
init|=
name|this
operator|.
name|conf
operator|.
name|getInt
argument_list|(
name|DFS_ROUTER_READER_COUNT_KEY
argument_list|,
name|DFS_ROUTER_READER_COUNT_DEFAULT
argument_list|)
decl_stmt|;
name|int
name|handlerQueueSize
init|=
name|this
operator|.
name|conf
operator|.
name|getInt
argument_list|(
name|DFS_ROUTER_HANDLER_QUEUE_SIZE_KEY
argument_list|,
name|DFS_ROUTER_HANDLER_QUEUE_SIZE_DEFAULT
argument_list|)
decl_stmt|;
comment|// Override Hadoop Common IPC setting
name|int
name|readerQueueSize
init|=
name|this
operator|.
name|conf
operator|.
name|getInt
argument_list|(
name|DFS_ROUTER_READER_QUEUE_SIZE_KEY
argument_list|,
name|DFS_ROUTER_READER_QUEUE_SIZE_DEFAULT
argument_list|)
decl_stmt|;
name|this
operator|.
name|conf
operator|.
name|setInt
argument_list|(
name|CommonConfigurationKeys
operator|.
name|IPC_SERVER_RPC_READ_CONNECTION_QUEUE_SIZE_KEY
argument_list|,
name|readerQueueSize
argument_list|)
expr_stmt|;
name|RPC
operator|.
name|setProtocolEngine
argument_list|(
name|this
operator|.
name|conf
argument_list|,
name|ClientNamenodeProtocolPB
operator|.
name|class
argument_list|,
name|ProtobufRpcEngine
operator|.
name|class
argument_list|)
expr_stmt|;
name|ClientNamenodeProtocolServerSideTranslatorPB
name|clientProtocolServerTranslator
init|=
operator|new
name|ClientNamenodeProtocolServerSideTranslatorPB
argument_list|(
name|this
argument_list|)
decl_stmt|;
name|BlockingService
name|clientNNPbService
init|=
name|ClientNamenodeProtocol
operator|.
name|newReflectiveBlockingService
argument_list|(
name|clientProtocolServerTranslator
argument_list|)
decl_stmt|;
name|InetSocketAddress
name|confRpcAddress
init|=
name|conf
operator|.
name|getSocketAddr
argument_list|(
name|DFSConfigKeys
operator|.
name|DFS_ROUTER_RPC_BIND_HOST_KEY
argument_list|,
name|DFSConfigKeys
operator|.
name|DFS_ROUTER_RPC_ADDRESS_KEY
argument_list|,
name|DFSConfigKeys
operator|.
name|DFS_ROUTER_RPC_ADDRESS_DEFAULT
argument_list|,
name|DFSConfigKeys
operator|.
name|DFS_ROUTER_RPC_PORT_DEFAULT
argument_list|)
decl_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"RPC server binding to {} with {} handlers for Router {}"
argument_list|,
name|confRpcAddress
argument_list|,
name|handlerCount
argument_list|,
name|this
operator|.
name|router
operator|.
name|getRouterId
argument_list|()
argument_list|)
expr_stmt|;
name|this
operator|.
name|rpcServer
operator|=
operator|new
name|RPC
operator|.
name|Builder
argument_list|(
name|this
operator|.
name|conf
argument_list|)
operator|.
name|setProtocol
argument_list|(
name|ClientNamenodeProtocolPB
operator|.
name|class
argument_list|)
operator|.
name|setInstance
argument_list|(
name|clientNNPbService
argument_list|)
operator|.
name|setBindAddress
argument_list|(
name|confRpcAddress
operator|.
name|getHostName
argument_list|()
argument_list|)
operator|.
name|setPort
argument_list|(
name|confRpcAddress
operator|.
name|getPort
argument_list|()
argument_list|)
operator|.
name|setNumHandlers
argument_list|(
name|handlerCount
argument_list|)
operator|.
name|setnumReaders
argument_list|(
name|readerCount
argument_list|)
operator|.
name|setQueueSizePerHandler
argument_list|(
name|handlerQueueSize
argument_list|)
operator|.
name|setVerbose
argument_list|(
literal|false
argument_list|)
operator|.
name|build
argument_list|()
expr_stmt|;
comment|// We don't want the server to log the full stack trace for some exceptions
name|this
operator|.
name|rpcServer
operator|.
name|addTerseExceptions
argument_list|(
name|RemoteException
operator|.
name|class
argument_list|,
name|StandbyException
operator|.
name|class
argument_list|,
name|SafeModeException
operator|.
name|class
argument_list|,
name|FileNotFoundException
operator|.
name|class
argument_list|,
name|FileAlreadyExistsException
operator|.
name|class
argument_list|,
name|AccessControlException
operator|.
name|class
argument_list|,
name|LeaseExpiredException
operator|.
name|class
argument_list|,
name|NotReplicatedYetException
operator|.
name|class
argument_list|,
name|IOException
operator|.
name|class
argument_list|)
expr_stmt|;
comment|// The RPC-server port can be ephemeral... ensure we have the correct info
name|InetSocketAddress
name|listenAddress
init|=
name|this
operator|.
name|rpcServer
operator|.
name|getListenerAddress
argument_list|()
decl_stmt|;
name|this
operator|.
name|rpcAddress
operator|=
operator|new
name|InetSocketAddress
argument_list|(
name|confRpcAddress
operator|.
name|getHostName
argument_list|()
argument_list|,
name|listenAddress
operator|.
name|getPort
argument_list|()
argument_list|)
expr_stmt|;
comment|// Create metrics monitor
name|Class
argument_list|<
name|?
extends|extends
name|RouterRpcMonitor
argument_list|>
name|rpcMonitorClass
init|=
name|this
operator|.
name|conf
operator|.
name|getClass
argument_list|(
name|DFSConfigKeys
operator|.
name|DFS_ROUTER_METRICS_CLASS
argument_list|,
name|DFSConfigKeys
operator|.
name|DFS_ROUTER_METRICS_CLASS_DEFAULT
argument_list|,
name|RouterRpcMonitor
operator|.
name|class
argument_list|)
decl_stmt|;
name|this
operator|.
name|rpcMonitor
operator|=
name|ReflectionUtils
operator|.
name|newInstance
argument_list|(
name|rpcMonitorClass
argument_list|,
name|conf
argument_list|)
expr_stmt|;
comment|// Create the client
name|this
operator|.
name|rpcClient
operator|=
operator|new
name|RouterRpcClient
argument_list|(
name|this
operator|.
name|conf
argument_list|,
name|this
operator|.
name|router
operator|.
name|getRouterId
argument_list|()
argument_list|,
name|this
operator|.
name|namenodeResolver
argument_list|,
name|this
operator|.
name|rpcMonitor
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|serviceInit (Configuration configuration)
specifier|protected
name|void
name|serviceInit
parameter_list|(
name|Configuration
name|configuration
parameter_list|)
throws|throws
name|Exception
block|{
name|this
operator|.
name|conf
operator|=
name|configuration
expr_stmt|;
if|if
condition|(
name|this
operator|.
name|rpcMonitor
operator|==
literal|null
condition|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Cannot instantiate Router RPC metrics class"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|rpcMonitor
operator|.
name|init
argument_list|(
name|this
operator|.
name|conf
argument_list|,
name|this
argument_list|,
name|this
operator|.
name|router
operator|.
name|getStateStore
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|super
operator|.
name|serviceInit
argument_list|(
name|configuration
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|serviceStart ()
specifier|protected
name|void
name|serviceStart
parameter_list|()
throws|throws
name|Exception
block|{
if|if
condition|(
name|this
operator|.
name|rpcServer
operator|!=
literal|null
condition|)
block|{
name|this
operator|.
name|rpcServer
operator|.
name|start
argument_list|()
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Router RPC up at: {}"
argument_list|,
name|this
operator|.
name|getRpcAddress
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|super
operator|.
name|serviceStart
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|serviceStop ()
specifier|protected
name|void
name|serviceStop
parameter_list|()
throws|throws
name|Exception
block|{
if|if
condition|(
name|this
operator|.
name|rpcServer
operator|!=
literal|null
condition|)
block|{
name|this
operator|.
name|rpcServer
operator|.
name|stop
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|rpcMonitor
operator|!=
literal|null
condition|)
block|{
name|this
operator|.
name|rpcMonitor
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
name|super
operator|.
name|serviceStop
argument_list|()
expr_stmt|;
block|}
comment|/**    * Get the RPC client to the Namenode.    *    * @return RPC clients to the Namenodes.    */
DECL|method|getRPCClient ()
specifier|public
name|RouterRpcClient
name|getRPCClient
parameter_list|()
block|{
return|return
name|rpcClient
return|;
block|}
comment|/**    * Get the RPC monitor and metrics.    *    * @return RPC monitor and metrics.    */
DECL|method|getRPCMonitor ()
specifier|public
name|RouterRpcMonitor
name|getRPCMonitor
parameter_list|()
block|{
return|return
name|rpcMonitor
return|;
block|}
comment|/**    * Allow access to the client RPC server for testing.    *    * @return The RPC server.    */
annotation|@
name|VisibleForTesting
DECL|method|getServer ()
specifier|public
name|Server
name|getServer
parameter_list|()
block|{
return|return
name|rpcServer
return|;
block|}
comment|/**    * Get the RPC address of the service.    *    * @return RPC service address.    */
DECL|method|getRpcAddress ()
specifier|public
name|InetSocketAddress
name|getRpcAddress
parameter_list|()
block|{
return|return
name|rpcAddress
return|;
block|}
comment|/**    * Check if the Router is in safe mode. We should only see READ, WRITE, and    * UNCHECKED. It includes a default handler when we haven't implemented an    * operation. If not supported, it always throws an exception reporting the    * operation.    *    * @param op Category of the operation to check.    * @param supported If the operation is supported or not. If not, it will    *                  throw an UnsupportedOperationException.    * @throws StandbyException If the Router is in safe mode and cannot serve    *                          client requests.    * @throws UnsupportedOperationException If the operation is not supported.    */
DECL|method|checkOperation (OperationCategory op, boolean supported)
specifier|private
name|void
name|checkOperation
parameter_list|(
name|OperationCategory
name|op
parameter_list|,
name|boolean
name|supported
parameter_list|)
throws|throws
name|StandbyException
throws|,
name|UnsupportedOperationException
block|{
name|checkOperation
argument_list|(
name|op
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|supported
condition|)
block|{
if|if
condition|(
name|rpcMonitor
operator|!=
literal|null
condition|)
block|{
name|rpcMonitor
operator|.
name|proxyOpNotImplemented
argument_list|()
expr_stmt|;
block|}
name|String
name|methodName
init|=
name|getMethodName
argument_list|()
decl_stmt|;
throw|throw
operator|new
name|UnsupportedOperationException
argument_list|(
literal|"Operation \""
operator|+
name|methodName
operator|+
literal|"\" is not supported"
argument_list|)
throw|;
block|}
block|}
comment|/**    * Check if the Router is in safe mode. We should only see READ, WRITE, and    * UNCHECKED. This function should be called by all ClientProtocol functions.    *    * @param op Category of the operation to check.    * @throws StandbyException If the Router is in safe mode and cannot serve    *                          client requests.    */
DECL|method|checkOperation (OperationCategory op)
specifier|private
name|void
name|checkOperation
parameter_list|(
name|OperationCategory
name|op
parameter_list|)
throws|throws
name|StandbyException
block|{
comment|// Log the function we are currently calling.
if|if
condition|(
name|rpcMonitor
operator|!=
literal|null
condition|)
block|{
name|rpcMonitor
operator|.
name|startOp
argument_list|()
expr_stmt|;
block|}
comment|// Log the function we are currently calling.
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|String
name|methodName
init|=
name|getMethodName
argument_list|()
decl_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"Proxying operation: {}"
argument_list|,
name|methodName
argument_list|)
expr_stmt|;
block|}
comment|// Store the category of the operation category for this thread
name|opCategory
operator|.
name|set
argument_list|(
name|op
argument_list|)
expr_stmt|;
comment|// We allow unchecked and read operations
if|if
condition|(
name|op
operator|==
name|OperationCategory
operator|.
name|UNCHECKED
operator|||
name|op
operator|==
name|OperationCategory
operator|.
name|READ
condition|)
block|{
return|return;
block|}
comment|// TODO check Router safe mode and return Standby exception
block|}
annotation|@
name|Override
comment|// ClientProtocol
DECL|method|getDelegationToken (Text renewer)
specifier|public
name|Token
argument_list|<
name|DelegationTokenIdentifier
argument_list|>
name|getDelegationToken
parameter_list|(
name|Text
name|renewer
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|,
literal|false
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
comment|/**    * The the delegation token from each name service.    * @param renewer    * @return Name service -> Token.    * @throws IOException    */
specifier|public
name|Map
argument_list|<
name|FederationNamespaceInfo
argument_list|,
name|Token
argument_list|<
name|DelegationTokenIdentifier
argument_list|>
argument_list|>
DECL|method|getDelegationTokens (Text renewer)
name|getDelegationTokens
parameter_list|(
name|Text
name|renewer
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|,
literal|false
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
annotation|@
name|Override
comment|// ClientProtocol
DECL|method|renewDelegationToken (Token<DelegationTokenIdentifier> token)
specifier|public
name|long
name|renewDelegationToken
parameter_list|(
name|Token
argument_list|<
name|DelegationTokenIdentifier
argument_list|>
name|token
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|,
literal|false
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
annotation|@
name|Override
comment|// ClientProtocol
DECL|method|cancelDelegationToken (Token<DelegationTokenIdentifier> token)
specifier|public
name|void
name|cancelDelegationToken
parameter_list|(
name|Token
argument_list|<
name|DelegationTokenIdentifier
argument_list|>
name|token
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
comment|// ClientProtocol
DECL|method|getBlockLocations (String src, final long offset, final long length)
specifier|public
name|LocatedBlocks
name|getBlockLocations
parameter_list|(
name|String
name|src
parameter_list|,
specifier|final
name|long
name|offset
parameter_list|,
specifier|final
name|long
name|length
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|false
argument_list|)
decl_stmt|;
name|RemoteMethod
name|remoteMethod
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"getBlockLocations"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|long
operator|.
name|class
operator|,
name|long
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
operator|,
name|offset
operator|,
name|length
block|)
function|;
return|return
operator|(
name|LocatedBlocks
operator|)
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|remoteMethod
argument_list|,
name|LocatedBlocks
operator|.
name|class
argument_list|,
literal|null
argument_list|)
return|;
block|}
end_class

begin_function
annotation|@
name|Override
comment|// ClientProtocol
DECL|method|getServerDefaults ()
specifier|public
name|FsServerDefaults
name|getServerDefaults
parameter_list|()
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|)
expr_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"getServerDefaults"
argument_list|)
decl_stmt|;
name|String
name|ns
init|=
name|subclusterResolver
operator|.
name|getDefaultNamespace
argument_list|()
decl_stmt|;
return|return
operator|(
name|FsServerDefaults
operator|)
name|rpcClient
operator|.
name|invokeSingle
argument_list|(
name|ns
argument_list|,
name|method
argument_list|)
return|;
block|}
end_function

begin_function
annotation|@
name|Override
comment|// ClientProtocol
DECL|method|create (String src, FsPermission masked, String clientName, EnumSetWritable<CreateFlag> flag, boolean createParent, short replication, long blockSize, CryptoProtocolVersion[] supportedVersions, String ecPolicyName)
specifier|public
name|HdfsFileStatus
name|create
parameter_list|(
name|String
name|src
parameter_list|,
name|FsPermission
name|masked
parameter_list|,
name|String
name|clientName
parameter_list|,
name|EnumSetWritable
argument_list|<
name|CreateFlag
argument_list|>
name|flag
parameter_list|,
name|boolean
name|createParent
parameter_list|,
name|short
name|replication
parameter_list|,
name|long
name|blockSize
parameter_list|,
name|CryptoProtocolVersion
index|[]
name|supportedVersions
parameter_list|,
name|String
name|ecPolicyName
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
name|RemoteLocation
name|createLocation
init|=
name|getCreateLocation
argument_list|(
name|src
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"create"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|FsPermission
operator|.
name|class
operator|,
name|String
operator|.
name|class
operator|,
name|EnumSetWritable
operator|.
name|class
operator|,
name|boolean
operator|.
name|class
operator|,
name|short
operator|.
name|class
operator|,
name|long
operator|.
name|class
operator|,
name|CryptoProtocolVersion
index|[]
operator|.
expr|class
operator|,
name|String
operator|.
name|class
block|}
operator|,
name|createLocation
operator|.
name|getDest
argument_list|()
operator|,
name|masked
operator|,
name|clientName
operator|,
name|flag
operator|,
name|createParent
operator|,
name|replication
operator|,
name|blockSize
operator|,
name|supportedVersions
operator|,
name|ecPolicyName
block|)
function|;
end_function

begin_return
return|return
operator|(
name|HdfsFileStatus
operator|)
name|rpcClient
operator|.
name|invokeSingle
argument_list|(
name|createLocation
argument_list|,
name|method
argument_list|)
return|;
end_return

begin_comment
unit|}
comment|/**    * Get the location to create a file. It checks if the file already existed    * in one of the locations.    *    * @param src Path of the file to check.    * @return The remote location for this file.    * @throws IOException If the file has no creation location.    */
end_comment

begin_function
DECL|method|getCreateLocation (final String src)
unit|private
name|RemoteLocation
name|getCreateLocation
parameter_list|(
specifier|final
name|String
name|src
parameter_list|)
throws|throws
name|IOException
block|{
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|true
argument_list|)
decl_stmt|;
if|if
condition|(
name|locations
operator|==
literal|null
operator|||
name|locations
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Cannot get locations to create "
operator|+
name|src
argument_list|)
throw|;
block|}
name|RemoteLocation
name|createLocation
init|=
name|locations
operator|.
name|get
argument_list|(
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|locations
operator|.
name|size
argument_list|()
operator|>
literal|1
condition|)
block|{
try|try
block|{
comment|// Check if this file already exists in other subclusters
name|LocatedBlocks
name|existingLocation
init|=
name|getBlockLocations
argument_list|(
name|src
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
decl_stmt|;
if|if
condition|(
name|existingLocation
operator|!=
literal|null
condition|)
block|{
comment|// Forward to the existing location and let the NN handle the error
name|LocatedBlock
name|existingLocationLastLocatedBlock
init|=
name|existingLocation
operator|.
name|getLastLocatedBlock
argument_list|()
decl_stmt|;
if|if
condition|(
name|existingLocationLastLocatedBlock
operator|==
literal|null
condition|)
block|{
comment|// The block has no blocks yet, check for the meta data
for|for
control|(
name|RemoteLocation
name|location
range|:
name|locations
control|)
block|{
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"getFileInfo"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
block|)
empty_stmt|;
if|if
condition|(
name|rpcClient
operator|.
name|invokeSingle
argument_list|(
name|location
argument_list|,
name|method
argument_list|)
operator|!=
literal|null
condition|)
block|{
name|createLocation
operator|=
name|location
expr_stmt|;
break|break;
block|}
block|}
block|}
else|else
block|{
name|ExtendedBlock
name|existingLocationLastBlock
init|=
name|existingLocationLastLocatedBlock
operator|.
name|getBlock
argument_list|()
decl_stmt|;
name|String
name|blockPoolId
init|=
name|existingLocationLastBlock
operator|.
name|getBlockPoolId
argument_list|()
decl_stmt|;
name|createLocation
operator|=
name|getLocationForPath
argument_list|(
name|src
argument_list|,
literal|true
argument_list|,
name|blockPoolId
argument_list|)
expr_stmt|;
block|}
block|}
block|}
catch|catch
parameter_list|(
name|FileNotFoundException
name|fne
parameter_list|)
block|{
comment|// Ignore if the file is not found
block|}
block|}
end_function

begin_return
return|return
name|createLocation
return|;
end_return

begin_comment
unit|}
comment|// Medium
end_comment

begin_function
unit|@
name|Override
comment|// ClientProtocol
DECL|method|append (String src, final String clientName, final EnumSetWritable<CreateFlag> flag)
specifier|public
name|LastBlockWithStatus
name|append
parameter_list|(
name|String
name|src
parameter_list|,
specifier|final
name|String
name|clientName
parameter_list|,
specifier|final
name|EnumSetWritable
argument_list|<
name|CreateFlag
argument_list|>
name|flag
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"append"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|String
operator|.
name|class
operator|,
name|EnumSetWritable
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
operator|,
name|clientName
operator|,
name|flag
block|)
function|;
end_function

begin_return
return|return
operator|(
name|LastBlockWithStatus
operator|)
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|,
name|LastBlockWithStatus
operator|.
name|class
argument_list|,
literal|null
argument_list|)
return|;
end_return

begin_comment
unit|}
comment|// Low
end_comment

begin_function
unit|@
name|Override
comment|// ClientProtocol
DECL|method|recoverLease (String src, String clientName)
specifier|public
name|boolean
name|recoverLease
parameter_list|(
name|String
name|src
parameter_list|,
name|String
name|clientName
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"recoverLease"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|String
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
operator|,
name|clientName
block|)
function|;
end_function

begin_decl_stmt
name|Object
name|result
init|=
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|,
name|Boolean
operator|.
name|class
argument_list|,
name|Boolean
operator|.
name|TRUE
argument_list|)
decl_stmt|;
end_decl_stmt

begin_return
return|return
operator|(
name|boolean
operator|)
name|result
return|;
end_return

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|setReplication (String src, short replication)
specifier|public
name|boolean
name|setReplication
parameter_list|(
name|String
name|src
parameter_list|,
name|short
name|replication
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"setReplication"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|short
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
operator|,
name|replication
block|)
function|;
end_function

begin_decl_stmt
name|Object
name|result
init|=
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|,
name|Boolean
operator|.
name|class
argument_list|,
name|Boolean
operator|.
name|TRUE
argument_list|)
decl_stmt|;
end_decl_stmt

begin_return
return|return
operator|(
name|boolean
operator|)
name|result
return|;
end_return

begin_function
unit|}    @
name|Override
DECL|method|setStoragePolicy (String src, String policyName)
specifier|public
name|void
name|setStoragePolicy
parameter_list|(
name|String
name|src
parameter_list|,
name|String
name|policyName
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"setStoragePolicy"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|String
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
operator|,
name|policyName
block|)
function|;
end_function

begin_expr_stmt
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
unit|}    @
name|Override
DECL|method|getStoragePolicies ()
specifier|public
name|BlockStoragePolicy
index|[]
name|getStoragePolicies
parameter_list|()
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|)
expr_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"getStoragePolicies"
argument_list|)
decl_stmt|;
name|String
name|ns
init|=
name|subclusterResolver
operator|.
name|getDefaultNamespace
argument_list|()
decl_stmt|;
return|return
operator|(
name|BlockStoragePolicy
index|[]
operator|)
name|rpcClient
operator|.
name|invokeSingle
argument_list|(
name|ns
argument_list|,
name|method
argument_list|)
return|;
block|}
end_function

begin_function
annotation|@
name|Override
comment|// ClientProtocol
DECL|method|setPermission (String src, FsPermission permissions)
specifier|public
name|void
name|setPermission
parameter_list|(
name|String
name|src
parameter_list|,
name|FsPermission
name|permissions
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"setPermission"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|FsPermission
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
operator|,
name|permissions
block|)
function|;
end_function

begin_expr_stmt
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|setOwner (String src, String username, String groupname)
specifier|public
name|void
name|setOwner
parameter_list|(
name|String
name|src
parameter_list|,
name|String
name|username
parameter_list|,
name|String
name|groupname
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"setOwner"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|String
operator|.
name|class
operator|,
name|String
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
operator|,
name|username
operator|,
name|groupname
block|)
function|;
end_function

begin_expr_stmt
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
unit|}
comment|/**    * Excluded and favored nodes are not verified and will be ignored by    * placement policy if they are not in the same nameservice as the file.    */
end_comment

begin_function
unit|@
name|Override
comment|// ClientProtocol
DECL|method|addBlock (String src, String clientName, ExtendedBlock previous, DatanodeInfo[] excludedNodes, long fileId, String[] favoredNodes, EnumSet<AddBlockFlag> addBlockFlags)
specifier|public
name|LocatedBlock
name|addBlock
parameter_list|(
name|String
name|src
parameter_list|,
name|String
name|clientName
parameter_list|,
name|ExtendedBlock
name|previous
parameter_list|,
name|DatanodeInfo
index|[]
name|excludedNodes
parameter_list|,
name|long
name|fileId
parameter_list|,
name|String
index|[]
name|favoredNodes
parameter_list|,
name|EnumSet
argument_list|<
name|AddBlockFlag
argument_list|>
name|addBlockFlags
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"addBlock"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|String
operator|.
name|class
operator|,
name|ExtendedBlock
operator|.
name|class
operator|,
name|DatanodeInfo
index|[]
operator|.
expr|class
operator|,
name|long
operator|.
name|class
operator|,
name|String
index|[]
operator|.
expr|class
operator|,
name|EnumSet
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
operator|,
name|clientName
operator|,
name|previous
operator|,
name|excludedNodes
operator|,
name|fileId
operator|,
name|favoredNodes
operator|,
name|addBlockFlags
block|)
function|;
end_function

begin_comment
comment|// TODO verify the excludedNodes and favoredNodes are acceptable to this NN
end_comment

begin_return
return|return
operator|(
name|LocatedBlock
operator|)
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|,
name|LocatedBlock
operator|.
name|class
argument_list|,
literal|null
argument_list|)
return|;
end_return

begin_comment
unit|}
comment|/**    * Excluded nodes are not verified and will be ignored by placement if they    * are not in the same nameservice as the file.    */
end_comment

begin_function
unit|@
name|Override
comment|// ClientProtocol
DECL|method|getAdditionalDatanode (final String src, final long fileId, final ExtendedBlock blk, final DatanodeInfo[] existings, final String[] existingStorageIDs, final DatanodeInfo[] excludes, final int numAdditionalNodes, final String clientName)
specifier|public
name|LocatedBlock
name|getAdditionalDatanode
parameter_list|(
specifier|final
name|String
name|src
parameter_list|,
specifier|final
name|long
name|fileId
parameter_list|,
specifier|final
name|ExtendedBlock
name|blk
parameter_list|,
specifier|final
name|DatanodeInfo
index|[]
name|existings
parameter_list|,
specifier|final
name|String
index|[]
name|existingStorageIDs
parameter_list|,
specifier|final
name|DatanodeInfo
index|[]
name|excludes
parameter_list|,
specifier|final
name|int
name|numAdditionalNodes
parameter_list|,
specifier|final
name|String
name|clientName
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|)
expr_stmt|;
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|false
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"getAdditionalDatanode"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|long
operator|.
name|class
operator|,
name|ExtendedBlock
operator|.
name|class
operator|,
name|DatanodeInfo
index|[]
operator|.
expr|class
operator|,
name|String
index|[]
operator|.
expr|class
operator|,
name|DatanodeInfo
index|[]
operator|.
expr|class
operator|,
name|int
operator|.
name|class
operator|,
name|String
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
operator|,
name|fileId
operator|,
name|blk
operator|,
name|existings
operator|,
name|existingStorageIDs
operator|,
name|excludes
operator|,
name|numAdditionalNodes
operator|,
name|clientName
block|)
function|;
end_function

begin_return
return|return
operator|(
name|LocatedBlock
operator|)
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|,
name|LocatedBlock
operator|.
name|class
argument_list|,
literal|null
argument_list|)
return|;
end_return

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|abandonBlock (ExtendedBlock b, long fileId, String src, String holder)
specifier|public
name|void
name|abandonBlock
parameter_list|(
name|ExtendedBlock
name|b
parameter_list|,
name|long
name|fileId
parameter_list|,
name|String
name|src
parameter_list|,
name|String
name|holder
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"abandonBlock"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|ExtendedBlock
operator|.
name|class
operator|,
name|long
operator|.
name|class
operator|,
name|String
operator|.
name|class
operator|,
name|String
operator|.
name|class
block|}
operator|,
name|b
operator|,
name|fileId
operator|,
operator|new
name|RemoteParam
argument_list|()
operator|,
name|holder
block|)
function|;
end_function

begin_expr_stmt
name|rpcClient
operator|.
name|invokeSingle
argument_list|(
name|b
argument_list|,
name|method
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|complete (String src, String clientName, ExtendedBlock last, long fileId)
specifier|public
name|boolean
name|complete
parameter_list|(
name|String
name|src
parameter_list|,
name|String
name|clientName
parameter_list|,
name|ExtendedBlock
name|last
parameter_list|,
name|long
name|fileId
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"complete"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|String
operator|.
name|class
operator|,
name|ExtendedBlock
operator|.
name|class
operator|,
name|long
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
operator|,
name|clientName
operator|,
name|last
operator|,
name|fileId
block|)
function|;
end_function

begin_comment
comment|// Complete can return true/false, so don't expect a result
end_comment

begin_return
return|return
operator|(
operator|(
name|Boolean
operator|)
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|,
name|Boolean
operator|.
name|class
argument_list|,
literal|null
argument_list|)
operator|)
operator|.
name|booleanValue
argument_list|()
return|;
end_return

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|updateBlockForPipeline ( ExtendedBlock block, String clientName)
specifier|public
name|LocatedBlock
name|updateBlockForPipeline
parameter_list|(
name|ExtendedBlock
name|block
parameter_list|,
name|String
name|clientName
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"updateBlockForPipeline"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|ExtendedBlock
operator|.
name|class
operator|,
name|String
operator|.
name|class
block|}
operator|,
name|block
operator|,
name|clientName
block|)
function|;
end_function

begin_return
return|return
operator|(
name|LocatedBlock
operator|)
name|rpcClient
operator|.
name|invokeSingle
argument_list|(
name|block
argument_list|,
name|method
argument_list|)
return|;
end_return

begin_comment
unit|}
comment|/**    * Datanode are not verified to be in the same nameservice as the old block.    * TODO This may require validation.    */
end_comment

begin_function
unit|@
name|Override
comment|// ClientProtocol
DECL|method|updatePipeline (String clientName, ExtendedBlock oldBlock, ExtendedBlock newBlock, DatanodeID[] newNodes, String[] newStorageIDs)
specifier|public
name|void
name|updatePipeline
parameter_list|(
name|String
name|clientName
parameter_list|,
name|ExtendedBlock
name|oldBlock
parameter_list|,
name|ExtendedBlock
name|newBlock
parameter_list|,
name|DatanodeID
index|[]
name|newNodes
parameter_list|,
name|String
index|[]
name|newStorageIDs
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"updatePipeline"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|ExtendedBlock
operator|.
name|class
operator|,
name|ExtendedBlock
operator|.
name|class
operator|,
name|DatanodeID
index|[]
operator|.
expr|class
operator|,
name|String
index|[]
operator|.
expr|class
block|}
operator|,
name|clientName
operator|,
name|oldBlock
operator|,
name|newBlock
operator|,
name|newNodes
operator|,
name|newStorageIDs
block|)
function|;
end_function

begin_expr_stmt
name|rpcClient
operator|.
name|invokeSingle
argument_list|(
name|oldBlock
argument_list|,
name|method
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|getPreferredBlockSize (String src)
specifier|public
name|long
name|getPreferredBlockSize
parameter_list|(
name|String
name|src
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|)
expr_stmt|;
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"getPreferredBlockSize"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
block|)
function|;
end_function

begin_return
return|return
operator|(
operator|(
name|Long
operator|)
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|,
name|Long
operator|.
name|class
argument_list|,
literal|null
argument_list|)
operator|)
operator|.
name|longValue
argument_list|()
return|;
end_return

begin_comment
unit|}
comment|/**    * Determines combinations of eligible src/dst locations for a rename. A    * rename cannot change the namespace. Renames are only allowed if there is an    * eligible dst location in the same namespace as the source.    *    * @param srcLocations List of all potential source destinations where the    *          path may be located. On return this list is trimmed to include    *          only the paths that have corresponding destinations in the same    *          namespace.    * @param dst The destination path    * @return A map of all eligible source namespaces and their corresponding    *         replacement value.    * @throws IOException If the dst paths could not be determined.    */
end_comment

begin_function
DECL|method|getRenameDestinations ( final List<RemoteLocation> srcLocations, final String dst)
unit|private
name|RemoteParam
name|getRenameDestinations
parameter_list|(
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|srcLocations
parameter_list|,
specifier|final
name|String
name|dst
parameter_list|)
throws|throws
name|IOException
block|{
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|dstLocations
init|=
name|getLocationsForPath
argument_list|(
name|dst
argument_list|,
literal|true
argument_list|)
decl_stmt|;
specifier|final
name|Map
argument_list|<
name|RemoteLocation
argument_list|,
name|String
argument_list|>
name|dstMap
init|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
decl_stmt|;
name|Iterator
argument_list|<
name|RemoteLocation
argument_list|>
name|iterator
init|=
name|srcLocations
operator|.
name|iterator
argument_list|()
decl_stmt|;
while|while
condition|(
name|iterator
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|RemoteLocation
name|srcLocation
init|=
name|iterator
operator|.
name|next
argument_list|()
decl_stmt|;
name|RemoteLocation
name|eligibleDst
init|=
name|getFirstMatchingLocation
argument_list|(
name|srcLocation
argument_list|,
name|dstLocations
argument_list|)
decl_stmt|;
if|if
condition|(
name|eligibleDst
operator|!=
literal|null
condition|)
block|{
comment|// Use this dst for this source location
name|dstMap
operator|.
name|put
argument_list|(
name|srcLocation
argument_list|,
name|eligibleDst
operator|.
name|getDest
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// This src destination is not valid, remove from the source list
name|iterator
operator|.
name|remove
argument_list|()
expr_stmt|;
block|}
block|}
return|return
operator|new
name|RemoteParam
argument_list|(
name|dstMap
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**    * Get first matching location.    *    * @param location Location we are looking for.    * @param locations List of locations.    * @return The first matchin location in the list.    */
end_comment

begin_function
DECL|method|getFirstMatchingLocation (RemoteLocation location, List<RemoteLocation> locations)
specifier|private
name|RemoteLocation
name|getFirstMatchingLocation
parameter_list|(
name|RemoteLocation
name|location
parameter_list|,
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
parameter_list|)
block|{
for|for
control|(
name|RemoteLocation
name|loc
range|:
name|locations
control|)
block|{
if|if
condition|(
name|loc
operator|.
name|getNameserviceId
argument_list|()
operator|.
name|equals
argument_list|(
name|location
operator|.
name|getNameserviceId
argument_list|()
argument_list|)
condition|)
block|{
comment|// Return first matching location
return|return
name|loc
return|;
block|}
block|}
return|return
literal|null
return|;
block|}
end_function

begin_function
annotation|@
name|Deprecated
annotation|@
name|Override
comment|// ClientProtocol
DECL|method|rename (final String src, final String dst)
specifier|public
name|boolean
name|rename
parameter_list|(
specifier|final
name|String
name|src
parameter_list|,
specifier|final
name|String
name|dst
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|srcLocations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|true
argument_list|)
decl_stmt|;
comment|// srcLocations may be trimmed by getRenameDestinations()
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locs
init|=
operator|new
name|LinkedList
argument_list|<>
argument_list|(
name|srcLocations
argument_list|)
decl_stmt|;
name|RemoteParam
name|dstParam
init|=
name|getRenameDestinations
argument_list|(
name|locs
argument_list|,
name|dst
argument_list|)
decl_stmt|;
if|if
condition|(
name|locs
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Rename of "
operator|+
name|src
operator|+
literal|" to "
operator|+
name|dst
operator|+
literal|" is not allowed,"
operator|+
literal|" no eligible destination in the same namespace was found."
argument_list|)
throw|;
block|}
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"rename"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|String
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
operator|,
name|dstParam
block|)
function|;
end_function

begin_return
return|return
operator|(
operator|(
name|Boolean
operator|)
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locs
argument_list|,
name|method
argument_list|,
name|Boolean
operator|.
name|class
argument_list|,
name|Boolean
operator|.
name|TRUE
argument_list|)
operator|)
operator|.
name|booleanValue
argument_list|()
return|;
end_return

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|rename2 (final String src, final String dst, final Options.Rename... options)
specifier|public
name|void
name|rename2
parameter_list|(
specifier|final
name|String
name|src
parameter_list|,
specifier|final
name|String
name|dst
parameter_list|,
specifier|final
name|Options
operator|.
name|Rename
modifier|...
name|options
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|srcLocations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|true
argument_list|)
decl_stmt|;
comment|// srcLocations may be trimmed by getRenameDestinations()
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locs
init|=
operator|new
name|LinkedList
argument_list|<>
argument_list|(
name|srcLocations
argument_list|)
decl_stmt|;
name|RemoteParam
name|dstParam
init|=
name|getRenameDestinations
argument_list|(
name|locs
argument_list|,
name|dst
argument_list|)
decl_stmt|;
if|if
condition|(
name|locs
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Rename of "
operator|+
name|src
operator|+
literal|" to "
operator|+
name|dst
operator|+
literal|" is not allowed,"
operator|+
literal|" no eligible destination in the same namespace was found."
argument_list|)
throw|;
block|}
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"rename2"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|String
operator|.
name|class
operator|,
name|options
operator|.
name|getClass
argument_list|()
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
operator|,
name|dstParam
operator|,
name|options
block|)
function|;
end_function

begin_expr_stmt
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locs
argument_list|,
name|method
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|concat (String trg, String[] src)
specifier|public
name|void
name|concat
parameter_list|(
name|String
name|trg
parameter_list|,
name|String
index|[]
name|src
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
comment|// See if the src and target files are all in the same namespace
name|LocatedBlocks
name|targetBlocks
init|=
name|getBlockLocations
argument_list|(
name|trg
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
decl_stmt|;
if|if
condition|(
name|targetBlocks
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Cannot locate blocks for target file - "
operator|+
name|trg
argument_list|)
throw|;
block|}
name|LocatedBlock
name|lastLocatedBlock
init|=
name|targetBlocks
operator|.
name|getLastLocatedBlock
argument_list|()
decl_stmt|;
name|String
name|targetBlockPoolId
init|=
name|lastLocatedBlock
operator|.
name|getBlock
argument_list|()
operator|.
name|getBlockPoolId
argument_list|()
decl_stmt|;
for|for
control|(
name|String
name|source
range|:
name|src
control|)
block|{
name|LocatedBlocks
name|sourceBlocks
init|=
name|getBlockLocations
argument_list|(
name|source
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
decl_stmt|;
if|if
condition|(
name|sourceBlocks
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Cannot located blocks for source file "
operator|+
name|source
argument_list|)
throw|;
block|}
name|String
name|sourceBlockPoolId
init|=
name|sourceBlocks
operator|.
name|getLastLocatedBlock
argument_list|()
operator|.
name|getBlock
argument_list|()
operator|.
name|getBlockPoolId
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|sourceBlockPoolId
operator|.
name|equals
argument_list|(
name|targetBlockPoolId
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Cannot concatenate source file "
operator|+
name|source
operator|+
literal|" because it is located in a different namespace"
operator|+
literal|" with block pool id "
operator|+
name|sourceBlockPoolId
operator|+
literal|" from the target file with block pool id "
operator|+
name|targetBlockPoolId
argument_list|)
throw|;
block|}
block|}
comment|// Find locations in the matching namespace.
specifier|final
name|RemoteLocation
name|targetDestination
init|=
name|getLocationForPath
argument_list|(
name|trg
argument_list|,
literal|true
argument_list|,
name|targetBlockPoolId
argument_list|)
decl_stmt|;
name|String
index|[]
name|sourceDestinations
init|=
operator|new
name|String
index|[
name|src
operator|.
name|length
index|]
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|src
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|String
name|sourceFile
init|=
name|src
index|[
name|i
index|]
decl_stmt|;
name|RemoteLocation
name|location
init|=
name|getLocationForPath
argument_list|(
name|sourceFile
argument_list|,
literal|true
argument_list|,
name|targetBlockPoolId
argument_list|)
decl_stmt|;
name|sourceDestinations
index|[
name|i
index|]
operator|=
name|location
operator|.
name|getDest
argument_list|()
expr_stmt|;
block|}
comment|// Invoke
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"concat"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|String
index|[]
operator|.
expr|class
block|}
operator|,
name|targetDestination
operator|.
name|getDest
argument_list|()
operator|,
name|sourceDestinations
block|)
function|;
end_function

begin_expr_stmt
name|rpcClient
operator|.
name|invokeSingle
argument_list|(
name|targetDestination
argument_list|,
name|method
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|truncate (String src, long newLength, String clientName)
specifier|public
name|boolean
name|truncate
parameter_list|(
name|String
name|src
parameter_list|,
name|long
name|newLength
parameter_list|,
name|String
name|clientName
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"truncate"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|long
operator|.
name|class
operator|,
name|String
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
operator|,
name|newLength
operator|,
name|clientName
block|)
function|;
end_function

begin_return
return|return
operator|(
operator|(
name|Boolean
operator|)
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|,
name|Boolean
operator|.
name|class
argument_list|,
name|Boolean
operator|.
name|TRUE
argument_list|)
operator|)
operator|.
name|booleanValue
argument_list|()
return|;
end_return

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|delete (String src, boolean recursive)
specifier|public
name|boolean
name|delete
parameter_list|(
name|String
name|src
parameter_list|,
name|boolean
name|recursive
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"delete"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|boolean
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
operator|,
name|recursive
block|)
function|;
end_function

begin_return
return|return
operator|(
operator|(
name|Boolean
operator|)
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|,
name|Boolean
operator|.
name|class
argument_list|,
name|Boolean
operator|.
name|TRUE
argument_list|)
operator|)
operator|.
name|booleanValue
argument_list|()
return|;
end_return

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|mkdirs (String src, FsPermission masked, boolean createParent)
specifier|public
name|boolean
name|mkdirs
parameter_list|(
name|String
name|src
parameter_list|,
name|FsPermission
name|masked
parameter_list|,
name|boolean
name|createParent
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|true
argument_list|)
decl_stmt|;
if|if
condition|(
name|locations
operator|.
name|size
argument_list|()
operator|>
literal|1
condition|)
block|{
comment|// Check if this directory already exists
try|try
block|{
name|HdfsFileStatus
name|fileStatus
init|=
name|getFileInfo
argument_list|(
name|src
argument_list|)
decl_stmt|;
if|if
condition|(
name|fileStatus
operator|!=
literal|null
condition|)
block|{
comment|// When existing, the NN doesn't return an exception; return true
return|return
literal|true
return|;
block|}
block|}
catch|catch
parameter_list|(
name|IOException
name|ioe
parameter_list|)
block|{
comment|// Can't query if this file exists or not.
name|LOG
operator|.
name|error
argument_list|(
literal|"Error requesting file info for path {} while proxing mkdirs"
argument_list|,
name|src
argument_list|,
name|ioe
argument_list|)
expr_stmt|;
block|}
block|}
name|RemoteLocation
name|firstLocation
init|=
name|locations
operator|.
name|get
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"mkdirs"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|FsPermission
operator|.
name|class
operator|,
name|boolean
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
operator|,
name|masked
operator|,
name|createParent
block|)
function|;
end_function

begin_return
return|return
operator|(
operator|(
name|Boolean
operator|)
name|rpcClient
operator|.
name|invokeSingle
argument_list|(
name|firstLocation
argument_list|,
name|method
argument_list|)
operator|)
operator|.
name|booleanValue
argument_list|()
return|;
end_return

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|renewLease (String clientName)
specifier|public
name|void
name|renewLease
parameter_list|(
name|String
name|clientName
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"renewLease"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
block|}
operator|,
name|clientName
block|)
function|;
end_function

begin_decl_stmt
name|Set
argument_list|<
name|FederationNamespaceInfo
argument_list|>
name|nss
init|=
name|namenodeResolver
operator|.
name|getNamespaces
argument_list|()
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|rpcClient
operator|.
name|invokeConcurrent
argument_list|(
name|nss
argument_list|,
name|method
argument_list|,
literal|false
argument_list|,
literal|false
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|getListing (String src, byte[] startAfter, boolean needLocation)
specifier|public
name|DirectoryListing
name|getListing
parameter_list|(
name|String
name|src
parameter_list|,
name|byte
index|[]
name|startAfter
parameter_list|,
name|boolean
name|needLocation
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|)
expr_stmt|;
comment|// Locate the dir and fetch the listing
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"getListing"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|startAfter
operator|.
name|getClass
argument_list|()
operator|,
name|boolean
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
operator|,
name|startAfter
operator|,
name|needLocation
block|)
function|;
end_function

begin_decl_stmt
name|Map
argument_list|<
name|RemoteLocation
argument_list|,
name|Object
argument_list|>
name|listings
init|=
name|rpcClient
operator|.
name|invokeConcurrent
argument_list|(
name|locations
argument_list|,
name|method
argument_list|,
literal|false
argument_list|,
literal|false
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Map
argument_list|<
name|String
argument_list|,
name|HdfsFileStatus
argument_list|>
name|nnListing
init|=
operator|new
name|TreeMap
argument_list|<>
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|totalRemainingEntries
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|remainingEntries
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|boolean
name|namenodeListingExists
init|=
literal|false
decl_stmt|;
end_decl_stmt

begin_if
if|if
condition|(
name|listings
operator|!=
literal|null
condition|)
block|{
comment|// Check the subcluster listing with the smallest name
name|String
name|lastName
init|=
literal|null
decl_stmt|;
for|for
control|(
name|Entry
argument_list|<
name|RemoteLocation
argument_list|,
name|Object
argument_list|>
name|entry
range|:
name|listings
operator|.
name|entrySet
argument_list|()
control|)
block|{
name|RemoteLocation
name|location
init|=
name|entry
operator|.
name|getKey
argument_list|()
decl_stmt|;
name|DirectoryListing
name|listing
init|=
operator|(
name|DirectoryListing
operator|)
name|entry
operator|.
name|getValue
argument_list|()
decl_stmt|;
if|if
condition|(
name|listing
operator|==
literal|null
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Cannot get listing from {}"
argument_list|,
name|location
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|totalRemainingEntries
operator|+=
name|listing
operator|.
name|getRemainingEntries
argument_list|()
expr_stmt|;
name|HdfsFileStatus
index|[]
name|partialListing
init|=
name|listing
operator|.
name|getPartialListing
argument_list|()
decl_stmt|;
name|int
name|length
init|=
name|partialListing
operator|.
name|length
decl_stmt|;
if|if
condition|(
name|length
operator|>
literal|0
condition|)
block|{
name|HdfsFileStatus
name|lastLocalEntry
init|=
name|partialListing
index|[
name|length
operator|-
literal|1
index|]
decl_stmt|;
name|String
name|lastLocalName
init|=
name|lastLocalEntry
operator|.
name|getLocalName
argument_list|()
decl_stmt|;
if|if
condition|(
name|lastName
operator|==
literal|null
operator|||
name|lastName
operator|.
name|compareTo
argument_list|(
name|lastLocalName
argument_list|)
operator|>
literal|0
condition|)
block|{
name|lastName
operator|=
name|lastLocalName
expr_stmt|;
block|}
block|}
block|}
block|}
comment|// Add existing entries
for|for
control|(
name|Object
name|value
range|:
name|listings
operator|.
name|values
argument_list|()
control|)
block|{
name|DirectoryListing
name|listing
init|=
operator|(
name|DirectoryListing
operator|)
name|value
decl_stmt|;
if|if
condition|(
name|listing
operator|!=
literal|null
condition|)
block|{
name|namenodeListingExists
operator|=
literal|true
expr_stmt|;
for|for
control|(
name|HdfsFileStatus
name|file
range|:
name|listing
operator|.
name|getPartialListing
argument_list|()
control|)
block|{
name|String
name|filename
init|=
name|file
operator|.
name|getLocalName
argument_list|()
decl_stmt|;
if|if
condition|(
name|totalRemainingEntries
operator|>
literal|0
operator|&&
name|filename
operator|.
name|compareTo
argument_list|(
name|lastName
argument_list|)
operator|>
literal|0
condition|)
block|{
comment|// Discarding entries further than the lastName
name|remainingEntries
operator|++
expr_stmt|;
block|}
else|else
block|{
name|nnListing
operator|.
name|put
argument_list|(
name|filename
argument_list|,
name|file
argument_list|)
expr_stmt|;
block|}
block|}
name|remainingEntries
operator|+=
name|listing
operator|.
name|getRemainingEntries
argument_list|()
expr_stmt|;
block|}
block|}
block|}
end_if

begin_comment
comment|// Add mount points at this level in the tree
end_comment

begin_decl_stmt
specifier|final
name|List
argument_list|<
name|String
argument_list|>
name|children
init|=
name|subclusterResolver
operator|.
name|getMountPoints
argument_list|(
name|src
argument_list|)
decl_stmt|;
end_decl_stmt

begin_if
if|if
condition|(
name|children
operator|!=
literal|null
condition|)
block|{
comment|// Get the dates for each mount point
name|Map
argument_list|<
name|String
argument_list|,
name|Long
argument_list|>
name|dates
init|=
name|getMountPointDates
argument_list|(
name|src
argument_list|)
decl_stmt|;
comment|// Create virtual folder with the mount name
for|for
control|(
name|String
name|child
range|:
name|children
control|)
block|{
name|long
name|date
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|dates
operator|!=
literal|null
operator|&&
name|dates
operator|.
name|containsKey
argument_list|(
name|child
argument_list|)
condition|)
block|{
name|date
operator|=
name|dates
operator|.
name|get
argument_list|(
name|child
argument_list|)
expr_stmt|;
block|}
comment|// TODO add number of children
name|HdfsFileStatus
name|dirStatus
init|=
name|getMountPointStatus
argument_list|(
name|child
argument_list|,
literal|0
argument_list|,
name|date
argument_list|)
decl_stmt|;
comment|// This may overwrite existing listing entries with the mount point
comment|// TODO don't add if already there?
name|nnListing
operator|.
name|put
argument_list|(
name|child
argument_list|,
name|dirStatus
argument_list|)
expr_stmt|;
block|}
block|}
end_if

begin_if
if|if
condition|(
operator|!
name|namenodeListingExists
operator|&&
name|nnListing
operator|.
name|size
argument_list|()
operator|==
literal|0
condition|)
block|{
comment|// NN returns a null object if the directory cannot be found and has no
comment|// listing. If we didn't retrieve any NN listing data, and there are no
comment|// mount points here, return null.
return|return
literal|null
return|;
block|}
end_if

begin_comment
comment|// Generate combined listing
end_comment

begin_decl_stmt
name|HdfsFileStatus
index|[]
name|combinedData
init|=
operator|new
name|HdfsFileStatus
index|[
name|nnListing
operator|.
name|size
argument_list|()
index|]
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|combinedData
operator|=
name|nnListing
operator|.
name|values
argument_list|()
operator|.
name|toArray
argument_list|(
name|combinedData
argument_list|)
expr_stmt|;
end_expr_stmt

begin_return
return|return
operator|new
name|DirectoryListing
argument_list|(
name|combinedData
argument_list|,
name|remainingEntries
argument_list|)
return|;
end_return

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|getFileInfo (String src)
specifier|public
name|HdfsFileStatus
name|getFileInfo
parameter_list|(
name|String
name|src
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|)
expr_stmt|;
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|false
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"getFileInfo"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
block|)
function|;
end_function

begin_decl_stmt
name|HdfsFileStatus
name|ret
init|=
operator|(
name|HdfsFileStatus
operator|)
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|,
name|HdfsFileStatus
operator|.
name|class
argument_list|,
literal|null
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|// If there is no real path, check mount points
end_comment

begin_if
if|if
condition|(
name|ret
operator|==
literal|null
condition|)
block|{
name|List
argument_list|<
name|String
argument_list|>
name|children
init|=
name|subclusterResolver
operator|.
name|getMountPoints
argument_list|(
name|src
argument_list|)
decl_stmt|;
if|if
condition|(
name|children
operator|!=
literal|null
operator|&&
operator|!
name|children
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|Map
argument_list|<
name|String
argument_list|,
name|Long
argument_list|>
name|dates
init|=
name|getMountPointDates
argument_list|(
name|src
argument_list|)
decl_stmt|;
name|long
name|date
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|dates
operator|!=
literal|null
operator|&&
name|dates
operator|.
name|containsKey
argument_list|(
name|src
argument_list|)
condition|)
block|{
name|date
operator|=
name|dates
operator|.
name|get
argument_list|(
name|src
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|getMountPointStatus
argument_list|(
name|src
argument_list|,
name|children
operator|.
name|size
argument_list|()
argument_list|,
name|date
argument_list|)
expr_stmt|;
block|}
block|}
end_if

begin_return
return|return
name|ret
return|;
end_return

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|isFileClosed (String src)
specifier|public
name|boolean
name|isFileClosed
parameter_list|(
name|String
name|src
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|)
expr_stmt|;
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|false
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"isFileClosed"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
block|)
function|;
end_function

begin_return
return|return
operator|(
operator|(
name|Boolean
operator|)
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|,
name|Boolean
operator|.
name|class
argument_list|,
name|Boolean
operator|.
name|TRUE
argument_list|)
operator|)
operator|.
name|booleanValue
argument_list|()
return|;
end_return

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|getFileLinkInfo (String src)
specifier|public
name|HdfsFileStatus
name|getFileLinkInfo
parameter_list|(
name|String
name|src
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|)
expr_stmt|;
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|false
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"getFileLinkInfo"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
block|)
function|;
end_function

begin_return
return|return
operator|(
name|HdfsFileStatus
operator|)
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|,
name|HdfsFileStatus
operator|.
name|class
argument_list|,
literal|null
argument_list|)
return|;
end_return

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|getStats ()
specifier|public
name|long
index|[]
name|getStats
parameter_list|()
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|UNCHECKED
argument_list|)
expr_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"getStats"
argument_list|)
decl_stmt|;
name|Set
argument_list|<
name|FederationNamespaceInfo
argument_list|>
name|nss
init|=
name|namenodeResolver
operator|.
name|getNamespaces
argument_list|()
decl_stmt|;
name|Map
argument_list|<
name|FederationNamespaceInfo
argument_list|,
name|Object
argument_list|>
name|results
init|=
name|rpcClient
operator|.
name|invokeConcurrent
argument_list|(
name|nss
argument_list|,
name|method
argument_list|,
literal|true
argument_list|,
literal|false
argument_list|)
decl_stmt|;
name|long
index|[]
name|combinedData
init|=
operator|new
name|long
index|[
name|STATS_ARRAY_LENGTH
index|]
decl_stmt|;
for|for
control|(
name|Object
name|o
range|:
name|results
operator|.
name|values
argument_list|()
control|)
block|{
name|long
index|[]
name|data
init|=
operator|(
name|long
index|[]
operator|)
name|o
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|combinedData
operator|.
name|length
operator|&&
name|i
operator|<
name|data
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|data
index|[
name|i
index|]
operator|>=
literal|0
condition|)
block|{
name|combinedData
index|[
name|i
index|]
operator|+=
name|data
index|[
name|i
index|]
expr_stmt|;
block|}
block|}
block|}
return|return
name|combinedData
return|;
block|}
end_function

begin_function
annotation|@
name|Override
comment|// ClientProtocol
DECL|method|getDatanodeReport (DatanodeReportType type)
specifier|public
name|DatanodeInfo
index|[]
name|getDatanodeReport
parameter_list|(
name|DatanodeReportType
name|type
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|UNCHECKED
argument_list|)
expr_stmt|;
return|return
name|getDatanodeReport
argument_list|(
name|type
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**    * Get the datanode report with a timeout.    * @param type Type of the datanode.    * @param timeOutMs Time out for the reply in milliseconds.    * @return List of datanodes.    * @throws IOException If it cannot get the report.    */
end_comment

begin_function
DECL|method|getDatanodeReport ( DatanodeReportType type, long timeOutMs)
specifier|public
name|DatanodeInfo
index|[]
name|getDatanodeReport
parameter_list|(
name|DatanodeReportType
name|type
parameter_list|,
name|long
name|timeOutMs
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|UNCHECKED
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|DatanodeInfo
argument_list|>
name|datanodesMap
init|=
operator|new
name|LinkedHashMap
argument_list|<>
argument_list|()
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"getDatanodeReport"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|DatanodeReportType
operator|.
name|class
block|}
operator|,
name|type
block|)
function|;
end_function

begin_decl_stmt
name|Set
argument_list|<
name|FederationNamespaceInfo
argument_list|>
name|nss
init|=
name|namenodeResolver
operator|.
name|getNamespaces
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Map
argument_list|<
name|FederationNamespaceInfo
argument_list|,
name|Object
argument_list|>
name|results
init|=
name|rpcClient
operator|.
name|invokeConcurrent
argument_list|(
name|nss
argument_list|,
name|method
argument_list|,
literal|true
argument_list|,
literal|false
argument_list|,
name|timeOutMs
argument_list|)
decl_stmt|;
end_decl_stmt

begin_for
for|for
control|(
name|Entry
argument_list|<
name|FederationNamespaceInfo
argument_list|,
name|Object
argument_list|>
name|entry
range|:
name|results
operator|.
name|entrySet
argument_list|()
control|)
block|{
name|FederationNamespaceInfo
name|ns
init|=
name|entry
operator|.
name|getKey
argument_list|()
decl_stmt|;
name|DatanodeInfo
index|[]
name|result
init|=
operator|(
name|DatanodeInfo
index|[]
operator|)
name|entry
operator|.
name|getValue
argument_list|()
decl_stmt|;
for|for
control|(
name|DatanodeInfo
name|node
range|:
name|result
control|)
block|{
name|String
name|nodeId
init|=
name|node
operator|.
name|getXferAddr
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|datanodesMap
operator|.
name|containsKey
argument_list|(
name|nodeId
argument_list|)
condition|)
block|{
comment|// Add the subcluster as a suffix to the network location
name|node
operator|.
name|setNetworkLocation
argument_list|(
name|NodeBase
operator|.
name|PATH_SEPARATOR_STR
operator|+
name|ns
operator|.
name|getNameserviceId
argument_list|()
operator|+
name|node
operator|.
name|getNetworkLocation
argument_list|()
argument_list|)
expr_stmt|;
name|datanodesMap
operator|.
name|put
argument_list|(
name|nodeId
argument_list|,
name|node
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"{} is in multiple subclusters"
argument_list|,
name|nodeId
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_for

begin_comment
comment|// Map -> Array
end_comment

begin_decl_stmt
name|Collection
argument_list|<
name|DatanodeInfo
argument_list|>
name|datanodes
init|=
name|datanodesMap
operator|.
name|values
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|DatanodeInfo
index|[]
name|combinedData
init|=
operator|new
name|DatanodeInfo
index|[
name|datanodes
operator|.
name|size
argument_list|()
index|]
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|combinedData
operator|=
name|datanodes
operator|.
name|toArray
argument_list|(
name|combinedData
argument_list|)
expr_stmt|;
end_expr_stmt

begin_return
return|return
name|combinedData
return|;
end_return

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|getDatanodeStorageReport ( DatanodeReportType type)
specifier|public
name|DatanodeStorageReport
index|[]
name|getDatanodeStorageReport
parameter_list|(
name|DatanodeReportType
name|type
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|UNCHECKED
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|DatanodeStorageReport
argument_list|>
name|datanodesMap
init|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"getDatanodeStorageReport"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|DatanodeReportType
operator|.
name|class
block|}
operator|,
name|type
block|)
function|;
end_function

begin_decl_stmt
name|Set
argument_list|<
name|FederationNamespaceInfo
argument_list|>
name|nss
init|=
name|namenodeResolver
operator|.
name|getNamespaces
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Map
argument_list|<
name|FederationNamespaceInfo
argument_list|,
name|Object
argument_list|>
name|results
init|=
name|rpcClient
operator|.
name|invokeConcurrent
argument_list|(
name|nss
argument_list|,
name|method
argument_list|,
literal|true
argument_list|,
literal|false
argument_list|)
decl_stmt|;
end_decl_stmt

begin_for
for|for
control|(
name|Object
name|r
range|:
name|results
operator|.
name|values
argument_list|()
control|)
block|{
name|DatanodeStorageReport
index|[]
name|result
init|=
operator|(
name|DatanodeStorageReport
index|[]
operator|)
name|r
decl_stmt|;
for|for
control|(
name|DatanodeStorageReport
name|node
range|:
name|result
control|)
block|{
name|String
name|nodeId
init|=
name|node
operator|.
name|getDatanodeInfo
argument_list|()
operator|.
name|getXferAddr
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|datanodesMap
operator|.
name|containsKey
argument_list|(
name|nodeId
argument_list|)
condition|)
block|{
name|datanodesMap
operator|.
name|put
argument_list|(
name|nodeId
argument_list|,
name|node
argument_list|)
expr_stmt|;
block|}
comment|// TODO merge somehow, right now it just takes the first one
block|}
block|}
end_for

begin_decl_stmt
name|Collection
argument_list|<
name|DatanodeStorageReport
argument_list|>
name|datanodes
init|=
name|datanodesMap
operator|.
name|values
argument_list|()
decl_stmt|;
end_decl_stmt

begin_comment
comment|// TODO sort somehow
end_comment

begin_decl_stmt
name|DatanodeStorageReport
index|[]
name|combinedData
init|=
operator|new
name|DatanodeStorageReport
index|[
name|datanodes
operator|.
name|size
argument_list|()
index|]
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|combinedData
operator|=
name|datanodes
operator|.
name|toArray
argument_list|(
name|combinedData
argument_list|)
expr_stmt|;
end_expr_stmt

begin_return
return|return
name|combinedData
return|;
end_return

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|setSafeMode (SafeModeAction action, boolean isChecked)
specifier|public
name|boolean
name|setSafeMode
parameter_list|(
name|SafeModeAction
name|action
parameter_list|,
name|boolean
name|isChecked
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
comment|// Set safe mode in all the name spaces
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"setSafeMode"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|SafeModeAction
operator|.
name|class
operator|,
name|boolean
operator|.
name|class
block|}
operator|,
name|action
operator|,
name|isChecked
block|)
function|;
end_function

begin_decl_stmt
name|Set
argument_list|<
name|FederationNamespaceInfo
argument_list|>
name|nss
init|=
name|namenodeResolver
operator|.
name|getNamespaces
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Map
argument_list|<
name|FederationNamespaceInfo
argument_list|,
name|Object
argument_list|>
name|results
init|=
name|rpcClient
operator|.
name|invokeConcurrent
argument_list|(
name|nss
argument_list|,
name|method
argument_list|,
literal|true
argument_list|,
literal|true
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|// We only report true if all the name space are in safe mode
end_comment

begin_decl_stmt
name|int
name|numSafemode
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_for
for|for
control|(
name|Object
name|result
range|:
name|results
operator|.
name|values
argument_list|()
control|)
block|{
if|if
condition|(
name|result
operator|instanceof
name|Boolean
condition|)
block|{
name|boolean
name|safemode
init|=
operator|(
name|boolean
operator|)
name|result
decl_stmt|;
if|if
condition|(
name|safemode
condition|)
block|{
name|numSafemode
operator|++
expr_stmt|;
block|}
block|}
block|}
end_for

begin_return
return|return
name|numSafemode
operator|==
name|results
operator|.
name|size
argument_list|()
return|;
end_return

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|restoreFailedStorage (String arg)
specifier|public
name|boolean
name|restoreFailedStorage
parameter_list|(
name|String
name|arg
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|UNCHECKED
argument_list|)
expr_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"restoreFailedStorage"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
block|}
operator|,
name|arg
block|)
function|;
end_function

begin_decl_stmt
specifier|final
name|Set
argument_list|<
name|FederationNamespaceInfo
argument_list|>
name|nss
init|=
name|namenodeResolver
operator|.
name|getNamespaces
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Map
argument_list|<
name|FederationNamespaceInfo
argument_list|,
name|Object
argument_list|>
name|ret
init|=
name|rpcClient
operator|.
name|invokeConcurrent
argument_list|(
name|nss
argument_list|,
name|method
argument_list|,
literal|true
argument_list|,
literal|false
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|boolean
name|success
init|=
literal|true
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Object
name|obj
init|=
name|ret
decl_stmt|;
end_decl_stmt

begin_decl_stmt
annotation|@
name|SuppressWarnings
argument_list|(
literal|"unchecked"
argument_list|)
name|Map
argument_list|<
name|FederationNamespaceInfo
argument_list|,
name|Boolean
argument_list|>
name|results
init|=
operator|(
name|Map
argument_list|<
name|FederationNamespaceInfo
argument_list|,
name|Boolean
argument_list|>
operator|)
name|obj
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Collection
argument_list|<
name|Boolean
argument_list|>
name|sucesses
init|=
name|results
operator|.
name|values
argument_list|()
decl_stmt|;
end_decl_stmt

begin_for
for|for
control|(
name|boolean
name|s
range|:
name|sucesses
control|)
block|{
if|if
condition|(
operator|!
name|s
condition|)
block|{
name|success
operator|=
literal|false
expr_stmt|;
block|}
block|}
end_for

begin_return
return|return
name|success
return|;
end_return

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|saveNamespace (long timeWindow, long txGap)
specifier|public
name|boolean
name|saveNamespace
parameter_list|(
name|long
name|timeWindow
parameter_list|,
name|long
name|txGap
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|UNCHECKED
argument_list|)
expr_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"saveNamespace"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|Long
operator|.
name|class
operator|,
name|Long
operator|.
name|class
block|}
operator|,
name|timeWindow
operator|,
name|txGap
block|)
function|;
end_function

begin_decl_stmt
specifier|final
name|Set
argument_list|<
name|FederationNamespaceInfo
argument_list|>
name|nss
init|=
name|namenodeResolver
operator|.
name|getNamespaces
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Map
argument_list|<
name|FederationNamespaceInfo
argument_list|,
name|Object
argument_list|>
name|ret
init|=
name|rpcClient
operator|.
name|invokeConcurrent
argument_list|(
name|nss
argument_list|,
name|method
argument_list|,
literal|true
argument_list|,
literal|false
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|boolean
name|success
init|=
literal|true
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Object
name|obj
init|=
name|ret
decl_stmt|;
end_decl_stmt

begin_decl_stmt
annotation|@
name|SuppressWarnings
argument_list|(
literal|"unchecked"
argument_list|)
name|Map
argument_list|<
name|FederationNamespaceInfo
argument_list|,
name|Boolean
argument_list|>
name|results
init|=
operator|(
name|Map
argument_list|<
name|FederationNamespaceInfo
argument_list|,
name|Boolean
argument_list|>
operator|)
name|obj
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Collection
argument_list|<
name|Boolean
argument_list|>
name|sucesses
init|=
name|results
operator|.
name|values
argument_list|()
decl_stmt|;
end_decl_stmt

begin_for
for|for
control|(
name|boolean
name|s
range|:
name|sucesses
control|)
block|{
if|if
condition|(
operator|!
name|s
condition|)
block|{
name|success
operator|=
literal|false
expr_stmt|;
block|}
block|}
end_for

begin_return
return|return
name|success
return|;
end_return

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|rollEdits ()
specifier|public
name|long
name|rollEdits
parameter_list|()
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"rollEdits"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{}
block|)
function|;
end_function

begin_decl_stmt
specifier|final
name|Set
argument_list|<
name|FederationNamespaceInfo
argument_list|>
name|nss
init|=
name|namenodeResolver
operator|.
name|getNamespaces
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Map
argument_list|<
name|FederationNamespaceInfo
argument_list|,
name|Object
argument_list|>
name|ret
init|=
name|rpcClient
operator|.
name|invokeConcurrent
argument_list|(
name|nss
argument_list|,
name|method
argument_list|,
literal|true
argument_list|,
literal|false
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|// Return the maximum txid
end_comment

begin_decl_stmt
name|long
name|txid
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Object
name|obj
init|=
name|ret
decl_stmt|;
end_decl_stmt

begin_decl_stmt
annotation|@
name|SuppressWarnings
argument_list|(
literal|"unchecked"
argument_list|)
name|Map
argument_list|<
name|FederationNamespaceInfo
argument_list|,
name|Long
argument_list|>
name|results
init|=
operator|(
name|Map
argument_list|<
name|FederationNamespaceInfo
argument_list|,
name|Long
argument_list|>
operator|)
name|obj
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Collection
argument_list|<
name|Long
argument_list|>
name|txids
init|=
name|results
operator|.
name|values
argument_list|()
decl_stmt|;
end_decl_stmt

begin_for
for|for
control|(
name|long
name|t
range|:
name|txids
control|)
block|{
if|if
condition|(
name|t
operator|>
name|txid
condition|)
block|{
name|txid
operator|=
name|t
expr_stmt|;
block|}
block|}
end_for

begin_return
return|return
name|txid
return|;
end_return

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|refreshNodes ()
specifier|public
name|void
name|refreshNodes
parameter_list|()
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|UNCHECKED
argument_list|)
expr_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"refreshNodes"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{}
block|)
function|;
end_function

begin_decl_stmt
specifier|final
name|Set
argument_list|<
name|FederationNamespaceInfo
argument_list|>
name|nss
init|=
name|namenodeResolver
operator|.
name|getNamespaces
argument_list|()
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|rpcClient
operator|.
name|invokeConcurrent
argument_list|(
name|nss
argument_list|,
name|method
argument_list|,
literal|true
argument_list|,
literal|true
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|finalizeUpgrade ()
specifier|public
name|void
name|finalizeUpgrade
parameter_list|()
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|UNCHECKED
argument_list|)
expr_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"finalizeUpgrade"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{}
block|)
function|;
end_function

begin_decl_stmt
specifier|final
name|Set
argument_list|<
name|FederationNamespaceInfo
argument_list|>
name|nss
init|=
name|namenodeResolver
operator|.
name|getNamespaces
argument_list|()
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|rpcClient
operator|.
name|invokeConcurrent
argument_list|(
name|nss
argument_list|,
name|method
argument_list|,
literal|true
argument_list|,
literal|false
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|rollingUpgrade (RollingUpgradeAction action)
specifier|public
name|RollingUpgradeInfo
name|rollingUpgrade
parameter_list|(
name|RollingUpgradeAction
name|action
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|)
expr_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"rollingUpgrade"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|RollingUpgradeAction
operator|.
name|class
block|}
operator|,
name|action
block|)
function|;
end_function

begin_decl_stmt
specifier|final
name|Set
argument_list|<
name|FederationNamespaceInfo
argument_list|>
name|nss
init|=
name|namenodeResolver
operator|.
name|getNamespaces
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Map
argument_list|<
name|FederationNamespaceInfo
argument_list|,
name|Object
argument_list|>
name|ret
init|=
name|rpcClient
operator|.
name|invokeConcurrent
argument_list|(
name|nss
argument_list|,
name|method
argument_list|,
literal|true
argument_list|,
literal|false
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|// Return the first rolling upgrade info
end_comment

begin_decl_stmt
name|RollingUpgradeInfo
name|info
init|=
literal|null
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Object
name|obj
init|=
name|ret
decl_stmt|;
end_decl_stmt

begin_decl_stmt
annotation|@
name|SuppressWarnings
argument_list|(
literal|"unchecked"
argument_list|)
name|Map
argument_list|<
name|FederationNamespaceInfo
argument_list|,
name|RollingUpgradeInfo
argument_list|>
name|results
init|=
operator|(
name|Map
argument_list|<
name|FederationNamespaceInfo
argument_list|,
name|RollingUpgradeInfo
argument_list|>
operator|)
name|obj
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Collection
argument_list|<
name|RollingUpgradeInfo
argument_list|>
name|infos
init|=
name|results
operator|.
name|values
argument_list|()
decl_stmt|;
end_decl_stmt

begin_for
for|for
control|(
name|RollingUpgradeInfo
name|infoNs
range|:
name|infos
control|)
block|{
if|if
condition|(
name|info
operator|==
literal|null
operator|&&
name|infoNs
operator|!=
literal|null
condition|)
block|{
name|info
operator|=
name|infoNs
expr_stmt|;
block|}
block|}
end_for

begin_return
return|return
name|info
return|;
end_return

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|metaSave (String filename)
specifier|public
name|void
name|metaSave
parameter_list|(
name|String
name|filename
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|UNCHECKED
argument_list|)
expr_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"metaSave"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
block|}
operator|,
name|filename
block|)
function|;
end_function

begin_decl_stmt
specifier|final
name|Set
argument_list|<
name|FederationNamespaceInfo
argument_list|>
name|nss
init|=
name|namenodeResolver
operator|.
name|getNamespaces
argument_list|()
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|rpcClient
operator|.
name|invokeConcurrent
argument_list|(
name|nss
argument_list|,
name|method
argument_list|,
literal|true
argument_list|,
literal|false
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|listCorruptFileBlocks (String path, String cookie)
specifier|public
name|CorruptFileBlocks
name|listCorruptFileBlocks
parameter_list|(
name|String
name|path
parameter_list|,
name|String
name|cookie
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|)
expr_stmt|;
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|path
argument_list|,
literal|false
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"listCorruptFileBlocks"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|String
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
operator|,
name|cookie
block|)
function|;
end_function

begin_return
return|return
operator|(
name|CorruptFileBlocks
operator|)
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|,
name|CorruptFileBlocks
operator|.
name|class
argument_list|,
literal|null
argument_list|)
return|;
end_return

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|setBalancerBandwidth (long bandwidth)
specifier|public
name|void
name|setBalancerBandwidth
parameter_list|(
name|long
name|bandwidth
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|UNCHECKED
argument_list|)
expr_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"setBalancerBandwidth"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|Long
operator|.
name|class
block|}
operator|,
name|bandwidth
block|)
function|;
end_function

begin_decl_stmt
specifier|final
name|Set
argument_list|<
name|FederationNamespaceInfo
argument_list|>
name|nss
init|=
name|namenodeResolver
operator|.
name|getNamespaces
argument_list|()
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|rpcClient
operator|.
name|invokeConcurrent
argument_list|(
name|nss
argument_list|,
name|method
argument_list|,
literal|true
argument_list|,
literal|false
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|getContentSummary (String path)
specifier|public
name|ContentSummary
name|getContentSummary
parameter_list|(
name|String
name|path
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|)
expr_stmt|;
comment|// Get the summaries from regular files
name|Collection
argument_list|<
name|ContentSummary
argument_list|>
name|summaries
init|=
operator|new
name|LinkedList
argument_list|<>
argument_list|()
decl_stmt|;
name|FileNotFoundException
name|notFoundException
init|=
literal|null
decl_stmt|;
try|try
block|{
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|path
argument_list|,
literal|false
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"getContentSummary"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
block|)
empty_stmt|;
annotation|@
name|SuppressWarnings
argument_list|(
literal|"unchecked"
argument_list|)
name|Map
argument_list|<
name|String
argument_list|,
name|ContentSummary
argument_list|>
name|results
init|=
call|(
name|Map
argument_list|<
name|String
argument_list|,
name|ContentSummary
argument_list|>
call|)
argument_list|(
operator|(
name|Object
operator|)
name|rpcClient
operator|.
name|invokeConcurrent
argument_list|(
name|locations
argument_list|,
name|method
argument_list|,
literal|false
argument_list|,
literal|false
argument_list|)
argument_list|)
decl_stmt|;
name|summaries
operator|.
name|addAll
argument_list|(
name|results
operator|.
name|values
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function

begin_catch
catch|catch
parameter_list|(
name|FileNotFoundException
name|e
parameter_list|)
block|{
name|notFoundException
operator|=
name|e
expr_stmt|;
block|}
end_catch

begin_comment
comment|// Add mount points at this level in the tree
end_comment

begin_decl_stmt
specifier|final
name|List
argument_list|<
name|String
argument_list|>
name|children
init|=
name|subclusterResolver
operator|.
name|getMountPoints
argument_list|(
name|path
argument_list|)
decl_stmt|;
end_decl_stmt

begin_if
if|if
condition|(
name|children
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|String
name|child
range|:
name|children
control|)
block|{
name|Path
name|childPath
init|=
operator|new
name|Path
argument_list|(
name|path
argument_list|,
name|child
argument_list|)
decl_stmt|;
try|try
block|{
name|ContentSummary
name|mountSummary
init|=
name|getContentSummary
argument_list|(
name|childPath
operator|.
name|toString
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|mountSummary
operator|!=
literal|null
condition|)
block|{
name|summaries
operator|.
name|add
argument_list|(
name|mountSummary
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Cannot get content summary for mount {}: {}"
argument_list|,
name|childPath
argument_list|,
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_if

begin_comment
comment|// Throw original exception if no original nor mount points
end_comment

begin_if
if|if
condition|(
name|summaries
operator|.
name|isEmpty
argument_list|()
operator|&&
name|notFoundException
operator|!=
literal|null
condition|)
block|{
throw|throw
name|notFoundException
throw|;
block|}
end_if

begin_return
return|return
name|aggregateContentSummary
argument_list|(
name|summaries
argument_list|)
return|;
end_return

begin_comment
unit|}
comment|/**    * Aggregate content summaries for each subcluster.    *    * @param summaries Collection of individual summaries.    * @return Aggregated content summary.    */
end_comment

begin_function
DECL|method|aggregateContentSummary ( Collection<ContentSummary> summaries)
unit|private
name|ContentSummary
name|aggregateContentSummary
parameter_list|(
name|Collection
argument_list|<
name|ContentSummary
argument_list|>
name|summaries
parameter_list|)
block|{
if|if
condition|(
name|summaries
operator|.
name|size
argument_list|()
operator|==
literal|1
condition|)
block|{
return|return
name|summaries
operator|.
name|iterator
argument_list|()
operator|.
name|next
argument_list|()
return|;
block|}
name|long
name|length
init|=
literal|0
decl_stmt|;
name|long
name|fileCount
init|=
literal|0
decl_stmt|;
name|long
name|directoryCount
init|=
literal|0
decl_stmt|;
name|long
name|quota
init|=
literal|0
decl_stmt|;
name|long
name|spaceConsumed
init|=
literal|0
decl_stmt|;
name|long
name|spaceQuota
init|=
literal|0
decl_stmt|;
for|for
control|(
name|ContentSummary
name|summary
range|:
name|summaries
control|)
block|{
name|length
operator|+=
name|summary
operator|.
name|getLength
argument_list|()
expr_stmt|;
name|fileCount
operator|+=
name|summary
operator|.
name|getFileCount
argument_list|()
expr_stmt|;
name|directoryCount
operator|+=
name|summary
operator|.
name|getDirectoryCount
argument_list|()
expr_stmt|;
name|quota
operator|+=
name|summary
operator|.
name|getQuota
argument_list|()
expr_stmt|;
name|spaceConsumed
operator|+=
name|summary
operator|.
name|getSpaceConsumed
argument_list|()
expr_stmt|;
name|spaceQuota
operator|+=
name|summary
operator|.
name|getSpaceQuota
argument_list|()
expr_stmt|;
block|}
name|ContentSummary
name|ret
init|=
operator|new
name|ContentSummary
operator|.
name|Builder
argument_list|()
operator|.
name|length
argument_list|(
name|length
argument_list|)
operator|.
name|fileCount
argument_list|(
name|fileCount
argument_list|)
operator|.
name|directoryCount
argument_list|(
name|directoryCount
argument_list|)
operator|.
name|quota
argument_list|(
name|quota
argument_list|)
operator|.
name|spaceConsumed
argument_list|(
name|spaceConsumed
argument_list|)
operator|.
name|spaceQuota
argument_list|(
name|spaceQuota
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
annotation|@
name|Override
comment|// ClientProtocol
DECL|method|fsync (String src, long fileId, String clientName, long lastBlockLength)
specifier|public
name|void
name|fsync
parameter_list|(
name|String
name|src
parameter_list|,
name|long
name|fileId
parameter_list|,
name|String
name|clientName
parameter_list|,
name|long
name|lastBlockLength
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"fsync"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|long
operator|.
name|class
operator|,
name|String
operator|.
name|class
operator|,
name|long
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
operator|,
name|fileId
operator|,
name|clientName
operator|,
name|lastBlockLength
block|)
function|;
end_function

begin_expr_stmt
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|setTimes (String src, long mtime, long atime)
specifier|public
name|void
name|setTimes
parameter_list|(
name|String
name|src
parameter_list|,
name|long
name|mtime
parameter_list|,
name|long
name|atime
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"setTimes"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|long
operator|.
name|class
operator|,
name|long
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
operator|,
name|mtime
operator|,
name|atime
block|)
function|;
end_function

begin_expr_stmt
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|createSymlink (String target, String link, FsPermission dirPerms, boolean createParent)
specifier|public
name|void
name|createSymlink
parameter_list|(
name|String
name|target
parameter_list|,
name|String
name|link
parameter_list|,
name|FsPermission
name|dirPerms
parameter_list|,
name|boolean
name|createParent
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
comment|// TODO Verify that the link location is in the same NS as the targets
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|targetLocations
init|=
name|getLocationsForPath
argument_list|(
name|target
argument_list|,
literal|true
argument_list|)
decl_stmt|;
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|linkLocations
init|=
name|getLocationsForPath
argument_list|(
name|link
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|RemoteLocation
name|linkLocation
init|=
name|linkLocations
operator|.
name|get
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"createSymlink"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|String
operator|.
name|class
operator|,
name|FsPermission
operator|.
name|class
operator|,
name|boolean
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
operator|,
name|linkLocation
operator|.
name|getDest
argument_list|()
operator|,
name|dirPerms
operator|,
name|createParent
block|)
function|;
end_function

begin_expr_stmt
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|targetLocations
argument_list|,
name|method
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|getLinkTarget (String path)
specifier|public
name|String
name|getLinkTarget
parameter_list|(
name|String
name|path
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|)
expr_stmt|;
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|path
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"getLinkTarget"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
block|)
function|;
end_function

begin_return
return|return
operator|(
name|String
operator|)
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|,
name|String
operator|.
name|class
argument_list|,
literal|null
argument_list|)
return|;
end_return

begin_function
unit|}    @
name|Override
comment|// Client Protocol
DECL|method|allowSnapshot (String snapshotRoot)
specifier|public
name|void
name|allowSnapshot
parameter_list|(
name|String
name|snapshotRoot
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
annotation|@
name|Override
comment|// Client Protocol
DECL|method|disallowSnapshot (String snapshot)
specifier|public
name|void
name|disallowSnapshot
parameter_list|(
name|String
name|snapshot
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
annotation|@
name|Override
comment|// ClientProtocol
DECL|method|renameSnapshot (String snapshotRoot, String snapshotOldName, String snapshotNewName)
specifier|public
name|void
name|renameSnapshot
parameter_list|(
name|String
name|snapshotRoot
parameter_list|,
name|String
name|snapshotOldName
parameter_list|,
name|String
name|snapshotNewName
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
annotation|@
name|Override
comment|// Client Protocol
DECL|method|getSnapshottableDirListing ()
specifier|public
name|SnapshottableDirectoryStatus
index|[]
name|getSnapshottableDirListing
parameter_list|()
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|,
literal|false
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
end_function

begin_function
annotation|@
name|Override
comment|// ClientProtocol
DECL|method|getSnapshotDiffReport (String snapshotRoot, String earlierSnapshotName, String laterSnapshotName)
specifier|public
name|SnapshotDiffReport
name|getSnapshotDiffReport
parameter_list|(
name|String
name|snapshotRoot
parameter_list|,
name|String
name|earlierSnapshotName
parameter_list|,
name|String
name|laterSnapshotName
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|,
literal|false
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
end_function

begin_function
annotation|@
name|Override
comment|// ClientProtocol
DECL|method|getSnapshotDiffReportListing ( String snapshotRoot, String earlierSnapshotName, String laterSnapshotName, byte[] startPath, int index)
specifier|public
name|SnapshotDiffReportListing
name|getSnapshotDiffReportListing
parameter_list|(
name|String
name|snapshotRoot
parameter_list|,
name|String
name|earlierSnapshotName
parameter_list|,
name|String
name|laterSnapshotName
parameter_list|,
name|byte
index|[]
name|startPath
parameter_list|,
name|int
name|index
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|,
literal|false
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
end_function

begin_function
annotation|@
name|Override
comment|// ClientProtocol
DECL|method|addCacheDirective (CacheDirectiveInfo path, EnumSet<CacheFlag> flags)
specifier|public
name|long
name|addCacheDirective
parameter_list|(
name|CacheDirectiveInfo
name|path
parameter_list|,
name|EnumSet
argument_list|<
name|CacheFlag
argument_list|>
name|flags
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|,
literal|false
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
annotation|@
name|Override
comment|// ClientProtocol
DECL|method|modifyCacheDirective (CacheDirectiveInfo directive, EnumSet<CacheFlag> flags)
specifier|public
name|void
name|modifyCacheDirective
parameter_list|(
name|CacheDirectiveInfo
name|directive
parameter_list|,
name|EnumSet
argument_list|<
name|CacheFlag
argument_list|>
name|flags
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
annotation|@
name|Override
comment|// ClientProtocol
DECL|method|removeCacheDirective (long id)
specifier|public
name|void
name|removeCacheDirective
parameter_list|(
name|long
name|id
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
annotation|@
name|Override
comment|// ClientProtocol
DECL|method|listCacheDirectives ( long prevId, CacheDirectiveInfo filter)
specifier|public
name|BatchedEntries
argument_list|<
name|CacheDirectiveEntry
argument_list|>
name|listCacheDirectives
parameter_list|(
name|long
name|prevId
parameter_list|,
name|CacheDirectiveInfo
name|filter
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|,
literal|false
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
end_function

begin_function
annotation|@
name|Override
comment|// ClientProtocol
DECL|method|addCachePool (CachePoolInfo info)
specifier|public
name|void
name|addCachePool
parameter_list|(
name|CachePoolInfo
name|info
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
annotation|@
name|Override
comment|// ClientProtocol
DECL|method|modifyCachePool (CachePoolInfo info)
specifier|public
name|void
name|modifyCachePool
parameter_list|(
name|CachePoolInfo
name|info
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
annotation|@
name|Override
comment|// ClientProtocol
DECL|method|removeCachePool (String cachePoolName)
specifier|public
name|void
name|removeCachePool
parameter_list|(
name|String
name|cachePoolName
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
annotation|@
name|Override
comment|// ClientProtocol
DECL|method|listCachePools (String prevKey)
specifier|public
name|BatchedEntries
argument_list|<
name|CachePoolEntry
argument_list|>
name|listCachePools
parameter_list|(
name|String
name|prevKey
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|,
literal|false
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
end_function

begin_function
annotation|@
name|Override
comment|// ClientProtocol
DECL|method|modifyAclEntries (String src, List<AclEntry> aclSpec)
specifier|public
name|void
name|modifyAclEntries
parameter_list|(
name|String
name|src
parameter_list|,
name|List
argument_list|<
name|AclEntry
argument_list|>
name|aclSpec
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
comment|// TODO handle virtual directories
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"modifyAclEntries"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|List
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
operator|,
name|aclSpec
block|)
function|;
end_function

begin_expr_stmt
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
unit|}    @
name|Override
comment|// ClienProtocol
DECL|method|removeAclEntries (String src, List<AclEntry> aclSpec)
specifier|public
name|void
name|removeAclEntries
parameter_list|(
name|String
name|src
parameter_list|,
name|List
argument_list|<
name|AclEntry
argument_list|>
name|aclSpec
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
comment|// TODO handle virtual directories
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"removeAclEntries"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|List
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
operator|,
name|aclSpec
block|)
function|;
end_function

begin_expr_stmt
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|removeDefaultAcl (String src)
specifier|public
name|void
name|removeDefaultAcl
parameter_list|(
name|String
name|src
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
comment|// TODO handle virtual directories
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"removeDefaultAcl"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
block|)
function|;
end_function

begin_expr_stmt
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|removeAcl (String src)
specifier|public
name|void
name|removeAcl
parameter_list|(
name|String
name|src
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
comment|// TODO handle virtual directories
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"removeAcl"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
block|)
function|;
end_function

begin_expr_stmt
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|setAcl (String src, List<AclEntry> aclSpec)
specifier|public
name|void
name|setAcl
parameter_list|(
name|String
name|src
parameter_list|,
name|List
argument_list|<
name|AclEntry
argument_list|>
name|aclSpec
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
comment|// TODO handle virtual directories
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"setAcl"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|List
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
operator|,
name|aclSpec
block|)
function|;
end_function

begin_expr_stmt
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|getAclStatus (String src)
specifier|public
name|AclStatus
name|getAclStatus
parameter_list|(
name|String
name|src
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|)
expr_stmt|;
comment|// TODO handle virtual directories
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|false
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"getAclStatus"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
block|)
function|;
end_function

begin_return
return|return
operator|(
name|AclStatus
operator|)
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|,
name|AclStatus
operator|.
name|class
argument_list|,
literal|null
argument_list|)
return|;
end_return

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|createEncryptionZone (String src, String keyName)
specifier|public
name|void
name|createEncryptionZone
parameter_list|(
name|String
name|src
parameter_list|,
name|String
name|keyName
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
comment|// TODO handle virtual directories
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"createEncryptionZone"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|String
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
operator|,
name|keyName
block|)
function|;
end_function

begin_expr_stmt
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|getEZForPath (String src)
specifier|public
name|EncryptionZone
name|getEZForPath
parameter_list|(
name|String
name|src
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|)
expr_stmt|;
comment|// TODO handle virtual directories
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|false
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"getEZForPath"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
block|)
function|;
end_function

begin_return
return|return
operator|(
name|EncryptionZone
operator|)
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|,
name|EncryptionZone
operator|.
name|class
argument_list|,
literal|null
argument_list|)
return|;
end_return

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|listEncryptionZones (long prevId)
specifier|public
name|BatchedEntries
argument_list|<
name|EncryptionZone
argument_list|>
name|listEncryptionZones
parameter_list|(
name|long
name|prevId
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|,
literal|false
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
end_function

begin_function
annotation|@
name|Override
comment|// ClientProtocol
DECL|method|reencryptEncryptionZone (String zone, ReencryptAction action)
specifier|public
name|void
name|reencryptEncryptionZone
parameter_list|(
name|String
name|zone
parameter_list|,
name|ReencryptAction
name|action
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
annotation|@
name|Override
comment|// ClientProtocol
DECL|method|listReencryptionStatus ( long prevId)
specifier|public
name|BatchedEntries
argument_list|<
name|ZoneReencryptionStatus
argument_list|>
name|listReencryptionStatus
parameter_list|(
name|long
name|prevId
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|,
literal|false
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
end_function

begin_function
annotation|@
name|Override
comment|// ClientProtocol
DECL|method|setXAttr (String src, XAttr xAttr, EnumSet<XAttrSetFlag> flag)
specifier|public
name|void
name|setXAttr
parameter_list|(
name|String
name|src
parameter_list|,
name|XAttr
name|xAttr
parameter_list|,
name|EnumSet
argument_list|<
name|XAttrSetFlag
argument_list|>
name|flag
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
comment|// TODO handle virtual directories
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"setXAttr"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|XAttr
operator|.
name|class
operator|,
name|EnumSet
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
operator|,
name|xAttr
operator|,
name|flag
block|)
function|;
end_function

begin_expr_stmt
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
unit|}    @
name|SuppressWarnings
argument_list|(
literal|"unchecked"
argument_list|)
expr|@
name|Override
comment|// ClientProtocol
DECL|method|getXAttrs (String src, List<XAttr> xAttrs)
specifier|public
name|List
argument_list|<
name|XAttr
argument_list|>
name|getXAttrs
argument_list|(
name|String
name|src
argument_list|,
name|List
argument_list|<
name|XAttr
argument_list|>
name|xAttrs
argument_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|// TODO handle virtual directories
end_comment

begin_decl_stmt
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|false
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"getXAttrs"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|List
operator|.
name|class
block|}
end_decl_stmt

begin_operator
operator|,
end_operator

begin_expr_stmt
operator|new
name|RemoteParam
argument_list|()
operator|,
name|xAttrs
end_expr_stmt

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_return
return|return
operator|(
name|List
argument_list|<
name|XAttr
argument_list|>
operator|)
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|,
name|List
operator|.
name|class
argument_list|,
literal|null
argument_list|)
return|;
end_return

begin_expr_stmt
unit|}    @
name|SuppressWarnings
argument_list|(
literal|"unchecked"
argument_list|)
expr|@
name|Override
comment|// ClientProtocol
DECL|method|listXAttrs (String src)
specifier|public
name|List
argument_list|<
name|XAttr
argument_list|>
name|listXAttrs
argument_list|(
name|String
name|src
argument_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|// TODO handle virtual directories
end_comment

begin_decl_stmt
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|false
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"listXAttrs"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
block|}
end_decl_stmt

begin_operator
operator|,
end_operator

begin_expr_stmt
operator|new
name|RemoteParam
argument_list|()
end_expr_stmt

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_return
return|return
operator|(
name|List
argument_list|<
name|XAttr
argument_list|>
operator|)
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|,
name|List
operator|.
name|class
argument_list|,
literal|null
argument_list|)
return|;
end_return

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|removeXAttr (String src, XAttr xAttr)
specifier|public
name|void
name|removeXAttr
parameter_list|(
name|String
name|src
parameter_list|,
name|XAttr
name|xAttr
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
comment|// TODO handle virtual directories
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|src
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"removeXAttr"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|XAttr
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
operator|,
name|xAttr
block|)
function|;
end_function

begin_expr_stmt
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|checkAccess (String path, FsAction mode)
specifier|public
name|void
name|checkAccess
parameter_list|(
name|String
name|path
parameter_list|,
name|FsAction
name|mode
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|)
expr_stmt|;
comment|// TODO handle virtual directories
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|path
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"checkAccess"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|FsAction
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
operator|,
name|mode
block|)
function|;
end_function

begin_expr_stmt
name|rpcClient
operator|.
name|invokeSequential
argument_list|(
name|locations
argument_list|,
name|method
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|getCurrentEditLogTxid ()
specifier|public
name|long
name|getCurrentEditLogTxid
parameter_list|()
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|)
expr_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"getCurrentEditLogTxid"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{}
block|)
function|;
end_function

begin_decl_stmt
specifier|final
name|Set
argument_list|<
name|FederationNamespaceInfo
argument_list|>
name|nss
init|=
name|namenodeResolver
operator|.
name|getNamespaces
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Map
argument_list|<
name|FederationNamespaceInfo
argument_list|,
name|Object
argument_list|>
name|ret
init|=
name|rpcClient
operator|.
name|invokeConcurrent
argument_list|(
name|nss
argument_list|,
name|method
argument_list|,
literal|true
argument_list|,
literal|false
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|// Return the maximum txid
end_comment

begin_decl_stmt
name|long
name|txid
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Object
name|obj
init|=
name|ret
decl_stmt|;
end_decl_stmt

begin_decl_stmt
annotation|@
name|SuppressWarnings
argument_list|(
literal|"unchecked"
argument_list|)
name|Map
argument_list|<
name|FederationNamespaceInfo
argument_list|,
name|Long
argument_list|>
name|results
init|=
operator|(
name|Map
argument_list|<
name|FederationNamespaceInfo
argument_list|,
name|Long
argument_list|>
operator|)
name|obj
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Collection
argument_list|<
name|Long
argument_list|>
name|txids
init|=
name|results
operator|.
name|values
argument_list|()
decl_stmt|;
end_decl_stmt

begin_for
for|for
control|(
name|long
name|t
range|:
name|txids
control|)
block|{
if|if
condition|(
name|t
operator|>
name|txid
condition|)
block|{
name|txid
operator|=
name|t
expr_stmt|;
block|}
block|}
end_for

begin_return
return|return
name|txid
return|;
end_return

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|getEditsFromTxid (long txid)
specifier|public
name|EventBatchList
name|getEditsFromTxid
parameter_list|(
name|long
name|txid
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|,
literal|false
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
end_function

begin_function
annotation|@
name|Override
DECL|method|getDataEncryptionKey ()
specifier|public
name|DataEncryptionKey
name|getDataEncryptionKey
parameter_list|()
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|,
literal|false
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
end_function

begin_function
annotation|@
name|Override
DECL|method|createSnapshot (String snapshotRoot, String snapshotName)
specifier|public
name|String
name|createSnapshot
parameter_list|(
name|String
name|snapshotRoot
parameter_list|,
name|String
name|snapshotName
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
end_function

begin_function
annotation|@
name|Override
DECL|method|deleteSnapshot (String snapshotRoot, String snapshotName)
specifier|public
name|void
name|deleteSnapshot
parameter_list|(
name|String
name|snapshotRoot
parameter_list|,
name|String
name|snapshotName
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
annotation|@
name|Override
DECL|method|getErasureCodingPolicies ()
specifier|public
name|ErasureCodingPolicyInfo
index|[]
name|getErasureCodingPolicies
parameter_list|()
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|,
literal|false
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
end_function

begin_function
annotation|@
name|Override
comment|// ClientProtocol
DECL|method|getErasureCodingPolicy (String src)
specifier|public
name|ErasureCodingPolicy
name|getErasureCodingPolicy
parameter_list|(
name|String
name|src
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|,
literal|false
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
end_function

begin_function
annotation|@
name|Override
comment|// ClientProtocol
DECL|method|setErasureCodingPolicy (String src, String ecPolicyName)
specifier|public
name|void
name|setErasureCodingPolicy
parameter_list|(
name|String
name|src
parameter_list|,
name|String
name|ecPolicyName
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
annotation|@
name|Override
comment|// ClientProtocol
DECL|method|unsetErasureCodingPolicy (String src)
specifier|public
name|void
name|unsetErasureCodingPolicy
parameter_list|(
name|String
name|src
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
annotation|@
name|Override
comment|// ClientProtocol
DECL|method|setQuota (String path, long namespaceQuota, long storagespaceQuota, StorageType type)
specifier|public
name|void
name|setQuota
parameter_list|(
name|String
name|path
parameter_list|,
name|long
name|namespaceQuota
parameter_list|,
name|long
name|storagespaceQuota
parameter_list|,
name|StorageType
name|type
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
comment|// TODO assign global replicas instead of applying them to each folder
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|path
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"setQuota"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|String
operator|.
name|class
operator|,
name|Long
operator|.
name|class
operator|,
name|Long
operator|.
name|class
operator|,
name|StorageType
operator|.
name|class
block|}
operator|,
operator|new
name|RemoteParam
argument_list|()
operator|,
name|namespaceQuota
operator|,
name|storagespaceQuota
operator|,
name|type
block|)
function|;
end_function

begin_expr_stmt
name|rpcClient
operator|.
name|invokeConcurrent
argument_list|(
name|locations
argument_list|,
name|method
argument_list|,
literal|false
argument_list|,
literal|false
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
unit|}    @
name|Override
comment|// ClientProtocol
DECL|method|getQuotaUsage (String path)
specifier|public
name|QuotaUsage
name|getQuotaUsage
parameter_list|(
name|String
name|path
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|,
literal|false
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
end_function

begin_function
annotation|@
name|Override
DECL|method|reportBadBlocks (LocatedBlock[] blocks)
specifier|public
name|void
name|reportBadBlocks
parameter_list|(
name|LocatedBlock
index|[]
name|blocks
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|)
expr_stmt|;
comment|// Block pool id -> blocks
name|Map
argument_list|<
name|String
argument_list|,
name|List
argument_list|<
name|LocatedBlock
argument_list|>
argument_list|>
name|blockLocations
init|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
decl_stmt|;
for|for
control|(
name|LocatedBlock
name|block
range|:
name|blocks
control|)
block|{
name|String
name|bpId
init|=
name|block
operator|.
name|getBlock
argument_list|()
operator|.
name|getBlockPoolId
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|LocatedBlock
argument_list|>
name|bpBlocks
init|=
name|blockLocations
operator|.
name|get
argument_list|(
name|bpId
argument_list|)
decl_stmt|;
if|if
condition|(
name|bpBlocks
operator|==
literal|null
condition|)
block|{
name|bpBlocks
operator|=
operator|new
name|LinkedList
argument_list|<>
argument_list|()
expr_stmt|;
name|blockLocations
operator|.
name|put
argument_list|(
name|bpId
argument_list|,
name|bpBlocks
argument_list|)
expr_stmt|;
block|}
name|bpBlocks
operator|.
name|add
argument_list|(
name|block
argument_list|)
expr_stmt|;
block|}
comment|// Invoke each block pool
for|for
control|(
name|Entry
argument_list|<
name|String
argument_list|,
name|List
argument_list|<
name|LocatedBlock
argument_list|>
argument_list|>
name|entry
range|:
name|blockLocations
operator|.
name|entrySet
argument_list|()
control|)
block|{
name|String
name|bpId
init|=
name|entry
operator|.
name|getKey
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|LocatedBlock
argument_list|>
name|bpBlocks
init|=
name|entry
operator|.
name|getValue
argument_list|()
decl_stmt|;
name|LocatedBlock
index|[]
name|bpBlocksArray
init|=
name|bpBlocks
operator|.
name|toArray
argument_list|(
operator|new
name|LocatedBlock
index|[
name|bpBlocks
operator|.
name|size
argument_list|()
index|]
argument_list|)
decl_stmt|;
name|RemoteMethod
name|method
init|=
operator|new
name|RemoteMethod
argument_list|(
literal|"reportBadBlocks"
argument_list|,
operator|new
name|Class
argument_list|<
name|?
argument_list|>
index|[]
block|{
name|LocatedBlock
index|[]
operator|.
expr|class
block|}
operator|,
operator|new
name|Object
index|[]
block|{
name|bpBlocksArray
block|}
block|)
empty_stmt|;
name|rpcClient
operator|.
name|invokeSingleBlockPool
argument_list|(
name|bpId
argument_list|,
name|method
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
unit|}    @
name|Override
DECL|method|unsetStoragePolicy (String src)
specifier|public
name|void
name|unsetStoragePolicy
parameter_list|(
name|String
name|src
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
annotation|@
name|Override
DECL|method|getStoragePolicy (String path)
specifier|public
name|BlockStoragePolicy
name|getStoragePolicy
parameter_list|(
name|String
name|path
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|,
literal|false
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
end_function

begin_function
annotation|@
name|Override
DECL|method|addErasureCodingPolicies ( ErasureCodingPolicy[] policies)
specifier|public
name|AddErasureCodingPolicyResponse
index|[]
name|addErasureCodingPolicies
parameter_list|(
name|ErasureCodingPolicy
index|[]
name|policies
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|,
literal|false
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
end_function

begin_function
annotation|@
name|Override
DECL|method|removeErasureCodingPolicy (String arg0)
specifier|public
name|void
name|removeErasureCodingPolicy
parameter_list|(
name|String
name|arg0
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
annotation|@
name|Override
DECL|method|disableErasureCodingPolicy (String arg0)
specifier|public
name|void
name|disableErasureCodingPolicy
parameter_list|(
name|String
name|arg0
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
annotation|@
name|Override
DECL|method|enableErasureCodingPolicy (String arg0)
specifier|public
name|void
name|enableErasureCodingPolicy
parameter_list|(
name|String
name|arg0
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|WRITE
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
annotation|@
name|Override
DECL|method|getECBlockGroupStats ()
specifier|public
name|ECBlockGroupStats
name|getECBlockGroupStats
parameter_list|()
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|,
literal|false
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
end_function

begin_function
annotation|@
name|Override
DECL|method|getErasureCodingCodecs ()
specifier|public
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|getErasureCodingCodecs
parameter_list|()
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|,
literal|false
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
end_function

begin_function
annotation|@
name|Override
DECL|method|getReplicatedBlockStats ()
specifier|public
name|ReplicatedBlockStats
name|getReplicatedBlockStats
parameter_list|()
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|,
literal|false
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
end_function

begin_function
annotation|@
name|Override
DECL|method|listOpenFiles (long arg0)
specifier|public
name|BatchedEntries
argument_list|<
name|OpenFileEntry
argument_list|>
name|listOpenFiles
parameter_list|(
name|long
name|arg0
parameter_list|)
throws|throws
name|IOException
block|{
name|checkOperation
argument_list|(
name|OperationCategory
operator|.
name|READ
argument_list|,
literal|false
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
end_function

begin_comment
comment|/**    * Locate the location with the matching block pool id.    *    * @param path Path to check.    * @param failIfLocked Fail the request if locked (top mount point).    * @param blockPoolId The block pool ID of the namespace to search for.    * @return Prioritized list of locations in the federated cluster.    * @throws IOException if the location for this path cannot be determined.    */
end_comment

begin_function
DECL|method|getLocationForPath ( String path, boolean failIfLocked, String blockPoolId)
specifier|private
name|RemoteLocation
name|getLocationForPath
parameter_list|(
name|String
name|path
parameter_list|,
name|boolean
name|failIfLocked
parameter_list|,
name|String
name|blockPoolId
parameter_list|)
throws|throws
name|IOException
block|{
specifier|final
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|locations
init|=
name|getLocationsForPath
argument_list|(
name|path
argument_list|,
name|failIfLocked
argument_list|)
decl_stmt|;
name|String
name|nameserviceId
init|=
literal|null
decl_stmt|;
name|Set
argument_list|<
name|FederationNamespaceInfo
argument_list|>
name|namespaces
init|=
name|this
operator|.
name|namenodeResolver
operator|.
name|getNamespaces
argument_list|()
decl_stmt|;
for|for
control|(
name|FederationNamespaceInfo
name|namespace
range|:
name|namespaces
control|)
block|{
if|if
condition|(
name|namespace
operator|.
name|getBlockPoolId
argument_list|()
operator|.
name|equals
argument_list|(
name|blockPoolId
argument_list|)
condition|)
block|{
name|nameserviceId
operator|=
name|namespace
operator|.
name|getNameserviceId
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|nameserviceId
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|RemoteLocation
name|location
range|:
name|locations
control|)
block|{
if|if
condition|(
name|location
operator|.
name|getNameserviceId
argument_list|()
operator|.
name|equals
argument_list|(
name|nameserviceId
argument_list|)
condition|)
block|{
return|return
name|location
return|;
block|}
block|}
block|}
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Cannot locate a nameservice for block pool "
operator|+
name|blockPoolId
argument_list|)
throw|;
block|}
end_function

begin_comment
comment|/**    * Get the possible locations of a path in the federated cluster.    *    * @param path Path to check.    * @param failIfLocked Fail the request if locked (top mount point).    * @return Prioritized list of locations in the federated cluster.    * @throws IOException If the location for this path cannot be determined.    */
end_comment

begin_function
DECL|method|getLocationsForPath ( String path, boolean failIfLocked)
specifier|private
name|List
argument_list|<
name|RemoteLocation
argument_list|>
name|getLocationsForPath
parameter_list|(
name|String
name|path
parameter_list|,
name|boolean
name|failIfLocked
parameter_list|)
throws|throws
name|IOException
block|{
try|try
block|{
comment|// Check the location for this path
specifier|final
name|PathLocation
name|location
init|=
name|this
operator|.
name|subclusterResolver
operator|.
name|getDestinationForPath
argument_list|(
name|path
argument_list|)
decl_stmt|;
if|if
condition|(
name|location
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Cannot find locations for "
operator|+
name|path
operator|+
literal|" in "
operator|+
name|this
operator|.
name|subclusterResolver
argument_list|)
throw|;
block|}
return|return
name|location
operator|.
name|getDestinations
argument_list|()
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ioe
parameter_list|)
block|{
if|if
condition|(
name|this
operator|.
name|rpcMonitor
operator|!=
literal|null
condition|)
block|{
name|this
operator|.
name|rpcMonitor
operator|.
name|routerFailureStateStore
argument_list|()
expr_stmt|;
block|}
throw|throw
name|ioe
throw|;
block|}
block|}
end_function

begin_comment
comment|/**    * Get the modification dates for mount points.    *    * @param path Name of the path to start checking dates from.    * @return Map with the modification dates for all sub-entries.    */
end_comment

begin_function
DECL|method|getMountPointDates (String path)
specifier|private
name|Map
argument_list|<
name|String
argument_list|,
name|Long
argument_list|>
name|getMountPointDates
parameter_list|(
name|String
name|path
parameter_list|)
block|{
name|Map
argument_list|<
name|String
argument_list|,
name|Long
argument_list|>
name|ret
init|=
operator|new
name|TreeMap
argument_list|<>
argument_list|()
decl_stmt|;
comment|// TODO add when we have a Mount Table
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**    * Create a new file status for a mount point.    *    * @param name Name of the mount point.    * @param childrenNum Number of children.    * @param date Map with the dates.    * @return New HDFS file status representing a mount point.    */
end_comment

begin_function
DECL|method|getMountPointStatus ( String name, int childrenNum, long date)
specifier|private
name|HdfsFileStatus
name|getMountPointStatus
parameter_list|(
name|String
name|name
parameter_list|,
name|int
name|childrenNum
parameter_list|,
name|long
name|date
parameter_list|)
block|{
name|long
name|modTime
init|=
name|date
decl_stmt|;
name|long
name|accessTime
init|=
name|date
decl_stmt|;
name|FsPermission
name|permission
init|=
name|FsPermission
operator|.
name|getDirDefault
argument_list|()
decl_stmt|;
name|String
name|owner
init|=
name|this
operator|.
name|superUser
decl_stmt|;
name|String
name|group
init|=
name|this
operator|.
name|superGroup
decl_stmt|;
try|try
block|{
comment|// TODO support users, it should be the user for the pointed folder
name|UserGroupInformation
name|ugi
init|=
name|getRemoteUser
argument_list|()
decl_stmt|;
name|owner
operator|=
name|ugi
operator|.
name|getUserName
argument_list|()
expr_stmt|;
name|group
operator|=
name|ugi
operator|.
name|getPrimaryGroupName
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Cannot get the remote user: {}"
argument_list|,
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|long
name|inodeId
init|=
literal|0
decl_stmt|;
return|return
operator|new
name|HdfsFileStatus
operator|.
name|Builder
argument_list|()
operator|.
name|isdir
argument_list|(
literal|true
argument_list|)
operator|.
name|mtime
argument_list|(
name|modTime
argument_list|)
operator|.
name|atime
argument_list|(
name|accessTime
argument_list|)
operator|.
name|perm
argument_list|(
name|permission
argument_list|)
operator|.
name|owner
argument_list|(
name|owner
argument_list|)
operator|.
name|group
argument_list|(
name|group
argument_list|)
operator|.
name|symlink
argument_list|(
operator|new
name|byte
index|[
literal|0
index|]
argument_list|)
operator|.
name|path
argument_list|(
name|DFSUtil
operator|.
name|string2Bytes
argument_list|(
name|name
argument_list|)
argument_list|)
operator|.
name|fileId
argument_list|(
name|inodeId
argument_list|)
operator|.
name|children
argument_list|(
name|childrenNum
argument_list|)
operator|.
name|build
argument_list|()
return|;
block|}
end_function

begin_comment
comment|/**    * Get the name of the method that is calling this function.    *    * @return Name of the method calling this function.    */
end_comment

begin_function
DECL|method|getMethodName ()
specifier|private
specifier|static
name|String
name|getMethodName
parameter_list|()
block|{
specifier|final
name|StackTraceElement
index|[]
name|stack
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getStackTrace
argument_list|()
decl_stmt|;
name|String
name|methodName
init|=
name|stack
index|[
literal|3
index|]
operator|.
name|getMethodName
argument_list|()
decl_stmt|;
return|return
name|methodName
return|;
block|}
end_function

begin_comment
comment|/**    * Get the user that is invoking this operation.    *    * @return Remote user group information.    * @throws IOException If we cannot get the user information.    */
end_comment

begin_function
DECL|method|getRemoteUser ()
specifier|static
name|UserGroupInformation
name|getRemoteUser
parameter_list|()
throws|throws
name|IOException
block|{
name|UserGroupInformation
name|ugi
init|=
name|Server
operator|.
name|getRemoteUser
argument_list|()
decl_stmt|;
return|return
operator|(
name|ugi
operator|!=
literal|null
operator|)
condition|?
name|ugi
else|:
name|UserGroupInformation
operator|.
name|getCurrentUser
argument_list|()
return|;
block|}
end_function

unit|}
end_unit

