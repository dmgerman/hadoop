begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/**  * Licensed to the Apache Software Foundation (ASF) under one  * or more contributor license agreements.  See the NOTICE file  * distributed with this work for additional information  * regarding copyright ownership.  The ASF licenses this file  * to you under the Apache License, Version 2.0 (the  * "License"); you may not use this file except in compliance  * with the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
DECL|package|org.apache.hadoop.hdfs.server.namenode
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|server
operator|.
name|namenode
package|;
end_package

begin_import
import|import static
name|org
operator|.
name|junit
operator|.
name|Assert
operator|.
name|*
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|BufferedReader
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|File
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|FileReader
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collection
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collections
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Enumeration
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|regex
operator|.
name|Pattern
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|impl
operator|.
name|Log4JLogger
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|conf
operator|.
name|Configuration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|FileStatus
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|FileSystem
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|Path
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|permission
operator|.
name|FsPermission
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|DFSConfigKeys
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|DFSTestUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|HdfsConfiguration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|MiniDFSCluster
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|web
operator|.
name|WebHdfsConstants
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|web
operator|.
name|WebHdfsTestUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|web
operator|.
name|WebHdfsFileSystem
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|AccessControlException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|UserGroupInformation
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|test
operator|.
name|PathUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|log4j
operator|.
name|Appender
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|log4j
operator|.
name|AsyncAppender
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|log4j
operator|.
name|Level
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|log4j
operator|.
name|LogManager
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|log4j
operator|.
name|Logger
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|log4j
operator|.
name|PatternLayout
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|log4j
operator|.
name|RollingFileAppender
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|After
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Before
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Test
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|runner
operator|.
name|RunWith
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|runners
operator|.
name|Parameterized
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|runners
operator|.
name|Parameterized
operator|.
name|Parameters
import|;
end_import

begin_comment
comment|/**  * A JUnit test that audit logs are generated  */
end_comment

begin_class
annotation|@
name|RunWith
argument_list|(
name|Parameterized
operator|.
name|class
argument_list|)
DECL|class|TestAuditLogs
specifier|public
class|class
name|TestAuditLogs
block|{
DECL|field|auditLogFile
specifier|static
specifier|final
name|String
name|auditLogFile
init|=
name|PathUtils
operator|.
name|getTestDirName
argument_list|(
name|TestAuditLogs
operator|.
name|class
argument_list|)
operator|+
literal|"/TestAuditLogs-audit.log"
decl_stmt|;
DECL|field|useAsyncLog
specifier|final
name|boolean
name|useAsyncLog
decl_stmt|;
DECL|field|useAsyncEdits
specifier|final
name|boolean
name|useAsyncEdits
decl_stmt|;
annotation|@
name|Parameters
DECL|method|data ()
specifier|public
specifier|static
name|Collection
argument_list|<
name|Object
index|[]
argument_list|>
name|data
parameter_list|()
block|{
name|Collection
argument_list|<
name|Object
index|[]
argument_list|>
name|params
init|=
operator|new
name|ArrayList
argument_list|<
name|Object
index|[]
argument_list|>
argument_list|()
decl_stmt|;
name|params
operator|.
name|add
argument_list|(
operator|new
name|Object
index|[]
block|{
name|Boolean
operator|.
name|FALSE
block|,
name|Boolean
operator|.
name|FALSE
block|}
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
operator|new
name|Object
index|[]
block|{
name|Boolean
operator|.
name|TRUE
block|,
name|Boolean
operator|.
name|FALSE
block|}
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
operator|new
name|Object
index|[]
block|{
name|Boolean
operator|.
name|FALSE
block|,
name|Boolean
operator|.
name|TRUE
block|}
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
operator|new
name|Object
index|[]
block|{
name|Boolean
operator|.
name|TRUE
block|,
name|Boolean
operator|.
name|TRUE
block|}
argument_list|)
expr_stmt|;
return|return
name|params
return|;
block|}
DECL|method|TestAuditLogs (boolean useAsyncLog, boolean useAsyncEdits)
specifier|public
name|TestAuditLogs
parameter_list|(
name|boolean
name|useAsyncLog
parameter_list|,
name|boolean
name|useAsyncEdits
parameter_list|)
block|{
name|this
operator|.
name|useAsyncLog
operator|=
name|useAsyncLog
expr_stmt|;
name|this
operator|.
name|useAsyncEdits
operator|=
name|useAsyncEdits
expr_stmt|;
block|}
comment|// Pattern for:
comment|// allowed=(true|false) ugi=name ip=/address cmd={cmd} src={path} dst=null perm=null
DECL|field|auditPattern
specifier|static
specifier|final
name|Pattern
name|auditPattern
init|=
name|Pattern
operator|.
name|compile
argument_list|(
literal|"allowed=.*?\\s"
operator|+
literal|"ugi=.*?\\s"
operator|+
literal|"ip=/\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\s"
operator|+
literal|"cmd=.*?\\ssrc=.*?\\sdst=null\\s"
operator|+
literal|"perm=.*?"
argument_list|)
decl_stmt|;
DECL|field|successPattern
specifier|static
specifier|final
name|Pattern
name|successPattern
init|=
name|Pattern
operator|.
name|compile
argument_list|(
literal|".*allowed=true.*"
argument_list|)
decl_stmt|;
DECL|field|webOpenPattern
specifier|static
specifier|final
name|Pattern
name|webOpenPattern
init|=
name|Pattern
operator|.
name|compile
argument_list|(
literal|".*cmd=open.*proto=webhdfs.*"
argument_list|)
decl_stmt|;
DECL|field|username
specifier|static
specifier|final
name|String
name|username
init|=
literal|"bob"
decl_stmt|;
DECL|field|groups
specifier|static
specifier|final
name|String
index|[]
name|groups
init|=
block|{
literal|"group1"
block|}
decl_stmt|;
DECL|field|fileName
specifier|static
specifier|final
name|String
name|fileName
init|=
literal|"/srcdat"
decl_stmt|;
DECL|field|util
name|DFSTestUtil
name|util
decl_stmt|;
DECL|field|cluster
name|MiniDFSCluster
name|cluster
decl_stmt|;
DECL|field|fs
name|FileSystem
name|fs
decl_stmt|;
DECL|field|fnames
name|String
name|fnames
index|[]
decl_stmt|;
DECL|field|conf
name|Configuration
name|conf
decl_stmt|;
DECL|field|userGroupInfo
name|UserGroupInformation
name|userGroupInfo
decl_stmt|;
annotation|@
name|Before
DECL|method|setupCluster ()
specifier|public
name|void
name|setupCluster
parameter_list|()
throws|throws
name|Exception
block|{
comment|// must configure prior to instantiating the namesystem because it
comment|// will reconfigure the logger if async is enabled
name|configureAuditLogs
argument_list|()
expr_stmt|;
name|conf
operator|=
operator|new
name|HdfsConfiguration
argument_list|()
expr_stmt|;
specifier|final
name|long
name|precision
init|=
literal|1L
decl_stmt|;
name|conf
operator|.
name|setLong
argument_list|(
name|DFSConfigKeys
operator|.
name|DFS_NAMENODE_ACCESSTIME_PRECISION_KEY
argument_list|,
name|precision
argument_list|)
expr_stmt|;
name|conf
operator|.
name|setLong
argument_list|(
name|DFSConfigKeys
operator|.
name|DFS_BLOCKREPORT_INTERVAL_MSEC_KEY
argument_list|,
literal|10000L
argument_list|)
expr_stmt|;
name|conf
operator|.
name|setBoolean
argument_list|(
name|DFSConfigKeys
operator|.
name|DFS_NAMENODE_AUDIT_LOG_ASYNC_KEY
argument_list|,
name|useAsyncLog
argument_list|)
expr_stmt|;
name|conf
operator|.
name|setBoolean
argument_list|(
name|DFSConfigKeys
operator|.
name|DFS_NAMENODE_EDITS_ASYNC_LOGGING
argument_list|,
name|useAsyncEdits
argument_list|)
expr_stmt|;
name|util
operator|=
operator|new
name|DFSTestUtil
operator|.
name|Builder
argument_list|()
operator|.
name|setName
argument_list|(
literal|"TestAuditAllowed"
argument_list|)
operator|.
name|setNumFiles
argument_list|(
literal|20
argument_list|)
operator|.
name|build
argument_list|()
expr_stmt|;
name|cluster
operator|=
operator|new
name|MiniDFSCluster
operator|.
name|Builder
argument_list|(
name|conf
argument_list|)
operator|.
name|numDataNodes
argument_list|(
literal|4
argument_list|)
operator|.
name|build
argument_list|()
expr_stmt|;
name|fs
operator|=
name|cluster
operator|.
name|getFileSystem
argument_list|()
expr_stmt|;
name|util
operator|.
name|createFiles
argument_list|(
name|fs
argument_list|,
name|fileName
argument_list|)
expr_stmt|;
comment|// make sure the appender is what it's supposed to be
name|Logger
name|logger
init|=
operator|(
operator|(
name|Log4JLogger
operator|)
name|FSNamesystem
operator|.
name|auditLog
operator|)
operator|.
name|getLogger
argument_list|()
decl_stmt|;
annotation|@
name|SuppressWarnings
argument_list|(
literal|"unchecked"
argument_list|)
name|List
argument_list|<
name|Appender
argument_list|>
name|appenders
init|=
name|Collections
operator|.
name|list
argument_list|(
name|logger
operator|.
name|getAllAppenders
argument_list|()
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|appenders
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|useAsyncLog
argument_list|,
name|appenders
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|instanceof
name|AsyncAppender
argument_list|)
expr_stmt|;
name|fnames
operator|=
name|util
operator|.
name|getFileNames
argument_list|(
name|fileName
argument_list|)
expr_stmt|;
name|util
operator|.
name|waitReplication
argument_list|(
name|fs
argument_list|,
name|fileName
argument_list|,
operator|(
name|short
operator|)
literal|3
argument_list|)
expr_stmt|;
name|userGroupInfo
operator|=
name|UserGroupInformation
operator|.
name|createUserForTesting
argument_list|(
name|username
argument_list|,
name|groups
argument_list|)
expr_stmt|;
block|}
annotation|@
name|After
DECL|method|teardownCluster ()
specifier|public
name|void
name|teardownCluster
parameter_list|()
throws|throws
name|Exception
block|{
name|util
operator|.
name|cleanup
argument_list|(
name|fs
argument_list|,
literal|"/srcdat"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fs
operator|!=
literal|null
condition|)
block|{
name|fs
operator|.
name|close
argument_list|()
expr_stmt|;
name|fs
operator|=
literal|null
expr_stmt|;
block|}
if|if
condition|(
name|cluster
operator|!=
literal|null
condition|)
block|{
name|cluster
operator|.
name|shutdown
argument_list|()
expr_stmt|;
name|cluster
operator|=
literal|null
expr_stmt|;
block|}
block|}
comment|/** test that allowed operation puts proper entry in audit log */
annotation|@
name|Test
DECL|method|testAuditAllowed ()
specifier|public
name|void
name|testAuditAllowed
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|Path
name|file
init|=
operator|new
name|Path
argument_list|(
name|fnames
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|FileSystem
name|userfs
init|=
name|DFSTestUtil
operator|.
name|getFileSystemAs
argument_list|(
name|userGroupInfo
argument_list|,
name|conf
argument_list|)
decl_stmt|;
name|setupAuditLogs
argument_list|()
expr_stmt|;
name|InputStream
name|istream
init|=
name|userfs
operator|.
name|open
argument_list|(
name|file
argument_list|)
decl_stmt|;
name|int
name|val
init|=
name|istream
operator|.
name|read
argument_list|()
decl_stmt|;
name|istream
operator|.
name|close
argument_list|()
expr_stmt|;
name|verifyAuditLogs
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"failed to read from file"
argument_list|,
name|val
operator|>=
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/** test that allowed stat puts proper entry in audit log */
annotation|@
name|Test
DECL|method|testAuditAllowedStat ()
specifier|public
name|void
name|testAuditAllowedStat
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|Path
name|file
init|=
operator|new
name|Path
argument_list|(
name|fnames
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|FileSystem
name|userfs
init|=
name|DFSTestUtil
operator|.
name|getFileSystemAs
argument_list|(
name|userGroupInfo
argument_list|,
name|conf
argument_list|)
decl_stmt|;
name|setupAuditLogs
argument_list|()
expr_stmt|;
name|FileStatus
name|st
init|=
name|userfs
operator|.
name|getFileStatus
argument_list|(
name|file
argument_list|)
decl_stmt|;
name|verifyAuditLogs
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"failed to stat file"
argument_list|,
name|st
operator|!=
literal|null
operator|&&
name|st
operator|.
name|isFile
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|/** test that denied operation puts proper entry in audit log */
annotation|@
name|Test
DECL|method|testAuditDenied ()
specifier|public
name|void
name|testAuditDenied
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|Path
name|file
init|=
operator|new
name|Path
argument_list|(
name|fnames
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|FileSystem
name|userfs
init|=
name|DFSTestUtil
operator|.
name|getFileSystemAs
argument_list|(
name|userGroupInfo
argument_list|,
name|conf
argument_list|)
decl_stmt|;
name|fs
operator|.
name|setPermission
argument_list|(
name|file
argument_list|,
operator|new
name|FsPermission
argument_list|(
operator|(
name|short
operator|)
literal|0600
argument_list|)
argument_list|)
expr_stmt|;
name|fs
operator|.
name|setOwner
argument_list|(
name|file
argument_list|,
literal|"root"
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|setupAuditLogs
argument_list|()
expr_stmt|;
try|try
block|{
name|userfs
operator|.
name|open
argument_list|(
name|file
argument_list|)
expr_stmt|;
name|fail
argument_list|(
literal|"open must not succeed"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|AccessControlException
name|e
parameter_list|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"got access denied, as expected."
argument_list|)
expr_stmt|;
block|}
name|verifyAuditLogs
argument_list|(
literal|false
argument_list|)
expr_stmt|;
block|}
comment|/** test that access via webhdfs puts proper entry in audit log */
annotation|@
name|Test
DECL|method|testAuditWebHdfs ()
specifier|public
name|void
name|testAuditWebHdfs
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|Path
name|file
init|=
operator|new
name|Path
argument_list|(
name|fnames
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|fs
operator|.
name|setPermission
argument_list|(
name|file
argument_list|,
operator|new
name|FsPermission
argument_list|(
operator|(
name|short
operator|)
literal|0644
argument_list|)
argument_list|)
expr_stmt|;
name|fs
operator|.
name|setOwner
argument_list|(
name|file
argument_list|,
literal|"root"
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|setupAuditLogs
argument_list|()
expr_stmt|;
name|WebHdfsFileSystem
name|webfs
init|=
name|WebHdfsTestUtil
operator|.
name|getWebHdfsFileSystemAs
argument_list|(
name|userGroupInfo
argument_list|,
name|conf
argument_list|,
name|WebHdfsConstants
operator|.
name|WEBHDFS_SCHEME
argument_list|)
decl_stmt|;
name|InputStream
name|istream
init|=
name|webfs
operator|.
name|open
argument_list|(
name|file
argument_list|)
decl_stmt|;
name|int
name|val
init|=
name|istream
operator|.
name|read
argument_list|()
decl_stmt|;
name|istream
operator|.
name|close
argument_list|()
expr_stmt|;
name|verifyAuditLogsRepeat
argument_list|(
literal|true
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"failed to read from file"
argument_list|,
name|val
operator|>=
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/** test that stat via webhdfs puts proper entry in audit log */
annotation|@
name|Test
DECL|method|testAuditWebHdfsStat ()
specifier|public
name|void
name|testAuditWebHdfsStat
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|Path
name|file
init|=
operator|new
name|Path
argument_list|(
name|fnames
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|fs
operator|.
name|setPermission
argument_list|(
name|file
argument_list|,
operator|new
name|FsPermission
argument_list|(
operator|(
name|short
operator|)
literal|0644
argument_list|)
argument_list|)
expr_stmt|;
name|fs
operator|.
name|setOwner
argument_list|(
name|file
argument_list|,
literal|"root"
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|setupAuditLogs
argument_list|()
expr_stmt|;
name|WebHdfsFileSystem
name|webfs
init|=
name|WebHdfsTestUtil
operator|.
name|getWebHdfsFileSystemAs
argument_list|(
name|userGroupInfo
argument_list|,
name|conf
argument_list|,
name|WebHdfsConstants
operator|.
name|WEBHDFS_SCHEME
argument_list|)
decl_stmt|;
name|FileStatus
name|st
init|=
name|webfs
operator|.
name|getFileStatus
argument_list|(
name|file
argument_list|)
decl_stmt|;
name|verifyAuditLogs
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"failed to stat file"
argument_list|,
name|st
operator|!=
literal|null
operator|&&
name|st
operator|.
name|isFile
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|/** test that denied access via webhdfs puts proper entry in audit log */
annotation|@
name|Test
DECL|method|testAuditWebHdfsDenied ()
specifier|public
name|void
name|testAuditWebHdfsDenied
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|Path
name|file
init|=
operator|new
name|Path
argument_list|(
name|fnames
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|fs
operator|.
name|setPermission
argument_list|(
name|file
argument_list|,
operator|new
name|FsPermission
argument_list|(
operator|(
name|short
operator|)
literal|0600
argument_list|)
argument_list|)
expr_stmt|;
name|fs
operator|.
name|setOwner
argument_list|(
name|file
argument_list|,
literal|"root"
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|setupAuditLogs
argument_list|()
expr_stmt|;
try|try
block|{
name|WebHdfsFileSystem
name|webfs
init|=
name|WebHdfsTestUtil
operator|.
name|getWebHdfsFileSystemAs
argument_list|(
name|userGroupInfo
argument_list|,
name|conf
argument_list|,
name|WebHdfsConstants
operator|.
name|WEBHDFS_SCHEME
argument_list|)
decl_stmt|;
name|InputStream
name|istream
init|=
name|webfs
operator|.
name|open
argument_list|(
name|file
argument_list|)
decl_stmt|;
name|int
name|val
init|=
name|istream
operator|.
name|read
argument_list|()
decl_stmt|;
name|fail
argument_list|(
literal|"open+read must not succeed, got "
operator|+
name|val
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|AccessControlException
name|E
parameter_list|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"got access denied, as expected."
argument_list|)
expr_stmt|;
block|}
name|verifyAuditLogsRepeat
argument_list|(
literal|false
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
comment|/** test that open via webhdfs puts proper entry in audit log */
annotation|@
name|Test
DECL|method|testAuditWebHdfsOpen ()
specifier|public
name|void
name|testAuditWebHdfsOpen
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|Path
name|file
init|=
operator|new
name|Path
argument_list|(
name|fnames
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|fs
operator|.
name|setPermission
argument_list|(
name|file
argument_list|,
operator|new
name|FsPermission
argument_list|(
operator|(
name|short
operator|)
literal|0644
argument_list|)
argument_list|)
expr_stmt|;
name|fs
operator|.
name|setOwner
argument_list|(
name|file
argument_list|,
literal|"root"
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|setupAuditLogs
argument_list|()
expr_stmt|;
name|WebHdfsFileSystem
name|webfs
init|=
name|WebHdfsTestUtil
operator|.
name|getWebHdfsFileSystemAs
argument_list|(
name|userGroupInfo
argument_list|,
name|conf
argument_list|,
name|WebHdfsConstants
operator|.
name|WEBHDFS_SCHEME
argument_list|)
decl_stmt|;
name|webfs
operator|.
name|open
argument_list|(
name|file
argument_list|)
operator|.
name|read
argument_list|()
expr_stmt|;
name|verifyAuditLogsCheckPattern
argument_list|(
literal|true
argument_list|,
literal|3
argument_list|,
name|webOpenPattern
argument_list|)
expr_stmt|;
block|}
comment|/** make sure that "\r\n" isn't made into a newline in audit log */
annotation|@
name|Test
DECL|method|testAuditCharacterEscape ()
specifier|public
name|void
name|testAuditCharacterEscape
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|Path
name|file
init|=
operator|new
name|Path
argument_list|(
literal|"foo"
operator|+
literal|"\r\n"
operator|+
literal|"bar"
argument_list|)
decl_stmt|;
name|setupAuditLogs
argument_list|()
expr_stmt|;
name|fs
operator|.
name|create
argument_list|(
name|file
argument_list|)
expr_stmt|;
name|verifyAuditLogsRepeat
argument_list|(
literal|true
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/** Sets up log4j logger for auditlogs */
DECL|method|setupAuditLogs ()
specifier|private
name|void
name|setupAuditLogs
parameter_list|()
throws|throws
name|IOException
block|{
name|Logger
name|logger
init|=
operator|(
operator|(
name|Log4JLogger
operator|)
name|FSNamesystem
operator|.
name|auditLog
operator|)
operator|.
name|getLogger
argument_list|()
decl_stmt|;
comment|// enable logging now that the test is ready to run
name|logger
operator|.
name|setLevel
argument_list|(
name|Level
operator|.
name|INFO
argument_list|)
expr_stmt|;
block|}
DECL|method|configureAuditLogs ()
specifier|private
name|void
name|configureAuditLogs
parameter_list|()
throws|throws
name|IOException
block|{
comment|// Shutdown the LogManager to release all logger open file handles.
comment|// Unfortunately, Apache commons logging library does not provide
comment|// means to release underlying loggers. For additional info look up
comment|// commons library FAQ.
name|LogManager
operator|.
name|shutdown
argument_list|()
expr_stmt|;
name|File
name|file
init|=
operator|new
name|File
argument_list|(
name|auditLogFile
argument_list|)
decl_stmt|;
if|if
condition|(
name|file
operator|.
name|exists
argument_list|()
condition|)
block|{
name|assertTrue
argument_list|(
name|file
operator|.
name|delete
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|Logger
name|logger
init|=
operator|(
operator|(
name|Log4JLogger
operator|)
name|FSNamesystem
operator|.
name|auditLog
operator|)
operator|.
name|getLogger
argument_list|()
decl_stmt|;
comment|// disable logging while the cluster startup preps files
name|logger
operator|.
name|setLevel
argument_list|(
name|Level
operator|.
name|OFF
argument_list|)
expr_stmt|;
name|PatternLayout
name|layout
init|=
operator|new
name|PatternLayout
argument_list|(
literal|"%m%n"
argument_list|)
decl_stmt|;
name|RollingFileAppender
name|appender
init|=
operator|new
name|RollingFileAppender
argument_list|(
name|layout
argument_list|,
name|auditLogFile
argument_list|)
decl_stmt|;
name|logger
operator|.
name|addAppender
argument_list|(
name|appender
argument_list|)
expr_stmt|;
block|}
comment|// Ensure audit log has only one entry
DECL|method|verifyAuditLogs (boolean expectSuccess)
specifier|private
name|void
name|verifyAuditLogs
parameter_list|(
name|boolean
name|expectSuccess
parameter_list|)
throws|throws
name|IOException
block|{
name|verifyAuditLogsRepeat
argument_list|(
name|expectSuccess
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
comment|// Ensure audit log has exactly N entries
DECL|method|verifyAuditLogsRepeat (boolean expectSuccess, int ndupe)
specifier|private
name|void
name|verifyAuditLogsRepeat
parameter_list|(
name|boolean
name|expectSuccess
parameter_list|,
name|int
name|ndupe
parameter_list|)
throws|throws
name|IOException
block|{
comment|// Turn off the logs
name|Logger
name|logger
init|=
operator|(
operator|(
name|Log4JLogger
operator|)
name|FSNamesystem
operator|.
name|auditLog
operator|)
operator|.
name|getLogger
argument_list|()
decl_stmt|;
name|logger
operator|.
name|setLevel
argument_list|(
name|Level
operator|.
name|OFF
argument_list|)
expr_stmt|;
comment|// Close the appenders and force all logs to be flushed
name|Enumeration
argument_list|<
name|?
argument_list|>
name|appenders
init|=
name|logger
operator|.
name|getAllAppenders
argument_list|()
decl_stmt|;
while|while
condition|(
name|appenders
operator|.
name|hasMoreElements
argument_list|()
condition|)
block|{
name|Appender
name|appender
init|=
operator|(
name|Appender
operator|)
name|appenders
operator|.
name|nextElement
argument_list|()
decl_stmt|;
name|appender
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
name|BufferedReader
name|reader
init|=
operator|new
name|BufferedReader
argument_list|(
operator|new
name|FileReader
argument_list|(
name|auditLogFile
argument_list|)
argument_list|)
decl_stmt|;
name|String
name|line
init|=
literal|null
decl_stmt|;
name|boolean
name|ret
init|=
literal|true
decl_stmt|;
try|try
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|ndupe
condition|;
name|i
operator|++
control|)
block|{
name|line
operator|=
name|reader
operator|.
name|readLine
argument_list|()
expr_stmt|;
name|assertNotNull
argument_list|(
name|line
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Expected audit event not found in audit log"
argument_list|,
name|auditPattern
operator|.
name|matcher
argument_list|(
name|line
argument_list|)
operator|.
name|matches
argument_list|()
argument_list|)
expr_stmt|;
name|ret
operator|&=
name|successPattern
operator|.
name|matcher
argument_list|(
name|line
argument_list|)
operator|.
name|matches
argument_list|()
expr_stmt|;
block|}
name|assertNull
argument_list|(
literal|"Unexpected event in audit log"
argument_list|,
name|reader
operator|.
name|readLine
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Expected success="
operator|+
name|expectSuccess
argument_list|,
name|ret
operator|==
name|expectSuccess
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|reader
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
block|}
comment|// Ensure audit log has exactly N entries
DECL|method|verifyAuditLogsCheckPattern (boolean expectSuccess, int ndupe, Pattern pattern)
specifier|private
name|void
name|verifyAuditLogsCheckPattern
parameter_list|(
name|boolean
name|expectSuccess
parameter_list|,
name|int
name|ndupe
parameter_list|,
name|Pattern
name|pattern
parameter_list|)
throws|throws
name|IOException
block|{
comment|// Turn off the logs
name|Logger
name|logger
init|=
operator|(
operator|(
name|Log4JLogger
operator|)
name|FSNamesystem
operator|.
name|auditLog
operator|)
operator|.
name|getLogger
argument_list|()
decl_stmt|;
name|logger
operator|.
name|setLevel
argument_list|(
name|Level
operator|.
name|OFF
argument_list|)
expr_stmt|;
comment|// Close the appenders and force all logs to be flushed
name|Enumeration
argument_list|<
name|?
argument_list|>
name|appenders
init|=
name|logger
operator|.
name|getAllAppenders
argument_list|()
decl_stmt|;
while|while
condition|(
name|appenders
operator|.
name|hasMoreElements
argument_list|()
condition|)
block|{
name|Appender
name|appender
init|=
operator|(
name|Appender
operator|)
name|appenders
operator|.
name|nextElement
argument_list|()
decl_stmt|;
name|appender
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
name|BufferedReader
name|reader
init|=
operator|new
name|BufferedReader
argument_list|(
operator|new
name|FileReader
argument_list|(
name|auditLogFile
argument_list|)
argument_list|)
decl_stmt|;
name|String
name|line
init|=
literal|null
decl_stmt|;
name|boolean
name|ret
init|=
literal|true
decl_stmt|;
name|boolean
name|patternMatches
init|=
literal|false
decl_stmt|;
try|try
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|ndupe
condition|;
name|i
operator|++
control|)
block|{
name|line
operator|=
name|reader
operator|.
name|readLine
argument_list|()
expr_stmt|;
name|assertNotNull
argument_list|(
name|line
argument_list|)
expr_stmt|;
name|patternMatches
operator||=
name|pattern
operator|.
name|matcher
argument_list|(
name|line
argument_list|)
operator|.
name|matches
argument_list|()
expr_stmt|;
name|ret
operator|&=
name|successPattern
operator|.
name|matcher
argument_list|(
name|line
argument_list|)
operator|.
name|matches
argument_list|()
expr_stmt|;
block|}
name|assertNull
argument_list|(
literal|"Unexpected event in audit log"
argument_list|,
name|reader
operator|.
name|readLine
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Expected audit event not found in audit log"
argument_list|,
name|patternMatches
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Expected success="
operator|+
name|expectSuccess
argument_list|,
name|ret
operator|==
name|expectSuccess
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|reader
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
block|}
block|}
end_class

end_unit

