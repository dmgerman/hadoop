begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  * Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *    http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
DECL|package|org.apache.hadoop.hdfs.server.common.blockaliasmap.impl
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|server
operator|.
name|common
operator|.
name|blockaliasmap
operator|.
name|impl
package|;
end_package

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|io
operator|.
name|Files
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|io
operator|.
name|FileUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|conf
operator|.
name|Configuration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|Path
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|DFSConfigKeys
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|Block
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|ProvidedStorageLocation
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|server
operator|.
name|aliasmap
operator|.
name|InMemoryAliasMap
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|server
operator|.
name|aliasmap
operator|.
name|InMemoryLevelDBAliasMapServer
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|server
operator|.
name|common
operator|.
name|FileRegion
import|;
end_import

begin_import
import|import
name|org
operator|.
name|iq80
operator|.
name|leveldb
operator|.
name|DBException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|After
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Before
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Test
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|File
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|assertj
operator|.
name|core
operator|.
name|api
operator|.
name|AssertionsForClassTypes
operator|.
name|assertThatExceptionOfType
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|mockito
operator|.
name|Mockito
operator|.
name|doThrow
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|mockito
operator|.
name|Mockito
operator|.
name|mock
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|mockito
operator|.
name|Mockito
operator|.
name|when
import|;
end_import

begin_comment
comment|/**  * Tests the in-memory alias map with a mock level-db implementation.  */
end_comment

begin_class
DECL|class|TestLevelDbMockAliasMapClient
specifier|public
class|class
name|TestLevelDbMockAliasMapClient
block|{
DECL|field|levelDBAliasMapServer
specifier|private
name|InMemoryLevelDBAliasMapServer
name|levelDBAliasMapServer
decl_stmt|;
DECL|field|inMemoryLevelDBAliasMapClient
specifier|private
name|InMemoryLevelDBAliasMapClient
name|inMemoryLevelDBAliasMapClient
decl_stmt|;
DECL|field|tempDir
specifier|private
name|File
name|tempDir
decl_stmt|;
DECL|field|conf
specifier|private
name|Configuration
name|conf
decl_stmt|;
DECL|field|aliasMapMock
specifier|private
name|InMemoryAliasMap
name|aliasMapMock
decl_stmt|;
DECL|field|bpid
specifier|private
specifier|final
name|String
name|bpid
init|=
literal|"BPID-0"
decl_stmt|;
annotation|@
name|Before
DECL|method|setUp ()
specifier|public
name|void
name|setUp
parameter_list|()
throws|throws
name|IOException
block|{
name|aliasMapMock
operator|=
name|mock
argument_list|(
name|InMemoryAliasMap
operator|.
name|class
argument_list|)
expr_stmt|;
name|when
argument_list|(
name|aliasMapMock
operator|.
name|getBlockPoolId
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|bpid
argument_list|)
expr_stmt|;
name|levelDBAliasMapServer
operator|=
operator|new
name|InMemoryLevelDBAliasMapServer
argument_list|(
name|config
lambda|->
name|aliasMapMock
argument_list|,
name|bpid
argument_list|)
expr_stmt|;
name|conf
operator|=
operator|new
name|Configuration
argument_list|()
expr_stmt|;
name|int
name|port
init|=
literal|9877
decl_stmt|;
name|conf
operator|.
name|set
argument_list|(
name|DFSConfigKeys
operator|.
name|DFS_PROVIDED_ALIASMAP_INMEMORY_RPC_ADDRESS
argument_list|,
literal|"localhost:"
operator|+
name|port
argument_list|)
expr_stmt|;
name|tempDir
operator|=
name|Files
operator|.
name|createTempDir
argument_list|()
expr_stmt|;
name|conf
operator|.
name|set
argument_list|(
name|DFSConfigKeys
operator|.
name|DFS_PROVIDED_ALIASMAP_INMEMORY_LEVELDB_DIR
argument_list|,
name|tempDir
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
expr_stmt|;
name|levelDBAliasMapServer
operator|.
name|setConf
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|levelDBAliasMapServer
operator|.
name|start
argument_list|()
expr_stmt|;
name|inMemoryLevelDBAliasMapClient
operator|=
operator|new
name|InMemoryLevelDBAliasMapClient
argument_list|()
expr_stmt|;
name|inMemoryLevelDBAliasMapClient
operator|.
name|setConf
argument_list|(
name|conf
argument_list|)
expr_stmt|;
block|}
annotation|@
name|After
DECL|method|tearDown ()
specifier|public
name|void
name|tearDown
parameter_list|()
throws|throws
name|IOException
block|{
name|levelDBAliasMapServer
operator|.
name|close
argument_list|()
expr_stmt|;
name|inMemoryLevelDBAliasMapClient
operator|.
name|close
argument_list|()
expr_stmt|;
name|FileUtils
operator|.
name|deleteDirectory
argument_list|(
name|tempDir
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|readFailure ()
specifier|public
name|void
name|readFailure
parameter_list|()
throws|throws
name|Exception
block|{
name|Block
name|block
init|=
operator|new
name|Block
argument_list|(
literal|42
argument_list|,
literal|43
argument_list|,
literal|44
argument_list|)
decl_stmt|;
name|doThrow
argument_list|(
operator|new
name|IOException
argument_list|()
argument_list|)
operator|.
name|doThrow
argument_list|(
operator|new
name|DBException
argument_list|()
argument_list|)
operator|.
name|when
argument_list|(
name|aliasMapMock
argument_list|)
operator|.
name|read
argument_list|(
name|block
argument_list|)
expr_stmt|;
name|assertThatExceptionOfType
argument_list|(
name|IOException
operator|.
name|class
argument_list|)
operator|.
name|isThrownBy
argument_list|(
parameter_list|()
lambda|->
name|inMemoryLevelDBAliasMapClient
operator|.
name|getReader
argument_list|(
literal|null
argument_list|,
name|bpid
argument_list|)
operator|.
name|resolve
argument_list|(
name|block
argument_list|)
argument_list|)
expr_stmt|;
name|assertThatExceptionOfType
argument_list|(
name|IOException
operator|.
name|class
argument_list|)
operator|.
name|isThrownBy
argument_list|(
parameter_list|()
lambda|->
name|inMemoryLevelDBAliasMapClient
operator|.
name|getReader
argument_list|(
literal|null
argument_list|,
name|bpid
argument_list|)
operator|.
name|resolve
argument_list|(
name|block
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|writeFailure ()
specifier|public
name|void
name|writeFailure
parameter_list|()
throws|throws
name|IOException
block|{
name|Block
name|block
init|=
operator|new
name|Block
argument_list|(
literal|42
argument_list|,
literal|43
argument_list|,
literal|44
argument_list|)
decl_stmt|;
name|byte
index|[]
name|nonce
init|=
operator|new
name|byte
index|[
literal|0
index|]
decl_stmt|;
name|Path
name|path
init|=
operator|new
name|Path
argument_list|(
literal|"koekoek"
argument_list|)
decl_stmt|;
name|ProvidedStorageLocation
name|providedStorageLocation
init|=
operator|new
name|ProvidedStorageLocation
argument_list|(
name|path
argument_list|,
literal|45
argument_list|,
literal|46
argument_list|,
name|nonce
argument_list|)
decl_stmt|;
name|doThrow
argument_list|(
operator|new
name|IOException
argument_list|()
argument_list|)
operator|.
name|when
argument_list|(
name|aliasMapMock
argument_list|)
operator|.
name|write
argument_list|(
name|block
argument_list|,
name|providedStorageLocation
argument_list|)
expr_stmt|;
name|assertThatExceptionOfType
argument_list|(
name|IOException
operator|.
name|class
argument_list|)
operator|.
name|isThrownBy
argument_list|(
parameter_list|()
lambda|->
name|inMemoryLevelDBAliasMapClient
operator|.
name|getWriter
argument_list|(
literal|null
argument_list|,
name|bpid
argument_list|)
operator|.
name|store
argument_list|(
operator|new
name|FileRegion
argument_list|(
name|block
argument_list|,
name|providedStorageLocation
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|assertThatExceptionOfType
argument_list|(
name|IOException
operator|.
name|class
argument_list|)
operator|.
name|isThrownBy
argument_list|(
parameter_list|()
lambda|->
name|inMemoryLevelDBAliasMapClient
operator|.
name|getWriter
argument_list|(
literal|null
argument_list|,
name|bpid
argument_list|)
operator|.
name|store
argument_list|(
operator|new
name|FileRegion
argument_list|(
name|block
argument_list|,
name|providedStorageLocation
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_class

end_unit

