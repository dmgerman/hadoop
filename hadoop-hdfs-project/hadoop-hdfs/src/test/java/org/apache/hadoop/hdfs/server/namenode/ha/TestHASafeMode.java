begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/**  * Licensed to the Apache Software Foundation (ASF) under one  * or more contributor license agreements.  See the NOTICE file  * distributed with this work for additional information  * regarding copyright ownership.  The ASF licenses this file  * to you under the Apache License, Version 2.0 (the  * "License"); you may not use this file except in compliance  * with the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
DECL|package|org.apache.hadoop.hdfs.server.namenode.ha
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|server
operator|.
name|namenode
operator|.
name|ha
package|;
end_package

begin_import
import|import static
name|org
operator|.
name|junit
operator|.
name|Assert
operator|.
name|assertTrue
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|mockito
operator|.
name|Matchers
operator|.
name|anyInt
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|mockito
operator|.
name|Mockito
operator|.
name|mock
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|mockito
operator|.
name|Mockito
operator|.
name|times
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|mockito
operator|.
name|Mockito
operator|.
name|verify
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|Log
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|LogFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|conf
operator|.
name|Configuration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|FileSystem
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|Path
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|DFSConfigKeys
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|DFSTestUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|MiniDFSCluster
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|MiniDFSNNTopology
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|server
operator|.
name|blockmanagement
operator|.
name|BlockManagerTestUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|server
operator|.
name|namenode
operator|.
name|FSNamesystem
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|server
operator|.
name|namenode
operator|.
name|NameNode
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|server
operator|.
name|namenode
operator|.
name|NameNodeAdapter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|After
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Before
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Test
import|;
end_import

begin_comment
comment|/**  * Tests that exercise safemode in an HA cluster.  */
end_comment

begin_class
DECL|class|TestHASafeMode
specifier|public
class|class
name|TestHASafeMode
block|{
DECL|field|LOG
specifier|private
specifier|static
specifier|final
name|Log
name|LOG
init|=
name|LogFactory
operator|.
name|getLog
argument_list|(
name|TestHASafeMode
operator|.
name|class
argument_list|)
decl_stmt|;
DECL|field|BLOCK_SIZE
specifier|private
specifier|static
specifier|final
name|int
name|BLOCK_SIZE
init|=
literal|1024
decl_stmt|;
DECL|field|nn0
specifier|private
name|NameNode
name|nn0
decl_stmt|;
DECL|field|nn1
specifier|private
name|NameNode
name|nn1
decl_stmt|;
DECL|field|fs
specifier|private
name|FileSystem
name|fs
decl_stmt|;
DECL|field|cluster
specifier|private
name|MiniDFSCluster
name|cluster
decl_stmt|;
DECL|field|mockRuntime
specifier|private
name|Runtime
name|mockRuntime
init|=
name|mock
argument_list|(
name|Runtime
operator|.
name|class
argument_list|)
decl_stmt|;
annotation|@
name|Before
DECL|method|setupCluster ()
specifier|public
name|void
name|setupCluster
parameter_list|()
throws|throws
name|Exception
block|{
name|Configuration
name|conf
init|=
operator|new
name|Configuration
argument_list|()
decl_stmt|;
name|conf
operator|.
name|setInt
argument_list|(
name|DFSConfigKeys
operator|.
name|DFS_BLOCK_SIZE_KEY
argument_list|,
name|BLOCK_SIZE
argument_list|)
expr_stmt|;
name|conf
operator|.
name|setInt
argument_list|(
name|DFSConfigKeys
operator|.
name|DFS_HEARTBEAT_INTERVAL_KEY
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|cluster
operator|=
operator|new
name|MiniDFSCluster
operator|.
name|Builder
argument_list|(
name|conf
argument_list|)
operator|.
name|nnTopology
argument_list|(
name|MiniDFSNNTopology
operator|.
name|simpleHATopology
argument_list|()
argument_list|)
operator|.
name|numDataNodes
argument_list|(
literal|3
argument_list|)
operator|.
name|waitSafeMode
argument_list|(
literal|false
argument_list|)
operator|.
name|build
argument_list|()
expr_stmt|;
name|cluster
operator|.
name|waitActive
argument_list|()
expr_stmt|;
name|nn0
operator|=
name|cluster
operator|.
name|getNameNode
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|nn1
operator|=
name|cluster
operator|.
name|getNameNode
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|fs
operator|=
name|HATestUtil
operator|.
name|configureFailoverFs
argument_list|(
name|cluster
argument_list|,
name|conf
argument_list|)
expr_stmt|;
name|nn0
operator|.
name|getNamesystem
argument_list|()
operator|.
name|getEditLogTailer
argument_list|()
operator|.
name|setRuntime
argument_list|(
name|mockRuntime
argument_list|)
expr_stmt|;
name|cluster
operator|.
name|transitionToActive
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
annotation|@
name|After
DECL|method|shutdownCluster ()
specifier|public
name|void
name|shutdownCluster
parameter_list|()
throws|throws
name|IOException
block|{
if|if
condition|(
name|cluster
operator|!=
literal|null
condition|)
block|{
name|verify
argument_list|(
name|mockRuntime
argument_list|,
name|times
argument_list|(
literal|0
argument_list|)
argument_list|)
operator|.
name|exit
argument_list|(
name|anyInt
argument_list|()
argument_list|)
expr_stmt|;
name|cluster
operator|.
name|shutdown
argument_list|()
expr_stmt|;
block|}
block|}
DECL|method|restartStandby ()
specifier|private
name|void
name|restartStandby
parameter_list|()
throws|throws
name|IOException
block|{
name|cluster
operator|.
name|shutdownNameNode
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|// Set the safemode extension to be lengthy, so that the tests
comment|// can check the safemode message after the safemode conditions
comment|// have been achieved, without being racy.
name|cluster
operator|.
name|getConfiguration
argument_list|(
literal|1
argument_list|)
operator|.
name|setInt
argument_list|(
name|DFSConfigKeys
operator|.
name|DFS_NAMENODE_SAFEMODE_EXTENSION_KEY
argument_list|,
literal|30000
argument_list|)
expr_stmt|;
name|cluster
operator|.
name|restartNameNode
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|nn1
operator|=
name|cluster
operator|.
name|getNameNode
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|nn1
operator|.
name|getNamesystem
argument_list|()
operator|.
name|getEditLogTailer
argument_list|()
operator|.
name|setSleepTime
argument_list|(
literal|250
argument_list|)
expr_stmt|;
name|nn1
operator|.
name|getNamesystem
argument_list|()
operator|.
name|getEditLogTailer
argument_list|()
operator|.
name|interrupt
argument_list|()
expr_stmt|;
block|}
comment|/**    * Test case for enter safemode in active namenode, when it is already in startup safemode.    * It is a regression test for HDFS-2747.    */
annotation|@
name|Test
DECL|method|testEnterSafeModeInANNShouldNotThrowNPE ()
specifier|public
name|void
name|testEnterSafeModeInANNShouldNotThrowNPE
parameter_list|()
throws|throws
name|Exception
block|{
name|banner
argument_list|(
literal|"Restarting active"
argument_list|)
expr_stmt|;
name|restartActive
argument_list|()
expr_stmt|;
name|FSNamesystem
name|namesystem
init|=
name|nn0
operator|.
name|getNamesystem
argument_list|()
decl_stmt|;
name|String
name|status
init|=
name|namesystem
operator|.
name|getSafemode
argument_list|()
decl_stmt|;
name|assertTrue
argument_list|(
literal|"Bad safemode status: '"
operator|+
name|status
operator|+
literal|"'"
argument_list|,
name|status
operator|.
name|startsWith
argument_list|(
literal|"Safe mode is ON."
argument_list|)
argument_list|)
expr_stmt|;
name|NameNodeAdapter
operator|.
name|enterSafeMode
argument_list|(
name|nn0
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Failed to enter into safemode in active"
argument_list|,
name|namesystem
operator|.
name|isInSafeMode
argument_list|()
argument_list|)
expr_stmt|;
name|NameNodeAdapter
operator|.
name|enterSafeMode
argument_list|(
name|nn0
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Failed to enter into safemode in active"
argument_list|,
name|namesystem
operator|.
name|isInSafeMode
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|/**    * Test case for enter safemode in standby namenode, when it is already in startup safemode.    * It is a regression test for HDFS-2747.    */
annotation|@
name|Test
DECL|method|testEnterSafeModeInSBNShouldNotThrowNPE ()
specifier|public
name|void
name|testEnterSafeModeInSBNShouldNotThrowNPE
parameter_list|()
throws|throws
name|Exception
block|{
name|banner
argument_list|(
literal|"Starting with NN0 active and NN1 standby, creating some blocks"
argument_list|)
expr_stmt|;
name|DFSTestUtil
operator|.
name|createFile
argument_list|(
name|fs
argument_list|,
operator|new
name|Path
argument_list|(
literal|"/test"
argument_list|)
argument_list|,
literal|3
operator|*
name|BLOCK_SIZE
argument_list|,
operator|(
name|short
operator|)
literal|3
argument_list|,
literal|1L
argument_list|)
expr_stmt|;
comment|// Roll edit log so that, when the SBN restarts, it will load
comment|// the namespace during startup and enter safemode.
name|nn0
operator|.
name|getRpcServer
argument_list|()
operator|.
name|rollEditLog
argument_list|()
expr_stmt|;
name|banner
argument_list|(
literal|"Creating some blocks that won't be in the edit log"
argument_list|)
expr_stmt|;
name|DFSTestUtil
operator|.
name|createFile
argument_list|(
name|fs
argument_list|,
operator|new
name|Path
argument_list|(
literal|"/test2"
argument_list|)
argument_list|,
literal|5
operator|*
name|BLOCK_SIZE
argument_list|,
operator|(
name|short
operator|)
literal|3
argument_list|,
literal|1L
argument_list|)
expr_stmt|;
name|banner
argument_list|(
literal|"Deleting the original blocks"
argument_list|)
expr_stmt|;
name|fs
operator|.
name|delete
argument_list|(
operator|new
name|Path
argument_list|(
literal|"/test"
argument_list|)
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|banner
argument_list|(
literal|"Restarting standby"
argument_list|)
expr_stmt|;
name|restartStandby
argument_list|()
expr_stmt|;
name|FSNamesystem
name|namesystem
init|=
name|nn1
operator|.
name|getNamesystem
argument_list|()
decl_stmt|;
name|String
name|status
init|=
name|namesystem
operator|.
name|getSafemode
argument_list|()
decl_stmt|;
name|assertTrue
argument_list|(
literal|"Bad safemode status: '"
operator|+
name|status
operator|+
literal|"'"
argument_list|,
name|status
operator|.
name|startsWith
argument_list|(
literal|"Safe mode is ON."
argument_list|)
argument_list|)
expr_stmt|;
name|NameNodeAdapter
operator|.
name|enterSafeMode
argument_list|(
name|nn1
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Failed to enter into safemode in standby"
argument_list|,
name|namesystem
operator|.
name|isInSafeMode
argument_list|()
argument_list|)
expr_stmt|;
name|NameNodeAdapter
operator|.
name|enterSafeMode
argument_list|(
name|nn1
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Failed to enter into safemode in standby"
argument_list|,
name|namesystem
operator|.
name|isInSafeMode
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|restartActive ()
specifier|private
name|void
name|restartActive
parameter_list|()
throws|throws
name|IOException
block|{
name|cluster
operator|.
name|shutdownNameNode
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|// Set the safemode extension to be lengthy, so that the tests
comment|// can check the safemode message after the safemode conditions
comment|// have been achieved, without being racy.
name|cluster
operator|.
name|getConfiguration
argument_list|(
literal|0
argument_list|)
operator|.
name|setInt
argument_list|(
name|DFSConfigKeys
operator|.
name|DFS_NAMENODE_SAFEMODE_EXTENSION_KEY
argument_list|,
literal|30000
argument_list|)
expr_stmt|;
name|cluster
operator|.
name|restartNameNode
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|nn0
operator|=
name|cluster
operator|.
name|getNameNode
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/**    * Tests the case where, while a standby is down, more blocks are    * added to the namespace, but not rolled. So, when it starts up,    * it receives notification about the new blocks during    * the safemode extension period.    */
annotation|@
name|Test
DECL|method|testBlocksAddedBeforeStandbyRestart ()
specifier|public
name|void
name|testBlocksAddedBeforeStandbyRestart
parameter_list|()
throws|throws
name|Exception
block|{
name|banner
argument_list|(
literal|"Starting with NN0 active and NN1 standby, creating some blocks"
argument_list|)
expr_stmt|;
name|DFSTestUtil
operator|.
name|createFile
argument_list|(
name|fs
argument_list|,
operator|new
name|Path
argument_list|(
literal|"/test"
argument_list|)
argument_list|,
literal|3
operator|*
name|BLOCK_SIZE
argument_list|,
operator|(
name|short
operator|)
literal|3
argument_list|,
literal|1L
argument_list|)
expr_stmt|;
comment|// Roll edit log so that, when the SBN restarts, it will load
comment|// the namespace during startup.
name|nn0
operator|.
name|getRpcServer
argument_list|()
operator|.
name|rollEditLog
argument_list|()
expr_stmt|;
name|banner
argument_list|(
literal|"Creating some blocks that won't be in the edit log"
argument_list|)
expr_stmt|;
name|DFSTestUtil
operator|.
name|createFile
argument_list|(
name|fs
argument_list|,
operator|new
name|Path
argument_list|(
literal|"/test2"
argument_list|)
argument_list|,
literal|5
operator|*
name|BLOCK_SIZE
argument_list|,
operator|(
name|short
operator|)
literal|3
argument_list|,
literal|1L
argument_list|)
expr_stmt|;
name|banner
argument_list|(
literal|"Restarting standby"
argument_list|)
expr_stmt|;
name|restartStandby
argument_list|()
expr_stmt|;
comment|// We expect it to be stuck in safemode (not the extension) because
comment|// the block reports are delayed (since they include blocks
comment|// from /test2 which are too-high genstamps.
name|String
name|status
init|=
name|nn1
operator|.
name|getNamesystem
argument_list|()
operator|.
name|getSafemode
argument_list|()
decl_stmt|;
name|assertTrue
argument_list|(
literal|"Bad safemode status: '"
operator|+
name|status
operator|+
literal|"'"
argument_list|,
name|status
operator|.
name|startsWith
argument_list|(
literal|"Safe mode is ON."
operator|+
literal|"The reported blocks 0 needs additional 3 blocks to reach"
argument_list|)
argument_list|)
expr_stmt|;
name|banner
argument_list|(
literal|"Waiting for standby to catch up to active namespace"
argument_list|)
expr_stmt|;
name|HATestUtil
operator|.
name|waitForStandbyToCatchUp
argument_list|(
name|nn0
argument_list|,
name|nn1
argument_list|)
expr_stmt|;
name|status
operator|=
name|nn1
operator|.
name|getNamesystem
argument_list|()
operator|.
name|getSafemode
argument_list|()
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Bad safemode status: '"
operator|+
name|status
operator|+
literal|"'"
argument_list|,
name|status
operator|.
name|startsWith
argument_list|(
literal|"Safe mode is ON."
operator|+
literal|"The reported blocks 8 has reached the threshold 0.9990 of "
operator|+
literal|"total blocks 8. Safe mode will be turned off automatically"
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/**    * Similar to {@link #testBlocksAddedBeforeStandbyRestart()} except that    * the new blocks are allocated after the SBN has restarted. So, the    * blocks were not present in the original block reports at startup    * but are reported separately by blockReceived calls.    */
annotation|@
name|Test
DECL|method|testBlocksAddedWhileInSafeMode ()
specifier|public
name|void
name|testBlocksAddedWhileInSafeMode
parameter_list|()
throws|throws
name|Exception
block|{
name|banner
argument_list|(
literal|"Starting with NN0 active and NN1 standby, creating some blocks"
argument_list|)
expr_stmt|;
name|DFSTestUtil
operator|.
name|createFile
argument_list|(
name|fs
argument_list|,
operator|new
name|Path
argument_list|(
literal|"/test"
argument_list|)
argument_list|,
literal|3
operator|*
name|BLOCK_SIZE
argument_list|,
operator|(
name|short
operator|)
literal|3
argument_list|,
literal|1L
argument_list|)
expr_stmt|;
comment|// Roll edit log so that, when the SBN restarts, it will load
comment|// the namespace during startup.
name|nn0
operator|.
name|getRpcServer
argument_list|()
operator|.
name|rollEditLog
argument_list|()
expr_stmt|;
name|banner
argument_list|(
literal|"Restarting standby"
argument_list|)
expr_stmt|;
name|restartStandby
argument_list|()
expr_stmt|;
name|String
name|status
init|=
name|nn1
operator|.
name|getNamesystem
argument_list|()
operator|.
name|getSafemode
argument_list|()
decl_stmt|;
name|assertTrue
argument_list|(
literal|"Bad safemode status: '"
operator|+
name|status
operator|+
literal|"'"
argument_list|,
name|status
operator|.
name|startsWith
argument_list|(
literal|"Safe mode is ON."
operator|+
literal|"The reported blocks 3 has reached the threshold 0.9990 of "
operator|+
literal|"total blocks 3. Safe mode will be turned off automatically"
argument_list|)
argument_list|)
expr_stmt|;
comment|// Create a few blocks which will send blockReceived calls to the
comment|// SBN.
name|banner
argument_list|(
literal|"Creating some blocks while SBN is in safe mode"
argument_list|)
expr_stmt|;
name|DFSTestUtil
operator|.
name|createFile
argument_list|(
name|fs
argument_list|,
operator|new
name|Path
argument_list|(
literal|"/test2"
argument_list|)
argument_list|,
literal|5
operator|*
name|BLOCK_SIZE
argument_list|,
operator|(
name|short
operator|)
literal|3
argument_list|,
literal|1L
argument_list|)
expr_stmt|;
name|banner
argument_list|(
literal|"Waiting for standby to catch up to active namespace"
argument_list|)
expr_stmt|;
name|HATestUtil
operator|.
name|waitForStandbyToCatchUp
argument_list|(
name|nn0
argument_list|,
name|nn1
argument_list|)
expr_stmt|;
name|status
operator|=
name|nn1
operator|.
name|getNamesystem
argument_list|()
operator|.
name|getSafemode
argument_list|()
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Bad safemode status: '"
operator|+
name|status
operator|+
literal|"'"
argument_list|,
name|status
operator|.
name|startsWith
argument_list|(
literal|"Safe mode is ON."
operator|+
literal|"The reported blocks 8 has reached the threshold 0.9990 of "
operator|+
literal|"total blocks 8. Safe mode will be turned off automatically"
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/**    * Test for the following case proposed by ATM:    * 1. Both NNs are up, one is active. There are 100 blocks. Both are    *    out of safemode.    * 2. 10 block deletions get processed by NN1. NN2 enqueues these DN messages    *     until it next reads from a checkpointed edits file.    * 3. NN2 gets restarted. Its queues are lost.    * 4. NN2 comes up, reads from all the finalized edits files. Concludes there    *    should still be 100 blocks.    * 5. NN2 receives a block report from all the DNs, which only accounts for    *    90 blocks. It doesn't leave safemode.    * 6. NN1 dies or is transitioned to standby.    * 7. NN2 is transitioned to active. It reads all the edits from NN1. It now    *    knows there should only be 90 blocks, but it's still in safemode.    * 8. NN2 doesn't ever recheck whether it should leave safemode.    *     * This is essentially the inverse of {@link #testBlocksAddedBeforeStandbyRestart()}    */
annotation|@
name|Test
DECL|method|testBlocksRemovedBeforeStandbyRestart ()
specifier|public
name|void
name|testBlocksRemovedBeforeStandbyRestart
parameter_list|()
throws|throws
name|Exception
block|{
name|banner
argument_list|(
literal|"Starting with NN0 active and NN1 standby, creating some blocks"
argument_list|)
expr_stmt|;
name|DFSTestUtil
operator|.
name|createFile
argument_list|(
name|fs
argument_list|,
operator|new
name|Path
argument_list|(
literal|"/test"
argument_list|)
argument_list|,
literal|5
operator|*
name|BLOCK_SIZE
argument_list|,
operator|(
name|short
operator|)
literal|3
argument_list|,
literal|1L
argument_list|)
expr_stmt|;
comment|// Roll edit log so that, when the SBN restarts, it will load
comment|// the namespace during startup.
name|nn0
operator|.
name|getRpcServer
argument_list|()
operator|.
name|rollEditLog
argument_list|()
expr_stmt|;
comment|// Delete those blocks again, so they won't get reported to the SBN
comment|// once it starts up
name|banner
argument_list|(
literal|"Removing the blocks without rolling the edit log"
argument_list|)
expr_stmt|;
name|fs
operator|.
name|delete
argument_list|(
operator|new
name|Path
argument_list|(
literal|"/test"
argument_list|)
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|BlockManagerTestUtil
operator|.
name|computeAllPendingWork
argument_list|(
name|nn0
operator|.
name|getNamesystem
argument_list|()
operator|.
name|getBlockManager
argument_list|()
argument_list|)
expr_stmt|;
name|cluster
operator|.
name|triggerHeartbeats
argument_list|()
expr_stmt|;
name|banner
argument_list|(
literal|"Restarting standby"
argument_list|)
expr_stmt|;
name|restartStandby
argument_list|()
expr_stmt|;
name|String
name|status
init|=
name|nn1
operator|.
name|getNamesystem
argument_list|()
operator|.
name|getSafemode
argument_list|()
decl_stmt|;
name|assertTrue
argument_list|(
literal|"Bad safemode status: '"
operator|+
name|status
operator|+
literal|"'"
argument_list|,
name|status
operator|.
name|startsWith
argument_list|(
literal|"Safe mode is ON."
operator|+
literal|"The reported blocks 0 needs additional 5 blocks to reach"
argument_list|)
argument_list|)
expr_stmt|;
name|banner
argument_list|(
literal|"Waiting for standby to catch up to active namespace"
argument_list|)
expr_stmt|;
name|HATestUtil
operator|.
name|waitForStandbyToCatchUp
argument_list|(
name|nn0
argument_list|,
name|nn1
argument_list|)
expr_stmt|;
name|status
operator|=
name|nn1
operator|.
name|getNamesystem
argument_list|()
operator|.
name|getSafemode
argument_list|()
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Bad safemode status: '"
operator|+
name|status
operator|+
literal|"'"
argument_list|,
name|status
operator|.
name|startsWith
argument_list|(
literal|"Safe mode is ON."
operator|+
literal|"The reported blocks 0 has reached the threshold 0.9990 of "
operator|+
literal|"total blocks 0. Safe mode will be turned off automatically"
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/**    * Similar to {@link #testBlocksRemovedBeforeStandbyRestart()} except that    * the blocks are removed after the SBN has restarted. So, the    * blocks were present in the original block reports at startup    * but are deleted separately later by deletion reports.    */
annotation|@
name|Test
DECL|method|testBlocksRemovedWhileInSafeMode ()
specifier|public
name|void
name|testBlocksRemovedWhileInSafeMode
parameter_list|()
throws|throws
name|Exception
block|{
name|banner
argument_list|(
literal|"Starting with NN0 active and NN1 standby, creating some blocks"
argument_list|)
expr_stmt|;
name|DFSTestUtil
operator|.
name|createFile
argument_list|(
name|fs
argument_list|,
operator|new
name|Path
argument_list|(
literal|"/test"
argument_list|)
argument_list|,
literal|10
operator|*
name|BLOCK_SIZE
argument_list|,
operator|(
name|short
operator|)
literal|3
argument_list|,
literal|1L
argument_list|)
expr_stmt|;
comment|// Roll edit log so that, when the SBN restarts, it will load
comment|// the namespace during startup.
name|nn0
operator|.
name|getRpcServer
argument_list|()
operator|.
name|rollEditLog
argument_list|()
expr_stmt|;
name|banner
argument_list|(
literal|"Restarting standby"
argument_list|)
expr_stmt|;
name|restartStandby
argument_list|()
expr_stmt|;
comment|// It will initially have all of the blocks necessary.
name|String
name|status
init|=
name|nn1
operator|.
name|getNamesystem
argument_list|()
operator|.
name|getSafemode
argument_list|()
decl_stmt|;
name|assertTrue
argument_list|(
literal|"Bad safemode status: '"
operator|+
name|status
operator|+
literal|"'"
argument_list|,
name|status
operator|.
name|startsWith
argument_list|(
literal|"Safe mode is ON."
operator|+
literal|"The reported blocks 10 has reached the threshold 0.9990 of "
operator|+
literal|"total blocks 10. Safe mode will be turned off automatically"
argument_list|)
argument_list|)
expr_stmt|;
comment|// Delete those blocks while the SBN is in safe mode - this
comment|// should reduce it back below the threshold
name|banner
argument_list|(
literal|"Removing the blocks without rolling the edit log"
argument_list|)
expr_stmt|;
name|fs
operator|.
name|delete
argument_list|(
operator|new
name|Path
argument_list|(
literal|"/test"
argument_list|)
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|BlockManagerTestUtil
operator|.
name|computeAllPendingWork
argument_list|(
name|nn0
operator|.
name|getNamesystem
argument_list|()
operator|.
name|getBlockManager
argument_list|()
argument_list|)
expr_stmt|;
name|banner
argument_list|(
literal|"Triggering deletions on DNs and Deletion Reports"
argument_list|)
expr_stmt|;
name|cluster
operator|.
name|triggerHeartbeats
argument_list|()
expr_stmt|;
name|HATestUtil
operator|.
name|waitForDNDeletions
argument_list|(
name|cluster
argument_list|)
expr_stmt|;
name|cluster
operator|.
name|triggerDeletionReports
argument_list|()
expr_stmt|;
name|status
operator|=
name|nn1
operator|.
name|getNamesystem
argument_list|()
operator|.
name|getSafemode
argument_list|()
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Bad safemode status: '"
operator|+
name|status
operator|+
literal|"'"
argument_list|,
name|status
operator|.
name|startsWith
argument_list|(
literal|"Safe mode is ON."
operator|+
literal|"The reported blocks 0 needs additional 10 blocks"
argument_list|)
argument_list|)
expr_stmt|;
name|banner
argument_list|(
literal|"Waiting for standby to catch up to active namespace"
argument_list|)
expr_stmt|;
name|HATestUtil
operator|.
name|waitForStandbyToCatchUp
argument_list|(
name|nn0
argument_list|,
name|nn1
argument_list|)
expr_stmt|;
name|status
operator|=
name|nn1
operator|.
name|getNamesystem
argument_list|()
operator|.
name|getSafemode
argument_list|()
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Bad safemode status: '"
operator|+
name|status
operator|+
literal|"'"
argument_list|,
name|status
operator|.
name|startsWith
argument_list|(
literal|"Safe mode is ON."
operator|+
literal|"The reported blocks 0 has reached the threshold 0.9990 of "
operator|+
literal|"total blocks 0. Safe mode will be turned off automatically"
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/**    * Set up a namesystem with several edits, both deletions and    * additions, and failover to a new NN while that NN is in    * safemode. Ensure that it will exit safemode.    */
annotation|@
name|Test
DECL|method|testComplexFailoverIntoSafemode ()
specifier|public
name|void
name|testComplexFailoverIntoSafemode
parameter_list|()
throws|throws
name|Exception
block|{
name|banner
argument_list|(
literal|"Starting with NN0 active and NN1 standby, creating some blocks"
argument_list|)
expr_stmt|;
name|DFSTestUtil
operator|.
name|createFile
argument_list|(
name|fs
argument_list|,
operator|new
name|Path
argument_list|(
literal|"/test"
argument_list|)
argument_list|,
literal|3
operator|*
name|BLOCK_SIZE
argument_list|,
operator|(
name|short
operator|)
literal|3
argument_list|,
literal|1L
argument_list|)
expr_stmt|;
comment|// Roll edit log so that, when the SBN restarts, it will load
comment|// the namespace during startup and enter safemode.
name|nn0
operator|.
name|getRpcServer
argument_list|()
operator|.
name|rollEditLog
argument_list|()
expr_stmt|;
name|banner
argument_list|(
literal|"Creating some blocks that won't be in the edit log"
argument_list|)
expr_stmt|;
name|DFSTestUtil
operator|.
name|createFile
argument_list|(
name|fs
argument_list|,
operator|new
name|Path
argument_list|(
literal|"/test2"
argument_list|)
argument_list|,
literal|5
operator|*
name|BLOCK_SIZE
argument_list|,
operator|(
name|short
operator|)
literal|3
argument_list|,
literal|1L
argument_list|)
expr_stmt|;
name|banner
argument_list|(
literal|"Deleting the original blocks"
argument_list|)
expr_stmt|;
name|fs
operator|.
name|delete
argument_list|(
operator|new
name|Path
argument_list|(
literal|"/test"
argument_list|)
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|banner
argument_list|(
literal|"Restarting standby"
argument_list|)
expr_stmt|;
name|restartStandby
argument_list|()
expr_stmt|;
comment|// We expect it to be stuck in safemode (not the extension) because
comment|// the block reports are delayed (since they include blocks
comment|// from /test2 which are too-high genstamps.
name|String
name|status
init|=
name|nn1
operator|.
name|getNamesystem
argument_list|()
operator|.
name|getSafemode
argument_list|()
decl_stmt|;
name|assertTrue
argument_list|(
literal|"Bad safemode status: '"
operator|+
name|status
operator|+
literal|"'"
argument_list|,
name|status
operator|.
name|startsWith
argument_list|(
literal|"Safe mode is ON."
operator|+
literal|"The reported blocks 0 needs additional 3 blocks to reach"
argument_list|)
argument_list|)
expr_stmt|;
comment|// Initiate a failover into it while it's in safemode
name|banner
argument_list|(
literal|"Initiating a failover into NN1 in safemode"
argument_list|)
expr_stmt|;
name|NameNodeAdapter
operator|.
name|abortEditLogs
argument_list|(
name|nn0
argument_list|)
expr_stmt|;
name|cluster
operator|.
name|transitionToActive
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|status
operator|=
name|nn1
operator|.
name|getNamesystem
argument_list|()
operator|.
name|getSafemode
argument_list|()
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Bad safemode status: '"
operator|+
name|status
operator|+
literal|"'"
argument_list|,
name|status
operator|.
name|startsWith
argument_list|(
literal|"Safe mode is ON."
operator|+
literal|"The reported blocks 5 has reached the threshold 0.9990 of "
operator|+
literal|"total blocks 5. Safe mode will be turned off automatically"
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/**    * Regression test for HDFS-2753. In this bug, the following sequence was    * observed:    * - Some blocks are written to DNs while the SBN was down. This causes    *   the blockReceived messages to get queued in the BPServiceActor on the    *   DN.    * - When the SBN returns, the DN re-registers with the SBN, and then    *   flushes its blockReceived queue to the SBN before it sends its    *   first block report. This caused the first block report to be    *   incorrect ignored.    * - The SBN would become stuck in safemode.    */
annotation|@
name|Test
DECL|method|testBlocksAddedWhileStandbyIsDown ()
specifier|public
name|void
name|testBlocksAddedWhileStandbyIsDown
parameter_list|()
throws|throws
name|Exception
block|{
name|DFSTestUtil
operator|.
name|createFile
argument_list|(
name|fs
argument_list|,
operator|new
name|Path
argument_list|(
literal|"/test"
argument_list|)
argument_list|,
literal|3
operator|*
name|BLOCK_SIZE
argument_list|,
operator|(
name|short
operator|)
literal|3
argument_list|,
literal|1L
argument_list|)
expr_stmt|;
name|banner
argument_list|(
literal|"Stopping standby"
argument_list|)
expr_stmt|;
name|cluster
operator|.
name|shutdownNameNode
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|DFSTestUtil
operator|.
name|createFile
argument_list|(
name|fs
argument_list|,
operator|new
name|Path
argument_list|(
literal|"/test2"
argument_list|)
argument_list|,
literal|3
operator|*
name|BLOCK_SIZE
argument_list|,
operator|(
name|short
operator|)
literal|3
argument_list|,
literal|1L
argument_list|)
expr_stmt|;
name|banner
argument_list|(
literal|"Rolling edit log so standby gets all edits on restart"
argument_list|)
expr_stmt|;
name|nn0
operator|.
name|getRpcServer
argument_list|()
operator|.
name|rollEditLog
argument_list|()
expr_stmt|;
name|restartStandby
argument_list|()
expr_stmt|;
name|String
name|status
init|=
name|nn1
operator|.
name|getNamesystem
argument_list|()
operator|.
name|getSafemode
argument_list|()
decl_stmt|;
name|assertTrue
argument_list|(
literal|"Bad safemode status: '"
operator|+
name|status
operator|+
literal|"'"
argument_list|,
name|status
operator|.
name|startsWith
argument_list|(
literal|"Safe mode is ON."
operator|+
literal|"The reported blocks 6 has reached the threshold 0.9990 of "
operator|+
literal|"total blocks 6. Safe mode will be turned off automatically"
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/**    * Print a big banner in the test log to make debug easier.    */
DECL|method|banner (String string)
specifier|static
name|void
name|banner
parameter_list|(
name|String
name|string
parameter_list|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"\n\n\n\n================================================\n"
operator|+
name|string
operator|+
literal|"\n"
operator|+
literal|"==================================================\n\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_class

end_unit

