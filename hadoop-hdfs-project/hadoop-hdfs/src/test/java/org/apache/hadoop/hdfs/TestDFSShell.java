begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/**  * Licensed to the Apache Software Foundation (ASF) under one  * or more contributor license agreements.  See the NOTICE file  * distributed with this work for additional information  * regarding copyright ownership.  The ASF licenses this file  * to you under the Apache License, Version 2.0 (the  * "License"); you may not use this file except in compliance  * with the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
DECL|package|org.apache.hadoop.hdfs
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|*
import|;
end_import

begin_import
import|import
name|java
operator|.
name|security
operator|.
name|Permission
import|;
end_import

begin_import
import|import
name|java
operator|.
name|security
operator|.
name|PrivilegedExceptionAction
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Arrays
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Random
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Scanner
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|atomic
operator|.
name|AtomicInteger
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|zip
operator|.
name|DeflaterOutputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|zip
operator|.
name|GZIPOutputStream
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|Log
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|LogFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|conf
operator|.
name|Configuration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|*
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|permission
operator|.
name|FsPermission
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|Block
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|BlockListAsLongs
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|server
operator|.
name|datanode
operator|.
name|DataNode
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|server
operator|.
name|datanode
operator|.
name|DataNodeTestUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|server
operator|.
name|protocol
operator|.
name|DatanodeStorage
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|tools
operator|.
name|DFSAdmin
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|IOUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|SequenceFile
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|Text
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|compress
operator|.
name|BZip2Codec
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|compress
operator|.
name|CompressionCodec
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|UserGroupInformation
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|test
operator|.
name|PathUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|util
operator|.
name|ReflectionUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|util
operator|.
name|StringUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|util
operator|.
name|ToolRunner
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Test
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|CommonConfigurationKeysPublic
operator|.
name|FS_TRASH_INTERVAL_KEY
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|hamcrest
operator|.
name|CoreMatchers
operator|.
name|is
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|hamcrest
operator|.
name|CoreMatchers
operator|.
name|not
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|junit
operator|.
name|Assert
operator|.
name|*
import|;
end_import

begin_comment
comment|/**  * This class tests commands from DFSShell.  */
end_comment

begin_class
DECL|class|TestDFSShell
specifier|public
class|class
name|TestDFSShell
block|{
DECL|field|LOG
specifier|private
specifier|static
specifier|final
name|Log
name|LOG
init|=
name|LogFactory
operator|.
name|getLog
argument_list|(
name|TestDFSShell
operator|.
name|class
argument_list|)
decl_stmt|;
DECL|field|counter
specifier|private
specifier|static
specifier|final
name|AtomicInteger
name|counter
init|=
operator|new
name|AtomicInteger
argument_list|()
decl_stmt|;
DECL|field|SUCCESS
specifier|private
specifier|final
name|int
name|SUCCESS
init|=
literal|0
decl_stmt|;
DECL|field|ERROR
specifier|private
specifier|final
name|int
name|ERROR
init|=
literal|1
decl_stmt|;
DECL|field|TEST_ROOT_DIR
specifier|static
specifier|final
name|String
name|TEST_ROOT_DIR
init|=
name|PathUtils
operator|.
name|getTestDirName
argument_list|(
name|TestDFSShell
operator|.
name|class
argument_list|)
decl_stmt|;
DECL|method|writeFile (FileSystem fs, Path f)
specifier|static
name|Path
name|writeFile
parameter_list|(
name|FileSystem
name|fs
parameter_list|,
name|Path
name|f
parameter_list|)
throws|throws
name|IOException
block|{
name|DataOutputStream
name|out
init|=
name|fs
operator|.
name|create
argument_list|(
name|f
argument_list|)
decl_stmt|;
name|out
operator|.
name|writeBytes
argument_list|(
literal|"dhruba: "
operator|+
name|f
argument_list|)
expr_stmt|;
name|out
operator|.
name|close
argument_list|()
expr_stmt|;
name|assertTrue
argument_list|(
name|fs
operator|.
name|exists
argument_list|(
name|f
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|f
return|;
block|}
DECL|method|mkdir (FileSystem fs, Path p)
specifier|static
name|Path
name|mkdir
parameter_list|(
name|FileSystem
name|fs
parameter_list|,
name|Path
name|p
parameter_list|)
throws|throws
name|IOException
block|{
name|assertTrue
argument_list|(
name|fs
operator|.
name|mkdirs
argument_list|(
name|p
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|fs
operator|.
name|exists
argument_list|(
name|p
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|fs
operator|.
name|getFileStatus
argument_list|(
name|p
argument_list|)
operator|.
name|isDirectory
argument_list|()
argument_list|)
expr_stmt|;
return|return
name|p
return|;
block|}
DECL|method|createLocalFile (File f)
specifier|static
name|File
name|createLocalFile
parameter_list|(
name|File
name|f
parameter_list|)
throws|throws
name|IOException
block|{
name|assertTrue
argument_list|(
operator|!
name|f
operator|.
name|exists
argument_list|()
argument_list|)
expr_stmt|;
name|PrintWriter
name|out
init|=
operator|new
name|PrintWriter
argument_list|(
name|f
argument_list|)
decl_stmt|;
name|out
operator|.
name|print
argument_list|(
literal|"createLocalFile: "
operator|+
name|f
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
expr_stmt|;
name|out
operator|.
name|flush
argument_list|()
expr_stmt|;
name|out
operator|.
name|close
argument_list|()
expr_stmt|;
name|assertTrue
argument_list|(
name|f
operator|.
name|exists
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|f
operator|.
name|isFile
argument_list|()
argument_list|)
expr_stmt|;
return|return
name|f
return|;
block|}
DECL|method|createLocalFileWithRandomData (int fileLength, File f)
specifier|static
name|File
name|createLocalFileWithRandomData
parameter_list|(
name|int
name|fileLength
parameter_list|,
name|File
name|f
parameter_list|)
throws|throws
name|IOException
block|{
name|assertTrue
argument_list|(
operator|!
name|f
operator|.
name|exists
argument_list|()
argument_list|)
expr_stmt|;
name|f
operator|.
name|createNewFile
argument_list|()
expr_stmt|;
name|FileOutputStream
name|out
init|=
operator|new
name|FileOutputStream
argument_list|(
name|f
operator|.
name|toString
argument_list|()
argument_list|)
decl_stmt|;
name|byte
index|[]
name|buffer
init|=
operator|new
name|byte
index|[
name|fileLength
index|]
decl_stmt|;
name|out
operator|.
name|write
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|out
operator|.
name|flush
argument_list|()
expr_stmt|;
name|out
operator|.
name|close
argument_list|()
expr_stmt|;
return|return
name|f
return|;
block|}
DECL|method|show (String s)
specifier|static
name|void
name|show
parameter_list|(
name|String
name|s
parameter_list|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getStackTrace
argument_list|()
index|[
literal|2
index|]
operator|+
literal|" "
operator|+
name|s
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
argument_list|(
name|timeout
operator|=
literal|30000
argument_list|)
DECL|method|testZeroSizeFile ()
specifier|public
name|void
name|testZeroSizeFile
parameter_list|()
throws|throws
name|IOException
block|{
name|Configuration
name|conf
init|=
operator|new
name|HdfsConfiguration
argument_list|()
decl_stmt|;
name|MiniDFSCluster
name|cluster
init|=
operator|new
name|MiniDFSCluster
operator|.
name|Builder
argument_list|(
name|conf
argument_list|)
operator|.
name|numDataNodes
argument_list|(
literal|2
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
name|FileSystem
name|fs
init|=
name|cluster
operator|.
name|getFileSystem
argument_list|()
decl_stmt|;
name|assertTrue
argument_list|(
literal|"Not a HDFS: "
operator|+
name|fs
operator|.
name|getUri
argument_list|()
argument_list|,
name|fs
operator|instanceof
name|DistributedFileSystem
argument_list|)
expr_stmt|;
specifier|final
name|DistributedFileSystem
name|dfs
init|=
operator|(
name|DistributedFileSystem
operator|)
name|fs
decl_stmt|;
try|try
block|{
comment|//create a zero size file
specifier|final
name|File
name|f1
init|=
operator|new
name|File
argument_list|(
name|TEST_ROOT_DIR
argument_list|,
literal|"f1"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
operator|!
name|f1
operator|.
name|exists
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|f1
operator|.
name|createNewFile
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|f1
operator|.
name|exists
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|f1
operator|.
name|isFile
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|0L
argument_list|,
name|f1
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
comment|//copy to remote
specifier|final
name|Path
name|root
init|=
name|mkdir
argument_list|(
name|dfs
argument_list|,
operator|new
name|Path
argument_list|(
literal|"/test/zeroSizeFile"
argument_list|)
argument_list|)
decl_stmt|;
specifier|final
name|Path
name|remotef
init|=
operator|new
name|Path
argument_list|(
name|root
argument_list|,
literal|"dst"
argument_list|)
decl_stmt|;
name|show
argument_list|(
literal|"copy local "
operator|+
name|f1
operator|+
literal|" to remote "
operator|+
name|remotef
argument_list|)
expr_stmt|;
name|dfs
operator|.
name|copyFromLocalFile
argument_list|(
literal|false
argument_list|,
literal|false
argument_list|,
operator|new
name|Path
argument_list|(
name|f1
operator|.
name|getPath
argument_list|()
argument_list|)
argument_list|,
name|remotef
argument_list|)
expr_stmt|;
comment|//getBlockSize() should not throw exception
name|show
argument_list|(
literal|"Block size = "
operator|+
name|dfs
operator|.
name|getFileStatus
argument_list|(
name|remotef
argument_list|)
operator|.
name|getBlockSize
argument_list|()
argument_list|)
expr_stmt|;
comment|//copy back
specifier|final
name|File
name|f2
init|=
operator|new
name|File
argument_list|(
name|TEST_ROOT_DIR
argument_list|,
literal|"f2"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
operator|!
name|f2
operator|.
name|exists
argument_list|()
argument_list|)
expr_stmt|;
name|dfs
operator|.
name|copyToLocalFile
argument_list|(
name|remotef
argument_list|,
operator|new
name|Path
argument_list|(
name|f2
operator|.
name|getPath
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|f2
operator|.
name|exists
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|f2
operator|.
name|isFile
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|0L
argument_list|,
name|f2
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|f1
operator|.
name|delete
argument_list|()
expr_stmt|;
name|f2
operator|.
name|delete
argument_list|()
expr_stmt|;
block|}
finally|finally
block|{
try|try
block|{
name|dfs
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{}
name|cluster
operator|.
name|shutdown
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
argument_list|(
name|timeout
operator|=
literal|30000
argument_list|)
DECL|method|testRecrusiveRm ()
specifier|public
name|void
name|testRecrusiveRm
parameter_list|()
throws|throws
name|IOException
block|{
name|Configuration
name|conf
init|=
operator|new
name|HdfsConfiguration
argument_list|()
decl_stmt|;
name|MiniDFSCluster
name|cluster
init|=
operator|new
name|MiniDFSCluster
operator|.
name|Builder
argument_list|(
name|conf
argument_list|)
operator|.
name|numDataNodes
argument_list|(
literal|2
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
name|FileSystem
name|fs
init|=
name|cluster
operator|.
name|getFileSystem
argument_list|()
decl_stmt|;
name|assertTrue
argument_list|(
literal|"Not a HDFS: "
operator|+
name|fs
operator|.
name|getUri
argument_list|()
argument_list|,
name|fs
operator|instanceof
name|DistributedFileSystem
argument_list|)
expr_stmt|;
try|try
block|{
name|fs
operator|.
name|mkdirs
argument_list|(
operator|new
name|Path
argument_list|(
operator|new
name|Path
argument_list|(
literal|"parent"
argument_list|)
argument_list|,
literal|"child"
argument_list|)
argument_list|)
expr_stmt|;
try|try
block|{
name|fs
operator|.
name|delete
argument_list|(
operator|new
name|Path
argument_list|(
literal|"parent"
argument_list|)
argument_list|,
literal|false
argument_list|)
expr_stmt|;
assert|assert
operator|(
literal|false
operator|)
assert|;
comment|// should never reach here.
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
comment|//should have thrown an exception
block|}
try|try
block|{
name|fs
operator|.
name|delete
argument_list|(
operator|new
name|Path
argument_list|(
literal|"parent"
argument_list|)
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
assert|assert
operator|(
literal|false
operator|)
assert|;
block|}
block|}
finally|finally
block|{
try|try
block|{
name|fs
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{}
empty_stmt|;
name|cluster
operator|.
name|shutdown
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
argument_list|(
name|timeout
operator|=
literal|30000
argument_list|)
DECL|method|testDu ()
specifier|public
name|void
name|testDu
parameter_list|()
throws|throws
name|IOException
block|{
name|Configuration
name|conf
init|=
operator|new
name|HdfsConfiguration
argument_list|()
decl_stmt|;
name|MiniDFSCluster
name|cluster
init|=
operator|new
name|MiniDFSCluster
operator|.
name|Builder
argument_list|(
name|conf
argument_list|)
operator|.
name|numDataNodes
argument_list|(
literal|2
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
name|DistributedFileSystem
name|fs
init|=
name|cluster
operator|.
name|getFileSystem
argument_list|()
decl_stmt|;
name|PrintStream
name|psBackup
init|=
name|System
operator|.
name|out
decl_stmt|;
name|ByteArrayOutputStream
name|out
init|=
operator|new
name|ByteArrayOutputStream
argument_list|()
decl_stmt|;
name|PrintStream
name|psOut
init|=
operator|new
name|PrintStream
argument_list|(
name|out
argument_list|)
decl_stmt|;
name|System
operator|.
name|setOut
argument_list|(
name|psOut
argument_list|)
expr_stmt|;
name|FsShell
name|shell
init|=
operator|new
name|FsShell
argument_list|()
decl_stmt|;
name|shell
operator|.
name|setConf
argument_list|(
name|conf
argument_list|)
expr_stmt|;
try|try
block|{
name|Path
name|myPath
init|=
operator|new
name|Path
argument_list|(
literal|"/test/dir"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|fs
operator|.
name|mkdirs
argument_list|(
name|myPath
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|fs
operator|.
name|exists
argument_list|(
name|myPath
argument_list|)
argument_list|)
expr_stmt|;
name|Path
name|myFile
init|=
operator|new
name|Path
argument_list|(
literal|"/test/dir/file"
argument_list|)
decl_stmt|;
name|writeFile
argument_list|(
name|fs
argument_list|,
name|myFile
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|fs
operator|.
name|exists
argument_list|(
name|myFile
argument_list|)
argument_list|)
expr_stmt|;
name|Path
name|myFile2
init|=
operator|new
name|Path
argument_list|(
literal|"/test/dir/file2"
argument_list|)
decl_stmt|;
name|writeFile
argument_list|(
name|fs
argument_list|,
name|myFile2
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|fs
operator|.
name|exists
argument_list|(
name|myFile2
argument_list|)
argument_list|)
expr_stmt|;
name|String
index|[]
name|args
init|=
operator|new
name|String
index|[
literal|2
index|]
decl_stmt|;
name|args
index|[
literal|0
index|]
operator|=
literal|"-du"
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|=
literal|"/test/dir"
expr_stmt|;
name|int
name|val
init|=
operator|-
literal|1
decl_stmt|;
try|try
block|{
name|val
operator|=
name|shell
operator|.
name|run
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Exception raised from DFSShell.run "
operator|+
name|e
operator|.
name|getLocalizedMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|assertTrue
argument_list|(
name|val
operator|==
literal|0
argument_list|)
expr_stmt|;
name|String
name|returnString
init|=
name|out
operator|.
name|toString
argument_list|()
decl_stmt|;
name|out
operator|.
name|reset
argument_list|()
expr_stmt|;
comment|// Check if size matchs as expected
name|assertTrue
argument_list|(
name|returnString
operator|.
name|contains
argument_list|(
literal|"22"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|returnString
operator|.
name|contains
argument_list|(
literal|"23"
argument_list|)
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|System
operator|.
name|setOut
argument_list|(
name|psBackup
argument_list|)
expr_stmt|;
name|cluster
operator|.
name|shutdown
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
argument_list|(
name|timeout
operator|=
literal|30000
argument_list|)
DECL|method|testPut ()
specifier|public
name|void
name|testPut
parameter_list|()
throws|throws
name|IOException
block|{
name|Configuration
name|conf
init|=
operator|new
name|HdfsConfiguration
argument_list|()
decl_stmt|;
name|MiniDFSCluster
name|cluster
init|=
operator|new
name|MiniDFSCluster
operator|.
name|Builder
argument_list|(
name|conf
argument_list|)
operator|.
name|numDataNodes
argument_list|(
literal|2
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
name|FileSystem
name|fs
init|=
name|cluster
operator|.
name|getFileSystem
argument_list|()
decl_stmt|;
name|assertTrue
argument_list|(
literal|"Not a HDFS: "
operator|+
name|fs
operator|.
name|getUri
argument_list|()
argument_list|,
name|fs
operator|instanceof
name|DistributedFileSystem
argument_list|)
expr_stmt|;
specifier|final
name|DistributedFileSystem
name|dfs
init|=
operator|(
name|DistributedFileSystem
operator|)
name|fs
decl_stmt|;
try|try
block|{
comment|// remove left over crc files:
operator|new
name|File
argument_list|(
name|TEST_ROOT_DIR
argument_list|,
literal|".f1.crc"
argument_list|)
operator|.
name|delete
argument_list|()
expr_stmt|;
operator|new
name|File
argument_list|(
name|TEST_ROOT_DIR
argument_list|,
literal|".f2.crc"
argument_list|)
operator|.
name|delete
argument_list|()
expr_stmt|;
specifier|final
name|File
name|f1
init|=
name|createLocalFile
argument_list|(
operator|new
name|File
argument_list|(
name|TEST_ROOT_DIR
argument_list|,
literal|"f1"
argument_list|)
argument_list|)
decl_stmt|;
specifier|final
name|File
name|f2
init|=
name|createLocalFile
argument_list|(
operator|new
name|File
argument_list|(
name|TEST_ROOT_DIR
argument_list|,
literal|"f2"
argument_list|)
argument_list|)
decl_stmt|;
specifier|final
name|Path
name|root
init|=
name|mkdir
argument_list|(
name|dfs
argument_list|,
operator|new
name|Path
argument_list|(
literal|"/test/put"
argument_list|)
argument_list|)
decl_stmt|;
specifier|final
name|Path
name|dst
init|=
operator|new
name|Path
argument_list|(
name|root
argument_list|,
literal|"dst"
argument_list|)
decl_stmt|;
name|show
argument_list|(
literal|"begin"
argument_list|)
expr_stmt|;
specifier|final
name|Thread
name|copy2ndFileThread
init|=
operator|new
name|Thread
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|run
parameter_list|()
block|{
try|try
block|{
name|show
argument_list|(
literal|"copy local "
operator|+
name|f2
operator|+
literal|" to remote "
operator|+
name|dst
argument_list|)
expr_stmt|;
name|dfs
operator|.
name|copyFromLocalFile
argument_list|(
literal|false
argument_list|,
literal|false
argument_list|,
operator|new
name|Path
argument_list|(
name|f2
operator|.
name|getPath
argument_list|()
argument_list|)
argument_list|,
name|dst
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ioe
parameter_list|)
block|{
name|show
argument_list|(
literal|"good "
operator|+
name|StringUtils
operator|.
name|stringifyException
argument_list|(
name|ioe
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|//should not be here, must got IOException
name|assertTrue
argument_list|(
literal|false
argument_list|)
expr_stmt|;
block|}
block|}
decl_stmt|;
comment|//use SecurityManager to pause the copying of f1 and begin copying f2
name|SecurityManager
name|sm
init|=
name|System
operator|.
name|getSecurityManager
argument_list|()
decl_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"SecurityManager = "
operator|+
name|sm
argument_list|)
expr_stmt|;
name|System
operator|.
name|setSecurityManager
argument_list|(
operator|new
name|SecurityManager
argument_list|()
block|{
specifier|private
name|boolean
name|firstTime
init|=
literal|true
decl_stmt|;
annotation|@
name|Override
specifier|public
name|void
name|checkPermission
parameter_list|(
name|Permission
name|perm
parameter_list|)
block|{
if|if
condition|(
name|firstTime
condition|)
block|{
name|Thread
name|t
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|t
operator|.
name|toString
argument_list|()
operator|.
name|contains
argument_list|(
literal|"DataNode"
argument_list|)
condition|)
block|{
name|String
name|s
init|=
literal|""
operator|+
name|Arrays
operator|.
name|asList
argument_list|(
name|t
operator|.
name|getStackTrace
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|s
operator|.
name|contains
argument_list|(
literal|"FileUtil.copyContent"
argument_list|)
condition|)
block|{
comment|//pause at FileUtil.copyContent
name|firstTime
operator|=
literal|false
expr_stmt|;
name|copy2ndFileThread
operator|.
name|start
argument_list|()
expr_stmt|;
try|try
block|{
name|Thread
operator|.
name|sleep
argument_list|(
literal|5000
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|e
parameter_list|)
block|{}
block|}
block|}
block|}
block|}
block|}
argument_list|)
expr_stmt|;
name|show
argument_list|(
literal|"copy local "
operator|+
name|f1
operator|+
literal|" to remote "
operator|+
name|dst
argument_list|)
expr_stmt|;
name|dfs
operator|.
name|copyFromLocalFile
argument_list|(
literal|false
argument_list|,
literal|false
argument_list|,
operator|new
name|Path
argument_list|(
name|f1
operator|.
name|getPath
argument_list|()
argument_list|)
argument_list|,
name|dst
argument_list|)
expr_stmt|;
name|show
argument_list|(
literal|"done"
argument_list|)
expr_stmt|;
try|try
block|{
name|copy2ndFileThread
operator|.
name|join
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|e
parameter_list|)
block|{ }
name|System
operator|.
name|setSecurityManager
argument_list|(
name|sm
argument_list|)
expr_stmt|;
comment|// copy multiple files to destination directory
specifier|final
name|Path
name|destmultiple
init|=
name|mkdir
argument_list|(
name|dfs
argument_list|,
operator|new
name|Path
argument_list|(
literal|"/test/putmultiple"
argument_list|)
argument_list|)
decl_stmt|;
name|Path
index|[]
name|srcs
init|=
operator|new
name|Path
index|[
literal|2
index|]
decl_stmt|;
name|srcs
index|[
literal|0
index|]
operator|=
operator|new
name|Path
argument_list|(
name|f1
operator|.
name|getPath
argument_list|()
argument_list|)
expr_stmt|;
name|srcs
index|[
literal|1
index|]
operator|=
operator|new
name|Path
argument_list|(
name|f2
operator|.
name|getPath
argument_list|()
argument_list|)
expr_stmt|;
name|dfs
operator|.
name|copyFromLocalFile
argument_list|(
literal|false
argument_list|,
literal|false
argument_list|,
name|srcs
argument_list|,
name|destmultiple
argument_list|)
expr_stmt|;
name|srcs
index|[
literal|0
index|]
operator|=
operator|new
name|Path
argument_list|(
name|destmultiple
argument_list|,
literal|"f1"
argument_list|)
expr_stmt|;
name|srcs
index|[
literal|1
index|]
operator|=
operator|new
name|Path
argument_list|(
name|destmultiple
argument_list|,
literal|"f2"
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|dfs
operator|.
name|exists
argument_list|(
name|srcs
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|dfs
operator|.
name|exists
argument_list|(
name|srcs
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
comment|// move multiple files to destination directory
specifier|final
name|Path
name|destmultiple2
init|=
name|mkdir
argument_list|(
name|dfs
argument_list|,
operator|new
name|Path
argument_list|(
literal|"/test/movemultiple"
argument_list|)
argument_list|)
decl_stmt|;
name|srcs
index|[
literal|0
index|]
operator|=
operator|new
name|Path
argument_list|(
name|f1
operator|.
name|getPath
argument_list|()
argument_list|)
expr_stmt|;
name|srcs
index|[
literal|1
index|]
operator|=
operator|new
name|Path
argument_list|(
name|f2
operator|.
name|getPath
argument_list|()
argument_list|)
expr_stmt|;
name|dfs
operator|.
name|moveFromLocalFile
argument_list|(
name|srcs
argument_list|,
name|destmultiple2
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|f1
operator|.
name|exists
argument_list|()
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|f2
operator|.
name|exists
argument_list|()
argument_list|)
expr_stmt|;
name|srcs
index|[
literal|0
index|]
operator|=
operator|new
name|Path
argument_list|(
name|destmultiple2
argument_list|,
literal|"f1"
argument_list|)
expr_stmt|;
name|srcs
index|[
literal|1
index|]
operator|=
operator|new
name|Path
argument_list|(
name|destmultiple2
argument_list|,
literal|"f2"
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|dfs
operator|.
name|exists
argument_list|(
name|srcs
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|dfs
operator|.
name|exists
argument_list|(
name|srcs
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|f1
operator|.
name|delete
argument_list|()
expr_stmt|;
name|f2
operator|.
name|delete
argument_list|()
expr_stmt|;
block|}
finally|finally
block|{
try|try
block|{
name|dfs
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{}
name|cluster
operator|.
name|shutdown
argument_list|()
expr_stmt|;
block|}
block|}
comment|/** check command error outputs and exit statuses. */
annotation|@
name|Test
argument_list|(
name|timeout
operator|=
literal|30000
argument_list|)
DECL|method|testErrOutPut ()
specifier|public
name|void
name|testErrOutPut
parameter_list|()
throws|throws
name|Exception
block|{
name|Configuration
name|conf
init|=
operator|new
name|HdfsConfiguration
argument_list|()
decl_stmt|;
name|MiniDFSCluster
name|cluster
init|=
literal|null
decl_stmt|;
name|PrintStream
name|bak
init|=
literal|null
decl_stmt|;
try|try
block|{
name|cluster
operator|=
operator|new
name|MiniDFSCluster
operator|.
name|Builder
argument_list|(
name|conf
argument_list|)
operator|.
name|numDataNodes
argument_list|(
literal|2
argument_list|)
operator|.
name|build
argument_list|()
expr_stmt|;
name|FileSystem
name|srcFs
init|=
name|cluster
operator|.
name|getFileSystem
argument_list|()
decl_stmt|;
name|Path
name|root
init|=
operator|new
name|Path
argument_list|(
literal|"/nonexistentfile"
argument_list|)
decl_stmt|;
name|bak
operator|=
name|System
operator|.
name|err
expr_stmt|;
name|ByteArrayOutputStream
name|out
init|=
operator|new
name|ByteArrayOutputStream
argument_list|()
decl_stmt|;
name|PrintStream
name|tmp
init|=
operator|new
name|PrintStream
argument_list|(
name|out
argument_list|)
decl_stmt|;
name|System
operator|.
name|setErr
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|String
index|[]
name|argv
init|=
operator|new
name|String
index|[
literal|2
index|]
decl_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
literal|"-cat"
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
name|root
operator|.
name|toUri
argument_list|()
operator|.
name|getPath
argument_list|()
expr_stmt|;
name|int
name|ret
init|=
name|ToolRunner
operator|.
name|run
argument_list|(
operator|new
name|FsShell
argument_list|()
argument_list|,
name|argv
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|" -cat returned 1 "
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|String
name|returned
init|=
name|out
operator|.
name|toString
argument_list|()
decl_stmt|;
name|assertTrue
argument_list|(
literal|"cat does not print exceptions "
argument_list|,
operator|(
name|returned
operator|.
name|lastIndexOf
argument_list|(
literal|"Exception"
argument_list|)
operator|==
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|out
operator|.
name|reset
argument_list|()
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
literal|"-rm"
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
name|root
operator|.
name|toString
argument_list|()
expr_stmt|;
name|FsShell
name|shell
init|=
operator|new
name|FsShell
argument_list|()
decl_stmt|;
name|shell
operator|.
name|setConf
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|" -rm returned 1 "
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|returned
operator|=
name|out
operator|.
name|toString
argument_list|()
expr_stmt|;
name|out
operator|.
name|reset
argument_list|()
expr_stmt|;
name|assertTrue
argument_list|(
literal|"rm prints reasonable error "
argument_list|,
operator|(
name|returned
operator|.
name|lastIndexOf
argument_list|(
literal|"No such file or directory"
argument_list|)
operator|!=
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
literal|"-rmr"
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
name|root
operator|.
name|toString
argument_list|()
expr_stmt|;
name|ret
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|" -rmr returned 1"
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|returned
operator|=
name|out
operator|.
name|toString
argument_list|()
expr_stmt|;
name|assertTrue
argument_list|(
literal|"rmr prints reasonable error "
argument_list|,
operator|(
name|returned
operator|.
name|lastIndexOf
argument_list|(
literal|"No such file or directory"
argument_list|)
operator|!=
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|out
operator|.
name|reset
argument_list|()
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
literal|"-du"
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
literal|"/nonexistentfile"
expr_stmt|;
name|ret
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|returned
operator|=
name|out
operator|.
name|toString
argument_list|()
expr_stmt|;
name|assertTrue
argument_list|(
literal|" -du prints reasonable error "
argument_list|,
operator|(
name|returned
operator|.
name|lastIndexOf
argument_list|(
literal|"No such file or directory"
argument_list|)
operator|!=
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|out
operator|.
name|reset
argument_list|()
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
literal|"-dus"
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
literal|"/nonexistentfile"
expr_stmt|;
name|ret
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|returned
operator|=
name|out
operator|.
name|toString
argument_list|()
expr_stmt|;
name|assertTrue
argument_list|(
literal|" -dus prints reasonable error"
argument_list|,
operator|(
name|returned
operator|.
name|lastIndexOf
argument_list|(
literal|"No such file or directory"
argument_list|)
operator|!=
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|out
operator|.
name|reset
argument_list|()
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
literal|"-ls"
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
literal|"/nonexistenfile"
expr_stmt|;
name|ret
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|returned
operator|=
name|out
operator|.
name|toString
argument_list|()
expr_stmt|;
name|assertTrue
argument_list|(
literal|" -ls does not return Found 0 items"
argument_list|,
operator|(
name|returned
operator|.
name|lastIndexOf
argument_list|(
literal|"Found 0"
argument_list|)
operator|==
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|out
operator|.
name|reset
argument_list|()
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
literal|"-ls"
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
literal|"/nonexistentfile"
expr_stmt|;
name|ret
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|" -lsr should fail "
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|out
operator|.
name|reset
argument_list|()
expr_stmt|;
name|srcFs
operator|.
name|mkdirs
argument_list|(
operator|new
name|Path
argument_list|(
literal|"/testdir"
argument_list|)
argument_list|)
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
literal|"-ls"
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
literal|"/testdir"
expr_stmt|;
name|ret
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|returned
operator|=
name|out
operator|.
name|toString
argument_list|()
expr_stmt|;
name|assertTrue
argument_list|(
literal|" -ls does not print out anything "
argument_list|,
operator|(
name|returned
operator|.
name|lastIndexOf
argument_list|(
literal|"Found 0"
argument_list|)
operator|==
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|out
operator|.
name|reset
argument_list|()
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
literal|"-ls"
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
literal|"/user/nonxistant/*"
expr_stmt|;
name|ret
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|" -ls on nonexistent glob returns 1"
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|out
operator|.
name|reset
argument_list|()
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
literal|"-mkdir"
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
literal|"/testdir"
expr_stmt|;
name|ret
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|returned
operator|=
name|out
operator|.
name|toString
argument_list|()
expr_stmt|;
name|assertEquals
argument_list|(
literal|" -mkdir returned 1 "
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|" -mkdir returned File exists"
argument_list|,
operator|(
name|returned
operator|.
name|lastIndexOf
argument_list|(
literal|"File exists"
argument_list|)
operator|!=
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|Path
name|testFile
init|=
operator|new
name|Path
argument_list|(
literal|"/testfile"
argument_list|)
decl_stmt|;
name|OutputStream
name|outtmp
init|=
name|srcFs
operator|.
name|create
argument_list|(
name|testFile
argument_list|)
decl_stmt|;
name|outtmp
operator|.
name|write
argument_list|(
name|testFile
operator|.
name|toString
argument_list|()
operator|.
name|getBytes
argument_list|()
argument_list|)
expr_stmt|;
name|outtmp
operator|.
name|close
argument_list|()
expr_stmt|;
name|out
operator|.
name|reset
argument_list|()
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
literal|"-mkdir"
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
literal|"/testfile"
expr_stmt|;
name|ret
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|returned
operator|=
name|out
operator|.
name|toString
argument_list|()
expr_stmt|;
name|assertEquals
argument_list|(
literal|" -mkdir returned 1"
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|" -mkdir returned this is a file "
argument_list|,
operator|(
name|returned
operator|.
name|lastIndexOf
argument_list|(
literal|"not a directory"
argument_list|)
operator|!=
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|out
operator|.
name|reset
argument_list|()
expr_stmt|;
name|argv
operator|=
operator|new
name|String
index|[
literal|3
index|]
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
literal|"-mv"
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
literal|"/testfile"
expr_stmt|;
name|argv
index|[
literal|2
index|]
operator|=
literal|"file"
expr_stmt|;
name|ret
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"mv failed to rename"
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|out
operator|.
name|reset
argument_list|()
expr_stmt|;
name|argv
operator|=
operator|new
name|String
index|[
literal|3
index|]
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
literal|"-mv"
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
literal|"/testfile"
expr_stmt|;
name|argv
index|[
literal|2
index|]
operator|=
literal|"/testfiletest"
expr_stmt|;
name|ret
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|returned
operator|=
name|out
operator|.
name|toString
argument_list|()
expr_stmt|;
name|assertTrue
argument_list|(
literal|"no output from rename"
argument_list|,
operator|(
name|returned
operator|.
name|lastIndexOf
argument_list|(
literal|"Renamed"
argument_list|)
operator|==
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|out
operator|.
name|reset
argument_list|()
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
literal|"-mv"
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
literal|"/testfile"
expr_stmt|;
name|argv
index|[
literal|2
index|]
operator|=
literal|"/testfiletmp"
expr_stmt|;
name|ret
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|returned
operator|=
name|out
operator|.
name|toString
argument_list|()
expr_stmt|;
name|assertTrue
argument_list|(
literal|" unix like output"
argument_list|,
operator|(
name|returned
operator|.
name|lastIndexOf
argument_list|(
literal|"No such file or"
argument_list|)
operator|!=
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|out
operator|.
name|reset
argument_list|()
expr_stmt|;
name|argv
operator|=
operator|new
name|String
index|[
literal|1
index|]
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
literal|"-du"
expr_stmt|;
name|srcFs
operator|.
name|mkdirs
argument_list|(
name|srcFs
operator|.
name|getHomeDirectory
argument_list|()
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|returned
operator|=
name|out
operator|.
name|toString
argument_list|()
expr_stmt|;
name|assertEquals
argument_list|(
literal|" no error "
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"empty path specified"
argument_list|,
operator|(
name|returned
operator|.
name|lastIndexOf
argument_list|(
literal|"empty string"
argument_list|)
operator|==
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|out
operator|.
name|reset
argument_list|()
expr_stmt|;
name|argv
operator|=
operator|new
name|String
index|[
literal|3
index|]
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
literal|"-test"
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
literal|"-d"
expr_stmt|;
name|argv
index|[
literal|2
index|]
operator|=
literal|"/no/such/dir"
expr_stmt|;
name|ret
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|returned
operator|=
name|out
operator|.
name|toString
argument_list|()
expr_stmt|;
name|assertEquals
argument_list|(
literal|" -test -d wrong result "
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|returned
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
name|bak
operator|!=
literal|null
condition|)
block|{
name|System
operator|.
name|setErr
argument_list|(
name|bak
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cluster
operator|!=
literal|null
condition|)
block|{
name|cluster
operator|.
name|shutdown
argument_list|()
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Test
argument_list|(
name|timeout
operator|=
literal|30000
argument_list|)
DECL|method|testURIPaths ()
specifier|public
name|void
name|testURIPaths
parameter_list|()
throws|throws
name|Exception
block|{
name|Configuration
name|srcConf
init|=
operator|new
name|HdfsConfiguration
argument_list|()
decl_stmt|;
name|Configuration
name|dstConf
init|=
operator|new
name|HdfsConfiguration
argument_list|()
decl_stmt|;
name|MiniDFSCluster
name|srcCluster
init|=
literal|null
decl_stmt|;
name|MiniDFSCluster
name|dstCluster
init|=
literal|null
decl_stmt|;
name|File
name|bak
init|=
operator|new
name|File
argument_list|(
name|PathUtils
operator|.
name|getTestDir
argument_list|(
name|getClass
argument_list|()
argument_list|)
argument_list|,
literal|"dfs_tmp_uri"
argument_list|)
decl_stmt|;
name|bak
operator|.
name|mkdirs
argument_list|()
expr_stmt|;
try|try
block|{
name|srcCluster
operator|=
operator|new
name|MiniDFSCluster
operator|.
name|Builder
argument_list|(
name|srcConf
argument_list|)
operator|.
name|numDataNodes
argument_list|(
literal|2
argument_list|)
operator|.
name|build
argument_list|()
expr_stmt|;
name|dstConf
operator|.
name|set
argument_list|(
name|MiniDFSCluster
operator|.
name|HDFS_MINIDFS_BASEDIR
argument_list|,
name|bak
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
expr_stmt|;
name|dstCluster
operator|=
operator|new
name|MiniDFSCluster
operator|.
name|Builder
argument_list|(
name|dstConf
argument_list|)
operator|.
name|numDataNodes
argument_list|(
literal|2
argument_list|)
operator|.
name|build
argument_list|()
expr_stmt|;
name|FileSystem
name|srcFs
init|=
name|srcCluster
operator|.
name|getFileSystem
argument_list|()
decl_stmt|;
name|FileSystem
name|dstFs
init|=
name|dstCluster
operator|.
name|getFileSystem
argument_list|()
decl_stmt|;
name|FsShell
name|shell
init|=
operator|new
name|FsShell
argument_list|()
decl_stmt|;
name|shell
operator|.
name|setConf
argument_list|(
name|srcConf
argument_list|)
expr_stmt|;
comment|//check for ls
name|String
index|[]
name|argv
init|=
operator|new
name|String
index|[
literal|2
index|]
decl_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
literal|"-ls"
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
name|dstFs
operator|.
name|getUri
argument_list|()
operator|.
name|toString
argument_list|()
operator|+
literal|"/"
expr_stmt|;
name|int
name|ret
init|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"ls works on remote uri "
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|)
expr_stmt|;
comment|//check for rm -r
name|dstFs
operator|.
name|mkdirs
argument_list|(
operator|new
name|Path
argument_list|(
literal|"/hadoopdir"
argument_list|)
argument_list|)
expr_stmt|;
name|argv
operator|=
operator|new
name|String
index|[
literal|2
index|]
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
literal|"-rmr"
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
name|dstFs
operator|.
name|getUri
argument_list|()
operator|.
name|toString
argument_list|()
operator|+
literal|"/hadoopdir"
expr_stmt|;
name|ret
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"-rmr works on remote uri "
operator|+
name|argv
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|)
expr_stmt|;
comment|//check du
name|argv
index|[
literal|0
index|]
operator|=
literal|"-du"
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
name|dstFs
operator|.
name|getUri
argument_list|()
operator|.
name|toString
argument_list|()
operator|+
literal|"/"
expr_stmt|;
name|ret
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"du works on remote uri "
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|)
expr_stmt|;
comment|//check put
name|File
name|furi
init|=
operator|new
name|File
argument_list|(
name|TEST_ROOT_DIR
argument_list|,
literal|"furi"
argument_list|)
decl_stmt|;
name|createLocalFile
argument_list|(
name|furi
argument_list|)
expr_stmt|;
name|argv
operator|=
operator|new
name|String
index|[
literal|3
index|]
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
literal|"-put"
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
name|furi
operator|.
name|toURI
argument_list|()
operator|.
name|toString
argument_list|()
expr_stmt|;
name|argv
index|[
literal|2
index|]
operator|=
name|dstFs
operator|.
name|getUri
argument_list|()
operator|.
name|toString
argument_list|()
operator|+
literal|"/furi"
expr_stmt|;
name|ret
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|" put is working "
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|)
expr_stmt|;
comment|//check cp
name|argv
index|[
literal|0
index|]
operator|=
literal|"-cp"
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
name|dstFs
operator|.
name|getUri
argument_list|()
operator|.
name|toString
argument_list|()
operator|+
literal|"/furi"
expr_stmt|;
name|argv
index|[
literal|2
index|]
operator|=
name|srcFs
operator|.
name|getUri
argument_list|()
operator|.
name|toString
argument_list|()
operator|+
literal|"/furi"
expr_stmt|;
name|ret
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|" cp is working "
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|srcFs
operator|.
name|exists
argument_list|(
operator|new
name|Path
argument_list|(
literal|"/furi"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|//check cat
name|argv
operator|=
operator|new
name|String
index|[
literal|2
index|]
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
literal|"-cat"
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
name|dstFs
operator|.
name|getUri
argument_list|()
operator|.
name|toString
argument_list|()
operator|+
literal|"/furi"
expr_stmt|;
name|ret
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|" cat is working "
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|)
expr_stmt|;
comment|//check chown
name|dstFs
operator|.
name|delete
argument_list|(
operator|new
name|Path
argument_list|(
literal|"/furi"
argument_list|)
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|dstFs
operator|.
name|delete
argument_list|(
operator|new
name|Path
argument_list|(
literal|"/hadoopdir"
argument_list|)
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|String
name|file
init|=
literal|"/tmp/chownTest"
decl_stmt|;
name|Path
name|path
init|=
operator|new
name|Path
argument_list|(
name|file
argument_list|)
decl_stmt|;
name|Path
name|parent
init|=
operator|new
name|Path
argument_list|(
literal|"/tmp"
argument_list|)
decl_stmt|;
name|Path
name|root
init|=
operator|new
name|Path
argument_list|(
literal|"/"
argument_list|)
decl_stmt|;
name|TestDFSShell
operator|.
name|writeFile
argument_list|(
name|dstFs
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|runCmd
argument_list|(
name|shell
argument_list|,
literal|"-chgrp"
argument_list|,
literal|"-R"
argument_list|,
literal|"herbivores"
argument_list|,
name|dstFs
operator|.
name|getUri
argument_list|()
operator|.
name|toString
argument_list|()
operator|+
literal|"/*"
argument_list|)
expr_stmt|;
name|confirmOwner
argument_list|(
literal|null
argument_list|,
literal|"herbivores"
argument_list|,
name|dstFs
argument_list|,
name|parent
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|runCmd
argument_list|(
name|shell
argument_list|,
literal|"-chown"
argument_list|,
literal|"-R"
argument_list|,
literal|":reptiles"
argument_list|,
name|dstFs
operator|.
name|getUri
argument_list|()
operator|.
name|toString
argument_list|()
operator|+
literal|"/"
argument_list|)
expr_stmt|;
name|confirmOwner
argument_list|(
literal|null
argument_list|,
literal|"reptiles"
argument_list|,
name|dstFs
argument_list|,
name|root
argument_list|,
name|parent
argument_list|,
name|path
argument_list|)
expr_stmt|;
comment|//check if default hdfs:/// works
name|argv
index|[
literal|0
index|]
operator|=
literal|"-cat"
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
literal|"hdfs:///furi"
expr_stmt|;
name|ret
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|" default works for cat"
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
literal|"-ls"
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
literal|"hdfs:///"
expr_stmt|;
name|ret
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"default works for ls "
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
literal|"-rmr"
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
literal|"hdfs:///furi"
expr_stmt|;
name|ret
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"default works for rm/rmr"
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
literal|null
operator|!=
name|srcCluster
condition|)
block|{
name|srcCluster
operator|.
name|shutdown
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
literal|null
operator|!=
name|dstCluster
condition|)
block|{
name|dstCluster
operator|.
name|shutdown
argument_list|()
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Test
argument_list|(
name|timeout
operator|=
literal|30000
argument_list|)
DECL|method|testText ()
specifier|public
name|void
name|testText
parameter_list|()
throws|throws
name|Exception
block|{
name|Configuration
name|conf
init|=
operator|new
name|HdfsConfiguration
argument_list|()
decl_stmt|;
name|MiniDFSCluster
name|cluster
init|=
literal|null
decl_stmt|;
try|try
block|{
name|cluster
operator|=
operator|new
name|MiniDFSCluster
operator|.
name|Builder
argument_list|(
name|conf
argument_list|)
operator|.
name|numDataNodes
argument_list|(
literal|2
argument_list|)
operator|.
name|build
argument_list|()
expr_stmt|;
specifier|final
name|FileSystem
name|dfs
init|=
name|cluster
operator|.
name|getFileSystem
argument_list|()
decl_stmt|;
name|textTest
argument_list|(
operator|new
name|Path
argument_list|(
literal|"/texttest"
argument_list|)
operator|.
name|makeQualified
argument_list|(
name|dfs
operator|.
name|getUri
argument_list|()
argument_list|,
name|dfs
operator|.
name|getWorkingDirectory
argument_list|()
argument_list|)
argument_list|,
name|conf
argument_list|)
expr_stmt|;
name|conf
operator|.
name|set
argument_list|(
literal|"fs.defaultFS"
argument_list|,
name|dfs
operator|.
name|getUri
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
specifier|final
name|FileSystem
name|lfs
init|=
name|FileSystem
operator|.
name|getLocal
argument_list|(
name|conf
argument_list|)
decl_stmt|;
name|textTest
argument_list|(
operator|new
name|Path
argument_list|(
name|TEST_ROOT_DIR
argument_list|,
literal|"texttest"
argument_list|)
operator|.
name|makeQualified
argument_list|(
name|lfs
operator|.
name|getUri
argument_list|()
argument_list|,
name|lfs
operator|.
name|getWorkingDirectory
argument_list|()
argument_list|)
argument_list|,
name|conf
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
literal|null
operator|!=
name|cluster
condition|)
block|{
name|cluster
operator|.
name|shutdown
argument_list|()
expr_stmt|;
block|}
block|}
block|}
DECL|method|textTest (Path root, Configuration conf)
specifier|private
name|void
name|textTest
parameter_list|(
name|Path
name|root
parameter_list|,
name|Configuration
name|conf
parameter_list|)
throws|throws
name|Exception
block|{
name|PrintStream
name|bak
init|=
literal|null
decl_stmt|;
try|try
block|{
specifier|final
name|FileSystem
name|fs
init|=
name|root
operator|.
name|getFileSystem
argument_list|(
name|conf
argument_list|)
decl_stmt|;
name|fs
operator|.
name|mkdirs
argument_list|(
name|root
argument_list|)
expr_stmt|;
comment|// Test the gzip type of files. Magic detection.
name|OutputStream
name|zout
init|=
operator|new
name|GZIPOutputStream
argument_list|(
name|fs
operator|.
name|create
argument_list|(
operator|new
name|Path
argument_list|(
name|root
argument_list|,
literal|"file.gz"
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|Random
name|r
init|=
operator|new
name|Random
argument_list|()
decl_stmt|;
name|bak
operator|=
name|System
operator|.
name|out
expr_stmt|;
name|ByteArrayOutputStream
name|file
init|=
operator|new
name|ByteArrayOutputStream
argument_list|()
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|1024
condition|;
operator|++
name|i
control|)
block|{
name|char
name|c
init|=
name|Character
operator|.
name|forDigit
argument_list|(
name|r
operator|.
name|nextInt
argument_list|(
literal|26
argument_list|)
operator|+
literal|10
argument_list|,
literal|36
argument_list|)
decl_stmt|;
name|file
operator|.
name|write
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|zout
operator|.
name|write
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
name|zout
operator|.
name|close
argument_list|()
expr_stmt|;
name|ByteArrayOutputStream
name|out
init|=
operator|new
name|ByteArrayOutputStream
argument_list|()
decl_stmt|;
name|System
operator|.
name|setOut
argument_list|(
operator|new
name|PrintStream
argument_list|(
name|out
argument_list|)
argument_list|)
expr_stmt|;
name|String
index|[]
name|argv
init|=
operator|new
name|String
index|[
literal|2
index|]
decl_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
literal|"-text"
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
operator|new
name|Path
argument_list|(
name|root
argument_list|,
literal|"file.gz"
argument_list|)
operator|.
name|toString
argument_list|()
expr_stmt|;
name|int
name|ret
init|=
name|ToolRunner
operator|.
name|run
argument_list|(
operator|new
name|FsShell
argument_list|(
name|conf
argument_list|)
argument_list|,
name|argv
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"'-text "
operator|+
name|argv
index|[
literal|1
index|]
operator|+
literal|" returned "
operator|+
name|ret
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Output doesn't match input"
argument_list|,
name|Arrays
operator|.
name|equals
argument_list|(
name|file
operator|.
name|toByteArray
argument_list|()
argument_list|,
name|out
operator|.
name|toByteArray
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
comment|// Create a sequence file with a gz extension, to test proper
comment|// container detection. Magic detection.
name|SequenceFile
operator|.
name|Writer
name|writer
init|=
name|SequenceFile
operator|.
name|createWriter
argument_list|(
name|conf
argument_list|,
name|SequenceFile
operator|.
name|Writer
operator|.
name|file
argument_list|(
operator|new
name|Path
argument_list|(
name|root
argument_list|,
literal|"file.gz"
argument_list|)
argument_list|)
argument_list|,
name|SequenceFile
operator|.
name|Writer
operator|.
name|keyClass
argument_list|(
name|Text
operator|.
name|class
argument_list|)
argument_list|,
name|SequenceFile
operator|.
name|Writer
operator|.
name|valueClass
argument_list|(
name|Text
operator|.
name|class
argument_list|)
argument_list|)
decl_stmt|;
name|writer
operator|.
name|append
argument_list|(
operator|new
name|Text
argument_list|(
literal|"Foo"
argument_list|)
argument_list|,
operator|new
name|Text
argument_list|(
literal|"Bar"
argument_list|)
argument_list|)
expr_stmt|;
name|writer
operator|.
name|close
argument_list|()
expr_stmt|;
name|out
operator|=
operator|new
name|ByteArrayOutputStream
argument_list|()
expr_stmt|;
name|System
operator|.
name|setOut
argument_list|(
operator|new
name|PrintStream
argument_list|(
name|out
argument_list|)
argument_list|)
expr_stmt|;
name|argv
operator|=
operator|new
name|String
index|[
literal|2
index|]
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
literal|"-text"
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
operator|new
name|Path
argument_list|(
name|root
argument_list|,
literal|"file.gz"
argument_list|)
operator|.
name|toString
argument_list|()
expr_stmt|;
name|ret
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
operator|new
name|FsShell
argument_list|(
name|conf
argument_list|)
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"'-text "
operator|+
name|argv
index|[
literal|1
index|]
operator|+
literal|" returned "
operator|+
name|ret
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Output doesn't match input"
argument_list|,
name|Arrays
operator|.
name|equals
argument_list|(
literal|"Foo\tBar\n"
operator|.
name|getBytes
argument_list|()
argument_list|,
name|out
operator|.
name|toByteArray
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|out
operator|.
name|reset
argument_list|()
expr_stmt|;
comment|// Test deflate. Extension-based detection.
name|OutputStream
name|dout
init|=
operator|new
name|DeflaterOutputStream
argument_list|(
name|fs
operator|.
name|create
argument_list|(
operator|new
name|Path
argument_list|(
name|root
argument_list|,
literal|"file.deflate"
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|byte
index|[]
name|outbytes
init|=
literal|"foo"
operator|.
name|getBytes
argument_list|()
decl_stmt|;
name|dout
operator|.
name|write
argument_list|(
name|outbytes
argument_list|)
expr_stmt|;
name|dout
operator|.
name|close
argument_list|()
expr_stmt|;
name|out
operator|=
operator|new
name|ByteArrayOutputStream
argument_list|()
expr_stmt|;
name|System
operator|.
name|setOut
argument_list|(
operator|new
name|PrintStream
argument_list|(
name|out
argument_list|)
argument_list|)
expr_stmt|;
name|argv
operator|=
operator|new
name|String
index|[
literal|2
index|]
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
literal|"-text"
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
operator|new
name|Path
argument_list|(
name|root
argument_list|,
literal|"file.deflate"
argument_list|)
operator|.
name|toString
argument_list|()
expr_stmt|;
name|ret
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
operator|new
name|FsShell
argument_list|(
name|conf
argument_list|)
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"'-text "
operator|+
name|argv
index|[
literal|1
index|]
operator|+
literal|" returned "
operator|+
name|ret
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Output doesn't match input"
argument_list|,
name|Arrays
operator|.
name|equals
argument_list|(
name|outbytes
argument_list|,
name|out
operator|.
name|toByteArray
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|out
operator|.
name|reset
argument_list|()
expr_stmt|;
comment|// Test a simple codec. Extension based detection. We use
comment|// Bzip2 cause its non-native.
name|CompressionCodec
name|codec
init|=
operator|(
name|CompressionCodec
operator|)
name|ReflectionUtils
operator|.
name|newInstance
argument_list|(
name|BZip2Codec
operator|.
name|class
argument_list|,
name|conf
argument_list|)
decl_stmt|;
name|String
name|extension
init|=
name|codec
operator|.
name|getDefaultExtension
argument_list|()
decl_stmt|;
name|Path
name|p
init|=
operator|new
name|Path
argument_list|(
name|root
argument_list|,
literal|"file."
operator|+
name|extension
argument_list|)
decl_stmt|;
name|OutputStream
name|fout
init|=
operator|new
name|DataOutputStream
argument_list|(
name|codec
operator|.
name|createOutputStream
argument_list|(
name|fs
operator|.
name|create
argument_list|(
name|p
argument_list|,
literal|true
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|byte
index|[]
name|writebytes
init|=
literal|"foo"
operator|.
name|getBytes
argument_list|()
decl_stmt|;
name|fout
operator|.
name|write
argument_list|(
name|writebytes
argument_list|)
expr_stmt|;
name|fout
operator|.
name|close
argument_list|()
expr_stmt|;
name|out
operator|=
operator|new
name|ByteArrayOutputStream
argument_list|()
expr_stmt|;
name|System
operator|.
name|setOut
argument_list|(
operator|new
name|PrintStream
argument_list|(
name|out
argument_list|)
argument_list|)
expr_stmt|;
name|argv
operator|=
operator|new
name|String
index|[
literal|2
index|]
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
literal|"-text"
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
operator|new
name|Path
argument_list|(
name|root
argument_list|,
name|p
argument_list|)
operator|.
name|toString
argument_list|()
expr_stmt|;
name|ret
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
operator|new
name|FsShell
argument_list|(
name|conf
argument_list|)
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"'-text "
operator|+
name|argv
index|[
literal|1
index|]
operator|+
literal|" returned "
operator|+
name|ret
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Output doesn't match input"
argument_list|,
name|Arrays
operator|.
name|equals
argument_list|(
name|writebytes
argument_list|,
name|out
operator|.
name|toByteArray
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|out
operator|.
name|reset
argument_list|()
expr_stmt|;
comment|// Test a plain text.
name|OutputStream
name|pout
init|=
name|fs
operator|.
name|create
argument_list|(
operator|new
name|Path
argument_list|(
name|root
argument_list|,
literal|"file.txt"
argument_list|)
argument_list|)
decl_stmt|;
name|writebytes
operator|=
literal|"bar"
operator|.
name|getBytes
argument_list|()
expr_stmt|;
name|pout
operator|.
name|write
argument_list|(
name|writebytes
argument_list|)
expr_stmt|;
name|pout
operator|.
name|close
argument_list|()
expr_stmt|;
name|out
operator|=
operator|new
name|ByteArrayOutputStream
argument_list|()
expr_stmt|;
name|System
operator|.
name|setOut
argument_list|(
operator|new
name|PrintStream
argument_list|(
name|out
argument_list|)
argument_list|)
expr_stmt|;
name|argv
operator|=
operator|new
name|String
index|[
literal|2
index|]
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
literal|"-text"
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
operator|new
name|Path
argument_list|(
name|root
argument_list|,
literal|"file.txt"
argument_list|)
operator|.
name|toString
argument_list|()
expr_stmt|;
name|ret
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
operator|new
name|FsShell
argument_list|(
name|conf
argument_list|)
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"'-text "
operator|+
name|argv
index|[
literal|1
index|]
operator|+
literal|" returned "
operator|+
name|ret
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Output doesn't match input"
argument_list|,
name|Arrays
operator|.
name|equals
argument_list|(
name|writebytes
argument_list|,
name|out
operator|.
name|toByteArray
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|out
operator|.
name|reset
argument_list|()
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
literal|null
operator|!=
name|bak
condition|)
block|{
name|System
operator|.
name|setOut
argument_list|(
name|bak
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Test
argument_list|(
name|timeout
operator|=
literal|30000
argument_list|)
DECL|method|testCopyToLocal ()
specifier|public
name|void
name|testCopyToLocal
parameter_list|()
throws|throws
name|IOException
block|{
name|Configuration
name|conf
init|=
operator|new
name|HdfsConfiguration
argument_list|()
decl_stmt|;
name|MiniDFSCluster
name|cluster
init|=
operator|new
name|MiniDFSCluster
operator|.
name|Builder
argument_list|(
name|conf
argument_list|)
operator|.
name|numDataNodes
argument_list|(
literal|2
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
name|FileSystem
name|fs
init|=
name|cluster
operator|.
name|getFileSystem
argument_list|()
decl_stmt|;
name|assertTrue
argument_list|(
literal|"Not a HDFS: "
operator|+
name|fs
operator|.
name|getUri
argument_list|()
argument_list|,
name|fs
operator|instanceof
name|DistributedFileSystem
argument_list|)
expr_stmt|;
name|DistributedFileSystem
name|dfs
init|=
operator|(
name|DistributedFileSystem
operator|)
name|fs
decl_stmt|;
name|FsShell
name|shell
init|=
operator|new
name|FsShell
argument_list|()
decl_stmt|;
name|shell
operator|.
name|setConf
argument_list|(
name|conf
argument_list|)
expr_stmt|;
try|try
block|{
name|String
name|root
init|=
name|createTree
argument_list|(
name|dfs
argument_list|,
literal|"copyToLocal"
argument_list|)
decl_stmt|;
comment|// Verify copying the tree
block|{
try|try
block|{
name|assertEquals
argument_list|(
literal|0
argument_list|,
name|runCmd
argument_list|(
name|shell
argument_list|,
literal|"-copyToLocal"
argument_list|,
name|root
operator|+
literal|"*"
argument_list|,
name|TEST_ROOT_DIR
argument_list|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Exception raised from DFSShell.run "
operator|+
name|e
operator|.
name|getLocalizedMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|File
name|localroot
init|=
operator|new
name|File
argument_list|(
name|TEST_ROOT_DIR
argument_list|,
literal|"copyToLocal"
argument_list|)
decl_stmt|;
name|File
name|localroot2
init|=
operator|new
name|File
argument_list|(
name|TEST_ROOT_DIR
argument_list|,
literal|"copyToLocal2"
argument_list|)
decl_stmt|;
name|File
name|f1
init|=
operator|new
name|File
argument_list|(
name|localroot
argument_list|,
literal|"f1"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
literal|"Copying failed."
argument_list|,
name|f1
operator|.
name|isFile
argument_list|()
argument_list|)
expr_stmt|;
name|File
name|f2
init|=
operator|new
name|File
argument_list|(
name|localroot
argument_list|,
literal|"f2"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
literal|"Copying failed."
argument_list|,
name|f2
operator|.
name|isFile
argument_list|()
argument_list|)
expr_stmt|;
name|File
name|sub
init|=
operator|new
name|File
argument_list|(
name|localroot
argument_list|,
literal|"sub"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
literal|"Copying failed."
argument_list|,
name|sub
operator|.
name|isDirectory
argument_list|()
argument_list|)
expr_stmt|;
name|File
name|f3
init|=
operator|new
name|File
argument_list|(
name|sub
argument_list|,
literal|"f3"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
literal|"Copying failed."
argument_list|,
name|f3
operator|.
name|isFile
argument_list|()
argument_list|)
expr_stmt|;
name|File
name|f4
init|=
operator|new
name|File
argument_list|(
name|sub
argument_list|,
literal|"f4"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
literal|"Copying failed."
argument_list|,
name|f4
operator|.
name|isFile
argument_list|()
argument_list|)
expr_stmt|;
name|File
name|f5
init|=
operator|new
name|File
argument_list|(
name|localroot2
argument_list|,
literal|"f1"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
literal|"Copying failed."
argument_list|,
name|f5
operator|.
name|isFile
argument_list|()
argument_list|)
expr_stmt|;
name|f1
operator|.
name|delete
argument_list|()
expr_stmt|;
name|f2
operator|.
name|delete
argument_list|()
expr_stmt|;
name|f3
operator|.
name|delete
argument_list|()
expr_stmt|;
name|f4
operator|.
name|delete
argument_list|()
expr_stmt|;
name|f5
operator|.
name|delete
argument_list|()
expr_stmt|;
name|sub
operator|.
name|delete
argument_list|()
expr_stmt|;
block|}
comment|// Verify copying non existing sources do not create zero byte
comment|// destination files
block|{
name|String
index|[]
name|args
init|=
block|{
literal|"-copyToLocal"
block|,
literal|"nosuchfile"
block|,
name|TEST_ROOT_DIR
block|}
decl_stmt|;
try|try
block|{
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|shell
operator|.
name|run
argument_list|(
name|args
argument_list|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Exception raised from DFSShell.run "
operator|+
name|e
operator|.
name|getLocalizedMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|File
name|f6
init|=
operator|new
name|File
argument_list|(
name|TEST_ROOT_DIR
argument_list|,
literal|"nosuchfile"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
operator|!
name|f6
operator|.
name|exists
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
finally|finally
block|{
try|try
block|{
name|dfs
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{       }
name|cluster
operator|.
name|shutdown
argument_list|()
expr_stmt|;
block|}
block|}
DECL|method|createTree (FileSystem fs, String name)
specifier|static
name|String
name|createTree
parameter_list|(
name|FileSystem
name|fs
parameter_list|,
name|String
name|name
parameter_list|)
throws|throws
name|IOException
block|{
comment|// create a tree
comment|//   ROOT
comment|//   |- f1
comment|//   |- f2
comment|//   + sub
comment|//      |- f3
comment|//      |- f4
comment|//   ROOT2
comment|//   |- f1
name|String
name|path
init|=
literal|"/test/"
operator|+
name|name
decl_stmt|;
name|Path
name|root
init|=
name|mkdir
argument_list|(
name|fs
argument_list|,
operator|new
name|Path
argument_list|(
name|path
argument_list|)
argument_list|)
decl_stmt|;
name|Path
name|sub
init|=
name|mkdir
argument_list|(
name|fs
argument_list|,
operator|new
name|Path
argument_list|(
name|root
argument_list|,
literal|"sub"
argument_list|)
argument_list|)
decl_stmt|;
name|Path
name|root2
init|=
name|mkdir
argument_list|(
name|fs
argument_list|,
operator|new
name|Path
argument_list|(
name|path
operator|+
literal|"2"
argument_list|)
argument_list|)
decl_stmt|;
name|writeFile
argument_list|(
name|fs
argument_list|,
operator|new
name|Path
argument_list|(
name|root
argument_list|,
literal|"f1"
argument_list|)
argument_list|)
expr_stmt|;
name|writeFile
argument_list|(
name|fs
argument_list|,
operator|new
name|Path
argument_list|(
name|root
argument_list|,
literal|"f2"
argument_list|)
argument_list|)
expr_stmt|;
name|writeFile
argument_list|(
name|fs
argument_list|,
operator|new
name|Path
argument_list|(
name|sub
argument_list|,
literal|"f3"
argument_list|)
argument_list|)
expr_stmt|;
name|writeFile
argument_list|(
name|fs
argument_list|,
operator|new
name|Path
argument_list|(
name|sub
argument_list|,
literal|"f4"
argument_list|)
argument_list|)
expr_stmt|;
name|writeFile
argument_list|(
name|fs
argument_list|,
operator|new
name|Path
argument_list|(
name|root2
argument_list|,
literal|"f1"
argument_list|)
argument_list|)
expr_stmt|;
name|mkdir
argument_list|(
name|fs
argument_list|,
operator|new
name|Path
argument_list|(
name|root2
argument_list|,
literal|"sub"
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|path
return|;
block|}
annotation|@
name|Test
argument_list|(
name|timeout
operator|=
literal|30000
argument_list|)
DECL|method|testCount ()
specifier|public
name|void
name|testCount
parameter_list|()
throws|throws
name|Exception
block|{
name|Configuration
name|conf
init|=
operator|new
name|HdfsConfiguration
argument_list|()
decl_stmt|;
name|MiniDFSCluster
name|cluster
init|=
operator|new
name|MiniDFSCluster
operator|.
name|Builder
argument_list|(
name|conf
argument_list|)
operator|.
name|numDataNodes
argument_list|(
literal|2
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
name|DistributedFileSystem
name|dfs
init|=
operator|(
name|DistributedFileSystem
operator|)
name|cluster
operator|.
name|getFileSystem
argument_list|()
decl_stmt|;
name|FsShell
name|shell
init|=
operator|new
name|FsShell
argument_list|()
decl_stmt|;
name|shell
operator|.
name|setConf
argument_list|(
name|conf
argument_list|)
expr_stmt|;
try|try
block|{
name|String
name|root
init|=
name|createTree
argument_list|(
name|dfs
argument_list|,
literal|"count"
argument_list|)
decl_stmt|;
comment|// Verify the counts
name|runCount
argument_list|(
name|root
argument_list|,
literal|2
argument_list|,
literal|4
argument_list|,
name|shell
argument_list|)
expr_stmt|;
name|runCount
argument_list|(
name|root
operator|+
literal|"2"
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|shell
argument_list|)
expr_stmt|;
name|runCount
argument_list|(
name|root
operator|+
literal|"2/f1"
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|shell
argument_list|)
expr_stmt|;
name|runCount
argument_list|(
name|root
operator|+
literal|"2/sub"
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|shell
argument_list|)
expr_stmt|;
specifier|final
name|FileSystem
name|localfs
init|=
name|FileSystem
operator|.
name|getLocal
argument_list|(
name|conf
argument_list|)
decl_stmt|;
name|Path
name|localpath
init|=
operator|new
name|Path
argument_list|(
name|TEST_ROOT_DIR
argument_list|,
literal|"testcount"
argument_list|)
decl_stmt|;
name|localpath
operator|=
name|localpath
operator|.
name|makeQualified
argument_list|(
name|localfs
operator|.
name|getUri
argument_list|()
argument_list|,
name|localfs
operator|.
name|getWorkingDirectory
argument_list|()
argument_list|)
expr_stmt|;
name|localfs
operator|.
name|mkdirs
argument_list|(
name|localpath
argument_list|)
expr_stmt|;
specifier|final
name|String
name|localstr
init|=
name|localpath
operator|.
name|toString
argument_list|()
decl_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"localstr="
operator|+
name|localstr
argument_list|)
expr_stmt|;
name|runCount
argument_list|(
name|localstr
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|shell
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|0
argument_list|,
name|runCmd
argument_list|(
name|shell
argument_list|,
literal|"-count"
argument_list|,
name|root
argument_list|,
name|localstr
argument_list|)
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
try|try
block|{
name|dfs
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{       }
name|cluster
operator|.
name|shutdown
argument_list|()
expr_stmt|;
block|}
block|}
DECL|method|runCount (String path, long dirs, long files, FsShell shell )
specifier|private
specifier|static
name|void
name|runCount
parameter_list|(
name|String
name|path
parameter_list|,
name|long
name|dirs
parameter_list|,
name|long
name|files
parameter_list|,
name|FsShell
name|shell
parameter_list|)
throws|throws
name|IOException
block|{
name|ByteArrayOutputStream
name|bytes
init|=
operator|new
name|ByteArrayOutputStream
argument_list|()
decl_stmt|;
name|PrintStream
name|out
init|=
operator|new
name|PrintStream
argument_list|(
name|bytes
argument_list|)
decl_stmt|;
name|PrintStream
name|oldOut
init|=
name|System
operator|.
name|out
decl_stmt|;
name|System
operator|.
name|setOut
argument_list|(
name|out
argument_list|)
expr_stmt|;
name|Scanner
name|in
init|=
literal|null
decl_stmt|;
name|String
name|results
init|=
literal|null
decl_stmt|;
try|try
block|{
name|runCmd
argument_list|(
name|shell
argument_list|,
literal|"-count"
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|results
operator|=
name|bytes
operator|.
name|toString
argument_list|()
expr_stmt|;
name|in
operator|=
operator|new
name|Scanner
argument_list|(
name|results
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|dirs
argument_list|,
name|in
operator|.
name|nextLong
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|files
argument_list|,
name|in
operator|.
name|nextLong
argument_list|()
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
name|in
operator|!=
literal|null
condition|)
name|in
operator|.
name|close
argument_list|()
expr_stmt|;
name|IOUtils
operator|.
name|closeStream
argument_list|(
name|out
argument_list|)
expr_stmt|;
name|System
operator|.
name|setOut
argument_list|(
name|oldOut
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"results:\n"
operator|+
name|results
argument_list|)
expr_stmt|;
block|}
block|}
comment|//throws IOException instead of Exception as shell.run() does.
DECL|method|runCmd (FsShell shell, String... args)
specifier|private
specifier|static
name|int
name|runCmd
parameter_list|(
name|FsShell
name|shell
parameter_list|,
name|String
modifier|...
name|args
parameter_list|)
throws|throws
name|IOException
block|{
name|StringBuilder
name|cmdline
init|=
operator|new
name|StringBuilder
argument_list|(
literal|"RUN:"
argument_list|)
decl_stmt|;
for|for
control|(
name|String
name|arg
range|:
name|args
control|)
name|cmdline
operator|.
name|append
argument_list|(
literal|" "
operator|+
name|arg
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
name|cmdline
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
try|try
block|{
name|int
name|exitCode
decl_stmt|;
name|exitCode
operator|=
name|shell
operator|.
name|run
argument_list|(
name|args
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"RUN: "
operator|+
name|args
index|[
literal|0
index|]
operator|+
literal|" exit="
operator|+
name|exitCode
argument_list|)
expr_stmt|;
return|return
name|exitCode
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"RUN: "
operator|+
name|args
index|[
literal|0
index|]
operator|+
literal|" IOException="
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
throw|throw
name|e
throw|;
block|}
catch|catch
parameter_list|(
name|RuntimeException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"RUN: "
operator|+
name|args
index|[
literal|0
index|]
operator|+
literal|" RuntimeException="
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
throw|throw
name|e
throw|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"RUN: "
operator|+
name|args
index|[
literal|0
index|]
operator|+
literal|" Exception="
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|IOException
argument_list|(
name|StringUtils
operator|.
name|stringifyException
argument_list|(
name|e
argument_list|)
argument_list|)
throw|;
block|}
block|}
comment|/**    * Test chmod.    */
DECL|method|testChmod (Configuration conf, FileSystem fs, String chmodDir)
name|void
name|testChmod
parameter_list|(
name|Configuration
name|conf
parameter_list|,
name|FileSystem
name|fs
parameter_list|,
name|String
name|chmodDir
parameter_list|)
throws|throws
name|IOException
block|{
name|FsShell
name|shell
init|=
operator|new
name|FsShell
argument_list|()
decl_stmt|;
name|shell
operator|.
name|setConf
argument_list|(
name|conf
argument_list|)
expr_stmt|;
try|try
block|{
comment|//first make dir
name|Path
name|dir
init|=
operator|new
name|Path
argument_list|(
name|chmodDir
argument_list|)
decl_stmt|;
name|fs
operator|.
name|delete
argument_list|(
name|dir
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|fs
operator|.
name|mkdirs
argument_list|(
name|dir
argument_list|)
expr_stmt|;
name|confirmPermissionChange
argument_list|(
comment|/* Setting */
literal|"u+rwx,g=rw,o-rwx"
argument_list|,
comment|/* Should give */
literal|"rwxrw----"
argument_list|,
name|fs
argument_list|,
name|shell
argument_list|,
name|dir
argument_list|)
expr_stmt|;
comment|//create an empty file
name|Path
name|file
init|=
operator|new
name|Path
argument_list|(
name|chmodDir
argument_list|,
literal|"file"
argument_list|)
decl_stmt|;
name|TestDFSShell
operator|.
name|writeFile
argument_list|(
name|fs
argument_list|,
name|file
argument_list|)
expr_stmt|;
comment|//test octal mode
name|confirmPermissionChange
argument_list|(
literal|"644"
argument_list|,
literal|"rw-r--r--"
argument_list|,
name|fs
argument_list|,
name|shell
argument_list|,
name|file
argument_list|)
expr_stmt|;
comment|//test recursive
name|runCmd
argument_list|(
name|shell
argument_list|,
literal|"-chmod"
argument_list|,
literal|"-R"
argument_list|,
literal|"a+rwX"
argument_list|,
name|chmodDir
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"rwxrwxrwx"
argument_list|,
name|fs
operator|.
name|getFileStatus
argument_list|(
name|dir
argument_list|)
operator|.
name|getPermission
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"rw-rw-rw-"
argument_list|,
name|fs
operator|.
name|getFileStatus
argument_list|(
name|file
argument_list|)
operator|.
name|getPermission
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
comment|// Skip "sticky bit" tests on Windows.
comment|//
if|if
condition|(
operator|!
name|Path
operator|.
name|WINDOWS
condition|)
block|{
comment|// test sticky bit on directories
name|Path
name|dir2
init|=
operator|new
name|Path
argument_list|(
name|dir
argument_list|,
literal|"stickybit"
argument_list|)
decl_stmt|;
name|fs
operator|.
name|mkdirs
argument_list|(
name|dir2
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Testing sticky bit on: "
operator|+
name|dir2
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Sticky bit directory initial mode: "
operator|+
name|fs
operator|.
name|getFileStatus
argument_list|(
name|dir2
argument_list|)
operator|.
name|getPermission
argument_list|()
argument_list|)
expr_stmt|;
name|confirmPermissionChange
argument_list|(
literal|"u=rwx,g=rx,o=rx"
argument_list|,
literal|"rwxr-xr-x"
argument_list|,
name|fs
argument_list|,
name|shell
argument_list|,
name|dir2
argument_list|)
expr_stmt|;
name|confirmPermissionChange
argument_list|(
literal|"+t"
argument_list|,
literal|"rwxr-xr-t"
argument_list|,
name|fs
argument_list|,
name|shell
argument_list|,
name|dir2
argument_list|)
expr_stmt|;
name|confirmPermissionChange
argument_list|(
literal|"-t"
argument_list|,
literal|"rwxr-xr-x"
argument_list|,
name|fs
argument_list|,
name|shell
argument_list|,
name|dir2
argument_list|)
expr_stmt|;
name|confirmPermissionChange
argument_list|(
literal|"=t"
argument_list|,
literal|"--------T"
argument_list|,
name|fs
argument_list|,
name|shell
argument_list|,
name|dir2
argument_list|)
expr_stmt|;
name|confirmPermissionChange
argument_list|(
literal|"0000"
argument_list|,
literal|"---------"
argument_list|,
name|fs
argument_list|,
name|shell
argument_list|,
name|dir2
argument_list|)
expr_stmt|;
name|confirmPermissionChange
argument_list|(
literal|"1666"
argument_list|,
literal|"rw-rw-rwT"
argument_list|,
name|fs
argument_list|,
name|shell
argument_list|,
name|dir2
argument_list|)
expr_stmt|;
name|confirmPermissionChange
argument_list|(
literal|"777"
argument_list|,
literal|"rwxrwxrwt"
argument_list|,
name|fs
argument_list|,
name|shell
argument_list|,
name|dir2
argument_list|)
expr_stmt|;
name|fs
operator|.
name|delete
argument_list|(
name|dir2
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Skipped sticky bit tests on Windows"
argument_list|)
expr_stmt|;
block|}
name|fs
operator|.
name|delete
argument_list|(
name|dir
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
try|try
block|{
name|fs
operator|.
name|close
argument_list|()
expr_stmt|;
name|shell
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ignored
parameter_list|)
block|{}
block|}
block|}
comment|// Apply a new permission to a path and confirm that the new permission
comment|// is the one you were expecting
DECL|method|confirmPermissionChange (String toApply, String expected, FileSystem fs, FsShell shell, Path dir2)
specifier|private
name|void
name|confirmPermissionChange
parameter_list|(
name|String
name|toApply
parameter_list|,
name|String
name|expected
parameter_list|,
name|FileSystem
name|fs
parameter_list|,
name|FsShell
name|shell
parameter_list|,
name|Path
name|dir2
parameter_list|)
throws|throws
name|IOException
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Confirming permission change of "
operator|+
name|toApply
operator|+
literal|" to "
operator|+
name|expected
argument_list|)
expr_stmt|;
name|runCmd
argument_list|(
name|shell
argument_list|,
literal|"-chmod"
argument_list|,
name|toApply
argument_list|,
name|dir2
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|String
name|result
init|=
name|fs
operator|.
name|getFileStatus
argument_list|(
name|dir2
argument_list|)
operator|.
name|getPermission
argument_list|()
operator|.
name|toString
argument_list|()
decl_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Permission change result: "
operator|+
name|result
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|expected
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
DECL|method|confirmOwner (String owner, String group, FileSystem fs, Path... paths)
specifier|private
name|void
name|confirmOwner
parameter_list|(
name|String
name|owner
parameter_list|,
name|String
name|group
parameter_list|,
name|FileSystem
name|fs
parameter_list|,
name|Path
modifier|...
name|paths
parameter_list|)
throws|throws
name|IOException
block|{
for|for
control|(
name|Path
name|path
range|:
name|paths
control|)
block|{
if|if
condition|(
name|owner
operator|!=
literal|null
condition|)
block|{
name|assertEquals
argument_list|(
name|owner
argument_list|,
name|fs
operator|.
name|getFileStatus
argument_list|(
name|path
argument_list|)
operator|.
name|getOwner
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|group
operator|!=
literal|null
condition|)
block|{
name|assertEquals
argument_list|(
name|group
argument_list|,
name|fs
operator|.
name|getFileStatus
argument_list|(
name|path
argument_list|)
operator|.
name|getGroup
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Test
argument_list|(
name|timeout
operator|=
literal|30000
argument_list|)
DECL|method|testFilePermissions ()
specifier|public
name|void
name|testFilePermissions
parameter_list|()
throws|throws
name|IOException
block|{
name|Configuration
name|conf
init|=
operator|new
name|HdfsConfiguration
argument_list|()
decl_stmt|;
comment|//test chmod on local fs
name|FileSystem
name|fs
init|=
name|FileSystem
operator|.
name|getLocal
argument_list|(
name|conf
argument_list|)
decl_stmt|;
name|testChmod
argument_list|(
name|conf
argument_list|,
name|fs
argument_list|,
operator|(
operator|new
name|File
argument_list|(
name|TEST_ROOT_DIR
argument_list|,
literal|"chmodTest"
argument_list|)
operator|)
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
expr_stmt|;
name|conf
operator|.
name|set
argument_list|(
name|DFSConfigKeys
operator|.
name|DFS_PERMISSIONS_ENABLED_KEY
argument_list|,
literal|"true"
argument_list|)
expr_stmt|;
comment|//test chmod on DFS
name|MiniDFSCluster
name|cluster
init|=
operator|new
name|MiniDFSCluster
operator|.
name|Builder
argument_list|(
name|conf
argument_list|)
operator|.
name|numDataNodes
argument_list|(
literal|2
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
name|fs
operator|=
name|cluster
operator|.
name|getFileSystem
argument_list|()
expr_stmt|;
name|testChmod
argument_list|(
name|conf
argument_list|,
name|fs
argument_list|,
literal|"/tmp/chmodTest"
argument_list|)
expr_stmt|;
comment|// test chown and chgrp on DFS:
name|FsShell
name|shell
init|=
operator|new
name|FsShell
argument_list|()
decl_stmt|;
name|shell
operator|.
name|setConf
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|fs
operator|=
name|cluster
operator|.
name|getFileSystem
argument_list|()
expr_stmt|;
comment|/* For dfs, I am the super user and I can change owner of any file to      * anything. "-R" option is already tested by chmod test above.      */
name|String
name|file
init|=
literal|"/tmp/chownTest"
decl_stmt|;
name|Path
name|path
init|=
operator|new
name|Path
argument_list|(
name|file
argument_list|)
decl_stmt|;
name|Path
name|parent
init|=
operator|new
name|Path
argument_list|(
literal|"/tmp"
argument_list|)
decl_stmt|;
name|Path
name|root
init|=
operator|new
name|Path
argument_list|(
literal|"/"
argument_list|)
decl_stmt|;
name|TestDFSShell
operator|.
name|writeFile
argument_list|(
name|fs
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|runCmd
argument_list|(
name|shell
argument_list|,
literal|"-chgrp"
argument_list|,
literal|"-R"
argument_list|,
literal|"herbivores"
argument_list|,
literal|"/*"
argument_list|,
literal|"unknownFile*"
argument_list|)
expr_stmt|;
name|confirmOwner
argument_list|(
literal|null
argument_list|,
literal|"herbivores"
argument_list|,
name|fs
argument_list|,
name|parent
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|runCmd
argument_list|(
name|shell
argument_list|,
literal|"-chgrp"
argument_list|,
literal|"mammals"
argument_list|,
name|file
argument_list|)
expr_stmt|;
name|confirmOwner
argument_list|(
literal|null
argument_list|,
literal|"mammals"
argument_list|,
name|fs
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|runCmd
argument_list|(
name|shell
argument_list|,
literal|"-chown"
argument_list|,
literal|"-R"
argument_list|,
literal|":reptiles"
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
name|confirmOwner
argument_list|(
literal|null
argument_list|,
literal|"reptiles"
argument_list|,
name|fs
argument_list|,
name|root
argument_list|,
name|parent
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|runCmd
argument_list|(
name|shell
argument_list|,
literal|"-chown"
argument_list|,
literal|"python:"
argument_list|,
literal|"/nonExistentFile"
argument_list|,
name|file
argument_list|)
expr_stmt|;
name|confirmOwner
argument_list|(
literal|"python"
argument_list|,
literal|"reptiles"
argument_list|,
name|fs
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|runCmd
argument_list|(
name|shell
argument_list|,
literal|"-chown"
argument_list|,
literal|"-R"
argument_list|,
literal|"hadoop:toys"
argument_list|,
literal|"unknownFile"
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
name|confirmOwner
argument_list|(
literal|"hadoop"
argument_list|,
literal|"toys"
argument_list|,
name|fs
argument_list|,
name|root
argument_list|,
name|parent
argument_list|,
name|path
argument_list|)
expr_stmt|;
comment|// Test different characters in names
name|runCmd
argument_list|(
name|shell
argument_list|,
literal|"-chown"
argument_list|,
literal|"hdfs.user"
argument_list|,
name|file
argument_list|)
expr_stmt|;
name|confirmOwner
argument_list|(
literal|"hdfs.user"
argument_list|,
literal|null
argument_list|,
name|fs
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|runCmd
argument_list|(
name|shell
argument_list|,
literal|"-chown"
argument_list|,
literal|"_Hdfs.User-10:_hadoop.users--"
argument_list|,
name|file
argument_list|)
expr_stmt|;
name|confirmOwner
argument_list|(
literal|"_Hdfs.User-10"
argument_list|,
literal|"_hadoop.users--"
argument_list|,
name|fs
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|runCmd
argument_list|(
name|shell
argument_list|,
literal|"-chown"
argument_list|,
literal|"hdfs/hadoop-core@apache.org:asf-projects"
argument_list|,
name|file
argument_list|)
expr_stmt|;
name|confirmOwner
argument_list|(
literal|"hdfs/hadoop-core@apache.org"
argument_list|,
literal|"asf-projects"
argument_list|,
name|fs
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|runCmd
argument_list|(
name|shell
argument_list|,
literal|"-chgrp"
argument_list|,
literal|"hadoop-core@apache.org/100"
argument_list|,
name|file
argument_list|)
expr_stmt|;
name|confirmOwner
argument_list|(
literal|null
argument_list|,
literal|"hadoop-core@apache.org/100"
argument_list|,
name|fs
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|cluster
operator|.
name|shutdown
argument_list|()
expr_stmt|;
block|}
comment|/**    * Tests various options of DFSShell.    */
annotation|@
name|Test
argument_list|(
name|timeout
operator|=
literal|120000
argument_list|)
DECL|method|testDFSShell ()
specifier|public
name|void
name|testDFSShell
parameter_list|()
throws|throws
name|IOException
block|{
name|Configuration
name|conf
init|=
operator|new
name|HdfsConfiguration
argument_list|()
decl_stmt|;
comment|/* This tests some properties of ChecksumFileSystem as well.      * Make sure that we create ChecksumDFS */
name|MiniDFSCluster
name|cluster
init|=
operator|new
name|MiniDFSCluster
operator|.
name|Builder
argument_list|(
name|conf
argument_list|)
operator|.
name|numDataNodes
argument_list|(
literal|2
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
name|FileSystem
name|fs
init|=
name|cluster
operator|.
name|getFileSystem
argument_list|()
decl_stmt|;
name|assertTrue
argument_list|(
literal|"Not a HDFS: "
operator|+
name|fs
operator|.
name|getUri
argument_list|()
argument_list|,
name|fs
operator|instanceof
name|DistributedFileSystem
argument_list|)
expr_stmt|;
name|DistributedFileSystem
name|fileSys
init|=
operator|(
name|DistributedFileSystem
operator|)
name|fs
decl_stmt|;
name|FsShell
name|shell
init|=
operator|new
name|FsShell
argument_list|()
decl_stmt|;
name|shell
operator|.
name|setConf
argument_list|(
name|conf
argument_list|)
expr_stmt|;
try|try
block|{
comment|// First create a new directory with mkdirs
name|Path
name|myPath
init|=
operator|new
name|Path
argument_list|(
literal|"/test/mkdirs"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|fileSys
operator|.
name|mkdirs
argument_list|(
name|myPath
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|fileSys
operator|.
name|exists
argument_list|(
name|myPath
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|fileSys
operator|.
name|mkdirs
argument_list|(
name|myPath
argument_list|)
argument_list|)
expr_stmt|;
comment|// Second, create a file in that directory.
name|Path
name|myFile
init|=
operator|new
name|Path
argument_list|(
literal|"/test/mkdirs/myFile"
argument_list|)
decl_stmt|;
name|writeFile
argument_list|(
name|fileSys
argument_list|,
name|myFile
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|fileSys
operator|.
name|exists
argument_list|(
name|myFile
argument_list|)
argument_list|)
expr_stmt|;
name|Path
name|myFile2
init|=
operator|new
name|Path
argument_list|(
literal|"/test/mkdirs/myFile2"
argument_list|)
decl_stmt|;
name|writeFile
argument_list|(
name|fileSys
argument_list|,
name|myFile2
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|fileSys
operator|.
name|exists
argument_list|(
name|myFile2
argument_list|)
argument_list|)
expr_stmt|;
comment|// Verify that rm with a pattern
block|{
name|String
index|[]
name|args
init|=
operator|new
name|String
index|[
literal|2
index|]
decl_stmt|;
name|args
index|[
literal|0
index|]
operator|=
literal|"-rm"
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|=
literal|"/test/mkdirs/myFile*"
expr_stmt|;
name|int
name|val
init|=
operator|-
literal|1
decl_stmt|;
try|try
block|{
name|val
operator|=
name|shell
operator|.
name|run
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Exception raised from DFSShell.run "
operator|+
name|e
operator|.
name|getLocalizedMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|assertTrue
argument_list|(
name|val
operator|==
literal|0
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|fileSys
operator|.
name|exists
argument_list|(
name|myFile
argument_list|)
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|fileSys
operator|.
name|exists
argument_list|(
name|myFile2
argument_list|)
argument_list|)
expr_stmt|;
comment|//re-create the files for other tests
name|writeFile
argument_list|(
name|fileSys
argument_list|,
name|myFile
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|fileSys
operator|.
name|exists
argument_list|(
name|myFile
argument_list|)
argument_list|)
expr_stmt|;
name|writeFile
argument_list|(
name|fileSys
argument_list|,
name|myFile2
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|fileSys
operator|.
name|exists
argument_list|(
name|myFile2
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|// Verify that we can read the file
block|{
name|String
index|[]
name|args
init|=
operator|new
name|String
index|[
literal|3
index|]
decl_stmt|;
name|args
index|[
literal|0
index|]
operator|=
literal|"-cat"
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|=
literal|"/test/mkdirs/myFile"
expr_stmt|;
name|args
index|[
literal|2
index|]
operator|=
literal|"/test/mkdirs/myFile2"
expr_stmt|;
name|int
name|val
init|=
operator|-
literal|1
decl_stmt|;
try|try
block|{
name|val
operator|=
name|shell
operator|.
name|run
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Exception raised from DFSShell.run: "
operator|+
name|StringUtils
operator|.
name|stringifyException
argument_list|(
name|e
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|assertTrue
argument_list|(
name|val
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
name|fileSys
operator|.
name|delete
argument_list|(
name|myFile2
argument_list|,
literal|true
argument_list|)
expr_stmt|;
comment|// Verify that we get an error while trying to read an nonexistent file
block|{
name|String
index|[]
name|args
init|=
operator|new
name|String
index|[
literal|2
index|]
decl_stmt|;
name|args
index|[
literal|0
index|]
operator|=
literal|"-cat"
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|=
literal|"/test/mkdirs/myFile1"
expr_stmt|;
name|int
name|val
init|=
operator|-
literal|1
decl_stmt|;
try|try
block|{
name|val
operator|=
name|shell
operator|.
name|run
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Exception raised from DFSShell.run "
operator|+
name|e
operator|.
name|getLocalizedMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|assertTrue
argument_list|(
name|val
operator|!=
literal|0
argument_list|)
expr_stmt|;
block|}
comment|// Verify that we get an error while trying to delete an nonexistent file
block|{
name|String
index|[]
name|args
init|=
operator|new
name|String
index|[
literal|2
index|]
decl_stmt|;
name|args
index|[
literal|0
index|]
operator|=
literal|"-rm"
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|=
literal|"/test/mkdirs/myFile1"
expr_stmt|;
name|int
name|val
init|=
operator|-
literal|1
decl_stmt|;
try|try
block|{
name|val
operator|=
name|shell
operator|.
name|run
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Exception raised from DFSShell.run "
operator|+
name|e
operator|.
name|getLocalizedMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|assertTrue
argument_list|(
name|val
operator|!=
literal|0
argument_list|)
expr_stmt|;
block|}
comment|// Verify that we succeed in removing the file we created
block|{
name|String
index|[]
name|args
init|=
operator|new
name|String
index|[
literal|2
index|]
decl_stmt|;
name|args
index|[
literal|0
index|]
operator|=
literal|"-rm"
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|=
literal|"/test/mkdirs/myFile"
expr_stmt|;
name|int
name|val
init|=
operator|-
literal|1
decl_stmt|;
try|try
block|{
name|val
operator|=
name|shell
operator|.
name|run
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Exception raised from DFSShell.run "
operator|+
name|e
operator|.
name|getLocalizedMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|assertTrue
argument_list|(
name|val
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
comment|// Verify touch/test
block|{
name|String
index|[]
name|args
decl_stmt|;
name|int
name|val
decl_stmt|;
name|args
operator|=
operator|new
name|String
index|[
literal|3
index|]
expr_stmt|;
name|args
index|[
literal|0
index|]
operator|=
literal|"-test"
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|=
literal|"-e"
expr_stmt|;
name|args
index|[
literal|2
index|]
operator|=
literal|"/test/mkdirs/noFileHere"
expr_stmt|;
name|val
operator|=
operator|-
literal|1
expr_stmt|;
try|try
block|{
name|val
operator|=
name|shell
operator|.
name|run
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Exception raised from DFSShell.run "
operator|+
name|e
operator|.
name|getLocalizedMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|=
literal|"-z"
expr_stmt|;
name|val
operator|=
operator|-
literal|1
expr_stmt|;
try|try
block|{
name|val
operator|=
name|shell
operator|.
name|run
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Exception raised from DFSShell.run "
operator|+
name|e
operator|.
name|getLocalizedMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|args
operator|=
operator|new
name|String
index|[
literal|2
index|]
expr_stmt|;
name|args
index|[
literal|0
index|]
operator|=
literal|"-touchz"
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|=
literal|"/test/mkdirs/isFileHere"
expr_stmt|;
name|val
operator|=
operator|-
literal|1
expr_stmt|;
try|try
block|{
name|val
operator|=
name|shell
operator|.
name|run
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Exception raised from DFSShell.run "
operator|+
name|e
operator|.
name|getLocalizedMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|assertEquals
argument_list|(
literal|0
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|args
operator|=
operator|new
name|String
index|[
literal|2
index|]
expr_stmt|;
name|args
index|[
literal|0
index|]
operator|=
literal|"-touchz"
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|=
literal|"/test/mkdirs/thisDirNotExists/isFileHere"
expr_stmt|;
name|val
operator|=
operator|-
literal|1
expr_stmt|;
try|try
block|{
name|val
operator|=
name|shell
operator|.
name|run
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Exception raised from DFSShell.run "
operator|+
name|e
operator|.
name|getLocalizedMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|args
operator|=
operator|new
name|String
index|[
literal|3
index|]
expr_stmt|;
name|args
index|[
literal|0
index|]
operator|=
literal|"-test"
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|=
literal|"-e"
expr_stmt|;
name|args
index|[
literal|2
index|]
operator|=
literal|"/test/mkdirs/isFileHere"
expr_stmt|;
name|val
operator|=
operator|-
literal|1
expr_stmt|;
try|try
block|{
name|val
operator|=
name|shell
operator|.
name|run
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Exception raised from DFSShell.run "
operator|+
name|e
operator|.
name|getLocalizedMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|assertEquals
argument_list|(
literal|0
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|=
literal|"-d"
expr_stmt|;
name|val
operator|=
operator|-
literal|1
expr_stmt|;
try|try
block|{
name|val
operator|=
name|shell
operator|.
name|run
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Exception raised from DFSShell.run "
operator|+
name|e
operator|.
name|getLocalizedMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|=
literal|"-z"
expr_stmt|;
name|val
operator|=
operator|-
literal|1
expr_stmt|;
try|try
block|{
name|val
operator|=
name|shell
operator|.
name|run
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Exception raised from DFSShell.run "
operator|+
name|e
operator|.
name|getLocalizedMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|assertEquals
argument_list|(
literal|0
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
comment|// Verify that cp from a directory to a subdirectory fails
block|{
name|String
index|[]
name|args
init|=
operator|new
name|String
index|[
literal|2
index|]
decl_stmt|;
name|args
index|[
literal|0
index|]
operator|=
literal|"-mkdir"
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|=
literal|"/test/dir1"
expr_stmt|;
name|int
name|val
init|=
operator|-
literal|1
decl_stmt|;
try|try
block|{
name|val
operator|=
name|shell
operator|.
name|run
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Exception raised from DFSShell.run "
operator|+
name|e
operator|.
name|getLocalizedMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|assertEquals
argument_list|(
literal|0
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|// this should fail
name|String
index|[]
name|args1
init|=
operator|new
name|String
index|[
literal|3
index|]
decl_stmt|;
name|args1
index|[
literal|0
index|]
operator|=
literal|"-cp"
expr_stmt|;
name|args1
index|[
literal|1
index|]
operator|=
literal|"/test/dir1"
expr_stmt|;
name|args1
index|[
literal|2
index|]
operator|=
literal|"/test/dir1/dir2"
expr_stmt|;
name|val
operator|=
literal|0
expr_stmt|;
try|try
block|{
name|val
operator|=
name|shell
operator|.
name|run
argument_list|(
name|args1
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Exception raised from DFSShell.run "
operator|+
name|e
operator|.
name|getLocalizedMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|// this should succeed
name|args1
index|[
literal|0
index|]
operator|=
literal|"-cp"
expr_stmt|;
name|args1
index|[
literal|1
index|]
operator|=
literal|"/test/dir1"
expr_stmt|;
name|args1
index|[
literal|2
index|]
operator|=
literal|"/test/dir1foo"
expr_stmt|;
name|val
operator|=
operator|-
literal|1
expr_stmt|;
try|try
block|{
name|val
operator|=
name|shell
operator|.
name|run
argument_list|(
name|args1
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Exception raised from DFSShell.run "
operator|+
name|e
operator|.
name|getLocalizedMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|assertEquals
argument_list|(
literal|0
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
comment|// Verify -test -f negative case (missing file)
block|{
name|String
index|[]
name|args
init|=
operator|new
name|String
index|[
literal|3
index|]
decl_stmt|;
name|args
index|[
literal|0
index|]
operator|=
literal|"-test"
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|=
literal|"-f"
expr_stmt|;
name|args
index|[
literal|2
index|]
operator|=
literal|"/test/mkdirs/noFileHere"
expr_stmt|;
name|int
name|val
init|=
operator|-
literal|1
decl_stmt|;
try|try
block|{
name|val
operator|=
name|shell
operator|.
name|run
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Exception raised from DFSShell.run "
operator|+
name|e
operator|.
name|getLocalizedMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
comment|// Verify -test -f negative case (directory rather than file)
block|{
name|String
index|[]
name|args
init|=
operator|new
name|String
index|[
literal|3
index|]
decl_stmt|;
name|args
index|[
literal|0
index|]
operator|=
literal|"-test"
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|=
literal|"-f"
expr_stmt|;
name|args
index|[
literal|2
index|]
operator|=
literal|"/test/mkdirs"
expr_stmt|;
name|int
name|val
init|=
operator|-
literal|1
decl_stmt|;
try|try
block|{
name|val
operator|=
name|shell
operator|.
name|run
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Exception raised from DFSShell.run "
operator|+
name|e
operator|.
name|getLocalizedMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
comment|// Verify -test -f positive case
block|{
name|writeFile
argument_list|(
name|fileSys
argument_list|,
name|myFile
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|fileSys
operator|.
name|exists
argument_list|(
name|myFile
argument_list|)
argument_list|)
expr_stmt|;
name|String
index|[]
name|args
init|=
operator|new
name|String
index|[
literal|3
index|]
decl_stmt|;
name|args
index|[
literal|0
index|]
operator|=
literal|"-test"
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|=
literal|"-f"
expr_stmt|;
name|args
index|[
literal|2
index|]
operator|=
name|myFile
operator|.
name|toString
argument_list|()
expr_stmt|;
name|int
name|val
init|=
operator|-
literal|1
decl_stmt|;
try|try
block|{
name|val
operator|=
name|shell
operator|.
name|run
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Exception raised from DFSShell.run "
operator|+
name|e
operator|.
name|getLocalizedMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|assertEquals
argument_list|(
literal|0
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
comment|// Verify -test -s negative case (missing file)
block|{
name|String
index|[]
name|args
init|=
operator|new
name|String
index|[
literal|3
index|]
decl_stmt|;
name|args
index|[
literal|0
index|]
operator|=
literal|"-test"
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|=
literal|"-s"
expr_stmt|;
name|args
index|[
literal|2
index|]
operator|=
literal|"/test/mkdirs/noFileHere"
expr_stmt|;
name|int
name|val
init|=
operator|-
literal|1
decl_stmt|;
try|try
block|{
name|val
operator|=
name|shell
operator|.
name|run
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Exception raised from DFSShell.run "
operator|+
name|e
operator|.
name|getLocalizedMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
comment|// Verify -test -s negative case (zero length file)
block|{
name|String
index|[]
name|args
init|=
operator|new
name|String
index|[
literal|3
index|]
decl_stmt|;
name|args
index|[
literal|0
index|]
operator|=
literal|"-test"
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|=
literal|"-s"
expr_stmt|;
name|args
index|[
literal|2
index|]
operator|=
literal|"/test/mkdirs/isFileHere"
expr_stmt|;
name|int
name|val
init|=
operator|-
literal|1
decl_stmt|;
try|try
block|{
name|val
operator|=
name|shell
operator|.
name|run
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Exception raised from DFSShell.run "
operator|+
name|e
operator|.
name|getLocalizedMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
comment|// Verify -test -s positive case (nonzero length file)
block|{
name|String
index|[]
name|args
init|=
operator|new
name|String
index|[
literal|3
index|]
decl_stmt|;
name|args
index|[
literal|0
index|]
operator|=
literal|"-test"
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|=
literal|"-s"
expr_stmt|;
name|args
index|[
literal|2
index|]
operator|=
name|myFile
operator|.
name|toString
argument_list|()
expr_stmt|;
name|int
name|val
init|=
operator|-
literal|1
decl_stmt|;
try|try
block|{
name|val
operator|=
name|shell
operator|.
name|run
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Exception raised from DFSShell.run "
operator|+
name|e
operator|.
name|getLocalizedMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|assertEquals
argument_list|(
literal|0
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
block|}
finally|finally
block|{
try|try
block|{
name|fileSys
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{       }
name|cluster
operator|.
name|shutdown
argument_list|()
expr_stmt|;
block|}
block|}
DECL|method|getBlockFiles (MiniDFSCluster cluster)
specifier|static
name|List
argument_list|<
name|File
argument_list|>
name|getBlockFiles
parameter_list|(
name|MiniDFSCluster
name|cluster
parameter_list|)
throws|throws
name|IOException
block|{
name|List
argument_list|<
name|File
argument_list|>
name|files
init|=
operator|new
name|ArrayList
argument_list|<
name|File
argument_list|>
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|DataNode
argument_list|>
name|datanodes
init|=
name|cluster
operator|.
name|getDataNodes
argument_list|()
decl_stmt|;
name|String
name|poolId
init|=
name|cluster
operator|.
name|getNamesystem
argument_list|()
operator|.
name|getBlockPoolId
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|Map
argument_list|<
name|DatanodeStorage
argument_list|,
name|BlockListAsLongs
argument_list|>
argument_list|>
name|blocks
init|=
name|cluster
operator|.
name|getAllBlockReports
argument_list|(
name|poolId
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|blocks
operator|.
name|size
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|DataNode
name|dn
init|=
name|datanodes
operator|.
name|get
argument_list|(
name|i
argument_list|)
decl_stmt|;
name|Map
argument_list|<
name|DatanodeStorage
argument_list|,
name|BlockListAsLongs
argument_list|>
name|map
init|=
name|blocks
operator|.
name|get
argument_list|(
name|i
argument_list|)
decl_stmt|;
for|for
control|(
name|Map
operator|.
name|Entry
argument_list|<
name|DatanodeStorage
argument_list|,
name|BlockListAsLongs
argument_list|>
name|e
range|:
name|map
operator|.
name|entrySet
argument_list|()
control|)
block|{
for|for
control|(
name|Block
name|b
range|:
name|e
operator|.
name|getValue
argument_list|()
control|)
block|{
name|files
operator|.
name|add
argument_list|(
name|DataNodeTestUtils
operator|.
name|getFile
argument_list|(
name|dn
argument_list|,
name|poolId
argument_list|,
name|b
operator|.
name|getBlockId
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return
name|files
return|;
block|}
DECL|method|corrupt (List<File> files)
specifier|static
name|void
name|corrupt
parameter_list|(
name|List
argument_list|<
name|File
argument_list|>
name|files
parameter_list|)
throws|throws
name|IOException
block|{
for|for
control|(
name|File
name|f
range|:
name|files
control|)
block|{
name|StringBuilder
name|content
init|=
operator|new
name|StringBuilder
argument_list|(
name|DFSTestUtil
operator|.
name|readFile
argument_list|(
name|f
argument_list|)
argument_list|)
decl_stmt|;
name|char
name|c
init|=
name|content
operator|.
name|charAt
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|content
operator|.
name|setCharAt
argument_list|(
literal|0
argument_list|,
operator|++
name|c
argument_list|)
expr_stmt|;
name|PrintWriter
name|out
init|=
operator|new
name|PrintWriter
argument_list|(
name|f
argument_list|)
decl_stmt|;
name|out
operator|.
name|print
argument_list|(
name|content
argument_list|)
expr_stmt|;
name|out
operator|.
name|flush
argument_list|()
expr_stmt|;
name|out
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
block|}
DECL|interface|TestGetRunner
specifier|static
interface|interface
name|TestGetRunner
block|{
DECL|method|run (int exitcode, String... options)
name|String
name|run
parameter_list|(
name|int
name|exitcode
parameter_list|,
name|String
modifier|...
name|options
parameter_list|)
throws|throws
name|IOException
function_decl|;
block|}
annotation|@
name|Test
argument_list|(
name|timeout
operator|=
literal|30000
argument_list|)
DECL|method|testRemoteException ()
specifier|public
name|void
name|testRemoteException
parameter_list|()
throws|throws
name|Exception
block|{
name|UserGroupInformation
name|tmpUGI
init|=
name|UserGroupInformation
operator|.
name|createUserForTesting
argument_list|(
literal|"tmpname"
argument_list|,
operator|new
name|String
index|[]
block|{
literal|"mygroup"
block|}
argument_list|)
decl_stmt|;
name|MiniDFSCluster
name|dfs
init|=
literal|null
decl_stmt|;
name|PrintStream
name|bak
init|=
literal|null
decl_stmt|;
try|try
block|{
specifier|final
name|Configuration
name|conf
init|=
operator|new
name|HdfsConfiguration
argument_list|()
decl_stmt|;
name|dfs
operator|=
operator|new
name|MiniDFSCluster
operator|.
name|Builder
argument_list|(
name|conf
argument_list|)
operator|.
name|numDataNodes
argument_list|(
literal|2
argument_list|)
operator|.
name|build
argument_list|()
expr_stmt|;
name|FileSystem
name|fs
init|=
name|dfs
operator|.
name|getFileSystem
argument_list|()
decl_stmt|;
name|Path
name|p
init|=
operator|new
name|Path
argument_list|(
literal|"/foo"
argument_list|)
decl_stmt|;
name|fs
operator|.
name|mkdirs
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|fs
operator|.
name|setPermission
argument_list|(
name|p
argument_list|,
operator|new
name|FsPermission
argument_list|(
operator|(
name|short
operator|)
literal|0700
argument_list|)
argument_list|)
expr_stmt|;
name|bak
operator|=
name|System
operator|.
name|err
expr_stmt|;
name|tmpUGI
operator|.
name|doAs
argument_list|(
operator|new
name|PrivilegedExceptionAction
argument_list|<
name|Object
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|Object
name|run
parameter_list|()
throws|throws
name|Exception
block|{
name|FsShell
name|fshell
init|=
operator|new
name|FsShell
argument_list|(
name|conf
argument_list|)
decl_stmt|;
name|ByteArrayOutputStream
name|out
init|=
operator|new
name|ByteArrayOutputStream
argument_list|()
decl_stmt|;
name|PrintStream
name|tmp
init|=
operator|new
name|PrintStream
argument_list|(
name|out
argument_list|)
decl_stmt|;
name|System
operator|.
name|setErr
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|String
index|[]
name|args
init|=
operator|new
name|String
index|[
literal|2
index|]
decl_stmt|;
name|args
index|[
literal|0
index|]
operator|=
literal|"-ls"
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|=
literal|"/foo"
expr_stmt|;
name|int
name|ret
init|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|fshell
argument_list|,
name|args
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"returned should be 1"
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|String
name|str
init|=
name|out
operator|.
name|toString
argument_list|()
decl_stmt|;
name|assertTrue
argument_list|(
literal|"permission denied printed"
argument_list|,
name|str
operator|.
name|indexOf
argument_list|(
literal|"Permission denied"
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|out
operator|.
name|reset
argument_list|()
expr_stmt|;
return|return
literal|null
return|;
block|}
block|}
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
name|bak
operator|!=
literal|null
condition|)
block|{
name|System
operator|.
name|setErr
argument_list|(
name|bak
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dfs
operator|!=
literal|null
condition|)
block|{
name|dfs
operator|.
name|shutdown
argument_list|()
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Test
argument_list|(
name|timeout
operator|=
literal|30000
argument_list|)
DECL|method|testGet ()
specifier|public
name|void
name|testGet
parameter_list|()
throws|throws
name|IOException
block|{
name|DFSTestUtil
operator|.
name|setLogLevel2All
argument_list|(
name|FSInputChecker
operator|.
name|LOG
argument_list|)
expr_stmt|;
specifier|final
name|String
name|fname
init|=
literal|"testGet.txt"
decl_stmt|;
name|Path
name|root
init|=
operator|new
name|Path
argument_list|(
literal|"/test/get"
argument_list|)
decl_stmt|;
specifier|final
name|Path
name|remotef
init|=
operator|new
name|Path
argument_list|(
name|root
argument_list|,
name|fname
argument_list|)
decl_stmt|;
specifier|final
name|Configuration
name|conf
init|=
operator|new
name|HdfsConfiguration
argument_list|()
decl_stmt|;
name|TestGetRunner
name|runner
init|=
operator|new
name|TestGetRunner
argument_list|()
block|{
specifier|private
name|int
name|count
init|=
literal|0
decl_stmt|;
specifier|private
specifier|final
name|FsShell
name|shell
init|=
operator|new
name|FsShell
argument_list|(
name|conf
argument_list|)
decl_stmt|;
specifier|public
name|String
name|run
parameter_list|(
name|int
name|exitcode
parameter_list|,
name|String
modifier|...
name|options
parameter_list|)
throws|throws
name|IOException
block|{
name|String
name|dst
init|=
name|TEST_ROOT_DIR
operator|+
literal|"/"
operator|+
name|fname
operator|+
operator|++
name|count
decl_stmt|;
name|String
index|[]
name|args
init|=
operator|new
name|String
index|[
name|options
operator|.
name|length
operator|+
literal|3
index|]
decl_stmt|;
name|args
index|[
literal|0
index|]
operator|=
literal|"-get"
expr_stmt|;
name|args
index|[
name|args
operator|.
name|length
operator|-
literal|2
index|]
operator|=
name|remotef
operator|.
name|toString
argument_list|()
expr_stmt|;
name|args
index|[
name|args
operator|.
name|length
operator|-
literal|1
index|]
operator|=
name|dst
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|options
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|args
index|[
name|i
operator|+
literal|1
index|]
operator|=
name|options
index|[
name|i
index|]
expr_stmt|;
block|}
name|show
argument_list|(
literal|"args="
operator|+
name|Arrays
operator|.
name|asList
argument_list|(
name|args
argument_list|)
argument_list|)
expr_stmt|;
try|try
block|{
name|assertEquals
argument_list|(
name|exitcode
argument_list|,
name|shell
operator|.
name|run
argument_list|(
name|args
argument_list|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|assertTrue
argument_list|(
name|StringUtils
operator|.
name|stringifyException
argument_list|(
name|e
argument_list|)
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
return|return
name|exitcode
operator|==
literal|0
condition|?
name|DFSTestUtil
operator|.
name|readFile
argument_list|(
operator|new
name|File
argument_list|(
name|dst
argument_list|)
argument_list|)
else|:
literal|null
return|;
block|}
block|}
decl_stmt|;
name|File
name|localf
init|=
name|createLocalFile
argument_list|(
operator|new
name|File
argument_list|(
name|TEST_ROOT_DIR
argument_list|,
name|fname
argument_list|)
argument_list|)
decl_stmt|;
name|MiniDFSCluster
name|cluster
init|=
literal|null
decl_stmt|;
name|DistributedFileSystem
name|dfs
init|=
literal|null
decl_stmt|;
try|try
block|{
name|cluster
operator|=
operator|new
name|MiniDFSCluster
operator|.
name|Builder
argument_list|(
name|conf
argument_list|)
operator|.
name|numDataNodes
argument_list|(
literal|2
argument_list|)
operator|.
name|format
argument_list|(
literal|true
argument_list|)
operator|.
name|build
argument_list|()
expr_stmt|;
name|dfs
operator|=
operator|(
name|DistributedFileSystem
operator|)
name|cluster
operator|.
name|getFileSystem
argument_list|()
expr_stmt|;
name|mkdir
argument_list|(
name|dfs
argument_list|,
name|root
argument_list|)
expr_stmt|;
name|dfs
operator|.
name|copyFromLocalFile
argument_list|(
literal|false
argument_list|,
literal|false
argument_list|,
operator|new
name|Path
argument_list|(
name|localf
operator|.
name|getPath
argument_list|()
argument_list|)
argument_list|,
name|remotef
argument_list|)
expr_stmt|;
name|String
name|localfcontent
init|=
name|DFSTestUtil
operator|.
name|readFile
argument_list|(
name|localf
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
name|localfcontent
argument_list|,
name|runner
operator|.
name|run
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|localfcontent
argument_list|,
name|runner
operator|.
name|run
argument_list|(
literal|0
argument_list|,
literal|"-ignoreCrc"
argument_list|)
argument_list|)
expr_stmt|;
comment|// find block files to modify later
name|List
argument_list|<
name|File
argument_list|>
name|files
init|=
name|getBlockFiles
argument_list|(
name|cluster
argument_list|)
decl_stmt|;
comment|// Shut down cluster and then corrupt the block files by overwriting a
comment|// portion with junk data.  We must shut down the cluster so that threads
comment|// in the data node do not hold locks on the block files while we try to
comment|// write into them.  Particularly on Windows, the data node's use of the
comment|// FileChannel.transferTo method can cause block files to be memory mapped
comment|// in read-only mode during the transfer to a client, and this causes a
comment|// locking conflict.  The call to shutdown the cluster blocks until all
comment|// DataXceiver threads exit, preventing this problem.
name|dfs
operator|.
name|close
argument_list|()
expr_stmt|;
name|cluster
operator|.
name|shutdown
argument_list|()
expr_stmt|;
name|show
argument_list|(
literal|"files="
operator|+
name|files
argument_list|)
expr_stmt|;
name|corrupt
argument_list|(
name|files
argument_list|)
expr_stmt|;
comment|// Start the cluster again, but do not reformat, so prior files remain.
name|cluster
operator|=
operator|new
name|MiniDFSCluster
operator|.
name|Builder
argument_list|(
name|conf
argument_list|)
operator|.
name|numDataNodes
argument_list|(
literal|2
argument_list|)
operator|.
name|format
argument_list|(
literal|false
argument_list|)
operator|.
name|build
argument_list|()
expr_stmt|;
name|dfs
operator|=
operator|(
name|DistributedFileSystem
operator|)
name|cluster
operator|.
name|getFileSystem
argument_list|()
expr_stmt|;
name|assertEquals
argument_list|(
literal|null
argument_list|,
name|runner
operator|.
name|run
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|corruptedcontent
init|=
name|runner
operator|.
name|run
argument_list|(
literal|0
argument_list|,
literal|"-ignoreCrc"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
name|localfcontent
operator|.
name|substring
argument_list|(
literal|1
argument_list|)
argument_list|,
name|corruptedcontent
operator|.
name|substring
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|localfcontent
operator|.
name|charAt
argument_list|(
literal|0
argument_list|)
operator|+
literal|1
argument_list|,
name|corruptedcontent
operator|.
name|charAt
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
literal|null
operator|!=
name|dfs
condition|)
block|{
try|try
block|{
name|dfs
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{         }
block|}
if|if
condition|(
literal|null
operator|!=
name|cluster
condition|)
block|{
name|cluster
operator|.
name|shutdown
argument_list|()
expr_stmt|;
block|}
name|localf
operator|.
name|delete
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
argument_list|(
name|timeout
operator|=
literal|30000
argument_list|)
DECL|method|testLsr ()
specifier|public
name|void
name|testLsr
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|Configuration
name|conf
init|=
operator|new
name|HdfsConfiguration
argument_list|()
decl_stmt|;
name|MiniDFSCluster
name|cluster
init|=
operator|new
name|MiniDFSCluster
operator|.
name|Builder
argument_list|(
name|conf
argument_list|)
operator|.
name|numDataNodes
argument_list|(
literal|2
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
name|DistributedFileSystem
name|dfs
init|=
operator|(
name|DistributedFileSystem
operator|)
name|cluster
operator|.
name|getFileSystem
argument_list|()
decl_stmt|;
try|try
block|{
specifier|final
name|String
name|root
init|=
name|createTree
argument_list|(
name|dfs
argument_list|,
literal|"lsr"
argument_list|)
decl_stmt|;
name|dfs
operator|.
name|mkdirs
argument_list|(
operator|new
name|Path
argument_list|(
name|root
argument_list|,
literal|"zzz"
argument_list|)
argument_list|)
expr_stmt|;
name|runLsr
argument_list|(
operator|new
name|FsShell
argument_list|(
name|conf
argument_list|)
argument_list|,
name|root
argument_list|,
literal|0
argument_list|)
expr_stmt|;
specifier|final
name|Path
name|sub
init|=
operator|new
name|Path
argument_list|(
name|root
argument_list|,
literal|"sub"
argument_list|)
decl_stmt|;
name|dfs
operator|.
name|setPermission
argument_list|(
name|sub
argument_list|,
operator|new
name|FsPermission
argument_list|(
operator|(
name|short
operator|)
literal|0
argument_list|)
argument_list|)
expr_stmt|;
specifier|final
name|UserGroupInformation
name|ugi
init|=
name|UserGroupInformation
operator|.
name|getCurrentUser
argument_list|()
decl_stmt|;
specifier|final
name|String
name|tmpusername
init|=
name|ugi
operator|.
name|getShortUserName
argument_list|()
operator|+
literal|"1"
decl_stmt|;
name|UserGroupInformation
name|tmpUGI
init|=
name|UserGroupInformation
operator|.
name|createUserForTesting
argument_list|(
name|tmpusername
argument_list|,
operator|new
name|String
index|[]
block|{
name|tmpusername
block|}
argument_list|)
decl_stmt|;
name|String
name|results
init|=
name|tmpUGI
operator|.
name|doAs
argument_list|(
operator|new
name|PrivilegedExceptionAction
argument_list|<
name|String
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|String
name|run
parameter_list|()
throws|throws
name|Exception
block|{
return|return
name|runLsr
argument_list|(
operator|new
name|FsShell
argument_list|(
name|conf
argument_list|)
argument_list|,
name|root
argument_list|,
literal|1
argument_list|)
return|;
block|}
block|}
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|results
operator|.
name|contains
argument_list|(
literal|"zzz"
argument_list|)
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|cluster
operator|.
name|shutdown
argument_list|()
expr_stmt|;
block|}
block|}
DECL|method|runLsr (final FsShell shell, String root, int returnvalue )
specifier|private
specifier|static
name|String
name|runLsr
parameter_list|(
specifier|final
name|FsShell
name|shell
parameter_list|,
name|String
name|root
parameter_list|,
name|int
name|returnvalue
parameter_list|)
throws|throws
name|Exception
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"root="
operator|+
name|root
operator|+
literal|", returnvalue="
operator|+
name|returnvalue
argument_list|)
expr_stmt|;
specifier|final
name|ByteArrayOutputStream
name|bytes
init|=
operator|new
name|ByteArrayOutputStream
argument_list|()
decl_stmt|;
specifier|final
name|PrintStream
name|out
init|=
operator|new
name|PrintStream
argument_list|(
name|bytes
argument_list|)
decl_stmt|;
specifier|final
name|PrintStream
name|oldOut
init|=
name|System
operator|.
name|out
decl_stmt|;
specifier|final
name|PrintStream
name|oldErr
init|=
name|System
operator|.
name|err
decl_stmt|;
name|System
operator|.
name|setOut
argument_list|(
name|out
argument_list|)
expr_stmt|;
name|System
operator|.
name|setErr
argument_list|(
name|out
argument_list|)
expr_stmt|;
specifier|final
name|String
name|results
decl_stmt|;
try|try
block|{
name|assertEquals
argument_list|(
name|returnvalue
argument_list|,
name|shell
operator|.
name|run
argument_list|(
operator|new
name|String
index|[]
block|{
literal|"-lsr"
block|,
name|root
block|}
argument_list|)
argument_list|)
expr_stmt|;
name|results
operator|=
name|bytes
operator|.
name|toString
argument_list|()
expr_stmt|;
block|}
finally|finally
block|{
name|IOUtils
operator|.
name|closeStream
argument_list|(
name|out
argument_list|)
expr_stmt|;
name|System
operator|.
name|setOut
argument_list|(
name|oldOut
argument_list|)
expr_stmt|;
name|System
operator|.
name|setErr
argument_list|(
name|oldErr
argument_list|)
expr_stmt|;
block|}
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"results:\n"
operator|+
name|results
argument_list|)
expr_stmt|;
return|return
name|results
return|;
block|}
comment|/**    * default setting is file:// which is not a DFS    * so DFSAdmin should throw and catch InvalidArgumentException    * and return -1 exit code.    * @throws Exception    */
annotation|@
name|Test
argument_list|(
name|timeout
operator|=
literal|30000
argument_list|)
DECL|method|testInvalidShell ()
specifier|public
name|void
name|testInvalidShell
parameter_list|()
throws|throws
name|Exception
block|{
name|Configuration
name|conf
init|=
operator|new
name|Configuration
argument_list|()
decl_stmt|;
comment|// default FS (non-DFS)
name|DFSAdmin
name|admin
init|=
operator|new
name|DFSAdmin
argument_list|()
decl_stmt|;
name|admin
operator|.
name|setConf
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|int
name|res
init|=
name|admin
operator|.
name|run
argument_list|(
operator|new
name|String
index|[]
block|{
literal|"-refreshNodes"
block|}
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"expected to fail -1"
argument_list|,
name|res
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
comment|// force Copy Option is -f
annotation|@
name|Test
argument_list|(
name|timeout
operator|=
literal|30000
argument_list|)
DECL|method|testCopyCommandsWithForceOption ()
specifier|public
name|void
name|testCopyCommandsWithForceOption
parameter_list|()
throws|throws
name|Exception
block|{
name|Configuration
name|conf
init|=
operator|new
name|Configuration
argument_list|()
decl_stmt|;
name|MiniDFSCluster
name|cluster
init|=
operator|new
name|MiniDFSCluster
operator|.
name|Builder
argument_list|(
name|conf
argument_list|)
operator|.
name|numDataNodes
argument_list|(
literal|1
argument_list|)
operator|.
name|format
argument_list|(
literal|true
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
name|FsShell
name|shell
init|=
literal|null
decl_stmt|;
name|FileSystem
name|fs
init|=
literal|null
decl_stmt|;
specifier|final
name|File
name|localFile
init|=
operator|new
name|File
argument_list|(
name|TEST_ROOT_DIR
argument_list|,
literal|"testFileForPut"
argument_list|)
decl_stmt|;
specifier|final
name|String
name|localfilepath
init|=
operator|new
name|Path
argument_list|(
name|localFile
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
operator|.
name|toUri
argument_list|()
operator|.
name|toString
argument_list|()
decl_stmt|;
specifier|final
name|String
name|testdir
init|=
literal|"/tmp/TestDFSShell-testCopyCommandsWithForceOption-"
operator|+
name|counter
operator|.
name|getAndIncrement
argument_list|()
decl_stmt|;
specifier|final
name|Path
name|hdfsTestDir
init|=
operator|new
name|Path
argument_list|(
name|testdir
argument_list|)
decl_stmt|;
try|try
block|{
name|fs
operator|=
name|cluster
operator|.
name|getFileSystem
argument_list|()
expr_stmt|;
name|fs
operator|.
name|mkdirs
argument_list|(
name|hdfsTestDir
argument_list|)
expr_stmt|;
name|localFile
operator|.
name|createNewFile
argument_list|()
expr_stmt|;
name|writeFile
argument_list|(
name|fs
argument_list|,
operator|new
name|Path
argument_list|(
name|testdir
argument_list|,
literal|"testFileForPut"
argument_list|)
argument_list|)
expr_stmt|;
name|shell
operator|=
operator|new
name|FsShell
argument_list|()
expr_stmt|;
comment|// Tests for put
name|String
index|[]
name|argv
init|=
operator|new
name|String
index|[]
block|{
literal|"-put"
block|,
literal|"-f"
block|,
name|localfilepath
block|,
name|testdir
block|}
decl_stmt|;
name|int
name|res
init|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"put -f is not working"
argument_list|,
name|SUCCESS
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|argv
operator|=
operator|new
name|String
index|[]
block|{
literal|"-put"
block|,
name|localfilepath
block|,
name|testdir
block|}
expr_stmt|;
name|res
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"put command itself is able to overwrite the file"
argument_list|,
name|ERROR
argument_list|,
name|res
argument_list|)
expr_stmt|;
comment|// Tests for copyFromLocal
name|argv
operator|=
operator|new
name|String
index|[]
block|{
literal|"-copyFromLocal"
block|,
literal|"-f"
block|,
name|localfilepath
block|,
name|testdir
block|}
expr_stmt|;
name|res
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"copyFromLocal -f is not working"
argument_list|,
name|SUCCESS
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|argv
operator|=
operator|new
name|String
index|[]
block|{
literal|"-copyFromLocal"
block|,
name|localfilepath
block|,
name|testdir
block|}
expr_stmt|;
name|res
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"copyFromLocal command itself is able to overwrite the file"
argument_list|,
name|ERROR
argument_list|,
name|res
argument_list|)
expr_stmt|;
comment|// Tests for cp
name|argv
operator|=
operator|new
name|String
index|[]
block|{
literal|"-cp"
block|,
literal|"-f"
block|,
name|localfilepath
block|,
name|testdir
block|}
expr_stmt|;
name|res
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"cp -f is not working"
argument_list|,
name|SUCCESS
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|argv
operator|=
operator|new
name|String
index|[]
block|{
literal|"-cp"
block|,
name|localfilepath
block|,
name|testdir
block|}
expr_stmt|;
name|res
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"cp command itself is able to overwrite the file"
argument_list|,
name|ERROR
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
literal|null
operator|!=
name|shell
condition|)
name|shell
operator|.
name|close
argument_list|()
expr_stmt|;
if|if
condition|(
name|localFile
operator|.
name|exists
argument_list|()
condition|)
name|localFile
operator|.
name|delete
argument_list|()
expr_stmt|;
if|if
condition|(
literal|null
operator|!=
name|fs
condition|)
block|{
name|fs
operator|.
name|delete
argument_list|(
name|hdfsTestDir
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|fs
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
name|cluster
operator|.
name|shutdown
argument_list|()
expr_stmt|;
block|}
block|}
comment|// setrep for file and directory.
annotation|@
name|Test
argument_list|(
name|timeout
operator|=
literal|30000
argument_list|)
DECL|method|testSetrep ()
specifier|public
name|void
name|testSetrep
parameter_list|()
throws|throws
name|Exception
block|{
name|Configuration
name|conf
init|=
operator|new
name|Configuration
argument_list|()
decl_stmt|;
name|MiniDFSCluster
name|cluster
init|=
operator|new
name|MiniDFSCluster
operator|.
name|Builder
argument_list|(
name|conf
argument_list|)
operator|.
name|numDataNodes
argument_list|(
literal|1
argument_list|)
operator|.
name|format
argument_list|(
literal|true
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
name|FsShell
name|shell
init|=
literal|null
decl_stmt|;
name|FileSystem
name|fs
init|=
literal|null
decl_stmt|;
specifier|final
name|String
name|testdir1
init|=
literal|"/tmp/TestDFSShell-testSetrep-"
operator|+
name|counter
operator|.
name|getAndIncrement
argument_list|()
decl_stmt|;
specifier|final
name|String
name|testdir2
init|=
name|testdir1
operator|+
literal|"/nestedDir"
decl_stmt|;
specifier|final
name|Path
name|hdfsFile1
init|=
operator|new
name|Path
argument_list|(
name|testdir1
argument_list|,
literal|"testFileForSetrep"
argument_list|)
decl_stmt|;
specifier|final
name|Path
name|hdfsFile2
init|=
operator|new
name|Path
argument_list|(
name|testdir2
argument_list|,
literal|"testFileForSetrep"
argument_list|)
decl_stmt|;
specifier|final
name|Short
name|oldRepFactor
init|=
operator|new
name|Short
argument_list|(
operator|(
name|short
operator|)
literal|1
argument_list|)
decl_stmt|;
specifier|final
name|Short
name|newRepFactor
init|=
operator|new
name|Short
argument_list|(
operator|(
name|short
operator|)
literal|3
argument_list|)
decl_stmt|;
try|try
block|{
name|String
index|[]
name|argv
decl_stmt|;
name|cluster
operator|.
name|waitActive
argument_list|()
expr_stmt|;
name|fs
operator|=
name|cluster
operator|.
name|getFileSystem
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|fs
operator|.
name|mkdirs
argument_list|(
operator|new
name|Path
argument_list|(
name|testdir2
argument_list|)
argument_list|)
argument_list|,
name|is
argument_list|(
literal|true
argument_list|)
argument_list|)
expr_stmt|;
name|shell
operator|=
operator|new
name|FsShell
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|fs
operator|.
name|create
argument_list|(
name|hdfsFile1
argument_list|,
literal|true
argument_list|)
operator|.
name|close
argument_list|()
expr_stmt|;
name|fs
operator|.
name|create
argument_list|(
name|hdfsFile2
argument_list|,
literal|true
argument_list|)
operator|.
name|close
argument_list|()
expr_stmt|;
comment|// Tests for setrep on a file.
name|argv
operator|=
operator|new
name|String
index|[]
block|{
literal|"-setrep"
block|,
name|newRepFactor
operator|.
name|toString
argument_list|()
block|,
name|hdfsFile1
operator|.
name|toString
argument_list|()
block|}
expr_stmt|;
name|assertThat
argument_list|(
name|shell
operator|.
name|run
argument_list|(
name|argv
argument_list|)
argument_list|,
name|is
argument_list|(
name|SUCCESS
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|fs
operator|.
name|getFileStatus
argument_list|(
name|hdfsFile1
argument_list|)
operator|.
name|getReplication
argument_list|()
argument_list|,
name|is
argument_list|(
name|newRepFactor
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|fs
operator|.
name|getFileStatus
argument_list|(
name|hdfsFile2
argument_list|)
operator|.
name|getReplication
argument_list|()
argument_list|,
name|is
argument_list|(
name|oldRepFactor
argument_list|)
argument_list|)
expr_stmt|;
comment|// Tests for setrep
comment|// Tests for setrep on a directory and make sure it is applied recursively.
name|argv
operator|=
operator|new
name|String
index|[]
block|{
literal|"-setrep"
block|,
name|newRepFactor
operator|.
name|toString
argument_list|()
block|,
name|testdir1
block|}
expr_stmt|;
name|assertThat
argument_list|(
name|shell
operator|.
name|run
argument_list|(
name|argv
argument_list|)
argument_list|,
name|is
argument_list|(
name|SUCCESS
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|fs
operator|.
name|getFileStatus
argument_list|(
name|hdfsFile1
argument_list|)
operator|.
name|getReplication
argument_list|()
argument_list|,
name|is
argument_list|(
name|newRepFactor
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|fs
operator|.
name|getFileStatus
argument_list|(
name|hdfsFile2
argument_list|)
operator|.
name|getReplication
argument_list|()
argument_list|,
name|is
argument_list|(
name|newRepFactor
argument_list|)
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
name|shell
operator|!=
literal|null
condition|)
block|{
name|shell
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
name|cluster
operator|.
name|shutdown
argument_list|()
expr_stmt|;
block|}
block|}
comment|/**    * Delete a file optionally configuring trash on the server and client.    */
DECL|method|deleteFileUsingTrash ( boolean serverTrash, boolean clientTrash)
specifier|private
name|void
name|deleteFileUsingTrash
parameter_list|(
name|boolean
name|serverTrash
parameter_list|,
name|boolean
name|clientTrash
parameter_list|)
throws|throws
name|Exception
block|{
comment|// Run a cluster, optionally with trash enabled on the server
name|Configuration
name|serverConf
init|=
operator|new
name|HdfsConfiguration
argument_list|()
decl_stmt|;
if|if
condition|(
name|serverTrash
condition|)
block|{
name|serverConf
operator|.
name|setLong
argument_list|(
name|FS_TRASH_INTERVAL_KEY
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|MiniDFSCluster
name|cluster
init|=
operator|new
name|MiniDFSCluster
operator|.
name|Builder
argument_list|(
name|serverConf
argument_list|)
operator|.
name|numDataNodes
argument_list|(
literal|1
argument_list|)
operator|.
name|format
argument_list|(
literal|true
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
name|Configuration
name|clientConf
init|=
operator|new
name|Configuration
argument_list|(
name|serverConf
argument_list|)
decl_stmt|;
comment|// Create a client, optionally with trash enabled
if|if
condition|(
name|clientTrash
condition|)
block|{
name|clientConf
operator|.
name|setLong
argument_list|(
name|FS_TRASH_INTERVAL_KEY
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|clientConf
operator|.
name|setLong
argument_list|(
name|FS_TRASH_INTERVAL_KEY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|FsShell
name|shell
init|=
operator|new
name|FsShell
argument_list|(
name|clientConf
argument_list|)
decl_stmt|;
name|FileSystem
name|fs
init|=
literal|null
decl_stmt|;
try|try
block|{
comment|// Create and delete a file
name|fs
operator|=
name|cluster
operator|.
name|getFileSystem
argument_list|()
expr_stmt|;
comment|// Use a separate tmp dir for each invocation.
specifier|final
name|String
name|testdir
init|=
literal|"/tmp/TestDFSShell-deleteFileUsingTrash-"
operator|+
name|counter
operator|.
name|getAndIncrement
argument_list|()
decl_stmt|;
name|writeFile
argument_list|(
name|fs
argument_list|,
operator|new
name|Path
argument_list|(
name|testdir
argument_list|,
literal|"foo"
argument_list|)
argument_list|)
expr_stmt|;
specifier|final
name|String
name|testFile
init|=
name|testdir
operator|+
literal|"/foo"
decl_stmt|;
specifier|final
name|String
name|trashFile
init|=
name|shell
operator|.
name|getCurrentTrashDir
argument_list|()
operator|+
literal|"/"
operator|+
name|testFile
decl_stmt|;
name|String
index|[]
name|argv
init|=
operator|new
name|String
index|[]
block|{
literal|"-rm"
block|,
name|testFile
block|}
decl_stmt|;
name|int
name|res
init|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"rm failed"
argument_list|,
literal|0
argument_list|,
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|serverTrash
condition|)
block|{
comment|// If the server config was set we should use it unconditionally
name|assertTrue
argument_list|(
literal|"File not in trash"
argument_list|,
name|fs
operator|.
name|exists
argument_list|(
operator|new
name|Path
argument_list|(
name|trashFile
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|clientTrash
condition|)
block|{
comment|// If the server config was not set but the client config was
comment|// set then we should use it
name|assertTrue
argument_list|(
literal|"File not in trashed"
argument_list|,
name|fs
operator|.
name|exists
argument_list|(
operator|new
name|Path
argument_list|(
name|trashFile
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// If neither was set then we should not have trashed the file
name|assertFalse
argument_list|(
literal|"File was not removed"
argument_list|,
name|fs
operator|.
name|exists
argument_list|(
operator|new
name|Path
argument_list|(
name|testFile
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
literal|"File was trashed"
argument_list|,
name|fs
operator|.
name|exists
argument_list|(
operator|new
name|Path
argument_list|(
name|trashFile
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
finally|finally
block|{
if|if
condition|(
name|fs
operator|!=
literal|null
condition|)
block|{
name|fs
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|cluster
operator|!=
literal|null
condition|)
block|{
name|cluster
operator|.
name|shutdown
argument_list|()
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Test
argument_list|(
name|timeout
operator|=
literal|300000
argument_list|)
DECL|method|testAppendToFile ()
specifier|public
name|void
name|testAppendToFile
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|int
name|inputFileLength
init|=
literal|1024
operator|*
literal|1024
decl_stmt|;
name|File
name|testRoot
init|=
operator|new
name|File
argument_list|(
name|TEST_ROOT_DIR
argument_list|,
literal|"testAppendtoFileDir"
argument_list|)
decl_stmt|;
name|testRoot
operator|.
name|mkdirs
argument_list|()
expr_stmt|;
name|File
name|file1
init|=
operator|new
name|File
argument_list|(
name|testRoot
argument_list|,
literal|"file1"
argument_list|)
decl_stmt|;
name|File
name|file2
init|=
operator|new
name|File
argument_list|(
name|testRoot
argument_list|,
literal|"file2"
argument_list|)
decl_stmt|;
name|createLocalFileWithRandomData
argument_list|(
name|inputFileLength
argument_list|,
name|file1
argument_list|)
expr_stmt|;
name|createLocalFileWithRandomData
argument_list|(
name|inputFileLength
argument_list|,
name|file2
argument_list|)
expr_stmt|;
name|Configuration
name|conf
init|=
operator|new
name|HdfsConfiguration
argument_list|()
decl_stmt|;
name|MiniDFSCluster
name|cluster
init|=
operator|new
name|MiniDFSCluster
operator|.
name|Builder
argument_list|(
name|conf
argument_list|)
operator|.
name|numDataNodes
argument_list|(
literal|1
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
name|cluster
operator|.
name|waitActive
argument_list|()
expr_stmt|;
try|try
block|{
name|FileSystem
name|dfs
init|=
name|cluster
operator|.
name|getFileSystem
argument_list|()
decl_stmt|;
name|assertTrue
argument_list|(
literal|"Not a HDFS: "
operator|+
name|dfs
operator|.
name|getUri
argument_list|()
argument_list|,
name|dfs
operator|instanceof
name|DistributedFileSystem
argument_list|)
expr_stmt|;
comment|// Run appendToFile once, make sure that the target file is
comment|// created and is of the right size.
name|Path
name|remoteFile
init|=
operator|new
name|Path
argument_list|(
literal|"/remoteFile"
argument_list|)
decl_stmt|;
name|FsShell
name|shell
init|=
operator|new
name|FsShell
argument_list|()
decl_stmt|;
name|shell
operator|.
name|setConf
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|String
index|[]
name|argv
init|=
operator|new
name|String
index|[]
block|{
literal|"-appendToFile"
block|,
name|file1
operator|.
name|toString
argument_list|()
block|,
name|file2
operator|.
name|toString
argument_list|()
block|,
name|remoteFile
operator|.
name|toString
argument_list|()
block|}
decl_stmt|;
name|int
name|res
init|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|res
argument_list|,
name|is
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|dfs
operator|.
name|getFileStatus
argument_list|(
name|remoteFile
argument_list|)
operator|.
name|getLen
argument_list|()
argument_list|,
name|is
argument_list|(
operator|(
name|long
operator|)
name|inputFileLength
operator|*
literal|2
argument_list|)
argument_list|)
expr_stmt|;
comment|// Run the command once again and make sure that the target file
comment|// size has been doubled.
name|res
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|res
argument_list|,
name|is
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|dfs
operator|.
name|getFileStatus
argument_list|(
name|remoteFile
argument_list|)
operator|.
name|getLen
argument_list|()
argument_list|,
name|is
argument_list|(
operator|(
name|long
operator|)
name|inputFileLength
operator|*
literal|4
argument_list|)
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|cluster
operator|.
name|shutdown
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
argument_list|(
name|timeout
operator|=
literal|300000
argument_list|)
DECL|method|testAppendToFileBadArgs ()
specifier|public
name|void
name|testAppendToFileBadArgs
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|int
name|inputFileLength
init|=
literal|1024
operator|*
literal|1024
decl_stmt|;
name|File
name|testRoot
init|=
operator|new
name|File
argument_list|(
name|TEST_ROOT_DIR
argument_list|,
literal|"testAppendToFileBadArgsDir"
argument_list|)
decl_stmt|;
name|testRoot
operator|.
name|mkdirs
argument_list|()
expr_stmt|;
name|File
name|file1
init|=
operator|new
name|File
argument_list|(
name|testRoot
argument_list|,
literal|"file1"
argument_list|)
decl_stmt|;
name|createLocalFileWithRandomData
argument_list|(
name|inputFileLength
argument_list|,
name|file1
argument_list|)
expr_stmt|;
name|Configuration
name|conf
init|=
operator|new
name|HdfsConfiguration
argument_list|()
decl_stmt|;
name|MiniDFSCluster
name|cluster
init|=
operator|new
name|MiniDFSCluster
operator|.
name|Builder
argument_list|(
name|conf
argument_list|)
operator|.
name|numDataNodes
argument_list|(
literal|1
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
name|cluster
operator|.
name|waitActive
argument_list|()
expr_stmt|;
try|try
block|{
name|FileSystem
name|dfs
init|=
name|cluster
operator|.
name|getFileSystem
argument_list|()
decl_stmt|;
name|assertTrue
argument_list|(
literal|"Not a HDFS: "
operator|+
name|dfs
operator|.
name|getUri
argument_list|()
argument_list|,
name|dfs
operator|instanceof
name|DistributedFileSystem
argument_list|)
expr_stmt|;
comment|// Run appendToFile with insufficient arguments.
name|FsShell
name|shell
init|=
operator|new
name|FsShell
argument_list|()
decl_stmt|;
name|shell
operator|.
name|setConf
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|String
index|[]
name|argv
init|=
operator|new
name|String
index|[]
block|{
literal|"-appendToFile"
block|,
name|file1
operator|.
name|toString
argument_list|()
block|}
decl_stmt|;
name|int
name|res
init|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|res
argument_list|,
name|not
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|// Mix stdin with other input files. Must fail.
name|Path
name|remoteFile
init|=
operator|new
name|Path
argument_list|(
literal|"/remoteFile"
argument_list|)
decl_stmt|;
name|argv
operator|=
operator|new
name|String
index|[]
block|{
literal|"-appendToFile"
block|,
name|file1
operator|.
name|toString
argument_list|()
block|,
literal|"-"
block|,
name|remoteFile
operator|.
name|toString
argument_list|()
block|}
expr_stmt|;
name|res
operator|=
name|ToolRunner
operator|.
name|run
argument_list|(
name|shell
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|res
argument_list|,
name|not
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|cluster
operator|.
name|shutdown
argument_list|()
expr_stmt|;
block|}
block|}
comment|/**    * Test that the server trash configuration is respected when    * the client configuration is not set.    */
annotation|@
name|Test
argument_list|(
name|timeout
operator|=
literal|30000
argument_list|)
DECL|method|testServerConfigRespected ()
specifier|public
name|void
name|testServerConfigRespected
parameter_list|()
throws|throws
name|Exception
block|{
name|deleteFileUsingTrash
argument_list|(
literal|true
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
comment|/**    * Test that server trash configuration is respected even when the    * client configuration is set.    */
annotation|@
name|Test
argument_list|(
name|timeout
operator|=
literal|30000
argument_list|)
DECL|method|testServerConfigRespectedWithClient ()
specifier|public
name|void
name|testServerConfigRespectedWithClient
parameter_list|()
throws|throws
name|Exception
block|{
name|deleteFileUsingTrash
argument_list|(
literal|true
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
comment|/**    * Test that the client trash configuration is respected when    * the server configuration is not set.    */
annotation|@
name|Test
argument_list|(
name|timeout
operator|=
literal|30000
argument_list|)
DECL|method|testClientConfigRespected ()
specifier|public
name|void
name|testClientConfigRespected
parameter_list|()
throws|throws
name|Exception
block|{
name|deleteFileUsingTrash
argument_list|(
literal|false
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
comment|/**    * Test that trash is disabled by default.    */
annotation|@
name|Test
argument_list|(
name|timeout
operator|=
literal|30000
argument_list|)
DECL|method|testNoTrashConfig ()
specifier|public
name|void
name|testNoTrashConfig
parameter_list|()
throws|throws
name|Exception
block|{
name|deleteFileUsingTrash
argument_list|(
literal|false
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
block|}
end_class

end_unit

