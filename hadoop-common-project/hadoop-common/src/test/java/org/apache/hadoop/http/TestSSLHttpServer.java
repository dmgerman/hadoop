begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/**  * Licensed to the Apache Software Foundation (ASF) under one  * or more contributor license agreements.  See the NOTICE file  * distributed with this work for additional information  * regarding copyright ownership.  The ASF licenses this file  * to you under the Apache License, Version 2.0 (the  * "License"); you may not use this file except in compliance  * with the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
DECL|package|org.apache.hadoop.http
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|http
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|ByteArrayOutputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|File
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|InetAddress
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|Socket
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URI
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URISyntaxException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URL
import|;
end_import

begin_import
import|import
name|java
operator|.
name|security
operator|.
name|GeneralSecurityException
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|net
operator|.
name|ssl
operator|.
name|HttpsURLConnection
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|net
operator|.
name|ssl
operator|.
name|SSLHandshakeException
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|net
operator|.
name|ssl
operator|.
name|SSLSocket
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|net
operator|.
name|ssl
operator|.
name|SSLSocketFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|conf
operator|.
name|Configuration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|FileUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|http
operator|.
name|TestHttpServer
operator|.
name|EchoServlet
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|IOUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|net
operator|.
name|NetUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|ssl
operator|.
name|KeyStoreTestUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|ssl
operator|.
name|SSLFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|test
operator|.
name|GenericTestUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|util
operator|.
name|StringUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|AfterClass
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|BeforeClass
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Test
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|Logger
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|LoggerFactory
import|;
end_import

begin_comment
comment|/**  * This testcase issues SSL certificates configures the HttpServer to serve  * HTTPS using the created certificates and calls an echo servlet using the  * corresponding HTTPS URL.  */
end_comment

begin_class
DECL|class|TestSSLHttpServer
specifier|public
class|class
name|TestSSLHttpServer
extends|extends
name|HttpServerFunctionalTest
block|{
DECL|field|BASEDIR
specifier|private
specifier|static
specifier|final
name|String
name|BASEDIR
init|=
name|GenericTestUtils
operator|.
name|getTempPath
argument_list|(
name|TestSSLHttpServer
operator|.
name|class
operator|.
name|getSimpleName
argument_list|()
argument_list|)
decl_stmt|;
DECL|field|LOG
specifier|private
specifier|static
specifier|final
name|Logger
name|LOG
init|=
name|LoggerFactory
operator|.
name|getLogger
argument_list|(
name|TestSSLHttpServer
operator|.
name|class
argument_list|)
decl_stmt|;
DECL|field|HTTPS_CIPHER_SUITES_KEY
specifier|private
specifier|static
specifier|final
name|String
name|HTTPS_CIPHER_SUITES_KEY
init|=
literal|"https.cipherSuites"
decl_stmt|;
DECL|field|JAVAX_NET_DEBUG_KEY
specifier|private
specifier|static
specifier|final
name|String
name|JAVAX_NET_DEBUG_KEY
init|=
literal|"javax.net.debug"
decl_stmt|;
DECL|field|SSL_SERVER_KEYSTORE_PROP_PREFIX
specifier|private
specifier|static
specifier|final
name|String
name|SSL_SERVER_KEYSTORE_PROP_PREFIX
init|=
literal|"ssl.server"
operator|+
literal|".keystore"
decl_stmt|;
DECL|field|SSL_SERVER_TRUSTSTORE_PROP_PREFIX
specifier|private
specifier|static
specifier|final
name|String
name|SSL_SERVER_TRUSTSTORE_PROP_PREFIX
init|=
literal|"ssl.server"
operator|+
literal|".truststore"
decl_stmt|;
DECL|field|SERVLET_NAME_LONGHEADER
specifier|private
specifier|static
specifier|final
name|String
name|SERVLET_NAME_LONGHEADER
init|=
literal|"longheader"
decl_stmt|;
DECL|field|SERVLET_PATH_LONGHEADER
specifier|private
specifier|static
specifier|final
name|String
name|SERVLET_PATH_LONGHEADER
init|=
literal|"/"
operator|+
name|SERVLET_NAME_LONGHEADER
decl_stmt|;
DECL|field|SERVLET_NAME_ECHO
specifier|private
specifier|static
specifier|final
name|String
name|SERVLET_NAME_ECHO
init|=
literal|"echo"
decl_stmt|;
DECL|field|SERVLET_PATH_ECHO
specifier|private
specifier|static
specifier|final
name|String
name|SERVLET_PATH_ECHO
init|=
literal|"/"
operator|+
name|SERVLET_NAME_ECHO
decl_stmt|;
DECL|field|server
specifier|private
specifier|static
name|HttpServer2
name|server
decl_stmt|;
DECL|field|keystoreDir
specifier|private
specifier|static
name|String
name|keystoreDir
decl_stmt|;
DECL|field|sslConfDir
specifier|private
specifier|static
name|String
name|sslConfDir
decl_stmt|;
DECL|field|clientSslFactory
specifier|private
specifier|static
name|SSLFactory
name|clientSslFactory
decl_stmt|;
DECL|field|cipherSuitesPropertyValue
specifier|private
specifier|static
name|String
name|cipherSuitesPropertyValue
decl_stmt|;
DECL|field|sslDebugPropertyValue
specifier|private
specifier|static
name|String
name|sslDebugPropertyValue
decl_stmt|;
DECL|field|EXCLUDED_CIPHERS
specifier|private
specifier|static
specifier|final
name|String
name|EXCLUDED_CIPHERS
init|=
literal|"TLS_ECDHE_RSA_WITH_RC4_128_SHA,"
operator|+
literal|"SSL_DHE_RSA_EXPORT_WITH_DES40_CBC_SHA, \n"
operator|+
literal|"SSL_RSA_WITH_DES_CBC_SHA,"
operator|+
literal|"SSL_DHE_RSA_WITH_DES_CBC_SHA,  "
operator|+
literal|"SSL_RSA_EXPORT_WITH_RC4_40_MD5,\t \n"
operator|+
literal|"SSL_RSA_EXPORT_WITH_DES40_CBC_SHA,"
operator|+
literal|"SSL_RSA_WITH_RC4_128_MD5 \t"
decl_stmt|;
DECL|field|ONE_ENABLED_CIPHERS
specifier|private
specifier|static
specifier|final
name|String
name|ONE_ENABLED_CIPHERS
init|=
name|EXCLUDED_CIPHERS
operator|+
literal|",TLS_RSA_WITH_AES_128_CBC_SHA"
decl_stmt|;
DECL|field|EXCLUSIVE_ENABLED_CIPHERS
specifier|private
specifier|static
specifier|final
name|String
name|EXCLUSIVE_ENABLED_CIPHERS
init|=
literal|"\tTLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA, \n"
operator|+
literal|"TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA,"
operator|+
literal|"TLS_RSA_WITH_AES_128_CBC_SHA,"
operator|+
literal|"TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA,  "
operator|+
literal|"TLS_ECDH_RSA_WITH_AES_128_CBC_SHA,"
operator|+
literal|"TLS_DHE_RSA_WITH_AES_128_CBC_SHA,\t\n "
operator|+
literal|"TLS_DHE_DSS_WITH_AES_128_CBC_SHA"
decl_stmt|;
DECL|field|INCLUDED_PROTOCOLS
specifier|private
specifier|static
specifier|final
name|String
name|INCLUDED_PROTOCOLS
init|=
literal|"SSLv2Hello,TLSv1.1"
decl_stmt|;
annotation|@
name|BeforeClass
DECL|method|setup ()
specifier|public
specifier|static
name|void
name|setup
parameter_list|()
throws|throws
name|Exception
block|{
name|turnOnSSLDebugLogging
argument_list|()
expr_stmt|;
name|storeHttpsCipherSuites
argument_list|()
expr_stmt|;
name|Configuration
name|conf
init|=
operator|new
name|Configuration
argument_list|()
decl_stmt|;
name|conf
operator|.
name|setInt
argument_list|(
name|HttpServer2
operator|.
name|HTTP_MAX_THREADS_KEY
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|File
name|base
init|=
operator|new
name|File
argument_list|(
name|BASEDIR
argument_list|)
decl_stmt|;
name|FileUtil
operator|.
name|fullyDelete
argument_list|(
name|base
argument_list|)
expr_stmt|;
name|base
operator|.
name|mkdirs
argument_list|()
expr_stmt|;
name|keystoreDir
operator|=
operator|new
name|File
argument_list|(
name|BASEDIR
argument_list|)
operator|.
name|getAbsolutePath
argument_list|()
expr_stmt|;
name|sslConfDir
operator|=
name|KeyStoreTestUtil
operator|.
name|getClasspathDir
argument_list|(
name|TestSSLHttpServer
operator|.
name|class
argument_list|)
expr_stmt|;
name|KeyStoreTestUtil
operator|.
name|setupSSLConfig
argument_list|(
name|keystoreDir
argument_list|,
name|sslConfDir
argument_list|,
name|conf
argument_list|,
literal|false
argument_list|,
literal|true
argument_list|,
name|EXCLUDED_CIPHERS
argument_list|)
expr_stmt|;
name|Configuration
name|sslConf
init|=
name|KeyStoreTestUtil
operator|.
name|getSslConfig
argument_list|()
decl_stmt|;
name|clientSslFactory
operator|=
operator|new
name|SSLFactory
argument_list|(
name|SSLFactory
operator|.
name|Mode
operator|.
name|CLIENT
argument_list|,
name|sslConf
argument_list|)
expr_stmt|;
name|clientSslFactory
operator|.
name|init
argument_list|()
expr_stmt|;
name|setupServer
argument_list|(
name|conf
argument_list|,
name|sslConf
argument_list|)
expr_stmt|;
name|baseUrl
operator|=
operator|new
name|URL
argument_list|(
literal|"https://"
operator|+
name|NetUtils
operator|.
name|getHostPortString
argument_list|(
name|server
operator|.
name|getConnectorAddress
argument_list|(
literal|0
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"HTTP server started: "
operator|+
name|baseUrl
argument_list|)
expr_stmt|;
block|}
DECL|method|setupServer (Configuration conf, Configuration sslConf)
specifier|private
specifier|static
name|void
name|setupServer
parameter_list|(
name|Configuration
name|conf
parameter_list|,
name|Configuration
name|sslConf
parameter_list|)
throws|throws
name|IOException
throws|,
name|URISyntaxException
block|{
name|conf
operator|.
name|set
argument_list|(
name|SSLFactory
operator|.
name|SSL_ENABLED_PROTOCOLS_KEY
argument_list|,
name|INCLUDED_PROTOCOLS
argument_list|)
expr_stmt|;
name|sslConf
operator|.
name|set
argument_list|(
name|SSLFactory
operator|.
name|SSL_ENABLED_PROTOCOLS_KEY
argument_list|,
name|INCLUDED_PROTOCOLS
argument_list|)
expr_stmt|;
name|server
operator|=
operator|new
name|HttpServer2
operator|.
name|Builder
argument_list|()
operator|.
name|setName
argument_list|(
literal|"test"
argument_list|)
operator|.
name|addEndpoint
argument_list|(
operator|new
name|URI
argument_list|(
literal|"https://localhost"
argument_list|)
argument_list|)
operator|.
name|setConf
argument_list|(
name|conf
argument_list|)
operator|.
name|keyPassword
argument_list|(
name|sslConf
operator|.
name|get
argument_list|(
name|SSL_SERVER_KEYSTORE_PROP_PREFIX
operator|+
literal|".keypassword"
argument_list|)
argument_list|)
operator|.
name|keyStore
argument_list|(
name|sslConf
operator|.
name|get
argument_list|(
name|SSL_SERVER_KEYSTORE_PROP_PREFIX
operator|+
literal|".location"
argument_list|)
argument_list|,
name|sslConf
operator|.
name|get
argument_list|(
name|SSL_SERVER_KEYSTORE_PROP_PREFIX
operator|+
literal|".password"
argument_list|)
argument_list|,
name|sslConf
operator|.
name|get
argument_list|(
name|SSL_SERVER_KEYSTORE_PROP_PREFIX
operator|+
literal|".type"
argument_list|,
literal|"jks"
argument_list|)
argument_list|)
operator|.
name|trustStore
argument_list|(
name|sslConf
operator|.
name|get
argument_list|(
name|SSL_SERVER_TRUSTSTORE_PROP_PREFIX
operator|+
literal|".location"
argument_list|)
argument_list|,
name|sslConf
operator|.
name|get
argument_list|(
name|SSL_SERVER_TRUSTSTORE_PROP_PREFIX
operator|+
literal|".password"
argument_list|)
argument_list|,
name|sslConf
operator|.
name|get
argument_list|(
name|SSL_SERVER_TRUSTSTORE_PROP_PREFIX
operator|+
literal|".type"
argument_list|,
literal|"jks"
argument_list|)
argument_list|)
operator|.
name|excludeCiphers
argument_list|(
name|sslConf
operator|.
name|get
argument_list|(
literal|"ssl.server.exclude.cipher.list"
argument_list|)
argument_list|)
operator|.
name|build
argument_list|()
expr_stmt|;
name|server
operator|.
name|addServlet
argument_list|(
name|SERVLET_NAME_ECHO
argument_list|,
name|SERVLET_PATH_ECHO
argument_list|,
name|EchoServlet
operator|.
name|class
argument_list|)
expr_stmt|;
name|server
operator|.
name|addServlet
argument_list|(
name|SERVLET_NAME_LONGHEADER
argument_list|,
name|SERVLET_PATH_LONGHEADER
argument_list|,
name|LongHeaderServlet
operator|.
name|class
argument_list|)
expr_stmt|;
name|server
operator|.
name|start
argument_list|()
expr_stmt|;
block|}
annotation|@
name|AfterClass
DECL|method|cleanup ()
specifier|public
specifier|static
name|void
name|cleanup
parameter_list|()
throws|throws
name|Exception
block|{
name|server
operator|.
name|stop
argument_list|()
expr_stmt|;
name|FileUtil
operator|.
name|fullyDelete
argument_list|(
operator|new
name|File
argument_list|(
name|BASEDIR
argument_list|)
argument_list|)
expr_stmt|;
name|KeyStoreTestUtil
operator|.
name|cleanupSSLConfig
argument_list|(
name|keystoreDir
argument_list|,
name|sslConfDir
argument_list|)
expr_stmt|;
name|clientSslFactory
operator|.
name|destroy
argument_list|()
expr_stmt|;
name|restoreHttpsCipherSuites
argument_list|()
expr_stmt|;
name|restoreSSLDebugLogging
argument_list|()
expr_stmt|;
block|}
comment|/**    * Stores the JVM property value of https.cipherSuites and sets its    * value to an empty string.    * This ensures that the value https.cipherSuites does    * not affect the result of tests.    */
DECL|method|storeHttpsCipherSuites ()
specifier|private
specifier|static
name|void
name|storeHttpsCipherSuites
parameter_list|()
block|{
name|String
name|cipherSuites
init|=
name|System
operator|.
name|getProperty
argument_list|(
name|HTTPS_CIPHER_SUITES_KEY
argument_list|)
decl_stmt|;
if|if
condition|(
name|cipherSuites
operator|!=
literal|null
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Found value for property {}: {}"
argument_list|,
name|HTTPS_CIPHER_SUITES_KEY
argument_list|,
name|cipherSuites
argument_list|)
expr_stmt|;
name|cipherSuitesPropertyValue
operator|=
name|cipherSuites
expr_stmt|;
block|}
name|System
operator|.
name|clearProperty
argument_list|(
name|HTTPS_CIPHER_SUITES_KEY
argument_list|)
expr_stmt|;
block|}
DECL|method|restoreHttpsCipherSuites ()
specifier|private
specifier|static
name|void
name|restoreHttpsCipherSuites
parameter_list|()
block|{
if|if
condition|(
name|cipherSuitesPropertyValue
operator|!=
literal|null
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Restoring property {} to value: {}"
argument_list|,
name|HTTPS_CIPHER_SUITES_KEY
argument_list|,
name|cipherSuitesPropertyValue
argument_list|)
expr_stmt|;
name|System
operator|.
name|setProperty
argument_list|(
name|HTTPS_CIPHER_SUITES_KEY
argument_list|,
name|cipherSuitesPropertyValue
argument_list|)
expr_stmt|;
name|cipherSuitesPropertyValue
operator|=
literal|null
expr_stmt|;
block|}
block|}
DECL|method|turnOnSSLDebugLogging ()
specifier|private
specifier|static
name|void
name|turnOnSSLDebugLogging
parameter_list|()
block|{
name|String
name|sslDebug
init|=
name|System
operator|.
name|getProperty
argument_list|(
name|JAVAX_NET_DEBUG_KEY
argument_list|)
decl_stmt|;
if|if
condition|(
name|sslDebug
operator|!=
literal|null
condition|)
block|{
name|sslDebugPropertyValue
operator|=
name|sslDebug
expr_stmt|;
block|}
name|System
operator|.
name|setProperty
argument_list|(
name|JAVAX_NET_DEBUG_KEY
argument_list|,
literal|"all"
argument_list|)
expr_stmt|;
block|}
DECL|method|restoreSSLDebugLogging ()
specifier|private
specifier|static
name|void
name|restoreSSLDebugLogging
parameter_list|()
block|{
if|if
condition|(
name|sslDebugPropertyValue
operator|!=
literal|null
condition|)
block|{
name|System
operator|.
name|setProperty
argument_list|(
name|JAVAX_NET_DEBUG_KEY
argument_list|,
name|sslDebugPropertyValue
argument_list|)
expr_stmt|;
name|sslDebugPropertyValue
operator|=
literal|null
expr_stmt|;
block|}
else|else
block|{
name|System
operator|.
name|clearProperty
argument_list|(
name|JAVAX_NET_DEBUG_KEY
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|getConnectionWithSSLSocketFactory (URL url, String ciphers)
specifier|private
name|HttpsURLConnection
name|getConnectionWithSSLSocketFactory
parameter_list|(
name|URL
name|url
parameter_list|,
name|String
name|ciphers
parameter_list|)
throws|throws
name|IOException
throws|,
name|GeneralSecurityException
block|{
name|HttpsURLConnection
name|conn
init|=
operator|(
name|HttpsURLConnection
operator|)
name|url
operator|.
name|openConnection
argument_list|()
decl_stmt|;
name|SSLSocketFactory
name|sslSocketFactory
init|=
name|clientSslFactory
operator|.
name|createSSLSocketFactory
argument_list|()
decl_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Creating "
operator|+
name|PreferredCipherSSLSocketFactory
operator|.
name|class
operator|.
name|getCanonicalName
argument_list|()
operator|+
literal|" with ciphers: "
operator|+
name|ciphers
argument_list|)
expr_stmt|;
name|PreferredCipherSSLSocketFactory
name|cipherSSLSocketFactory
init|=
operator|new
name|PreferredCipherSSLSocketFactory
argument_list|(
name|sslSocketFactory
argument_list|,
name|StringUtils
operator|.
name|getTrimmedStrings
argument_list|(
name|ciphers
argument_list|)
argument_list|)
decl_stmt|;
name|conn
operator|.
name|setSSLSocketFactory
argument_list|(
name|cipherSSLSocketFactory
argument_list|)
expr_stmt|;
return|return
name|conn
return|;
block|}
specifier|private
name|HttpsURLConnection
DECL|method|getConnectionWithPreferredProtocolSSLSocketFactory (URL url, String protocols)
name|getConnectionWithPreferredProtocolSSLSocketFactory
parameter_list|(
name|URL
name|url
parameter_list|,
name|String
name|protocols
parameter_list|)
throws|throws
name|IOException
throws|,
name|GeneralSecurityException
block|{
name|HttpsURLConnection
name|conn
init|=
operator|(
name|HttpsURLConnection
operator|)
name|url
operator|.
name|openConnection
argument_list|()
decl_stmt|;
name|SSLSocketFactory
name|sslSocketFactory
init|=
name|clientSslFactory
operator|.
name|createSSLSocketFactory
argument_list|()
decl_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Creating "
operator|+
name|PreferredProtocolSSLSocketFactory
operator|.
name|class
operator|.
name|getCanonicalName
argument_list|()
operator|+
literal|" with protocols: "
operator|+
name|protocols
argument_list|)
expr_stmt|;
name|PreferredProtocolSSLSocketFactory
name|cipherSSLSocketFactory
init|=
operator|new
name|PreferredProtocolSSLSocketFactory
argument_list|(
name|sslSocketFactory
argument_list|,
name|StringUtils
operator|.
name|getTrimmedStrings
argument_list|(
name|protocols
argument_list|)
argument_list|)
decl_stmt|;
name|conn
operator|.
name|setSSLSocketFactory
argument_list|(
name|cipherSSLSocketFactory
argument_list|)
expr_stmt|;
return|return
name|conn
return|;
block|}
annotation|@
name|Test
DECL|method|testEcho ()
specifier|public
name|void
name|testEcho
parameter_list|()
throws|throws
name|Exception
block|{
name|assertEquals
argument_list|(
literal|"a:b\nc:d\n"
argument_list|,
name|readFromURL
argument_list|(
operator|new
name|URL
argument_list|(
name|baseUrl
argument_list|,
name|SERVLET_PATH_ECHO
operator|+
literal|"?a=b&c=d"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"a:b\nc&lt;:d\ne:&gt;\n"
argument_list|,
name|readFromURL
argument_list|(
operator|new
name|URL
argument_list|(
name|baseUrl
argument_list|,
name|SERVLET_PATH_ECHO
operator|+
literal|"?a=b&c<=d&e=>"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/**    * Test that verifies headers can be up to 64K long. The test adds a 63K    * header leaving 1K for other headers. This is because the header buffer    * setting is for ALL headers, names and values included.    */
annotation|@
name|Test
DECL|method|testLongHeader ()
specifier|public
name|void
name|testLongHeader
parameter_list|()
throws|throws
name|Exception
block|{
name|URL
name|url
init|=
operator|new
name|URL
argument_list|(
name|baseUrl
argument_list|,
name|SERVLET_PATH_LONGHEADER
argument_list|)
decl_stmt|;
name|HttpsURLConnection
name|conn
init|=
operator|(
name|HttpsURLConnection
operator|)
name|url
operator|.
name|openConnection
argument_list|()
decl_stmt|;
name|conn
operator|.
name|setSSLSocketFactory
argument_list|(
name|clientSslFactory
operator|.
name|createSSLSocketFactory
argument_list|()
argument_list|)
expr_stmt|;
name|testLongHeader
argument_list|(
name|conn
argument_list|)
expr_stmt|;
block|}
DECL|method|readFromURL (URL url)
specifier|private
specifier|static
name|String
name|readFromURL
parameter_list|(
name|URL
name|url
parameter_list|)
throws|throws
name|Exception
block|{
name|HttpsURLConnection
name|conn
init|=
operator|(
name|HttpsURLConnection
operator|)
name|url
operator|.
name|openConnection
argument_list|()
decl_stmt|;
name|conn
operator|.
name|setSSLSocketFactory
argument_list|(
name|clientSslFactory
operator|.
name|createSSLSocketFactory
argument_list|()
argument_list|)
expr_stmt|;
return|return
name|readFromConnection
argument_list|(
name|conn
argument_list|)
return|;
block|}
DECL|method|readFromConnection (HttpsURLConnection conn)
specifier|private
specifier|static
name|String
name|readFromConnection
parameter_list|(
name|HttpsURLConnection
name|conn
parameter_list|)
throws|throws
name|IOException
block|{
name|InputStream
name|in
init|=
name|conn
operator|.
name|getInputStream
argument_list|()
decl_stmt|;
name|ByteArrayOutputStream
name|out
init|=
operator|new
name|ByteArrayOutputStream
argument_list|()
decl_stmt|;
name|IOUtils
operator|.
name|copyBytes
argument_list|(
name|in
argument_list|,
name|out
argument_list|,
literal|1024
argument_list|)
expr_stmt|;
return|return
name|out
operator|.
name|toString
argument_list|()
return|;
block|}
comment|/**    * Test that verifies that excluded ciphers (SSL_RSA_WITH_RC4_128_SHA,    * TLS_ECDH_ECDSA_WITH_RC4_128_SHA,TLS_ECDH_RSA_WITH_RC4_128_SHA,    * TLS_ECDHE_ECDSA_WITH_RC4_128_SHA,TLS_ECDHE_RSA_WITH_RC4_128_SHA) are not    * available for negotiation during SSL connection.    */
annotation|@
name|Test
DECL|method|testExcludedCiphers ()
specifier|public
name|void
name|testExcludedCiphers
parameter_list|()
throws|throws
name|Exception
block|{
name|URL
name|url
init|=
operator|new
name|URL
argument_list|(
name|baseUrl
argument_list|,
name|SERVLET_PATH_ECHO
operator|+
literal|"?a=b&c=d"
argument_list|)
decl_stmt|;
name|HttpsURLConnection
name|conn
init|=
name|getConnectionWithSSLSocketFactory
argument_list|(
name|url
argument_list|,
name|EXCLUDED_CIPHERS
argument_list|)
decl_stmt|;
name|assertFalse
argument_list|(
literal|"excludedCipher list is empty"
argument_list|,
name|EXCLUDED_CIPHERS
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
try|try
block|{
name|readFromConnection
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|fail
argument_list|(
literal|"No Ciphers in common, SSLHandshake must fail."
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|SSLHandshakeException
name|ex
parameter_list|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"No Ciphers in common, expected successful test result."
argument_list|,
name|ex
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Test
DECL|method|testIncludedProtocols ()
specifier|public
name|void
name|testIncludedProtocols
parameter_list|()
throws|throws
name|Exception
block|{
name|URL
name|url
init|=
operator|new
name|URL
argument_list|(
name|baseUrl
argument_list|,
name|SERVLET_PATH_ECHO
operator|+
literal|"?a=b&c=d"
argument_list|)
decl_stmt|;
name|HttpsURLConnection
name|conn
init|=
name|getConnectionWithPreferredProtocolSSLSocketFactory
argument_list|(
name|url
argument_list|,
name|INCLUDED_PROTOCOLS
argument_list|)
decl_stmt|;
name|assertFalse
argument_list|(
literal|"included protocol list is empty"
argument_list|,
name|INCLUDED_PROTOCOLS
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
name|readFromConnection
argument_list|(
name|conn
argument_list|)
expr_stmt|;
block|}
comment|/** Test that verified that additionally included cipher    * TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA is only available cipher for working    * TLS connection from client to server disabled for all other common ciphers.    */
annotation|@
name|Test
DECL|method|testOneEnabledCiphers ()
specifier|public
name|void
name|testOneEnabledCiphers
parameter_list|()
throws|throws
name|Exception
block|{
name|testEnabledCiphers
argument_list|(
name|ONE_ENABLED_CIPHERS
argument_list|)
expr_stmt|;
block|}
comment|/** Test verifies that mutually exclusive server's disabled cipher suites and    * client's enabled cipher suites can successfully establish TLS connection.    */
annotation|@
name|Test
DECL|method|testExclusiveEnabledCiphers ()
specifier|public
name|void
name|testExclusiveEnabledCiphers
parameter_list|()
throws|throws
name|Exception
block|{
name|testEnabledCiphers
argument_list|(
name|EXCLUSIVE_ENABLED_CIPHERS
argument_list|)
expr_stmt|;
block|}
DECL|method|testEnabledCiphers (String ciphers)
specifier|private
name|void
name|testEnabledCiphers
parameter_list|(
name|String
name|ciphers
parameter_list|)
throws|throws
name|IOException
throws|,
name|GeneralSecurityException
block|{
name|URL
name|url
init|=
operator|new
name|URL
argument_list|(
name|baseUrl
argument_list|,
name|SERVLET_PATH_ECHO
operator|+
literal|"?a=b&c=d"
argument_list|)
decl_stmt|;
name|HttpsURLConnection
name|conn
init|=
name|getConnectionWithSSLSocketFactory
argument_list|(
name|url
argument_list|,
name|ciphers
argument_list|)
decl_stmt|;
name|assertFalse
argument_list|(
literal|"excludedCipher list is empty"
argument_list|,
name|ciphers
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
name|String
name|out
init|=
name|readFromConnection
argument_list|(
name|conn
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
name|out
argument_list|,
literal|"a:b\nc:d\n"
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"At least one additional enabled cipher than excluded ciphers,"
operator|+
literal|" expected successful test result."
argument_list|)
expr_stmt|;
block|}
DECL|class|PreferredCipherSSLSocketFactory
specifier|private
class|class
name|PreferredCipherSSLSocketFactory
extends|extends
name|SSLSocketFactory
block|{
DECL|field|delegateSocketFactory
specifier|private
specifier|final
name|SSLSocketFactory
name|delegateSocketFactory
decl_stmt|;
DECL|field|enabledCipherSuites
specifier|private
specifier|final
name|String
index|[]
name|enabledCipherSuites
decl_stmt|;
DECL|method|PreferredCipherSSLSocketFactory (SSLSocketFactory sslSocketFactory, String[] pEnabledCipherSuites)
name|PreferredCipherSSLSocketFactory
parameter_list|(
name|SSLSocketFactory
name|sslSocketFactory
parameter_list|,
name|String
index|[]
name|pEnabledCipherSuites
parameter_list|)
block|{
name|delegateSocketFactory
operator|=
name|sslSocketFactory
expr_stmt|;
if|if
condition|(
literal|null
operator|!=
name|pEnabledCipherSuites
operator|&&
name|pEnabledCipherSuites
operator|.
name|length
operator|>
literal|0
condition|)
block|{
name|enabledCipherSuites
operator|=
name|pEnabledCipherSuites
expr_stmt|;
block|}
else|else
block|{
name|enabledCipherSuites
operator|=
literal|null
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|getDefaultCipherSuites ()
specifier|public
name|String
index|[]
name|getDefaultCipherSuites
parameter_list|()
block|{
return|return
name|delegateSocketFactory
operator|.
name|getDefaultCipherSuites
argument_list|()
return|;
block|}
annotation|@
name|Override
DECL|method|getSupportedCipherSuites ()
specifier|public
name|String
index|[]
name|getSupportedCipherSuites
parameter_list|()
block|{
return|return
name|delegateSocketFactory
operator|.
name|getSupportedCipherSuites
argument_list|()
return|;
block|}
annotation|@
name|Override
DECL|method|createSocket (Socket socket, String string, int i, boolean bln)
specifier|public
name|Socket
name|createSocket
parameter_list|(
name|Socket
name|socket
parameter_list|,
name|String
name|string
parameter_list|,
name|int
name|i
parameter_list|,
name|boolean
name|bln
parameter_list|)
throws|throws
name|IOException
block|{
name|SSLSocket
name|sslSocket
init|=
operator|(
name|SSLSocket
operator|)
name|delegateSocketFactory
operator|.
name|createSocket
argument_list|(
name|socket
argument_list|,
name|string
argument_list|,
name|i
argument_list|,
name|bln
argument_list|)
decl_stmt|;
name|setEnabledCipherSuites
argument_list|(
name|sslSocket
argument_list|)
expr_stmt|;
return|return
name|sslSocket
return|;
block|}
annotation|@
name|Override
DECL|method|createSocket (String string, int i)
specifier|public
name|Socket
name|createSocket
parameter_list|(
name|String
name|string
parameter_list|,
name|int
name|i
parameter_list|)
throws|throws
name|IOException
block|{
name|SSLSocket
name|sslSocket
init|=
operator|(
name|SSLSocket
operator|)
name|delegateSocketFactory
operator|.
name|createSocket
argument_list|(
name|string
argument_list|,
name|i
argument_list|)
decl_stmt|;
name|setEnabledCipherSuites
argument_list|(
name|sslSocket
argument_list|)
expr_stmt|;
return|return
name|sslSocket
return|;
block|}
annotation|@
name|Override
DECL|method|createSocket (String string, int i, InetAddress ia, int i1)
specifier|public
name|Socket
name|createSocket
parameter_list|(
name|String
name|string
parameter_list|,
name|int
name|i
parameter_list|,
name|InetAddress
name|ia
parameter_list|,
name|int
name|i1
parameter_list|)
throws|throws
name|IOException
block|{
name|SSLSocket
name|sslSocket
init|=
operator|(
name|SSLSocket
operator|)
name|delegateSocketFactory
operator|.
name|createSocket
argument_list|(
name|string
argument_list|,
name|i
argument_list|,
name|ia
argument_list|,
name|i1
argument_list|)
decl_stmt|;
name|setEnabledCipherSuites
argument_list|(
name|sslSocket
argument_list|)
expr_stmt|;
return|return
name|sslSocket
return|;
block|}
annotation|@
name|Override
DECL|method|createSocket (InetAddress ia, int i)
specifier|public
name|Socket
name|createSocket
parameter_list|(
name|InetAddress
name|ia
parameter_list|,
name|int
name|i
parameter_list|)
throws|throws
name|IOException
block|{
name|SSLSocket
name|sslSocket
init|=
operator|(
name|SSLSocket
operator|)
name|delegateSocketFactory
operator|.
name|createSocket
argument_list|(
name|ia
argument_list|,
name|i
argument_list|)
decl_stmt|;
name|setEnabledCipherSuites
argument_list|(
name|sslSocket
argument_list|)
expr_stmt|;
return|return
name|sslSocket
return|;
block|}
annotation|@
name|Override
DECL|method|createSocket (InetAddress ia, int i, InetAddress ia1, int i1)
specifier|public
name|Socket
name|createSocket
parameter_list|(
name|InetAddress
name|ia
parameter_list|,
name|int
name|i
parameter_list|,
name|InetAddress
name|ia1
parameter_list|,
name|int
name|i1
parameter_list|)
throws|throws
name|IOException
block|{
name|SSLSocket
name|sslSocket
init|=
operator|(
name|SSLSocket
operator|)
name|delegateSocketFactory
operator|.
name|createSocket
argument_list|(
name|ia
argument_list|,
name|i
argument_list|,
name|ia1
argument_list|,
name|i1
argument_list|)
decl_stmt|;
name|setEnabledCipherSuites
argument_list|(
name|sslSocket
argument_list|)
expr_stmt|;
return|return
name|sslSocket
return|;
block|}
DECL|method|setEnabledCipherSuites (SSLSocket sslSocket)
specifier|private
name|void
name|setEnabledCipherSuites
parameter_list|(
name|SSLSocket
name|sslSocket
parameter_list|)
block|{
if|if
condition|(
literal|null
operator|!=
name|enabledCipherSuites
condition|)
block|{
name|sslSocket
operator|.
name|setEnabledCipherSuites
argument_list|(
name|enabledCipherSuites
argument_list|)
expr_stmt|;
block|}
block|}
block|}
DECL|class|PreferredProtocolSSLSocketFactory
specifier|private
class|class
name|PreferredProtocolSSLSocketFactory
extends|extends
name|SSLSocketFactory
block|{
DECL|field|delegateSocketFactory
specifier|private
specifier|final
name|SSLSocketFactory
name|delegateSocketFactory
decl_stmt|;
DECL|field|enabledProtocols
specifier|private
specifier|final
name|String
index|[]
name|enabledProtocols
decl_stmt|;
DECL|method|PreferredProtocolSSLSocketFactory (SSLSocketFactory sslSocketFactory, String[] enabledProtocols)
name|PreferredProtocolSSLSocketFactory
parameter_list|(
name|SSLSocketFactory
name|sslSocketFactory
parameter_list|,
name|String
index|[]
name|enabledProtocols
parameter_list|)
block|{
name|delegateSocketFactory
operator|=
name|sslSocketFactory
expr_stmt|;
if|if
condition|(
literal|null
operator|!=
name|enabledProtocols
operator|&&
name|enabledProtocols
operator|.
name|length
operator|>
literal|0
condition|)
block|{
name|this
operator|.
name|enabledProtocols
operator|=
name|enabledProtocols
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|enabledProtocols
operator|=
literal|null
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|getDefaultCipherSuites ()
specifier|public
name|String
index|[]
name|getDefaultCipherSuites
parameter_list|()
block|{
return|return
name|delegateSocketFactory
operator|.
name|getDefaultCipherSuites
argument_list|()
return|;
block|}
annotation|@
name|Override
DECL|method|getSupportedCipherSuites ()
specifier|public
name|String
index|[]
name|getSupportedCipherSuites
parameter_list|()
block|{
return|return
name|delegateSocketFactory
operator|.
name|getSupportedCipherSuites
argument_list|()
return|;
block|}
annotation|@
name|Override
DECL|method|createSocket (Socket socket, String string, int i, boolean bln)
specifier|public
name|Socket
name|createSocket
parameter_list|(
name|Socket
name|socket
parameter_list|,
name|String
name|string
parameter_list|,
name|int
name|i
parameter_list|,
name|boolean
name|bln
parameter_list|)
throws|throws
name|IOException
block|{
name|SSLSocket
name|sslSocket
init|=
operator|(
name|SSLSocket
operator|)
name|delegateSocketFactory
operator|.
name|createSocket
argument_list|(
name|socket
argument_list|,
name|string
argument_list|,
name|i
argument_list|,
name|bln
argument_list|)
decl_stmt|;
name|setEnabledProtocols
argument_list|(
name|sslSocket
argument_list|)
expr_stmt|;
return|return
name|sslSocket
return|;
block|}
annotation|@
name|Override
DECL|method|createSocket (String string, int i)
specifier|public
name|Socket
name|createSocket
parameter_list|(
name|String
name|string
parameter_list|,
name|int
name|i
parameter_list|)
throws|throws
name|IOException
block|{
name|SSLSocket
name|sslSocket
init|=
operator|(
name|SSLSocket
operator|)
name|delegateSocketFactory
operator|.
name|createSocket
argument_list|(
name|string
argument_list|,
name|i
argument_list|)
decl_stmt|;
name|setEnabledProtocols
argument_list|(
name|sslSocket
argument_list|)
expr_stmt|;
return|return
name|sslSocket
return|;
block|}
annotation|@
name|Override
DECL|method|createSocket (String string, int i, InetAddress ia, int i1)
specifier|public
name|Socket
name|createSocket
parameter_list|(
name|String
name|string
parameter_list|,
name|int
name|i
parameter_list|,
name|InetAddress
name|ia
parameter_list|,
name|int
name|i1
parameter_list|)
throws|throws
name|IOException
block|{
name|SSLSocket
name|sslSocket
init|=
operator|(
name|SSLSocket
operator|)
name|delegateSocketFactory
operator|.
name|createSocket
argument_list|(
name|string
argument_list|,
name|i
argument_list|,
name|ia
argument_list|,
name|i1
argument_list|)
decl_stmt|;
name|setEnabledProtocols
argument_list|(
name|sslSocket
argument_list|)
expr_stmt|;
return|return
name|sslSocket
return|;
block|}
annotation|@
name|Override
DECL|method|createSocket (InetAddress ia, int i)
specifier|public
name|Socket
name|createSocket
parameter_list|(
name|InetAddress
name|ia
parameter_list|,
name|int
name|i
parameter_list|)
throws|throws
name|IOException
block|{
name|SSLSocket
name|sslSocket
init|=
operator|(
name|SSLSocket
operator|)
name|delegateSocketFactory
operator|.
name|createSocket
argument_list|(
name|ia
argument_list|,
name|i
argument_list|)
decl_stmt|;
name|setEnabledProtocols
argument_list|(
name|sslSocket
argument_list|)
expr_stmt|;
return|return
name|sslSocket
return|;
block|}
annotation|@
name|Override
DECL|method|createSocket (InetAddress ia, int i, InetAddress ia1, int i1)
specifier|public
name|Socket
name|createSocket
parameter_list|(
name|InetAddress
name|ia
parameter_list|,
name|int
name|i
parameter_list|,
name|InetAddress
name|ia1
parameter_list|,
name|int
name|i1
parameter_list|)
throws|throws
name|IOException
block|{
name|SSLSocket
name|sslSocket
init|=
operator|(
name|SSLSocket
operator|)
name|delegateSocketFactory
operator|.
name|createSocket
argument_list|(
name|ia
argument_list|,
name|i
argument_list|,
name|ia1
argument_list|,
name|i1
argument_list|)
decl_stmt|;
name|setEnabledProtocols
argument_list|(
name|sslSocket
argument_list|)
expr_stmt|;
return|return
name|sslSocket
return|;
block|}
DECL|method|setEnabledProtocols (SSLSocket sslSocket)
specifier|private
name|void
name|setEnabledProtocols
parameter_list|(
name|SSLSocket
name|sslSocket
parameter_list|)
block|{
if|if
condition|(
literal|null
operator|!=
name|enabledProtocols
condition|)
block|{
name|sslSocket
operator|.
name|setEnabledProtocols
argument_list|(
name|enabledProtocols
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_class

end_unit

