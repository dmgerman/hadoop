begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/**  * Licensed to the Apache Software Foundation (ASF) under one  * or more contributor license agreements.  See the NOTICE file  * distributed with this work for additional information  * regarding copyright ownership.  The ASF licenses this file  * to you under the Apache License, Version 2.0 (the  * "License"); you may not use this file except in compliance  * with the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
DECL|package|org.apache.hadoop.hdfs.server.namenode
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|server
operator|.
name|namenode
package|;
end_package

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|zip
operator|.
name|Checksum
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|EnumMap
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|ChecksumException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|classification
operator|.
name|InterfaceAudience
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|classification
operator|.
name|InterfaceStability
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|security
operator|.
name|token
operator|.
name|delegation
operator|.
name|DelegationTokenIdentifier
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|Options
operator|.
name|Rename
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|permission
operator|.
name|FsPermission
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|permission
operator|.
name|PermissionStatus
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|Block
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|DatanodeID
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|LayoutVersion
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|protocol
operator|.
name|LayoutVersion
operator|.
name|Feature
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|server
operator|.
name|common
operator|.
name|GenerationStamp
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|server
operator|.
name|namenode
operator|.
name|FSEditLogOpCodes
operator|.
name|*
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|token
operator|.
name|delegation
operator|.
name|DelegationKey
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|BytesWritable
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|LongWritable
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|Writable
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|WritableFactories
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|WritableFactory
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|DataInput
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|DataOutput
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|DataInputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|EOFException
import|;
end_import

begin_comment
comment|/**  * Helper classes for reading the ops from an InputStream.  * All ops derive from FSEditLogOp and are only  * instantiated from Reader#readOp()  */
end_comment

begin_class
annotation|@
name|InterfaceAudience
operator|.
name|Private
annotation|@
name|InterfaceStability
operator|.
name|Unstable
DECL|class|FSEditLogOp
specifier|public
specifier|abstract
class|class
name|FSEditLogOp
block|{
DECL|field|opCode
specifier|final
name|FSEditLogOpCodes
name|opCode
decl_stmt|;
comment|/**    * Constructor for an EditLog Op. EditLog ops cannot be constructed    * directly, but only through Reader#readOp.    */
DECL|method|FSEditLogOp (FSEditLogOpCodes opCode)
specifier|private
name|FSEditLogOp
parameter_list|(
name|FSEditLogOpCodes
name|opCode
parameter_list|)
block|{
name|this
operator|.
name|opCode
operator|=
name|opCode
expr_stmt|;
block|}
DECL|method|readFields (DataInputStream in, int logVersion)
specifier|public
specifier|abstract
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
function_decl|;
DECL|class|AddCloseOp
specifier|static
class|class
name|AddCloseOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|length
name|int
name|length
decl_stmt|;
DECL|field|path
name|String
name|path
decl_stmt|;
DECL|field|replication
name|short
name|replication
decl_stmt|;
DECL|field|mtime
name|long
name|mtime
decl_stmt|;
DECL|field|atime
name|long
name|atime
decl_stmt|;
DECL|field|blockSize
name|long
name|blockSize
decl_stmt|;
DECL|field|blocks
name|Block
index|[]
name|blocks
decl_stmt|;
DECL|field|permissions
name|PermissionStatus
name|permissions
decl_stmt|;
DECL|field|clientName
name|String
name|clientName
decl_stmt|;
DECL|field|clientMachine
name|String
name|clientMachine
decl_stmt|;
comment|//final DatanodeDescriptor[] dataNodeDescriptors; UNUSED
DECL|method|AddCloseOp (FSEditLogOpCodes opCode)
specifier|private
name|AddCloseOp
parameter_list|(
name|FSEditLogOpCodes
name|opCode
parameter_list|)
block|{
name|super
argument_list|(
name|opCode
argument_list|)
expr_stmt|;
assert|assert
operator|(
name|opCode
operator|==
name|OP_ADD
operator|||
name|opCode
operator|==
name|OP_CLOSE
operator|)
assert|;
block|}
DECL|method|readFields (DataInputStream in, int logVersion)
specifier|public
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
comment|// versions> 0 support per file replication
comment|// get name and replication
name|this
operator|.
name|length
operator|=
name|in
operator|.
name|readInt
argument_list|()
expr_stmt|;
if|if
condition|(
operator|-
literal|7
operator|==
name|logVersion
operator|&&
name|length
operator|!=
literal|3
operator|||
operator|-
literal|17
operator|<
name|logVersion
operator|&&
name|logVersion
operator|<
operator|-
literal|7
operator|&&
name|length
operator|!=
literal|4
operator|||
name|logVersion
operator|<=
operator|-
literal|17
operator|&&
name|length
operator|!=
literal|5
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Incorrect data format."
operator|+
literal|" logVersion is "
operator|+
name|logVersion
operator|+
literal|" but writables.length is "
operator|+
name|length
operator|+
literal|". "
argument_list|)
throw|;
block|}
name|this
operator|.
name|path
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|replication
operator|=
name|readShort
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|mtime
operator|=
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
if|if
condition|(
name|LayoutVersion
operator|.
name|supports
argument_list|(
name|Feature
operator|.
name|FILE_ACCESS_TIME
argument_list|,
name|logVersion
argument_list|)
condition|)
block|{
name|this
operator|.
name|atime
operator|=
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|atime
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|logVersion
operator|<
operator|-
literal|7
condition|)
block|{
name|this
operator|.
name|blockSize
operator|=
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|blockSize
operator|=
literal|0
expr_stmt|;
block|}
comment|// get blocks
name|this
operator|.
name|blocks
operator|=
name|readBlocks
argument_list|(
name|in
argument_list|,
name|logVersion
argument_list|)
expr_stmt|;
if|if
condition|(
name|logVersion
operator|<=
operator|-
literal|11
condition|)
block|{
name|this
operator|.
name|permissions
operator|=
name|PermissionStatus
operator|.
name|read
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|permissions
operator|=
literal|null
expr_stmt|;
block|}
comment|// clientname, clientMachine and block locations of last block.
if|if
condition|(
name|this
operator|.
name|opCode
operator|==
name|OP_ADD
operator|&&
name|logVersion
operator|<=
operator|-
literal|12
condition|)
block|{
name|this
operator|.
name|clientName
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|clientMachine
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
if|if
condition|(
operator|-
literal|13
operator|<=
name|logVersion
condition|)
block|{
name|readDatanodeDescriptorArray
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|this
operator|.
name|clientName
operator|=
literal|""
expr_stmt|;
name|this
operator|.
name|clientMachine
operator|=
literal|""
expr_stmt|;
block|}
block|}
comment|/** This method is defined for compatibility reason. */
DECL|method|readDatanodeDescriptorArray (DataInput in)
specifier|private
specifier|static
name|DatanodeDescriptor
index|[]
name|readDatanodeDescriptorArray
parameter_list|(
name|DataInput
name|in
parameter_list|)
throws|throws
name|IOException
block|{
name|DatanodeDescriptor
index|[]
name|locations
init|=
operator|new
name|DatanodeDescriptor
index|[
name|in
operator|.
name|readInt
argument_list|()
index|]
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|locations
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|locations
index|[
name|i
index|]
operator|=
operator|new
name|DatanodeDescriptor
argument_list|()
expr_stmt|;
name|locations
index|[
name|i
index|]
operator|.
name|readFieldsFromFSEditLog
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
return|return
name|locations
return|;
block|}
DECL|method|readBlocks ( DataInputStream in, int logVersion)
specifier|private
specifier|static
name|Block
index|[]
name|readBlocks
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|int
name|numBlocks
init|=
name|in
operator|.
name|readInt
argument_list|()
decl_stmt|;
name|Block
index|[]
name|blocks
init|=
operator|new
name|Block
index|[
name|numBlocks
index|]
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|numBlocks
condition|;
name|i
operator|++
control|)
block|{
name|Block
name|blk
init|=
operator|new
name|Block
argument_list|()
decl_stmt|;
if|if
condition|(
name|logVersion
operator|<=
operator|-
literal|14
condition|)
block|{
name|blk
operator|.
name|readFields
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BlockTwo
name|oldblk
init|=
operator|new
name|BlockTwo
argument_list|()
decl_stmt|;
name|oldblk
operator|.
name|readFields
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|blk
operator|.
name|set
argument_list|(
name|oldblk
operator|.
name|blkid
argument_list|,
name|oldblk
operator|.
name|len
argument_list|,
name|GenerationStamp
operator|.
name|GRANDFATHER_GENERATION_STAMP
argument_list|)
expr_stmt|;
block|}
name|blocks
index|[
name|i
index|]
operator|=
name|blk
expr_stmt|;
block|}
return|return
name|blocks
return|;
block|}
block|}
DECL|class|SetReplicationOp
specifier|static
class|class
name|SetReplicationOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|path
name|String
name|path
decl_stmt|;
DECL|field|replication
name|short
name|replication
decl_stmt|;
DECL|method|SetReplicationOp ()
specifier|private
name|SetReplicationOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_SET_REPLICATION
argument_list|)
expr_stmt|;
block|}
DECL|method|readFields (DataInputStream in, int logVersion)
specifier|public
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|path
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|replication
operator|=
name|readShort
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|ConcatDeleteOp
specifier|static
class|class
name|ConcatDeleteOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|length
name|int
name|length
decl_stmt|;
DECL|field|trg
name|String
name|trg
decl_stmt|;
DECL|field|srcs
name|String
index|[]
name|srcs
decl_stmt|;
DECL|field|timestamp
name|long
name|timestamp
decl_stmt|;
DECL|method|ConcatDeleteOp ()
specifier|private
name|ConcatDeleteOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_CONCAT_DELETE
argument_list|)
expr_stmt|;
block|}
DECL|method|readFields (DataInputStream in, int logVersion)
specifier|public
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|length
operator|=
name|in
operator|.
name|readInt
argument_list|()
expr_stmt|;
if|if
condition|(
name|length
operator|<
literal|3
condition|)
block|{
comment|// trg, srcs.., timestam
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Incorrect data format. "
operator|+
literal|"Concat delete operation."
argument_list|)
throw|;
block|}
name|this
operator|.
name|trg
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|int
name|srcSize
init|=
name|this
operator|.
name|length
operator|-
literal|1
operator|-
literal|1
decl_stmt|;
comment|//trg and timestamp
name|this
operator|.
name|srcs
operator|=
operator|new
name|String
index|[
name|srcSize
index|]
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|srcSize
condition|;
name|i
operator|++
control|)
block|{
name|srcs
index|[
name|i
index|]
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
name|this
operator|.
name|timestamp
operator|=
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|RenameOldOp
specifier|static
class|class
name|RenameOldOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|length
name|int
name|length
decl_stmt|;
DECL|field|src
name|String
name|src
decl_stmt|;
DECL|field|dst
name|String
name|dst
decl_stmt|;
DECL|field|timestamp
name|long
name|timestamp
decl_stmt|;
DECL|method|RenameOldOp ()
specifier|private
name|RenameOldOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_RENAME_OLD
argument_list|)
expr_stmt|;
block|}
DECL|method|readFields (DataInputStream in, int logVersion)
specifier|public
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|length
operator|=
name|in
operator|.
name|readInt
argument_list|()
expr_stmt|;
if|if
condition|(
name|this
operator|.
name|length
operator|!=
literal|3
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Incorrect data format. "
operator|+
literal|"Old rename operation."
argument_list|)
throw|;
block|}
name|this
operator|.
name|src
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|dst
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|timestamp
operator|=
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|DeleteOp
specifier|static
class|class
name|DeleteOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|length
name|int
name|length
decl_stmt|;
DECL|field|path
name|String
name|path
decl_stmt|;
DECL|field|timestamp
name|long
name|timestamp
decl_stmt|;
DECL|method|DeleteOp ()
specifier|private
name|DeleteOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_DELETE
argument_list|)
expr_stmt|;
block|}
DECL|method|readFields (DataInputStream in, int logVersion)
specifier|public
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|length
operator|=
name|in
operator|.
name|readInt
argument_list|()
expr_stmt|;
if|if
condition|(
name|this
operator|.
name|length
operator|!=
literal|2
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Incorrect data format. "
operator|+
literal|"delete operation."
argument_list|)
throw|;
block|}
name|this
operator|.
name|path
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|timestamp
operator|=
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|MkdirOp
specifier|static
class|class
name|MkdirOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|length
name|int
name|length
decl_stmt|;
DECL|field|path
name|String
name|path
decl_stmt|;
DECL|field|timestamp
name|long
name|timestamp
decl_stmt|;
DECL|field|permissions
name|PermissionStatus
name|permissions
decl_stmt|;
DECL|method|MkdirOp ()
specifier|private
name|MkdirOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_MKDIR
argument_list|)
expr_stmt|;
block|}
DECL|method|readFields (DataInputStream in, int logVersion)
specifier|public
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|length
operator|=
name|in
operator|.
name|readInt
argument_list|()
expr_stmt|;
if|if
condition|(
operator|-
literal|17
operator|<
name|logVersion
operator|&&
name|length
operator|!=
literal|2
operator|||
name|logVersion
operator|<=
operator|-
literal|17
operator|&&
name|length
operator|!=
literal|3
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Incorrect data format. "
operator|+
literal|"Mkdir operation."
argument_list|)
throw|;
block|}
name|this
operator|.
name|path
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|timestamp
operator|=
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
comment|// The disk format stores atimes for directories as well.
comment|// However, currently this is not being updated/used because of
comment|// performance reasons.
if|if
condition|(
name|LayoutVersion
operator|.
name|supports
argument_list|(
name|Feature
operator|.
name|FILE_ACCESS_TIME
argument_list|,
name|logVersion
argument_list|)
condition|)
block|{
comment|/*unused this.atime = */
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|logVersion
operator|<=
operator|-
literal|11
condition|)
block|{
name|this
operator|.
name|permissions
operator|=
name|PermissionStatus
operator|.
name|read
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|permissions
operator|=
literal|null
expr_stmt|;
block|}
block|}
block|}
DECL|class|SetGenstampOp
specifier|static
class|class
name|SetGenstampOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|genStamp
name|long
name|genStamp
decl_stmt|;
DECL|method|SetGenstampOp ()
specifier|private
name|SetGenstampOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_SET_GENSTAMP
argument_list|)
expr_stmt|;
block|}
DECL|method|readFields (DataInputStream in, int logVersion)
specifier|public
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|genStamp
operator|=
name|in
operator|.
name|readLong
argument_list|()
expr_stmt|;
block|}
block|}
DECL|class|DatanodeAddOp
specifier|static
class|class
name|DatanodeAddOp
extends|extends
name|FSEditLogOp
block|{
annotation|@
name|SuppressWarnings
argument_list|(
literal|"deprecation"
argument_list|)
DECL|method|DatanodeAddOp ()
specifier|private
name|DatanodeAddOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_DATANODE_ADD
argument_list|)
expr_stmt|;
block|}
DECL|method|readFields (DataInputStream in, int logVersion)
specifier|public
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
comment|//Datanodes are not persistent any more.
name|FSImageSerialization
operator|.
name|DatanodeImage
operator|.
name|skipOne
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|DatanodeRemoveOp
specifier|static
class|class
name|DatanodeRemoveOp
extends|extends
name|FSEditLogOp
block|{
annotation|@
name|SuppressWarnings
argument_list|(
literal|"deprecation"
argument_list|)
DECL|method|DatanodeRemoveOp ()
specifier|private
name|DatanodeRemoveOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_DATANODE_REMOVE
argument_list|)
expr_stmt|;
block|}
DECL|method|readFields (DataInputStream in, int logVersion)
specifier|public
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|DatanodeID
name|nodeID
init|=
operator|new
name|DatanodeID
argument_list|()
decl_stmt|;
name|nodeID
operator|.
name|readFields
argument_list|(
name|in
argument_list|)
expr_stmt|;
comment|//Datanodes are not persistent any more.
block|}
block|}
DECL|class|SetPermissionsOp
specifier|static
class|class
name|SetPermissionsOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|src
name|String
name|src
decl_stmt|;
DECL|field|permissions
name|FsPermission
name|permissions
decl_stmt|;
DECL|method|SetPermissionsOp ()
specifier|private
name|SetPermissionsOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_SET_PERMISSIONS
argument_list|)
expr_stmt|;
block|}
DECL|method|readFields (DataInputStream in, int logVersion)
specifier|public
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|src
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|permissions
operator|=
name|FsPermission
operator|.
name|read
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|SetOwnerOp
specifier|static
class|class
name|SetOwnerOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|src
name|String
name|src
decl_stmt|;
DECL|field|username
name|String
name|username
decl_stmt|;
DECL|field|groupname
name|String
name|groupname
decl_stmt|;
DECL|method|SetOwnerOp ()
specifier|private
name|SetOwnerOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_SET_OWNER
argument_list|)
expr_stmt|;
block|}
DECL|method|readFields (DataInputStream in, int logVersion)
specifier|public
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|src
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|username
operator|=
name|FSImageSerialization
operator|.
name|readString_EmptyAsNull
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|groupname
operator|=
name|FSImageSerialization
operator|.
name|readString_EmptyAsNull
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|SetNSQuotaOp
specifier|static
class|class
name|SetNSQuotaOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|src
name|String
name|src
decl_stmt|;
DECL|field|nsQuota
name|long
name|nsQuota
decl_stmt|;
DECL|method|SetNSQuotaOp ()
specifier|private
name|SetNSQuotaOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_SET_NS_QUOTA
argument_list|)
expr_stmt|;
block|}
DECL|method|readFields (DataInputStream in, int logVersion)
specifier|public
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|src
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|nsQuota
operator|=
name|readLongWritable
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|ClearNSQuotaOp
specifier|static
class|class
name|ClearNSQuotaOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|src
name|String
name|src
decl_stmt|;
DECL|method|ClearNSQuotaOp ()
specifier|private
name|ClearNSQuotaOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_CLEAR_NS_QUOTA
argument_list|)
expr_stmt|;
block|}
DECL|method|readFields (DataInputStream in, int logVersion)
specifier|public
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|src
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|SetQuotaOp
specifier|static
class|class
name|SetQuotaOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|src
name|String
name|src
decl_stmt|;
DECL|field|nsQuota
name|long
name|nsQuota
decl_stmt|;
DECL|field|dsQuota
name|long
name|dsQuota
decl_stmt|;
DECL|method|SetQuotaOp ()
specifier|private
name|SetQuotaOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_SET_QUOTA
argument_list|)
expr_stmt|;
block|}
DECL|method|readFields (DataInputStream in, int logVersion)
specifier|public
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|src
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|nsQuota
operator|=
name|readLongWritable
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|dsQuota
operator|=
name|readLongWritable
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|TimesOp
specifier|static
class|class
name|TimesOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|length
name|int
name|length
decl_stmt|;
DECL|field|path
name|String
name|path
decl_stmt|;
DECL|field|mtime
name|long
name|mtime
decl_stmt|;
DECL|field|atime
name|long
name|atime
decl_stmt|;
DECL|method|TimesOp ()
specifier|private
name|TimesOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_TIMES
argument_list|)
expr_stmt|;
block|}
DECL|method|readFields (DataInputStream in, int logVersion)
specifier|public
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|length
operator|=
name|in
operator|.
name|readInt
argument_list|()
expr_stmt|;
if|if
condition|(
name|length
operator|!=
literal|3
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Incorrect data format. "
operator|+
literal|"times operation."
argument_list|)
throw|;
block|}
name|this
operator|.
name|path
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|mtime
operator|=
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|atime
operator|=
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|SymlinkOp
specifier|static
class|class
name|SymlinkOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|length
name|int
name|length
decl_stmt|;
DECL|field|path
name|String
name|path
decl_stmt|;
DECL|field|value
name|String
name|value
decl_stmt|;
DECL|field|mtime
name|long
name|mtime
decl_stmt|;
DECL|field|atime
name|long
name|atime
decl_stmt|;
DECL|field|permissionStatus
name|PermissionStatus
name|permissionStatus
decl_stmt|;
DECL|method|SymlinkOp ()
specifier|private
name|SymlinkOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_SYMLINK
argument_list|)
expr_stmt|;
block|}
DECL|method|readFields (DataInputStream in, int logVersion)
specifier|public
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|length
operator|=
name|in
operator|.
name|readInt
argument_list|()
expr_stmt|;
if|if
condition|(
name|this
operator|.
name|length
operator|!=
literal|4
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Incorrect data format. "
operator|+
literal|"symlink operation."
argument_list|)
throw|;
block|}
name|this
operator|.
name|path
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|value
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|mtime
operator|=
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|atime
operator|=
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|permissionStatus
operator|=
name|PermissionStatus
operator|.
name|read
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|RenameOp
specifier|static
class|class
name|RenameOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|length
name|int
name|length
decl_stmt|;
DECL|field|src
name|String
name|src
decl_stmt|;
DECL|field|dst
name|String
name|dst
decl_stmt|;
DECL|field|timestamp
name|long
name|timestamp
decl_stmt|;
DECL|field|options
name|Rename
index|[]
name|options
decl_stmt|;
DECL|method|RenameOp ()
specifier|private
name|RenameOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_RENAME
argument_list|)
expr_stmt|;
block|}
DECL|method|readFields (DataInputStream in, int logVersion)
specifier|public
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|length
operator|=
name|in
operator|.
name|readInt
argument_list|()
expr_stmt|;
if|if
condition|(
name|this
operator|.
name|length
operator|!=
literal|3
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Incorrect data format. "
operator|+
literal|"Rename operation."
argument_list|)
throw|;
block|}
name|this
operator|.
name|src
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|dst
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|timestamp
operator|=
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|options
operator|=
name|readRenameOptions
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
DECL|method|readRenameOptions (DataInputStream in)
specifier|private
specifier|static
name|Rename
index|[]
name|readRenameOptions
parameter_list|(
name|DataInputStream
name|in
parameter_list|)
throws|throws
name|IOException
block|{
name|BytesWritable
name|writable
init|=
operator|new
name|BytesWritable
argument_list|()
decl_stmt|;
name|writable
operator|.
name|readFields
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|byte
index|[]
name|bytes
init|=
name|writable
operator|.
name|getBytes
argument_list|()
decl_stmt|;
name|Rename
index|[]
name|options
init|=
operator|new
name|Rename
index|[
name|bytes
operator|.
name|length
index|]
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|bytes
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|options
index|[
name|i
index|]
operator|=
name|Rename
operator|.
name|valueOf
argument_list|(
name|bytes
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
return|return
name|options
return|;
block|}
block|}
DECL|class|ReassignLeaseOp
specifier|static
class|class
name|ReassignLeaseOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|leaseHolder
name|String
name|leaseHolder
decl_stmt|;
DECL|field|path
name|String
name|path
decl_stmt|;
DECL|field|newHolder
name|String
name|newHolder
decl_stmt|;
DECL|method|ReassignLeaseOp ()
specifier|private
name|ReassignLeaseOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_REASSIGN_LEASE
argument_list|)
expr_stmt|;
block|}
DECL|method|readFields (DataInputStream in, int logVersion)
specifier|public
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|leaseHolder
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|path
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|newHolder
operator|=
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|GetDelegationTokenOp
specifier|static
class|class
name|GetDelegationTokenOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|token
name|DelegationTokenIdentifier
name|token
decl_stmt|;
DECL|field|expiryTime
name|long
name|expiryTime
decl_stmt|;
DECL|method|GetDelegationTokenOp ()
specifier|private
name|GetDelegationTokenOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_GET_DELEGATION_TOKEN
argument_list|)
expr_stmt|;
block|}
DECL|method|readFields (DataInputStream in, int logVersion)
specifier|public
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|token
operator|=
operator|new
name|DelegationTokenIdentifier
argument_list|()
expr_stmt|;
name|this
operator|.
name|token
operator|.
name|readFields
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|expiryTime
operator|=
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|RenewDelegationTokenOp
specifier|static
class|class
name|RenewDelegationTokenOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|token
name|DelegationTokenIdentifier
name|token
decl_stmt|;
DECL|field|expiryTime
name|long
name|expiryTime
decl_stmt|;
DECL|method|RenewDelegationTokenOp ()
specifier|private
name|RenewDelegationTokenOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_RENEW_DELEGATION_TOKEN
argument_list|)
expr_stmt|;
block|}
DECL|method|readFields (DataInputStream in, int logVersion)
specifier|public
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|token
operator|=
operator|new
name|DelegationTokenIdentifier
argument_list|()
expr_stmt|;
name|this
operator|.
name|token
operator|.
name|readFields
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|this
operator|.
name|expiryTime
operator|=
name|readLong
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|CancelDelegationTokenOp
specifier|static
class|class
name|CancelDelegationTokenOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|token
name|DelegationTokenIdentifier
name|token
decl_stmt|;
DECL|method|CancelDelegationTokenOp ()
specifier|private
name|CancelDelegationTokenOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_CANCEL_DELEGATION_TOKEN
argument_list|)
expr_stmt|;
block|}
DECL|method|readFields (DataInputStream in, int logVersion)
specifier|public
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|token
operator|=
operator|new
name|DelegationTokenIdentifier
argument_list|()
expr_stmt|;
name|this
operator|.
name|token
operator|.
name|readFields
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|UpdateMasterKeyOp
specifier|static
class|class
name|UpdateMasterKeyOp
extends|extends
name|FSEditLogOp
block|{
DECL|field|key
name|DelegationKey
name|key
decl_stmt|;
DECL|method|UpdateMasterKeyOp ()
specifier|private
name|UpdateMasterKeyOp
parameter_list|()
block|{
name|super
argument_list|(
name|OP_UPDATE_MASTER_KEY
argument_list|)
expr_stmt|;
block|}
DECL|method|readFields (DataInputStream in, int logVersion)
specifier|public
name|void
name|readFields
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|key
operator|=
operator|new
name|DelegationKey
argument_list|()
expr_stmt|;
name|this
operator|.
name|key
operator|.
name|readFields
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|readShort (DataInputStream in)
specifier|static
specifier|private
name|short
name|readShort
parameter_list|(
name|DataInputStream
name|in
parameter_list|)
throws|throws
name|IOException
block|{
return|return
name|Short
operator|.
name|parseShort
argument_list|(
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
argument_list|)
return|;
block|}
DECL|method|readLong (DataInputStream in)
specifier|static
specifier|private
name|long
name|readLong
parameter_list|(
name|DataInputStream
name|in
parameter_list|)
throws|throws
name|IOException
block|{
return|return
name|Long
operator|.
name|parseLong
argument_list|(
name|FSImageSerialization
operator|.
name|readString
argument_list|(
name|in
argument_list|)
argument_list|)
return|;
block|}
comment|/**    * A class to read in blocks stored in the old format. The only two    * fields in the block were blockid and length.    */
DECL|class|BlockTwo
specifier|static
class|class
name|BlockTwo
implements|implements
name|Writable
block|{
DECL|field|blkid
name|long
name|blkid
decl_stmt|;
DECL|field|len
name|long
name|len
decl_stmt|;
static|static
block|{
comment|// register a ctor
name|WritableFactories
operator|.
name|setFactory
argument_list|(
name|BlockTwo
operator|.
name|class
argument_list|,
operator|new
name|WritableFactory
argument_list|()
block|{
specifier|public
name|Writable
name|newInstance
parameter_list|()
block|{
return|return
operator|new
name|BlockTwo
argument_list|()
return|;
block|}
block|}
argument_list|)
expr_stmt|;
block|}
DECL|method|BlockTwo ()
name|BlockTwo
parameter_list|()
block|{
name|blkid
operator|=
literal|0
expr_stmt|;
name|len
operator|=
literal|0
expr_stmt|;
block|}
comment|/////////////////////////////////////
comment|// Writable
comment|/////////////////////////////////////
DECL|method|write (DataOutput out)
specifier|public
name|void
name|write
parameter_list|(
name|DataOutput
name|out
parameter_list|)
throws|throws
name|IOException
block|{
name|out
operator|.
name|writeLong
argument_list|(
name|blkid
argument_list|)
expr_stmt|;
name|out
operator|.
name|writeLong
argument_list|(
name|len
argument_list|)
expr_stmt|;
block|}
DECL|method|readFields (DataInput in)
specifier|public
name|void
name|readFields
parameter_list|(
name|DataInput
name|in
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|blkid
operator|=
name|in
operator|.
name|readLong
argument_list|()
expr_stmt|;
name|this
operator|.
name|len
operator|=
name|in
operator|.
name|readLong
argument_list|()
expr_stmt|;
block|}
block|}
comment|// a place holder for reading a long
DECL|field|longWritable
specifier|private
specifier|static
specifier|final
name|LongWritable
name|longWritable
init|=
operator|new
name|LongWritable
argument_list|()
decl_stmt|;
comment|/** Read an integer from an input stream */
DECL|method|readLongWritable (DataInputStream in)
specifier|private
specifier|static
name|long
name|readLongWritable
parameter_list|(
name|DataInputStream
name|in
parameter_list|)
throws|throws
name|IOException
block|{
synchronized|synchronized
init|(
name|longWritable
init|)
block|{
name|longWritable
operator|.
name|readFields
argument_list|(
name|in
argument_list|)
expr_stmt|;
return|return
name|longWritable
operator|.
name|get
argument_list|()
return|;
block|}
block|}
comment|/**    * Class for reading editlog ops from a stream    */
DECL|class|Reader
specifier|public
specifier|static
class|class
name|Reader
block|{
DECL|field|in
specifier|private
specifier|final
name|DataInputStream
name|in
decl_stmt|;
DECL|field|logVersion
specifier|private
specifier|final
name|int
name|logVersion
decl_stmt|;
DECL|field|checksum
specifier|private
specifier|final
name|Checksum
name|checksum
decl_stmt|;
DECL|field|opInstances
specifier|private
name|EnumMap
argument_list|<
name|FSEditLogOpCodes
argument_list|,
name|FSEditLogOp
argument_list|>
name|opInstances
decl_stmt|;
comment|/**      * Construct the reader      * @param in The stream to read from.      * @param logVersion The version of the data coming from the stream.      * @param checksum Checksum being used with input stream.      */
annotation|@
name|SuppressWarnings
argument_list|(
literal|"deprecation"
argument_list|)
DECL|method|Reader (DataInputStream in, int logVersion, Checksum checksum)
specifier|public
name|Reader
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|int
name|logVersion
parameter_list|,
name|Checksum
name|checksum
parameter_list|)
block|{
name|this
operator|.
name|in
operator|=
name|in
expr_stmt|;
name|this
operator|.
name|logVersion
operator|=
name|logVersion
expr_stmt|;
name|this
operator|.
name|checksum
operator|=
name|checksum
expr_stmt|;
name|opInstances
operator|=
operator|new
name|EnumMap
argument_list|<
name|FSEditLogOpCodes
argument_list|,
name|FSEditLogOp
argument_list|>
argument_list|(
name|FSEditLogOpCodes
operator|.
name|class
argument_list|)
expr_stmt|;
name|opInstances
operator|.
name|put
argument_list|(
name|OP_ADD
argument_list|,
operator|new
name|AddCloseOp
argument_list|(
name|OP_ADD
argument_list|)
argument_list|)
expr_stmt|;
name|opInstances
operator|.
name|put
argument_list|(
name|OP_CLOSE
argument_list|,
operator|new
name|AddCloseOp
argument_list|(
name|OP_CLOSE
argument_list|)
argument_list|)
expr_stmt|;
name|opInstances
operator|.
name|put
argument_list|(
name|OP_SET_REPLICATION
argument_list|,
operator|new
name|SetReplicationOp
argument_list|()
argument_list|)
expr_stmt|;
name|opInstances
operator|.
name|put
argument_list|(
name|OP_CONCAT_DELETE
argument_list|,
operator|new
name|ConcatDeleteOp
argument_list|()
argument_list|)
expr_stmt|;
name|opInstances
operator|.
name|put
argument_list|(
name|OP_RENAME_OLD
argument_list|,
operator|new
name|RenameOldOp
argument_list|()
argument_list|)
expr_stmt|;
name|opInstances
operator|.
name|put
argument_list|(
name|OP_DELETE
argument_list|,
operator|new
name|DeleteOp
argument_list|()
argument_list|)
expr_stmt|;
name|opInstances
operator|.
name|put
argument_list|(
name|OP_MKDIR
argument_list|,
operator|new
name|MkdirOp
argument_list|()
argument_list|)
expr_stmt|;
name|opInstances
operator|.
name|put
argument_list|(
name|OP_SET_GENSTAMP
argument_list|,
operator|new
name|SetGenstampOp
argument_list|()
argument_list|)
expr_stmt|;
name|opInstances
operator|.
name|put
argument_list|(
name|OP_DATANODE_ADD
argument_list|,
operator|new
name|DatanodeAddOp
argument_list|()
argument_list|)
expr_stmt|;
name|opInstances
operator|.
name|put
argument_list|(
name|OP_DATANODE_REMOVE
argument_list|,
operator|new
name|DatanodeRemoveOp
argument_list|()
argument_list|)
expr_stmt|;
name|opInstances
operator|.
name|put
argument_list|(
name|OP_SET_PERMISSIONS
argument_list|,
operator|new
name|SetPermissionsOp
argument_list|()
argument_list|)
expr_stmt|;
name|opInstances
operator|.
name|put
argument_list|(
name|OP_SET_OWNER
argument_list|,
operator|new
name|SetOwnerOp
argument_list|()
argument_list|)
expr_stmt|;
name|opInstances
operator|.
name|put
argument_list|(
name|OP_SET_NS_QUOTA
argument_list|,
operator|new
name|SetNSQuotaOp
argument_list|()
argument_list|)
expr_stmt|;
name|opInstances
operator|.
name|put
argument_list|(
name|OP_CLEAR_NS_QUOTA
argument_list|,
operator|new
name|ClearNSQuotaOp
argument_list|()
argument_list|)
expr_stmt|;
name|opInstances
operator|.
name|put
argument_list|(
name|OP_SET_QUOTA
argument_list|,
operator|new
name|SetQuotaOp
argument_list|()
argument_list|)
expr_stmt|;
name|opInstances
operator|.
name|put
argument_list|(
name|OP_TIMES
argument_list|,
operator|new
name|TimesOp
argument_list|()
argument_list|)
expr_stmt|;
name|opInstances
operator|.
name|put
argument_list|(
name|OP_SYMLINK
argument_list|,
operator|new
name|SymlinkOp
argument_list|()
argument_list|)
expr_stmt|;
name|opInstances
operator|.
name|put
argument_list|(
name|OP_RENAME
argument_list|,
operator|new
name|RenameOp
argument_list|()
argument_list|)
expr_stmt|;
name|opInstances
operator|.
name|put
argument_list|(
name|OP_REASSIGN_LEASE
argument_list|,
operator|new
name|ReassignLeaseOp
argument_list|()
argument_list|)
expr_stmt|;
name|opInstances
operator|.
name|put
argument_list|(
name|OP_GET_DELEGATION_TOKEN
argument_list|,
operator|new
name|GetDelegationTokenOp
argument_list|()
argument_list|)
expr_stmt|;
name|opInstances
operator|.
name|put
argument_list|(
name|OP_RENEW_DELEGATION_TOKEN
argument_list|,
operator|new
name|RenewDelegationTokenOp
argument_list|()
argument_list|)
expr_stmt|;
name|opInstances
operator|.
name|put
argument_list|(
name|OP_CANCEL_DELEGATION_TOKEN
argument_list|,
operator|new
name|CancelDelegationTokenOp
argument_list|()
argument_list|)
expr_stmt|;
name|opInstances
operator|.
name|put
argument_list|(
name|OP_UPDATE_MASTER_KEY
argument_list|,
operator|new
name|UpdateMasterKeyOp
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|/**      * Read an operation from the input stream.      *       * Note that the objects returned from this method may be re-used by future      * calls to the same method.      *       * @return the operation read from the stream, or null at the end of the file      * @throws IOException on error.      */
DECL|method|readOp ()
specifier|public
name|FSEditLogOp
name|readOp
parameter_list|()
throws|throws
name|IOException
block|{
if|if
condition|(
name|checksum
operator|!=
literal|null
condition|)
block|{
name|checksum
operator|.
name|reset
argument_list|()
expr_stmt|;
block|}
name|in
operator|.
name|mark
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|byte
name|opCodeByte
decl_stmt|;
try|try
block|{
name|opCodeByte
operator|=
name|in
operator|.
name|readByte
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|EOFException
name|eof
parameter_list|)
block|{
comment|// EOF at an opcode boundary is expected.
return|return
literal|null
return|;
block|}
name|FSEditLogOpCodes
name|opCode
init|=
name|FSEditLogOpCodes
operator|.
name|fromByte
argument_list|(
name|opCodeByte
argument_list|)
decl_stmt|;
if|if
condition|(
name|opCode
operator|==
name|OP_INVALID
condition|)
block|{
name|in
operator|.
name|reset
argument_list|()
expr_stmt|;
comment|// reset back to end of file if somebody reads it again
return|return
literal|null
return|;
block|}
name|FSEditLogOp
name|op
init|=
name|opInstances
operator|.
name|get
argument_list|(
name|opCode
argument_list|)
decl_stmt|;
if|if
condition|(
name|op
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Read invalid opcode "
operator|+
name|opCode
argument_list|)
throw|;
block|}
name|op
operator|.
name|readFields
argument_list|(
name|in
argument_list|,
name|logVersion
argument_list|)
expr_stmt|;
name|validateChecksum
argument_list|(
name|in
argument_list|,
name|checksum
argument_list|)
expr_stmt|;
return|return
name|op
return|;
block|}
comment|/**      * Validate a transaction's checksum      */
DECL|method|validateChecksum (DataInputStream in, Checksum checksum)
specifier|private
name|void
name|validateChecksum
parameter_list|(
name|DataInputStream
name|in
parameter_list|,
name|Checksum
name|checksum
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
name|checksum
operator|!=
literal|null
condition|)
block|{
name|int
name|calculatedChecksum
init|=
operator|(
name|int
operator|)
name|checksum
operator|.
name|getValue
argument_list|()
decl_stmt|;
name|int
name|readChecksum
init|=
name|in
operator|.
name|readInt
argument_list|()
decl_stmt|;
comment|// read in checksum
if|if
condition|(
name|readChecksum
operator|!=
name|calculatedChecksum
condition|)
block|{
throw|throw
operator|new
name|ChecksumException
argument_list|(
literal|"Transaction is corrupt. Calculated checksum is "
operator|+
name|calculatedChecksum
operator|+
literal|" but read checksum "
operator|+
name|readChecksum
argument_list|,
operator|-
literal|1
argument_list|)
throw|;
block|}
block|}
block|}
block|}
block|}
end_class

end_unit

