begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/**  * Licensed to the Apache Software Foundation (ASF) under one  * or more contributor license agreements.  See the NOTICE file  * distributed with this work for additional information  * regarding copyright ownership.  The ASF licenses this file  * to you under the Apache License, Version 2.0 (the  * "License"); you may not use this file except in compliance  * with the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
DECL|package|org.apache.hadoop.fs.azure.metrics
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|azure
operator|.
name|metrics
package|;
end_package

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|UUID
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|atomic
operator|.
name|AtomicLong
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|classification
operator|.
name|InterfaceAudience
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|classification
operator|.
name|InterfaceStability
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|conf
operator|.
name|Configuration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|metrics2
operator|.
name|MetricsCollector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|metrics2
operator|.
name|MetricsInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|metrics2
operator|.
name|MetricsSource
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|metrics2
operator|.
name|annotation
operator|.
name|Metrics
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|metrics2
operator|.
name|lib
operator|.
name|MetricsRegistry
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|metrics2
operator|.
name|lib
operator|.
name|MutableCounterLong
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|metrics2
operator|.
name|lib
operator|.
name|MutableGaugeLong
import|;
end_import

begin_comment
comment|/**  * A metrics source for the WASB file system to track all the metrics we care  * about for getting a clear picture of the performance/reliability/interaction  * of the Hadoop cluster with Azure Storage.  */
end_comment

begin_class
annotation|@
name|Metrics
argument_list|(
name|about
operator|=
literal|"Metrics for WASB"
argument_list|,
name|context
operator|=
literal|"azureFileSystem"
argument_list|)
annotation|@
name|InterfaceAudience
operator|.
name|Public
annotation|@
name|InterfaceStability
operator|.
name|Evolving
DECL|class|AzureFileSystemInstrumentation
specifier|public
specifier|final
class|class
name|AzureFileSystemInstrumentation
implements|implements
name|MetricsSource
block|{
DECL|field|METRIC_TAG_FILESYSTEM_ID
specifier|public
specifier|static
specifier|final
name|String
name|METRIC_TAG_FILESYSTEM_ID
init|=
literal|"wasbFileSystemId"
decl_stmt|;
DECL|field|METRIC_TAG_ACCOUNT_NAME
specifier|public
specifier|static
specifier|final
name|String
name|METRIC_TAG_ACCOUNT_NAME
init|=
literal|"accountName"
decl_stmt|;
DECL|field|METRIC_TAG_CONTAINTER_NAME
specifier|public
specifier|static
specifier|final
name|String
name|METRIC_TAG_CONTAINTER_NAME
init|=
literal|"containerName"
decl_stmt|;
DECL|field|WASB_WEB_RESPONSES
specifier|public
specifier|static
specifier|final
name|String
name|WASB_WEB_RESPONSES
init|=
literal|"wasb_web_responses"
decl_stmt|;
DECL|field|WASB_BYTES_WRITTEN
specifier|public
specifier|static
specifier|final
name|String
name|WASB_BYTES_WRITTEN
init|=
literal|"wasb_bytes_written_last_second"
decl_stmt|;
DECL|field|WASB_BYTES_READ
specifier|public
specifier|static
specifier|final
name|String
name|WASB_BYTES_READ
init|=
literal|"wasb_bytes_read_last_second"
decl_stmt|;
DECL|field|WASB_RAW_BYTES_UPLOADED
specifier|public
specifier|static
specifier|final
name|String
name|WASB_RAW_BYTES_UPLOADED
init|=
literal|"wasb_raw_bytes_uploaded"
decl_stmt|;
DECL|field|WASB_RAW_BYTES_DOWNLOADED
specifier|public
specifier|static
specifier|final
name|String
name|WASB_RAW_BYTES_DOWNLOADED
init|=
literal|"wasb_raw_bytes_downloaded"
decl_stmt|;
DECL|field|WASB_FILES_CREATED
specifier|public
specifier|static
specifier|final
name|String
name|WASB_FILES_CREATED
init|=
literal|"wasb_files_created"
decl_stmt|;
DECL|field|WASB_FILES_DELETED
specifier|public
specifier|static
specifier|final
name|String
name|WASB_FILES_DELETED
init|=
literal|"wasb_files_deleted"
decl_stmt|;
DECL|field|WASB_DIRECTORIES_CREATED
specifier|public
specifier|static
specifier|final
name|String
name|WASB_DIRECTORIES_CREATED
init|=
literal|"wasb_directories_created"
decl_stmt|;
DECL|field|WASB_DIRECTORIES_DELETED
specifier|public
specifier|static
specifier|final
name|String
name|WASB_DIRECTORIES_DELETED
init|=
literal|"wasb_directories_deleted"
decl_stmt|;
DECL|field|WASB_UPLOAD_RATE
specifier|public
specifier|static
specifier|final
name|String
name|WASB_UPLOAD_RATE
init|=
literal|"wasb_maximum_upload_bytes_per_second"
decl_stmt|;
DECL|field|WASB_DOWNLOAD_RATE
specifier|public
specifier|static
specifier|final
name|String
name|WASB_DOWNLOAD_RATE
init|=
literal|"wasb_maximum_download_bytes_per_second"
decl_stmt|;
DECL|field|WASB_UPLOAD_LATENCY
specifier|public
specifier|static
specifier|final
name|String
name|WASB_UPLOAD_LATENCY
init|=
literal|"wasb_average_block_upload_latency_ms"
decl_stmt|;
DECL|field|WASB_DOWNLOAD_LATENCY
specifier|public
specifier|static
specifier|final
name|String
name|WASB_DOWNLOAD_LATENCY
init|=
literal|"wasb_average_block_download_latency_ms"
decl_stmt|;
DECL|field|WASB_CLIENT_ERRORS
specifier|public
specifier|static
specifier|final
name|String
name|WASB_CLIENT_ERRORS
init|=
literal|"wasb_client_errors"
decl_stmt|;
DECL|field|WASB_SERVER_ERRORS
specifier|public
specifier|static
specifier|final
name|String
name|WASB_SERVER_ERRORS
init|=
literal|"wasb_server_errors"
decl_stmt|;
comment|/**    * Config key for how big the rolling window size for latency metrics should    * be (in seconds).    */
DECL|field|KEY_ROLLING_WINDOW_SIZE
specifier|private
specifier|static
specifier|final
name|String
name|KEY_ROLLING_WINDOW_SIZE
init|=
literal|"fs.azure.metrics.rolling.window.size"
decl_stmt|;
DECL|field|registry
specifier|private
specifier|final
name|MetricsRegistry
name|registry
init|=
operator|new
name|MetricsRegistry
argument_list|(
literal|"azureFileSystem"
argument_list|)
operator|.
name|setContext
argument_list|(
literal|"azureFileSystem"
argument_list|)
decl_stmt|;
DECL|field|numberOfWebResponses
specifier|private
specifier|final
name|MutableCounterLong
name|numberOfWebResponses
init|=
name|registry
operator|.
name|newCounter
argument_list|(
name|WASB_WEB_RESPONSES
argument_list|,
literal|"Total number of web responses obtained from Azure Storage"
argument_list|,
literal|0L
argument_list|)
decl_stmt|;
DECL|field|inMemoryNumberOfWebResponses
specifier|private
name|AtomicLong
name|inMemoryNumberOfWebResponses
init|=
operator|new
name|AtomicLong
argument_list|(
literal|0
argument_list|)
decl_stmt|;
DECL|field|numberOfFilesCreated
specifier|private
specifier|final
name|MutableCounterLong
name|numberOfFilesCreated
init|=
name|registry
operator|.
name|newCounter
argument_list|(
name|WASB_FILES_CREATED
argument_list|,
literal|"Total number of files created through the WASB file system."
argument_list|,
literal|0L
argument_list|)
decl_stmt|;
DECL|field|numberOfFilesDeleted
specifier|private
specifier|final
name|MutableCounterLong
name|numberOfFilesDeleted
init|=
name|registry
operator|.
name|newCounter
argument_list|(
name|WASB_FILES_DELETED
argument_list|,
literal|"Total number of files deleted through the WASB file system."
argument_list|,
literal|0L
argument_list|)
decl_stmt|;
DECL|field|numberOfDirectoriesCreated
specifier|private
specifier|final
name|MutableCounterLong
name|numberOfDirectoriesCreated
init|=
name|registry
operator|.
name|newCounter
argument_list|(
name|WASB_DIRECTORIES_CREATED
argument_list|,
literal|"Total number of directories created through the WASB file system."
argument_list|,
literal|0L
argument_list|)
decl_stmt|;
DECL|field|numberOfDirectoriesDeleted
specifier|private
specifier|final
name|MutableCounterLong
name|numberOfDirectoriesDeleted
init|=
name|registry
operator|.
name|newCounter
argument_list|(
name|WASB_DIRECTORIES_DELETED
argument_list|,
literal|"Total number of directories deleted through the WASB file system."
argument_list|,
literal|0L
argument_list|)
decl_stmt|;
DECL|field|bytesWrittenInLastSecond
specifier|private
specifier|final
name|MutableGaugeLong
name|bytesWrittenInLastSecond
init|=
name|registry
operator|.
name|newGauge
argument_list|(
name|WASB_BYTES_WRITTEN
argument_list|,
literal|"Total number of bytes written to Azure Storage during the last second."
argument_list|,
literal|0L
argument_list|)
decl_stmt|;
DECL|field|bytesReadInLastSecond
specifier|private
specifier|final
name|MutableGaugeLong
name|bytesReadInLastSecond
init|=
name|registry
operator|.
name|newGauge
argument_list|(
name|WASB_BYTES_READ
argument_list|,
literal|"Total number of bytes read from Azure Storage during the last second."
argument_list|,
literal|0L
argument_list|)
decl_stmt|;
DECL|field|maximumUploadBytesPerSecond
specifier|private
specifier|final
name|MutableGaugeLong
name|maximumUploadBytesPerSecond
init|=
name|registry
operator|.
name|newGauge
argument_list|(
name|WASB_UPLOAD_RATE
argument_list|,
literal|"The maximum upload rate encountered to Azure Storage in bytes/second."
argument_list|,
literal|0L
argument_list|)
decl_stmt|;
DECL|field|maximumDownloadBytesPerSecond
specifier|private
specifier|final
name|MutableGaugeLong
name|maximumDownloadBytesPerSecond
init|=
name|registry
operator|.
name|newGauge
argument_list|(
name|WASB_DOWNLOAD_RATE
argument_list|,
literal|"The maximum download rate encountered to Azure Storage in bytes/second."
argument_list|,
literal|0L
argument_list|)
decl_stmt|;
DECL|field|rawBytesUploaded
specifier|private
specifier|final
name|MutableCounterLong
name|rawBytesUploaded
init|=
name|registry
operator|.
name|newCounter
argument_list|(
name|WASB_RAW_BYTES_UPLOADED
argument_list|,
literal|"Total number of raw bytes (including overhead) uploaded to Azure"
operator|+
literal|" Storage."
argument_list|,
literal|0L
argument_list|)
decl_stmt|;
DECL|field|rawBytesDownloaded
specifier|private
specifier|final
name|MutableCounterLong
name|rawBytesDownloaded
init|=
name|registry
operator|.
name|newCounter
argument_list|(
name|WASB_RAW_BYTES_DOWNLOADED
argument_list|,
literal|"Total number of raw bytes (including overhead) downloaded from Azure"
operator|+
literal|" Storage."
argument_list|,
literal|0L
argument_list|)
decl_stmt|;
DECL|field|clientErrors
specifier|private
specifier|final
name|MutableCounterLong
name|clientErrors
init|=
name|registry
operator|.
name|newCounter
argument_list|(
name|WASB_CLIENT_ERRORS
argument_list|,
literal|"Total number of client-side errors by WASB (excluding 404)."
argument_list|,
literal|0L
argument_list|)
decl_stmt|;
DECL|field|serverErrors
specifier|private
specifier|final
name|MutableCounterLong
name|serverErrors
init|=
name|registry
operator|.
name|newCounter
argument_list|(
name|WASB_SERVER_ERRORS
argument_list|,
literal|"Total number of server-caused errors by WASB."
argument_list|,
literal|0L
argument_list|)
decl_stmt|;
DECL|field|averageBlockUploadLatencyMs
specifier|private
specifier|final
name|MutableGaugeLong
name|averageBlockUploadLatencyMs
decl_stmt|;
DECL|field|averageBlockDownloadLatencyMs
specifier|private
specifier|final
name|MutableGaugeLong
name|averageBlockDownloadLatencyMs
decl_stmt|;
DECL|field|currentMaximumUploadBytesPerSecond
specifier|private
name|long
name|currentMaximumUploadBytesPerSecond
decl_stmt|;
DECL|field|currentMaximumDownloadBytesPerSecond
specifier|private
name|long
name|currentMaximumDownloadBytesPerSecond
decl_stmt|;
DECL|field|DEFAULT_LATENCY_ROLLING_AVERAGE_WINDOW
specifier|private
specifier|static
specifier|final
name|int
name|DEFAULT_LATENCY_ROLLING_AVERAGE_WINDOW
init|=
literal|5
decl_stmt|;
comment|// seconds
DECL|field|currentBlockUploadLatency
specifier|private
specifier|final
name|RollingWindowAverage
name|currentBlockUploadLatency
decl_stmt|;
DECL|field|currentBlockDownloadLatency
specifier|private
specifier|final
name|RollingWindowAverage
name|currentBlockDownloadLatency
decl_stmt|;
DECL|field|fileSystemInstanceId
specifier|private
name|UUID
name|fileSystemInstanceId
decl_stmt|;
DECL|method|AzureFileSystemInstrumentation (Configuration conf)
specifier|public
name|AzureFileSystemInstrumentation
parameter_list|(
name|Configuration
name|conf
parameter_list|)
block|{
name|fileSystemInstanceId
operator|=
name|UUID
operator|.
name|randomUUID
argument_list|()
expr_stmt|;
name|registry
operator|.
name|tag
argument_list|(
literal|"wasbFileSystemId"
argument_list|,
literal|"A unique identifier for the file "
argument_list|,
name|fileSystemInstanceId
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
specifier|final
name|int
name|rollingWindowSizeInSeconds
init|=
name|conf
operator|.
name|getInt
argument_list|(
name|KEY_ROLLING_WINDOW_SIZE
argument_list|,
name|DEFAULT_LATENCY_ROLLING_AVERAGE_WINDOW
argument_list|)
decl_stmt|;
name|averageBlockUploadLatencyMs
operator|=
name|registry
operator|.
name|newGauge
argument_list|(
name|WASB_UPLOAD_LATENCY
argument_list|,
name|String
operator|.
name|format
argument_list|(
literal|"The average latency in milliseconds of uploading a single block"
operator|+
literal|". The average latency is calculated over a %d-second rolling"
operator|+
literal|" window."
argument_list|,
name|rollingWindowSizeInSeconds
argument_list|)
argument_list|,
literal|0L
argument_list|)
expr_stmt|;
name|averageBlockDownloadLatencyMs
operator|=
name|registry
operator|.
name|newGauge
argument_list|(
name|WASB_DOWNLOAD_LATENCY
argument_list|,
name|String
operator|.
name|format
argument_list|(
literal|"The average latency in milliseconds of downloading a single block"
operator|+
literal|". The average latency is calculated over a %d-second rolling"
operator|+
literal|" window."
argument_list|,
name|rollingWindowSizeInSeconds
argument_list|)
argument_list|,
literal|0L
argument_list|)
expr_stmt|;
name|currentBlockUploadLatency
operator|=
operator|new
name|RollingWindowAverage
argument_list|(
name|rollingWindowSizeInSeconds
operator|*
literal|1000
argument_list|)
expr_stmt|;
name|currentBlockDownloadLatency
operator|=
operator|new
name|RollingWindowAverage
argument_list|(
name|rollingWindowSizeInSeconds
operator|*
literal|1000
argument_list|)
expr_stmt|;
block|}
comment|/**    * The unique identifier for this file system in the metrics.    */
DECL|method|getFileSystemInstanceId ()
specifier|public
name|UUID
name|getFileSystemInstanceId
parameter_list|()
block|{
return|return
name|fileSystemInstanceId
return|;
block|}
comment|/**    * Get the metrics registry information.    */
DECL|method|getMetricsRegistryInfo ()
specifier|public
name|MetricsInfo
name|getMetricsRegistryInfo
parameter_list|()
block|{
return|return
name|registry
operator|.
name|info
argument_list|()
return|;
block|}
comment|/**    * Sets the account name to tag all the metrics with.    * @param accountName The account name.    */
DECL|method|setAccountName (String accountName)
specifier|public
name|void
name|setAccountName
parameter_list|(
name|String
name|accountName
parameter_list|)
block|{
name|registry
operator|.
name|tag
argument_list|(
literal|"accountName"
argument_list|,
literal|"Name of the Azure Storage account that these metrics are going against"
argument_list|,
name|accountName
argument_list|)
expr_stmt|;
block|}
comment|/**    * Sets the container name to tag all the metrics with.    * @param containerName The container name.    */
DECL|method|setContainerName (String containerName)
specifier|public
name|void
name|setContainerName
parameter_list|(
name|String
name|containerName
parameter_list|)
block|{
name|registry
operator|.
name|tag
argument_list|(
literal|"containerName"
argument_list|,
literal|"Name of the Azure Storage container that these metrics are going against"
argument_list|,
name|containerName
argument_list|)
expr_stmt|;
block|}
comment|/**    * Indicate that we just got a web response from Azure Storage. This should    * be called for every web request/response we do (to get accurate metrics    * of how we're hitting the storage service).    */
DECL|method|webResponse ()
specifier|public
name|void
name|webResponse
parameter_list|()
block|{
name|numberOfWebResponses
operator|.
name|incr
argument_list|()
expr_stmt|;
name|inMemoryNumberOfWebResponses
operator|.
name|incrementAndGet
argument_list|()
expr_stmt|;
block|}
comment|/**    * Gets the current number of web responses obtained from Azure Storage.    * @return The number of web responses.    */
DECL|method|getCurrentWebResponses ()
specifier|public
name|long
name|getCurrentWebResponses
parameter_list|()
block|{
return|return
name|inMemoryNumberOfWebResponses
operator|.
name|get
argument_list|()
return|;
block|}
comment|/**    * Indicate that we just created a file through WASB.    */
DECL|method|fileCreated ()
specifier|public
name|void
name|fileCreated
parameter_list|()
block|{
name|numberOfFilesCreated
operator|.
name|incr
argument_list|()
expr_stmt|;
block|}
comment|/**    * Indicate that we just deleted a file through WASB.    */
DECL|method|fileDeleted ()
specifier|public
name|void
name|fileDeleted
parameter_list|()
block|{
name|numberOfFilesDeleted
operator|.
name|incr
argument_list|()
expr_stmt|;
block|}
comment|/**    * Indicate that we just created a directory through WASB.    */
DECL|method|directoryCreated ()
specifier|public
name|void
name|directoryCreated
parameter_list|()
block|{
name|numberOfDirectoriesCreated
operator|.
name|incr
argument_list|()
expr_stmt|;
block|}
comment|/**    * Indicate that we just deleted a directory through WASB.    */
DECL|method|directoryDeleted ()
specifier|public
name|void
name|directoryDeleted
parameter_list|()
block|{
name|numberOfDirectoriesDeleted
operator|.
name|incr
argument_list|()
expr_stmt|;
block|}
comment|/**    * Sets the current gauge value for how many bytes were written in the last    *  second.    * @param currentBytesWritten The number of bytes.    */
DECL|method|updateBytesWrittenInLastSecond (long currentBytesWritten)
specifier|public
name|void
name|updateBytesWrittenInLastSecond
parameter_list|(
name|long
name|currentBytesWritten
parameter_list|)
block|{
name|bytesWrittenInLastSecond
operator|.
name|set
argument_list|(
name|currentBytesWritten
argument_list|)
expr_stmt|;
block|}
comment|/**    * Sets the current gauge value for how many bytes were read in the last    *  second.    * @param currentBytesRead The number of bytes.    */
DECL|method|updateBytesReadInLastSecond (long currentBytesRead)
specifier|public
name|void
name|updateBytesReadInLastSecond
parameter_list|(
name|long
name|currentBytesRead
parameter_list|)
block|{
name|bytesReadInLastSecond
operator|.
name|set
argument_list|(
name|currentBytesRead
argument_list|)
expr_stmt|;
block|}
comment|/**    * Record the current bytes-per-second upload rate seen.    * @param bytesPerSecond The bytes per second.    */
DECL|method|currentUploadBytesPerSecond (long bytesPerSecond)
specifier|public
specifier|synchronized
name|void
name|currentUploadBytesPerSecond
parameter_list|(
name|long
name|bytesPerSecond
parameter_list|)
block|{
if|if
condition|(
name|bytesPerSecond
operator|>
name|currentMaximumUploadBytesPerSecond
condition|)
block|{
name|currentMaximumUploadBytesPerSecond
operator|=
name|bytesPerSecond
expr_stmt|;
name|maximumUploadBytesPerSecond
operator|.
name|set
argument_list|(
name|bytesPerSecond
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**    * Record the current bytes-per-second download rate seen.    * @param bytesPerSecond The bytes per second.    */
DECL|method|currentDownloadBytesPerSecond (long bytesPerSecond)
specifier|public
specifier|synchronized
name|void
name|currentDownloadBytesPerSecond
parameter_list|(
name|long
name|bytesPerSecond
parameter_list|)
block|{
if|if
condition|(
name|bytesPerSecond
operator|>
name|currentMaximumDownloadBytesPerSecond
condition|)
block|{
name|currentMaximumDownloadBytesPerSecond
operator|=
name|bytesPerSecond
expr_stmt|;
name|maximumDownloadBytesPerSecond
operator|.
name|set
argument_list|(
name|bytesPerSecond
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**    * Indicate that we just uploaded some data to Azure storage.    * @param numberOfBytes The raw number of bytes uploaded (including overhead).    */
DECL|method|rawBytesUploaded (long numberOfBytes)
specifier|public
name|void
name|rawBytesUploaded
parameter_list|(
name|long
name|numberOfBytes
parameter_list|)
block|{
name|rawBytesUploaded
operator|.
name|incr
argument_list|(
name|numberOfBytes
argument_list|)
expr_stmt|;
block|}
comment|/**    * Indicate that we just downloaded some data to Azure storage.    * @param numberOfBytes The raw number of bytes downloaded (including overhead).    */
DECL|method|rawBytesDownloaded (long numberOfBytes)
specifier|public
name|void
name|rawBytesDownloaded
parameter_list|(
name|long
name|numberOfBytes
parameter_list|)
block|{
name|rawBytesDownloaded
operator|.
name|incr
argument_list|(
name|numberOfBytes
argument_list|)
expr_stmt|;
block|}
comment|/**    * Indicate that we just uploaded a block and record its latency.    * @param latency The latency in milliseconds.    */
DECL|method|blockUploaded (long latency)
specifier|public
name|void
name|blockUploaded
parameter_list|(
name|long
name|latency
parameter_list|)
block|{
name|currentBlockUploadLatency
operator|.
name|addPoint
argument_list|(
name|latency
argument_list|)
expr_stmt|;
block|}
comment|/**    * Indicate that we just downloaded a block and record its latency.    * @param latency The latency in milliseconds.    */
DECL|method|blockDownloaded (long latency)
specifier|public
name|void
name|blockDownloaded
parameter_list|(
name|long
name|latency
parameter_list|)
block|{
name|currentBlockDownloadLatency
operator|.
name|addPoint
argument_list|(
name|latency
argument_list|)
expr_stmt|;
block|}
comment|/**    * Indicate that we just encountered a client-side error.    */
DECL|method|clientErrorEncountered ()
specifier|public
name|void
name|clientErrorEncountered
parameter_list|()
block|{
name|clientErrors
operator|.
name|incr
argument_list|()
expr_stmt|;
block|}
comment|/**    * Indicate that we just encountered a server-caused error.    */
DECL|method|serverErrorEncountered ()
specifier|public
name|void
name|serverErrorEncountered
parameter_list|()
block|{
name|serverErrors
operator|.
name|incr
argument_list|()
expr_stmt|;
block|}
comment|/**    * Get the current rolling average of the upload latency.    * @return rolling average of upload latency in milliseconds.    */
DECL|method|getBlockUploadLatency ()
specifier|public
name|long
name|getBlockUploadLatency
parameter_list|()
block|{
return|return
name|currentBlockUploadLatency
operator|.
name|getCurrentAverage
argument_list|()
return|;
block|}
comment|/**    * Get the current rolling average of the download latency.    * @return rolling average of download latency in milliseconds.    */
DECL|method|getBlockDownloadLatency ()
specifier|public
name|long
name|getBlockDownloadLatency
parameter_list|()
block|{
return|return
name|currentBlockDownloadLatency
operator|.
name|getCurrentAverage
argument_list|()
return|;
block|}
comment|/**    * Get the current maximum upload bandwidth.    * @return maximum upload bandwidth in bytes per second.    */
DECL|method|getCurrentMaximumUploadBandwidth ()
specifier|public
name|long
name|getCurrentMaximumUploadBandwidth
parameter_list|()
block|{
return|return
name|currentMaximumUploadBytesPerSecond
return|;
block|}
comment|/**    * Get the current maximum download bandwidth.    * @return maximum download bandwidth in bytes per second.    */
DECL|method|getCurrentMaximumDownloadBandwidth ()
specifier|public
name|long
name|getCurrentMaximumDownloadBandwidth
parameter_list|()
block|{
return|return
name|currentMaximumDownloadBytesPerSecond
return|;
block|}
annotation|@
name|Override
DECL|method|getMetrics (MetricsCollector builder, boolean all)
specifier|public
name|void
name|getMetrics
parameter_list|(
name|MetricsCollector
name|builder
parameter_list|,
name|boolean
name|all
parameter_list|)
block|{
name|averageBlockDownloadLatencyMs
operator|.
name|set
argument_list|(
name|currentBlockDownloadLatency
operator|.
name|getCurrentAverage
argument_list|()
argument_list|)
expr_stmt|;
name|averageBlockUploadLatencyMs
operator|.
name|set
argument_list|(
name|currentBlockUploadLatency
operator|.
name|getCurrentAverage
argument_list|()
argument_list|)
expr_stmt|;
name|registry
operator|.
name|snapshot
argument_list|(
name|builder
operator|.
name|addRecord
argument_list|(
name|registry
operator|.
name|info
argument_list|()
operator|.
name|name
argument_list|()
argument_list|)
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
block|}
end_class

end_unit

