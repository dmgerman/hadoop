begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/**  * Licensed to the Apache Software Foundation (ASF) under one  * or more contributor license agreements.  See the NOTICE file  * distributed with this work for additional information  * regarding copyright ownership.  The ASF licenses this file  * to you under the Apache License, Version 2.0 (the  * "License"); you may not use this file except in compliance  * with the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
DECL|package|org.apache.hadoop.yarn.util
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|util
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|BufferedReader
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|File
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|FileFilter
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|FileInputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|FileNotFoundException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStreamReader
import|;
end_import

begin_import
import|import
name|java
operator|.
name|math
operator|.
name|BigInteger
import|;
end_import

begin_import
import|import
name|java
operator|.
name|nio
operator|.
name|charset
operator|.
name|Charset
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayDeque
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collections
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|LinkedList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Queue
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|regex
operator|.
name|Matcher
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|regex
operator|.
name|Pattern
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|io
operator|.
name|IOUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|io
operator|.
name|filefilter
operator|.
name|AndFileFilter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|io
operator|.
name|filefilter
operator|.
name|DirectoryFileFilter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|io
operator|.
name|filefilter
operator|.
name|RegexFileFilter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|lang3
operator|.
name|ArrayUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|lang3
operator|.
name|StringUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|Log
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|LogFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|classification
operator|.
name|InterfaceAudience
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|classification
operator|.
name|InterfaceStability
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|conf
operator|.
name|Configuration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|util
operator|.
name|CpuTimeTracker
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|util
operator|.
name|Shell
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|util
operator|.
name|SysInfoLinux
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|conf
operator|.
name|YarnConfiguration
import|;
end_import

begin_comment
comment|/**  * A Proc file-system based ProcessTree. Works only on Linux.  */
end_comment

begin_class
annotation|@
name|InterfaceAudience
operator|.
name|Private
annotation|@
name|InterfaceStability
operator|.
name|Unstable
DECL|class|ProcfsBasedProcessTree
specifier|public
class|class
name|ProcfsBasedProcessTree
extends|extends
name|ResourceCalculatorProcessTree
block|{
DECL|field|LOG
specifier|static
specifier|final
name|Log
name|LOG
init|=
name|LogFactory
operator|.
name|getLog
argument_list|(
name|ProcfsBasedProcessTree
operator|.
name|class
argument_list|)
decl_stmt|;
DECL|field|PROCFS
specifier|private
specifier|static
specifier|final
name|String
name|PROCFS
init|=
literal|"/proc/"
decl_stmt|;
DECL|field|PROCFS_STAT_FILE_FORMAT
specifier|private
specifier|static
specifier|final
name|Pattern
name|PROCFS_STAT_FILE_FORMAT
init|=
name|Pattern
operator|.
name|compile
argument_list|(
literal|"^([\\d-]+)\\s\\((.*)\\)\\s[^\\s]\\s([\\d-]+)\\s([\\d-]+)\\s"
operator|+
literal|"([\\d-]+)\\s([\\d-]+\\s){7}(\\d+)\\s(\\d+)\\s([\\d-]+\\s){7}(\\d+)\\s"
operator|+
literal|"(\\d+)(\\s[\\d-]+){15}"
argument_list|)
decl_stmt|;
DECL|field|PROCFS_STAT_FILE
specifier|public
specifier|static
specifier|final
name|String
name|PROCFS_STAT_FILE
init|=
literal|"stat"
decl_stmt|;
DECL|field|PROCFS_CMDLINE_FILE
specifier|public
specifier|static
specifier|final
name|String
name|PROCFS_CMDLINE_FILE
init|=
literal|"cmdline"
decl_stmt|;
DECL|field|PAGE_SIZE
specifier|public
specifier|static
specifier|final
name|long
name|PAGE_SIZE
init|=
name|SysInfoLinux
operator|.
name|PAGE_SIZE
decl_stmt|;
DECL|field|JIFFY_LENGTH_IN_MILLIS
specifier|public
specifier|static
specifier|final
name|long
name|JIFFY_LENGTH_IN_MILLIS
init|=
name|SysInfoLinux
operator|.
name|JIFFY_LENGTH_IN_MILLIS
decl_stmt|;
comment|// in millisecond
DECL|field|cpuTimeTracker
specifier|private
specifier|final
name|CpuTimeTracker
name|cpuTimeTracker
decl_stmt|;
DECL|field|clock
specifier|private
name|Clock
name|clock
decl_stmt|;
DECL|enum|MemInfo
enum|enum
name|MemInfo
block|{
DECL|enumConstant|SIZE
DECL|enumConstant|RSS
DECL|enumConstant|PSS
DECL|enumConstant|SHARED_CLEAN
name|SIZE
argument_list|(
literal|"Size"
argument_list|)
block|,
name|RSS
argument_list|(
literal|"Rss"
argument_list|)
block|,
name|PSS
argument_list|(
literal|"Pss"
argument_list|)
block|,
name|SHARED_CLEAN
argument_list|(
literal|"Shared_Clean"
argument_list|)
block|,
DECL|enumConstant|SHARED_DIRTY
DECL|enumConstant|PRIVATE_CLEAN
name|SHARED_DIRTY
argument_list|(
literal|"Shared_Dirty"
argument_list|)
block|,
name|PRIVATE_CLEAN
argument_list|(
literal|"Private_Clean"
argument_list|)
block|,
DECL|enumConstant|PRIVATE_DIRTY
DECL|enumConstant|REFERENCED
DECL|enumConstant|ANONYMOUS
name|PRIVATE_DIRTY
argument_list|(
literal|"Private_Dirty"
argument_list|)
block|,
name|REFERENCED
argument_list|(
literal|"Referenced"
argument_list|)
block|,
name|ANONYMOUS
argument_list|(
DECL|enumConstant|ANON_HUGE_PAGES
DECL|enumConstant|SWAP
literal|"Anonymous"
argument_list|)
block|,
name|ANON_HUGE_PAGES
argument_list|(
literal|"AnonHugePages"
argument_list|)
block|,
name|SWAP
argument_list|(
literal|"swap"
argument_list|)
block|,
DECL|enumConstant|KERNEL_PAGE_SIZE
DECL|enumConstant|MMU_PAGE_SIZE
DECL|enumConstant|INVALID
name|KERNEL_PAGE_SIZE
argument_list|(
literal|"kernelPageSize"
argument_list|)
block|,
name|MMU_PAGE_SIZE
argument_list|(
literal|"mmuPageSize"
argument_list|)
block|,
name|INVALID
argument_list|(
literal|"invalid"
argument_list|)
block|;
DECL|field|name
specifier|private
name|String
name|name
decl_stmt|;
DECL|method|MemInfo (String name)
specifier|private
name|MemInfo
parameter_list|(
name|String
name|name
parameter_list|)
block|{
name|this
operator|.
name|name
operator|=
name|name
expr_stmt|;
block|}
DECL|method|getMemInfoByName (String name)
specifier|public
specifier|static
name|MemInfo
name|getMemInfoByName
parameter_list|(
name|String
name|name
parameter_list|)
block|{
name|String
name|searchName
init|=
name|StringUtils
operator|.
name|trimToNull
argument_list|(
name|name
argument_list|)
decl_stmt|;
for|for
control|(
name|MemInfo
name|info
range|:
name|MemInfo
operator|.
name|values
argument_list|()
control|)
block|{
if|if
condition|(
name|info
operator|.
name|name
operator|.
name|trim
argument_list|()
operator|.
name|equalsIgnoreCase
argument_list|(
name|searchName
argument_list|)
condition|)
block|{
return|return
name|info
return|;
block|}
block|}
return|return
name|INVALID
return|;
block|}
block|}
DECL|field|SMAPS
specifier|public
specifier|static
specifier|final
name|String
name|SMAPS
init|=
literal|"smaps"
decl_stmt|;
DECL|field|KB_TO_BYTES
specifier|public
specifier|static
specifier|final
name|int
name|KB_TO_BYTES
init|=
literal|1024
decl_stmt|;
DECL|field|KB
specifier|private
specifier|static
specifier|final
name|String
name|KB
init|=
literal|"kB"
decl_stmt|;
DECL|field|READ_ONLY_WITH_SHARED_PERMISSION
specifier|private
specifier|static
specifier|final
name|String
name|READ_ONLY_WITH_SHARED_PERMISSION
init|=
literal|"r--s"
decl_stmt|;
DECL|field|READ_EXECUTE_WITH_SHARED_PERMISSION
specifier|private
specifier|static
specifier|final
name|String
name|READ_EXECUTE_WITH_SHARED_PERMISSION
init|=
literal|"r-xs"
decl_stmt|;
DECL|field|ADDRESS_PATTERN
specifier|private
specifier|static
specifier|final
name|Pattern
name|ADDRESS_PATTERN
init|=
name|Pattern
operator|.
name|compile
argument_list|(
literal|"([[a-f]|(0-9)]*)-([[a-f]|(0-9)]*)(\\s)*([rxwps\\-]*)"
argument_list|)
decl_stmt|;
DECL|field|MEM_INFO_PATTERN
specifier|private
specifier|static
specifier|final
name|Pattern
name|MEM_INFO_PATTERN
init|=
name|Pattern
operator|.
name|compile
argument_list|(
literal|"(^[A-Z].*):[\\s ]*(.*)"
argument_list|)
decl_stmt|;
DECL|field|smapsEnabled
specifier|private
name|boolean
name|smapsEnabled
decl_stmt|;
DECL|field|processSMAPTree
specifier|protected
name|Map
argument_list|<
name|String
argument_list|,
name|ProcessTreeSmapMemInfo
argument_list|>
name|processSMAPTree
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|ProcessTreeSmapMemInfo
argument_list|>
argument_list|()
decl_stmt|;
comment|// to enable testing, using this variable which can be configured
comment|// to a test directory.
DECL|field|procfsDir
specifier|private
name|String
name|procfsDir
decl_stmt|;
DECL|field|deadPid
specifier|static
specifier|private
name|String
name|deadPid
init|=
literal|"-1"
decl_stmt|;
DECL|field|pid
specifier|private
name|String
name|pid
init|=
name|deadPid
decl_stmt|;
DECL|field|numberPattern
specifier|static
specifier|private
name|Pattern
name|numberPattern
init|=
name|Pattern
operator|.
name|compile
argument_list|(
literal|"[1-9][0-9]*"
argument_list|)
decl_stmt|;
DECL|field|cpuTime
specifier|private
name|long
name|cpuTime
init|=
name|UNAVAILABLE
decl_stmt|;
DECL|field|processTree
specifier|protected
name|Map
argument_list|<
name|String
argument_list|,
name|ProcessInfo
argument_list|>
name|processTree
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|ProcessInfo
argument_list|>
argument_list|()
decl_stmt|;
DECL|method|ProcfsBasedProcessTree (String pid)
specifier|public
name|ProcfsBasedProcessTree
parameter_list|(
name|String
name|pid
parameter_list|)
block|{
name|this
argument_list|(
name|pid
argument_list|,
name|PROCFS
argument_list|,
name|SystemClock
operator|.
name|getInstance
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|setConf (Configuration conf)
specifier|public
name|void
name|setConf
parameter_list|(
name|Configuration
name|conf
parameter_list|)
block|{
name|super
operator|.
name|setConf
argument_list|(
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|!=
literal|null
condition|)
block|{
name|smapsEnabled
operator|=
name|conf
operator|.
name|getBoolean
argument_list|(
name|YarnConfiguration
operator|.
name|PROCFS_USE_SMAPS_BASED_RSS_ENABLED
argument_list|,
name|YarnConfiguration
operator|.
name|DEFAULT_PROCFS_USE_SMAPS_BASED_RSS_ENABLED
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|ProcfsBasedProcessTree (String pid, String procfsDir)
specifier|public
name|ProcfsBasedProcessTree
parameter_list|(
name|String
name|pid
parameter_list|,
name|String
name|procfsDir
parameter_list|)
block|{
name|this
argument_list|(
name|pid
argument_list|,
name|procfsDir
argument_list|,
name|SystemClock
operator|.
name|getInstance
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|/**    * Build a new process tree rooted at the pid.    *    * This method is provided mainly for testing purposes, where    * the root of the proc file system can be adjusted.    *    * @param pid root of the process tree    * @param procfsDir the root of a proc file system - only used for testing.    * @param clock clock for controlling time for testing    */
DECL|method|ProcfsBasedProcessTree (String pid, String procfsDir, Clock clock)
specifier|public
name|ProcfsBasedProcessTree
parameter_list|(
name|String
name|pid
parameter_list|,
name|String
name|procfsDir
parameter_list|,
name|Clock
name|clock
parameter_list|)
block|{
name|super
argument_list|(
name|pid
argument_list|)
expr_stmt|;
name|this
operator|.
name|clock
operator|=
name|clock
expr_stmt|;
name|this
operator|.
name|pid
operator|=
name|getValidPID
argument_list|(
name|pid
argument_list|)
expr_stmt|;
name|this
operator|.
name|procfsDir
operator|=
name|procfsDir
expr_stmt|;
name|this
operator|.
name|cpuTimeTracker
operator|=
operator|new
name|CpuTimeTracker
argument_list|(
name|JIFFY_LENGTH_IN_MILLIS
argument_list|)
expr_stmt|;
block|}
comment|/**    * Checks if the ProcfsBasedProcessTree is available on this system.    *    * @return true if ProcfsBasedProcessTree is available. False otherwise.    */
DECL|method|isAvailable ()
specifier|public
specifier|static
name|boolean
name|isAvailable
parameter_list|()
block|{
try|try
block|{
if|if
condition|(
operator|!
name|Shell
operator|.
name|LINUX
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"ProcfsBasedProcessTree currently is supported only on "
operator|+
literal|"Linux."
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
block|}
catch|catch
parameter_list|(
name|SecurityException
name|se
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Failed to get Operating System name."
argument_list|,
name|se
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
return|return
literal|true
return|;
block|}
comment|/**    * Update process-tree with latest state. If the root-process is not alive,    * tree will be empty.    *    */
annotation|@
name|Override
DECL|method|updateProcessTree ()
specifier|public
name|void
name|updateProcessTree
parameter_list|()
block|{
if|if
condition|(
operator|!
name|pid
operator|.
name|equals
argument_list|(
name|deadPid
argument_list|)
condition|)
block|{
comment|// Get the list of processes
name|List
argument_list|<
name|String
argument_list|>
name|processList
init|=
name|getProcessList
argument_list|()
decl_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|ProcessInfo
argument_list|>
name|allProcessInfo
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|ProcessInfo
argument_list|>
argument_list|()
decl_stmt|;
comment|// cache the processTree to get the age for processes
name|Map
argument_list|<
name|String
argument_list|,
name|ProcessInfo
argument_list|>
name|oldProcs
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|ProcessInfo
argument_list|>
argument_list|(
name|processTree
argument_list|)
decl_stmt|;
name|processTree
operator|.
name|clear
argument_list|()
expr_stmt|;
name|ProcessInfo
name|me
init|=
literal|null
decl_stmt|;
for|for
control|(
name|String
name|proc
range|:
name|processList
control|)
block|{
comment|// Get information for each process
name|ProcessInfo
name|pInfo
init|=
operator|new
name|ProcessInfo
argument_list|(
name|proc
argument_list|)
decl_stmt|;
if|if
condition|(
name|constructProcessInfo
argument_list|(
name|pInfo
argument_list|,
name|procfsDir
argument_list|)
operator|!=
literal|null
condition|)
block|{
name|allProcessInfo
operator|.
name|put
argument_list|(
name|proc
argument_list|,
name|pInfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|proc
operator|.
name|equals
argument_list|(
name|this
operator|.
name|pid
argument_list|)
condition|)
block|{
name|me
operator|=
name|pInfo
expr_stmt|;
comment|// cache 'me'
name|processTree
operator|.
name|put
argument_list|(
name|proc
argument_list|,
name|pInfo
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|me
operator|==
literal|null
condition|)
block|{
return|return;
block|}
comment|// Add each process to its parent.
for|for
control|(
name|Map
operator|.
name|Entry
argument_list|<
name|String
argument_list|,
name|ProcessInfo
argument_list|>
name|entry
range|:
name|allProcessInfo
operator|.
name|entrySet
argument_list|()
control|)
block|{
name|String
name|pID
init|=
name|entry
operator|.
name|getKey
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
literal|"1"
operator|.
name|equals
argument_list|(
name|pID
argument_list|)
condition|)
block|{
name|ProcessInfo
name|pInfo
init|=
name|entry
operator|.
name|getValue
argument_list|()
decl_stmt|;
name|String
name|ppid
init|=
name|pInfo
operator|.
name|getPpid
argument_list|()
decl_stmt|;
comment|// If parent is init and process is not session leader,
comment|// attach to sessionID
if|if
condition|(
literal|"1"
operator|.
name|equals
argument_list|(
name|ppid
argument_list|)
condition|)
block|{
name|String
name|sid
init|=
name|pInfo
operator|.
name|getSessionId
argument_list|()
operator|.
name|toString
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|pID
operator|.
name|equals
argument_list|(
name|sid
argument_list|)
condition|)
block|{
name|ppid
operator|=
name|sid
expr_stmt|;
block|}
block|}
name|ProcessInfo
name|parentPInfo
init|=
name|allProcessInfo
operator|.
name|get
argument_list|(
name|ppid
argument_list|)
decl_stmt|;
if|if
condition|(
name|parentPInfo
operator|!=
literal|null
condition|)
block|{
name|parentPInfo
operator|.
name|addChild
argument_list|(
name|pInfo
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|// now start constructing the process-tree
name|List
argument_list|<
name|ProcessInfo
argument_list|>
name|children
init|=
name|me
operator|.
name|getChildren
argument_list|()
decl_stmt|;
name|Queue
argument_list|<
name|ProcessInfo
argument_list|>
name|pInfoQueue
init|=
operator|new
name|ArrayDeque
argument_list|<
name|ProcessInfo
argument_list|>
argument_list|(
name|children
argument_list|)
decl_stmt|;
while|while
condition|(
operator|!
name|pInfoQueue
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|ProcessInfo
name|pInfo
init|=
name|pInfoQueue
operator|.
name|remove
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|processTree
operator|.
name|containsKey
argument_list|(
name|pInfo
operator|.
name|getPid
argument_list|()
argument_list|)
condition|)
block|{
name|processTree
operator|.
name|put
argument_list|(
name|pInfo
operator|.
name|getPid
argument_list|()
argument_list|,
name|pInfo
argument_list|)
expr_stmt|;
block|}
name|pInfoQueue
operator|.
name|addAll
argument_list|(
name|pInfo
operator|.
name|getChildren
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|// update age values and compute the number of jiffies since last update
for|for
control|(
name|Map
operator|.
name|Entry
argument_list|<
name|String
argument_list|,
name|ProcessInfo
argument_list|>
name|procs
range|:
name|processTree
operator|.
name|entrySet
argument_list|()
control|)
block|{
name|ProcessInfo
name|oldInfo
init|=
name|oldProcs
operator|.
name|get
argument_list|(
name|procs
operator|.
name|getKey
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|procs
operator|.
name|getValue
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|procs
operator|.
name|getValue
argument_list|()
operator|.
name|updateJiffy
argument_list|(
name|oldInfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|oldInfo
operator|!=
literal|null
condition|)
block|{
name|procs
operator|.
name|getValue
argument_list|()
operator|.
name|updateAge
argument_list|(
name|oldInfo
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|LOG
operator|.
name|debug
argument_list|(
name|this
argument_list|)
expr_stmt|;
if|if
condition|(
name|smapsEnabled
condition|)
block|{
comment|// Update smaps info
name|processSMAPTree
operator|.
name|clear
argument_list|()
expr_stmt|;
for|for
control|(
name|ProcessInfo
name|p
range|:
name|processTree
operator|.
name|values
argument_list|()
control|)
block|{
if|if
condition|(
name|p
operator|!=
literal|null
condition|)
block|{
comment|// Get information for each process
name|ProcessTreeSmapMemInfo
name|memInfo
init|=
operator|new
name|ProcessTreeSmapMemInfo
argument_list|(
name|p
operator|.
name|getPid
argument_list|()
argument_list|)
decl_stmt|;
name|constructProcessSMAPInfo
argument_list|(
name|memInfo
argument_list|,
name|procfsDir
argument_list|)
expr_stmt|;
name|processSMAPTree
operator|.
name|put
argument_list|(
name|p
operator|.
name|getPid
argument_list|()
argument_list|,
name|memInfo
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
comment|/** Verify that the given process id is same as its process group id.    * @return true if the process id matches else return false.    */
annotation|@
name|Override
DECL|method|checkPidPgrpidForMatch ()
specifier|public
name|boolean
name|checkPidPgrpidForMatch
parameter_list|()
block|{
return|return
name|checkPidPgrpidForMatch
argument_list|(
name|pid
argument_list|,
name|PROCFS
argument_list|)
return|;
block|}
DECL|method|checkPidPgrpidForMatch (String _pid, String procfs)
specifier|public
specifier|static
name|boolean
name|checkPidPgrpidForMatch
parameter_list|(
name|String
name|_pid
parameter_list|,
name|String
name|procfs
parameter_list|)
block|{
comment|// Get information for this process
name|ProcessInfo
name|pInfo
init|=
operator|new
name|ProcessInfo
argument_list|(
name|_pid
argument_list|)
decl_stmt|;
name|pInfo
operator|=
name|constructProcessInfo
argument_list|(
name|pInfo
argument_list|,
name|procfs
argument_list|)
expr_stmt|;
comment|// null if process group leader finished execution; issue no warning
comment|// make sure that pid and its pgrpId match
if|if
condition|(
name|pInfo
operator|==
literal|null
condition|)
return|return
literal|true
return|;
name|String
name|pgrpId
init|=
name|pInfo
operator|.
name|getPgrpId
argument_list|()
operator|.
name|toString
argument_list|()
decl_stmt|;
return|return
name|pgrpId
operator|.
name|equals
argument_list|(
name|_pid
argument_list|)
return|;
block|}
DECL|field|PROCESSTREE_DUMP_FORMAT
specifier|private
specifier|static
specifier|final
name|String
name|PROCESSTREE_DUMP_FORMAT
init|=
literal|"\t|- %s %s %d %d %s %d %d %d %d %s%n"
decl_stmt|;
DECL|method|getCurrentProcessIDs ()
specifier|public
name|List
argument_list|<
name|String
argument_list|>
name|getCurrentProcessIDs
parameter_list|()
block|{
return|return
name|Collections
operator|.
name|unmodifiableList
argument_list|(
operator|new
name|ArrayList
argument_list|<>
argument_list|(
name|processTree
operator|.
name|keySet
argument_list|()
argument_list|)
argument_list|)
return|;
block|}
comment|/**    * Get a dump of the process-tree.    *    * @return a string concatenating the dump of information of all the processes    *         in the process-tree    */
annotation|@
name|Override
DECL|method|getProcessTreeDump ()
specifier|public
name|String
name|getProcessTreeDump
parameter_list|()
block|{
name|StringBuilder
name|ret
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
comment|// The header.
name|ret
operator|.
name|append
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"\t|- PID PPID PGRPID SESSID CMD_NAME "
operator|+
literal|"USER_MODE_TIME(MILLIS) SYSTEM_TIME(MILLIS) VMEM_USAGE(BYTES) "
operator|+
literal|"RSSMEM_USAGE(PAGES) FULL_CMD_LINE%n"
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|ProcessInfo
name|p
range|:
name|processTree
operator|.
name|values
argument_list|()
control|)
block|{
if|if
condition|(
name|p
operator|!=
literal|null
condition|)
block|{
name|ret
operator|.
name|append
argument_list|(
name|String
operator|.
name|format
argument_list|(
name|PROCESSTREE_DUMP_FORMAT
argument_list|,
name|p
operator|.
name|getPid
argument_list|()
argument_list|,
name|p
operator|.
name|getPpid
argument_list|()
argument_list|,
name|p
operator|.
name|getPgrpId
argument_list|()
argument_list|,
name|p
operator|.
name|getSessionId
argument_list|()
argument_list|,
name|p
operator|.
name|getName
argument_list|()
argument_list|,
name|p
operator|.
name|getUtime
argument_list|()
argument_list|,
name|p
operator|.
name|getStime
argument_list|()
argument_list|,
name|p
operator|.
name|getVmem
argument_list|()
argument_list|,
name|p
operator|.
name|getRssmemPage
argument_list|()
argument_list|,
name|p
operator|.
name|getCmdLine
argument_list|(
name|procfsDir
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|ret
operator|.
name|toString
argument_list|()
return|;
block|}
annotation|@
name|Override
DECL|method|getVirtualMemorySize (int olderThanAge)
specifier|public
name|long
name|getVirtualMemorySize
parameter_list|(
name|int
name|olderThanAge
parameter_list|)
block|{
name|long
name|total
init|=
literal|0L
decl_stmt|;
name|boolean
name|isAvailable
init|=
literal|false
decl_stmt|;
for|for
control|(
name|ProcessInfo
name|p
range|:
name|processTree
operator|.
name|values
argument_list|()
control|)
block|{
if|if
condition|(
name|p
operator|!=
literal|null
condition|)
block|{
name|isAvailable
operator|=
literal|true
expr_stmt|;
if|if
condition|(
name|p
operator|.
name|getAge
argument_list|()
operator|>
name|olderThanAge
condition|)
block|{
name|total
operator|+=
name|p
operator|.
name|getVmem
argument_list|()
expr_stmt|;
block|}
block|}
block|}
return|return
name|isAvailable
condition|?
name|total
else|:
name|UNAVAILABLE
return|;
block|}
annotation|@
name|Override
DECL|method|getRssMemorySize (int olderThanAge)
specifier|public
name|long
name|getRssMemorySize
parameter_list|(
name|int
name|olderThanAge
parameter_list|)
block|{
if|if
condition|(
name|PAGE_SIZE
operator|<
literal|0
condition|)
block|{
return|return
name|UNAVAILABLE
return|;
block|}
if|if
condition|(
name|smapsEnabled
condition|)
block|{
return|return
name|getSmapBasedRssMemorySize
argument_list|(
name|olderThanAge
argument_list|)
return|;
block|}
name|boolean
name|isAvailable
init|=
literal|false
decl_stmt|;
name|long
name|totalPages
init|=
literal|0
decl_stmt|;
for|for
control|(
name|ProcessInfo
name|p
range|:
name|processTree
operator|.
name|values
argument_list|()
control|)
block|{
if|if
condition|(
name|p
operator|!=
literal|null
condition|)
block|{
name|isAvailable
operator|=
literal|true
expr_stmt|;
if|if
condition|(
name|p
operator|.
name|getAge
argument_list|()
operator|>
name|olderThanAge
condition|)
block|{
name|totalPages
operator|+=
name|p
operator|.
name|getRssmemPage
argument_list|()
expr_stmt|;
block|}
block|}
block|}
return|return
name|isAvailable
condition|?
name|totalPages
operator|*
name|PAGE_SIZE
else|:
name|UNAVAILABLE
return|;
comment|// convert # pages to byte
block|}
comment|/**    * Get the resident set size (RSS) memory used by all the processes    * in the process-tree that are older than the passed in age. RSS is    * calculated based on SMAP information. Skip mappings with "r--s", "r-xs"    * permissions to get real RSS usage of the process.    *    * @param olderThanAge    *          processes above this age are included in the memory addition    * @return rss memory used by the process-tree in bytes, for    * processes older than this age. return {@link #UNAVAILABLE} if it cannot    * be calculated.    */
DECL|method|getSmapBasedRssMemorySize (int olderThanAge)
specifier|private
name|long
name|getSmapBasedRssMemorySize
parameter_list|(
name|int
name|olderThanAge
parameter_list|)
block|{
name|long
name|total
init|=
name|UNAVAILABLE
decl_stmt|;
for|for
control|(
name|ProcessInfo
name|p
range|:
name|processTree
operator|.
name|values
argument_list|()
control|)
block|{
if|if
condition|(
name|p
operator|!=
literal|null
condition|)
block|{
comment|// set resource to 0 instead of UNAVAILABLE
if|if
condition|(
name|total
operator|==
name|UNAVAILABLE
condition|)
block|{
name|total
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|p
operator|.
name|getAge
argument_list|()
operator|>
name|olderThanAge
condition|)
block|{
name|ProcessTreeSmapMemInfo
name|procMemInfo
init|=
name|processSMAPTree
operator|.
name|get
argument_list|(
name|p
operator|.
name|getPid
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|procMemInfo
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|ProcessSmapMemoryInfo
name|info
range|:
name|procMemInfo
operator|.
name|getMemoryInfoList
argument_list|()
control|)
block|{
comment|// Do not account for r--s or r-xs mappings
if|if
condition|(
name|info
operator|.
name|getPermission
argument_list|()
operator|.
name|trim
argument_list|()
operator|.
name|equalsIgnoreCase
argument_list|(
name|READ_ONLY_WITH_SHARED_PERMISSION
argument_list|)
operator|||
name|info
operator|.
name|getPermission
argument_list|()
operator|.
name|trim
argument_list|()
operator|.
name|equalsIgnoreCase
argument_list|(
name|READ_EXECUTE_WITH_SHARED_PERMISSION
argument_list|)
condition|)
block|{
continue|continue;
block|}
comment|// Account for anonymous to know the amount of
comment|// memory reclaimable by killing the process
name|total
operator|+=
name|info
operator|.
name|anonymous
expr_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|" total("
operator|+
name|olderThanAge
operator|+
literal|"): PID : "
operator|+
name|p
operator|.
name|getPid
argument_list|()
operator|+
literal|", info : "
operator|+
name|info
operator|.
name|toString
argument_list|()
operator|+
literal|", total : "
operator|+
operator|(
name|total
operator|*
name|KB_TO_BYTES
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|LOG
operator|.
name|debug
argument_list|(
name|procMemInfo
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|total
operator|>
literal|0
condition|)
block|{
name|total
operator|*=
name|KB_TO_BYTES
expr_stmt|;
comment|// convert to bytes
block|}
name|LOG
operator|.
name|info
argument_list|(
literal|"SmapBasedCumulativeRssmem (bytes) : "
operator|+
name|total
argument_list|)
expr_stmt|;
return|return
name|total
return|;
comment|// size
block|}
annotation|@
name|Override
DECL|method|getCumulativeCpuTime ()
specifier|public
name|long
name|getCumulativeCpuTime
parameter_list|()
block|{
if|if
condition|(
name|JIFFY_LENGTH_IN_MILLIS
operator|<
literal|0
condition|)
block|{
return|return
name|UNAVAILABLE
return|;
block|}
name|long
name|incJiffies
init|=
literal|0
decl_stmt|;
name|boolean
name|isAvailable
init|=
literal|false
decl_stmt|;
for|for
control|(
name|ProcessInfo
name|p
range|:
name|processTree
operator|.
name|values
argument_list|()
control|)
block|{
if|if
condition|(
name|p
operator|!=
literal|null
condition|)
block|{
comment|// data is available
name|isAvailable
operator|=
literal|true
expr_stmt|;
name|incJiffies
operator|+=
name|p
operator|.
name|getDtime
argument_list|()
expr_stmt|;
block|}
block|}
if|if
condition|(
name|isAvailable
condition|)
block|{
comment|// reset cpuTime to 0 instead of UNAVAILABLE
if|if
condition|(
name|cpuTime
operator|==
name|UNAVAILABLE
condition|)
block|{
name|cpuTime
operator|=
literal|0L
expr_stmt|;
block|}
name|cpuTime
operator|+=
name|incJiffies
operator|*
name|JIFFY_LENGTH_IN_MILLIS
expr_stmt|;
block|}
return|return
name|cpuTime
return|;
block|}
DECL|method|getTotalProcessJiffies ()
specifier|private
name|BigInteger
name|getTotalProcessJiffies
parameter_list|()
block|{
name|BigInteger
name|totalStime
init|=
name|BigInteger
operator|.
name|ZERO
decl_stmt|;
name|long
name|totalUtime
init|=
literal|0
decl_stmt|;
for|for
control|(
name|ProcessInfo
name|p
range|:
name|processTree
operator|.
name|values
argument_list|()
control|)
block|{
if|if
condition|(
name|p
operator|!=
literal|null
condition|)
block|{
name|totalUtime
operator|+=
name|p
operator|.
name|getUtime
argument_list|()
expr_stmt|;
name|totalStime
operator|=
name|totalStime
operator|.
name|add
argument_list|(
name|p
operator|.
name|getStime
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|totalStime
operator|.
name|add
argument_list|(
name|BigInteger
operator|.
name|valueOf
argument_list|(
name|totalUtime
argument_list|)
argument_list|)
return|;
block|}
comment|/**    * Get the CPU usage by all the processes in the process-tree in Unix.    * Note: UNAVAILABLE will be returned in case when CPU usage is not    * available. It is NOT advised to return any other error code.    *    * @return percentage CPU usage since the process-tree was created,    * {@link #UNAVAILABLE} if CPU usage cannot be calculated or not available.    */
annotation|@
name|Override
DECL|method|getCpuUsagePercent ()
specifier|public
name|float
name|getCpuUsagePercent
parameter_list|()
block|{
name|BigInteger
name|processTotalJiffies
init|=
name|getTotalProcessJiffies
argument_list|()
decl_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Process "
operator|+
name|pid
operator|+
literal|" jiffies:"
operator|+
name|processTotalJiffies
argument_list|)
expr_stmt|;
block|}
name|cpuTimeTracker
operator|.
name|updateElapsedJiffies
argument_list|(
name|processTotalJiffies
argument_list|,
name|clock
operator|.
name|getTime
argument_list|()
argument_list|)
expr_stmt|;
return|return
name|cpuTimeTracker
operator|.
name|getCpuTrackerUsagePercent
argument_list|()
return|;
block|}
DECL|method|getValidPID (String pid)
specifier|private
specifier|static
name|String
name|getValidPID
parameter_list|(
name|String
name|pid
parameter_list|)
block|{
if|if
condition|(
name|pid
operator|==
literal|null
condition|)
return|return
name|deadPid
return|;
name|Matcher
name|m
init|=
name|numberPattern
operator|.
name|matcher
argument_list|(
name|pid
argument_list|)
decl_stmt|;
if|if
condition|(
name|m
operator|.
name|matches
argument_list|()
condition|)
return|return
name|pid
return|;
return|return
name|deadPid
return|;
block|}
comment|/**    * Get the list of all processes in the system.    */
DECL|method|getProcessList ()
specifier|private
name|List
argument_list|<
name|String
argument_list|>
name|getProcessList
parameter_list|()
block|{
name|List
argument_list|<
name|String
argument_list|>
name|processList
init|=
name|Collections
operator|.
name|emptyList
argument_list|()
decl_stmt|;
name|FileFilter
name|procListFileFilter
init|=
operator|new
name|AndFileFilter
argument_list|(
name|DirectoryFileFilter
operator|.
name|INSTANCE
argument_list|,
operator|new
name|RegexFileFilter
argument_list|(
name|numberPattern
argument_list|)
argument_list|)
decl_stmt|;
name|File
name|dir
init|=
operator|new
name|File
argument_list|(
name|procfsDir
argument_list|)
decl_stmt|;
name|File
index|[]
name|processDirs
init|=
name|dir
operator|.
name|listFiles
argument_list|(
name|procListFileFilter
argument_list|)
decl_stmt|;
if|if
condition|(
name|ArrayUtils
operator|.
name|isNotEmpty
argument_list|(
name|processDirs
argument_list|)
condition|)
block|{
name|processList
operator|=
operator|new
name|ArrayList
argument_list|<
name|String
argument_list|>
argument_list|(
name|processDirs
operator|.
name|length
argument_list|)
expr_stmt|;
for|for
control|(
name|File
name|processDir
range|:
name|processDirs
control|)
block|{
name|processList
operator|.
name|add
argument_list|(
name|processDir
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|processList
return|;
block|}
comment|/**    * Construct the ProcessInfo using the process' PID and procfs rooted at the    * specified directory and return the same. It is provided mainly to assist    * testing purposes.    *    * Returns null on failing to read from procfs,    *    * @param pinfo ProcessInfo that needs to be updated    * @param procfsDir root of the proc file system    * @return updated ProcessInfo, null on errors.    */
DECL|method|constructProcessInfo (ProcessInfo pinfo, String procfsDir)
specifier|private
specifier|static
name|ProcessInfo
name|constructProcessInfo
parameter_list|(
name|ProcessInfo
name|pinfo
parameter_list|,
name|String
name|procfsDir
parameter_list|)
block|{
name|ProcessInfo
name|ret
init|=
literal|null
decl_stmt|;
comment|// Read "procfsDir/<pid>/stat" file - typically /proc/<pid>/stat
name|BufferedReader
name|in
init|=
literal|null
decl_stmt|;
name|InputStreamReader
name|fReader
init|=
literal|null
decl_stmt|;
try|try
block|{
name|File
name|pidDir
init|=
operator|new
name|File
argument_list|(
name|procfsDir
argument_list|,
name|pinfo
operator|.
name|getPid
argument_list|()
argument_list|)
decl_stmt|;
name|fReader
operator|=
operator|new
name|InputStreamReader
argument_list|(
operator|new
name|FileInputStream
argument_list|(
operator|new
name|File
argument_list|(
name|pidDir
argument_list|,
name|PROCFS_STAT_FILE
argument_list|)
argument_list|)
argument_list|,
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
expr_stmt|;
name|in
operator|=
operator|new
name|BufferedReader
argument_list|(
name|fReader
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|FileNotFoundException
name|f
parameter_list|)
block|{
comment|// The process vanished in the interim!
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|pinfo
expr_stmt|;
try|try
block|{
name|String
name|str
init|=
name|in
operator|.
name|readLine
argument_list|()
decl_stmt|;
comment|// only one line
name|Matcher
name|m
init|=
name|PROCFS_STAT_FILE_FORMAT
operator|.
name|matcher
argument_list|(
name|str
argument_list|)
decl_stmt|;
name|boolean
name|mat
init|=
name|m
operator|.
name|find
argument_list|()
decl_stmt|;
if|if
condition|(
name|mat
condition|)
block|{
name|String
name|processName
init|=
literal|"("
operator|+
name|m
operator|.
name|group
argument_list|(
literal|2
argument_list|)
operator|+
literal|")"
decl_stmt|;
comment|// Set (name) (ppid) (pgrpId) (session) (utime) (stime) (vsize) (rss)
name|pinfo
operator|.
name|updateProcessInfo
argument_list|(
name|processName
argument_list|,
name|m
operator|.
name|group
argument_list|(
literal|3
argument_list|)
argument_list|,
name|Integer
operator|.
name|parseInt
argument_list|(
name|m
operator|.
name|group
argument_list|(
literal|4
argument_list|)
argument_list|)
argument_list|,
name|Integer
operator|.
name|parseInt
argument_list|(
name|m
operator|.
name|group
argument_list|(
literal|5
argument_list|)
argument_list|)
argument_list|,
name|Long
operator|.
name|parseLong
argument_list|(
name|m
operator|.
name|group
argument_list|(
literal|7
argument_list|)
argument_list|)
argument_list|,
operator|new
name|BigInteger
argument_list|(
name|m
operator|.
name|group
argument_list|(
literal|8
argument_list|)
argument_list|)
argument_list|,
name|Long
operator|.
name|parseLong
argument_list|(
name|m
operator|.
name|group
argument_list|(
literal|10
argument_list|)
argument_list|)
argument_list|,
name|Long
operator|.
name|parseLong
argument_list|(
name|m
operator|.
name|group
argument_list|(
literal|11
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Unexpected: procfs stat file is not in the expected format"
operator|+
literal|" for process with pid "
operator|+
name|pinfo
operator|.
name|getPid
argument_list|()
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|null
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|IOException
name|io
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Error reading the stream"
argument_list|,
name|io
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|null
expr_stmt|;
block|}
finally|finally
block|{
comment|// Close the streams
try|try
block|{
name|fReader
operator|.
name|close
argument_list|()
expr_stmt|;
try|try
block|{
name|in
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|i
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Error closing the stream"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|IOException
name|i
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Error closing the stream"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|ret
return|;
block|}
comment|/**    * Returns a string printing PIDs of process present in the    * ProcfsBasedProcessTree. Output format : [pid pid ..]    */
annotation|@
name|Override
DECL|method|toString ()
specifier|public
name|String
name|toString
parameter_list|()
block|{
name|StringBuffer
name|pTree
init|=
operator|new
name|StringBuffer
argument_list|(
literal|"[ "
argument_list|)
decl_stmt|;
for|for
control|(
name|String
name|p
range|:
name|processTree
operator|.
name|keySet
argument_list|()
control|)
block|{
name|pTree
operator|.
name|append
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|pTree
operator|.
name|append
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
block|}
return|return
name|pTree
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
name|pTree
operator|.
name|length
argument_list|()
argument_list|)
operator|+
literal|"]"
return|;
block|}
comment|/**  * Returns boolean indicating whether pid  * is in process tree.  */
DECL|method|contains (String pid)
specifier|public
name|boolean
name|contains
parameter_list|(
name|String
name|pid
parameter_list|)
block|{
return|return
name|processTree
operator|.
name|containsKey
argument_list|(
name|pid
argument_list|)
return|;
block|}
comment|/**    *    * Class containing information of a process.    *    */
DECL|class|ProcessInfo
specifier|private
specifier|static
class|class
name|ProcessInfo
block|{
DECL|field|pid
specifier|private
name|String
name|pid
decl_stmt|;
comment|// process-id
DECL|field|name
specifier|private
name|String
name|name
decl_stmt|;
comment|// command name
DECL|field|pgrpId
specifier|private
name|Integer
name|pgrpId
decl_stmt|;
comment|// process group-id
DECL|field|ppid
specifier|private
name|String
name|ppid
decl_stmt|;
comment|// parent process-id
DECL|field|sessionId
specifier|private
name|Integer
name|sessionId
decl_stmt|;
comment|// session-id
DECL|field|vmem
specifier|private
name|Long
name|vmem
decl_stmt|;
comment|// virtual memory usage
DECL|field|rssmemPage
specifier|private
name|Long
name|rssmemPage
decl_stmt|;
comment|// rss memory usage in # of pages
DECL|field|utime
specifier|private
name|Long
name|utime
init|=
literal|0L
decl_stmt|;
comment|// # of jiffies in user mode
DECL|field|MAX_LONG
specifier|private
specifier|final
name|BigInteger
name|MAX_LONG
init|=
name|BigInteger
operator|.
name|valueOf
argument_list|(
name|Long
operator|.
name|MAX_VALUE
argument_list|)
decl_stmt|;
DECL|field|stime
specifier|private
name|BigInteger
name|stime
init|=
operator|new
name|BigInteger
argument_list|(
literal|"0"
argument_list|)
decl_stmt|;
comment|// # of jiffies in kernel mode
comment|// how many times has this process been seen alive
DECL|field|age
specifier|private
name|int
name|age
decl_stmt|;
comment|// # of jiffies used since last update:
DECL|field|dtime
specifier|private
name|Long
name|dtime
init|=
literal|0L
decl_stmt|;
comment|// dtime = (utime + stime) - (utimeOld + stimeOld)
comment|// We need this to compute the cumulative CPU time
comment|// because the subprocess may finish earlier than root process
DECL|field|children
specifier|private
name|List
argument_list|<
name|ProcessInfo
argument_list|>
name|children
init|=
operator|new
name|ArrayList
argument_list|<
name|ProcessInfo
argument_list|>
argument_list|()
decl_stmt|;
comment|// list of children
DECL|method|ProcessInfo (String pid)
specifier|public
name|ProcessInfo
parameter_list|(
name|String
name|pid
parameter_list|)
block|{
name|this
operator|.
name|pid
operator|=
name|pid
expr_stmt|;
comment|// seeing this the first time.
name|this
operator|.
name|age
operator|=
literal|1
expr_stmt|;
block|}
DECL|method|getPid ()
specifier|public
name|String
name|getPid
parameter_list|()
block|{
return|return
name|pid
return|;
block|}
DECL|method|getName ()
specifier|public
name|String
name|getName
parameter_list|()
block|{
return|return
name|name
return|;
block|}
DECL|method|getPgrpId ()
specifier|public
name|Integer
name|getPgrpId
parameter_list|()
block|{
return|return
name|pgrpId
return|;
block|}
DECL|method|getPpid ()
specifier|public
name|String
name|getPpid
parameter_list|()
block|{
return|return
name|ppid
return|;
block|}
DECL|method|getSessionId ()
specifier|public
name|Integer
name|getSessionId
parameter_list|()
block|{
return|return
name|sessionId
return|;
block|}
DECL|method|getVmem ()
specifier|public
name|Long
name|getVmem
parameter_list|()
block|{
return|return
name|vmem
return|;
block|}
DECL|method|getUtime ()
specifier|public
name|Long
name|getUtime
parameter_list|()
block|{
return|return
name|utime
return|;
block|}
DECL|method|getStime ()
specifier|public
name|BigInteger
name|getStime
parameter_list|()
block|{
return|return
name|stime
return|;
block|}
DECL|method|getDtime ()
specifier|public
name|Long
name|getDtime
parameter_list|()
block|{
return|return
name|dtime
return|;
block|}
DECL|method|getRssmemPage ()
specifier|public
name|Long
name|getRssmemPage
parameter_list|()
block|{
comment|// get rss # of pages
return|return
name|rssmemPage
return|;
block|}
DECL|method|getAge ()
specifier|public
name|int
name|getAge
parameter_list|()
block|{
return|return
name|age
return|;
block|}
DECL|method|updateProcessInfo (String name, String ppid, Integer pgrpId, Integer sessionId, Long utime, BigInteger stime, Long vmem, Long rssmem)
specifier|public
name|void
name|updateProcessInfo
parameter_list|(
name|String
name|name
parameter_list|,
name|String
name|ppid
parameter_list|,
name|Integer
name|pgrpId
parameter_list|,
name|Integer
name|sessionId
parameter_list|,
name|Long
name|utime
parameter_list|,
name|BigInteger
name|stime
parameter_list|,
name|Long
name|vmem
parameter_list|,
name|Long
name|rssmem
parameter_list|)
block|{
name|this
operator|.
name|name
operator|=
name|name
expr_stmt|;
name|this
operator|.
name|ppid
operator|=
name|ppid
expr_stmt|;
name|this
operator|.
name|pgrpId
operator|=
name|pgrpId
expr_stmt|;
name|this
operator|.
name|sessionId
operator|=
name|sessionId
expr_stmt|;
name|this
operator|.
name|utime
operator|=
name|utime
expr_stmt|;
name|this
operator|.
name|stime
operator|=
name|stime
expr_stmt|;
name|this
operator|.
name|vmem
operator|=
name|vmem
expr_stmt|;
name|this
operator|.
name|rssmemPage
operator|=
name|rssmem
expr_stmt|;
block|}
DECL|method|updateJiffy (ProcessInfo oldInfo)
specifier|public
name|void
name|updateJiffy
parameter_list|(
name|ProcessInfo
name|oldInfo
parameter_list|)
block|{
if|if
condition|(
name|oldInfo
operator|==
literal|null
condition|)
block|{
name|BigInteger
name|sum
init|=
name|this
operator|.
name|stime
operator|.
name|add
argument_list|(
name|BigInteger
operator|.
name|valueOf
argument_list|(
name|this
operator|.
name|utime
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|sum
operator|.
name|compareTo
argument_list|(
name|MAX_LONG
argument_list|)
operator|>
literal|0
condition|)
block|{
name|this
operator|.
name|dtime
operator|=
literal|0L
expr_stmt|;
name|LOG
operator|.
name|warn
argument_list|(
literal|"Sum of stime ("
operator|+
name|this
operator|.
name|stime
operator|+
literal|") and utime ("
operator|+
name|this
operator|.
name|utime
operator|+
literal|") is greater than "
operator|+
name|Long
operator|.
name|MAX_VALUE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|dtime
operator|=
name|sum
operator|.
name|longValue
argument_list|()
expr_stmt|;
block|}
return|return;
block|}
name|this
operator|.
name|dtime
operator|=
operator|(
name|this
operator|.
name|utime
operator|-
name|oldInfo
operator|.
name|utime
operator|+
name|this
operator|.
name|stime
operator|.
name|subtract
argument_list|(
name|oldInfo
operator|.
name|stime
argument_list|)
operator|.
name|longValue
argument_list|()
operator|)
expr_stmt|;
block|}
DECL|method|updateAge (ProcessInfo oldInfo)
specifier|public
name|void
name|updateAge
parameter_list|(
name|ProcessInfo
name|oldInfo
parameter_list|)
block|{
name|this
operator|.
name|age
operator|=
name|oldInfo
operator|.
name|age
operator|+
literal|1
expr_stmt|;
block|}
DECL|method|addChild (ProcessInfo p)
specifier|public
name|boolean
name|addChild
parameter_list|(
name|ProcessInfo
name|p
parameter_list|)
block|{
return|return
name|children
operator|.
name|add
argument_list|(
name|p
argument_list|)
return|;
block|}
DECL|method|getChildren ()
specifier|public
name|List
argument_list|<
name|ProcessInfo
argument_list|>
name|getChildren
parameter_list|()
block|{
return|return
name|children
return|;
block|}
DECL|method|getCmdLine (String procfsDir)
specifier|public
name|String
name|getCmdLine
parameter_list|(
name|String
name|procfsDir
parameter_list|)
block|{
name|String
name|ret
init|=
literal|"N/A"
decl_stmt|;
if|if
condition|(
name|pid
operator|==
literal|null
condition|)
block|{
return|return
name|ret
return|;
block|}
name|BufferedReader
name|in
init|=
literal|null
decl_stmt|;
name|InputStreamReader
name|fReader
init|=
literal|null
decl_stmt|;
try|try
block|{
name|fReader
operator|=
operator|new
name|InputStreamReader
argument_list|(
operator|new
name|FileInputStream
argument_list|(
operator|new
name|File
argument_list|(
operator|new
name|File
argument_list|(
name|procfsDir
argument_list|,
name|pid
operator|.
name|toString
argument_list|()
argument_list|)
argument_list|,
name|PROCFS_CMDLINE_FILE
argument_list|)
argument_list|)
argument_list|,
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|FileNotFoundException
name|f
parameter_list|)
block|{
comment|// The process vanished in the interim!
return|return
name|ret
return|;
block|}
name|in
operator|=
operator|new
name|BufferedReader
argument_list|(
name|fReader
argument_list|)
expr_stmt|;
try|try
block|{
name|ret
operator|=
name|in
operator|.
name|readLine
argument_list|()
expr_stmt|;
comment|// only one line
if|if
condition|(
name|ret
operator|==
literal|null
condition|)
block|{
name|ret
operator|=
literal|"N/A"
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|ret
operator|.
name|replace
argument_list|(
literal|'\0'
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
comment|// Replace each null char with a space
if|if
condition|(
name|ret
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
comment|// The cmdline might be empty because the process is swapped out or
comment|// is a zombie.
name|ret
operator|=
literal|"N/A"
expr_stmt|;
block|}
block|}
block|}
catch|catch
parameter_list|(
name|IOException
name|io
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Error reading the stream"
argument_list|,
name|io
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|"N/A"
expr_stmt|;
block|}
finally|finally
block|{
comment|// Close the streams
try|try
block|{
name|fReader
operator|.
name|close
argument_list|()
expr_stmt|;
try|try
block|{
name|in
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|i
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Error closing the stream"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|IOException
name|i
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Error closing the stream"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|ret
return|;
block|}
block|}
comment|/**    * Update memory related information    *    * @param pInfo    * @param procfsDir    */
DECL|method|constructProcessSMAPInfo (ProcessTreeSmapMemInfo pInfo, String procfsDir)
specifier|private
specifier|static
name|void
name|constructProcessSMAPInfo
parameter_list|(
name|ProcessTreeSmapMemInfo
name|pInfo
parameter_list|,
name|String
name|procfsDir
parameter_list|)
block|{
name|BufferedReader
name|in
init|=
literal|null
decl_stmt|;
name|InputStreamReader
name|fReader
init|=
literal|null
decl_stmt|;
try|try
block|{
name|File
name|pidDir
init|=
operator|new
name|File
argument_list|(
name|procfsDir
argument_list|,
name|pInfo
operator|.
name|getPid
argument_list|()
argument_list|)
decl_stmt|;
name|File
name|file
init|=
operator|new
name|File
argument_list|(
name|pidDir
argument_list|,
name|SMAPS
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|file
operator|.
name|exists
argument_list|()
condition|)
block|{
return|return;
block|}
name|fReader
operator|=
operator|new
name|InputStreamReader
argument_list|(
operator|new
name|FileInputStream
argument_list|(
name|file
argument_list|)
argument_list|,
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
expr_stmt|;
name|in
operator|=
operator|new
name|BufferedReader
argument_list|(
name|fReader
argument_list|)
expr_stmt|;
name|ProcessSmapMemoryInfo
name|memoryMappingInfo
init|=
literal|null
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|lines
init|=
name|IOUtils
operator|.
name|readLines
argument_list|(
name|in
argument_list|)
decl_stmt|;
for|for
control|(
name|String
name|line
range|:
name|lines
control|)
block|{
name|line
operator|=
name|line
operator|.
name|trim
argument_list|()
expr_stmt|;
try|try
block|{
name|Matcher
name|address
init|=
name|ADDRESS_PATTERN
operator|.
name|matcher
argument_list|(
name|line
argument_list|)
decl_stmt|;
if|if
condition|(
name|address
operator|.
name|find
argument_list|()
condition|)
block|{
name|memoryMappingInfo
operator|=
operator|new
name|ProcessSmapMemoryInfo
argument_list|(
name|line
argument_list|)
expr_stmt|;
name|memoryMappingInfo
operator|.
name|setPermission
argument_list|(
name|address
operator|.
name|group
argument_list|(
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|pInfo
operator|.
name|getMemoryInfoList
argument_list|()
operator|.
name|add
argument_list|(
name|memoryMappingInfo
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|Matcher
name|memInfo
init|=
name|MEM_INFO_PATTERN
operator|.
name|matcher
argument_list|(
name|line
argument_list|)
decl_stmt|;
if|if
condition|(
name|memInfo
operator|.
name|find
argument_list|()
condition|)
block|{
name|String
name|key
init|=
name|memInfo
operator|.
name|group
argument_list|(
literal|1
argument_list|)
operator|.
name|trim
argument_list|()
decl_stmt|;
name|String
name|value
init|=
name|memInfo
operator|.
name|group
argument_list|(
literal|2
argument_list|)
operator|.
name|replace
argument_list|(
name|KB
argument_list|,
literal|""
argument_list|)
operator|.
name|trim
argument_list|()
decl_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"MemInfo : "
operator|+
name|key
operator|+
literal|" : Value  : "
operator|+
name|value
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|memoryMappingInfo
operator|!=
literal|null
condition|)
block|{
name|memoryMappingInfo
operator|.
name|setMemInfo
argument_list|(
name|key
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
block|}
block|}
catch|catch
parameter_list|(
name|Throwable
name|t
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Error parsing smaps line : "
operator|+
name|line
operator|+
literal|"; "
operator|+
name|t
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
block|}
catch|catch
parameter_list|(
name|FileNotFoundException
name|f
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
name|e
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|t
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
name|t
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|IOUtils
operator|.
name|closeQuietly
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**    * Placeholder for process's SMAPS information    */
DECL|class|ProcessTreeSmapMemInfo
specifier|static
class|class
name|ProcessTreeSmapMemInfo
block|{
DECL|field|pid
specifier|private
name|String
name|pid
decl_stmt|;
DECL|field|memoryInfoList
specifier|private
name|List
argument_list|<
name|ProcessSmapMemoryInfo
argument_list|>
name|memoryInfoList
decl_stmt|;
DECL|method|ProcessTreeSmapMemInfo (String pid)
specifier|public
name|ProcessTreeSmapMemInfo
parameter_list|(
name|String
name|pid
parameter_list|)
block|{
name|this
operator|.
name|pid
operator|=
name|pid
expr_stmt|;
name|this
operator|.
name|memoryInfoList
operator|=
operator|new
name|LinkedList
argument_list|<
name|ProcessSmapMemoryInfo
argument_list|>
argument_list|()
expr_stmt|;
block|}
DECL|method|getMemoryInfoList ()
specifier|public
name|List
argument_list|<
name|ProcessSmapMemoryInfo
argument_list|>
name|getMemoryInfoList
parameter_list|()
block|{
return|return
name|memoryInfoList
return|;
block|}
DECL|method|getPid ()
specifier|public
name|String
name|getPid
parameter_list|()
block|{
return|return
name|pid
return|;
block|}
DECL|method|toString ()
specifier|public
name|String
name|toString
parameter_list|()
block|{
name|StringBuilder
name|sb
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
for|for
control|(
name|ProcessSmapMemoryInfo
name|info
range|:
name|memoryInfoList
control|)
block|{
name|sb
operator|.
name|append
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|sb
operator|.
name|append
argument_list|(
name|info
argument_list|)
expr_stmt|;
block|}
return|return
name|sb
operator|.
name|toString
argument_list|()
return|;
block|}
block|}
comment|/**    *<pre>    * Private Pages : Pages that were mapped only by the process    * Shared Pages : Pages that were shared with other processes    *    * Clean Pages : Pages that have not been modified since they were mapped    * Dirty Pages : Pages that have been modified since they were mapped    *    * Private RSS = Private Clean Pages + Private Dirty Pages    * Shared RSS = Shared Clean Pages + Shared Dirty Pages    * RSS = Private RSS + Shared RSS    * PSS = The count of all pages mapped uniquely by the process,     *  plus a fraction of each shared page, said fraction to be     *  proportional to the number of processes which have mapped the page.    *     *</pre>    */
DECL|class|ProcessSmapMemoryInfo
specifier|static
class|class
name|ProcessSmapMemoryInfo
block|{
DECL|field|size
specifier|private
name|int
name|size
decl_stmt|;
DECL|field|rss
specifier|private
name|int
name|rss
decl_stmt|;
DECL|field|pss
specifier|private
name|int
name|pss
decl_stmt|;
DECL|field|sharedClean
specifier|private
name|int
name|sharedClean
decl_stmt|;
DECL|field|sharedDirty
specifier|private
name|int
name|sharedDirty
decl_stmt|;
DECL|field|privateClean
specifier|private
name|int
name|privateClean
decl_stmt|;
DECL|field|privateDirty
specifier|private
name|int
name|privateDirty
decl_stmt|;
DECL|field|anonymous
specifier|private
name|int
name|anonymous
decl_stmt|;
DECL|field|referenced
specifier|private
name|int
name|referenced
decl_stmt|;
DECL|field|regionName
specifier|private
name|String
name|regionName
decl_stmt|;
DECL|field|permission
specifier|private
name|String
name|permission
decl_stmt|;
DECL|method|ProcessSmapMemoryInfo (String name)
specifier|public
name|ProcessSmapMemoryInfo
parameter_list|(
name|String
name|name
parameter_list|)
block|{
name|this
operator|.
name|regionName
operator|=
name|name
expr_stmt|;
block|}
DECL|method|getName ()
specifier|public
name|String
name|getName
parameter_list|()
block|{
return|return
name|regionName
return|;
block|}
DECL|method|setPermission (String permission)
specifier|public
name|void
name|setPermission
parameter_list|(
name|String
name|permission
parameter_list|)
block|{
name|this
operator|.
name|permission
operator|=
name|permission
expr_stmt|;
block|}
DECL|method|getPermission ()
specifier|public
name|String
name|getPermission
parameter_list|()
block|{
return|return
name|permission
return|;
block|}
DECL|method|getSize ()
specifier|public
name|int
name|getSize
parameter_list|()
block|{
return|return
name|size
return|;
block|}
DECL|method|getRss ()
specifier|public
name|int
name|getRss
parameter_list|()
block|{
return|return
name|rss
return|;
block|}
DECL|method|getPss ()
specifier|public
name|int
name|getPss
parameter_list|()
block|{
return|return
name|pss
return|;
block|}
DECL|method|getSharedClean ()
specifier|public
name|int
name|getSharedClean
parameter_list|()
block|{
return|return
name|sharedClean
return|;
block|}
DECL|method|getSharedDirty ()
specifier|public
name|int
name|getSharedDirty
parameter_list|()
block|{
return|return
name|sharedDirty
return|;
block|}
DECL|method|getPrivateClean ()
specifier|public
name|int
name|getPrivateClean
parameter_list|()
block|{
return|return
name|privateClean
return|;
block|}
DECL|method|getPrivateDirty ()
specifier|public
name|int
name|getPrivateDirty
parameter_list|()
block|{
return|return
name|privateDirty
return|;
block|}
DECL|method|getReferenced ()
specifier|public
name|int
name|getReferenced
parameter_list|()
block|{
return|return
name|referenced
return|;
block|}
DECL|method|getAnonymous ()
specifier|public
name|int
name|getAnonymous
parameter_list|()
block|{
return|return
name|anonymous
return|;
block|}
DECL|method|setMemInfo (String key, String value)
specifier|public
name|void
name|setMemInfo
parameter_list|(
name|String
name|key
parameter_list|,
name|String
name|value
parameter_list|)
block|{
name|MemInfo
name|info
init|=
name|MemInfo
operator|.
name|getMemInfoByName
argument_list|(
name|key
argument_list|)
decl_stmt|;
name|int
name|val
init|=
literal|0
decl_stmt|;
try|try
block|{
name|val
operator|=
name|Integer
operator|.
name|parseInt
argument_list|(
name|value
operator|.
name|trim
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|NumberFormatException
name|ne
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Error in parsing : "
operator|+
name|info
operator|+
literal|" : value"
operator|+
name|value
operator|.
name|trim
argument_list|()
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|info
operator|==
literal|null
condition|)
block|{
return|return;
block|}
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"setMemInfo : memInfo : "
operator|+
name|info
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|info
condition|)
block|{
case|case
name|SIZE
case|:
name|size
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|RSS
case|:
name|rss
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|PSS
case|:
name|pss
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|SHARED_CLEAN
case|:
name|sharedClean
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|SHARED_DIRTY
case|:
name|sharedDirty
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|PRIVATE_CLEAN
case|:
name|privateClean
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|PRIVATE_DIRTY
case|:
name|privateDirty
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|REFERENCED
case|:
name|referenced
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|ANONYMOUS
case|:
name|anonymous
operator|=
name|val
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
DECL|method|toString ()
specifier|public
name|String
name|toString
parameter_list|()
block|{
name|StringBuilder
name|sb
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|sb
operator|.
name|append
argument_list|(
literal|"\t"
argument_list|)
operator|.
name|append
argument_list|(
name|this
operator|.
name|getName
argument_list|()
argument_list|)
operator|.
name|append
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|sb
operator|.
name|append
argument_list|(
literal|"\t"
argument_list|)
operator|.
name|append
argument_list|(
name|MemInfo
operator|.
name|SIZE
operator|.
name|name
operator|+
literal|":"
operator|+
name|this
operator|.
name|getSize
argument_list|()
argument_list|)
operator|.
name|append
argument_list|(
literal|" kB\n"
argument_list|)
expr_stmt|;
name|sb
operator|.
name|append
argument_list|(
literal|"\t"
argument_list|)
operator|.
name|append
argument_list|(
name|MemInfo
operator|.
name|PSS
operator|.
name|name
operator|+
literal|":"
operator|+
name|this
operator|.
name|getPss
argument_list|()
argument_list|)
operator|.
name|append
argument_list|(
literal|" kB\n"
argument_list|)
expr_stmt|;
name|sb
operator|.
name|append
argument_list|(
literal|"\t"
argument_list|)
operator|.
name|append
argument_list|(
name|MemInfo
operator|.
name|RSS
operator|.
name|name
operator|+
literal|":"
operator|+
name|this
operator|.
name|getRss
argument_list|()
argument_list|)
operator|.
name|append
argument_list|(
literal|" kB\n"
argument_list|)
expr_stmt|;
name|sb
operator|.
name|append
argument_list|(
literal|"\t"
argument_list|)
operator|.
name|append
argument_list|(
name|MemInfo
operator|.
name|SHARED_CLEAN
operator|.
name|name
operator|+
literal|":"
operator|+
name|this
operator|.
name|getSharedClean
argument_list|()
argument_list|)
operator|.
name|append
argument_list|(
literal|" kB\n"
argument_list|)
expr_stmt|;
name|sb
operator|.
name|append
argument_list|(
literal|"\t"
argument_list|)
operator|.
name|append
argument_list|(
name|MemInfo
operator|.
name|SHARED_DIRTY
operator|.
name|name
operator|+
literal|":"
operator|+
name|this
operator|.
name|getSharedDirty
argument_list|()
argument_list|)
operator|.
name|append
argument_list|(
literal|" kB\n"
argument_list|)
expr_stmt|;
name|sb
operator|.
name|append
argument_list|(
literal|"\t"
argument_list|)
operator|.
name|append
argument_list|(
name|MemInfo
operator|.
name|PRIVATE_CLEAN
operator|.
name|name
operator|+
literal|":"
operator|+
name|this
operator|.
name|getPrivateClean
argument_list|()
argument_list|)
operator|.
name|append
argument_list|(
literal|" kB\n"
argument_list|)
expr_stmt|;
name|sb
operator|.
name|append
argument_list|(
literal|"\t"
argument_list|)
operator|.
name|append
argument_list|(
name|MemInfo
operator|.
name|PRIVATE_DIRTY
operator|.
name|name
operator|+
literal|":"
operator|+
name|this
operator|.
name|getPrivateDirty
argument_list|()
argument_list|)
operator|.
name|append
argument_list|(
literal|" kB\n"
argument_list|)
expr_stmt|;
name|sb
operator|.
name|append
argument_list|(
literal|"\t"
argument_list|)
operator|.
name|append
argument_list|(
name|MemInfo
operator|.
name|REFERENCED
operator|.
name|name
operator|+
literal|":"
operator|+
name|this
operator|.
name|getReferenced
argument_list|()
argument_list|)
operator|.
name|append
argument_list|(
literal|" kB\n"
argument_list|)
expr_stmt|;
name|sb
operator|.
name|append
argument_list|(
literal|"\t"
argument_list|)
operator|.
name|append
argument_list|(
name|MemInfo
operator|.
name|ANONYMOUS
operator|.
name|name
operator|+
literal|":"
operator|+
name|this
operator|.
name|getAnonymous
argument_list|()
argument_list|)
operator|.
name|append
argument_list|(
literal|" kB\n"
argument_list|)
expr_stmt|;
return|return
name|sb
operator|.
name|toString
argument_list|()
return|;
block|}
block|}
comment|/**    * Test the {@link ProcfsBasedProcessTree}    *    * @param args    */
DECL|method|main (String[] args)
specifier|public
specifier|static
name|void
name|main
parameter_list|(
name|String
index|[]
name|args
parameter_list|)
block|{
if|if
condition|(
name|args
operator|.
name|length
operator|!=
literal|1
condition|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Provide<pid of process to monitor>"
argument_list|)
expr_stmt|;
return|return;
block|}
name|int
name|numprocessors
init|=
name|ResourceCalculatorPlugin
operator|.
name|getResourceCalculatorPlugin
argument_list|(
literal|null
argument_list|,
literal|null
argument_list|)
operator|.
name|getNumProcessors
argument_list|()
decl_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Number of processors "
operator|+
name|numprocessors
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Creating ProcfsBasedProcessTree for process "
operator|+
name|args
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|ProcfsBasedProcessTree
name|procfsBasedProcessTree
init|=
operator|new
name|ProcfsBasedProcessTree
argument_list|(
name|args
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|procfsBasedProcessTree
operator|.
name|updateProcessTree
argument_list|()
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|procfsBasedProcessTree
operator|.
name|getProcessTreeDump
argument_list|()
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Get cpu usage "
operator|+
name|procfsBasedProcessTree
operator|.
name|getCpuUsagePercent
argument_list|()
argument_list|)
expr_stmt|;
try|try
block|{
comment|// Sleep so we can compute the CPU usage
name|Thread
operator|.
name|sleep
argument_list|(
literal|500L
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|e
parameter_list|)
block|{
comment|// do nothing
block|}
name|procfsBasedProcessTree
operator|.
name|updateProcessTree
argument_list|()
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|procfsBasedProcessTree
operator|.
name|getProcessTreeDump
argument_list|()
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Cpu usage  "
operator|+
name|procfsBasedProcessTree
operator|.
name|getCpuUsagePercent
argument_list|()
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Vmem usage in bytes "
operator|+
name|procfsBasedProcessTree
operator|.
name|getVirtualMemorySize
argument_list|()
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Rss mem usage in bytes "
operator|+
name|procfsBasedProcessTree
operator|.
name|getRssMemorySize
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
end_class

end_unit

