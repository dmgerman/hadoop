begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/**  * Licensed to the Apache Software Foundation (ASF) under one  * or more contributor license agreements.  See the NOTICE file  * distributed with this work for additional information  * regarding copyright ownership.  The ASF licenses this file  * to you under the Apache License, Version 2.0 (the  * "License"); you may not use this file except in compliance  * with the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
DECL|package|org.apache.hadoop.yarn.client.api.impl
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|client
operator|.
name|api
operator|.
name|impl
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|File
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|lang
operator|.
name|reflect
operator|.
name|UndeclaredThrowableException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|ConnectException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|HttpURLConnection
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|InetSocketAddress
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|SocketTimeoutException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URI
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URL
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URLConnection
import|;
end_import

begin_import
import|import
name|java
operator|.
name|security
operator|.
name|GeneralSecurityException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|security
operator|.
name|PrivilegedExceptionAction
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|BlockingQueue
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|Callable
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ExecutionException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ExecutorService
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|Executors
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|FutureTask
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|LinkedBlockingQueue
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|TimeUnit
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|net
operator|.
name|ssl
operator|.
name|HostnameVerifier
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|net
operator|.
name|ssl
operator|.
name|HttpsURLConnection
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|net
operator|.
name|ssl
operator|.
name|SSLSocketFactory
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|ws
operator|.
name|rs
operator|.
name|core
operator|.
name|MediaType
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|ws
operator|.
name|rs
operator|.
name|core
operator|.
name|MultivaluedMap
import|;
end_import

begin_import
import|import
name|com
operator|.
name|fasterxml
operator|.
name|jackson
operator|.
name|databind
operator|.
name|ObjectMapper
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|cli
operator|.
name|CommandLine
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|cli
operator|.
name|GnuParser
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|cli
operator|.
name|HelpFormatter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|cli
operator|.
name|Options
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|Log
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|LogFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|classification
operator|.
name|InterfaceAudience
operator|.
name|Private
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|classification
operator|.
name|InterfaceStability
operator|.
name|Evolving
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|conf
operator|.
name|Configuration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|SecurityUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|UserGroupInformation
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|authentication
operator|.
name|client
operator|.
name|AuthenticationException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|authentication
operator|.
name|client
operator|.
name|ConnectionConfigurator
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|ssl
operator|.
name|SSLFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|token
operator|.
name|Token
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|token
operator|.
name|delegation
operator|.
name|web
operator|.
name|DelegationTokenAuthenticatedURL
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|token
operator|.
name|delegation
operator|.
name|web
operator|.
name|DelegationTokenAuthenticator
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|token
operator|.
name|delegation
operator|.
name|web
operator|.
name|KerberosDelegationTokenAuthenticator
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|token
operator|.
name|delegation
operator|.
name|web
operator|.
name|PseudoDelegationTokenAuthenticator
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|ApplicationAttemptId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|ApplicationId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|timeline
operator|.
name|TimelineDomain
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|timeline
operator|.
name|TimelineDomains
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|timeline
operator|.
name|TimelineEntities
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|timeline
operator|.
name|TimelineEntity
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|timeline
operator|.
name|TimelineEntityGroupId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|timeline
operator|.
name|TimelinePutResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|client
operator|.
name|api
operator|.
name|TimelineClient
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|conf
operator|.
name|YarnConfiguration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|exceptions
operator|.
name|YarnException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|security
operator|.
name|client
operator|.
name|TimelineDelegationTokenIdentifier
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|webapp
operator|.
name|YarnJacksonJaxbJsonProvider
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|annotations
operator|.
name|VisibleForTesting
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|base
operator|.
name|Joiner
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|base
operator|.
name|Preconditions
import|;
end_import

begin_import
import|import
name|com
operator|.
name|sun
operator|.
name|jersey
operator|.
name|api
operator|.
name|client
operator|.
name|Client
import|;
end_import

begin_import
import|import
name|com
operator|.
name|sun
operator|.
name|jersey
operator|.
name|api
operator|.
name|client
operator|.
name|ClientHandlerException
import|;
end_import

begin_import
import|import
name|com
operator|.
name|sun
operator|.
name|jersey
operator|.
name|api
operator|.
name|client
operator|.
name|ClientRequest
import|;
end_import

begin_import
import|import
name|com
operator|.
name|sun
operator|.
name|jersey
operator|.
name|api
operator|.
name|client
operator|.
name|ClientResponse
import|;
end_import

begin_import
import|import
name|com
operator|.
name|sun
operator|.
name|jersey
operator|.
name|api
operator|.
name|client
operator|.
name|config
operator|.
name|ClientConfig
import|;
end_import

begin_import
import|import
name|com
operator|.
name|sun
operator|.
name|jersey
operator|.
name|api
operator|.
name|client
operator|.
name|config
operator|.
name|DefaultClientConfig
import|;
end_import

begin_import
import|import
name|com
operator|.
name|sun
operator|.
name|jersey
operator|.
name|api
operator|.
name|client
operator|.
name|filter
operator|.
name|ClientFilter
import|;
end_import

begin_import
import|import
name|com
operator|.
name|sun
operator|.
name|jersey
operator|.
name|client
operator|.
name|urlconnection
operator|.
name|HttpURLConnectionFactory
import|;
end_import

begin_import
import|import
name|com
operator|.
name|sun
operator|.
name|jersey
operator|.
name|client
operator|.
name|urlconnection
operator|.
name|URLConnectionClientHandler
import|;
end_import

begin_import
import|import
name|com
operator|.
name|sun
operator|.
name|jersey
operator|.
name|core
operator|.
name|util
operator|.
name|MultivaluedMapImpl
import|;
end_import

begin_class
annotation|@
name|Private
annotation|@
name|Evolving
DECL|class|TimelineClientImpl
specifier|public
class|class
name|TimelineClientImpl
extends|extends
name|TimelineClient
block|{
DECL|field|LOG
specifier|private
specifier|static
specifier|final
name|Log
name|LOG
init|=
name|LogFactory
operator|.
name|getLog
argument_list|(
name|TimelineClientImpl
operator|.
name|class
argument_list|)
decl_stmt|;
DECL|field|MAPPER
specifier|private
specifier|static
specifier|final
name|ObjectMapper
name|MAPPER
init|=
operator|new
name|ObjectMapper
argument_list|()
decl_stmt|;
DECL|field|RESOURCE_URI_STR_V1
specifier|private
specifier|static
specifier|final
name|String
name|RESOURCE_URI_STR_V1
init|=
literal|"/ws/v1/timeline/"
decl_stmt|;
DECL|field|RESOURCE_URI_STR_V2
specifier|private
specifier|static
specifier|final
name|String
name|RESOURCE_URI_STR_V2
init|=
literal|"/ws/v2/timeline/"
decl_stmt|;
DECL|field|JOINER
specifier|private
specifier|static
specifier|final
name|Joiner
name|JOINER
init|=
name|Joiner
operator|.
name|on
argument_list|(
literal|""
argument_list|)
decl_stmt|;
DECL|field|DEFAULT_SOCKET_TIMEOUT
specifier|public
specifier|final
specifier|static
name|int
name|DEFAULT_SOCKET_TIMEOUT
init|=
literal|1
operator|*
literal|60
operator|*
literal|1000
decl_stmt|;
comment|// 1 minute
DECL|field|opts
specifier|private
specifier|static
name|Options
name|opts
decl_stmt|;
DECL|field|ENTITY_DATA_TYPE
specifier|private
specifier|static
specifier|final
name|String
name|ENTITY_DATA_TYPE
init|=
literal|"entity"
decl_stmt|;
DECL|field|DOMAIN_DATA_TYPE
specifier|private
specifier|static
specifier|final
name|String
name|DOMAIN_DATA_TYPE
init|=
literal|"domain"
decl_stmt|;
static|static
block|{
name|opts
operator|=
operator|new
name|Options
argument_list|()
expr_stmt|;
name|opts
operator|.
name|addOption
argument_list|(
literal|"put"
argument_list|,
literal|true
argument_list|,
literal|"Put the timeline entities/domain in a JSON file"
argument_list|)
expr_stmt|;
name|opts
operator|.
name|getOption
argument_list|(
literal|"put"
argument_list|)
operator|.
name|setArgName
argument_list|(
literal|"Path to the JSON file"
argument_list|)
expr_stmt|;
name|opts
operator|.
name|addOption
argument_list|(
name|ENTITY_DATA_TYPE
argument_list|,
literal|false
argument_list|,
literal|"Specify the JSON file contains the entities"
argument_list|)
expr_stmt|;
name|opts
operator|.
name|addOption
argument_list|(
name|DOMAIN_DATA_TYPE
argument_list|,
literal|false
argument_list|,
literal|"Specify the JSON file contains the domain"
argument_list|)
expr_stmt|;
name|opts
operator|.
name|addOption
argument_list|(
literal|"help"
argument_list|,
literal|false
argument_list|,
literal|"Print usage"
argument_list|)
expr_stmt|;
block|}
DECL|field|client
specifier|private
name|Client
name|client
decl_stmt|;
DECL|field|connConfigurator
specifier|private
name|ConnectionConfigurator
name|connConfigurator
decl_stmt|;
DECL|field|authenticator
specifier|private
name|DelegationTokenAuthenticator
name|authenticator
decl_stmt|;
DECL|field|token
specifier|private
name|DelegationTokenAuthenticatedURL
operator|.
name|Token
name|token
decl_stmt|;
DECL|field|authUgi
specifier|private
name|UserGroupInformation
name|authUgi
decl_stmt|;
DECL|field|doAsUser
specifier|private
name|String
name|doAsUser
decl_stmt|;
DECL|field|configuration
specifier|private
name|Configuration
name|configuration
decl_stmt|;
DECL|field|timelineServiceVersion
specifier|private
name|float
name|timelineServiceVersion
decl_stmt|;
DECL|field|timelineWriter
specifier|private
name|TimelineWriter
name|timelineWriter
decl_stmt|;
DECL|field|sslFactory
specifier|private
name|SSLFactory
name|sslFactory
decl_stmt|;
DECL|field|timelineServiceAddress
specifier|private
specifier|volatile
name|String
name|timelineServiceAddress
decl_stmt|;
comment|// Retry parameters for identifying new timeline service
comment|// TODO consider to merge with connection retry
DECL|field|maxServiceRetries
specifier|private
name|int
name|maxServiceRetries
decl_stmt|;
DECL|field|serviceRetryInterval
specifier|private
name|long
name|serviceRetryInterval
decl_stmt|;
DECL|field|timelineServiceV2
specifier|private
name|boolean
name|timelineServiceV2
init|=
literal|false
decl_stmt|;
annotation|@
name|Private
annotation|@
name|VisibleForTesting
DECL|field|connectionRetry
name|TimelineClientConnectionRetry
name|connectionRetry
decl_stmt|;
DECL|field|entityDispatcher
specifier|private
name|TimelineEntityDispatcher
name|entityDispatcher
decl_stmt|;
comment|// Abstract class for an operation that should be retried by timeline client
annotation|@
name|Private
annotation|@
name|VisibleForTesting
DECL|class|TimelineClientRetryOp
specifier|public
specifier|static
specifier|abstract
class|class
name|TimelineClientRetryOp
block|{
comment|// The operation that should be retried
DECL|method|run ()
specifier|public
specifier|abstract
name|Object
name|run
parameter_list|()
throws|throws
name|IOException
function_decl|;
comment|// The method to indicate if we should retry given the incoming exception
DECL|method|shouldRetryOn (Exception e)
specifier|public
specifier|abstract
name|boolean
name|shouldRetryOn
parameter_list|(
name|Exception
name|e
parameter_list|)
function_decl|;
block|}
comment|// Class to handle retry
comment|// Outside this class, only visible to tests
annotation|@
name|Private
annotation|@
name|VisibleForTesting
DECL|class|TimelineClientConnectionRetry
specifier|static
class|class
name|TimelineClientConnectionRetry
block|{
comment|// maxRetries< 0 means keep trying
annotation|@
name|Private
annotation|@
name|VisibleForTesting
DECL|field|maxRetries
specifier|public
name|int
name|maxRetries
decl_stmt|;
annotation|@
name|Private
annotation|@
name|VisibleForTesting
DECL|field|retryInterval
specifier|public
name|long
name|retryInterval
decl_stmt|;
comment|// Indicates if retries happened last time. Only tests should read it.
comment|// In unit tests, retryOn() calls should _not_ be concurrent.
DECL|field|retried
specifier|private
name|boolean
name|retried
init|=
literal|false
decl_stmt|;
annotation|@
name|Private
annotation|@
name|VisibleForTesting
DECL|method|getRetired ()
name|boolean
name|getRetired
parameter_list|()
block|{
return|return
name|retried
return|;
block|}
comment|// Constructor with default retry settings
DECL|method|TimelineClientConnectionRetry (Configuration conf)
specifier|public
name|TimelineClientConnectionRetry
parameter_list|(
name|Configuration
name|conf
parameter_list|)
block|{
name|Preconditions
operator|.
name|checkArgument
argument_list|(
name|conf
operator|.
name|getInt
argument_list|(
name|YarnConfiguration
operator|.
name|TIMELINE_SERVICE_CLIENT_MAX_RETRIES
argument_list|,
name|YarnConfiguration
operator|.
name|DEFAULT_TIMELINE_SERVICE_CLIENT_MAX_RETRIES
argument_list|)
operator|>=
operator|-
literal|1
argument_list|,
literal|"%s property value should be greater than or equal to -1"
argument_list|,
name|YarnConfiguration
operator|.
name|TIMELINE_SERVICE_CLIENT_MAX_RETRIES
argument_list|)
expr_stmt|;
name|Preconditions
operator|.
name|checkArgument
argument_list|(
name|conf
operator|.
name|getLong
argument_list|(
name|YarnConfiguration
operator|.
name|TIMELINE_SERVICE_CLIENT_RETRY_INTERVAL_MS
argument_list|,
name|YarnConfiguration
operator|.
name|DEFAULT_TIMELINE_SERVICE_CLIENT_RETRY_INTERVAL_MS
argument_list|)
operator|>
literal|0
argument_list|,
literal|"%s property value should be greater than zero"
argument_list|,
name|YarnConfiguration
operator|.
name|TIMELINE_SERVICE_CLIENT_RETRY_INTERVAL_MS
argument_list|)
expr_stmt|;
name|maxRetries
operator|=
name|conf
operator|.
name|getInt
argument_list|(
name|YarnConfiguration
operator|.
name|TIMELINE_SERVICE_CLIENT_MAX_RETRIES
argument_list|,
name|YarnConfiguration
operator|.
name|DEFAULT_TIMELINE_SERVICE_CLIENT_MAX_RETRIES
argument_list|)
expr_stmt|;
name|retryInterval
operator|=
name|conf
operator|.
name|getLong
argument_list|(
name|YarnConfiguration
operator|.
name|TIMELINE_SERVICE_CLIENT_RETRY_INTERVAL_MS
argument_list|,
name|YarnConfiguration
operator|.
name|DEFAULT_TIMELINE_SERVICE_CLIENT_RETRY_INTERVAL_MS
argument_list|)
expr_stmt|;
block|}
DECL|method|retryOn (TimelineClientRetryOp op)
specifier|public
name|Object
name|retryOn
parameter_list|(
name|TimelineClientRetryOp
name|op
parameter_list|)
throws|throws
name|RuntimeException
throws|,
name|IOException
block|{
name|int
name|leftRetries
init|=
name|maxRetries
decl_stmt|;
name|retried
operator|=
literal|false
expr_stmt|;
comment|// keep trying
while|while
condition|(
literal|true
condition|)
block|{
try|try
block|{
comment|// try perform the op, if fail, keep retrying
return|return
name|op
operator|.
name|run
argument_list|()
return|;
block|}
catch|catch
parameter_list|(
name|IOException
decl||
name|RuntimeException
name|e
parameter_list|)
block|{
comment|// break if there's no retries left
if|if
condition|(
name|leftRetries
operator|==
literal|0
condition|)
block|{
break|break;
block|}
if|if
condition|(
name|op
operator|.
name|shouldRetryOn
argument_list|(
name|e
argument_list|)
condition|)
block|{
name|logException
argument_list|(
name|e
argument_list|,
name|leftRetries
argument_list|)
expr_stmt|;
block|}
else|else
block|{
throw|throw
name|e
throw|;
block|}
block|}
if|if
condition|(
name|leftRetries
operator|>
literal|0
condition|)
block|{
name|leftRetries
operator|--
expr_stmt|;
block|}
name|retried
operator|=
literal|true
expr_stmt|;
try|try
block|{
comment|// sleep for the given time interval
name|Thread
operator|.
name|sleep
argument_list|(
name|retryInterval
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|ie
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Client retry sleep interrupted! "
argument_list|)
expr_stmt|;
block|}
block|}
throw|throw
operator|new
name|RuntimeException
argument_list|(
literal|"Failed to connect to timeline server. "
operator|+
literal|"Connection retries limit exceeded. "
operator|+
literal|"The posted timeline event may be missing"
argument_list|)
throw|;
block|}
empty_stmt|;
DECL|method|logException (Exception e, int leftRetries)
specifier|private
name|void
name|logException
parameter_list|(
name|Exception
name|e
parameter_list|,
name|int
name|leftRetries
parameter_list|)
block|{
if|if
condition|(
name|leftRetries
operator|>
literal|0
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Exception caught by TimelineClientConnectionRetry,"
operator|+
literal|" will try "
operator|+
name|leftRetries
operator|+
literal|" more time(s).\nMessage: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// note that maxRetries may be -1 at the very beginning
name|LOG
operator|.
name|info
argument_list|(
literal|"ConnectionException caught by TimelineClientConnectionRetry,"
operator|+
literal|" will keep retrying.\nMessage: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
block|}
DECL|class|TimelineJerseyRetryFilter
specifier|private
class|class
name|TimelineJerseyRetryFilter
extends|extends
name|ClientFilter
block|{
annotation|@
name|Override
DECL|method|handle (final ClientRequest cr)
specifier|public
name|ClientResponse
name|handle
parameter_list|(
specifier|final
name|ClientRequest
name|cr
parameter_list|)
throws|throws
name|ClientHandlerException
block|{
comment|// Set up the retry operation
name|TimelineClientRetryOp
name|jerseyRetryOp
init|=
operator|new
name|TimelineClientRetryOp
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|Object
name|run
parameter_list|()
block|{
comment|// Try pass the request, if fail, keep retrying
return|return
name|getNext
argument_list|()
operator|.
name|handle
argument_list|(
name|cr
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|boolean
name|shouldRetryOn
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
comment|// Only retry on connection exceptions
return|return
operator|(
name|e
operator|instanceof
name|ClientHandlerException
operator|)
operator|&&
operator|(
name|e
operator|.
name|getCause
argument_list|()
operator|instanceof
name|ConnectException
operator|||
name|e
operator|.
name|getCause
argument_list|()
operator|instanceof
name|SocketTimeoutException
operator|)
return|;
block|}
block|}
decl_stmt|;
try|try
block|{
return|return
operator|(
name|ClientResponse
operator|)
name|connectionRetry
operator|.
name|retryOn
argument_list|(
name|jerseyRetryOp
argument_list|)
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|ClientHandlerException
argument_list|(
literal|"Jersey retry failed!\nMessage: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
throw|;
block|}
block|}
block|}
DECL|method|TimelineClientImpl ()
specifier|public
name|TimelineClientImpl
parameter_list|()
block|{
name|super
argument_list|(
name|TimelineClientImpl
operator|.
name|class
operator|.
name|getName
argument_list|()
argument_list|,
literal|null
argument_list|)
expr_stmt|;
block|}
DECL|method|TimelineClientImpl (ApplicationId applicationId)
specifier|public
name|TimelineClientImpl
parameter_list|(
name|ApplicationId
name|applicationId
parameter_list|)
block|{
name|super
argument_list|(
name|TimelineClientImpl
operator|.
name|class
operator|.
name|getName
argument_list|()
argument_list|,
name|applicationId
argument_list|)
expr_stmt|;
name|this
operator|.
name|timelineServiceV2
operator|=
literal|true
expr_stmt|;
block|}
DECL|method|serviceInit (Configuration conf)
specifier|protected
name|void
name|serviceInit
parameter_list|(
name|Configuration
name|conf
parameter_list|)
throws|throws
name|Exception
block|{
name|this
operator|.
name|configuration
operator|=
name|conf
expr_stmt|;
name|UserGroupInformation
name|ugi
init|=
name|UserGroupInformation
operator|.
name|getCurrentUser
argument_list|()
decl_stmt|;
name|UserGroupInformation
name|realUgi
init|=
name|ugi
operator|.
name|getRealUser
argument_list|()
decl_stmt|;
if|if
condition|(
name|realUgi
operator|!=
literal|null
condition|)
block|{
name|authUgi
operator|=
name|realUgi
expr_stmt|;
name|doAsUser
operator|=
name|ugi
operator|.
name|getShortUserName
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|authUgi
operator|=
name|ugi
expr_stmt|;
name|doAsUser
operator|=
literal|null
expr_stmt|;
block|}
name|ClientConfig
name|cc
init|=
operator|new
name|DefaultClientConfig
argument_list|()
decl_stmt|;
name|cc
operator|.
name|getClasses
argument_list|()
operator|.
name|add
argument_list|(
name|YarnJacksonJaxbJsonProvider
operator|.
name|class
argument_list|)
expr_stmt|;
name|connConfigurator
operator|=
name|initConnConfigurator
argument_list|(
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|UserGroupInformation
operator|.
name|isSecurityEnabled
argument_list|()
condition|)
block|{
name|authenticator
operator|=
operator|new
name|KerberosDelegationTokenAuthenticator
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|authenticator
operator|=
operator|new
name|PseudoDelegationTokenAuthenticator
argument_list|()
expr_stmt|;
block|}
name|authenticator
operator|.
name|setConnectionConfigurator
argument_list|(
name|connConfigurator
argument_list|)
expr_stmt|;
name|token
operator|=
operator|new
name|DelegationTokenAuthenticatedURL
operator|.
name|Token
argument_list|()
expr_stmt|;
name|connectionRetry
operator|=
operator|new
name|TimelineClientConnectionRetry
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|client
operator|=
operator|new
name|Client
argument_list|(
operator|new
name|URLConnectionClientHandler
argument_list|(
operator|new
name|TimelineURLConnectionFactory
argument_list|()
argument_list|)
argument_list|,
name|cc
argument_list|)
expr_stmt|;
name|TimelineJerseyRetryFilter
name|retryFilter
init|=
operator|new
name|TimelineJerseyRetryFilter
argument_list|()
decl_stmt|;
comment|// TODO need to cleanup filter retry later.
if|if
condition|(
operator|!
name|timelineServiceV2
condition|)
block|{
name|client
operator|.
name|addFilter
argument_list|(
name|retryFilter
argument_list|)
expr_stmt|;
block|}
comment|// old version timeline service need to get address from configuration
comment|// while new version need to auto discovery (with retry).
if|if
condition|(
name|timelineServiceV2
condition|)
block|{
name|maxServiceRetries
operator|=
name|conf
operator|.
name|getInt
argument_list|(
name|YarnConfiguration
operator|.
name|TIMELINE_SERVICE_CLIENT_MAX_RETRIES
argument_list|,
name|YarnConfiguration
operator|.
name|DEFAULT_TIMELINE_SERVICE_CLIENT_MAX_RETRIES
argument_list|)
expr_stmt|;
name|serviceRetryInterval
operator|=
name|conf
operator|.
name|getLong
argument_list|(
name|YarnConfiguration
operator|.
name|TIMELINE_SERVICE_CLIENT_RETRY_INTERVAL_MS
argument_list|,
name|YarnConfiguration
operator|.
name|DEFAULT_TIMELINE_SERVICE_CLIENT_RETRY_INTERVAL_MS
argument_list|)
expr_stmt|;
name|entityDispatcher
operator|=
operator|new
name|TimelineEntityDispatcher
argument_list|(
name|conf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|YarnConfiguration
operator|.
name|useHttps
argument_list|(
name|conf
argument_list|)
condition|)
block|{
name|setTimelineServiceAddress
argument_list|(
name|conf
operator|.
name|get
argument_list|(
name|YarnConfiguration
operator|.
name|TIMELINE_SERVICE_WEBAPP_HTTPS_ADDRESS
argument_list|,
name|YarnConfiguration
operator|.
name|DEFAULT_TIMELINE_SERVICE_WEBAPP_HTTPS_ADDRESS
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|setTimelineServiceAddress
argument_list|(
name|conf
operator|.
name|get
argument_list|(
name|YarnConfiguration
operator|.
name|TIMELINE_SERVICE_WEBAPP_ADDRESS
argument_list|,
name|YarnConfiguration
operator|.
name|DEFAULT_TIMELINE_SERVICE_WEBAPP_ADDRESS
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|timelineServiceVersion
operator|=
name|conf
operator|.
name|getFloat
argument_list|(
name|YarnConfiguration
operator|.
name|TIMELINE_SERVICE_VERSION
argument_list|,
name|YarnConfiguration
operator|.
name|DEFAULT_TIMELINE_SERVICE_VERSION
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Timeline service address: "
operator|+
name|getTimelineServiceAddress
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|super
operator|.
name|serviceInit
argument_list|(
name|conf
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|serviceStart ()
specifier|protected
name|void
name|serviceStart
parameter_list|()
throws|throws
name|Exception
block|{
if|if
condition|(
name|timelineServiceV2
condition|)
block|{
name|entityDispatcher
operator|.
name|start
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|timelineWriter
operator|=
name|createTimelineWriter
argument_list|(
name|configuration
argument_list|,
name|authUgi
argument_list|,
name|client
argument_list|,
name|constructResURI
argument_list|(
name|getConfig
argument_list|()
argument_list|,
name|timelineServiceAddress
argument_list|,
literal|false
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|createTimelineWriter (Configuration conf, UserGroupInformation ugi, Client webClient, URI uri)
specifier|protected
name|TimelineWriter
name|createTimelineWriter
parameter_list|(
name|Configuration
name|conf
parameter_list|,
name|UserGroupInformation
name|ugi
parameter_list|,
name|Client
name|webClient
parameter_list|,
name|URI
name|uri
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
name|Float
operator|.
name|compare
argument_list|(
name|this
operator|.
name|timelineServiceVersion
argument_list|,
literal|1.5f
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
operator|new
name|FileSystemTimelineWriter
argument_list|(
name|conf
argument_list|,
name|ugi
argument_list|,
name|webClient
argument_list|,
name|uri
argument_list|)
return|;
block|}
else|else
block|{
return|return
operator|new
name|DirectTimelineWriter
argument_list|(
name|ugi
argument_list|,
name|webClient
argument_list|,
name|uri
argument_list|)
return|;
block|}
block|}
annotation|@
name|Override
DECL|method|serviceStop ()
specifier|protected
name|void
name|serviceStop
parameter_list|()
throws|throws
name|Exception
block|{
if|if
condition|(
name|this
operator|.
name|timelineWriter
operator|!=
literal|null
condition|)
block|{
name|this
operator|.
name|timelineWriter
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|timelineServiceV2
condition|)
block|{
name|entityDispatcher
operator|.
name|stop
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|this
operator|.
name|sslFactory
operator|!=
literal|null
condition|)
block|{
name|this
operator|.
name|sslFactory
operator|.
name|destroy
argument_list|()
expr_stmt|;
block|}
name|super
operator|.
name|serviceStop
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|flush ()
specifier|public
name|void
name|flush
parameter_list|()
throws|throws
name|IOException
block|{
if|if
condition|(
name|timelineWriter
operator|!=
literal|null
condition|)
block|{
name|timelineWriter
operator|.
name|flush
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|putEntities ( TimelineEntity... entities)
specifier|public
name|TimelinePutResponse
name|putEntities
parameter_list|(
name|TimelineEntity
modifier|...
name|entities
parameter_list|)
throws|throws
name|IOException
throws|,
name|YarnException
block|{
return|return
name|timelineWriter
operator|.
name|putEntities
argument_list|(
name|entities
argument_list|)
return|;
block|}
annotation|@
name|Override
DECL|method|putEntities ( org.apache.hadoop.yarn.api.records.timelineservice.TimelineEntity... entities)
specifier|public
name|void
name|putEntities
parameter_list|(
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|timelineservice
operator|.
name|TimelineEntity
modifier|...
name|entities
parameter_list|)
throws|throws
name|IOException
throws|,
name|YarnException
block|{
if|if
condition|(
operator|!
name|timelineServiceV2
condition|)
block|{
throw|throw
operator|new
name|YarnException
argument_list|(
literal|"v.2 method is invoked on a v.1.x client"
argument_list|)
throw|;
block|}
name|entityDispatcher
operator|.
name|dispatchEntities
argument_list|(
literal|true
argument_list|,
name|entities
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|putEntitiesAsync ( org.apache.hadoop.yarn.api.records.timelineservice.TimelineEntity... entities)
specifier|public
name|void
name|putEntitiesAsync
parameter_list|(
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|timelineservice
operator|.
name|TimelineEntity
modifier|...
name|entities
parameter_list|)
throws|throws
name|IOException
throws|,
name|YarnException
block|{
if|if
condition|(
operator|!
name|timelineServiceV2
condition|)
block|{
throw|throw
operator|new
name|YarnException
argument_list|(
literal|"v.2 method is invoked on a v.1.x client"
argument_list|)
throw|;
block|}
name|entityDispatcher
operator|.
name|dispatchEntities
argument_list|(
literal|false
argument_list|,
name|entities
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|putDomain (TimelineDomain domain)
specifier|public
name|void
name|putDomain
parameter_list|(
name|TimelineDomain
name|domain
parameter_list|)
throws|throws
name|IOException
throws|,
name|YarnException
block|{
name|timelineWriter
operator|.
name|putDomain
argument_list|(
name|domain
argument_list|)
expr_stmt|;
block|}
comment|// Used for new timeline service only
annotation|@
name|Private
DECL|method|putObjects (String path, MultivaluedMap<String, String> params, Object obj)
specifier|protected
name|void
name|putObjects
parameter_list|(
name|String
name|path
parameter_list|,
name|MultivaluedMap
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|params
parameter_list|,
name|Object
name|obj
parameter_list|)
throws|throws
name|IOException
throws|,
name|YarnException
block|{
name|int
name|retries
init|=
name|verifyRestEndPointAvailable
argument_list|()
decl_stmt|;
comment|// timelineServiceAddress could be stale, add retry logic here.
name|boolean
name|needRetry
init|=
literal|true
decl_stmt|;
while|while
condition|(
name|needRetry
condition|)
block|{
try|try
block|{
name|URI
name|uri
init|=
name|constructResURI
argument_list|(
name|getConfig
argument_list|()
argument_list|,
name|timelineServiceAddress
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|putObjects
argument_list|(
name|uri
argument_list|,
name|path
argument_list|,
name|params
argument_list|,
name|obj
argument_list|)
expr_stmt|;
name|needRetry
operator|=
literal|false
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
comment|// handle exception for timelineServiceAddress being updated.
name|checkRetryWithSleep
argument_list|(
name|retries
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|retries
operator|--
expr_stmt|;
block|}
block|}
block|}
DECL|method|verifyRestEndPointAvailable ()
specifier|private
name|int
name|verifyRestEndPointAvailable
parameter_list|()
throws|throws
name|YarnException
block|{
comment|// timelineServiceAddress could haven't be initialized yet
comment|// or stale (only for new timeline service)
name|int
name|retries
init|=
name|pollTimelineServiceAddress
argument_list|(
name|this
operator|.
name|maxServiceRetries
argument_list|)
decl_stmt|;
if|if
condition|(
name|timelineServiceAddress
operator|==
literal|null
condition|)
block|{
name|String
name|errMessage
init|=
literal|"TimelineClient has reached to max retry times : "
operator|+
name|this
operator|.
name|maxServiceRetries
operator|+
literal|", but failed to fetch timeline service address. Please verify"
operator|+
literal|" Timeline Auxiliary Service is configured in all the NMs"
decl_stmt|;
name|LOG
operator|.
name|error
argument_list|(
name|errMessage
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|YarnException
argument_list|(
name|errMessage
argument_list|)
throw|;
block|}
return|return
name|retries
return|;
block|}
comment|/**    * Check if reaching to maximum of retries.    * @param retries    * @param e    */
DECL|method|checkRetryWithSleep (int retries, IOException e)
specifier|private
name|void
name|checkRetryWithSleep
parameter_list|(
name|int
name|retries
parameter_list|,
name|IOException
name|e
parameter_list|)
throws|throws
name|YarnException
throws|,
name|IOException
block|{
if|if
condition|(
name|retries
operator|>
literal|0
condition|)
block|{
try|try
block|{
name|Thread
operator|.
name|sleep
argument_list|(
name|this
operator|.
name|serviceRetryInterval
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|ex
parameter_list|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|interrupt
argument_list|()
expr_stmt|;
throw|throw
operator|new
name|YarnException
argument_list|(
literal|"Interrupted while retrying to connect to ATS"
argument_list|)
throw|;
block|}
block|}
else|else
block|{
name|StringBuilder
name|msg
init|=
operator|new
name|StringBuilder
argument_list|(
literal|"TimelineClient has reached to max retry times : "
argument_list|)
decl_stmt|;
name|msg
operator|.
name|append
argument_list|(
name|this
operator|.
name|maxServiceRetries
argument_list|)
expr_stmt|;
name|msg
operator|.
name|append
argument_list|(
literal|" for service address: "
argument_list|)
expr_stmt|;
name|msg
operator|.
name|append
argument_list|(
name|timelineServiceAddress
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|error
argument_list|(
name|msg
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|IOException
argument_list|(
name|msg
operator|.
name|toString
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
DECL|method|putObjects ( URI base, String path, MultivaluedMap<String, String> params, Object obj)
specifier|protected
name|void
name|putObjects
parameter_list|(
name|URI
name|base
parameter_list|,
name|String
name|path
parameter_list|,
name|MultivaluedMap
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|params
parameter_list|,
name|Object
name|obj
parameter_list|)
throws|throws
name|IOException
throws|,
name|YarnException
block|{
name|ClientResponse
name|resp
decl_stmt|;
try|try
block|{
name|resp
operator|=
name|client
operator|.
name|resource
argument_list|(
name|base
argument_list|)
operator|.
name|path
argument_list|(
name|path
argument_list|)
operator|.
name|queryParams
argument_list|(
name|params
argument_list|)
operator|.
name|accept
argument_list|(
name|MediaType
operator|.
name|APPLICATION_JSON
argument_list|)
operator|.
name|type
argument_list|(
name|MediaType
operator|.
name|APPLICATION_JSON
argument_list|)
operator|.
name|put
argument_list|(
name|ClientResponse
operator|.
name|class
argument_list|,
name|obj
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|RuntimeException
name|re
parameter_list|)
block|{
comment|// runtime exception is expected if the client cannot connect the server
name|String
name|msg
init|=
literal|"Failed to get the response from the timeline server."
decl_stmt|;
name|LOG
operator|.
name|error
argument_list|(
name|msg
argument_list|,
name|re
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|IOException
argument_list|(
name|re
argument_list|)
throw|;
block|}
if|if
condition|(
name|resp
operator|==
literal|null
operator|||
name|resp
operator|.
name|getStatusInfo
argument_list|()
operator|.
name|getStatusCode
argument_list|()
operator|!=
name|ClientResponse
operator|.
name|Status
operator|.
name|OK
operator|.
name|getStatusCode
argument_list|()
condition|)
block|{
name|String
name|msg
init|=
literal|"Response from the timeline server is "
operator|+
operator|(
operator|(
name|resp
operator|==
literal|null
operator|)
condition|?
literal|"null"
else|:
literal|"not successful,"
operator|+
literal|" HTTP error code: "
operator|+
name|resp
operator|.
name|getStatus
argument_list|()
operator|+
literal|", Server response:\n"
operator|+
name|resp
operator|.
name|getEntity
argument_list|(
name|String
operator|.
name|class
argument_list|)
operator|)
decl_stmt|;
name|LOG
operator|.
name|error
argument_list|(
name|msg
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|YarnException
argument_list|(
name|msg
argument_list|)
throw|;
block|}
block|}
annotation|@
name|Override
DECL|method|setTimelineServiceAddress (String address)
specifier|public
name|void
name|setTimelineServiceAddress
parameter_list|(
name|String
name|address
parameter_list|)
block|{
name|this
operator|.
name|timelineServiceAddress
operator|=
name|address
expr_stmt|;
block|}
DECL|method|getTimelineServiceAddress ()
specifier|private
name|String
name|getTimelineServiceAddress
parameter_list|()
block|{
return|return
name|this
operator|.
name|timelineServiceAddress
return|;
block|}
annotation|@
name|SuppressWarnings
argument_list|(
literal|"unchecked"
argument_list|)
annotation|@
name|Override
DECL|method|getDelegationToken ( final String renewer)
specifier|public
name|Token
argument_list|<
name|TimelineDelegationTokenIdentifier
argument_list|>
name|getDelegationToken
parameter_list|(
specifier|final
name|String
name|renewer
parameter_list|)
throws|throws
name|IOException
throws|,
name|YarnException
block|{
name|PrivilegedExceptionAction
argument_list|<
name|Token
argument_list|<
name|TimelineDelegationTokenIdentifier
argument_list|>
argument_list|>
name|getDTAction
init|=
operator|new
name|PrivilegedExceptionAction
argument_list|<
name|Token
argument_list|<
name|TimelineDelegationTokenIdentifier
argument_list|>
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|Token
argument_list|<
name|TimelineDelegationTokenIdentifier
argument_list|>
name|run
parameter_list|()
throws|throws
name|Exception
block|{
name|DelegationTokenAuthenticatedURL
name|authUrl
init|=
operator|new
name|DelegationTokenAuthenticatedURL
argument_list|(
name|authenticator
argument_list|,
name|connConfigurator
argument_list|)
decl_stmt|;
comment|// TODO we should add retry logic here if timelineServiceAddress is
comment|// not available immediately.
return|return
operator|(
name|Token
operator|)
name|authUrl
operator|.
name|getDelegationToken
argument_list|(
name|constructResURI
argument_list|(
name|getConfig
argument_list|()
argument_list|,
name|getTimelineServiceAddress
argument_list|()
argument_list|,
literal|false
argument_list|)
operator|.
name|toURL
argument_list|()
argument_list|,
name|token
argument_list|,
name|renewer
argument_list|,
name|doAsUser
argument_list|)
return|;
block|}
block|}
decl_stmt|;
return|return
operator|(
name|Token
argument_list|<
name|TimelineDelegationTokenIdentifier
argument_list|>
operator|)
name|operateDelegationToken
argument_list|(
name|getDTAction
argument_list|)
return|;
block|}
annotation|@
name|SuppressWarnings
argument_list|(
literal|"unchecked"
argument_list|)
annotation|@
name|Override
DECL|method|renewDelegationToken ( final Token<TimelineDelegationTokenIdentifier> timelineDT)
specifier|public
name|long
name|renewDelegationToken
parameter_list|(
specifier|final
name|Token
argument_list|<
name|TimelineDelegationTokenIdentifier
argument_list|>
name|timelineDT
parameter_list|)
throws|throws
name|IOException
throws|,
name|YarnException
block|{
specifier|final
name|boolean
name|isTokenServiceAddrEmpty
init|=
name|timelineDT
operator|.
name|getService
argument_list|()
operator|.
name|toString
argument_list|()
operator|.
name|isEmpty
argument_list|()
decl_stmt|;
specifier|final
name|String
name|scheme
init|=
name|isTokenServiceAddrEmpty
condition|?
literal|null
else|:
operator|(
name|YarnConfiguration
operator|.
name|useHttps
argument_list|(
name|this
operator|.
name|getConfig
argument_list|()
argument_list|)
condition|?
literal|"https"
else|:
literal|"http"
operator|)
decl_stmt|;
specifier|final
name|InetSocketAddress
name|address
init|=
name|isTokenServiceAddrEmpty
condition|?
literal|null
else|:
name|SecurityUtil
operator|.
name|getTokenServiceAddr
argument_list|(
name|timelineDT
argument_list|)
decl_stmt|;
name|PrivilegedExceptionAction
argument_list|<
name|Long
argument_list|>
name|renewDTAction
init|=
operator|new
name|PrivilegedExceptionAction
argument_list|<
name|Long
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|Long
name|run
parameter_list|()
throws|throws
name|Exception
block|{
comment|// If the timeline DT to renew is different than cached, replace it.
comment|// Token to set every time for retry, because when exception
comment|// happens, DelegationTokenAuthenticatedURL will reset it to null;
if|if
condition|(
operator|!
name|timelineDT
operator|.
name|equals
argument_list|(
name|token
operator|.
name|getDelegationToken
argument_list|()
argument_list|)
condition|)
block|{
name|token
operator|.
name|setDelegationToken
argument_list|(
operator|(
name|Token
operator|)
name|timelineDT
argument_list|)
expr_stmt|;
block|}
name|DelegationTokenAuthenticatedURL
name|authUrl
init|=
operator|new
name|DelegationTokenAuthenticatedURL
argument_list|(
name|authenticator
argument_list|,
name|connConfigurator
argument_list|)
decl_stmt|;
comment|// If the token service address is not available, fall back to use
comment|// the configured service address.
specifier|final
name|URI
name|serviceURI
init|=
name|isTokenServiceAddrEmpty
condition|?
name|constructResURI
argument_list|(
name|getConfig
argument_list|()
argument_list|,
name|getTimelineServiceAddress
argument_list|()
argument_list|,
literal|false
argument_list|)
else|:
operator|new
name|URI
argument_list|(
name|scheme
argument_list|,
literal|null
argument_list|,
name|address
operator|.
name|getHostName
argument_list|()
argument_list|,
name|address
operator|.
name|getPort
argument_list|()
argument_list|,
name|RESOURCE_URI_STR_V1
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
decl_stmt|;
return|return
name|authUrl
operator|.
name|renewDelegationToken
argument_list|(
name|serviceURI
operator|.
name|toURL
argument_list|()
argument_list|,
name|token
argument_list|,
name|doAsUser
argument_list|)
return|;
block|}
block|}
decl_stmt|;
return|return
operator|(
name|Long
operator|)
name|operateDelegationToken
argument_list|(
name|renewDTAction
argument_list|)
return|;
block|}
annotation|@
name|SuppressWarnings
argument_list|(
literal|"unchecked"
argument_list|)
annotation|@
name|Override
DECL|method|cancelDelegationToken ( final Token<TimelineDelegationTokenIdentifier> timelineDT)
specifier|public
name|void
name|cancelDelegationToken
parameter_list|(
specifier|final
name|Token
argument_list|<
name|TimelineDelegationTokenIdentifier
argument_list|>
name|timelineDT
parameter_list|)
throws|throws
name|IOException
throws|,
name|YarnException
block|{
specifier|final
name|boolean
name|isTokenServiceAddrEmpty
init|=
name|timelineDT
operator|.
name|getService
argument_list|()
operator|.
name|toString
argument_list|()
operator|.
name|isEmpty
argument_list|()
decl_stmt|;
specifier|final
name|String
name|scheme
init|=
name|isTokenServiceAddrEmpty
condition|?
literal|null
else|:
operator|(
name|YarnConfiguration
operator|.
name|useHttps
argument_list|(
name|this
operator|.
name|getConfig
argument_list|()
argument_list|)
condition|?
literal|"https"
else|:
literal|"http"
operator|)
decl_stmt|;
specifier|final
name|InetSocketAddress
name|address
init|=
name|isTokenServiceAddrEmpty
condition|?
literal|null
else|:
name|SecurityUtil
operator|.
name|getTokenServiceAddr
argument_list|(
name|timelineDT
argument_list|)
decl_stmt|;
name|PrivilegedExceptionAction
argument_list|<
name|Void
argument_list|>
name|cancelDTAction
init|=
operator|new
name|PrivilegedExceptionAction
argument_list|<
name|Void
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|Void
name|run
parameter_list|()
throws|throws
name|Exception
block|{
comment|// If the timeline DT to cancel is different than cached, replace
comment|// it.
comment|// Token to set every time for retry, because when exception
comment|// happens, DelegationTokenAuthenticatedURL will reset it to null;
if|if
condition|(
operator|!
name|timelineDT
operator|.
name|equals
argument_list|(
name|token
operator|.
name|getDelegationToken
argument_list|()
argument_list|)
condition|)
block|{
name|token
operator|.
name|setDelegationToken
argument_list|(
operator|(
name|Token
operator|)
name|timelineDT
argument_list|)
expr_stmt|;
block|}
name|DelegationTokenAuthenticatedURL
name|authUrl
init|=
operator|new
name|DelegationTokenAuthenticatedURL
argument_list|(
name|authenticator
argument_list|,
name|connConfigurator
argument_list|)
decl_stmt|;
comment|// If the token service address is not available, fall back to use
comment|// the configured service address.
specifier|final
name|URI
name|serviceURI
init|=
name|isTokenServiceAddrEmpty
condition|?
name|constructResURI
argument_list|(
name|getConfig
argument_list|()
argument_list|,
name|getTimelineServiceAddress
argument_list|()
argument_list|,
literal|false
argument_list|)
else|:
operator|new
name|URI
argument_list|(
name|scheme
argument_list|,
literal|null
argument_list|,
name|address
operator|.
name|getHostName
argument_list|()
argument_list|,
name|address
operator|.
name|getPort
argument_list|()
argument_list|,
name|RESOURCE_URI_STR_V1
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
decl_stmt|;
name|authUrl
operator|.
name|cancelDelegationToken
argument_list|(
name|serviceURI
operator|.
name|toURL
argument_list|()
argument_list|,
name|token
argument_list|,
name|doAsUser
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
block|}
decl_stmt|;
name|operateDelegationToken
argument_list|(
name|cancelDTAction
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|toString ()
specifier|public
name|String
name|toString
parameter_list|()
block|{
return|return
name|super
operator|.
name|toString
argument_list|()
operator|+
literal|" with timeline server "
operator|+
name|constructResURI
argument_list|(
name|getConfig
argument_list|()
argument_list|,
name|getTimelineServiceAddress
argument_list|()
argument_list|,
literal|false
argument_list|)
operator|+
literal|" and writer "
operator|+
name|timelineWriter
return|;
block|}
DECL|method|operateDelegationToken ( final PrivilegedExceptionAction<?> action)
specifier|private
name|Object
name|operateDelegationToken
parameter_list|(
specifier|final
name|PrivilegedExceptionAction
argument_list|<
name|?
argument_list|>
name|action
parameter_list|)
throws|throws
name|IOException
throws|,
name|YarnException
block|{
comment|// Set up the retry operation
name|TimelineClientRetryOp
name|tokenRetryOp
init|=
name|createTimelineClientRetryOpForOperateDelegationToken
argument_list|(
name|action
argument_list|)
decl_stmt|;
return|return
name|connectionRetry
operator|.
name|retryOn
argument_list|(
name|tokenRetryOp
argument_list|)
return|;
block|}
comment|/**    * Poll TimelineServiceAddress for maximum of retries times if it is null.    *    * @param retries    * @return the left retry times    * @throws IOException    */
DECL|method|pollTimelineServiceAddress (int retries)
specifier|private
name|int
name|pollTimelineServiceAddress
parameter_list|(
name|int
name|retries
parameter_list|)
throws|throws
name|YarnException
block|{
while|while
condition|(
name|timelineServiceAddress
operator|==
literal|null
operator|&&
name|retries
operator|>
literal|0
condition|)
block|{
try|try
block|{
name|Thread
operator|.
name|sleep
argument_list|(
name|this
operator|.
name|serviceRetryInterval
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|e
parameter_list|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|interrupt
argument_list|()
expr_stmt|;
throw|throw
operator|new
name|YarnException
argument_list|(
literal|"Interrupted while trying to connect ATS"
argument_list|)
throw|;
block|}
name|retries
operator|--
expr_stmt|;
block|}
return|return
name|retries
return|;
block|}
DECL|class|TimelineURLConnectionFactory
specifier|private
class|class
name|TimelineURLConnectionFactory
implements|implements
name|HttpURLConnectionFactory
block|{
annotation|@
name|Override
DECL|method|getHttpURLConnection (final URL url)
specifier|public
name|HttpURLConnection
name|getHttpURLConnection
parameter_list|(
specifier|final
name|URL
name|url
parameter_list|)
throws|throws
name|IOException
block|{
name|authUgi
operator|.
name|checkTGTAndReloginFromKeytab
argument_list|()
expr_stmt|;
try|try
block|{
return|return
operator|new
name|DelegationTokenAuthenticatedURL
argument_list|(
name|authenticator
argument_list|,
name|connConfigurator
argument_list|)
operator|.
name|openConnection
argument_list|(
name|url
argument_list|,
name|token
argument_list|,
name|doAsUser
argument_list|)
return|;
block|}
catch|catch
parameter_list|(
name|UndeclaredThrowableException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
name|e
operator|.
name|getCause
argument_list|()
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
name|AuthenticationException
name|ae
parameter_list|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
name|ae
argument_list|)
throw|;
block|}
block|}
block|}
DECL|method|initConnConfigurator (Configuration conf)
specifier|private
name|ConnectionConfigurator
name|initConnConfigurator
parameter_list|(
name|Configuration
name|conf
parameter_list|)
block|{
try|try
block|{
return|return
name|initSslConnConfigurator
argument_list|(
name|DEFAULT_SOCKET_TIMEOUT
argument_list|,
name|conf
argument_list|)
return|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Cannot load customized ssl related configuration. "
operator|+
literal|"Fallback to system-generic settings."
argument_list|,
name|e
argument_list|)
expr_stmt|;
return|return
name|DEFAULT_TIMEOUT_CONN_CONFIGURATOR
return|;
block|}
block|}
DECL|field|DEFAULT_TIMEOUT_CONN_CONFIGURATOR
specifier|private
specifier|static
specifier|final
name|ConnectionConfigurator
name|DEFAULT_TIMEOUT_CONN_CONFIGURATOR
init|=
operator|new
name|ConnectionConfigurator
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|HttpURLConnection
name|configure
parameter_list|(
name|HttpURLConnection
name|conn
parameter_list|)
throws|throws
name|IOException
block|{
name|setTimeouts
argument_list|(
name|conn
argument_list|,
name|DEFAULT_SOCKET_TIMEOUT
argument_list|)
expr_stmt|;
return|return
name|conn
return|;
block|}
block|}
decl_stmt|;
DECL|method|initSslConnConfigurator (final int timeout, Configuration conf)
specifier|private
name|ConnectionConfigurator
name|initSslConnConfigurator
parameter_list|(
specifier|final
name|int
name|timeout
parameter_list|,
name|Configuration
name|conf
parameter_list|)
throws|throws
name|IOException
throws|,
name|GeneralSecurityException
block|{
specifier|final
name|SSLSocketFactory
name|sf
decl_stmt|;
specifier|final
name|HostnameVerifier
name|hv
decl_stmt|;
name|sslFactory
operator|=
operator|new
name|SSLFactory
argument_list|(
name|SSLFactory
operator|.
name|Mode
operator|.
name|CLIENT
argument_list|,
name|conf
argument_list|)
expr_stmt|;
name|sslFactory
operator|.
name|init
argument_list|()
expr_stmt|;
name|sf
operator|=
name|sslFactory
operator|.
name|createSSLSocketFactory
argument_list|()
expr_stmt|;
name|hv
operator|=
name|sslFactory
operator|.
name|getHostnameVerifier
argument_list|()
expr_stmt|;
return|return
operator|new
name|ConnectionConfigurator
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|HttpURLConnection
name|configure
parameter_list|(
name|HttpURLConnection
name|conn
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
name|conn
operator|instanceof
name|HttpsURLConnection
condition|)
block|{
name|HttpsURLConnection
name|c
init|=
operator|(
name|HttpsURLConnection
operator|)
name|conn
decl_stmt|;
name|c
operator|.
name|setSSLSocketFactory
argument_list|(
name|sf
argument_list|)
expr_stmt|;
name|c
operator|.
name|setHostnameVerifier
argument_list|(
name|hv
argument_list|)
expr_stmt|;
block|}
name|setTimeouts
argument_list|(
name|conn
argument_list|,
name|timeout
argument_list|)
expr_stmt|;
return|return
name|conn
return|;
block|}
block|}
return|;
block|}
DECL|method|setTimeouts (URLConnection connection, int socketTimeout)
specifier|private
specifier|static
name|void
name|setTimeouts
parameter_list|(
name|URLConnection
name|connection
parameter_list|,
name|int
name|socketTimeout
parameter_list|)
block|{
name|connection
operator|.
name|setConnectTimeout
argument_list|(
name|socketTimeout
argument_list|)
expr_stmt|;
name|connection
operator|.
name|setReadTimeout
argument_list|(
name|socketTimeout
argument_list|)
expr_stmt|;
block|}
DECL|method|constructResURI ( Configuration conf, String address, boolean v2)
specifier|private
specifier|static
name|URI
name|constructResURI
parameter_list|(
name|Configuration
name|conf
parameter_list|,
name|String
name|address
parameter_list|,
name|boolean
name|v2
parameter_list|)
block|{
return|return
name|URI
operator|.
name|create
argument_list|(
name|JOINER
operator|.
name|join
argument_list|(
name|YarnConfiguration
operator|.
name|useHttps
argument_list|(
name|conf
argument_list|)
condition|?
literal|"https://"
else|:
literal|"http://"
argument_list|,
name|address
argument_list|,
name|v2
condition|?
name|RESOURCE_URI_STR_V2
else|:
name|RESOURCE_URI_STR_V1
argument_list|)
argument_list|)
return|;
block|}
DECL|method|main (String[] argv)
specifier|public
specifier|static
name|void
name|main
parameter_list|(
name|String
index|[]
name|argv
parameter_list|)
throws|throws
name|Exception
block|{
name|CommandLine
name|cliParser
init|=
operator|new
name|GnuParser
argument_list|()
operator|.
name|parse
argument_list|(
name|opts
argument_list|,
name|argv
argument_list|)
decl_stmt|;
if|if
condition|(
name|cliParser
operator|.
name|hasOption
argument_list|(
literal|"put"
argument_list|)
condition|)
block|{
name|String
name|path
init|=
name|cliParser
operator|.
name|getOptionValue
argument_list|(
literal|"put"
argument_list|)
decl_stmt|;
if|if
condition|(
name|path
operator|!=
literal|null
operator|&&
name|path
operator|.
name|length
argument_list|()
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|cliParser
operator|.
name|hasOption
argument_list|(
name|ENTITY_DATA_TYPE
argument_list|)
condition|)
block|{
name|putTimelineDataInJSONFile
argument_list|(
name|path
argument_list|,
name|ENTITY_DATA_TYPE
argument_list|)
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
name|cliParser
operator|.
name|hasOption
argument_list|(
name|DOMAIN_DATA_TYPE
argument_list|)
condition|)
block|{
name|putTimelineDataInJSONFile
argument_list|(
name|path
argument_list|,
name|DOMAIN_DATA_TYPE
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
block|}
name|printUsage
argument_list|()
expr_stmt|;
block|}
comment|/**    * Put timeline data in a JSON file via command line.    *     * @param path    *          path to the timeline data JSON file    * @param type    *          the type of the timeline data in the JSON file    */
DECL|method|putTimelineDataInJSONFile (String path, String type)
specifier|private
specifier|static
name|void
name|putTimelineDataInJSONFile
parameter_list|(
name|String
name|path
parameter_list|,
name|String
name|type
parameter_list|)
block|{
name|File
name|jsonFile
init|=
operator|new
name|File
argument_list|(
name|path
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|jsonFile
operator|.
name|exists
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"File ["
operator|+
name|jsonFile
operator|.
name|getAbsolutePath
argument_list|()
operator|+
literal|"] doesn't exist"
argument_list|)
expr_stmt|;
return|return;
block|}
name|YarnJacksonJaxbJsonProvider
operator|.
name|configObjectMapper
argument_list|(
name|MAPPER
argument_list|)
expr_stmt|;
name|TimelineEntities
name|entities
init|=
literal|null
decl_stmt|;
name|TimelineDomains
name|domains
init|=
literal|null
decl_stmt|;
try|try
block|{
if|if
condition|(
name|type
operator|.
name|equals
argument_list|(
name|ENTITY_DATA_TYPE
argument_list|)
condition|)
block|{
name|entities
operator|=
name|MAPPER
operator|.
name|readValue
argument_list|(
name|jsonFile
argument_list|,
name|TimelineEntities
operator|.
name|class
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|type
operator|.
name|equals
argument_list|(
name|DOMAIN_DATA_TYPE
argument_list|)
condition|)
block|{
name|domains
operator|=
name|MAPPER
operator|.
name|readValue
argument_list|(
name|jsonFile
argument_list|,
name|TimelineDomains
operator|.
name|class
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Error when reading  "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
name|e
operator|.
name|printStackTrace
argument_list|(
name|System
operator|.
name|err
argument_list|)
expr_stmt|;
return|return;
block|}
name|Configuration
name|conf
init|=
operator|new
name|YarnConfiguration
argument_list|()
decl_stmt|;
name|TimelineClient
name|client
init|=
name|TimelineClient
operator|.
name|createTimelineClient
argument_list|()
decl_stmt|;
name|client
operator|.
name|init
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|client
operator|.
name|start
argument_list|()
expr_stmt|;
try|try
block|{
if|if
condition|(
name|UserGroupInformation
operator|.
name|isSecurityEnabled
argument_list|()
operator|&&
name|conf
operator|.
name|getBoolean
argument_list|(
name|YarnConfiguration
operator|.
name|TIMELINE_SERVICE_ENABLED
argument_list|,
literal|false
argument_list|)
condition|)
block|{
name|Token
argument_list|<
name|TimelineDelegationTokenIdentifier
argument_list|>
name|token
init|=
name|client
operator|.
name|getDelegationToken
argument_list|(
name|UserGroupInformation
operator|.
name|getCurrentUser
argument_list|()
operator|.
name|getUserName
argument_list|()
argument_list|)
decl_stmt|;
name|UserGroupInformation
operator|.
name|getCurrentUser
argument_list|()
operator|.
name|addToken
argument_list|(
name|token
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|type
operator|.
name|equals
argument_list|(
name|ENTITY_DATA_TYPE
argument_list|)
condition|)
block|{
name|TimelinePutResponse
name|response
init|=
name|client
operator|.
name|putEntities
argument_list|(
name|entities
operator|.
name|getEntities
argument_list|()
operator|.
name|toArray
argument_list|(
operator|new
name|TimelineEntity
index|[
name|entities
operator|.
name|getEntities
argument_list|()
operator|.
name|size
argument_list|()
index|]
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|response
operator|.
name|getErrors
argument_list|()
operator|.
name|size
argument_list|()
operator|==
literal|0
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Timeline entities are successfully put"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|TimelinePutResponse
operator|.
name|TimelinePutError
name|error
range|:
name|response
operator|.
name|getErrors
argument_list|()
control|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"TimelineEntity ["
operator|+
name|error
operator|.
name|getEntityType
argument_list|()
operator|+
literal|":"
operator|+
name|error
operator|.
name|getEntityId
argument_list|()
operator|+
literal|"] is not successfully put. Error code: "
operator|+
name|error
operator|.
name|getErrorCode
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|type
operator|.
name|equals
argument_list|(
name|DOMAIN_DATA_TYPE
argument_list|)
condition|)
block|{
name|boolean
name|hasError
init|=
literal|false
decl_stmt|;
for|for
control|(
name|TimelineDomain
name|domain
range|:
name|domains
operator|.
name|getDomains
argument_list|()
control|)
block|{
try|try
block|{
name|client
operator|.
name|putDomain
argument_list|(
name|domain
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Error when putting domain "
operator|+
name|domain
operator|.
name|getId
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|hasError
operator|=
literal|true
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|hasError
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Timeline domains are successfully put"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
catch|catch
parameter_list|(
name|RuntimeException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Error when putting the timeline data"
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Error when putting the timeline data"
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|client
operator|.
name|stop
argument_list|()
expr_stmt|;
block|}
block|}
comment|/**    * Helper function to print out usage    */
DECL|method|printUsage ()
specifier|private
specifier|static
name|void
name|printUsage
parameter_list|()
block|{
operator|new
name|HelpFormatter
argument_list|()
operator|.
name|printHelp
argument_list|(
literal|"TimelineClient"
argument_list|,
name|opts
argument_list|)
expr_stmt|;
block|}
annotation|@
name|VisibleForTesting
annotation|@
name|Private
DECL|method|getUgi ()
specifier|public
name|UserGroupInformation
name|getUgi
parameter_list|()
block|{
return|return
name|authUgi
return|;
block|}
annotation|@
name|Override
DECL|method|putEntities (ApplicationAttemptId appAttemptId, TimelineEntityGroupId groupId, TimelineEntity... entities)
specifier|public
name|TimelinePutResponse
name|putEntities
parameter_list|(
name|ApplicationAttemptId
name|appAttemptId
parameter_list|,
name|TimelineEntityGroupId
name|groupId
parameter_list|,
name|TimelineEntity
modifier|...
name|entities
parameter_list|)
throws|throws
name|IOException
throws|,
name|YarnException
block|{
if|if
condition|(
name|Float
operator|.
name|compare
argument_list|(
name|this
operator|.
name|timelineServiceVersion
argument_list|,
literal|1.5f
argument_list|)
operator|!=
literal|0
condition|)
block|{
throw|throw
operator|new
name|YarnException
argument_list|(
literal|"This API is not supported under current Timeline Service Version: "
operator|+
name|timelineServiceVersion
argument_list|)
throw|;
block|}
return|return
name|timelineWriter
operator|.
name|putEntities
argument_list|(
name|appAttemptId
argument_list|,
name|groupId
argument_list|,
name|entities
argument_list|)
return|;
block|}
annotation|@
name|Override
DECL|method|putDomain (ApplicationAttemptId appAttemptId, TimelineDomain domain)
specifier|public
name|void
name|putDomain
parameter_list|(
name|ApplicationAttemptId
name|appAttemptId
parameter_list|,
name|TimelineDomain
name|domain
parameter_list|)
throws|throws
name|IOException
throws|,
name|YarnException
block|{
if|if
condition|(
name|Float
operator|.
name|compare
argument_list|(
name|this
operator|.
name|timelineServiceVersion
argument_list|,
literal|1.5f
argument_list|)
operator|!=
literal|0
condition|)
block|{
throw|throw
operator|new
name|YarnException
argument_list|(
literal|"This API is not supported under current Timeline Service Version: "
operator|+
name|timelineServiceVersion
argument_list|)
throw|;
block|}
name|timelineWriter
operator|.
name|putDomain
argument_list|(
name|appAttemptId
argument_list|,
name|domain
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Private
annotation|@
name|VisibleForTesting
DECL|method|setTimelineWriter (TimelineWriter writer)
specifier|public
name|void
name|setTimelineWriter
parameter_list|(
name|TimelineWriter
name|writer
parameter_list|)
block|{
name|this
operator|.
name|timelineWriter
operator|=
name|writer
expr_stmt|;
block|}
annotation|@
name|Private
annotation|@
name|VisibleForTesting
specifier|public
name|TimelineClientRetryOp
DECL|method|createTimelineClientRetryOpForOperateDelegationToken ( final PrivilegedExceptionAction<?> action)
name|createTimelineClientRetryOpForOperateDelegationToken
parameter_list|(
specifier|final
name|PrivilegedExceptionAction
argument_list|<
name|?
argument_list|>
name|action
parameter_list|)
throws|throws
name|IOException
block|{
return|return
operator|new
name|TimelineClientRetryOpForOperateDelegationToken
argument_list|(
name|this
operator|.
name|authUgi
argument_list|,
name|action
argument_list|)
return|;
block|}
annotation|@
name|Private
annotation|@
name|VisibleForTesting
DECL|class|TimelineClientRetryOpForOperateDelegationToken
specifier|public
class|class
name|TimelineClientRetryOpForOperateDelegationToken
extends|extends
name|TimelineClientRetryOp
block|{
DECL|field|authUgi
specifier|private
specifier|final
name|UserGroupInformation
name|authUgi
decl_stmt|;
DECL|field|action
specifier|private
specifier|final
name|PrivilegedExceptionAction
argument_list|<
name|?
argument_list|>
name|action
decl_stmt|;
DECL|method|TimelineClientRetryOpForOperateDelegationToken ( UserGroupInformation authUgi, PrivilegedExceptionAction<?> action)
specifier|public
name|TimelineClientRetryOpForOperateDelegationToken
parameter_list|(
name|UserGroupInformation
name|authUgi
parameter_list|,
name|PrivilegedExceptionAction
argument_list|<
name|?
argument_list|>
name|action
parameter_list|)
block|{
name|this
operator|.
name|authUgi
operator|=
name|authUgi
expr_stmt|;
name|this
operator|.
name|action
operator|=
name|action
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|run ()
specifier|public
name|Object
name|run
parameter_list|()
throws|throws
name|IOException
block|{
comment|// Try pass the request, if fail, keep retrying
name|authUgi
operator|.
name|checkTGTAndReloginFromKeytab
argument_list|()
expr_stmt|;
try|try
block|{
return|return
name|authUgi
operator|.
name|doAs
argument_list|(
name|action
argument_list|)
return|;
block|}
catch|catch
parameter_list|(
name|UndeclaredThrowableException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
name|e
operator|.
name|getCause
argument_list|()
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
annotation|@
name|Override
DECL|method|shouldRetryOn (Exception e)
specifier|public
name|boolean
name|shouldRetryOn
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
comment|// retry on connection exceptions
comment|// and SocketTimeoutException
return|return
operator|(
name|e
operator|instanceof
name|ConnectException
operator|||
name|e
operator|instanceof
name|SocketTimeoutException
operator|)
return|;
block|}
block|}
DECL|class|EntitiesHolder
specifier|private
specifier|final
class|class
name|EntitiesHolder
extends|extends
name|FutureTask
argument_list|<
name|Void
argument_list|>
block|{
specifier|private
specifier|final
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|timelineservice
operator|.
name|TimelineEntities
DECL|field|entities
name|entities
decl_stmt|;
DECL|field|isSync
specifier|private
specifier|final
name|boolean
name|isSync
decl_stmt|;
DECL|method|EntitiesHolder ( final org.apache.hadoop.yarn.api.records.timelineservice.TimelineEntities entities, final boolean isSync)
name|EntitiesHolder
parameter_list|(
specifier|final
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|timelineservice
operator|.
name|TimelineEntities
name|entities
parameter_list|,
specifier|final
name|boolean
name|isSync
parameter_list|)
block|{
name|super
argument_list|(
operator|new
name|Callable
argument_list|<
name|Void
argument_list|>
argument_list|()
block|{
comment|// publishEntities()
specifier|public
name|Void
name|call
parameter_list|()
throws|throws
name|Exception
block|{
name|MultivaluedMap
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|params
init|=
operator|new
name|MultivaluedMapImpl
argument_list|()
decl_stmt|;
name|params
operator|.
name|add
argument_list|(
literal|"appid"
argument_list|,
name|getContextAppId
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
literal|"async"
argument_list|,
name|Boolean
operator|.
name|toString
argument_list|(
operator|!
name|isSync
argument_list|)
argument_list|)
expr_stmt|;
name|putObjects
argument_list|(
literal|"entities"
argument_list|,
name|params
argument_list|,
name|entities
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
block|}
argument_list|)
expr_stmt|;
name|this
operator|.
name|entities
operator|=
name|entities
expr_stmt|;
name|this
operator|.
name|isSync
operator|=
name|isSync
expr_stmt|;
block|}
DECL|method|isSync ()
specifier|public
name|boolean
name|isSync
parameter_list|()
block|{
return|return
name|isSync
return|;
block|}
specifier|public
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|timelineservice
operator|.
name|TimelineEntities
DECL|method|getEntities ()
name|getEntities
parameter_list|()
block|{
return|return
name|entities
return|;
block|}
block|}
comment|/**    * This class is responsible for collecting the timeline entities and    * publishing them in async.    */
DECL|class|TimelineEntityDispatcher
specifier|private
class|class
name|TimelineEntityDispatcher
block|{
comment|/**      * Time period for which the timelineclient will wait for draining after      * stop.      */
DECL|field|DRAIN_TIME_PERIOD
specifier|private
specifier|static
specifier|final
name|long
name|DRAIN_TIME_PERIOD
init|=
literal|2000L
decl_stmt|;
DECL|field|numberOfAsyncsToMerge
specifier|private
name|int
name|numberOfAsyncsToMerge
decl_stmt|;
DECL|field|timelineEntityQueue
specifier|private
specifier|final
name|BlockingQueue
argument_list|<
name|EntitiesHolder
argument_list|>
name|timelineEntityQueue
decl_stmt|;
DECL|field|executor
specifier|private
name|ExecutorService
name|executor
decl_stmt|;
DECL|method|TimelineEntityDispatcher (Configuration conf)
name|TimelineEntityDispatcher
parameter_list|(
name|Configuration
name|conf
parameter_list|)
block|{
name|timelineEntityQueue
operator|=
operator|new
name|LinkedBlockingQueue
argument_list|<
name|EntitiesHolder
argument_list|>
argument_list|()
expr_stmt|;
name|numberOfAsyncsToMerge
operator|=
name|conf
operator|.
name|getInt
argument_list|(
name|YarnConfiguration
operator|.
name|NUMBER_OF_ASYNC_ENTITIES_TO_MERGE
argument_list|,
name|YarnConfiguration
operator|.
name|DEFAULT_NUMBER_OF_ASYNC_ENTITIES_TO_MERGE
argument_list|)
expr_stmt|;
block|}
DECL|method|createRunnable ()
name|Runnable
name|createRunnable
parameter_list|()
block|{
return|return
operator|new
name|Runnable
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|run
parameter_list|()
block|{
try|try
block|{
name|EntitiesHolder
name|entitiesHolder
decl_stmt|;
while|while
condition|(
operator|!
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|isInterrupted
argument_list|()
condition|)
block|{
comment|// Merge all the async calls and make one push, but if its sync
comment|// call push immediately
try|try
block|{
name|entitiesHolder
operator|=
name|timelineEntityQueue
operator|.
name|take
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|ie
parameter_list|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Timeline dispatcher thread was interrupted "
argument_list|)
expr_stmt|;
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|interrupt
argument_list|()
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|entitiesHolder
operator|!=
literal|null
condition|)
block|{
name|publishWithoutBlockingOnQueue
argument_list|(
name|entitiesHolder
argument_list|)
expr_stmt|;
block|}
block|}
block|}
finally|finally
block|{
if|if
condition|(
operator|!
name|timelineEntityQueue
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Yet to publish "
operator|+
name|timelineEntityQueue
operator|.
name|size
argument_list|()
operator|+
literal|" timelineEntities, draining them now. "
argument_list|)
expr_stmt|;
block|}
comment|// Try to drain the remaining entities to be published @ the max for
comment|// 2 seconds
name|long
name|timeTillweDrain
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|+
name|DRAIN_TIME_PERIOD
decl_stmt|;
while|while
condition|(
operator|!
name|timelineEntityQueue
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|publishWithoutBlockingOnQueue
argument_list|(
name|timelineEntityQueue
operator|.
name|poll
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|>
name|timeTillweDrain
condition|)
block|{
comment|// time elapsed stop publishing further....
if|if
condition|(
operator|!
name|timelineEntityQueue
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Time to drain elapsed! Remaining "
operator|+
name|timelineEntityQueue
operator|.
name|size
argument_list|()
operator|+
literal|"timelineEntities will not"
operator|+
literal|" be published"
argument_list|)
expr_stmt|;
comment|// if some entities were not drained then we need interrupt
comment|// the threads which had put sync EntityHolders to the queue.
name|EntitiesHolder
name|nextEntityInTheQueue
init|=
literal|null
decl_stmt|;
while|while
condition|(
operator|(
name|nextEntityInTheQueue
operator|=
name|timelineEntityQueue
operator|.
name|poll
argument_list|()
operator|)
operator|!=
literal|null
condition|)
block|{
name|nextEntityInTheQueue
operator|.
name|cancel
argument_list|(
literal|true
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
block|}
block|}
block|}
block|}
comment|/**          * Publishes the given EntitiesHolder and return immediately if sync          * call, else tries to fetch the EntitiesHolder from the queue in non          * blocking fashion and collate the Entities if possible before          * publishing through REST.          *          * @param entitiesHolder          */
specifier|private
name|void
name|publishWithoutBlockingOnQueue
parameter_list|(
name|EntitiesHolder
name|entitiesHolder
parameter_list|)
block|{
if|if
condition|(
name|entitiesHolder
operator|.
name|isSync
argument_list|()
condition|)
block|{
name|entitiesHolder
operator|.
name|run
argument_list|()
expr_stmt|;
return|return;
block|}
name|int
name|count
init|=
literal|1
decl_stmt|;
while|while
condition|(
literal|true
condition|)
block|{
comment|// loop till we find a sync put Entities or there is nothing
comment|// to take
name|EntitiesHolder
name|nextEntityInTheQueue
init|=
name|timelineEntityQueue
operator|.
name|poll
argument_list|()
decl_stmt|;
if|if
condition|(
name|nextEntityInTheQueue
operator|==
literal|null
condition|)
block|{
comment|// Nothing in the queue just publish and get back to the
comment|// blocked wait state
name|entitiesHolder
operator|.
name|run
argument_list|()
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|nextEntityInTheQueue
operator|.
name|isSync
argument_list|()
condition|)
block|{
comment|// flush all the prev async entities first
name|entitiesHolder
operator|.
name|run
argument_list|()
expr_stmt|;
comment|// and then flush the sync entity
name|nextEntityInTheQueue
operator|.
name|run
argument_list|()
expr_stmt|;
break|break;
block|}
else|else
block|{
comment|// append all async entities together and then flush
name|entitiesHolder
operator|.
name|getEntities
argument_list|()
operator|.
name|addEntities
argument_list|(
name|nextEntityInTheQueue
operator|.
name|getEntities
argument_list|()
operator|.
name|getEntities
argument_list|()
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
if|if
condition|(
name|count
operator|==
name|numberOfAsyncsToMerge
condition|)
block|{
comment|// Flush the entities if the number of the async
comment|// putEntites merged reaches the desired limit. To avoid
comment|// collecting multiple entities and delaying for a long
comment|// time.
name|entitiesHolder
operator|.
name|run
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
block|}
return|;
block|}
DECL|method|dispatchEntities (boolean sync, org.apache.hadoop.yarn.api.records.timelineservice.TimelineEntity[] entitiesTobePublished)
specifier|public
name|void
name|dispatchEntities
parameter_list|(
name|boolean
name|sync
parameter_list|,
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|timelineservice
operator|.
name|TimelineEntity
index|[]
name|entitiesTobePublished
parameter_list|)
throws|throws
name|YarnException
block|{
if|if
condition|(
name|executor
operator|.
name|isShutdown
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|YarnException
argument_list|(
literal|"Timeline client is in the process of stopping,"
operator|+
literal|" not accepting any more TimelineEntities"
argument_list|)
throw|;
block|}
comment|// wrap all TimelineEntity into TimelineEntities object
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|timelineservice
operator|.
name|TimelineEntities
name|entities
init|=
operator|new
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|timelineservice
operator|.
name|TimelineEntities
argument_list|()
decl_stmt|;
for|for
control|(
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|timelineservice
operator|.
name|TimelineEntity
name|entity
range|:
name|entitiesTobePublished
control|)
block|{
name|entities
operator|.
name|addEntity
argument_list|(
name|entity
argument_list|)
expr_stmt|;
block|}
comment|// created a holder and place it in queue
name|EntitiesHolder
name|entitiesHolder
init|=
operator|new
name|EntitiesHolder
argument_list|(
name|entities
argument_list|,
name|sync
argument_list|)
decl_stmt|;
try|try
block|{
name|timelineEntityQueue
operator|.
name|put
argument_list|(
name|entitiesHolder
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|e
parameter_list|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|interrupt
argument_list|()
expr_stmt|;
throw|throw
operator|new
name|YarnException
argument_list|(
literal|"Failed while adding entity to the queue for publishing"
argument_list|,
name|e
argument_list|)
throw|;
block|}
if|if
condition|(
name|sync
condition|)
block|{
comment|// In sync call we need to wait till its published and if any error then
comment|// throw it back
try|try
block|{
name|entitiesHolder
operator|.
name|get
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|ExecutionException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|YarnException
argument_list|(
literal|"Failed while publishing entity"
argument_list|,
name|e
operator|.
name|getCause
argument_list|()
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|e
parameter_list|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|interrupt
argument_list|()
expr_stmt|;
throw|throw
operator|new
name|YarnException
argument_list|(
literal|"Interrupted while publishing entity"
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
block|}
DECL|method|start ()
specifier|public
name|void
name|start
parameter_list|()
block|{
name|executor
operator|=
name|Executors
operator|.
name|newSingleThreadExecutor
argument_list|()
expr_stmt|;
name|executor
operator|.
name|execute
argument_list|(
name|createRunnable
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|stop ()
specifier|public
name|void
name|stop
parameter_list|()
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Stopping TimelineClient."
argument_list|)
expr_stmt|;
name|executor
operator|.
name|shutdownNow
argument_list|()
expr_stmt|;
try|try
block|{
name|executor
operator|.
name|awaitTermination
argument_list|(
name|DRAIN_TIME_PERIOD
argument_list|,
name|TimeUnit
operator|.
name|MILLISECONDS
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|e
parameter_list|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|interrupt
argument_list|()
expr_stmt|;
name|e
operator|.
name|printStackTrace
argument_list|()
expr_stmt|;
block|}
block|}
block|}
block|}
end_class

end_unit

