begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  * Licensed to the Apache Software Foundation (ASF) under one  * or more contributor license agreements.  See the NOTICE file  * distributed with this work for additional information  * regarding copyright ownership.  The ASF licenses this file  * to you under the Apache License, Version 2.0 (the  * "License"); you may not use this file except in compliance  * with the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
DECL|package|org.apache.hadoop.yarn.service.utils
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|service
operator|.
name|utils
package|;
end_package

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|annotations
operator|.
name|VisibleForTesting
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|ArrayListMultimap
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|Multimap
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|lang
operator|.
name|StringUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|FileSystem
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|Path
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|permission
operator|.
name|FsPermission
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|registry
operator|.
name|client
operator|.
name|api
operator|.
name|RegistryConstants
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|registry
operator|.
name|client
operator|.
name|binding
operator|.
name|RegistryUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|UserGroupInformation
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|exceptions
operator|.
name|YarnException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|service
operator|.
name|api
operator|.
name|records
operator|.
name|Container
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|service
operator|.
name|api
operator|.
name|records
operator|.
name|Service
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|service
operator|.
name|api
operator|.
name|records
operator|.
name|Artifact
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|service
operator|.
name|api
operator|.
name|records
operator|.
name|Component
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|service
operator|.
name|api
operator|.
name|records
operator|.
name|Configuration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|service
operator|.
name|api
operator|.
name|records
operator|.
name|PlacementConstraint
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|service
operator|.
name|api
operator|.
name|records
operator|.
name|Resource
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|service
operator|.
name|exceptions
operator|.
name|SliderException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|service
operator|.
name|conf
operator|.
name|RestApiConstants
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|service
operator|.
name|exceptions
operator|.
name|RestApiErrorMessages
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|service
operator|.
name|monitor
operator|.
name|probe
operator|.
name|MonitorUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|service
operator|.
name|provider
operator|.
name|AbstractClientProvider
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|service
operator|.
name|provider
operator|.
name|ProviderFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|codehaus
operator|.
name|jackson
operator|.
name|map
operator|.
name|PropertyNamingStrategy
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|Logger
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|LoggerFactory
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URI
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URISyntaxException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collection
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashSet
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|LinkedHashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Set
import|;
end_import

begin_class
DECL|class|ServiceApiUtil
specifier|public
class|class
name|ServiceApiUtil
block|{
DECL|field|LOG
specifier|private
specifier|static
specifier|final
name|Logger
name|LOG
init|=
name|LoggerFactory
operator|.
name|getLogger
argument_list|(
name|ServiceApiUtil
operator|.
name|class
argument_list|)
decl_stmt|;
DECL|field|jsonSerDeser
specifier|public
specifier|static
name|JsonSerDeser
argument_list|<
name|Service
argument_list|>
name|jsonSerDeser
init|=
operator|new
name|JsonSerDeser
argument_list|<>
argument_list|(
name|Service
operator|.
name|class
argument_list|,
name|PropertyNamingStrategy
operator|.
name|CAMEL_CASE_TO_LOWER_CASE_WITH_UNDERSCORES
argument_list|)
decl_stmt|;
DECL|field|namePattern
specifier|private
specifier|static
specifier|final
name|PatternValidator
name|namePattern
init|=
operator|new
name|PatternValidator
argument_list|(
literal|"[a-z][a-z0-9-]*"
argument_list|)
decl_stmt|;
DECL|field|userNamePattern
specifier|private
specifier|static
specifier|final
name|PatternValidator
name|userNamePattern
init|=
operator|new
name|PatternValidator
argument_list|(
literal|"[a-z][a-z0-9-.]*"
argument_list|)
decl_stmt|;
annotation|@
name|VisibleForTesting
DECL|method|setJsonSerDeser (JsonSerDeser jsd)
specifier|public
specifier|static
name|void
name|setJsonSerDeser
parameter_list|(
name|JsonSerDeser
name|jsd
parameter_list|)
block|{
name|jsonSerDeser
operator|=
name|jsd
expr_stmt|;
block|}
annotation|@
name|VisibleForTesting
DECL|method|validateAndResolveService (Service service, SliderFileSystem fs, org.apache.hadoop.conf.Configuration conf)
specifier|public
specifier|static
name|void
name|validateAndResolveService
parameter_list|(
name|Service
name|service
parameter_list|,
name|SliderFileSystem
name|fs
parameter_list|,
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|conf
operator|.
name|Configuration
name|conf
parameter_list|)
throws|throws
name|IOException
block|{
name|boolean
name|dnsEnabled
init|=
name|conf
operator|.
name|getBoolean
argument_list|(
name|RegistryConstants
operator|.
name|KEY_DNS_ENABLED
argument_list|,
name|RegistryConstants
operator|.
name|DEFAULT_DNS_ENABLED
argument_list|)
decl_stmt|;
if|if
condition|(
name|dnsEnabled
condition|)
block|{
if|if
condition|(
name|RegistryUtils
operator|.
name|currentUser
argument_list|()
operator|.
name|length
argument_list|()
operator|>
name|RegistryConstants
operator|.
name|MAX_FQDN_LABEL_LENGTH
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
name|RestApiErrorMessages
operator|.
name|ERROR_USER_NAME_INVALID
argument_list|)
throw|;
block|}
name|userNamePattern
operator|.
name|validate
argument_list|(
name|RegistryUtils
operator|.
name|currentUser
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|StringUtils
operator|.
name|isEmpty
argument_list|(
name|service
operator|.
name|getName
argument_list|()
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
name|RestApiErrorMessages
operator|.
name|ERROR_APPLICATION_NAME_INVALID
argument_list|)
throw|;
block|}
if|if
condition|(
name|StringUtils
operator|.
name|isEmpty
argument_list|(
name|service
operator|.
name|getVersion
argument_list|()
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
name|String
operator|.
name|format
argument_list|(
name|RestApiErrorMessages
operator|.
name|ERROR_APPLICATION_VERSION_INVALID
argument_list|,
name|service
operator|.
name|getName
argument_list|()
argument_list|)
argument_list|)
throw|;
block|}
name|validateNameFormat
argument_list|(
name|service
operator|.
name|getName
argument_list|()
argument_list|,
name|conf
argument_list|)
expr_stmt|;
comment|// If the service has no components, throw error
if|if
condition|(
operator|!
name|hasComponent
argument_list|(
name|service
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"No component specified for "
operator|+
name|service
operator|.
name|getName
argument_list|()
argument_list|)
throw|;
block|}
if|if
condition|(
name|UserGroupInformation
operator|.
name|isSecurityEnabled
argument_list|()
condition|)
block|{
if|if
condition|(
operator|!
name|StringUtils
operator|.
name|isEmpty
argument_list|(
name|service
operator|.
name|getKerberosPrincipal
argument_list|()
operator|.
name|getKeytab
argument_list|()
argument_list|)
condition|)
block|{
try|try
block|{
comment|// validate URI format
operator|new
name|URI
argument_list|(
name|service
operator|.
name|getKerberosPrincipal
argument_list|()
operator|.
name|getKeytab
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|URISyntaxException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
block|}
comment|// Validate the Docker client config.
try|try
block|{
name|validateDockerClientConfiguration
argument_list|(
name|service
argument_list|,
name|conf
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
name|e
argument_list|)
throw|;
block|}
comment|// Validate there are no component name collisions (collisions are not
comment|// currently supported) and add any components from external services
name|Configuration
name|globalConf
init|=
name|service
operator|.
name|getConfiguration
argument_list|()
decl_stmt|;
name|Set
argument_list|<
name|String
argument_list|>
name|componentNames
init|=
operator|new
name|HashSet
argument_list|<>
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|Component
argument_list|>
name|componentsToRemove
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|Component
argument_list|>
name|componentsToAdd
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
for|for
control|(
name|Component
name|comp
range|:
name|service
operator|.
name|getComponents
argument_list|()
control|)
block|{
name|int
name|maxCompLength
init|=
name|RegistryConstants
operator|.
name|MAX_FQDN_LABEL_LENGTH
decl_stmt|;
name|maxCompLength
operator|=
name|maxCompLength
operator|-
name|Long
operator|.
name|toString
argument_list|(
name|Long
operator|.
name|MAX_VALUE
argument_list|)
operator|.
name|length
argument_list|()
expr_stmt|;
if|if
condition|(
name|dnsEnabled
operator|&&
name|comp
operator|.
name|getName
argument_list|()
operator|.
name|length
argument_list|()
operator|>
name|maxCompLength
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
name|String
operator|.
name|format
argument_list|(
name|RestApiErrorMessages
operator|.
name|ERROR_COMPONENT_NAME_INVALID
argument_list|,
name|maxCompLength
argument_list|,
name|comp
operator|.
name|getName
argument_list|()
argument_list|)
argument_list|)
throw|;
block|}
if|if
condition|(
name|componentNames
operator|.
name|contains
argument_list|(
name|comp
operator|.
name|getName
argument_list|()
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"Component name collision: "
operator|+
name|comp
operator|.
name|getName
argument_list|()
argument_list|)
throw|;
block|}
comment|// If artifact is of type SERVICE (which cannot be filled from
comment|// global), read external service and add its components to this
comment|// service
if|if
condition|(
name|comp
operator|.
name|getArtifact
argument_list|()
operator|!=
literal|null
operator|&&
name|comp
operator|.
name|getArtifact
argument_list|()
operator|.
name|getType
argument_list|()
operator|==
name|Artifact
operator|.
name|TypeEnum
operator|.
name|SERVICE
condition|)
block|{
if|if
condition|(
name|StringUtils
operator|.
name|isEmpty
argument_list|(
name|comp
operator|.
name|getArtifact
argument_list|()
operator|.
name|getId
argument_list|()
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
name|RestApiErrorMessages
operator|.
name|ERROR_ARTIFACT_ID_INVALID
argument_list|)
throw|;
block|}
name|LOG
operator|.
name|info
argument_list|(
literal|"Marking {} for removal"
argument_list|,
name|comp
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|componentsToRemove
operator|.
name|add
argument_list|(
name|comp
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|Component
argument_list|>
name|externalComponents
init|=
name|getComponents
argument_list|(
name|fs
argument_list|,
name|comp
operator|.
name|getArtifact
argument_list|()
operator|.
name|getId
argument_list|()
argument_list|)
decl_stmt|;
for|for
control|(
name|Component
name|c
range|:
name|externalComponents
control|)
block|{
name|Component
name|override
init|=
name|service
operator|.
name|getComponent
argument_list|(
name|c
operator|.
name|getName
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|override
operator|!=
literal|null
operator|&&
name|override
operator|.
name|getArtifact
argument_list|()
operator|==
literal|null
condition|)
block|{
comment|// allow properties from external components to be overridden /
comment|// augmented by properties in this component, except for artifact
comment|// which must be read from external component
name|override
operator|.
name|mergeFrom
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Merging external component {} from external {}"
argument_list|,
name|c
operator|.
name|getName
argument_list|()
argument_list|,
name|comp
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|componentNames
operator|.
name|contains
argument_list|(
name|c
operator|.
name|getName
argument_list|()
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"Component name collision: "
operator|+
name|c
operator|.
name|getName
argument_list|()
argument_list|)
throw|;
block|}
name|componentNames
operator|.
name|add
argument_list|(
name|c
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|componentsToAdd
operator|.
name|add
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Adding component {} from external {}"
argument_list|,
name|c
operator|.
name|getName
argument_list|()
argument_list|,
name|comp
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
comment|// otherwise handle as a normal component
name|componentNames
operator|.
name|add
argument_list|(
name|comp
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
comment|// configuration
name|comp
operator|.
name|getConfiguration
argument_list|()
operator|.
name|mergeFrom
argument_list|(
name|globalConf
argument_list|)
expr_stmt|;
block|}
block|}
name|service
operator|.
name|getComponents
argument_list|()
operator|.
name|removeAll
argument_list|(
name|componentsToRemove
argument_list|)
expr_stmt|;
name|service
operator|.
name|getComponents
argument_list|()
operator|.
name|addAll
argument_list|(
name|componentsToAdd
argument_list|)
expr_stmt|;
comment|// Validate components and let global values take effect if component level
comment|// values are not provided
name|Artifact
name|globalArtifact
init|=
name|service
operator|.
name|getArtifact
argument_list|()
decl_stmt|;
name|Resource
name|globalResource
init|=
name|service
operator|.
name|getResource
argument_list|()
decl_stmt|;
for|for
control|(
name|Component
name|comp
range|:
name|service
operator|.
name|getComponents
argument_list|()
control|)
block|{
comment|// fill in global artifact unless it is type SERVICE
if|if
condition|(
name|comp
operator|.
name|getArtifact
argument_list|()
operator|==
literal|null
operator|&&
name|service
operator|.
name|getArtifact
argument_list|()
operator|!=
literal|null
operator|&&
name|service
operator|.
name|getArtifact
argument_list|()
operator|.
name|getType
argument_list|()
operator|!=
name|Artifact
operator|.
name|TypeEnum
operator|.
name|SERVICE
condition|)
block|{
name|comp
operator|.
name|setArtifact
argument_list|(
name|globalArtifact
argument_list|)
expr_stmt|;
block|}
comment|// fill in global resource
if|if
condition|(
name|comp
operator|.
name|getResource
argument_list|()
operator|==
literal|null
condition|)
block|{
name|comp
operator|.
name|setResource
argument_list|(
name|globalResource
argument_list|)
expr_stmt|;
block|}
comment|// validate dependency existence
if|if
condition|(
name|comp
operator|.
name|getDependencies
argument_list|()
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|String
name|dependency
range|:
name|comp
operator|.
name|getDependencies
argument_list|()
control|)
block|{
if|if
condition|(
operator|!
name|componentNames
operator|.
name|contains
argument_list|(
name|dependency
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
name|String
operator|.
name|format
argument_list|(
name|RestApiErrorMessages
operator|.
name|ERROR_DEPENDENCY_INVALID
argument_list|,
name|dependency
argument_list|,
name|comp
operator|.
name|getName
argument_list|()
argument_list|)
argument_list|)
throw|;
block|}
block|}
block|}
name|validateComponent
argument_list|(
name|comp
argument_list|,
name|fs
operator|.
name|getFileSystem
argument_list|()
argument_list|,
name|conf
argument_list|)
expr_stmt|;
block|}
name|validatePlacementPolicy
argument_list|(
name|service
operator|.
name|getComponents
argument_list|()
argument_list|,
name|componentNames
argument_list|)
expr_stmt|;
comment|// validate dependency tree
name|sortByDependencies
argument_list|(
name|service
operator|.
name|getComponents
argument_list|()
argument_list|)
expr_stmt|;
comment|// Service lifetime if not specified, is set to unlimited lifetime
if|if
condition|(
name|service
operator|.
name|getLifetime
argument_list|()
operator|==
literal|null
condition|)
block|{
name|service
operator|.
name|setLifetime
argument_list|(
name|RestApiConstants
operator|.
name|DEFAULT_UNLIMITED_LIFETIME
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|validateDockerClientConfiguration (Service service, org.apache.hadoop.conf.Configuration conf)
specifier|private
specifier|static
name|void
name|validateDockerClientConfiguration
parameter_list|(
name|Service
name|service
parameter_list|,
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|conf
operator|.
name|Configuration
name|conf
parameter_list|)
throws|throws
name|IOException
block|{
name|String
name|dockerClientConfig
init|=
name|service
operator|.
name|getDockerClientConfig
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|StringUtils
operator|.
name|isEmpty
argument_list|(
name|dockerClientConfig
argument_list|)
condition|)
block|{
name|Path
name|dockerClientConfigPath
init|=
operator|new
name|Path
argument_list|(
name|dockerClientConfig
argument_list|)
decl_stmt|;
name|FileSystem
name|fs
init|=
name|dockerClientConfigPath
operator|.
name|getFileSystem
argument_list|(
name|conf
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|fs
operator|.
name|exists
argument_list|(
name|dockerClientConfigPath
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"The supplied Docker client config does not exist: "
operator|+
name|dockerClientConfig
argument_list|)
throw|;
block|}
block|}
block|}
DECL|method|validateComponent (Component comp, FileSystem fs, org.apache.hadoop.conf.Configuration conf)
specifier|private
specifier|static
name|void
name|validateComponent
parameter_list|(
name|Component
name|comp
parameter_list|,
name|FileSystem
name|fs
parameter_list|,
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|conf
operator|.
name|Configuration
name|conf
parameter_list|)
throws|throws
name|IOException
block|{
name|validateNameFormat
argument_list|(
name|comp
operator|.
name|getName
argument_list|()
argument_list|,
name|conf
argument_list|)
expr_stmt|;
name|AbstractClientProvider
name|compClientProvider
init|=
name|ProviderFactory
operator|.
name|getClientProvider
argument_list|(
name|comp
operator|.
name|getArtifact
argument_list|()
argument_list|)
decl_stmt|;
name|compClientProvider
operator|.
name|validateArtifact
argument_list|(
name|comp
operator|.
name|getArtifact
argument_list|()
argument_list|,
name|fs
argument_list|)
expr_stmt|;
if|if
condition|(
name|comp
operator|.
name|getLaunchCommand
argument_list|()
operator|==
literal|null
operator|&&
operator|(
name|comp
operator|.
name|getArtifact
argument_list|()
operator|==
literal|null
operator|||
name|comp
operator|.
name|getArtifact
argument_list|()
operator|.
name|getType
argument_list|()
operator|!=
name|Artifact
operator|.
name|TypeEnum
operator|.
name|DOCKER
operator|)
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
name|RestApiErrorMessages
operator|.
name|ERROR_ABSENT_LAUNCH_COMMAND
argument_list|)
throw|;
block|}
name|validateServiceResource
argument_list|(
name|comp
operator|.
name|getResource
argument_list|()
argument_list|,
name|comp
argument_list|)
expr_stmt|;
if|if
condition|(
name|comp
operator|.
name|getNumberOfContainers
argument_list|()
operator|==
literal|null
operator|||
name|comp
operator|.
name|getNumberOfContainers
argument_list|()
operator|<
literal|0
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
name|String
operator|.
name|format
argument_list|(
name|RestApiErrorMessages
operator|.
name|ERROR_CONTAINERS_COUNT_FOR_COMP_INVALID
operator|+
literal|": "
operator|+
name|comp
operator|.
name|getNumberOfContainers
argument_list|()
argument_list|,
name|comp
operator|.
name|getName
argument_list|()
argument_list|)
argument_list|)
throw|;
block|}
name|compClientProvider
operator|.
name|validateConfigFiles
argument_list|(
name|comp
operator|.
name|getConfiguration
argument_list|()
operator|.
name|getFiles
argument_list|()
argument_list|,
name|fs
argument_list|)
expr_stmt|;
name|MonitorUtils
operator|.
name|getProbe
argument_list|(
name|comp
operator|.
name|getReadinessCheck
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|// Check component or service name format and transform to lower case.
DECL|method|validateNameFormat (String name, org.apache.hadoop.conf.Configuration conf)
specifier|public
specifier|static
name|void
name|validateNameFormat
parameter_list|(
name|String
name|name
parameter_list|,
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|conf
operator|.
name|Configuration
name|conf
parameter_list|)
block|{
if|if
condition|(
name|StringUtils
operator|.
name|isEmpty
argument_list|(
name|name
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"Name can not be empty!"
argument_list|)
throw|;
block|}
comment|// validate component name
if|if
condition|(
name|name
operator|.
name|contains
argument_list|(
literal|"_"
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"Invalid format: "
operator|+
name|name
operator|+
literal|", can not use '_', as DNS hostname does not allow '_'. Use '-' Instead. "
argument_list|)
throw|;
block|}
name|boolean
name|dnsEnabled
init|=
name|conf
operator|.
name|getBoolean
argument_list|(
name|RegistryConstants
operator|.
name|KEY_DNS_ENABLED
argument_list|,
name|RegistryConstants
operator|.
name|DEFAULT_DNS_ENABLED
argument_list|)
decl_stmt|;
if|if
condition|(
name|dnsEnabled
operator|&&
name|name
operator|.
name|length
argument_list|()
operator|>
name|RegistryConstants
operator|.
name|MAX_FQDN_LABEL_LENGTH
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"Invalid format %s, must be no more than 63 characters "
argument_list|,
name|name
argument_list|)
argument_list|)
throw|;
block|}
name|namePattern
operator|.
name|validate
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
DECL|method|validatePlacementPolicy (List<Component> components, Set<String> componentNames)
specifier|private
specifier|static
name|void
name|validatePlacementPolicy
parameter_list|(
name|List
argument_list|<
name|Component
argument_list|>
name|components
parameter_list|,
name|Set
argument_list|<
name|String
argument_list|>
name|componentNames
parameter_list|)
block|{
for|for
control|(
name|Component
name|comp
range|:
name|components
control|)
block|{
if|if
condition|(
name|comp
operator|.
name|getPlacementPolicy
argument_list|()
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|PlacementConstraint
name|constraint
range|:
name|comp
operator|.
name|getPlacementPolicy
argument_list|()
operator|.
name|getConstraints
argument_list|()
control|)
block|{
for|for
control|(
name|String
name|targetTag
range|:
name|constraint
operator|.
name|getTargetTags
argument_list|()
control|)
block|{
if|if
condition|(
operator|!
name|comp
operator|.
name|getName
argument_list|()
operator|.
name|equals
argument_list|(
name|targetTag
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
name|String
operator|.
name|format
argument_list|(
name|RestApiErrorMessages
operator|.
name|ERROR_PLACEMENT_POLICY_TAG_NAME_NOT_SAME
argument_list|,
name|targetTag
argument_list|,
name|comp
operator|.
name|getName
argument_list|()
argument_list|,
name|comp
operator|.
name|getName
argument_list|()
argument_list|,
name|comp
operator|.
name|getName
argument_list|()
argument_list|)
argument_list|)
throw|;
block|}
block|}
block|}
block|}
block|}
block|}
annotation|@
name|VisibleForTesting
DECL|method|getComponents (SliderFileSystem fs, String serviceName)
specifier|public
specifier|static
name|List
argument_list|<
name|Component
argument_list|>
name|getComponents
parameter_list|(
name|SliderFileSystem
name|fs
parameter_list|,
name|String
name|serviceName
parameter_list|)
throws|throws
name|IOException
block|{
return|return
name|loadService
argument_list|(
name|fs
argument_list|,
name|serviceName
argument_list|)
operator|.
name|getComponents
argument_list|()
return|;
block|}
DECL|method|loadService (SliderFileSystem fs, String serviceName)
specifier|public
specifier|static
name|Service
name|loadService
parameter_list|(
name|SliderFileSystem
name|fs
parameter_list|,
name|String
name|serviceName
parameter_list|)
throws|throws
name|IOException
block|{
name|Path
name|serviceJson
init|=
name|getServiceJsonPath
argument_list|(
name|fs
argument_list|,
name|serviceName
argument_list|)
decl_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Loading service definition from "
operator|+
name|serviceJson
argument_list|)
expr_stmt|;
return|return
name|jsonSerDeser
operator|.
name|load
argument_list|(
name|fs
operator|.
name|getFileSystem
argument_list|()
argument_list|,
name|serviceJson
argument_list|)
return|;
block|}
DECL|method|loadServiceUpgrade (SliderFileSystem fs, String serviceName, String version)
specifier|public
specifier|static
name|Service
name|loadServiceUpgrade
parameter_list|(
name|SliderFileSystem
name|fs
parameter_list|,
name|String
name|serviceName
parameter_list|,
name|String
name|version
parameter_list|)
throws|throws
name|IOException
block|{
name|Path
name|versionPath
init|=
name|fs
operator|.
name|buildClusterUpgradeDirPath
argument_list|(
name|serviceName
argument_list|,
name|version
argument_list|)
decl_stmt|;
name|Path
name|versionedDef
init|=
operator|new
name|Path
argument_list|(
name|versionPath
argument_list|,
name|serviceName
operator|+
literal|".json"
argument_list|)
decl_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Loading service definition from {}"
argument_list|,
name|versionedDef
argument_list|)
expr_stmt|;
return|return
name|jsonSerDeser
operator|.
name|load
argument_list|(
name|fs
operator|.
name|getFileSystem
argument_list|()
argument_list|,
name|versionedDef
argument_list|)
return|;
block|}
DECL|method|loadServiceFrom (SliderFileSystem fs, Path appDefPath)
specifier|public
specifier|static
name|Service
name|loadServiceFrom
parameter_list|(
name|SliderFileSystem
name|fs
parameter_list|,
name|Path
name|appDefPath
parameter_list|)
throws|throws
name|IOException
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Loading service definition from "
operator|+
name|appDefPath
argument_list|)
expr_stmt|;
return|return
name|jsonSerDeser
operator|.
name|load
argument_list|(
name|fs
operator|.
name|getFileSystem
argument_list|()
argument_list|,
name|appDefPath
argument_list|)
return|;
block|}
DECL|method|getServiceJsonPath (SliderFileSystem fs, String serviceName)
specifier|public
specifier|static
name|Path
name|getServiceJsonPath
parameter_list|(
name|SliderFileSystem
name|fs
parameter_list|,
name|String
name|serviceName
parameter_list|)
block|{
name|Path
name|serviceDir
init|=
name|fs
operator|.
name|buildClusterDirPath
argument_list|(
name|serviceName
argument_list|)
decl_stmt|;
return|return
operator|new
name|Path
argument_list|(
name|serviceDir
argument_list|,
name|serviceName
operator|+
literal|".json"
argument_list|)
return|;
block|}
DECL|method|validateServiceResource (Resource resource, Component comp)
specifier|private
specifier|static
name|void
name|validateServiceResource
parameter_list|(
name|Resource
name|resource
parameter_list|,
name|Component
name|comp
parameter_list|)
block|{
comment|// Only services/components of type SERVICE can skip resource requirement
if|if
condition|(
name|resource
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
name|comp
operator|==
literal|null
condition|?
name|RestApiErrorMessages
operator|.
name|ERROR_RESOURCE_INVALID
else|:
name|String
operator|.
name|format
argument_list|(
name|RestApiErrorMessages
operator|.
name|ERROR_RESOURCE_FOR_COMP_INVALID
argument_list|,
name|comp
operator|.
name|getName
argument_list|()
argument_list|)
argument_list|)
throw|;
block|}
comment|// One and only one of profile OR cpus& memory can be specified. Specifying
comment|// both raises validation error.
if|if
condition|(
name|StringUtils
operator|.
name|isNotEmpty
argument_list|(
name|resource
operator|.
name|getProfile
argument_list|()
argument_list|)
operator|&&
operator|(
name|resource
operator|.
name|getCpus
argument_list|()
operator|!=
literal|null
operator|||
name|StringUtils
operator|.
name|isNotEmpty
argument_list|(
name|resource
operator|.
name|getMemory
argument_list|()
argument_list|)
operator|)
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
name|comp
operator|==
literal|null
condition|?
name|RestApiErrorMessages
operator|.
name|ERROR_RESOURCE_PROFILE_MULTIPLE_VALUES_NOT_SUPPORTED
else|:
name|String
operator|.
name|format
argument_list|(
name|RestApiErrorMessages
operator|.
name|ERROR_RESOURCE_PROFILE_MULTIPLE_VALUES_FOR_COMP_NOT_SUPPORTED
argument_list|,
name|comp
operator|.
name|getName
argument_list|()
argument_list|)
argument_list|)
throw|;
block|}
comment|// Currently resource profile is not supported yet, so we will raise
comment|// validation error if only resource profile is specified
if|if
condition|(
name|StringUtils
operator|.
name|isNotEmpty
argument_list|(
name|resource
operator|.
name|getProfile
argument_list|()
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
name|RestApiErrorMessages
operator|.
name|ERROR_RESOURCE_PROFILE_NOT_SUPPORTED_YET
argument_list|)
throw|;
block|}
name|String
name|memory
init|=
name|resource
operator|.
name|getMemory
argument_list|()
decl_stmt|;
name|Integer
name|cpus
init|=
name|resource
operator|.
name|getCpus
argument_list|()
decl_stmt|;
if|if
condition|(
name|StringUtils
operator|.
name|isEmpty
argument_list|(
name|memory
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
name|comp
operator|==
literal|null
condition|?
name|RestApiErrorMessages
operator|.
name|ERROR_RESOURCE_MEMORY_INVALID
else|:
name|String
operator|.
name|format
argument_list|(
name|RestApiErrorMessages
operator|.
name|ERROR_RESOURCE_MEMORY_FOR_COMP_INVALID
argument_list|,
name|comp
operator|.
name|getName
argument_list|()
argument_list|)
argument_list|)
throw|;
block|}
if|if
condition|(
name|cpus
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
name|comp
operator|==
literal|null
condition|?
name|RestApiErrorMessages
operator|.
name|ERROR_RESOURCE_CPUS_INVALID
else|:
name|String
operator|.
name|format
argument_list|(
name|RestApiErrorMessages
operator|.
name|ERROR_RESOURCE_CPUS_FOR_COMP_INVALID
argument_list|,
name|comp
operator|.
name|getName
argument_list|()
argument_list|)
argument_list|)
throw|;
block|}
if|if
condition|(
name|cpus
operator|<=
literal|0
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
name|comp
operator|==
literal|null
condition|?
name|RestApiErrorMessages
operator|.
name|ERROR_RESOURCE_CPUS_INVALID_RANGE
else|:
name|String
operator|.
name|format
argument_list|(
name|RestApiErrorMessages
operator|.
name|ERROR_RESOURCE_CPUS_FOR_COMP_INVALID_RANGE
argument_list|,
name|comp
operator|.
name|getName
argument_list|()
argument_list|)
argument_list|)
throw|;
block|}
block|}
comment|// check if comp mem size exceeds cluster limit
DECL|method|validateCompResourceSize ( org.apache.hadoop.yarn.api.records.Resource maxResource, Service service)
specifier|public
specifier|static
name|void
name|validateCompResourceSize
parameter_list|(
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|Resource
name|maxResource
parameter_list|,
name|Service
name|service
parameter_list|)
throws|throws
name|YarnException
block|{
for|for
control|(
name|Component
name|component
range|:
name|service
operator|.
name|getComponents
argument_list|()
control|)
block|{
name|long
name|mem
init|=
name|Long
operator|.
name|parseLong
argument_list|(
name|component
operator|.
name|getResource
argument_list|()
operator|.
name|getMemory
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|mem
operator|>
name|maxResource
operator|.
name|getMemorySize
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|YarnException
argument_list|(
literal|"Component "
operator|+
name|component
operator|.
name|getName
argument_list|()
operator|+
literal|": specified memory size ("
operator|+
name|mem
operator|+
literal|") is larger than configured max container memory "
operator|+
literal|"size ("
operator|+
name|maxResource
operator|.
name|getMemorySize
argument_list|()
operator|+
literal|")"
argument_list|)
throw|;
block|}
name|int
name|cpu
init|=
name|component
operator|.
name|getResource
argument_list|()
operator|.
name|getCpus
argument_list|()
decl_stmt|;
if|if
condition|(
name|cpu
operator|>
name|maxResource
operator|.
name|getVirtualCores
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|YarnException
argument_list|(
literal|"Component "
operator|+
name|component
operator|.
name|getName
argument_list|()
operator|+
literal|": specified number of "
operator|+
literal|"virtual core ("
operator|+
name|cpu
operator|+
literal|") is larger than configured max "
operator|+
literal|"virtual core size ("
operator|+
name|maxResource
operator|.
name|getVirtualCores
argument_list|()
operator|+
literal|")"
argument_list|)
throw|;
block|}
block|}
block|}
DECL|method|hasComponent (Service service)
specifier|private
specifier|static
name|boolean
name|hasComponent
parameter_list|(
name|Service
name|service
parameter_list|)
block|{
if|if
condition|(
name|service
operator|.
name|getComponents
argument_list|()
operator|==
literal|null
operator|||
name|service
operator|.
name|getComponents
argument_list|()
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
return|return
literal|false
return|;
block|}
return|return
literal|true
return|;
block|}
DECL|method|sortByDependencies (List<Component> components)
specifier|public
specifier|static
name|Collection
argument_list|<
name|Component
argument_list|>
name|sortByDependencies
parameter_list|(
name|List
argument_list|<
name|Component
argument_list|>
name|components
parameter_list|)
block|{
name|Map
argument_list|<
name|String
argument_list|,
name|Component
argument_list|>
name|sortedComponents
init|=
name|sortByDependencies
argument_list|(
name|components
argument_list|,
literal|null
argument_list|)
decl_stmt|;
return|return
name|sortedComponents
operator|.
name|values
argument_list|()
return|;
block|}
comment|/**    * Each internal call of sortByDependencies will identify all of the    * components with the same dependency depth (the lowest depth that has not    * been processed yet) and add them to the sortedComponents list, preserving    * their original ordering in the components list.    *    * So the first time it is called, all components with no dependencies    * (depth 0) will be identified. The next time it is called, all components    * that have dependencies only on the the depth 0 components will be    * identified (depth 1). This will be repeated until all components have    * been added to the sortedComponents list. If no new components are    * identified but the sortedComponents list is not complete, an error is    * thrown.    */
DECL|method|sortByDependencies (List<Component> components, Map<String, Component> sortedComponents)
specifier|private
specifier|static
name|Map
argument_list|<
name|String
argument_list|,
name|Component
argument_list|>
name|sortByDependencies
parameter_list|(
name|List
argument_list|<
name|Component
argument_list|>
name|components
parameter_list|,
name|Map
argument_list|<
name|String
argument_list|,
name|Component
argument_list|>
name|sortedComponents
parameter_list|)
block|{
if|if
condition|(
name|sortedComponents
operator|==
literal|null
condition|)
block|{
name|sortedComponents
operator|=
operator|new
name|LinkedHashMap
argument_list|<>
argument_list|()
expr_stmt|;
block|}
name|Map
argument_list|<
name|String
argument_list|,
name|Component
argument_list|>
name|componentsToAdd
init|=
operator|new
name|LinkedHashMap
argument_list|<>
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|Component
argument_list|>
name|componentsSkipped
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
for|for
control|(
name|Component
name|component
range|:
name|components
control|)
block|{
name|String
name|name
init|=
name|component
operator|.
name|getName
argument_list|()
decl_stmt|;
if|if
condition|(
name|sortedComponents
operator|.
name|containsKey
argument_list|(
name|name
argument_list|)
condition|)
block|{
continue|continue;
block|}
name|boolean
name|dependenciesAlreadySorted
init|=
literal|true
decl_stmt|;
if|if
condition|(
operator|!
name|ServiceUtils
operator|.
name|isEmpty
argument_list|(
name|component
operator|.
name|getDependencies
argument_list|()
argument_list|)
condition|)
block|{
for|for
control|(
name|String
name|dependency
range|:
name|component
operator|.
name|getDependencies
argument_list|()
control|)
block|{
if|if
condition|(
operator|!
name|sortedComponents
operator|.
name|containsKey
argument_list|(
name|dependency
argument_list|)
condition|)
block|{
name|dependenciesAlreadySorted
operator|=
literal|false
expr_stmt|;
break|break;
block|}
block|}
block|}
if|if
condition|(
name|dependenciesAlreadySorted
condition|)
block|{
name|componentsToAdd
operator|.
name|put
argument_list|(
name|name
argument_list|,
name|component
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|componentsSkipped
operator|.
name|add
argument_list|(
name|component
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|componentsToAdd
operator|.
name|size
argument_list|()
operator|==
literal|0
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
name|String
operator|.
name|format
argument_list|(
name|RestApiErrorMessages
operator|.
name|ERROR_DEPENDENCY_CYCLE
argument_list|,
name|componentsSkipped
argument_list|)
argument_list|)
throw|;
block|}
name|sortedComponents
operator|.
name|putAll
argument_list|(
name|componentsToAdd
argument_list|)
expr_stmt|;
if|if
condition|(
name|sortedComponents
operator|.
name|size
argument_list|()
operator|==
name|components
operator|.
name|size
argument_list|()
condition|)
block|{
return|return
name|sortedComponents
return|;
block|}
return|return
name|sortByDependencies
argument_list|(
name|components
argument_list|,
name|sortedComponents
argument_list|)
return|;
block|}
DECL|method|createDirAndPersistApp (SliderFileSystem fs, Path appDir, Service service)
specifier|public
specifier|static
name|void
name|createDirAndPersistApp
parameter_list|(
name|SliderFileSystem
name|fs
parameter_list|,
name|Path
name|appDir
parameter_list|,
name|Service
name|service
parameter_list|)
throws|throws
name|IOException
throws|,
name|SliderException
block|{
name|FsPermission
name|appDirPermission
init|=
operator|new
name|FsPermission
argument_list|(
literal|"750"
argument_list|)
decl_stmt|;
name|fs
operator|.
name|createWithPermissions
argument_list|(
name|appDir
argument_list|,
name|appDirPermission
argument_list|)
expr_stmt|;
name|Path
name|appJson
init|=
name|writeAppDefinition
argument_list|(
name|fs
argument_list|,
name|appDir
argument_list|,
name|service
argument_list|)
decl_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Persisted service {} version {} at {}"
argument_list|,
name|service
operator|.
name|getName
argument_list|()
argument_list|,
name|service
operator|.
name|getVersion
argument_list|()
argument_list|,
name|appJson
argument_list|)
expr_stmt|;
block|}
DECL|method|writeAppDefinition (SliderFileSystem fs, Path appDir, Service service)
specifier|public
specifier|static
name|Path
name|writeAppDefinition
parameter_list|(
name|SliderFileSystem
name|fs
parameter_list|,
name|Path
name|appDir
parameter_list|,
name|Service
name|service
parameter_list|)
throws|throws
name|IOException
block|{
name|Path
name|appJson
init|=
operator|new
name|Path
argument_list|(
name|appDir
argument_list|,
name|service
operator|.
name|getName
argument_list|()
operator|+
literal|".json"
argument_list|)
decl_stmt|;
name|jsonSerDeser
operator|.
name|save
argument_list|(
name|fs
operator|.
name|getFileSystem
argument_list|()
argument_list|,
name|appJson
argument_list|,
name|service
argument_list|,
literal|true
argument_list|)
expr_stmt|;
return|return
name|appJson
return|;
block|}
DECL|method|getLiveContainers (Service service, List<String> componentInstances)
specifier|public
specifier|static
name|List
argument_list|<
name|Container
argument_list|>
name|getLiveContainers
parameter_list|(
name|Service
name|service
parameter_list|,
name|List
argument_list|<
name|String
argument_list|>
name|componentInstances
parameter_list|)
throws|throws
name|YarnException
block|{
name|List
argument_list|<
name|Container
argument_list|>
name|result
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
comment|// In order to avoid iterating over all the containers of all components,
comment|// first find the affected components by parsing the instance name.
name|Multimap
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|affectedComps
init|=
name|ArrayListMultimap
operator|.
name|create
argument_list|()
decl_stmt|;
for|for
control|(
name|String
name|instanceName
range|:
name|componentInstances
control|)
block|{
name|affectedComps
operator|.
name|put
argument_list|(
name|ServiceApiUtil
operator|.
name|parseComponentName
argument_list|(
name|instanceName
argument_list|)
argument_list|,
name|instanceName
argument_list|)
expr_stmt|;
block|}
name|service
operator|.
name|getComponents
argument_list|()
operator|.
name|forEach
argument_list|(
name|comp
lambda|->
block|{
comment|// Iterating once over the containers of the affected component to
comment|// find all the containers. Avoiding multiple calls to
comment|// service.getComponent(...) and component.getContainer(...) because they
comment|// iterate over all the components of the service and all the containers
comment|// of the components respectively.
if|if
condition|(
name|affectedComps
operator|.
name|get
argument_list|(
name|comp
operator|.
name|getName
argument_list|()
argument_list|)
operator|!=
literal|null
condition|)
block|{
name|Collection
argument_list|<
name|String
argument_list|>
name|instanceNames
init|=
name|affectedComps
operator|.
name|get
argument_list|(
name|comp
operator|.
name|getName
argument_list|()
argument_list|)
decl_stmt|;
name|comp
operator|.
name|getContainers
argument_list|()
operator|.
name|forEach
argument_list|(
name|container
lambda|->
block|{
if|if
condition|(
name|instanceNames
operator|.
name|contains
argument_list|(
name|container
operator|.
name|getComponentInstanceName
argument_list|()
argument_list|)
condition|)
block|{
name|result
operator|.
name|add
argument_list|(
name|container
argument_list|)
expr_stmt|;
block|}
block|}
argument_list|)
expr_stmt|;
block|}
block|}
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
DECL|method|parseComponentName (String componentInstanceName)
specifier|private
specifier|static
name|String
name|parseComponentName
parameter_list|(
name|String
name|componentInstanceName
parameter_list|)
throws|throws
name|YarnException
block|{
name|int
name|idx
init|=
name|componentInstanceName
operator|.
name|lastIndexOf
argument_list|(
literal|'-'
argument_list|)
decl_stmt|;
if|if
condition|(
name|idx
operator|==
operator|-
literal|1
condition|)
block|{
throw|throw
operator|new
name|YarnException
argument_list|(
literal|"Invalid component instance ("
operator|+
name|componentInstanceName
operator|+
literal|") name."
argument_list|)
throw|;
block|}
return|return
name|componentInstanceName
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
name|idx
argument_list|)
return|;
block|}
DECL|method|$ (String s)
specifier|public
specifier|static
name|String
name|$
parameter_list|(
name|String
name|s
parameter_list|)
block|{
return|return
literal|"${"
operator|+
name|s
operator|+
literal|"}"
return|;
block|}
block|}
end_class

end_unit

