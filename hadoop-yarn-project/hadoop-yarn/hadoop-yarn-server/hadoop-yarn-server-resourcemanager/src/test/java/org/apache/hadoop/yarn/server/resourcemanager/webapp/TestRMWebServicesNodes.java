begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/**  * Licensed to the Apache Software Foundation (ASF) under one  * or more contributor license agreements.  See the NOTICE file  * distributed with this work for additional information  * regarding copyright ownership.  The ASF licenses this file  * to you under the Apache License, Version 2.0 (the  * "License"); you may not use this file except in compliance  * with the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
DECL|package|org.apache.hadoop.yarn.server.resourcemanager.webapp
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|webapp
package|;
end_package

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|webapp
operator|.
name|WebServicesTestUtils
operator|.
name|assertResponseStatusCode
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|junit
operator|.
name|Assert
operator|.
name|assertEquals
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|junit
operator|.
name|Assert
operator|.
name|assertTrue
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|junit
operator|.
name|Assert
operator|.
name|fail
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|mockito
operator|.
name|Mockito
operator|.
name|mock
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|mockito
operator|.
name|Mockito
operator|.
name|when
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|StringReader
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|EnumSet
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|TreeMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Iterator
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|ws
operator|.
name|rs
operator|.
name|core
operator|.
name|MediaType
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|parsers
operator|.
name|DocumentBuilder
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|parsers
operator|.
name|DocumentBuilderFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|conf
operator|.
name|Configuration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|http
operator|.
name|JettyUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|ContainerStatus
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|NodeId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|NodeState
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|Resource
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|ResourceUtilization
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|api
operator|.
name|records
operator|.
name|NodeHealthStatus
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|api
operator|.
name|records
operator|.
name|NodeStatus
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|api
operator|.
name|records
operator|.
name|OpportunisticContainersStatus
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|MockRM
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|ResourceManager
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|rmnode
operator|.
name|RMNode
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|rmnode
operator|.
name|RMNodeEvent
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|rmnode
operator|.
name|RMNodeEventType
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|rmnode
operator|.
name|RMNodeImpl
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|rmnode
operator|.
name|RMNodeStartedEvent
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|rmnode
operator|.
name|RMNodeStatusEvent
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|scheduler
operator|.
name|ResourceScheduler
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|scheduler
operator|.
name|SchedulerNodeReport
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|scheduler
operator|.
name|constraint
operator|.
name|AllocationTagsManager
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|util
operator|.
name|RackResolver
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|util
operator|.
name|YarnVersionInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|webapp
operator|.
name|GenericExceptionHandler
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|webapp
operator|.
name|GuiceServletConfig
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|webapp
operator|.
name|JerseyTestBase
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|webapp
operator|.
name|WebServicesTestUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|codehaus
operator|.
name|jettison
operator|.
name|json
operator|.
name|JSONArray
import|;
end_import

begin_import
import|import
name|org
operator|.
name|codehaus
operator|.
name|jettison
operator|.
name|json
operator|.
name|JSONException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|codehaus
operator|.
name|jettison
operator|.
name|json
operator|.
name|JSONObject
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Before
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Test
import|;
end_import

begin_import
import|import
name|org
operator|.
name|w3c
operator|.
name|dom
operator|.
name|Document
import|;
end_import

begin_import
import|import
name|org
operator|.
name|w3c
operator|.
name|dom
operator|.
name|Element
import|;
end_import

begin_import
import|import
name|org
operator|.
name|w3c
operator|.
name|dom
operator|.
name|NodeList
import|;
end_import

begin_import
import|import
name|org
operator|.
name|xml
operator|.
name|sax
operator|.
name|InputSource
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|base
operator|.
name|Joiner
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|inject
operator|.
name|Guice
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|inject
operator|.
name|servlet
operator|.
name|ServletModule
import|;
end_import

begin_import
import|import
name|com
operator|.
name|sun
operator|.
name|jersey
operator|.
name|api
operator|.
name|client
operator|.
name|ClientResponse
import|;
end_import

begin_import
import|import
name|com
operator|.
name|sun
operator|.
name|jersey
operator|.
name|api
operator|.
name|client
operator|.
name|ClientResponse
operator|.
name|Status
import|;
end_import

begin_import
import|import
name|com
operator|.
name|sun
operator|.
name|jersey
operator|.
name|api
operator|.
name|client
operator|.
name|UniformInterfaceException
import|;
end_import

begin_import
import|import
name|com
operator|.
name|sun
operator|.
name|jersey
operator|.
name|api
operator|.
name|client
operator|.
name|WebResource
import|;
end_import

begin_import
import|import
name|com
operator|.
name|sun
operator|.
name|jersey
operator|.
name|guice
operator|.
name|spi
operator|.
name|container
operator|.
name|servlet
operator|.
name|GuiceContainer
import|;
end_import

begin_import
import|import
name|com
operator|.
name|sun
operator|.
name|jersey
operator|.
name|test
operator|.
name|framework
operator|.
name|WebAppDescriptor
import|;
end_import

begin_class
DECL|class|TestRMWebServicesNodes
specifier|public
class|class
name|TestRMWebServicesNodes
extends|extends
name|JerseyTestBase
block|{
DECL|field|rm
specifier|private
specifier|static
name|MockRM
name|rm
decl_stmt|;
DECL|class|WebServletModule
specifier|private
specifier|static
class|class
name|WebServletModule
extends|extends
name|ServletModule
block|{
annotation|@
name|Override
DECL|method|configureServlets ()
specifier|protected
name|void
name|configureServlets
parameter_list|()
block|{
name|bind
argument_list|(
name|JAXBContextResolver
operator|.
name|class
argument_list|)
expr_stmt|;
name|bind
argument_list|(
name|RMWebServices
operator|.
name|class
argument_list|)
expr_stmt|;
name|bind
argument_list|(
name|GenericExceptionHandler
operator|.
name|class
argument_list|)
expr_stmt|;
name|rm
operator|=
operator|new
name|MockRM
argument_list|(
operator|new
name|Configuration
argument_list|()
argument_list|)
expr_stmt|;
name|rm
operator|.
name|getRMContext
argument_list|()
operator|.
name|getContainerTokenSecretManager
argument_list|()
operator|.
name|rollMasterKey
argument_list|()
expr_stmt|;
name|rm
operator|.
name|getRMContext
argument_list|()
operator|.
name|getNMTokenSecretManager
argument_list|()
operator|.
name|rollMasterKey
argument_list|()
expr_stmt|;
name|rm
operator|.
name|disableDrainEventsImplicitly
argument_list|()
expr_stmt|;
name|bind
argument_list|(
name|ResourceManager
operator|.
name|class
argument_list|)
operator|.
name|toInstance
argument_list|(
name|rm
argument_list|)
expr_stmt|;
name|serve
argument_list|(
literal|"/*"
argument_list|)
operator|.
name|with
argument_list|(
name|GuiceContainer
operator|.
name|class
argument_list|)
expr_stmt|;
block|}
block|}
static|static
block|{
name|GuiceServletConfig
operator|.
name|setInjector
argument_list|(
name|Guice
operator|.
name|createInjector
argument_list|(
operator|new
name|WebServletModule
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Before
annotation|@
name|Override
DECL|method|setUp ()
specifier|public
name|void
name|setUp
parameter_list|()
throws|throws
name|Exception
block|{
name|super
operator|.
name|setUp
argument_list|()
expr_stmt|;
name|GuiceServletConfig
operator|.
name|setInjector
argument_list|(
name|Guice
operator|.
name|createInjector
argument_list|(
operator|new
name|WebServletModule
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|TestRMWebServicesNodes ()
specifier|public
name|TestRMWebServicesNodes
parameter_list|()
block|{
name|super
argument_list|(
operator|new
name|WebAppDescriptor
operator|.
name|Builder
argument_list|(
literal|"org.apache.hadoop.yarn.server.resourcemanager.webapp"
argument_list|)
operator|.
name|contextListenerClass
argument_list|(
name|GuiceServletConfig
operator|.
name|class
argument_list|)
operator|.
name|filterClass
argument_list|(
name|com
operator|.
name|google
operator|.
name|inject
operator|.
name|servlet
operator|.
name|GuiceFilter
operator|.
name|class
argument_list|)
operator|.
name|contextPath
argument_list|(
literal|"jersey-guice-filter"
argument_list|)
operator|.
name|servletPath
argument_list|(
literal|"/"
argument_list|)
operator|.
name|build
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testNodes ()
specifier|public
name|void
name|testNodes
parameter_list|()
throws|throws
name|JSONException
throws|,
name|Exception
block|{
name|testNodesHelper
argument_list|(
literal|"nodes"
argument_list|,
name|MediaType
operator|.
name|APPLICATION_JSON
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testNodesSlash ()
specifier|public
name|void
name|testNodesSlash
parameter_list|()
throws|throws
name|JSONException
throws|,
name|Exception
block|{
name|testNodesHelper
argument_list|(
literal|"nodes/"
argument_list|,
name|MediaType
operator|.
name|APPLICATION_JSON
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testNodesDefault ()
specifier|public
name|void
name|testNodesDefault
parameter_list|()
throws|throws
name|JSONException
throws|,
name|Exception
block|{
name|testNodesHelper
argument_list|(
literal|"nodes/"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testNodesDefaultWithUnHealthyNode ()
specifier|public
name|void
name|testNodesDefaultWithUnHealthyNode
parameter_list|()
throws|throws
name|JSONException
throws|,
name|Exception
block|{
name|WebResource
name|r
init|=
name|resource
argument_list|()
decl_stmt|;
name|getRunningRMNode
argument_list|(
literal|"h1"
argument_list|,
literal|1234
argument_list|,
literal|5120
argument_list|)
expr_stmt|;
comment|// h2 will be in NEW state
name|getNewRMNode
argument_list|(
literal|"h2"
argument_list|,
literal|1235
argument_list|,
literal|5121
argument_list|)
expr_stmt|;
name|RMNode
name|node3
init|=
name|getRunningRMNode
argument_list|(
literal|"h3"
argument_list|,
literal|1236
argument_list|,
literal|5122
argument_list|)
decl_stmt|;
name|NodeId
name|nodeId3
init|=
name|node3
operator|.
name|getNodeID
argument_list|()
decl_stmt|;
name|RMNode
name|node
init|=
name|rm
operator|.
name|getRMContext
argument_list|()
operator|.
name|getRMNodes
argument_list|()
operator|.
name|get
argument_list|(
name|nodeId3
argument_list|)
decl_stmt|;
name|NodeHealthStatus
name|nodeHealth
init|=
name|NodeHealthStatus
operator|.
name|newInstance
argument_list|(
literal|false
argument_list|,
literal|"test health report"
argument_list|,
name|System
operator|.
name|currentTimeMillis
argument_list|()
argument_list|)
decl_stmt|;
name|NodeStatus
name|nodeStatus
init|=
name|NodeStatus
operator|.
name|newInstance
argument_list|(
name|nodeId3
argument_list|,
literal|1
argument_list|,
operator|new
name|ArrayList
argument_list|<
name|ContainerStatus
argument_list|>
argument_list|()
argument_list|,
literal|null
argument_list|,
name|nodeHealth
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
decl_stmt|;
operator|(
operator|(
name|RMNodeImpl
operator|)
name|node
operator|)
operator|.
name|handle
argument_list|(
operator|new
name|RMNodeStatusEvent
argument_list|(
name|nodeId3
argument_list|,
name|nodeStatus
argument_list|,
literal|null
argument_list|)
argument_list|)
expr_stmt|;
name|rm
operator|.
name|waitForState
argument_list|(
name|nodeId3
argument_list|,
name|NodeState
operator|.
name|UNHEALTHY
argument_list|)
expr_stmt|;
name|ClientResponse
name|response
init|=
name|r
operator|.
name|path
argument_list|(
literal|"ws"
argument_list|)
operator|.
name|path
argument_list|(
literal|"v1"
argument_list|)
operator|.
name|path
argument_list|(
literal|"cluster"
argument_list|)
operator|.
name|path
argument_list|(
literal|"nodes"
argument_list|)
operator|.
name|accept
argument_list|(
name|MediaType
operator|.
name|APPLICATION_JSON
argument_list|)
operator|.
name|get
argument_list|(
name|ClientResponse
operator|.
name|class
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
name|MediaType
operator|.
name|APPLICATION_JSON_TYPE
operator|+
literal|"; "
operator|+
name|JettyUtils
operator|.
name|UTF_8
argument_list|,
name|response
operator|.
name|getType
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|JSONObject
name|json
init|=
name|response
operator|.
name|getEntity
argument_list|(
name|JSONObject
operator|.
name|class
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|1
argument_list|,
name|json
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|JSONObject
name|nodes
init|=
name|json
operator|.
name|getJSONObject
argument_list|(
literal|"nodes"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|1
argument_list|,
name|nodes
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|JSONArray
name|nodeArray
init|=
name|nodes
operator|.
name|getJSONArray
argument_list|(
literal|"node"
argument_list|)
decl_stmt|;
comment|// 3 nodes, including the unhealthy node and the new node.
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|3
argument_list|,
name|nodeArray
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|getRunningRMNode (String host, int port, int memory)
specifier|private
name|RMNode
name|getRunningRMNode
parameter_list|(
name|String
name|host
parameter_list|,
name|int
name|port
parameter_list|,
name|int
name|memory
parameter_list|)
block|{
name|RMNodeImpl
name|rmnode1
init|=
name|getNewRMNode
argument_list|(
name|host
argument_list|,
name|port
argument_list|,
name|memory
argument_list|)
decl_stmt|;
name|sendStartedEvent
argument_list|(
name|rmnode1
argument_list|)
expr_stmt|;
return|return
name|rmnode1
return|;
block|}
DECL|method|sendStartedEvent (RMNode node)
specifier|private
name|void
name|sendStartedEvent
parameter_list|(
name|RMNode
name|node
parameter_list|)
block|{
operator|(
operator|(
name|RMNodeImpl
operator|)
name|node
operator|)
operator|.
name|handle
argument_list|(
operator|new
name|RMNodeStartedEvent
argument_list|(
name|node
operator|.
name|getNodeID
argument_list|()
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|sendLostEvent (RMNode node)
specifier|private
name|void
name|sendLostEvent
parameter_list|(
name|RMNode
name|node
parameter_list|)
block|{
operator|(
operator|(
name|RMNodeImpl
operator|)
name|node
operator|)
operator|.
name|handle
argument_list|(
operator|new
name|RMNodeEvent
argument_list|(
name|node
operator|.
name|getNodeID
argument_list|()
argument_list|,
name|RMNodeEventType
operator|.
name|EXPIRE
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|getNewRMNode (String host, int port, int memory)
specifier|private
name|RMNodeImpl
name|getNewRMNode
parameter_list|(
name|String
name|host
parameter_list|,
name|int
name|port
parameter_list|,
name|int
name|memory
parameter_list|)
block|{
name|NodeId
name|nodeId
init|=
name|NodeId
operator|.
name|newInstance
argument_list|(
name|host
argument_list|,
name|port
argument_list|)
decl_stmt|;
name|RMNodeImpl
name|nodeImpl
init|=
operator|new
name|RMNodeImpl
argument_list|(
name|nodeId
argument_list|,
name|rm
operator|.
name|getRMContext
argument_list|()
argument_list|,
name|nodeId
operator|.
name|getHost
argument_list|()
argument_list|,
name|nodeId
operator|.
name|getPort
argument_list|()
argument_list|,
name|nodeId
operator|.
name|getPort
argument_list|()
operator|+
literal|1
argument_list|,
name|RackResolver
operator|.
name|resolve
argument_list|(
name|nodeId
operator|.
name|getHost
argument_list|()
argument_list|)
argument_list|,
name|Resource
operator|.
name|newInstance
argument_list|(
name|memory
argument_list|,
literal|4
argument_list|)
argument_list|,
name|YarnVersionInfo
operator|.
name|getVersion
argument_list|()
argument_list|)
decl_stmt|;
name|rm
operator|.
name|getRMContext
argument_list|()
operator|.
name|getRMNodes
argument_list|()
operator|.
name|put
argument_list|(
name|nodeId
argument_list|,
name|nodeImpl
argument_list|)
expr_stmt|;
return|return
name|nodeImpl
return|;
block|}
annotation|@
name|Test
DECL|method|testNodesQueryNew ()
specifier|public
name|void
name|testNodesQueryNew
parameter_list|()
throws|throws
name|JSONException
throws|,
name|Exception
block|{
name|WebResource
name|r
init|=
name|resource
argument_list|()
decl_stmt|;
name|getRunningRMNode
argument_list|(
literal|"h1"
argument_list|,
literal|1234
argument_list|,
literal|5120
argument_list|)
expr_stmt|;
comment|// h2 will be in NEW state
name|RMNode
name|rmnode2
init|=
name|getNewRMNode
argument_list|(
literal|"h2"
argument_list|,
literal|1235
argument_list|,
literal|5121
argument_list|)
decl_stmt|;
name|ClientResponse
name|response
init|=
name|r
operator|.
name|path
argument_list|(
literal|"ws"
argument_list|)
operator|.
name|path
argument_list|(
literal|"v1"
argument_list|)
operator|.
name|path
argument_list|(
literal|"cluster"
argument_list|)
operator|.
name|path
argument_list|(
literal|"nodes"
argument_list|)
operator|.
name|queryParam
argument_list|(
literal|"states"
argument_list|,
name|NodeState
operator|.
name|NEW
operator|.
name|toString
argument_list|()
argument_list|)
operator|.
name|accept
argument_list|(
name|MediaType
operator|.
name|APPLICATION_JSON
argument_list|)
operator|.
name|get
argument_list|(
name|ClientResponse
operator|.
name|class
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
name|MediaType
operator|.
name|APPLICATION_JSON_TYPE
operator|+
literal|"; "
operator|+
name|JettyUtils
operator|.
name|UTF_8
argument_list|,
name|response
operator|.
name|getType
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|JSONObject
name|json
init|=
name|response
operator|.
name|getEntity
argument_list|(
name|JSONObject
operator|.
name|class
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|1
argument_list|,
name|json
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|JSONObject
name|nodes
init|=
name|json
operator|.
name|getJSONObject
argument_list|(
literal|"nodes"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|1
argument_list|,
name|nodes
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|JSONArray
name|nodeArray
init|=
name|nodes
operator|.
name|getJSONArray
argument_list|(
literal|"node"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|1
argument_list|,
name|nodeArray
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|JSONObject
name|info
init|=
name|nodeArray
operator|.
name|getJSONObject
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|verifyNodeInfo
argument_list|(
name|info
argument_list|,
name|rmnode2
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testNodesQueryStateNone ()
specifier|public
name|void
name|testNodesQueryStateNone
parameter_list|()
throws|throws
name|JSONException
throws|,
name|Exception
block|{
name|WebResource
name|r
init|=
name|resource
argument_list|()
decl_stmt|;
name|getNewRMNode
argument_list|(
literal|"h1"
argument_list|,
literal|1234
argument_list|,
literal|5120
argument_list|)
expr_stmt|;
name|getNewRMNode
argument_list|(
literal|"h2"
argument_list|,
literal|1235
argument_list|,
literal|5121
argument_list|)
expr_stmt|;
name|ClientResponse
name|response
init|=
name|r
operator|.
name|path
argument_list|(
literal|"ws"
argument_list|)
operator|.
name|path
argument_list|(
literal|"v1"
argument_list|)
operator|.
name|path
argument_list|(
literal|"cluster"
argument_list|)
operator|.
name|path
argument_list|(
literal|"nodes"
argument_list|)
operator|.
name|queryParam
argument_list|(
literal|"states"
argument_list|,
name|NodeState
operator|.
name|DECOMMISSIONED
operator|.
name|toString
argument_list|()
argument_list|)
operator|.
name|accept
argument_list|(
name|MediaType
operator|.
name|APPLICATION_JSON
argument_list|)
operator|.
name|get
argument_list|(
name|ClientResponse
operator|.
name|class
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
name|MediaType
operator|.
name|APPLICATION_JSON_TYPE
operator|+
literal|"; "
operator|+
name|JettyUtils
operator|.
name|UTF_8
argument_list|,
name|response
operator|.
name|getType
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|JSONObject
name|json
init|=
name|response
operator|.
name|getEntity
argument_list|(
name|JSONObject
operator|.
name|class
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|1
argument_list|,
name|json
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"nodes is not empty"
argument_list|,
operator|new
name|JSONObject
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|,
name|json
operator|.
name|get
argument_list|(
literal|"nodes"
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testNodesQueryStateInvalid ()
specifier|public
name|void
name|testNodesQueryStateInvalid
parameter_list|()
throws|throws
name|JSONException
throws|,
name|Exception
block|{
name|WebResource
name|r
init|=
name|resource
argument_list|()
decl_stmt|;
name|getNewRMNode
argument_list|(
literal|"h1"
argument_list|,
literal|1234
argument_list|,
literal|5120
argument_list|)
expr_stmt|;
name|getNewRMNode
argument_list|(
literal|"h2"
argument_list|,
literal|1235
argument_list|,
literal|5121
argument_list|)
expr_stmt|;
try|try
block|{
name|r
operator|.
name|path
argument_list|(
literal|"ws"
argument_list|)
operator|.
name|path
argument_list|(
literal|"v1"
argument_list|)
operator|.
name|path
argument_list|(
literal|"cluster"
argument_list|)
operator|.
name|path
argument_list|(
literal|"nodes"
argument_list|)
operator|.
name|queryParam
argument_list|(
literal|"states"
argument_list|,
literal|"BOGUSSTATE"
argument_list|)
operator|.
name|accept
argument_list|(
name|MediaType
operator|.
name|APPLICATION_JSON
argument_list|)
operator|.
name|get
argument_list|(
name|JSONObject
operator|.
name|class
argument_list|)
expr_stmt|;
name|fail
argument_list|(
literal|"should have thrown exception querying invalid state"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|UniformInterfaceException
name|ue
parameter_list|)
block|{
name|ClientResponse
name|response
init|=
name|ue
operator|.
name|getResponse
argument_list|()
decl_stmt|;
name|assertResponseStatusCode
argument_list|(
name|Status
operator|.
name|BAD_REQUEST
argument_list|,
name|response
operator|.
name|getStatusInfo
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|MediaType
operator|.
name|APPLICATION_JSON_TYPE
operator|+
literal|"; "
operator|+
name|JettyUtils
operator|.
name|UTF_8
argument_list|,
name|response
operator|.
name|getType
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|JSONObject
name|msg
init|=
name|response
operator|.
name|getEntity
argument_list|(
name|JSONObject
operator|.
name|class
argument_list|)
decl_stmt|;
name|JSONObject
name|exception
init|=
name|msg
operator|.
name|getJSONObject
argument_list|(
literal|"RemoteException"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|3
argument_list|,
name|exception
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|String
name|message
init|=
name|exception
operator|.
name|getString
argument_list|(
literal|"message"
argument_list|)
decl_stmt|;
name|String
name|type
init|=
name|exception
operator|.
name|getString
argument_list|(
literal|"exception"
argument_list|)
decl_stmt|;
name|String
name|classname
init|=
name|exception
operator|.
name|getString
argument_list|(
literal|"javaClassName"
argument_list|)
decl_stmt|;
name|WebServicesTestUtils
operator|.
name|checkStringContains
argument_list|(
literal|"exception message"
argument_list|,
literal|"org.apache.hadoop.yarn.api.records.NodeState.BOGUSSTATE"
argument_list|,
name|message
argument_list|)
expr_stmt|;
name|WebServicesTestUtils
operator|.
name|checkStringMatch
argument_list|(
literal|"exception type"
argument_list|,
literal|"IllegalArgumentException"
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|WebServicesTestUtils
operator|.
name|checkStringMatch
argument_list|(
literal|"exception classname"
argument_list|,
literal|"java.lang.IllegalArgumentException"
argument_list|,
name|classname
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Test
DECL|method|testNodesQueryStateLost ()
specifier|public
name|void
name|testNodesQueryStateLost
parameter_list|()
throws|throws
name|JSONException
throws|,
name|Exception
block|{
name|WebResource
name|r
init|=
name|resource
argument_list|()
decl_stmt|;
name|RMNode
name|rmnode1
init|=
name|getRunningRMNode
argument_list|(
literal|"h1"
argument_list|,
literal|1234
argument_list|,
literal|5120
argument_list|)
decl_stmt|;
name|sendLostEvent
argument_list|(
name|rmnode1
argument_list|)
expr_stmt|;
name|RMNode
name|rmnode2
init|=
name|getRunningRMNode
argument_list|(
literal|"h2"
argument_list|,
literal|1235
argument_list|,
literal|5121
argument_list|)
decl_stmt|;
name|sendLostEvent
argument_list|(
name|rmnode2
argument_list|)
expr_stmt|;
name|ClientResponse
name|response
init|=
name|r
operator|.
name|path
argument_list|(
literal|"ws"
argument_list|)
operator|.
name|path
argument_list|(
literal|"v1"
argument_list|)
operator|.
name|path
argument_list|(
literal|"cluster"
argument_list|)
operator|.
name|path
argument_list|(
literal|"nodes"
argument_list|)
operator|.
name|queryParam
argument_list|(
literal|"states"
argument_list|,
name|NodeState
operator|.
name|LOST
operator|.
name|toString
argument_list|()
argument_list|)
operator|.
name|accept
argument_list|(
name|MediaType
operator|.
name|APPLICATION_JSON
argument_list|)
operator|.
name|get
argument_list|(
name|ClientResponse
operator|.
name|class
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
name|MediaType
operator|.
name|APPLICATION_JSON_TYPE
operator|+
literal|"; "
operator|+
name|JettyUtils
operator|.
name|UTF_8
argument_list|,
name|response
operator|.
name|getType
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|JSONObject
name|json
init|=
name|response
operator|.
name|getEntity
argument_list|(
name|JSONObject
operator|.
name|class
argument_list|)
decl_stmt|;
name|JSONObject
name|nodes
init|=
name|json
operator|.
name|getJSONObject
argument_list|(
literal|"nodes"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|1
argument_list|,
name|nodes
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|JSONArray
name|nodeArray
init|=
name|nodes
operator|.
name|getJSONArray
argument_list|(
literal|"node"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|2
argument_list|,
name|nodeArray
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|nodeArray
operator|.
name|length
argument_list|()
condition|;
operator|++
name|i
control|)
block|{
name|JSONObject
name|info
init|=
name|nodeArray
operator|.
name|getJSONObject
argument_list|(
name|i
argument_list|)
decl_stmt|;
name|String
index|[]
name|node
init|=
name|info
operator|.
name|get
argument_list|(
literal|"id"
argument_list|)
operator|.
name|toString
argument_list|()
operator|.
name|split
argument_list|(
literal|":"
argument_list|)
decl_stmt|;
name|NodeId
name|nodeId
init|=
name|NodeId
operator|.
name|newInstance
argument_list|(
name|node
index|[
literal|0
index|]
argument_list|,
name|Integer
operator|.
name|parseInt
argument_list|(
name|node
index|[
literal|1
index|]
argument_list|)
argument_list|)
decl_stmt|;
name|RMNode
name|rmNode
init|=
name|rm
operator|.
name|getRMContext
argument_list|()
operator|.
name|getInactiveRMNodes
argument_list|()
operator|.
name|get
argument_list|(
name|nodeId
argument_list|)
decl_stmt|;
name|WebServicesTestUtils
operator|.
name|checkStringMatch
argument_list|(
literal|"nodeHTTPAddress"
argument_list|,
literal|""
argument_list|,
name|info
operator|.
name|getString
argument_list|(
literal|"nodeHTTPAddress"
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rmNode
operator|!=
literal|null
condition|)
block|{
name|WebServicesTestUtils
operator|.
name|checkStringMatch
argument_list|(
literal|"state"
argument_list|,
name|rmNode
operator|.
name|getState
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|,
name|info
operator|.
name|getString
argument_list|(
literal|"state"
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Test
DECL|method|testSingleNodeQueryStateLost ()
specifier|public
name|void
name|testSingleNodeQueryStateLost
parameter_list|()
throws|throws
name|JSONException
throws|,
name|Exception
block|{
name|WebResource
name|r
init|=
name|resource
argument_list|()
decl_stmt|;
name|getRunningRMNode
argument_list|(
literal|"h1"
argument_list|,
literal|1234
argument_list|,
literal|5120
argument_list|)
expr_stmt|;
name|RMNode
name|rmnode2
init|=
name|getRunningRMNode
argument_list|(
literal|"h2"
argument_list|,
literal|1234
argument_list|,
literal|5121
argument_list|)
decl_stmt|;
name|sendLostEvent
argument_list|(
name|rmnode2
argument_list|)
expr_stmt|;
name|ClientResponse
name|response
init|=
name|r
operator|.
name|path
argument_list|(
literal|"ws"
argument_list|)
operator|.
name|path
argument_list|(
literal|"v1"
argument_list|)
operator|.
name|path
argument_list|(
literal|"cluster"
argument_list|)
operator|.
name|path
argument_list|(
literal|"nodes"
argument_list|)
operator|.
name|path
argument_list|(
literal|"h2:1234"
argument_list|)
operator|.
name|accept
argument_list|(
name|MediaType
operator|.
name|APPLICATION_JSON
argument_list|)
operator|.
name|get
argument_list|(
name|ClientResponse
operator|.
name|class
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
name|MediaType
operator|.
name|APPLICATION_JSON_TYPE
operator|+
literal|"; "
operator|+
name|JettyUtils
operator|.
name|UTF_8
argument_list|,
name|response
operator|.
name|getType
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|JSONObject
name|json
init|=
name|response
operator|.
name|getEntity
argument_list|(
name|JSONObject
operator|.
name|class
argument_list|)
decl_stmt|;
name|JSONObject
name|info
init|=
name|json
operator|.
name|getJSONObject
argument_list|(
literal|"node"
argument_list|)
decl_stmt|;
name|String
name|id
init|=
name|info
operator|.
name|get
argument_list|(
literal|"id"
argument_list|)
operator|.
name|toString
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
literal|"Incorrect Node Information."
argument_list|,
literal|"h2:1234"
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|RMNode
name|rmNode
init|=
name|rm
operator|.
name|getRMContext
argument_list|()
operator|.
name|getInactiveRMNodes
argument_list|()
operator|.
name|get
argument_list|(
name|rmnode2
operator|.
name|getNodeID
argument_list|()
argument_list|)
decl_stmt|;
name|WebServicesTestUtils
operator|.
name|checkStringMatch
argument_list|(
literal|"nodeHTTPAddress"
argument_list|,
literal|""
argument_list|,
name|info
operator|.
name|getString
argument_list|(
literal|"nodeHTTPAddress"
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rmNode
operator|!=
literal|null
condition|)
block|{
name|WebServicesTestUtils
operator|.
name|checkStringMatch
argument_list|(
literal|"state"
argument_list|,
name|rmNode
operator|.
name|getState
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|,
name|info
operator|.
name|getString
argument_list|(
literal|"state"
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Test
DECL|method|testNodesQueryRunning ()
specifier|public
name|void
name|testNodesQueryRunning
parameter_list|()
throws|throws
name|JSONException
throws|,
name|Exception
block|{
name|WebResource
name|r
init|=
name|resource
argument_list|()
decl_stmt|;
name|getRunningRMNode
argument_list|(
literal|"h1"
argument_list|,
literal|1234
argument_list|,
literal|5120
argument_list|)
expr_stmt|;
comment|// h2 will be in NEW state
name|getNewRMNode
argument_list|(
literal|"h2"
argument_list|,
literal|1235
argument_list|,
literal|5121
argument_list|)
expr_stmt|;
name|ClientResponse
name|response
init|=
name|r
operator|.
name|path
argument_list|(
literal|"ws"
argument_list|)
operator|.
name|path
argument_list|(
literal|"v1"
argument_list|)
operator|.
name|path
argument_list|(
literal|"cluster"
argument_list|)
operator|.
name|path
argument_list|(
literal|"nodes"
argument_list|)
operator|.
name|queryParam
argument_list|(
literal|"states"
argument_list|,
literal|"running"
argument_list|)
operator|.
name|accept
argument_list|(
name|MediaType
operator|.
name|APPLICATION_JSON
argument_list|)
operator|.
name|get
argument_list|(
name|ClientResponse
operator|.
name|class
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
name|MediaType
operator|.
name|APPLICATION_JSON_TYPE
operator|+
literal|"; "
operator|+
name|JettyUtils
operator|.
name|UTF_8
argument_list|,
name|response
operator|.
name|getType
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|JSONObject
name|json
init|=
name|response
operator|.
name|getEntity
argument_list|(
name|JSONObject
operator|.
name|class
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|1
argument_list|,
name|json
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|JSONObject
name|nodes
init|=
name|json
operator|.
name|getJSONObject
argument_list|(
literal|"nodes"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|1
argument_list|,
name|nodes
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|JSONArray
name|nodeArray
init|=
name|nodes
operator|.
name|getJSONArray
argument_list|(
literal|"node"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|1
argument_list|,
name|nodeArray
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testNodesQueryHealthyFalse ()
specifier|public
name|void
name|testNodesQueryHealthyFalse
parameter_list|()
throws|throws
name|JSONException
throws|,
name|Exception
block|{
name|WebResource
name|r
init|=
name|resource
argument_list|()
decl_stmt|;
name|getRunningRMNode
argument_list|(
literal|"h1"
argument_list|,
literal|1234
argument_list|,
literal|5120
argument_list|)
expr_stmt|;
comment|// h2 will be in NEW state
name|getNewRMNode
argument_list|(
literal|"h2"
argument_list|,
literal|1235
argument_list|,
literal|5121
argument_list|)
expr_stmt|;
name|ClientResponse
name|response
init|=
name|r
operator|.
name|path
argument_list|(
literal|"ws"
argument_list|)
operator|.
name|path
argument_list|(
literal|"v1"
argument_list|)
operator|.
name|path
argument_list|(
literal|"cluster"
argument_list|)
operator|.
name|path
argument_list|(
literal|"nodes"
argument_list|)
operator|.
name|queryParam
argument_list|(
literal|"states"
argument_list|,
literal|"UNHEALTHY"
argument_list|)
operator|.
name|accept
argument_list|(
name|MediaType
operator|.
name|APPLICATION_JSON
argument_list|)
operator|.
name|get
argument_list|(
name|ClientResponse
operator|.
name|class
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
name|MediaType
operator|.
name|APPLICATION_JSON_TYPE
operator|+
literal|"; "
operator|+
name|JettyUtils
operator|.
name|UTF_8
argument_list|,
name|response
operator|.
name|getType
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|JSONObject
name|json
init|=
name|response
operator|.
name|getEntity
argument_list|(
name|JSONObject
operator|.
name|class
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|1
argument_list|,
name|json
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"nodes is not empty"
argument_list|,
operator|new
name|JSONObject
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|,
name|json
operator|.
name|get
argument_list|(
literal|"nodes"
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|testNodesHelper (String path, String media)
specifier|public
name|void
name|testNodesHelper
parameter_list|(
name|String
name|path
parameter_list|,
name|String
name|media
parameter_list|)
throws|throws
name|JSONException
throws|,
name|Exception
block|{
name|WebResource
name|r
init|=
name|resource
argument_list|()
decl_stmt|;
name|RMNode
name|rmnode1
init|=
name|getRunningRMNode
argument_list|(
literal|"h1"
argument_list|,
literal|1234
argument_list|,
literal|5120
argument_list|)
decl_stmt|;
name|RMNode
name|rmnode2
init|=
name|getRunningRMNode
argument_list|(
literal|"h2"
argument_list|,
literal|1235
argument_list|,
literal|5121
argument_list|)
decl_stmt|;
name|ClientResponse
name|response
init|=
name|r
operator|.
name|path
argument_list|(
literal|"ws"
argument_list|)
operator|.
name|path
argument_list|(
literal|"v1"
argument_list|)
operator|.
name|path
argument_list|(
literal|"cluster"
argument_list|)
operator|.
name|path
argument_list|(
name|path
argument_list|)
operator|.
name|accept
argument_list|(
name|media
argument_list|)
operator|.
name|get
argument_list|(
name|ClientResponse
operator|.
name|class
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
name|MediaType
operator|.
name|APPLICATION_JSON_TYPE
operator|+
literal|"; "
operator|+
name|JettyUtils
operator|.
name|UTF_8
argument_list|,
name|response
operator|.
name|getType
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|JSONObject
name|json
init|=
name|response
operator|.
name|getEntity
argument_list|(
name|JSONObject
operator|.
name|class
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|1
argument_list|,
name|json
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|JSONObject
name|nodes
init|=
name|json
operator|.
name|getJSONObject
argument_list|(
literal|"nodes"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|1
argument_list|,
name|nodes
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|JSONArray
name|nodeArray
init|=
name|nodes
operator|.
name|getJSONArray
argument_list|(
literal|"node"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|2
argument_list|,
name|nodeArray
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|JSONObject
name|info
init|=
name|nodeArray
operator|.
name|getJSONObject
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|String
name|id
init|=
name|info
operator|.
name|get
argument_list|(
literal|"id"
argument_list|)
operator|.
name|toString
argument_list|()
decl_stmt|;
if|if
condition|(
name|id
operator|.
name|matches
argument_list|(
literal|"h1:1234"
argument_list|)
condition|)
block|{
name|verifyNodeInfo
argument_list|(
name|info
argument_list|,
name|rmnode1
argument_list|)
expr_stmt|;
name|verifyNodeInfo
argument_list|(
name|nodeArray
operator|.
name|getJSONObject
argument_list|(
literal|1
argument_list|)
argument_list|,
name|rmnode2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|verifyNodeInfo
argument_list|(
name|info
argument_list|,
name|rmnode2
argument_list|)
expr_stmt|;
name|verifyNodeInfo
argument_list|(
name|nodeArray
operator|.
name|getJSONObject
argument_list|(
literal|1
argument_list|)
argument_list|,
name|rmnode1
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Test
DECL|method|testSingleNode ()
specifier|public
name|void
name|testSingleNode
parameter_list|()
throws|throws
name|JSONException
throws|,
name|Exception
block|{
name|getRunningRMNode
argument_list|(
literal|"h1"
argument_list|,
literal|1234
argument_list|,
literal|5120
argument_list|)
expr_stmt|;
name|RMNode
name|rmnode2
init|=
name|getRunningRMNode
argument_list|(
literal|"h2"
argument_list|,
literal|1235
argument_list|,
literal|5121
argument_list|)
decl_stmt|;
name|testSingleNodeHelper
argument_list|(
literal|"h2:1235"
argument_list|,
name|rmnode2
argument_list|,
name|MediaType
operator|.
name|APPLICATION_JSON
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testSingleNodeSlash ()
specifier|public
name|void
name|testSingleNodeSlash
parameter_list|()
throws|throws
name|JSONException
throws|,
name|Exception
block|{
name|RMNode
name|rmnode1
init|=
name|getRunningRMNode
argument_list|(
literal|"h1"
argument_list|,
literal|1234
argument_list|,
literal|5120
argument_list|)
decl_stmt|;
name|getRunningRMNode
argument_list|(
literal|"h2"
argument_list|,
literal|1235
argument_list|,
literal|5121
argument_list|)
expr_stmt|;
name|testSingleNodeHelper
argument_list|(
literal|"h1:1234/"
argument_list|,
name|rmnode1
argument_list|,
name|MediaType
operator|.
name|APPLICATION_JSON
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testSingleNodeDefault ()
specifier|public
name|void
name|testSingleNodeDefault
parameter_list|()
throws|throws
name|JSONException
throws|,
name|Exception
block|{
name|RMNode
name|rmnode1
init|=
name|getRunningRMNode
argument_list|(
literal|"h1"
argument_list|,
literal|1234
argument_list|,
literal|5120
argument_list|)
decl_stmt|;
name|getRunningRMNode
argument_list|(
literal|"h2"
argument_list|,
literal|1235
argument_list|,
literal|5121
argument_list|)
expr_stmt|;
name|testSingleNodeHelper
argument_list|(
literal|"h1:1234/"
argument_list|,
name|rmnode1
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
DECL|method|testSingleNodeHelper (String nodeid, RMNode nm, String media)
specifier|public
name|void
name|testSingleNodeHelper
parameter_list|(
name|String
name|nodeid
parameter_list|,
name|RMNode
name|nm
parameter_list|,
name|String
name|media
parameter_list|)
throws|throws
name|JSONException
throws|,
name|Exception
block|{
name|WebResource
name|r
init|=
name|resource
argument_list|()
decl_stmt|;
name|ClientResponse
name|response
init|=
name|r
operator|.
name|path
argument_list|(
literal|"ws"
argument_list|)
operator|.
name|path
argument_list|(
literal|"v1"
argument_list|)
operator|.
name|path
argument_list|(
literal|"cluster"
argument_list|)
operator|.
name|path
argument_list|(
literal|"nodes"
argument_list|)
operator|.
name|path
argument_list|(
name|nodeid
argument_list|)
operator|.
name|accept
argument_list|(
name|media
argument_list|)
operator|.
name|get
argument_list|(
name|ClientResponse
operator|.
name|class
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
name|MediaType
operator|.
name|APPLICATION_JSON_TYPE
operator|+
literal|"; "
operator|+
name|JettyUtils
operator|.
name|UTF_8
argument_list|,
name|response
operator|.
name|getType
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|JSONObject
name|json
init|=
name|response
operator|.
name|getEntity
argument_list|(
name|JSONObject
operator|.
name|class
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|1
argument_list|,
name|json
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|JSONObject
name|info
init|=
name|json
operator|.
name|getJSONObject
argument_list|(
literal|"node"
argument_list|)
decl_stmt|;
name|verifyNodeInfo
argument_list|(
name|info
argument_list|,
name|nm
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testNonexistNode ()
specifier|public
name|void
name|testNonexistNode
parameter_list|()
throws|throws
name|JSONException
throws|,
name|Exception
block|{
comment|// add h1 node in NEW state
name|getNewRMNode
argument_list|(
literal|"h1"
argument_list|,
literal|1234
argument_list|,
literal|5120
argument_list|)
expr_stmt|;
comment|// add h2 node in NEW state
name|getNewRMNode
argument_list|(
literal|"h2"
argument_list|,
literal|1235
argument_list|,
literal|5121
argument_list|)
expr_stmt|;
name|WebResource
name|r
init|=
name|resource
argument_list|()
decl_stmt|;
try|try
block|{
name|r
operator|.
name|path
argument_list|(
literal|"ws"
argument_list|)
operator|.
name|path
argument_list|(
literal|"v1"
argument_list|)
operator|.
name|path
argument_list|(
literal|"cluster"
argument_list|)
operator|.
name|path
argument_list|(
literal|"nodes"
argument_list|)
operator|.
name|path
argument_list|(
literal|"node_invalid:99"
argument_list|)
operator|.
name|accept
argument_list|(
name|MediaType
operator|.
name|APPLICATION_JSON
argument_list|)
operator|.
name|get
argument_list|(
name|JSONObject
operator|.
name|class
argument_list|)
expr_stmt|;
name|fail
argument_list|(
literal|"should have thrown exception on non-existent nodeid"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|UniformInterfaceException
name|ue
parameter_list|)
block|{
name|ClientResponse
name|response
init|=
name|ue
operator|.
name|getResponse
argument_list|()
decl_stmt|;
name|assertResponseStatusCode
argument_list|(
name|Status
operator|.
name|NOT_FOUND
argument_list|,
name|response
operator|.
name|getStatusInfo
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|MediaType
operator|.
name|APPLICATION_JSON_TYPE
operator|+
literal|"; "
operator|+
name|JettyUtils
operator|.
name|UTF_8
argument_list|,
name|response
operator|.
name|getType
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|JSONObject
name|msg
init|=
name|response
operator|.
name|getEntity
argument_list|(
name|JSONObject
operator|.
name|class
argument_list|)
decl_stmt|;
name|JSONObject
name|exception
init|=
name|msg
operator|.
name|getJSONObject
argument_list|(
literal|"RemoteException"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|3
argument_list|,
name|exception
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|String
name|message
init|=
name|exception
operator|.
name|getString
argument_list|(
literal|"message"
argument_list|)
decl_stmt|;
name|String
name|type
init|=
name|exception
operator|.
name|getString
argument_list|(
literal|"exception"
argument_list|)
decl_stmt|;
name|String
name|classname
init|=
name|exception
operator|.
name|getString
argument_list|(
literal|"javaClassName"
argument_list|)
decl_stmt|;
name|verifyNonexistNodeException
argument_list|(
name|message
argument_list|,
name|type
argument_list|,
name|classname
argument_list|)
expr_stmt|;
block|}
block|}
comment|// test that the exception output defaults to JSON
annotation|@
name|Test
DECL|method|testNonexistNodeDefault ()
specifier|public
name|void
name|testNonexistNodeDefault
parameter_list|()
throws|throws
name|JSONException
throws|,
name|Exception
block|{
name|getNewRMNode
argument_list|(
literal|"h1"
argument_list|,
literal|1234
argument_list|,
literal|5120
argument_list|)
expr_stmt|;
name|getNewRMNode
argument_list|(
literal|"h2"
argument_list|,
literal|1235
argument_list|,
literal|5121
argument_list|)
expr_stmt|;
name|WebResource
name|r
init|=
name|resource
argument_list|()
decl_stmt|;
try|try
block|{
name|r
operator|.
name|path
argument_list|(
literal|"ws"
argument_list|)
operator|.
name|path
argument_list|(
literal|"v1"
argument_list|)
operator|.
name|path
argument_list|(
literal|"cluster"
argument_list|)
operator|.
name|path
argument_list|(
literal|"nodes"
argument_list|)
operator|.
name|path
argument_list|(
literal|"node_invalid:99"
argument_list|)
operator|.
name|get
argument_list|(
name|JSONObject
operator|.
name|class
argument_list|)
expr_stmt|;
name|fail
argument_list|(
literal|"should have thrown exception on non-existent nodeid"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|UniformInterfaceException
name|ue
parameter_list|)
block|{
name|ClientResponse
name|response
init|=
name|ue
operator|.
name|getResponse
argument_list|()
decl_stmt|;
name|assertResponseStatusCode
argument_list|(
name|Status
operator|.
name|NOT_FOUND
argument_list|,
name|response
operator|.
name|getStatusInfo
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|MediaType
operator|.
name|APPLICATION_JSON_TYPE
operator|+
literal|"; "
operator|+
name|JettyUtils
operator|.
name|UTF_8
argument_list|,
name|response
operator|.
name|getType
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|JSONObject
name|msg
init|=
name|response
operator|.
name|getEntity
argument_list|(
name|JSONObject
operator|.
name|class
argument_list|)
decl_stmt|;
name|JSONObject
name|exception
init|=
name|msg
operator|.
name|getJSONObject
argument_list|(
literal|"RemoteException"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|3
argument_list|,
name|exception
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|String
name|message
init|=
name|exception
operator|.
name|getString
argument_list|(
literal|"message"
argument_list|)
decl_stmt|;
name|String
name|type
init|=
name|exception
operator|.
name|getString
argument_list|(
literal|"exception"
argument_list|)
decl_stmt|;
name|String
name|classname
init|=
name|exception
operator|.
name|getString
argument_list|(
literal|"javaClassName"
argument_list|)
decl_stmt|;
name|verifyNonexistNodeException
argument_list|(
name|message
argument_list|,
name|type
argument_list|,
name|classname
argument_list|)
expr_stmt|;
block|}
block|}
comment|// test that the exception output works in XML
annotation|@
name|Test
DECL|method|testNonexistNodeXML ()
specifier|public
name|void
name|testNonexistNodeXML
parameter_list|()
throws|throws
name|JSONException
throws|,
name|Exception
block|{
name|getNewRMNode
argument_list|(
literal|"h1"
argument_list|,
literal|1234
argument_list|,
literal|5120
argument_list|)
expr_stmt|;
name|getNewRMNode
argument_list|(
literal|"h2"
argument_list|,
literal|1235
argument_list|,
literal|5121
argument_list|)
expr_stmt|;
name|WebResource
name|r
init|=
name|resource
argument_list|()
decl_stmt|;
try|try
block|{
name|r
operator|.
name|path
argument_list|(
literal|"ws"
argument_list|)
operator|.
name|path
argument_list|(
literal|"v1"
argument_list|)
operator|.
name|path
argument_list|(
literal|"cluster"
argument_list|)
operator|.
name|path
argument_list|(
literal|"nodes"
argument_list|)
operator|.
name|path
argument_list|(
literal|"node_invalid:99"
argument_list|)
operator|.
name|accept
argument_list|(
name|MediaType
operator|.
name|APPLICATION_XML
argument_list|)
operator|.
name|get
argument_list|(
name|JSONObject
operator|.
name|class
argument_list|)
expr_stmt|;
name|fail
argument_list|(
literal|"should have thrown exception on non-existent nodeid"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|UniformInterfaceException
name|ue
parameter_list|)
block|{
name|ClientResponse
name|response
init|=
name|ue
operator|.
name|getResponse
argument_list|()
decl_stmt|;
name|assertResponseStatusCode
argument_list|(
name|Status
operator|.
name|NOT_FOUND
argument_list|,
name|response
operator|.
name|getStatusInfo
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|MediaType
operator|.
name|APPLICATION_XML_TYPE
operator|+
literal|"; "
operator|+
name|JettyUtils
operator|.
name|UTF_8
argument_list|,
name|response
operator|.
name|getType
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|String
name|msg
init|=
name|response
operator|.
name|getEntity
argument_list|(
name|String
operator|.
name|class
argument_list|)
decl_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|DocumentBuilderFactory
name|dbf
init|=
name|DocumentBuilderFactory
operator|.
name|newInstance
argument_list|()
decl_stmt|;
name|DocumentBuilder
name|db
init|=
name|dbf
operator|.
name|newDocumentBuilder
argument_list|()
decl_stmt|;
name|InputSource
name|is
init|=
operator|new
name|InputSource
argument_list|()
decl_stmt|;
name|is
operator|.
name|setCharacterStream
argument_list|(
operator|new
name|StringReader
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|Document
name|dom
init|=
name|db
operator|.
name|parse
argument_list|(
name|is
argument_list|)
decl_stmt|;
name|NodeList
name|nodes
init|=
name|dom
operator|.
name|getElementsByTagName
argument_list|(
literal|"RemoteException"
argument_list|)
decl_stmt|;
name|Element
name|element
init|=
operator|(
name|Element
operator|)
name|nodes
operator|.
name|item
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|String
name|message
init|=
name|WebServicesTestUtils
operator|.
name|getXmlString
argument_list|(
name|element
argument_list|,
literal|"message"
argument_list|)
decl_stmt|;
name|String
name|type
init|=
name|WebServicesTestUtils
operator|.
name|getXmlString
argument_list|(
name|element
argument_list|,
literal|"exception"
argument_list|)
decl_stmt|;
name|String
name|classname
init|=
name|WebServicesTestUtils
operator|.
name|getXmlString
argument_list|(
name|element
argument_list|,
literal|"javaClassName"
argument_list|)
decl_stmt|;
name|verifyNonexistNodeException
argument_list|(
name|message
argument_list|,
name|type
argument_list|,
name|classname
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|verifyNonexistNodeException (String message, String type, String classname)
specifier|private
name|void
name|verifyNonexistNodeException
parameter_list|(
name|String
name|message
parameter_list|,
name|String
name|type
parameter_list|,
name|String
name|classname
parameter_list|)
block|{
name|assertTrue
argument_list|(
literal|"exception message incorrect"
argument_list|,
literal|"java.lang.Exception: nodeId, node_invalid:99, is not found"
operator|.
name|matches
argument_list|(
name|message
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"exception type incorrect"
argument_list|,
literal|"NotFoundException"
operator|.
name|matches
argument_list|(
name|type
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"exception className incorrect"
argument_list|,
literal|"org.apache.hadoop.yarn.webapp.NotFoundException"
operator|.
name|matches
argument_list|(
name|classname
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testInvalidNode ()
specifier|public
name|void
name|testInvalidNode
parameter_list|()
throws|throws
name|JSONException
throws|,
name|Exception
block|{
name|getNewRMNode
argument_list|(
literal|"h1"
argument_list|,
literal|1234
argument_list|,
literal|5120
argument_list|)
expr_stmt|;
name|getNewRMNode
argument_list|(
literal|"h2"
argument_list|,
literal|1235
argument_list|,
literal|5121
argument_list|)
expr_stmt|;
name|WebResource
name|r
init|=
name|resource
argument_list|()
decl_stmt|;
try|try
block|{
name|r
operator|.
name|path
argument_list|(
literal|"ws"
argument_list|)
operator|.
name|path
argument_list|(
literal|"v1"
argument_list|)
operator|.
name|path
argument_list|(
literal|"cluster"
argument_list|)
operator|.
name|path
argument_list|(
literal|"nodes"
argument_list|)
operator|.
name|path
argument_list|(
literal|"node_invalid_foo"
argument_list|)
operator|.
name|accept
argument_list|(
name|MediaType
operator|.
name|APPLICATION_JSON
argument_list|)
operator|.
name|get
argument_list|(
name|JSONObject
operator|.
name|class
argument_list|)
expr_stmt|;
name|fail
argument_list|(
literal|"should have thrown exception on non-existent nodeid"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|UniformInterfaceException
name|ue
parameter_list|)
block|{
name|ClientResponse
name|response
init|=
name|ue
operator|.
name|getResponse
argument_list|()
decl_stmt|;
name|assertResponseStatusCode
argument_list|(
name|Status
operator|.
name|BAD_REQUEST
argument_list|,
name|response
operator|.
name|getStatusInfo
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|MediaType
operator|.
name|APPLICATION_JSON_TYPE
operator|+
literal|"; "
operator|+
name|JettyUtils
operator|.
name|UTF_8
argument_list|,
name|response
operator|.
name|getType
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|JSONObject
name|msg
init|=
name|response
operator|.
name|getEntity
argument_list|(
name|JSONObject
operator|.
name|class
argument_list|)
decl_stmt|;
name|JSONObject
name|exception
init|=
name|msg
operator|.
name|getJSONObject
argument_list|(
literal|"RemoteException"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|3
argument_list|,
name|exception
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|String
name|message
init|=
name|exception
operator|.
name|getString
argument_list|(
literal|"message"
argument_list|)
decl_stmt|;
name|String
name|type
init|=
name|exception
operator|.
name|getString
argument_list|(
literal|"exception"
argument_list|)
decl_stmt|;
name|String
name|classname
init|=
name|exception
operator|.
name|getString
argument_list|(
literal|"javaClassName"
argument_list|)
decl_stmt|;
name|WebServicesTestUtils
operator|.
name|checkStringMatch
argument_list|(
literal|"exception message"
argument_list|,
literal|"Invalid NodeId \\[node_invalid_foo\\]. Expected host:port"
argument_list|,
name|message
argument_list|)
expr_stmt|;
name|WebServicesTestUtils
operator|.
name|checkStringMatch
argument_list|(
literal|"exception type"
argument_list|,
literal|"IllegalArgumentException"
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|WebServicesTestUtils
operator|.
name|checkStringMatch
argument_list|(
literal|"exception classname"
argument_list|,
literal|"java.lang.IllegalArgumentException"
argument_list|,
name|classname
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Test
DECL|method|testNodesXML ()
specifier|public
name|void
name|testNodesXML
parameter_list|()
throws|throws
name|JSONException
throws|,
name|Exception
block|{
name|WebResource
name|r
init|=
name|resource
argument_list|()
decl_stmt|;
name|RMNodeImpl
name|rmnode1
init|=
name|getNewRMNode
argument_list|(
literal|"h1"
argument_list|,
literal|1234
argument_list|,
literal|5120
argument_list|)
decl_stmt|;
comment|// MockNM nm2 = rm.registerNode("h2:1235", 5121);
name|ClientResponse
name|response
init|=
name|r
operator|.
name|path
argument_list|(
literal|"ws"
argument_list|)
operator|.
name|path
argument_list|(
literal|"v1"
argument_list|)
operator|.
name|path
argument_list|(
literal|"cluster"
argument_list|)
operator|.
name|path
argument_list|(
literal|"nodes"
argument_list|)
operator|.
name|accept
argument_list|(
name|MediaType
operator|.
name|APPLICATION_XML
argument_list|)
operator|.
name|get
argument_list|(
name|ClientResponse
operator|.
name|class
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
name|MediaType
operator|.
name|APPLICATION_XML_TYPE
operator|+
literal|"; "
operator|+
name|JettyUtils
operator|.
name|UTF_8
argument_list|,
name|response
operator|.
name|getType
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|String
name|xml
init|=
name|response
operator|.
name|getEntity
argument_list|(
name|String
operator|.
name|class
argument_list|)
decl_stmt|;
name|DocumentBuilderFactory
name|dbf
init|=
name|DocumentBuilderFactory
operator|.
name|newInstance
argument_list|()
decl_stmt|;
name|DocumentBuilder
name|db
init|=
name|dbf
operator|.
name|newDocumentBuilder
argument_list|()
decl_stmt|;
name|InputSource
name|is
init|=
operator|new
name|InputSource
argument_list|()
decl_stmt|;
name|is
operator|.
name|setCharacterStream
argument_list|(
operator|new
name|StringReader
argument_list|(
name|xml
argument_list|)
argument_list|)
expr_stmt|;
name|Document
name|dom
init|=
name|db
operator|.
name|parse
argument_list|(
name|is
argument_list|)
decl_stmt|;
name|NodeList
name|nodesApps
init|=
name|dom
operator|.
name|getElementsByTagName
argument_list|(
literal|"nodes"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|1
argument_list|,
name|nodesApps
operator|.
name|getLength
argument_list|()
argument_list|)
expr_stmt|;
name|NodeList
name|nodes
init|=
name|dom
operator|.
name|getElementsByTagName
argument_list|(
literal|"node"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|1
argument_list|,
name|nodes
operator|.
name|getLength
argument_list|()
argument_list|)
expr_stmt|;
name|verifyNodesXML
argument_list|(
name|nodes
argument_list|,
name|rmnode1
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testSingleNodesXML ()
specifier|public
name|void
name|testSingleNodesXML
parameter_list|()
throws|throws
name|JSONException
throws|,
name|Exception
block|{
name|WebResource
name|r
init|=
name|resource
argument_list|()
decl_stmt|;
comment|// add h2 node in NEW state
name|RMNodeImpl
name|rmnode1
init|=
name|getNewRMNode
argument_list|(
literal|"h1"
argument_list|,
literal|1234
argument_list|,
literal|5120
argument_list|)
decl_stmt|;
comment|// MockNM nm2 = rm.registerNode("h2:1235", 5121);
name|ClientResponse
name|response
init|=
name|r
operator|.
name|path
argument_list|(
literal|"ws"
argument_list|)
operator|.
name|path
argument_list|(
literal|"v1"
argument_list|)
operator|.
name|path
argument_list|(
literal|"cluster"
argument_list|)
operator|.
name|path
argument_list|(
literal|"nodes"
argument_list|)
operator|.
name|path
argument_list|(
literal|"h1:1234"
argument_list|)
operator|.
name|accept
argument_list|(
name|MediaType
operator|.
name|APPLICATION_XML
argument_list|)
operator|.
name|get
argument_list|(
name|ClientResponse
operator|.
name|class
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
name|MediaType
operator|.
name|APPLICATION_XML_TYPE
operator|+
literal|"; "
operator|+
name|JettyUtils
operator|.
name|UTF_8
argument_list|,
name|response
operator|.
name|getType
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|String
name|xml
init|=
name|response
operator|.
name|getEntity
argument_list|(
name|String
operator|.
name|class
argument_list|)
decl_stmt|;
name|DocumentBuilderFactory
name|dbf
init|=
name|DocumentBuilderFactory
operator|.
name|newInstance
argument_list|()
decl_stmt|;
name|DocumentBuilder
name|db
init|=
name|dbf
operator|.
name|newDocumentBuilder
argument_list|()
decl_stmt|;
name|InputSource
name|is
init|=
operator|new
name|InputSource
argument_list|()
decl_stmt|;
name|is
operator|.
name|setCharacterStream
argument_list|(
operator|new
name|StringReader
argument_list|(
name|xml
argument_list|)
argument_list|)
expr_stmt|;
name|Document
name|dom
init|=
name|db
operator|.
name|parse
argument_list|(
name|is
argument_list|)
decl_stmt|;
name|NodeList
name|nodes
init|=
name|dom
operator|.
name|getElementsByTagName
argument_list|(
literal|"node"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|1
argument_list|,
name|nodes
operator|.
name|getLength
argument_list|()
argument_list|)
expr_stmt|;
name|verifyNodesXML
argument_list|(
name|nodes
argument_list|,
name|rmnode1
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testNodes2XML ()
specifier|public
name|void
name|testNodes2XML
parameter_list|()
throws|throws
name|JSONException
throws|,
name|Exception
block|{
name|WebResource
name|r
init|=
name|resource
argument_list|()
decl_stmt|;
name|getNewRMNode
argument_list|(
literal|"h1"
argument_list|,
literal|1234
argument_list|,
literal|5120
argument_list|)
expr_stmt|;
name|getNewRMNode
argument_list|(
literal|"h2"
argument_list|,
literal|1235
argument_list|,
literal|5121
argument_list|)
expr_stmt|;
name|ClientResponse
name|response
init|=
name|r
operator|.
name|path
argument_list|(
literal|"ws"
argument_list|)
operator|.
name|path
argument_list|(
literal|"v1"
argument_list|)
operator|.
name|path
argument_list|(
literal|"cluster"
argument_list|)
operator|.
name|path
argument_list|(
literal|"nodes"
argument_list|)
operator|.
name|accept
argument_list|(
name|MediaType
operator|.
name|APPLICATION_XML
argument_list|)
operator|.
name|get
argument_list|(
name|ClientResponse
operator|.
name|class
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
name|MediaType
operator|.
name|APPLICATION_XML_TYPE
operator|+
literal|"; "
operator|+
name|JettyUtils
operator|.
name|UTF_8
argument_list|,
name|response
operator|.
name|getType
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|String
name|xml
init|=
name|response
operator|.
name|getEntity
argument_list|(
name|String
operator|.
name|class
argument_list|)
decl_stmt|;
name|DocumentBuilderFactory
name|dbf
init|=
name|DocumentBuilderFactory
operator|.
name|newInstance
argument_list|()
decl_stmt|;
name|DocumentBuilder
name|db
init|=
name|dbf
operator|.
name|newDocumentBuilder
argument_list|()
decl_stmt|;
name|InputSource
name|is
init|=
operator|new
name|InputSource
argument_list|()
decl_stmt|;
name|is
operator|.
name|setCharacterStream
argument_list|(
operator|new
name|StringReader
argument_list|(
name|xml
argument_list|)
argument_list|)
expr_stmt|;
name|Document
name|dom
init|=
name|db
operator|.
name|parse
argument_list|(
name|is
argument_list|)
decl_stmt|;
name|NodeList
name|nodesApps
init|=
name|dom
operator|.
name|getElementsByTagName
argument_list|(
literal|"nodes"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|1
argument_list|,
name|nodesApps
operator|.
name|getLength
argument_list|()
argument_list|)
expr_stmt|;
name|NodeList
name|nodes
init|=
name|dom
operator|.
name|getElementsByTagName
argument_list|(
literal|"node"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|2
argument_list|,
name|nodes
operator|.
name|getLength
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testQueryAll ()
specifier|public
name|void
name|testQueryAll
parameter_list|()
throws|throws
name|Exception
block|{
name|WebResource
name|r
init|=
name|resource
argument_list|()
decl_stmt|;
name|getRunningRMNode
argument_list|(
literal|"h1"
argument_list|,
literal|1234
argument_list|,
literal|5120
argument_list|)
expr_stmt|;
comment|// add h2 node in NEW state
name|getNewRMNode
argument_list|(
literal|"h2"
argument_list|,
literal|1235
argument_list|,
literal|5121
argument_list|)
expr_stmt|;
comment|// add lost node
name|RMNode
name|nm3
init|=
name|getRunningRMNode
argument_list|(
literal|"h3"
argument_list|,
literal|1236
argument_list|,
literal|5122
argument_list|)
decl_stmt|;
name|sendLostEvent
argument_list|(
name|nm3
argument_list|)
expr_stmt|;
name|ClientResponse
name|response
init|=
name|r
operator|.
name|path
argument_list|(
literal|"ws"
argument_list|)
operator|.
name|path
argument_list|(
literal|"v1"
argument_list|)
operator|.
name|path
argument_list|(
literal|"cluster"
argument_list|)
operator|.
name|path
argument_list|(
literal|"nodes"
argument_list|)
operator|.
name|queryParam
argument_list|(
literal|"states"
argument_list|,
name|Joiner
operator|.
name|on
argument_list|(
literal|','
argument_list|)
operator|.
name|join
argument_list|(
name|EnumSet
operator|.
name|allOf
argument_list|(
name|NodeState
operator|.
name|class
argument_list|)
argument_list|)
argument_list|)
operator|.
name|accept
argument_list|(
name|MediaType
operator|.
name|APPLICATION_JSON
argument_list|)
operator|.
name|get
argument_list|(
name|ClientResponse
operator|.
name|class
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
name|MediaType
operator|.
name|APPLICATION_JSON_TYPE
operator|+
literal|"; "
operator|+
name|JettyUtils
operator|.
name|UTF_8
argument_list|,
name|response
operator|.
name|getType
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|JSONObject
name|json
init|=
name|response
operator|.
name|getEntity
argument_list|(
name|JSONObject
operator|.
name|class
argument_list|)
decl_stmt|;
name|JSONObject
name|nodes
init|=
name|json
operator|.
name|getJSONObject
argument_list|(
literal|"nodes"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|1
argument_list|,
name|nodes
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|JSONArray
name|nodeArray
init|=
name|nodes
operator|.
name|getJSONArray
argument_list|(
literal|"node"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|3
argument_list|,
name|nodeArray
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testNodesResourceUtilization ()
specifier|public
name|void
name|testNodesResourceUtilization
parameter_list|()
throws|throws
name|JSONException
throws|,
name|Exception
block|{
name|WebResource
name|r
init|=
name|resource
argument_list|()
decl_stmt|;
name|RMNode
name|rmnode1
init|=
name|getRunningRMNode
argument_list|(
literal|"h1"
argument_list|,
literal|1234
argument_list|,
literal|5120
argument_list|)
decl_stmt|;
name|NodeId
name|nodeId1
init|=
name|rmnode1
operator|.
name|getNodeID
argument_list|()
decl_stmt|;
name|RMNodeImpl
name|node
init|=
operator|(
name|RMNodeImpl
operator|)
name|rm
operator|.
name|getRMContext
argument_list|()
operator|.
name|getRMNodes
argument_list|()
operator|.
name|get
argument_list|(
name|nodeId1
argument_list|)
decl_stmt|;
name|NodeHealthStatus
name|nodeHealth
init|=
name|NodeHealthStatus
operator|.
name|newInstance
argument_list|(
literal|true
argument_list|,
literal|"test health report"
argument_list|,
name|System
operator|.
name|currentTimeMillis
argument_list|()
argument_list|)
decl_stmt|;
name|ResourceUtilization
name|nodeResource
init|=
name|ResourceUtilization
operator|.
name|newInstance
argument_list|(
literal|4096
argument_list|,
literal|0
argument_list|,
operator|(
name|float
operator|)
literal|10.5
argument_list|)
decl_stmt|;
name|ResourceUtilization
name|containerResource
init|=
name|ResourceUtilization
operator|.
name|newInstance
argument_list|(
literal|2048
argument_list|,
literal|0
argument_list|,
operator|(
name|float
operator|)
literal|5.05
argument_list|)
decl_stmt|;
name|NodeStatus
name|nodeStatus
init|=
name|NodeStatus
operator|.
name|newInstance
argument_list|(
name|nodeId1
argument_list|,
literal|0
argument_list|,
operator|new
name|ArrayList
argument_list|<
name|ContainerStatus
argument_list|>
argument_list|()
argument_list|,
literal|null
argument_list|,
name|nodeHealth
argument_list|,
name|containerResource
argument_list|,
name|nodeResource
argument_list|,
literal|null
argument_list|)
decl_stmt|;
name|node
operator|.
name|handle
argument_list|(
operator|new
name|RMNodeStatusEvent
argument_list|(
name|nodeId1
argument_list|,
name|nodeStatus
argument_list|,
literal|null
argument_list|)
argument_list|)
expr_stmt|;
name|rm
operator|.
name|waitForState
argument_list|(
name|nodeId1
argument_list|,
name|NodeState
operator|.
name|RUNNING
argument_list|)
expr_stmt|;
name|ClientResponse
name|response
init|=
name|r
operator|.
name|path
argument_list|(
literal|"ws"
argument_list|)
operator|.
name|path
argument_list|(
literal|"v1"
argument_list|)
operator|.
name|path
argument_list|(
literal|"cluster"
argument_list|)
operator|.
name|path
argument_list|(
literal|"nodes"
argument_list|)
operator|.
name|accept
argument_list|(
name|MediaType
operator|.
name|APPLICATION_JSON
argument_list|)
operator|.
name|get
argument_list|(
name|ClientResponse
operator|.
name|class
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
name|MediaType
operator|.
name|APPLICATION_JSON_TYPE
operator|+
literal|"; "
operator|+
name|JettyUtils
operator|.
name|UTF_8
argument_list|,
name|response
operator|.
name|getType
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|JSONObject
name|json
init|=
name|response
operator|.
name|getEntity
argument_list|(
name|JSONObject
operator|.
name|class
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|1
argument_list|,
name|json
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|JSONObject
name|nodes
init|=
name|json
operator|.
name|getJSONObject
argument_list|(
literal|"nodes"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|1
argument_list|,
name|nodes
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|JSONArray
name|nodeArray
init|=
name|nodes
operator|.
name|getJSONArray
argument_list|(
literal|"node"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|1
argument_list|,
name|nodeArray
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|JSONObject
name|info
init|=
name|nodeArray
operator|.
name|getJSONObject
argument_list|(
literal|0
argument_list|)
decl_stmt|;
comment|// verify the resource utilization
name|verifyNodeInfo
argument_list|(
name|info
argument_list|,
name|rmnode1
argument_list|)
expr_stmt|;
block|}
DECL|method|verifyNodesXML (NodeList nodes, RMNode nm)
specifier|public
name|void
name|verifyNodesXML
parameter_list|(
name|NodeList
name|nodes
parameter_list|,
name|RMNode
name|nm
parameter_list|)
throws|throws
name|JSONException
throws|,
name|Exception
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|nodes
operator|.
name|getLength
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|Element
name|element
init|=
operator|(
name|Element
operator|)
name|nodes
operator|.
name|item
argument_list|(
name|i
argument_list|)
decl_stmt|;
name|verifyNodeInfoGeneric
argument_list|(
name|nm
argument_list|,
name|WebServicesTestUtils
operator|.
name|getXmlString
argument_list|(
name|element
argument_list|,
literal|"state"
argument_list|)
argument_list|,
name|WebServicesTestUtils
operator|.
name|getXmlString
argument_list|(
name|element
argument_list|,
literal|"rack"
argument_list|)
argument_list|,
name|WebServicesTestUtils
operator|.
name|getXmlString
argument_list|(
name|element
argument_list|,
literal|"id"
argument_list|)
argument_list|,
name|WebServicesTestUtils
operator|.
name|getXmlString
argument_list|(
name|element
argument_list|,
literal|"nodeHostName"
argument_list|)
argument_list|,
name|WebServicesTestUtils
operator|.
name|getXmlString
argument_list|(
name|element
argument_list|,
literal|"nodeHTTPAddress"
argument_list|)
argument_list|,
name|WebServicesTestUtils
operator|.
name|getXmlLong
argument_list|(
name|element
argument_list|,
literal|"lastHealthUpdate"
argument_list|)
argument_list|,
name|WebServicesTestUtils
operator|.
name|getXmlString
argument_list|(
name|element
argument_list|,
literal|"healthReport"
argument_list|)
argument_list|,
name|WebServicesTestUtils
operator|.
name|getXmlInt
argument_list|(
name|element
argument_list|,
literal|"numContainers"
argument_list|)
argument_list|,
name|WebServicesTestUtils
operator|.
name|getXmlLong
argument_list|(
name|element
argument_list|,
literal|"usedMemoryMB"
argument_list|)
argument_list|,
name|WebServicesTestUtils
operator|.
name|getXmlLong
argument_list|(
name|element
argument_list|,
literal|"availMemoryMB"
argument_list|)
argument_list|,
name|WebServicesTestUtils
operator|.
name|getXmlLong
argument_list|(
name|element
argument_list|,
literal|"usedVirtualCores"
argument_list|)
argument_list|,
name|WebServicesTestUtils
operator|.
name|getXmlLong
argument_list|(
name|element
argument_list|,
literal|"availableVirtualCores"
argument_list|)
argument_list|,
name|WebServicesTestUtils
operator|.
name|getXmlString
argument_list|(
name|element
argument_list|,
literal|"version"
argument_list|)
argument_list|,
name|WebServicesTestUtils
operator|.
name|getXmlInt
argument_list|(
name|element
argument_list|,
literal|"nodePhysicalMemoryMB"
argument_list|)
argument_list|,
name|WebServicesTestUtils
operator|.
name|getXmlInt
argument_list|(
name|element
argument_list|,
literal|"nodeVirtualMemoryMB"
argument_list|)
argument_list|,
name|WebServicesTestUtils
operator|.
name|getXmlFloat
argument_list|(
name|element
argument_list|,
literal|"nodeCPUUsage"
argument_list|)
argument_list|,
name|WebServicesTestUtils
operator|.
name|getXmlInt
argument_list|(
name|element
argument_list|,
literal|"aggregatedContainersPhysicalMemoryMB"
argument_list|)
argument_list|,
name|WebServicesTestUtils
operator|.
name|getXmlInt
argument_list|(
name|element
argument_list|,
literal|"aggregatedContainersVirtualMemoryMB"
argument_list|)
argument_list|,
name|WebServicesTestUtils
operator|.
name|getXmlFloat
argument_list|(
name|element
argument_list|,
literal|"containersCPUUsage"
argument_list|)
argument_list|,
name|WebServicesTestUtils
operator|.
name|getXmlInt
argument_list|(
name|element
argument_list|,
literal|"numRunningOpportContainers"
argument_list|)
argument_list|,
name|WebServicesTestUtils
operator|.
name|getXmlLong
argument_list|(
name|element
argument_list|,
literal|"usedMemoryOpportGB"
argument_list|)
argument_list|,
name|WebServicesTestUtils
operator|.
name|getXmlInt
argument_list|(
name|element
argument_list|,
literal|"usedVirtualCoresOpport"
argument_list|)
argument_list|,
name|WebServicesTestUtils
operator|.
name|getXmlInt
argument_list|(
name|element
argument_list|,
literal|"numQueuedContainers"
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|verifyNodeInfo (JSONObject nodeInfo, RMNode nm)
specifier|public
name|void
name|verifyNodeInfo
parameter_list|(
name|JSONObject
name|nodeInfo
parameter_list|,
name|RMNode
name|nm
parameter_list|)
throws|throws
name|JSONException
throws|,
name|Exception
block|{
name|assertEquals
argument_list|(
literal|"incorrect number of elements"
argument_list|,
literal|19
argument_list|,
name|nodeInfo
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|JSONObject
name|resourceInfo
init|=
name|nodeInfo
operator|.
name|getJSONObject
argument_list|(
literal|"resourceUtilization"
argument_list|)
decl_stmt|;
name|verifyNodeInfoGeneric
argument_list|(
name|nm
argument_list|,
name|nodeInfo
operator|.
name|getString
argument_list|(
literal|"state"
argument_list|)
argument_list|,
name|nodeInfo
operator|.
name|getString
argument_list|(
literal|"rack"
argument_list|)
argument_list|,
name|nodeInfo
operator|.
name|getString
argument_list|(
literal|"id"
argument_list|)
argument_list|,
name|nodeInfo
operator|.
name|getString
argument_list|(
literal|"nodeHostName"
argument_list|)
argument_list|,
name|nodeInfo
operator|.
name|getString
argument_list|(
literal|"nodeHTTPAddress"
argument_list|)
argument_list|,
name|nodeInfo
operator|.
name|getLong
argument_list|(
literal|"lastHealthUpdate"
argument_list|)
argument_list|,
name|nodeInfo
operator|.
name|getString
argument_list|(
literal|"healthReport"
argument_list|)
argument_list|,
name|nodeInfo
operator|.
name|getInt
argument_list|(
literal|"numContainers"
argument_list|)
argument_list|,
name|nodeInfo
operator|.
name|getLong
argument_list|(
literal|"usedMemoryMB"
argument_list|)
argument_list|,
name|nodeInfo
operator|.
name|getLong
argument_list|(
literal|"availMemoryMB"
argument_list|)
argument_list|,
name|nodeInfo
operator|.
name|getLong
argument_list|(
literal|"usedVirtualCores"
argument_list|)
argument_list|,
name|nodeInfo
operator|.
name|getLong
argument_list|(
literal|"availableVirtualCores"
argument_list|)
argument_list|,
name|nodeInfo
operator|.
name|getString
argument_list|(
literal|"version"
argument_list|)
argument_list|,
name|resourceInfo
operator|.
name|getInt
argument_list|(
literal|"nodePhysicalMemoryMB"
argument_list|)
argument_list|,
name|resourceInfo
operator|.
name|getInt
argument_list|(
literal|"nodeVirtualMemoryMB"
argument_list|)
argument_list|,
name|resourceInfo
operator|.
name|getDouble
argument_list|(
literal|"nodeCPUUsage"
argument_list|)
argument_list|,
name|resourceInfo
operator|.
name|getInt
argument_list|(
literal|"aggregatedContainersPhysicalMemoryMB"
argument_list|)
argument_list|,
name|resourceInfo
operator|.
name|getInt
argument_list|(
literal|"aggregatedContainersVirtualMemoryMB"
argument_list|)
argument_list|,
name|resourceInfo
operator|.
name|getDouble
argument_list|(
literal|"containersCPUUsage"
argument_list|)
argument_list|,
name|nodeInfo
operator|.
name|getInt
argument_list|(
literal|"numRunningOpportContainers"
argument_list|)
argument_list|,
name|nodeInfo
operator|.
name|getLong
argument_list|(
literal|"usedMemoryOpportGB"
argument_list|)
argument_list|,
name|nodeInfo
operator|.
name|getInt
argument_list|(
literal|"usedVirtualCoresOpport"
argument_list|)
argument_list|,
name|nodeInfo
operator|.
name|getInt
argument_list|(
literal|"numQueuedContainers"
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|verifyNodeInfoGeneric (RMNode node, String state, String rack, String id, String nodeHostName, String nodeHTTPAddress, long lastHealthUpdate, String healthReport, int numContainers, long usedMemoryMB, long availMemoryMB, long usedVirtualCores, long availVirtualCores, String version, int nodePhysicalMemoryMB, int nodeVirtualMemoryMB, double nodeCPUUsage, int containersPhysicalMemoryMB, int containersVirtualMemoryMB, double containersCPUUsage, int numRunningOpportContainers, long usedMemoryOpportGB, int usedVirtualCoresOpport, int numQueuedContainers)
specifier|public
name|void
name|verifyNodeInfoGeneric
parameter_list|(
name|RMNode
name|node
parameter_list|,
name|String
name|state
parameter_list|,
name|String
name|rack
parameter_list|,
name|String
name|id
parameter_list|,
name|String
name|nodeHostName
parameter_list|,
name|String
name|nodeHTTPAddress
parameter_list|,
name|long
name|lastHealthUpdate
parameter_list|,
name|String
name|healthReport
parameter_list|,
name|int
name|numContainers
parameter_list|,
name|long
name|usedMemoryMB
parameter_list|,
name|long
name|availMemoryMB
parameter_list|,
name|long
name|usedVirtualCores
parameter_list|,
name|long
name|availVirtualCores
parameter_list|,
name|String
name|version
parameter_list|,
name|int
name|nodePhysicalMemoryMB
parameter_list|,
name|int
name|nodeVirtualMemoryMB
parameter_list|,
name|double
name|nodeCPUUsage
parameter_list|,
name|int
name|containersPhysicalMemoryMB
parameter_list|,
name|int
name|containersVirtualMemoryMB
parameter_list|,
name|double
name|containersCPUUsage
parameter_list|,
name|int
name|numRunningOpportContainers
parameter_list|,
name|long
name|usedMemoryOpportGB
parameter_list|,
name|int
name|usedVirtualCoresOpport
parameter_list|,
name|int
name|numQueuedContainers
parameter_list|)
throws|throws
name|JSONException
throws|,
name|Exception
block|{
name|ResourceScheduler
name|sched
init|=
name|rm
operator|.
name|getResourceScheduler
argument_list|()
decl_stmt|;
name|SchedulerNodeReport
name|report
init|=
name|sched
operator|.
name|getNodeReport
argument_list|(
name|node
operator|.
name|getNodeID
argument_list|()
argument_list|)
decl_stmt|;
name|OpportunisticContainersStatus
name|opportunisticStatus
init|=
name|node
operator|.
name|getOpportunisticContainersStatus
argument_list|()
decl_stmt|;
name|WebServicesTestUtils
operator|.
name|checkStringMatch
argument_list|(
literal|"state"
argument_list|,
name|node
operator|.
name|getState
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|,
name|state
argument_list|)
expr_stmt|;
name|WebServicesTestUtils
operator|.
name|checkStringMatch
argument_list|(
literal|"rack"
argument_list|,
name|node
operator|.
name|getRackName
argument_list|()
argument_list|,
name|rack
argument_list|)
expr_stmt|;
name|WebServicesTestUtils
operator|.
name|checkStringMatch
argument_list|(
literal|"id"
argument_list|,
name|node
operator|.
name|getNodeID
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|WebServicesTestUtils
operator|.
name|checkStringMatch
argument_list|(
literal|"nodeHostName"
argument_list|,
name|node
operator|.
name|getNodeID
argument_list|()
operator|.
name|getHost
argument_list|()
argument_list|,
name|nodeHostName
argument_list|)
expr_stmt|;
name|WebServicesTestUtils
operator|.
name|checkStringMatch
argument_list|(
literal|"healthReport"
argument_list|,
name|String
operator|.
name|valueOf
argument_list|(
name|node
operator|.
name|getHealthReport
argument_list|()
argument_list|)
argument_list|,
name|healthReport
argument_list|)
expr_stmt|;
name|String
name|expectedHttpAddress
init|=
name|node
operator|.
name|getNodeID
argument_list|()
operator|.
name|getHost
argument_list|()
operator|+
literal|":"
operator|+
name|node
operator|.
name|getHttpPort
argument_list|()
decl_stmt|;
name|WebServicesTestUtils
operator|.
name|checkStringMatch
argument_list|(
literal|"nodeHTTPAddress"
argument_list|,
name|expectedHttpAddress
argument_list|,
name|nodeHTTPAddress
argument_list|)
expr_stmt|;
name|WebServicesTestUtils
operator|.
name|checkStringMatch
argument_list|(
literal|"version"
argument_list|,
name|node
operator|.
name|getNodeManagerVersion
argument_list|()
argument_list|,
name|version
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|.
name|getNodeUtilization
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|ResourceUtilization
name|nodeResource
init|=
name|ResourceUtilization
operator|.
name|newInstance
argument_list|(
name|nodePhysicalMemoryMB
argument_list|,
name|nodeVirtualMemoryMB
argument_list|,
operator|(
name|float
operator|)
name|nodeCPUUsage
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"nodeResourceUtilization doesn't match"
argument_list|,
name|node
operator|.
name|getNodeUtilization
argument_list|()
argument_list|,
name|nodeResource
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|node
operator|.
name|getAggregatedContainersUtilization
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|ResourceUtilization
name|containerResource
init|=
name|ResourceUtilization
operator|.
name|newInstance
argument_list|(
name|containersPhysicalMemoryMB
argument_list|,
name|containersVirtualMemoryMB
argument_list|,
operator|(
name|float
operator|)
name|containersCPUUsage
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"containerResourceUtilization doesn't match"
argument_list|,
name|node
operator|.
name|getAggregatedContainersUtilization
argument_list|()
argument_list|,
name|containerResource
argument_list|)
expr_stmt|;
block|}
name|long
name|expectedHealthUpdate
init|=
name|node
operator|.
name|getLastHealthReportTime
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
literal|"lastHealthUpdate doesn't match, got: "
operator|+
name|lastHealthUpdate
operator|+
literal|" expected: "
operator|+
name|expectedHealthUpdate
argument_list|,
name|expectedHealthUpdate
argument_list|,
name|lastHealthUpdate
argument_list|)
expr_stmt|;
if|if
condition|(
name|report
operator|!=
literal|null
condition|)
block|{
name|assertEquals
argument_list|(
literal|"numContainers doesn't match: "
operator|+
name|numContainers
argument_list|,
name|report
operator|.
name|getNumContainers
argument_list|()
argument_list|,
name|numContainers
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"usedMemoryMB doesn't match: "
operator|+
name|usedMemoryMB
argument_list|,
name|report
operator|.
name|getUsedResource
argument_list|()
operator|.
name|getMemorySize
argument_list|()
argument_list|,
name|usedMemoryMB
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"availMemoryMB doesn't match: "
operator|+
name|availMemoryMB
argument_list|,
name|report
operator|.
name|getAvailableResource
argument_list|()
operator|.
name|getMemorySize
argument_list|()
argument_list|,
name|availMemoryMB
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"usedVirtualCores doesn't match: "
operator|+
name|usedVirtualCores
argument_list|,
name|report
operator|.
name|getUsedResource
argument_list|()
operator|.
name|getVirtualCores
argument_list|()
argument_list|,
name|usedVirtualCores
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"availVirtualCores doesn't match: "
operator|+
name|availVirtualCores
argument_list|,
name|report
operator|.
name|getAvailableResource
argument_list|()
operator|.
name|getVirtualCores
argument_list|()
argument_list|,
name|availVirtualCores
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|opportunisticStatus
operator|!=
literal|null
condition|)
block|{
name|assertEquals
argument_list|(
literal|"numRunningOpportContainers doesn't match: "
operator|+
name|numRunningOpportContainers
argument_list|,
name|opportunisticStatus
operator|.
name|getRunningOpportContainers
argument_list|()
argument_list|,
name|numRunningOpportContainers
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"usedMemoryOpportGB doesn't match: "
operator|+
name|usedMemoryOpportGB
argument_list|,
name|opportunisticStatus
operator|.
name|getOpportMemoryUsed
argument_list|()
argument_list|,
name|usedMemoryOpportGB
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"usedVirtualCoresOpport doesn't match: "
operator|+
name|usedVirtualCoresOpport
argument_list|,
name|opportunisticStatus
operator|.
name|getOpportCoresUsed
argument_list|()
argument_list|,
name|usedVirtualCoresOpport
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"numQueuedContainers doesn't match: "
operator|+
name|numQueuedContainers
argument_list|,
name|opportunisticStatus
operator|.
name|getQueuedOpportContainers
argument_list|()
argument_list|,
name|numQueuedContainers
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Test
DECL|method|testNodesAllocationTags ()
specifier|public
name|void
name|testNodesAllocationTags
parameter_list|()
throws|throws
name|Exception
block|{
name|NodeId
name|nm1
init|=
name|NodeId
operator|.
name|newInstance
argument_list|(
literal|"host1"
argument_list|,
literal|1234
argument_list|)
decl_stmt|;
name|NodeId
name|nm2
init|=
name|NodeId
operator|.
name|newInstance
argument_list|(
literal|"host2"
argument_list|,
literal|2345
argument_list|)
decl_stmt|;
name|AllocationTagsManager
name|atm
init|=
name|mock
argument_list|(
name|AllocationTagsManager
operator|.
name|class
argument_list|)
decl_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|Map
argument_list|<
name|String
argument_list|,
name|Long
argument_list|>
argument_list|>
name|expectedAllocationTags
init|=
operator|new
name|TreeMap
argument_list|<>
argument_list|()
decl_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|Long
argument_list|>
name|nm1Tags
init|=
operator|new
name|TreeMap
argument_list|<>
argument_list|()
decl_stmt|;
name|nm1Tags
operator|.
name|put
argument_list|(
literal|"A"
argument_list|,
literal|1L
argument_list|)
expr_stmt|;
name|nm1Tags
operator|.
name|put
argument_list|(
literal|"B"
argument_list|,
literal|2L
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|Long
argument_list|>
name|nm2Tags
init|=
operator|new
name|TreeMap
argument_list|<>
argument_list|()
decl_stmt|;
name|nm2Tags
operator|.
name|put
argument_list|(
literal|"C"
argument_list|,
literal|1L
argument_list|)
expr_stmt|;
name|nm2Tags
operator|.
name|put
argument_list|(
literal|"D"
argument_list|,
literal|2L
argument_list|)
expr_stmt|;
name|expectedAllocationTags
operator|.
name|put
argument_list|(
name|nm1
operator|.
name|toString
argument_list|()
argument_list|,
name|nm1Tags
argument_list|)
expr_stmt|;
name|expectedAllocationTags
operator|.
name|put
argument_list|(
name|nm2
operator|.
name|toString
argument_list|()
argument_list|,
name|nm2Tags
argument_list|)
expr_stmt|;
name|when
argument_list|(
name|atm
operator|.
name|getAllocationTagsWithCount
argument_list|(
name|nm1
argument_list|)
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|nm1Tags
argument_list|)
expr_stmt|;
name|when
argument_list|(
name|atm
operator|.
name|getAllocationTagsWithCount
argument_list|(
name|nm2
argument_list|)
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|nm2Tags
argument_list|)
expr_stmt|;
name|rm
operator|.
name|getRMContext
argument_list|()
operator|.
name|setAllocationTagsManager
argument_list|(
name|atm
argument_list|)
expr_stmt|;
name|rm
operator|.
name|start
argument_list|()
expr_stmt|;
name|rm
operator|.
name|registerNode
argument_list|(
name|nm1
operator|.
name|toString
argument_list|()
argument_list|,
literal|1024
argument_list|)
expr_stmt|;
name|rm
operator|.
name|registerNode
argument_list|(
name|nm2
operator|.
name|toString
argument_list|()
argument_list|,
literal|1024
argument_list|)
expr_stmt|;
name|WebResource
name|r
init|=
name|resource
argument_list|()
decl_stmt|;
name|ClientResponse
name|response
init|=
name|r
operator|.
name|path
argument_list|(
literal|"ws"
argument_list|)
operator|.
name|path
argument_list|(
literal|"v1"
argument_list|)
operator|.
name|path
argument_list|(
literal|"cluster"
argument_list|)
operator|.
name|path
argument_list|(
literal|"nodes"
argument_list|)
operator|.
name|accept
argument_list|(
literal|"application/json"
argument_list|)
operator|.
name|get
argument_list|(
name|ClientResponse
operator|.
name|class
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
name|MediaType
operator|.
name|APPLICATION_JSON
operator|+
literal|"; "
operator|+
name|JettyUtils
operator|.
name|UTF_8
argument_list|,
name|response
operator|.
name|getType
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|JSONObject
name|nodesInfoJson
init|=
name|response
operator|.
name|getEntity
argument_list|(
name|JSONObject
operator|.
name|class
argument_list|)
decl_stmt|;
name|verifyNodeAllocationTag
argument_list|(
name|nodesInfoJson
argument_list|,
name|expectedAllocationTags
argument_list|)
expr_stmt|;
name|rm
operator|.
name|stop
argument_list|()
expr_stmt|;
block|}
DECL|method|verifyNodeAllocationTag (JSONObject json, Map<String, Map<String, Long>> expectedAllocationTags)
specifier|private
name|void
name|verifyNodeAllocationTag
parameter_list|(
name|JSONObject
name|json
parameter_list|,
name|Map
argument_list|<
name|String
argument_list|,
name|Map
argument_list|<
name|String
argument_list|,
name|Long
argument_list|>
argument_list|>
name|expectedAllocationTags
parameter_list|)
throws|throws
name|JSONException
block|{
name|JSONArray
name|nodes
init|=
name|json
operator|.
name|getJSONObject
argument_list|(
literal|"nodes"
argument_list|)
operator|.
name|getJSONArray
argument_list|(
literal|"node"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
name|expectedAllocationTags
operator|.
name|size
argument_list|()
argument_list|,
name|nodes
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|nodes
operator|.
name|length
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|JSONObject
name|nodeJson
init|=
name|nodes
operator|.
name|getJSONObject
argument_list|(
name|i
argument_list|)
decl_stmt|;
name|String
name|nodeId
init|=
name|nodeJson
operator|.
name|getString
argument_list|(
literal|"id"
argument_list|)
decl_stmt|;
comment|// Ensure the response contains all nodes info
name|assertTrue
argument_list|(
literal|"Nodes info should have expected node IDs"
argument_list|,
name|expectedAllocationTags
operator|.
name|containsKey
argument_list|(
name|nodeId
argument_list|)
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|Long
argument_list|>
name|expectedTags
init|=
name|expectedAllocationTags
operator|.
name|get
argument_list|(
name|nodeId
argument_list|)
decl_stmt|;
name|JSONArray
name|tagsInfo
init|=
name|nodeJson
operator|.
name|getJSONObject
argument_list|(
literal|"allocationTags"
argument_list|)
operator|.
name|getJSONArray
argument_list|(
literal|"allocationTagInfo"
argument_list|)
decl_stmt|;
comment|// Ensure number of tags are expected.
name|assertEquals
argument_list|(
name|expectedTags
operator|.
name|size
argument_list|()
argument_list|,
name|tagsInfo
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
comment|// Iterate expected tags and make sure the actual
comment|// tags/counts are matched.
name|Iterator
argument_list|<
name|String
argument_list|>
name|it
init|=
name|expectedTags
operator|.
name|keySet
argument_list|()
operator|.
name|iterator
argument_list|()
decl_stmt|;
for|for
control|(
name|int
name|j
init|=
literal|0
init|;
name|j
operator|<
name|tagsInfo
operator|.
name|length
argument_list|()
condition|;
name|j
operator|++
control|)
block|{
name|JSONObject
name|tagInfo
init|=
name|tagsInfo
operator|.
name|getJSONObject
argument_list|(
name|j
argument_list|)
decl_stmt|;
name|String
name|expectedTag
init|=
name|it
operator|.
name|next
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
name|tagInfo
operator|.
name|getString
argument_list|(
literal|"allocationTag"
argument_list|)
argument_list|,
name|expectedTag
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|tagInfo
operator|.
name|getLong
argument_list|(
literal|"allocationsCount"
argument_list|)
argument_list|,
name|expectedTags
operator|.
name|get
argument_list|(
name|expectedTag
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_class

end_unit

