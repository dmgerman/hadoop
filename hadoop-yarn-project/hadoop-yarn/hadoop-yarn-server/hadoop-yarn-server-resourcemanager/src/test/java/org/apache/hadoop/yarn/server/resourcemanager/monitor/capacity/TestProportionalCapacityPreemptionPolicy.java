begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/**  * Licensed to the Apache Software Foundation (ASF) under one  * or more contributor license agreements.  See the NOTICE file  * distributed with this work for additional information  * regarding copyright ownership.  The ASF licenses this file  * to you under the Apache License, Version 2.0 (the  * "License"); you may not use this file except in compliance  * with the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
DECL|package|org.apache.hadoop.yarn.server.resourcemanager.monitor.capacity
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|monitor
operator|.
name|capacity
package|;
end_package

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|monitor
operator|.
name|capacity
operator|.
name|ProportionalCapacityPreemptionPolicy
operator|.
name|MAX_IGNORED_OVER_CAPACITY
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|monitor
operator|.
name|capacity
operator|.
name|ProportionalCapacityPreemptionPolicy
operator|.
name|MONITORING_INTERVAL
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|monitor
operator|.
name|capacity
operator|.
name|ProportionalCapacityPreemptionPolicy
operator|.
name|NATURAL_TERMINATION_FACTOR
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|monitor
operator|.
name|capacity
operator|.
name|ProportionalCapacityPreemptionPolicy
operator|.
name|OBSERVE_ONLY
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|monitor
operator|.
name|capacity
operator|.
name|ProportionalCapacityPreemptionPolicy
operator|.
name|TOTAL_PREEMPTION_PER_ROUND
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|monitor
operator|.
name|capacity
operator|.
name|ProportionalCapacityPreemptionPolicy
operator|.
name|WAIT_TIME_BEFORE_KILL
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|scheduler
operator|.
name|ContainerPreemptEventType
operator|.
name|KILL_CONTAINER
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|scheduler
operator|.
name|ContainerPreemptEventType
operator|.
name|PREEMPT_CONTAINER
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|junit
operator|.
name|Assert
operator|.
name|assertEquals
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|junit
operator|.
name|Assert
operator|.
name|assertNotNull
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|junit
operator|.
name|Assert
operator|.
name|fail
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|mockito
operator|.
name|Matchers
operator|.
name|argThat
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|mockito
operator|.
name|Matchers
operator|.
name|isA
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|mockito
operator|.
name|Mockito
operator|.
name|mock
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|mockito
operator|.
name|Mockito
operator|.
name|never
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|mockito
operator|.
name|Mockito
operator|.
name|times
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|mockito
operator|.
name|Mockito
operator|.
name|verify
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|mockito
operator|.
name|Mockito
operator|.
name|when
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Comparator
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Deque
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|LinkedList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|NavigableSet
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Random
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|TreeSet
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|conf
operator|.
name|Configuration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|service
operator|.
name|Service
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|ApplicationAttemptId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|ApplicationId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|Container
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|ContainerId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|Resource
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|conf
operator|.
name|YarnConfiguration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|event
operator|.
name|EventHandler
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|MockRM
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|monitor
operator|.
name|SchedulingMonitor
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|resource
operator|.
name|Priority
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|rmcontainer
operator|.
name|RMContainer
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|scheduler
operator|.
name|ContainerPreemptEvent
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|scheduler
operator|.
name|ContainerPreemptEventType
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|scheduler
operator|.
name|capacity
operator|.
name|CSQueue
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|scheduler
operator|.
name|capacity
operator|.
name|CapacityScheduler
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|scheduler
operator|.
name|capacity
operator|.
name|LeafQueue
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|scheduler
operator|.
name|capacity
operator|.
name|ParentQueue
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|scheduler
operator|.
name|common
operator|.
name|fica
operator|.
name|FiCaSchedulerApp
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|util
operator|.
name|Clock
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|util
operator|.
name|resource
operator|.
name|DefaultResourceCalculator
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|util
operator|.
name|resource
operator|.
name|ResourceCalculator
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Before
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Rule
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Test
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|rules
operator|.
name|TestName
import|;
end_import

begin_import
import|import
name|org
operator|.
name|mockito
operator|.
name|ArgumentCaptor
import|;
end_import

begin_import
import|import
name|org
operator|.
name|mockito
operator|.
name|ArgumentMatcher
import|;
end_import

begin_class
DECL|class|TestProportionalCapacityPreemptionPolicy
specifier|public
class|class
name|TestProportionalCapacityPreemptionPolicy
block|{
DECL|field|TS
specifier|static
specifier|final
name|long
name|TS
init|=
literal|3141592653L
decl_stmt|;
DECL|field|appAlloc
name|int
name|appAlloc
init|=
literal|0
decl_stmt|;
DECL|field|rand
name|Random
name|rand
init|=
literal|null
decl_stmt|;
DECL|field|mClock
name|Clock
name|mClock
init|=
literal|null
decl_stmt|;
DECL|field|conf
name|Configuration
name|conf
init|=
literal|null
decl_stmt|;
DECL|field|mCS
name|CapacityScheduler
name|mCS
init|=
literal|null
decl_stmt|;
DECL|field|mDisp
name|EventHandler
argument_list|<
name|ContainerPreemptEvent
argument_list|>
name|mDisp
init|=
literal|null
decl_stmt|;
DECL|field|rc
name|ResourceCalculator
name|rc
init|=
operator|new
name|DefaultResourceCalculator
argument_list|()
decl_stmt|;
DECL|field|appA
specifier|final
name|ApplicationAttemptId
name|appA
init|=
name|ApplicationAttemptId
operator|.
name|newInstance
argument_list|(
name|ApplicationId
operator|.
name|newInstance
argument_list|(
name|TS
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|)
decl_stmt|;
DECL|field|appB
specifier|final
name|ApplicationAttemptId
name|appB
init|=
name|ApplicationAttemptId
operator|.
name|newInstance
argument_list|(
name|ApplicationId
operator|.
name|newInstance
argument_list|(
name|TS
argument_list|,
literal|1
argument_list|)
argument_list|,
literal|0
argument_list|)
decl_stmt|;
DECL|field|appC
specifier|final
name|ApplicationAttemptId
name|appC
init|=
name|ApplicationAttemptId
operator|.
name|newInstance
argument_list|(
name|ApplicationId
operator|.
name|newInstance
argument_list|(
name|TS
argument_list|,
literal|2
argument_list|)
argument_list|,
literal|0
argument_list|)
decl_stmt|;
DECL|field|appD
specifier|final
name|ApplicationAttemptId
name|appD
init|=
name|ApplicationAttemptId
operator|.
name|newInstance
argument_list|(
name|ApplicationId
operator|.
name|newInstance
argument_list|(
name|TS
argument_list|,
literal|3
argument_list|)
argument_list|,
literal|0
argument_list|)
decl_stmt|;
DECL|field|appE
specifier|final
name|ApplicationAttemptId
name|appE
init|=
name|ApplicationAttemptId
operator|.
name|newInstance
argument_list|(
name|ApplicationId
operator|.
name|newInstance
argument_list|(
name|TS
argument_list|,
literal|4
argument_list|)
argument_list|,
literal|0
argument_list|)
decl_stmt|;
DECL|field|evtCaptor
specifier|final
name|ArgumentCaptor
argument_list|<
name|ContainerPreemptEvent
argument_list|>
name|evtCaptor
init|=
name|ArgumentCaptor
operator|.
name|forClass
argument_list|(
name|ContainerPreemptEvent
operator|.
name|class
argument_list|)
decl_stmt|;
DECL|field|name
annotation|@
name|Rule
specifier|public
name|TestName
name|name
init|=
operator|new
name|TestName
argument_list|()
decl_stmt|;
annotation|@
name|Before
annotation|@
name|SuppressWarnings
argument_list|(
literal|"unchecked"
argument_list|)
DECL|method|setup ()
specifier|public
name|void
name|setup
parameter_list|()
block|{
name|conf
operator|=
operator|new
name|Configuration
argument_list|(
literal|false
argument_list|)
expr_stmt|;
name|conf
operator|.
name|setLong
argument_list|(
name|WAIT_TIME_BEFORE_KILL
argument_list|,
literal|10000
argument_list|)
expr_stmt|;
name|conf
operator|.
name|setLong
argument_list|(
name|MONITORING_INTERVAL
argument_list|,
literal|3000
argument_list|)
expr_stmt|;
comment|// report "ideal" preempt
name|conf
operator|.
name|setFloat
argument_list|(
name|TOTAL_PREEMPTION_PER_ROUND
argument_list|,
operator|(
name|float
operator|)
literal|1.0
argument_list|)
expr_stmt|;
name|conf
operator|.
name|setFloat
argument_list|(
name|NATURAL_TERMINATION_FACTOR
argument_list|,
operator|(
name|float
operator|)
literal|1.0
argument_list|)
expr_stmt|;
name|mClock
operator|=
name|mock
argument_list|(
name|Clock
operator|.
name|class
argument_list|)
expr_stmt|;
name|mCS
operator|=
name|mock
argument_list|(
name|CapacityScheduler
operator|.
name|class
argument_list|)
expr_stmt|;
name|when
argument_list|(
name|mCS
operator|.
name|getResourceCalculator
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|rc
argument_list|)
expr_stmt|;
name|mDisp
operator|=
name|mock
argument_list|(
name|EventHandler
operator|.
name|class
argument_list|)
expr_stmt|;
name|rand
operator|=
operator|new
name|Random
argument_list|()
expr_stmt|;
name|long
name|seed
init|=
name|rand
operator|.
name|nextLong
argument_list|()
decl_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|name
operator|.
name|getMethodName
argument_list|()
operator|+
literal|" SEED: "
operator|+
name|seed
argument_list|)
expr_stmt|;
name|rand
operator|.
name|setSeed
argument_list|(
name|seed
argument_list|)
expr_stmt|;
name|appAlloc
operator|=
literal|0
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testIgnore ()
specifier|public
name|void
name|testIgnore
parameter_list|()
block|{
name|int
index|[]
index|[]
name|qData
init|=
operator|new
name|int
index|[]
index|[]
block|{
comment|//  /   A   B   C
block|{
literal|100
block|,
literal|40
block|,
literal|40
block|,
literal|20
block|}
block|,
comment|// abs
block|{
literal|100
block|,
literal|100
block|,
literal|100
block|,
literal|100
block|}
block|,
comment|// maxCap
block|{
literal|100
block|,
literal|0
block|,
literal|60
block|,
literal|40
block|}
block|,
comment|// used
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|// pending
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|// reserved
block|{
literal|3
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|}
block|,
comment|// apps
block|{
operator|-
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|}
block|,
comment|// req granularity
block|{
literal|3
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|// subqueues
block|}
decl_stmt|;
name|ProportionalCapacityPreemptionPolicy
name|policy
init|=
name|buildPolicy
argument_list|(
name|qData
argument_list|)
decl_stmt|;
name|policy
operator|.
name|editSchedule
argument_list|()
expr_stmt|;
comment|// don't correct imbalances without demand
name|verify
argument_list|(
name|mDisp
argument_list|,
name|never
argument_list|()
argument_list|)
operator|.
name|handle
argument_list|(
name|isA
argument_list|(
name|ContainerPreemptEvent
operator|.
name|class
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testProportionalPreemption ()
specifier|public
name|void
name|testProportionalPreemption
parameter_list|()
block|{
name|int
index|[]
index|[]
name|qData
init|=
operator|new
name|int
index|[]
index|[]
block|{
comment|//  /   A   B   C  D
block|{
literal|100
block|,
literal|10
block|,
literal|40
block|,
literal|20
block|,
literal|30
block|}
block|,
comment|// abs
block|{
literal|100
block|,
literal|100
block|,
literal|100
block|,
literal|100
block|,
literal|100
block|}
block|,
comment|// maxCap
block|{
literal|100
block|,
literal|30
block|,
literal|60
block|,
literal|10
block|,
literal|0
block|}
block|,
comment|// used
block|{
literal|45
block|,
literal|20
block|,
literal|5
block|,
literal|20
block|,
literal|0
block|}
block|,
comment|// pending
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|// reserved
block|{
literal|3
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|}
block|,
comment|// apps
block|{
operator|-
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|}
block|,
comment|// req granularity
block|{
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|// subqueues
block|}
decl_stmt|;
name|ProportionalCapacityPreemptionPolicy
name|policy
init|=
name|buildPolicy
argument_list|(
name|qData
argument_list|)
decl_stmt|;
name|policy
operator|.
name|editSchedule
argument_list|()
expr_stmt|;
name|verify
argument_list|(
name|mDisp
argument_list|,
name|times
argument_list|(
literal|16
argument_list|)
argument_list|)
operator|.
name|handle
argument_list|(
name|argThat
argument_list|(
operator|new
name|IsPreemptionRequestFor
argument_list|(
name|appA
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testMaxCap ()
specifier|public
name|void
name|testMaxCap
parameter_list|()
block|{
name|int
index|[]
index|[]
name|qData
init|=
operator|new
name|int
index|[]
index|[]
block|{
comment|//  /   A   B   C
block|{
literal|100
block|,
literal|40
block|,
literal|40
block|,
literal|20
block|}
block|,
comment|// abs
block|{
literal|100
block|,
literal|100
block|,
literal|45
block|,
literal|100
block|}
block|,
comment|// maxCap
block|{
literal|100
block|,
literal|55
block|,
literal|45
block|,
literal|0
block|}
block|,
comment|// used
block|{
literal|20
block|,
literal|10
block|,
literal|10
block|,
literal|0
block|}
block|,
comment|// pending
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|// reserved
block|{
literal|2
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|}
block|,
comment|// apps
block|{
operator|-
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|}
block|,
comment|// req granularity
block|{
literal|3
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|// subqueues
block|}
decl_stmt|;
name|ProportionalCapacityPreemptionPolicy
name|policy
init|=
name|buildPolicy
argument_list|(
name|qData
argument_list|)
decl_stmt|;
name|policy
operator|.
name|editSchedule
argument_list|()
expr_stmt|;
comment|// despite the imbalance, since B is at maxCap, do not correct
name|verify
argument_list|(
name|mDisp
argument_list|,
name|never
argument_list|()
argument_list|)
operator|.
name|handle
argument_list|(
name|argThat
argument_list|(
operator|new
name|IsPreemptionRequestFor
argument_list|(
name|appA
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testPreemptCycle ()
specifier|public
name|void
name|testPreemptCycle
parameter_list|()
block|{
name|int
index|[]
index|[]
name|qData
init|=
operator|new
name|int
index|[]
index|[]
block|{
comment|//  /   A   B   C
block|{
literal|100
block|,
literal|40
block|,
literal|40
block|,
literal|20
block|}
block|,
comment|// abs
block|{
literal|100
block|,
literal|100
block|,
literal|100
block|,
literal|100
block|}
block|,
comment|// maxCap
block|{
literal|100
block|,
literal|0
block|,
literal|60
block|,
literal|40
block|}
block|,
comment|// used
block|{
literal|10
block|,
literal|10
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|// pending
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|// reserved
block|{
literal|3
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|}
block|,
comment|// apps
block|{
operator|-
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|}
block|,
comment|// req granularity
block|{
literal|3
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|// subqueues
block|}
decl_stmt|;
name|ProportionalCapacityPreemptionPolicy
name|policy
init|=
name|buildPolicy
argument_list|(
name|qData
argument_list|)
decl_stmt|;
name|policy
operator|.
name|editSchedule
argument_list|()
expr_stmt|;
comment|// ensure all pending rsrc from A get preempted from other queues
name|verify
argument_list|(
name|mDisp
argument_list|,
name|times
argument_list|(
literal|10
argument_list|)
argument_list|)
operator|.
name|handle
argument_list|(
name|argThat
argument_list|(
operator|new
name|IsPreemptionRequestFor
argument_list|(
name|appC
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testExpireKill ()
specifier|public
name|void
name|testExpireKill
parameter_list|()
block|{
specifier|final
name|long
name|killTime
init|=
literal|10000L
decl_stmt|;
name|int
index|[]
index|[]
name|qData
init|=
operator|new
name|int
index|[]
index|[]
block|{
comment|//  /   A   B   C
block|{
literal|100
block|,
literal|40
block|,
literal|40
block|,
literal|20
block|}
block|,
comment|// abs
block|{
literal|100
block|,
literal|100
block|,
literal|100
block|,
literal|100
block|}
block|,
comment|// maxCap
block|{
literal|100
block|,
literal|0
block|,
literal|60
block|,
literal|40
block|}
block|,
comment|// used
block|{
literal|10
block|,
literal|10
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|// pending
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|// reserved
block|{
literal|3
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|}
block|,
comment|// apps
block|{
operator|-
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|}
block|,
comment|// req granularity
block|{
literal|3
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|// subqueues
block|}
decl_stmt|;
name|conf
operator|.
name|setLong
argument_list|(
name|WAIT_TIME_BEFORE_KILL
argument_list|,
name|killTime
argument_list|)
expr_stmt|;
name|ProportionalCapacityPreemptionPolicy
name|policy
init|=
name|buildPolicy
argument_list|(
name|qData
argument_list|)
decl_stmt|;
comment|// ensure all pending rsrc from A get preempted from other queues
name|when
argument_list|(
name|mClock
operator|.
name|getTime
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
literal|0L
argument_list|)
expr_stmt|;
name|policy
operator|.
name|editSchedule
argument_list|()
expr_stmt|;
name|verify
argument_list|(
name|mDisp
argument_list|,
name|times
argument_list|(
literal|10
argument_list|)
argument_list|)
operator|.
name|handle
argument_list|(
name|argThat
argument_list|(
operator|new
name|IsPreemptionRequestFor
argument_list|(
name|appC
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|// requests reiterated
name|when
argument_list|(
name|mClock
operator|.
name|getTime
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|killTime
operator|/
literal|2
argument_list|)
expr_stmt|;
name|policy
operator|.
name|editSchedule
argument_list|()
expr_stmt|;
name|verify
argument_list|(
name|mDisp
argument_list|,
name|times
argument_list|(
literal|20
argument_list|)
argument_list|)
operator|.
name|handle
argument_list|(
name|argThat
argument_list|(
operator|new
name|IsPreemptionRequestFor
argument_list|(
name|appC
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|// kill req sent
name|when
argument_list|(
name|mClock
operator|.
name|getTime
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|killTime
operator|+
literal|1
argument_list|)
expr_stmt|;
name|policy
operator|.
name|editSchedule
argument_list|()
expr_stmt|;
name|verify
argument_list|(
name|mDisp
argument_list|,
name|times
argument_list|(
literal|30
argument_list|)
argument_list|)
operator|.
name|handle
argument_list|(
name|evtCaptor
operator|.
name|capture
argument_list|()
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|ContainerPreemptEvent
argument_list|>
name|events
init|=
name|evtCaptor
operator|.
name|getAllValues
argument_list|()
decl_stmt|;
for|for
control|(
name|ContainerPreemptEvent
name|e
range|:
name|events
operator|.
name|subList
argument_list|(
literal|20
argument_list|,
literal|30
argument_list|)
control|)
block|{
name|assertEquals
argument_list|(
name|appC
argument_list|,
name|e
operator|.
name|getAppId
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|KILL_CONTAINER
argument_list|,
name|e
operator|.
name|getType
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Test
DECL|method|testDeadzone ()
specifier|public
name|void
name|testDeadzone
parameter_list|()
block|{
name|int
index|[]
index|[]
name|qData
init|=
operator|new
name|int
index|[]
index|[]
block|{
comment|//  /   A   B   C
block|{
literal|100
block|,
literal|40
block|,
literal|40
block|,
literal|20
block|}
block|,
comment|// abs
block|{
literal|100
block|,
literal|100
block|,
literal|100
block|,
literal|100
block|}
block|,
comment|// maxCap
block|{
literal|100
block|,
literal|39
block|,
literal|43
block|,
literal|21
block|}
block|,
comment|// used
block|{
literal|10
block|,
literal|10
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|// pending
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|// reserved
block|{
literal|3
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|}
block|,
comment|// apps
block|{
operator|-
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|}
block|,
comment|// req granularity
block|{
literal|3
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|// subqueues
block|}
decl_stmt|;
name|conf
operator|.
name|setFloat
argument_list|(
name|MAX_IGNORED_OVER_CAPACITY
argument_list|,
operator|(
name|float
operator|)
literal|0.1
argument_list|)
expr_stmt|;
name|ProportionalCapacityPreemptionPolicy
name|policy
init|=
name|buildPolicy
argument_list|(
name|qData
argument_list|)
decl_stmt|;
name|policy
operator|.
name|editSchedule
argument_list|()
expr_stmt|;
comment|// ignore 10% overcapacity to avoid jitter
name|verify
argument_list|(
name|mDisp
argument_list|,
name|never
argument_list|()
argument_list|)
operator|.
name|handle
argument_list|(
name|isA
argument_list|(
name|ContainerPreemptEvent
operator|.
name|class
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testOverCapacityImbalance ()
specifier|public
name|void
name|testOverCapacityImbalance
parameter_list|()
block|{
name|int
index|[]
index|[]
name|qData
init|=
operator|new
name|int
index|[]
index|[]
block|{
comment|//  /   A   B   C
block|{
literal|100
block|,
literal|40
block|,
literal|40
block|,
literal|20
block|}
block|,
comment|// abs
block|{
literal|100
block|,
literal|100
block|,
literal|100
block|,
literal|100
block|}
block|,
comment|// maxCap
block|{
literal|100
block|,
literal|55
block|,
literal|45
block|,
literal|0
block|}
block|,
comment|// used
block|{
literal|20
block|,
literal|10
block|,
literal|10
block|,
literal|0
block|}
block|,
comment|// pending
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|// reserved
block|{
literal|2
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|}
block|,
comment|// apps
block|{
operator|-
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|}
block|,
comment|// req granularity
block|{
literal|3
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|// subqueues
block|}
decl_stmt|;
name|ProportionalCapacityPreemptionPolicy
name|policy
init|=
name|buildPolicy
argument_list|(
name|qData
argument_list|)
decl_stmt|;
name|policy
operator|.
name|editSchedule
argument_list|()
expr_stmt|;
comment|// correct imbalance between over-capacity queues
name|verify
argument_list|(
name|mDisp
argument_list|,
name|times
argument_list|(
literal|5
argument_list|)
argument_list|)
operator|.
name|handle
argument_list|(
name|argThat
argument_list|(
operator|new
name|IsPreemptionRequestFor
argument_list|(
name|appA
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testNaturalTermination ()
specifier|public
name|void
name|testNaturalTermination
parameter_list|()
block|{
name|int
index|[]
index|[]
name|qData
init|=
operator|new
name|int
index|[]
index|[]
block|{
comment|//  /   A   B   C
block|{
literal|100
block|,
literal|40
block|,
literal|40
block|,
literal|20
block|}
block|,
comment|// abs
block|{
literal|100
block|,
literal|100
block|,
literal|100
block|,
literal|100
block|}
block|,
comment|// maxCap
block|{
literal|100
block|,
literal|55
block|,
literal|45
block|,
literal|0
block|}
block|,
comment|// used
block|{
literal|20
block|,
literal|10
block|,
literal|10
block|,
literal|0
block|}
block|,
comment|// pending
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|// reserved
block|{
literal|2
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|}
block|,
comment|// apps
block|{
operator|-
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|}
block|,
comment|// req granularity
block|{
literal|3
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|// subqueues
block|}
decl_stmt|;
name|conf
operator|.
name|setFloat
argument_list|(
name|NATURAL_TERMINATION_FACTOR
argument_list|,
operator|(
name|float
operator|)
literal|0.1
argument_list|)
expr_stmt|;
name|ProportionalCapacityPreemptionPolicy
name|policy
init|=
name|buildPolicy
argument_list|(
name|qData
argument_list|)
decl_stmt|;
name|policy
operator|.
name|editSchedule
argument_list|()
expr_stmt|;
comment|// ignore 10% imbalance between over-capacity queues
name|verify
argument_list|(
name|mDisp
argument_list|,
name|never
argument_list|()
argument_list|)
operator|.
name|handle
argument_list|(
name|isA
argument_list|(
name|ContainerPreemptEvent
operator|.
name|class
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testObserveOnly ()
specifier|public
name|void
name|testObserveOnly
parameter_list|()
block|{
name|int
index|[]
index|[]
name|qData
init|=
operator|new
name|int
index|[]
index|[]
block|{
comment|//  /   A   B   C
block|{
literal|100
block|,
literal|40
block|,
literal|40
block|,
literal|20
block|}
block|,
comment|// abs
block|{
literal|100
block|,
literal|100
block|,
literal|100
block|,
literal|100
block|}
block|,
comment|// maxCap
block|{
literal|100
block|,
literal|90
block|,
literal|10
block|,
literal|0
block|}
block|,
comment|// used
block|{
literal|80
block|,
literal|10
block|,
literal|20
block|,
literal|50
block|}
block|,
comment|// pending
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|// reserved
block|{
literal|2
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|}
block|,
comment|// apps
block|{
operator|-
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|}
block|,
comment|// req granularity
block|{
literal|3
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|// subqueues
block|}
decl_stmt|;
name|conf
operator|.
name|setBoolean
argument_list|(
name|OBSERVE_ONLY
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|ProportionalCapacityPreemptionPolicy
name|policy
init|=
name|buildPolicy
argument_list|(
name|qData
argument_list|)
decl_stmt|;
name|policy
operator|.
name|editSchedule
argument_list|()
expr_stmt|;
comment|// verify even severe imbalance not affected
name|verify
argument_list|(
name|mDisp
argument_list|,
name|never
argument_list|()
argument_list|)
operator|.
name|handle
argument_list|(
name|isA
argument_list|(
name|ContainerPreemptEvent
operator|.
name|class
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testHierarchical ()
specifier|public
name|void
name|testHierarchical
parameter_list|()
block|{
name|int
index|[]
index|[]
name|qData
init|=
operator|new
name|int
index|[]
index|[]
block|{
comment|//  /    A   B   C    D   E   F
block|{
literal|200
block|,
literal|100
block|,
literal|50
block|,
literal|50
block|,
literal|100
block|,
literal|10
block|,
literal|90
block|}
block|,
comment|// abs
block|{
literal|200
block|,
literal|200
block|,
literal|200
block|,
literal|200
block|,
literal|200
block|,
literal|200
block|,
literal|200
block|}
block|,
comment|// maxCap
block|{
literal|200
block|,
literal|110
block|,
literal|60
block|,
literal|50
block|,
literal|90
block|,
literal|90
block|,
literal|0
block|}
block|,
comment|// used
block|{
literal|10
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|10
block|,
literal|0
block|,
literal|10
block|}
block|,
comment|// pending
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|// reserved
block|{
literal|4
block|,
literal|2
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|1
block|,
literal|1
block|}
block|,
comment|// apps
block|{
operator|-
literal|1
block|,
operator|-
literal|1
block|,
literal|1
block|,
literal|1
block|,
operator|-
literal|1
block|,
literal|1
block|,
literal|1
block|}
block|,
comment|// req granularity
block|{
literal|2
block|,
literal|2
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|// subqueues
block|}
decl_stmt|;
name|ProportionalCapacityPreemptionPolicy
name|policy
init|=
name|buildPolicy
argument_list|(
name|qData
argument_list|)
decl_stmt|;
name|policy
operator|.
name|editSchedule
argument_list|()
expr_stmt|;
comment|// verify capacity taken from A1, not B1 despite B1 being far over
comment|// its absolute guaranteed capacity
name|verify
argument_list|(
name|mDisp
argument_list|,
name|times
argument_list|(
literal|10
argument_list|)
argument_list|)
operator|.
name|handle
argument_list|(
name|argThat
argument_list|(
operator|new
name|IsPreemptionRequestFor
argument_list|(
name|appA
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testZeroGuar ()
specifier|public
name|void
name|testZeroGuar
parameter_list|()
block|{
name|int
index|[]
index|[]
name|qData
init|=
operator|new
name|int
index|[]
index|[]
block|{
comment|//  /    A   B   C    D   E   F
block|{
literal|200
block|,
literal|100
block|,
literal|0
block|,
literal|99
block|,
literal|100
block|,
literal|10
block|,
literal|90
block|}
block|,
comment|// abs
block|{
literal|200
block|,
literal|200
block|,
literal|200
block|,
literal|200
block|,
literal|200
block|,
literal|200
block|,
literal|200
block|}
block|,
comment|// maxCap
block|{
literal|170
block|,
literal|80
block|,
literal|60
block|,
literal|20
block|,
literal|90
block|,
literal|90
block|,
literal|0
block|}
block|,
comment|// used
block|{
literal|10
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|10
block|,
literal|0
block|,
literal|10
block|}
block|,
comment|// pending
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|// reserved
block|{
literal|4
block|,
literal|2
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|1
block|,
literal|1
block|}
block|,
comment|// apps
block|{
operator|-
literal|1
block|,
operator|-
literal|1
block|,
literal|1
block|,
literal|1
block|,
operator|-
literal|1
block|,
literal|1
block|,
literal|1
block|}
block|,
comment|// req granularity
block|{
literal|2
block|,
literal|2
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|// subqueues
block|}
decl_stmt|;
name|ProportionalCapacityPreemptionPolicy
name|policy
init|=
name|buildPolicy
argument_list|(
name|qData
argument_list|)
decl_stmt|;
name|policy
operator|.
name|editSchedule
argument_list|()
expr_stmt|;
comment|// verify capacity taken from A1, not B1 despite B1 being far over
comment|// its absolute guaranteed capacity
name|verify
argument_list|(
name|mDisp
argument_list|,
name|never
argument_list|()
argument_list|)
operator|.
name|handle
argument_list|(
name|argThat
argument_list|(
operator|new
name|IsPreemptionRequestFor
argument_list|(
name|appA
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testZeroGuarOverCap ()
specifier|public
name|void
name|testZeroGuarOverCap
parameter_list|()
block|{
name|int
index|[]
index|[]
name|qData
init|=
operator|new
name|int
index|[]
index|[]
block|{
comment|//  /    A   B   C    D   E   F
block|{
literal|200
block|,
literal|100
block|,
literal|0
block|,
literal|99
block|,
literal|0
block|,
literal|100
block|,
literal|100
block|}
block|,
comment|// abs
block|{
literal|200
block|,
literal|200
block|,
literal|200
block|,
literal|200
block|,
literal|200
block|,
literal|200
block|,
literal|200
block|}
block|,
comment|// maxCap
block|{
literal|170
block|,
literal|170
block|,
literal|60
block|,
literal|20
block|,
literal|90
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|// used
block|{
literal|85
block|,
literal|50
block|,
literal|30
block|,
literal|10
block|,
literal|10
block|,
literal|20
block|,
literal|20
block|}
block|,
comment|// pending
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|// reserved
block|{
literal|4
block|,
literal|3
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|}
block|,
comment|// apps
block|{
operator|-
literal|1
block|,
operator|-
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
operator|-
literal|1
block|,
literal|1
block|}
block|,
comment|// req granularity
block|{
literal|2
block|,
literal|3
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|}
block|,
comment|// subqueues
block|}
decl_stmt|;
name|ProportionalCapacityPreemptionPolicy
name|policy
init|=
name|buildPolicy
argument_list|(
name|qData
argument_list|)
decl_stmt|;
name|policy
operator|.
name|editSchedule
argument_list|()
expr_stmt|;
comment|// we verify both that C has priority on B and D (has it has>0 guarantees)
comment|// and that B and D are force to share their over capacity fairly (as they
comment|// are both zero-guarantees) hence D sees some of its containers preempted
name|verify
argument_list|(
name|mDisp
argument_list|,
name|times
argument_list|(
literal|14
argument_list|)
argument_list|)
operator|.
name|handle
argument_list|(
name|argThat
argument_list|(
operator|new
name|IsPreemptionRequestFor
argument_list|(
name|appC
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testHierarchicalLarge ()
specifier|public
name|void
name|testHierarchicalLarge
parameter_list|()
block|{
name|int
index|[]
index|[]
name|qData
init|=
operator|new
name|int
index|[]
index|[]
block|{
comment|//  /    A   B   C    D   E   F    G   H   I
block|{
literal|400
block|,
literal|200
block|,
literal|60
block|,
literal|140
block|,
literal|100
block|,
literal|70
block|,
literal|30
block|,
literal|100
block|,
literal|10
block|,
literal|90
block|}
block|,
comment|// abs
block|{
literal|400
block|,
literal|400
block|,
literal|400
block|,
literal|400
block|,
literal|400
block|,
literal|400
block|,
literal|400
block|,
literal|400
block|,
literal|400
block|,
literal|400
block|, }
block|,
comment|// maxCap
block|{
literal|400
block|,
literal|210
block|,
literal|70
block|,
literal|140
block|,
literal|100
block|,
literal|50
block|,
literal|50
block|,
literal|90
block|,
literal|90
block|,
literal|0
block|}
block|,
comment|// used
block|{
literal|10
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|15
block|}
block|,
comment|// pending
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|// reserved
block|{
literal|6
block|,
literal|2
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|1
block|,
literal|1
block|}
block|,
comment|// apps
block|{
operator|-
literal|1
block|,
operator|-
literal|1
block|,
literal|1
block|,
literal|1
block|,
operator|-
literal|1
block|,
literal|1
block|,
literal|1
block|,
operator|-
literal|1
block|,
literal|1
block|,
literal|1
block|}
block|,
comment|// req granularity
block|{
literal|3
block|,
literal|2
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|// subqueues
block|}
decl_stmt|;
name|ProportionalCapacityPreemptionPolicy
name|policy
init|=
name|buildPolicy
argument_list|(
name|qData
argument_list|)
decl_stmt|;
name|policy
operator|.
name|editSchedule
argument_list|()
expr_stmt|;
comment|// verify capacity taken from A1, not H1 despite H1 being far over
comment|// its absolute guaranteed capacity
comment|// XXX note: compensating for rounding error in Resources.multiplyTo
comment|// which is likely triggered since we use small numbers for readability
name|verify
argument_list|(
name|mDisp
argument_list|,
name|times
argument_list|(
literal|9
argument_list|)
argument_list|)
operator|.
name|handle
argument_list|(
name|argThat
argument_list|(
operator|new
name|IsPreemptionRequestFor
argument_list|(
name|appA
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|verify
argument_list|(
name|mDisp
argument_list|,
name|times
argument_list|(
literal|4
argument_list|)
argument_list|)
operator|.
name|handle
argument_list|(
name|argThat
argument_list|(
operator|new
name|IsPreemptionRequestFor
argument_list|(
name|appE
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testContainerOrdering ()
specifier|public
name|void
name|testContainerOrdering
parameter_list|()
block|{
name|List
argument_list|<
name|RMContainer
argument_list|>
name|containers
init|=
operator|new
name|ArrayList
argument_list|<
name|RMContainer
argument_list|>
argument_list|()
decl_stmt|;
name|ApplicationAttemptId
name|appAttId
init|=
name|ApplicationAttemptId
operator|.
name|newInstance
argument_list|(
name|ApplicationId
operator|.
name|newInstance
argument_list|(
name|TS
argument_list|,
literal|10
argument_list|)
argument_list|,
literal|0
argument_list|)
decl_stmt|;
comment|// create a set of containers
name|RMContainer
name|rm1
init|=
name|mockContainer
argument_list|(
name|appAttId
argument_list|,
literal|5
argument_list|,
name|mock
argument_list|(
name|Resource
operator|.
name|class
argument_list|)
argument_list|,
literal|3
argument_list|)
decl_stmt|;
name|RMContainer
name|rm2
init|=
name|mockContainer
argument_list|(
name|appAttId
argument_list|,
literal|3
argument_list|,
name|mock
argument_list|(
name|Resource
operator|.
name|class
argument_list|)
argument_list|,
literal|3
argument_list|)
decl_stmt|;
name|RMContainer
name|rm3
init|=
name|mockContainer
argument_list|(
name|appAttId
argument_list|,
literal|2
argument_list|,
name|mock
argument_list|(
name|Resource
operator|.
name|class
argument_list|)
argument_list|,
literal|2
argument_list|)
decl_stmt|;
name|RMContainer
name|rm4
init|=
name|mockContainer
argument_list|(
name|appAttId
argument_list|,
literal|1
argument_list|,
name|mock
argument_list|(
name|Resource
operator|.
name|class
argument_list|)
argument_list|,
literal|2
argument_list|)
decl_stmt|;
name|RMContainer
name|rm5
init|=
name|mockContainer
argument_list|(
name|appAttId
argument_list|,
literal|4
argument_list|,
name|mock
argument_list|(
name|Resource
operator|.
name|class
argument_list|)
argument_list|,
literal|1
argument_list|)
decl_stmt|;
comment|// insert them in non-sorted order
name|containers
operator|.
name|add
argument_list|(
name|rm3
argument_list|)
expr_stmt|;
name|containers
operator|.
name|add
argument_list|(
name|rm2
argument_list|)
expr_stmt|;
name|containers
operator|.
name|add
argument_list|(
name|rm1
argument_list|)
expr_stmt|;
name|containers
operator|.
name|add
argument_list|(
name|rm5
argument_list|)
expr_stmt|;
name|containers
operator|.
name|add
argument_list|(
name|rm4
argument_list|)
expr_stmt|;
comment|// sort them
name|ProportionalCapacityPreemptionPolicy
operator|.
name|sortContainers
argument_list|(
name|containers
argument_list|)
expr_stmt|;
comment|// verify the "priority"-first, "reverse container-id"-second
comment|// ordering is enforced correctly
assert|assert
name|containers
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|.
name|equals
argument_list|(
name|rm1
argument_list|)
assert|;
assert|assert
name|containers
operator|.
name|get
argument_list|(
literal|1
argument_list|)
operator|.
name|equals
argument_list|(
name|rm2
argument_list|)
assert|;
assert|assert
name|containers
operator|.
name|get
argument_list|(
literal|2
argument_list|)
operator|.
name|equals
argument_list|(
name|rm3
argument_list|)
assert|;
assert|assert
name|containers
operator|.
name|get
argument_list|(
literal|3
argument_list|)
operator|.
name|equals
argument_list|(
name|rm4
argument_list|)
assert|;
assert|assert
name|containers
operator|.
name|get
argument_list|(
literal|4
argument_list|)
operator|.
name|equals
argument_list|(
name|rm5
argument_list|)
assert|;
block|}
annotation|@
name|Test
DECL|method|testPolicyInitializeAfterSchedulerInitialized ()
specifier|public
name|void
name|testPolicyInitializeAfterSchedulerInitialized
parameter_list|()
block|{
name|Configuration
name|conf
init|=
operator|new
name|Configuration
argument_list|()
decl_stmt|;
name|conf
operator|.
name|set
argument_list|(
name|YarnConfiguration
operator|.
name|RM_SCHEDULER_MONITOR_POLICIES
argument_list|,
name|ProportionalCapacityPreemptionPolicy
operator|.
name|class
operator|.
name|getCanonicalName
argument_list|()
argument_list|)
expr_stmt|;
name|conf
operator|.
name|setBoolean
argument_list|(
name|YarnConfiguration
operator|.
name|RM_SCHEDULER_ENABLE_MONITORS
argument_list|,
literal|true
argument_list|)
expr_stmt|;
annotation|@
name|SuppressWarnings
argument_list|(
literal|"resource"
argument_list|)
name|MockRM
name|rm
init|=
operator|new
name|MockRM
argument_list|(
name|conf
argument_list|)
decl_stmt|;
name|rm
operator|.
name|init
argument_list|(
name|conf
argument_list|)
expr_stmt|;
comment|// ProportionalCapacityPreemptionPolicy should be initialized after
comment|// CapacityScheduler initialized. We will
comment|// 1) find SchedulingMonitor from RMActiveService's service list,
comment|// 2) check if ResourceCalculator in policy is null or not.
comment|// If it's not null, we can come to a conclusion that policy initialized
comment|// after scheduler got initialized
for|for
control|(
name|Service
name|service
range|:
name|rm
operator|.
name|getRMActiveService
argument_list|()
operator|.
name|getServices
argument_list|()
control|)
block|{
if|if
condition|(
name|service
operator|instanceof
name|SchedulingMonitor
condition|)
block|{
name|ProportionalCapacityPreemptionPolicy
name|policy
init|=
call|(
name|ProportionalCapacityPreemptionPolicy
call|)
argument_list|(
operator|(
name|SchedulingMonitor
operator|)
name|service
argument_list|)
operator|.
name|getSchedulingEditPolicy
argument_list|()
decl_stmt|;
name|assertNotNull
argument_list|(
name|policy
operator|.
name|getResourceCalculator
argument_list|()
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|fail
argument_list|(
literal|"Failed to find SchedulingMonitor service, please check what happened"
argument_list|)
expr_stmt|;
block|}
DECL|class|IsPreemptionRequestFor
specifier|static
class|class
name|IsPreemptionRequestFor
extends|extends
name|ArgumentMatcher
argument_list|<
name|ContainerPreemptEvent
argument_list|>
block|{
DECL|field|appAttId
specifier|private
specifier|final
name|ApplicationAttemptId
name|appAttId
decl_stmt|;
DECL|field|type
specifier|private
specifier|final
name|ContainerPreemptEventType
name|type
decl_stmt|;
DECL|method|IsPreemptionRequestFor (ApplicationAttemptId appAttId)
name|IsPreemptionRequestFor
parameter_list|(
name|ApplicationAttemptId
name|appAttId
parameter_list|)
block|{
name|this
argument_list|(
name|appAttId
argument_list|,
name|PREEMPT_CONTAINER
argument_list|)
expr_stmt|;
block|}
DECL|method|IsPreemptionRequestFor (ApplicationAttemptId appAttId, ContainerPreemptEventType type)
name|IsPreemptionRequestFor
parameter_list|(
name|ApplicationAttemptId
name|appAttId
parameter_list|,
name|ContainerPreemptEventType
name|type
parameter_list|)
block|{
name|this
operator|.
name|appAttId
operator|=
name|appAttId
expr_stmt|;
name|this
operator|.
name|type
operator|=
name|type
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|matches (Object o)
specifier|public
name|boolean
name|matches
parameter_list|(
name|Object
name|o
parameter_list|)
block|{
return|return
name|appAttId
operator|.
name|equals
argument_list|(
operator|(
operator|(
name|ContainerPreemptEvent
operator|)
name|o
operator|)
operator|.
name|getAppId
argument_list|()
argument_list|)
operator|&&
name|type
operator|.
name|equals
argument_list|(
operator|(
operator|(
name|ContainerPreemptEvent
operator|)
name|o
operator|)
operator|.
name|getType
argument_list|()
argument_list|)
return|;
block|}
annotation|@
name|Override
DECL|method|toString ()
specifier|public
name|String
name|toString
parameter_list|()
block|{
return|return
name|appAttId
operator|.
name|toString
argument_list|()
return|;
block|}
block|}
DECL|method|buildPolicy (int[][] qData)
name|ProportionalCapacityPreemptionPolicy
name|buildPolicy
parameter_list|(
name|int
index|[]
index|[]
name|qData
parameter_list|)
block|{
name|ProportionalCapacityPreemptionPolicy
name|policy
init|=
operator|new
name|ProportionalCapacityPreemptionPolicy
argument_list|(
name|conf
argument_list|,
name|mDisp
argument_list|,
name|mCS
argument_list|,
name|mClock
argument_list|)
decl_stmt|;
name|ParentQueue
name|mRoot
init|=
name|buildMockRootQueue
argument_list|(
name|rand
argument_list|,
name|qData
argument_list|)
decl_stmt|;
name|when
argument_list|(
name|mCS
operator|.
name|getRootQueue
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|mRoot
argument_list|)
expr_stmt|;
name|Resource
name|clusterResources
init|=
name|Resource
operator|.
name|newInstance
argument_list|(
name|leafAbsCapacities
argument_list|(
name|qData
index|[
literal|0
index|]
argument_list|,
name|qData
index|[
literal|7
index|]
argument_list|)
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|when
argument_list|(
name|mCS
operator|.
name|getClusterResource
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|clusterResources
argument_list|)
expr_stmt|;
return|return
name|policy
return|;
block|}
DECL|method|buildMockRootQueue (Random r, int[]... queueData)
name|ParentQueue
name|buildMockRootQueue
parameter_list|(
name|Random
name|r
parameter_list|,
name|int
index|[]
modifier|...
name|queueData
parameter_list|)
block|{
name|int
index|[]
name|abs
init|=
name|queueData
index|[
literal|0
index|]
decl_stmt|;
name|int
index|[]
name|maxCap
init|=
name|queueData
index|[
literal|1
index|]
decl_stmt|;
name|int
index|[]
name|used
init|=
name|queueData
index|[
literal|2
index|]
decl_stmt|;
name|int
index|[]
name|pending
init|=
name|queueData
index|[
literal|3
index|]
decl_stmt|;
name|int
index|[]
name|reserved
init|=
name|queueData
index|[
literal|4
index|]
decl_stmt|;
name|int
index|[]
name|apps
init|=
name|queueData
index|[
literal|5
index|]
decl_stmt|;
name|int
index|[]
name|gran
init|=
name|queueData
index|[
literal|6
index|]
decl_stmt|;
name|int
index|[]
name|queues
init|=
name|queueData
index|[
literal|7
index|]
decl_stmt|;
return|return
name|mockNested
argument_list|(
name|abs
argument_list|,
name|maxCap
argument_list|,
name|used
argument_list|,
name|pending
argument_list|,
name|reserved
argument_list|,
name|apps
argument_list|,
name|gran
argument_list|,
name|queues
argument_list|)
return|;
block|}
DECL|method|mockNested (int[] abs, int[] maxCap, int[] used, int[] pending, int[] reserved, int[] apps, int[] gran, int[] queues)
name|ParentQueue
name|mockNested
parameter_list|(
name|int
index|[]
name|abs
parameter_list|,
name|int
index|[]
name|maxCap
parameter_list|,
name|int
index|[]
name|used
parameter_list|,
name|int
index|[]
name|pending
parameter_list|,
name|int
index|[]
name|reserved
parameter_list|,
name|int
index|[]
name|apps
parameter_list|,
name|int
index|[]
name|gran
parameter_list|,
name|int
index|[]
name|queues
parameter_list|)
block|{
name|float
name|tot
init|=
name|leafAbsCapacities
argument_list|(
name|abs
argument_list|,
name|queues
argument_list|)
decl_stmt|;
name|Deque
argument_list|<
name|ParentQueue
argument_list|>
name|pqs
init|=
operator|new
name|LinkedList
argument_list|<
name|ParentQueue
argument_list|>
argument_list|()
decl_stmt|;
name|ParentQueue
name|root
init|=
name|mockParentQueue
argument_list|(
literal|null
argument_list|,
name|queues
index|[
literal|0
index|]
argument_list|,
name|pqs
argument_list|)
decl_stmt|;
name|when
argument_list|(
name|root
operator|.
name|getQueueName
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
literal|"/"
argument_list|)
expr_stmt|;
name|when
argument_list|(
name|root
operator|.
name|getAbsoluteUsedCapacity
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|used
index|[
literal|0
index|]
operator|/
name|tot
argument_list|)
expr_stmt|;
name|when
argument_list|(
name|root
operator|.
name|getAbsoluteCapacity
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|abs
index|[
literal|0
index|]
operator|/
name|tot
argument_list|)
expr_stmt|;
name|when
argument_list|(
name|root
operator|.
name|getAbsoluteMaximumCapacity
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|maxCap
index|[
literal|0
index|]
operator|/
name|tot
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|1
init|;
name|i
operator|<
name|queues
operator|.
name|length
condition|;
operator|++
name|i
control|)
block|{
specifier|final
name|CSQueue
name|q
decl_stmt|;
specifier|final
name|ParentQueue
name|p
init|=
name|pqs
operator|.
name|removeLast
argument_list|()
decl_stmt|;
specifier|final
name|String
name|queueName
init|=
literal|"queue"
operator|+
operator|(
call|(
name|char
call|)
argument_list|(
literal|'A'
operator|+
name|i
operator|-
literal|1
argument_list|)
operator|)
decl_stmt|;
if|if
condition|(
name|queues
index|[
name|i
index|]
operator|>
literal|0
condition|)
block|{
name|q
operator|=
name|mockParentQueue
argument_list|(
name|p
argument_list|,
name|queues
index|[
name|i
index|]
argument_list|,
name|pqs
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|q
operator|=
name|mockLeafQueue
argument_list|(
name|p
argument_list|,
name|tot
argument_list|,
name|i
argument_list|,
name|abs
argument_list|,
name|used
argument_list|,
name|pending
argument_list|,
name|reserved
argument_list|,
name|apps
argument_list|,
name|gran
argument_list|)
expr_stmt|;
block|}
name|when
argument_list|(
name|q
operator|.
name|getParent
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|when
argument_list|(
name|q
operator|.
name|getQueueName
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|queueName
argument_list|)
expr_stmt|;
name|when
argument_list|(
name|q
operator|.
name|getAbsoluteUsedCapacity
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|used
index|[
name|i
index|]
operator|/
name|tot
argument_list|)
expr_stmt|;
name|when
argument_list|(
name|q
operator|.
name|getAbsoluteCapacity
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|abs
index|[
name|i
index|]
operator|/
name|tot
argument_list|)
expr_stmt|;
name|when
argument_list|(
name|q
operator|.
name|getAbsoluteMaximumCapacity
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|maxCap
index|[
name|i
index|]
operator|/
name|tot
argument_list|)
expr_stmt|;
block|}
assert|assert
literal|0
operator|==
name|pqs
operator|.
name|size
argument_list|()
assert|;
return|return
name|root
return|;
block|}
DECL|method|mockParentQueue (ParentQueue p, int subqueues, Deque<ParentQueue> pqs)
name|ParentQueue
name|mockParentQueue
parameter_list|(
name|ParentQueue
name|p
parameter_list|,
name|int
name|subqueues
parameter_list|,
name|Deque
argument_list|<
name|ParentQueue
argument_list|>
name|pqs
parameter_list|)
block|{
name|ParentQueue
name|pq
init|=
name|mock
argument_list|(
name|ParentQueue
operator|.
name|class
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|CSQueue
argument_list|>
name|cqs
init|=
operator|new
name|ArrayList
argument_list|<
name|CSQueue
argument_list|>
argument_list|()
decl_stmt|;
name|when
argument_list|(
name|pq
operator|.
name|getChildQueues
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|cqs
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|subqueues
condition|;
operator|++
name|i
control|)
block|{
name|pqs
operator|.
name|add
argument_list|(
name|pq
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p
operator|!=
literal|null
condition|)
block|{
name|p
operator|.
name|getChildQueues
argument_list|()
operator|.
name|add
argument_list|(
name|pq
argument_list|)
expr_stmt|;
block|}
return|return
name|pq
return|;
block|}
DECL|method|mockLeafQueue (ParentQueue p, float tot, int i, int[] abs, int[] used, int[] pending, int[] reserved, int[] apps, int[] gran)
name|LeafQueue
name|mockLeafQueue
parameter_list|(
name|ParentQueue
name|p
parameter_list|,
name|float
name|tot
parameter_list|,
name|int
name|i
parameter_list|,
name|int
index|[]
name|abs
parameter_list|,
name|int
index|[]
name|used
parameter_list|,
name|int
index|[]
name|pending
parameter_list|,
name|int
index|[]
name|reserved
parameter_list|,
name|int
index|[]
name|apps
parameter_list|,
name|int
index|[]
name|gran
parameter_list|)
block|{
name|LeafQueue
name|lq
init|=
name|mock
argument_list|(
name|LeafQueue
operator|.
name|class
argument_list|)
decl_stmt|;
name|when
argument_list|(
name|lq
operator|.
name|getTotalResourcePending
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|Resource
operator|.
name|newInstance
argument_list|(
name|pending
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|// consider moving where CapacityScheduler::comparator accessible
name|NavigableSet
argument_list|<
name|FiCaSchedulerApp
argument_list|>
name|qApps
init|=
operator|new
name|TreeSet
argument_list|<
name|FiCaSchedulerApp
argument_list|>
argument_list|(
operator|new
name|Comparator
argument_list|<
name|FiCaSchedulerApp
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|int
name|compare
parameter_list|(
name|FiCaSchedulerApp
name|a1
parameter_list|,
name|FiCaSchedulerApp
name|a2
parameter_list|)
block|{
return|return
name|a1
operator|.
name|getApplicationAttemptId
argument_list|()
operator|.
name|compareTo
argument_list|(
name|a2
operator|.
name|getApplicationAttemptId
argument_list|()
argument_list|)
return|;
block|}
block|}
argument_list|)
decl_stmt|;
comment|// applications are added in global L->R order in queues
if|if
condition|(
name|apps
index|[
name|i
index|]
operator|!=
literal|0
condition|)
block|{
name|int
name|aUsed
init|=
name|used
index|[
name|i
index|]
operator|/
name|apps
index|[
name|i
index|]
decl_stmt|;
name|int
name|aPending
init|=
name|pending
index|[
name|i
index|]
operator|/
name|apps
index|[
name|i
index|]
decl_stmt|;
name|int
name|aReserve
init|=
name|reserved
index|[
name|i
index|]
operator|/
name|apps
index|[
name|i
index|]
decl_stmt|;
for|for
control|(
name|int
name|a
init|=
literal|0
init|;
name|a
operator|<
name|apps
index|[
name|i
index|]
condition|;
operator|++
name|a
control|)
block|{
name|qApps
operator|.
name|add
argument_list|(
name|mockApp
argument_list|(
name|i
argument_list|,
name|appAlloc
argument_list|,
name|aUsed
argument_list|,
name|aPending
argument_list|,
name|aReserve
argument_list|,
name|gran
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
operator|++
name|appAlloc
expr_stmt|;
block|}
block|}
name|when
argument_list|(
name|lq
operator|.
name|getApplications
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|qApps
argument_list|)
expr_stmt|;
name|p
operator|.
name|getChildQueues
argument_list|()
operator|.
name|add
argument_list|(
name|lq
argument_list|)
expr_stmt|;
return|return
name|lq
return|;
block|}
DECL|method|mockApp (int qid, int id, int used, int pending, int reserved, int gran)
name|FiCaSchedulerApp
name|mockApp
parameter_list|(
name|int
name|qid
parameter_list|,
name|int
name|id
parameter_list|,
name|int
name|used
parameter_list|,
name|int
name|pending
parameter_list|,
name|int
name|reserved
parameter_list|,
name|int
name|gran
parameter_list|)
block|{
name|FiCaSchedulerApp
name|app
init|=
name|mock
argument_list|(
name|FiCaSchedulerApp
operator|.
name|class
argument_list|)
decl_stmt|;
name|ApplicationId
name|appId
init|=
name|ApplicationId
operator|.
name|newInstance
argument_list|(
name|TS
argument_list|,
name|id
argument_list|)
decl_stmt|;
name|ApplicationAttemptId
name|appAttId
init|=
name|ApplicationAttemptId
operator|.
name|newInstance
argument_list|(
name|appId
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|when
argument_list|(
name|app
operator|.
name|getApplicationId
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|appId
argument_list|)
expr_stmt|;
name|when
argument_list|(
name|app
operator|.
name|getApplicationAttemptId
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|appAttId
argument_list|)
expr_stmt|;
name|int
name|cAlloc
init|=
literal|0
decl_stmt|;
name|Resource
name|unit
init|=
name|Resource
operator|.
name|newInstance
argument_list|(
name|gran
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|RMContainer
argument_list|>
name|cReserved
init|=
operator|new
name|ArrayList
argument_list|<
name|RMContainer
argument_list|>
argument_list|()
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|reserved
condition|;
name|i
operator|+=
name|gran
control|)
block|{
name|cReserved
operator|.
name|add
argument_list|(
name|mockContainer
argument_list|(
name|appAttId
argument_list|,
name|cAlloc
argument_list|,
name|unit
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
operator|++
name|cAlloc
expr_stmt|;
block|}
name|when
argument_list|(
name|app
operator|.
name|getReservedContainers
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|cReserved
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RMContainer
argument_list|>
name|cLive
init|=
operator|new
name|ArrayList
argument_list|<
name|RMContainer
argument_list|>
argument_list|()
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|used
condition|;
name|i
operator|+=
name|gran
control|)
block|{
name|cLive
operator|.
name|add
argument_list|(
name|mockContainer
argument_list|(
name|appAttId
argument_list|,
name|cAlloc
argument_list|,
name|unit
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
operator|++
name|cAlloc
expr_stmt|;
block|}
name|when
argument_list|(
name|app
operator|.
name|getLiveContainers
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|cLive
argument_list|)
expr_stmt|;
return|return
name|app
return|;
block|}
DECL|method|mockContainer (ApplicationAttemptId appAttId, int id, Resource r, int priority)
name|RMContainer
name|mockContainer
parameter_list|(
name|ApplicationAttemptId
name|appAttId
parameter_list|,
name|int
name|id
parameter_list|,
name|Resource
name|r
parameter_list|,
name|int
name|priority
parameter_list|)
block|{
name|ContainerId
name|cId
init|=
name|ContainerId
operator|.
name|newInstance
argument_list|(
name|appAttId
argument_list|,
name|id
argument_list|)
decl_stmt|;
name|Container
name|c
init|=
name|mock
argument_list|(
name|Container
operator|.
name|class
argument_list|)
decl_stmt|;
name|when
argument_list|(
name|c
operator|.
name|getResource
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|r
argument_list|)
expr_stmt|;
name|when
argument_list|(
name|c
operator|.
name|getPriority
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|Priority
operator|.
name|create
argument_list|(
name|priority
argument_list|)
argument_list|)
expr_stmt|;
name|RMContainer
name|mC
init|=
name|mock
argument_list|(
name|RMContainer
operator|.
name|class
argument_list|)
decl_stmt|;
name|when
argument_list|(
name|mC
operator|.
name|getContainerId
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|cId
argument_list|)
expr_stmt|;
name|when
argument_list|(
name|mC
operator|.
name|getContainer
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return
name|mC
return|;
block|}
DECL|method|leafAbsCapacities (int[] abs, int[] subqueues)
specifier|static
name|int
name|leafAbsCapacities
parameter_list|(
name|int
index|[]
name|abs
parameter_list|,
name|int
index|[]
name|subqueues
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|abs
operator|.
name|length
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
literal|0
operator|==
name|subqueues
index|[
name|i
index|]
condition|)
block|{
name|ret
operator|+=
name|abs
index|[
name|i
index|]
expr_stmt|;
block|}
block|}
return|return
name|ret
return|;
block|}
DECL|method|printString (CSQueue nq, String indent)
name|void
name|printString
parameter_list|(
name|CSQueue
name|nq
parameter_list|,
name|String
name|indent
parameter_list|)
block|{
if|if
condition|(
name|nq
operator|instanceof
name|ParentQueue
condition|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|indent
operator|+
name|nq
operator|.
name|getQueueName
argument_list|()
operator|+
literal|" cur:"
operator|+
name|nq
operator|.
name|getAbsoluteUsedCapacity
argument_list|()
operator|+
literal|" guar:"
operator|+
name|nq
operator|.
name|getAbsoluteCapacity
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|CSQueue
name|q
range|:
operator|(
operator|(
name|ParentQueue
operator|)
name|nq
operator|)
operator|.
name|getChildQueues
argument_list|()
control|)
block|{
name|printString
argument_list|(
name|q
argument_list|,
name|indent
operator|+
literal|"  "
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|indent
operator|+
name|nq
operator|.
name|getQueueName
argument_list|()
operator|+
literal|" pen:"
operator|+
operator|(
operator|(
name|LeafQueue
operator|)
name|nq
operator|)
operator|.
name|getTotalResourcePending
argument_list|()
operator|+
literal|" cur:"
operator|+
name|nq
operator|.
name|getAbsoluteUsedCapacity
argument_list|()
operator|+
literal|" guar:"
operator|+
name|nq
operator|.
name|getAbsoluteCapacity
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|FiCaSchedulerApp
name|a
range|:
operator|(
operator|(
name|LeafQueue
operator|)
name|nq
operator|)
operator|.
name|getApplications
argument_list|()
control|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|indent
operator|+
literal|"  "
operator|+
name|a
operator|.
name|getApplicationId
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_class

end_unit

