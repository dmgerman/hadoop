begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/**  * Licensed to the Apache Software Foundation (ASF) under one  * or more contributor license agreements.  See the NOTICE file  * distributed with this work for additional information  * regarding copyright ownership.  The ASF licenses this file  * to you under the Apache License, Version 2.0 (the  * "License"); you may not use this file except in compliance  * with the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
DECL|package|org.apache.hadoop.yarn.server.resourcemanager.recovery
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|recovery
package|;
end_package

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|annotations
operator|.
name|VisibleForTesting
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|base
operator|.
name|Preconditions
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|Log
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|LogFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|curator
operator|.
name|framework
operator|.
name|CuratorFramework
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|curator
operator|.
name|framework
operator|.
name|api
operator|.
name|transaction
operator|.
name|CuratorTransaction
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|curator
operator|.
name|framework
operator|.
name|api
operator|.
name|transaction
operator|.
name|CuratorTransactionFinal
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|classification
operator|.
name|InterfaceAudience
operator|.
name|Private
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|classification
operator|.
name|InterfaceStability
operator|.
name|Unstable
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|conf
operator|.
name|Configuration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|IOUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|token
operator|.
name|delegation
operator|.
name|DelegationKey
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|util
operator|.
name|ZKUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|ApplicationAttemptId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|ApplicationId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|ReservationId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|conf
operator|.
name|HAUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|conf
operator|.
name|YarnConfiguration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|exceptions
operator|.
name|YarnRuntimeException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|proto
operator|.
name|YarnServerCommonProtos
operator|.
name|VersionProto
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|proto
operator|.
name|YarnServerResourceManagerRecoveryProtos
operator|.
name|AMRMTokenSecretManagerStateProto
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|proto
operator|.
name|YarnServerResourceManagerRecoveryProtos
operator|.
name|ApplicationAttemptStateDataProto
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|proto
operator|.
name|YarnServerResourceManagerRecoveryProtos
operator|.
name|ApplicationStateDataProto
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|proto
operator|.
name|YarnServerResourceManagerRecoveryProtos
operator|.
name|EpochProto
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|proto
operator|.
name|YarnProtos
operator|.
name|ReservationAllocationStateProto
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|security
operator|.
name|client
operator|.
name|RMDelegationTokenIdentifier
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|records
operator|.
name|Version
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|records
operator|.
name|impl
operator|.
name|pb
operator|.
name|VersionPBImpl
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|RMZKUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|recovery
operator|.
name|records
operator|.
name|AMRMTokenSecretManagerState
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|recovery
operator|.
name|records
operator|.
name|ApplicationAttemptStateData
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|recovery
operator|.
name|records
operator|.
name|ApplicationStateData
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|recovery
operator|.
name|records
operator|.
name|Epoch
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|recovery
operator|.
name|records
operator|.
name|RMDelegationTokenIdentifierData
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|recovery
operator|.
name|records
operator|.
name|impl
operator|.
name|pb
operator|.
name|AMRMTokenSecretManagerStatePBImpl
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|recovery
operator|.
name|records
operator|.
name|impl
operator|.
name|pb
operator|.
name|ApplicationAttemptStateDataPBImpl
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|recovery
operator|.
name|records
operator|.
name|impl
operator|.
name|pb
operator|.
name|ApplicationStateDataPBImpl
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|recovery
operator|.
name|records
operator|.
name|impl
operator|.
name|pb
operator|.
name|EpochPBImpl
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|util
operator|.
name|ConverterUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|zookeeper
operator|.
name|CreateMode
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|zookeeper
operator|.
name|ZooDefs
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|zookeeper
operator|.
name|data
operator|.
name|ACL
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|zookeeper
operator|.
name|data
operator|.
name|Id
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|zookeeper
operator|.
name|data
operator|.
name|Stat
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|zookeeper
operator|.
name|server
operator|.
name|auth
operator|.
name|DigestAuthenticationProvider
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|ByteArrayInputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|ByteArrayOutputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|DataInputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|DataOutputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|security
operator|.
name|NoSuchAlgorithmException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|security
operator|.
name|SecureRandom
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_comment
comment|/**  * {@link RMStateStore} implementation backed by ZooKeeper.  *  * The znode structure is as follows:  * ROOT_DIR_PATH  * |--- VERSION_INFO  * |--- EPOCH_NODE  * |--- RM_ZK_FENCING_LOCK  * |--- RM_APP_ROOT  * |     |----- (#ApplicationId1)  * |     |        |----- (#ApplicationAttemptIds)  * |     |  * |     |----- (#ApplicationId2)  * |     |       |----- (#ApplicationAttemptIds)  * |     ....  * |  * |--- RM_DT_SECRET_MANAGER_ROOT  *        |----- RM_DT_SEQUENTIAL_NUMBER_ZNODE_NAME  *        |----- RM_DELEGATION_TOKENS_ROOT_ZNODE_NAME  *        |       |----- Token_1  *        |       |----- Token_2  *        |       ....  *        |  *        |----- RM_DT_MASTER_KEYS_ROOT_ZNODE_NAME  *        |      |----- Key_1  *        |      |----- Key_2  *                ....  * |--- AMRMTOKEN_SECRET_MANAGER_ROOT  *        |----- currentMasterKey  *        |----- nextMasterKey  *  * |-- RESERVATION_SYSTEM_ROOT  *        |------PLAN_1  *        |      |------ RESERVATION_1  *        |      |------ RESERVATION_2  *        |      ....  *        |------PLAN_2  *        ....  * Note: Changes from 1.1 to 1.2 - AMRMTokenSecretManager state has been saved  * separately. The currentMasterkey and nextMasterkey have been stored.  * Also, AMRMToken has been removed from ApplicationAttemptState.  *  * Changes from 1.2 to 1.3, Addition of ReservationSystem state.  */
end_comment

begin_class
annotation|@
name|Private
annotation|@
name|Unstable
DECL|class|ZKRMStateStore
specifier|public
class|class
name|ZKRMStateStore
extends|extends
name|RMStateStore
block|{
DECL|field|LOG
specifier|public
specifier|static
specifier|final
name|Log
name|LOG
init|=
name|LogFactory
operator|.
name|getLog
argument_list|(
name|ZKRMStateStore
operator|.
name|class
argument_list|)
decl_stmt|;
DECL|field|random
specifier|private
specifier|final
name|SecureRandom
name|random
init|=
operator|new
name|SecureRandom
argument_list|()
decl_stmt|;
DECL|field|ROOT_ZNODE_NAME
specifier|protected
specifier|static
specifier|final
name|String
name|ROOT_ZNODE_NAME
init|=
literal|"ZKRMStateRoot"
decl_stmt|;
DECL|field|CURRENT_VERSION_INFO
specifier|protected
specifier|static
specifier|final
name|Version
name|CURRENT_VERSION_INFO
init|=
name|Version
operator|.
name|newInstance
argument_list|(
literal|1
argument_list|,
literal|3
argument_list|)
decl_stmt|;
DECL|field|RM_DELEGATION_TOKENS_ROOT_ZNODE_NAME
specifier|private
specifier|static
specifier|final
name|String
name|RM_DELEGATION_TOKENS_ROOT_ZNODE_NAME
init|=
literal|"RMDelegationTokensRoot"
decl_stmt|;
DECL|field|RM_DT_SEQUENTIAL_NUMBER_ZNODE_NAME
specifier|private
specifier|static
specifier|final
name|String
name|RM_DT_SEQUENTIAL_NUMBER_ZNODE_NAME
init|=
literal|"RMDTSequentialNumber"
decl_stmt|;
DECL|field|RM_DT_MASTER_KEYS_ROOT_ZNODE_NAME
specifier|private
specifier|static
specifier|final
name|String
name|RM_DT_MASTER_KEYS_ROOT_ZNODE_NAME
init|=
literal|"RMDTMasterKeysRoot"
decl_stmt|;
comment|/** Znode paths */
DECL|field|zkRootNodePath
specifier|private
name|String
name|zkRootNodePath
decl_stmt|;
DECL|field|rmAppRoot
specifier|private
name|String
name|rmAppRoot
decl_stmt|;
DECL|field|rmDTSecretManagerRoot
specifier|private
name|String
name|rmDTSecretManagerRoot
decl_stmt|;
DECL|field|dtMasterKeysRootPath
specifier|private
name|String
name|dtMasterKeysRootPath
decl_stmt|;
DECL|field|delegationTokensRootPath
specifier|private
name|String
name|delegationTokensRootPath
decl_stmt|;
DECL|field|dtSequenceNumberPath
specifier|private
name|String
name|dtSequenceNumberPath
decl_stmt|;
DECL|field|amrmTokenSecretManagerRoot
specifier|private
name|String
name|amrmTokenSecretManagerRoot
decl_stmt|;
DECL|field|reservationRoot
specifier|private
name|String
name|reservationRoot
decl_stmt|;
annotation|@
name|VisibleForTesting
DECL|field|znodeWorkingPath
specifier|protected
name|String
name|znodeWorkingPath
decl_stmt|;
comment|/** Fencing related variables */
DECL|field|FENCING_LOCK
specifier|private
specifier|static
specifier|final
name|String
name|FENCING_LOCK
init|=
literal|"RM_ZK_FENCING_LOCK"
decl_stmt|;
DECL|field|fencingNodePath
specifier|private
name|String
name|fencingNodePath
decl_stmt|;
DECL|field|verifyActiveStatusThread
specifier|private
name|Thread
name|verifyActiveStatusThread
decl_stmt|;
DECL|field|zkSessionTimeout
specifier|private
name|int
name|zkSessionTimeout
decl_stmt|;
comment|/** ACL and auth info */
DECL|field|zkAcl
specifier|private
name|List
argument_list|<
name|ACL
argument_list|>
name|zkAcl
decl_stmt|;
annotation|@
name|VisibleForTesting
DECL|field|zkRootNodeAcl
name|List
argument_list|<
name|ACL
argument_list|>
name|zkRootNodeAcl
decl_stmt|;
DECL|field|zkRootNodeUsername
specifier|private
name|String
name|zkRootNodeUsername
decl_stmt|;
DECL|field|CREATE_DELETE_PERMS
specifier|public
specifier|static
specifier|final
name|int
name|CREATE_DELETE_PERMS
init|=
name|ZooDefs
operator|.
name|Perms
operator|.
name|CREATE
operator||
name|ZooDefs
operator|.
name|Perms
operator|.
name|DELETE
decl_stmt|;
DECL|field|zkRootNodeAuthScheme
specifier|private
specifier|final
name|String
name|zkRootNodeAuthScheme
init|=
operator|new
name|DigestAuthenticationProvider
argument_list|()
operator|.
name|getScheme
argument_list|()
decl_stmt|;
annotation|@
name|VisibleForTesting
DECL|field|curatorFramework
specifier|protected
name|CuratorFramework
name|curatorFramework
decl_stmt|;
comment|/**    * Given the {@link Configuration} and {@link ACL}s used (zkAcl) for    * ZooKeeper access, construct the {@link ACL}s for the store's root node.    * In the constructed {@link ACL}, all the users allowed by zkAcl are given    * rwa access, while the current RM has exclude create-delete access.    *    * To be called only when HA is enabled and the configuration doesn't set ACL    * for the root node.    */
annotation|@
name|VisibleForTesting
annotation|@
name|Private
annotation|@
name|Unstable
DECL|method|constructZkRootNodeACL ( Configuration conf, List<ACL> sourceACLs)
specifier|protected
name|List
argument_list|<
name|ACL
argument_list|>
name|constructZkRootNodeACL
parameter_list|(
name|Configuration
name|conf
parameter_list|,
name|List
argument_list|<
name|ACL
argument_list|>
name|sourceACLs
parameter_list|)
throws|throws
name|NoSuchAlgorithmException
block|{
name|List
argument_list|<
name|ACL
argument_list|>
name|zkRootNodeAcl
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
for|for
control|(
name|ACL
name|acl
range|:
name|sourceACLs
control|)
block|{
name|zkRootNodeAcl
operator|.
name|add
argument_list|(
operator|new
name|ACL
argument_list|(
name|ZKUtil
operator|.
name|removeSpecificPerms
argument_list|(
name|acl
operator|.
name|getPerms
argument_list|()
argument_list|,
name|CREATE_DELETE_PERMS
argument_list|)
argument_list|,
name|acl
operator|.
name|getId
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|zkRootNodeUsername
operator|=
name|HAUtil
operator|.
name|getConfValueForRMInstance
argument_list|(
name|YarnConfiguration
operator|.
name|RM_ADDRESS
argument_list|,
name|YarnConfiguration
operator|.
name|DEFAULT_RM_ADDRESS
argument_list|,
name|conf
argument_list|)
expr_stmt|;
name|Id
name|rmId
init|=
operator|new
name|Id
argument_list|(
name|zkRootNodeAuthScheme
argument_list|,
name|DigestAuthenticationProvider
operator|.
name|generateDigest
argument_list|(
name|zkRootNodeUsername
operator|+
literal|":"
operator|+
name|resourceManager
operator|.
name|getZkRootNodePassword
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|zkRootNodeAcl
operator|.
name|add
argument_list|(
operator|new
name|ACL
argument_list|(
name|CREATE_DELETE_PERMS
argument_list|,
name|rmId
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|zkRootNodeAcl
return|;
block|}
annotation|@
name|Override
DECL|method|initInternal (Configuration conf)
specifier|public
specifier|synchronized
name|void
name|initInternal
parameter_list|(
name|Configuration
name|conf
parameter_list|)
throws|throws
name|Exception
block|{
comment|/* Initialize fencing related paths, acls, and ops */
name|znodeWorkingPath
operator|=
name|conf
operator|.
name|get
argument_list|(
name|YarnConfiguration
operator|.
name|ZK_RM_STATE_STORE_PARENT_PATH
argument_list|,
name|YarnConfiguration
operator|.
name|DEFAULT_ZK_RM_STATE_STORE_PARENT_PATH
argument_list|)
expr_stmt|;
name|zkRootNodePath
operator|=
name|getNodePath
argument_list|(
name|znodeWorkingPath
argument_list|,
name|ROOT_ZNODE_NAME
argument_list|)
expr_stmt|;
name|fencingNodePath
operator|=
name|getNodePath
argument_list|(
name|zkRootNodePath
argument_list|,
name|FENCING_LOCK
argument_list|)
expr_stmt|;
name|rmAppRoot
operator|=
name|getNodePath
argument_list|(
name|zkRootNodePath
argument_list|,
name|RM_APP_ROOT
argument_list|)
expr_stmt|;
name|zkSessionTimeout
operator|=
name|conf
operator|.
name|getInt
argument_list|(
name|YarnConfiguration
operator|.
name|RM_ZK_TIMEOUT_MS
argument_list|,
name|YarnConfiguration
operator|.
name|DEFAULT_RM_ZK_TIMEOUT_MS
argument_list|)
expr_stmt|;
name|zkAcl
operator|=
name|RMZKUtils
operator|.
name|getZKAcls
argument_list|(
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|HAUtil
operator|.
name|isHAEnabled
argument_list|(
name|conf
argument_list|)
condition|)
block|{
name|String
name|zkRootNodeAclConf
init|=
name|HAUtil
operator|.
name|getConfValueForRMInstance
argument_list|(
name|YarnConfiguration
operator|.
name|ZK_RM_STATE_STORE_ROOT_NODE_ACL
argument_list|,
name|conf
argument_list|)
decl_stmt|;
if|if
condition|(
name|zkRootNodeAclConf
operator|!=
literal|null
condition|)
block|{
name|zkRootNodeAclConf
operator|=
name|ZKUtil
operator|.
name|resolveConfIndirection
argument_list|(
name|zkRootNodeAclConf
argument_list|)
expr_stmt|;
try|try
block|{
name|zkRootNodeAcl
operator|=
name|ZKUtil
operator|.
name|parseACLs
argument_list|(
name|zkRootNodeAclConf
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|ZKUtil
operator|.
name|BadAclFormatException
name|bafe
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Invalid format for "
operator|+
name|YarnConfiguration
operator|.
name|ZK_RM_STATE_STORE_ROOT_NODE_ACL
argument_list|)
expr_stmt|;
throw|throw
name|bafe
throw|;
block|}
block|}
else|else
block|{
name|zkRootNodeAcl
operator|=
name|constructZkRootNodeACL
argument_list|(
name|conf
argument_list|,
name|zkAcl
argument_list|)
expr_stmt|;
block|}
block|}
name|rmDTSecretManagerRoot
operator|=
name|getNodePath
argument_list|(
name|zkRootNodePath
argument_list|,
name|RM_DT_SECRET_MANAGER_ROOT
argument_list|)
expr_stmt|;
name|dtMasterKeysRootPath
operator|=
name|getNodePath
argument_list|(
name|rmDTSecretManagerRoot
argument_list|,
name|RM_DT_MASTER_KEYS_ROOT_ZNODE_NAME
argument_list|)
expr_stmt|;
name|delegationTokensRootPath
operator|=
name|getNodePath
argument_list|(
name|rmDTSecretManagerRoot
argument_list|,
name|RM_DELEGATION_TOKENS_ROOT_ZNODE_NAME
argument_list|)
expr_stmt|;
name|dtSequenceNumberPath
operator|=
name|getNodePath
argument_list|(
name|rmDTSecretManagerRoot
argument_list|,
name|RM_DT_SEQUENTIAL_NUMBER_ZNODE_NAME
argument_list|)
expr_stmt|;
name|amrmTokenSecretManagerRoot
operator|=
name|getNodePath
argument_list|(
name|zkRootNodePath
argument_list|,
name|AMRMTOKEN_SECRET_MANAGER_ROOT
argument_list|)
expr_stmt|;
name|reservationRoot
operator|=
name|getNodePath
argument_list|(
name|zkRootNodePath
argument_list|,
name|RESERVATION_SYSTEM_ROOT
argument_list|)
expr_stmt|;
name|curatorFramework
operator|=
name|resourceManager
operator|.
name|getCurator
argument_list|()
expr_stmt|;
if|if
condition|(
name|curatorFramework
operator|==
literal|null
condition|)
block|{
name|curatorFramework
operator|=
name|resourceManager
operator|.
name|createAndStartCurator
argument_list|(
name|conf
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|startInternal ()
specifier|public
specifier|synchronized
name|void
name|startInternal
parameter_list|()
throws|throws
name|Exception
block|{
comment|// ensure root dirs exist
name|createRootDirRecursively
argument_list|(
name|znodeWorkingPath
argument_list|)
expr_stmt|;
name|create
argument_list|(
name|zkRootNodePath
argument_list|)
expr_stmt|;
name|setRootNodeAcls
argument_list|()
expr_stmt|;
name|delete
argument_list|(
name|fencingNodePath
argument_list|)
expr_stmt|;
if|if
condition|(
name|HAUtil
operator|.
name|isHAEnabled
argument_list|(
name|getConfig
argument_list|()
argument_list|)
operator|&&
operator|!
name|HAUtil
operator|.
name|isAutomaticFailoverEnabled
argument_list|(
name|getConfig
argument_list|()
argument_list|)
condition|)
block|{
name|verifyActiveStatusThread
operator|=
operator|new
name|VerifyActiveStatusThread
argument_list|()
expr_stmt|;
name|verifyActiveStatusThread
operator|.
name|start
argument_list|()
expr_stmt|;
block|}
name|create
argument_list|(
name|rmAppRoot
argument_list|)
expr_stmt|;
name|create
argument_list|(
name|rmDTSecretManagerRoot
argument_list|)
expr_stmt|;
name|create
argument_list|(
name|dtMasterKeysRootPath
argument_list|)
expr_stmt|;
name|create
argument_list|(
name|delegationTokensRootPath
argument_list|)
expr_stmt|;
name|create
argument_list|(
name|dtSequenceNumberPath
argument_list|)
expr_stmt|;
name|create
argument_list|(
name|amrmTokenSecretManagerRoot
argument_list|)
expr_stmt|;
name|create
argument_list|(
name|reservationRoot
argument_list|)
expr_stmt|;
block|}
DECL|method|logRootNodeAcls (String prefix)
specifier|private
name|void
name|logRootNodeAcls
parameter_list|(
name|String
name|prefix
parameter_list|)
throws|throws
name|Exception
block|{
name|Stat
name|getStat
init|=
operator|new
name|Stat
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|ACL
argument_list|>
name|getAcls
init|=
name|getACL
argument_list|(
name|zkRootNodePath
argument_list|)
decl_stmt|;
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|prefix
argument_list|)
expr_stmt|;
for|for
control|(
name|ACL
name|acl
range|:
name|getAcls
control|)
block|{
name|builder
operator|.
name|append
argument_list|(
name|acl
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|builder
operator|.
name|append
argument_list|(
name|getStat
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
name|builder
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|setRootNodeAcls ()
specifier|private
name|void
name|setRootNodeAcls
parameter_list|()
throws|throws
name|Exception
block|{
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|logRootNodeAcls
argument_list|(
literal|"Before setting ACLs'\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|HAUtil
operator|.
name|isHAEnabled
argument_list|(
name|getConfig
argument_list|()
argument_list|)
condition|)
block|{
name|curatorFramework
operator|.
name|setACL
argument_list|()
operator|.
name|withACL
argument_list|(
name|zkRootNodeAcl
argument_list|)
operator|.
name|forPath
argument_list|(
name|zkRootNodePath
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|curatorFramework
operator|.
name|setACL
argument_list|()
operator|.
name|withACL
argument_list|(
name|zkAcl
argument_list|)
operator|.
name|forPath
argument_list|(
name|zkRootNodePath
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|logRootNodeAcls
argument_list|(
literal|"After setting ACLs'\n"
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|closeInternal ()
specifier|protected
specifier|synchronized
name|void
name|closeInternal
parameter_list|()
throws|throws
name|Exception
block|{
if|if
condition|(
name|verifyActiveStatusThread
operator|!=
literal|null
condition|)
block|{
name|verifyActiveStatusThread
operator|.
name|interrupt
argument_list|()
expr_stmt|;
name|verifyActiveStatusThread
operator|.
name|join
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|HAUtil
operator|.
name|isHAEnabled
argument_list|(
name|getConfig
argument_list|()
argument_list|)
condition|)
block|{
name|IOUtils
operator|.
name|closeStream
argument_list|(
name|curatorFramework
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|getCurrentVersion ()
specifier|protected
name|Version
name|getCurrentVersion
parameter_list|()
block|{
return|return
name|CURRENT_VERSION_INFO
return|;
block|}
annotation|@
name|Override
DECL|method|storeVersion ()
specifier|protected
specifier|synchronized
name|void
name|storeVersion
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|versionNodePath
init|=
name|getNodePath
argument_list|(
name|zkRootNodePath
argument_list|,
name|VERSION_NODE
argument_list|)
decl_stmt|;
name|byte
index|[]
name|data
init|=
operator|(
operator|(
name|VersionPBImpl
operator|)
name|CURRENT_VERSION_INFO
operator|)
operator|.
name|getProto
argument_list|()
operator|.
name|toByteArray
argument_list|()
decl_stmt|;
if|if
condition|(
name|exists
argument_list|(
name|versionNodePath
argument_list|)
condition|)
block|{
name|safeSetData
argument_list|(
name|versionNodePath
argument_list|,
name|data
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|safeCreate
argument_list|(
name|versionNodePath
argument_list|,
name|data
argument_list|,
name|zkAcl
argument_list|,
name|CreateMode
operator|.
name|PERSISTENT
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|loadVersion ()
specifier|protected
specifier|synchronized
name|Version
name|loadVersion
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|versionNodePath
init|=
name|getNodePath
argument_list|(
name|zkRootNodePath
argument_list|,
name|VERSION_NODE
argument_list|)
decl_stmt|;
if|if
condition|(
name|exists
argument_list|(
name|versionNodePath
argument_list|)
condition|)
block|{
name|byte
index|[]
name|data
init|=
name|getData
argument_list|(
name|versionNodePath
argument_list|)
decl_stmt|;
return|return
operator|new
name|VersionPBImpl
argument_list|(
name|VersionProto
operator|.
name|parseFrom
argument_list|(
name|data
argument_list|)
argument_list|)
return|;
block|}
return|return
literal|null
return|;
block|}
annotation|@
name|Override
DECL|method|getAndIncrementEpoch ()
specifier|public
specifier|synchronized
name|long
name|getAndIncrementEpoch
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|epochNodePath
init|=
name|getNodePath
argument_list|(
name|zkRootNodePath
argument_list|,
name|EPOCH_NODE
argument_list|)
decl_stmt|;
name|long
name|currentEpoch
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|exists
argument_list|(
name|epochNodePath
argument_list|)
condition|)
block|{
comment|// load current epoch
name|byte
index|[]
name|data
init|=
name|getData
argument_list|(
name|epochNodePath
argument_list|)
decl_stmt|;
name|Epoch
name|epoch
init|=
operator|new
name|EpochPBImpl
argument_list|(
name|EpochProto
operator|.
name|parseFrom
argument_list|(
name|data
argument_list|)
argument_list|)
decl_stmt|;
name|currentEpoch
operator|=
name|epoch
operator|.
name|getEpoch
argument_list|()
expr_stmt|;
comment|// increment epoch and store it
name|byte
index|[]
name|storeData
init|=
name|Epoch
operator|.
name|newInstance
argument_list|(
name|currentEpoch
operator|+
literal|1
argument_list|)
operator|.
name|getProto
argument_list|()
operator|.
name|toByteArray
argument_list|()
decl_stmt|;
name|safeSetData
argument_list|(
name|epochNodePath
argument_list|,
name|storeData
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// initialize epoch node with 1 for the next time.
name|byte
index|[]
name|storeData
init|=
name|Epoch
operator|.
name|newInstance
argument_list|(
name|currentEpoch
operator|+
literal|1
argument_list|)
operator|.
name|getProto
argument_list|()
operator|.
name|toByteArray
argument_list|()
decl_stmt|;
name|safeCreate
argument_list|(
name|epochNodePath
argument_list|,
name|storeData
argument_list|,
name|zkAcl
argument_list|,
name|CreateMode
operator|.
name|PERSISTENT
argument_list|)
expr_stmt|;
block|}
return|return
name|currentEpoch
return|;
block|}
annotation|@
name|Override
DECL|method|loadState ()
specifier|public
specifier|synchronized
name|RMState
name|loadState
parameter_list|()
throws|throws
name|Exception
block|{
name|RMState
name|rmState
init|=
operator|new
name|RMState
argument_list|()
decl_stmt|;
comment|// recover DelegationTokenSecretManager
name|loadRMDTSecretManagerState
argument_list|(
name|rmState
argument_list|)
expr_stmt|;
comment|// recover RM applications
name|loadRMAppState
argument_list|(
name|rmState
argument_list|)
expr_stmt|;
comment|// recover AMRMTokenSecretManager
name|loadAMRMTokenSecretManagerState
argument_list|(
name|rmState
argument_list|)
expr_stmt|;
comment|// recover reservation state
name|loadReservationSystemState
argument_list|(
name|rmState
argument_list|)
expr_stmt|;
return|return
name|rmState
return|;
block|}
DECL|method|loadReservationSystemState (RMState rmState)
specifier|private
name|void
name|loadReservationSystemState
parameter_list|(
name|RMState
name|rmState
parameter_list|)
throws|throws
name|Exception
block|{
name|List
argument_list|<
name|String
argument_list|>
name|planNodes
init|=
name|getChildren
argument_list|(
name|reservationRoot
argument_list|)
decl_stmt|;
for|for
control|(
name|String
name|planName
range|:
name|planNodes
control|)
block|{
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Loading plan from znode: "
operator|+
name|planName
argument_list|)
expr_stmt|;
block|}
name|String
name|planNodePath
init|=
name|getNodePath
argument_list|(
name|reservationRoot
argument_list|,
name|planName
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|reservationNodes
init|=
name|getChildren
argument_list|(
name|planNodePath
argument_list|)
decl_stmt|;
for|for
control|(
name|String
name|reservationNodeName
range|:
name|reservationNodes
control|)
block|{
name|String
name|reservationNodePath
init|=
name|getNodePath
argument_list|(
name|planNodePath
argument_list|,
name|reservationNodeName
argument_list|)
decl_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Loading reservation from znode: "
operator|+
name|reservationNodePath
argument_list|)
expr_stmt|;
block|}
name|byte
index|[]
name|reservationData
init|=
name|getData
argument_list|(
name|reservationNodePath
argument_list|)
decl_stmt|;
name|ReservationAllocationStateProto
name|allocationState
init|=
name|ReservationAllocationStateProto
operator|.
name|parseFrom
argument_list|(
name|reservationData
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|rmState
operator|.
name|getReservationState
argument_list|()
operator|.
name|containsKey
argument_list|(
name|planName
argument_list|)
condition|)
block|{
name|rmState
operator|.
name|getReservationState
argument_list|()
operator|.
name|put
argument_list|(
name|planName
argument_list|,
operator|new
name|HashMap
argument_list|<
name|ReservationId
argument_list|,
name|ReservationAllocationStateProto
argument_list|>
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|ReservationId
name|reservationId
init|=
name|ReservationId
operator|.
name|parseReservationId
argument_list|(
name|reservationNodeName
argument_list|)
decl_stmt|;
name|rmState
operator|.
name|getReservationState
argument_list|()
operator|.
name|get
argument_list|(
name|planName
argument_list|)
operator|.
name|put
argument_list|(
name|reservationId
argument_list|,
name|allocationState
argument_list|)
expr_stmt|;
block|}
block|}
block|}
DECL|method|loadAMRMTokenSecretManagerState (RMState rmState)
specifier|private
name|void
name|loadAMRMTokenSecretManagerState
parameter_list|(
name|RMState
name|rmState
parameter_list|)
throws|throws
name|Exception
block|{
name|byte
index|[]
name|data
init|=
name|getData
argument_list|(
name|amrmTokenSecretManagerRoot
argument_list|)
decl_stmt|;
if|if
condition|(
name|data
operator|==
literal|null
condition|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"There is no data saved"
argument_list|)
expr_stmt|;
return|return;
block|}
name|AMRMTokenSecretManagerStatePBImpl
name|stateData
init|=
operator|new
name|AMRMTokenSecretManagerStatePBImpl
argument_list|(
name|AMRMTokenSecretManagerStateProto
operator|.
name|parseFrom
argument_list|(
name|data
argument_list|)
argument_list|)
decl_stmt|;
name|rmState
operator|.
name|amrmTokenSecretManagerState
operator|=
name|AMRMTokenSecretManagerState
operator|.
name|newInstance
argument_list|(
name|stateData
operator|.
name|getCurrentMasterKey
argument_list|()
argument_list|,
name|stateData
operator|.
name|getNextMasterKey
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|loadRMDTSecretManagerState (RMState rmState)
specifier|private
specifier|synchronized
name|void
name|loadRMDTSecretManagerState
parameter_list|(
name|RMState
name|rmState
parameter_list|)
throws|throws
name|Exception
block|{
name|loadRMDelegationKeyState
argument_list|(
name|rmState
argument_list|)
expr_stmt|;
name|loadRMSequentialNumberState
argument_list|(
name|rmState
argument_list|)
expr_stmt|;
name|loadRMDelegationTokenState
argument_list|(
name|rmState
argument_list|)
expr_stmt|;
block|}
DECL|method|loadRMDelegationKeyState (RMState rmState)
specifier|private
name|void
name|loadRMDelegationKeyState
parameter_list|(
name|RMState
name|rmState
parameter_list|)
throws|throws
name|Exception
block|{
name|List
argument_list|<
name|String
argument_list|>
name|childNodes
init|=
name|getChildren
argument_list|(
name|dtMasterKeysRootPath
argument_list|)
decl_stmt|;
for|for
control|(
name|String
name|childNodeName
range|:
name|childNodes
control|)
block|{
name|String
name|childNodePath
init|=
name|getNodePath
argument_list|(
name|dtMasterKeysRootPath
argument_list|,
name|childNodeName
argument_list|)
decl_stmt|;
name|byte
index|[]
name|childData
init|=
name|getData
argument_list|(
name|childNodePath
argument_list|)
decl_stmt|;
if|if
condition|(
name|childData
operator|==
literal|null
condition|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Content of "
operator|+
name|childNodePath
operator|+
literal|" is broken."
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|ByteArrayInputStream
name|is
init|=
operator|new
name|ByteArrayInputStream
argument_list|(
name|childData
argument_list|)
decl_stmt|;
name|DataInputStream
name|fsIn
init|=
operator|new
name|DataInputStream
argument_list|(
name|is
argument_list|)
decl_stmt|;
try|try
block|{
if|if
condition|(
name|childNodeName
operator|.
name|startsWith
argument_list|(
name|DELEGATION_KEY_PREFIX
argument_list|)
condition|)
block|{
name|DelegationKey
name|key
init|=
operator|new
name|DelegationKey
argument_list|()
decl_stmt|;
name|key
operator|.
name|readFields
argument_list|(
name|fsIn
argument_list|)
expr_stmt|;
name|rmState
operator|.
name|rmSecretManagerState
operator|.
name|masterKeyState
operator|.
name|add
argument_list|(
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Loaded delegation key: keyId="
operator|+
name|key
operator|.
name|getKeyId
argument_list|()
operator|+
literal|", expirationDate="
operator|+
name|key
operator|.
name|getExpiryDate
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
block|}
finally|finally
block|{
name|is
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
block|}
block|}
DECL|method|loadRMSequentialNumberState (RMState rmState)
specifier|private
name|void
name|loadRMSequentialNumberState
parameter_list|(
name|RMState
name|rmState
parameter_list|)
throws|throws
name|Exception
block|{
name|byte
index|[]
name|seqData
init|=
name|getData
argument_list|(
name|dtSequenceNumberPath
argument_list|)
decl_stmt|;
if|if
condition|(
name|seqData
operator|!=
literal|null
condition|)
block|{
name|ByteArrayInputStream
name|seqIs
init|=
operator|new
name|ByteArrayInputStream
argument_list|(
name|seqData
argument_list|)
decl_stmt|;
name|DataInputStream
name|seqIn
init|=
operator|new
name|DataInputStream
argument_list|(
name|seqIs
argument_list|)
decl_stmt|;
try|try
block|{
name|rmState
operator|.
name|rmSecretManagerState
operator|.
name|dtSequenceNumber
operator|=
name|seqIn
operator|.
name|readInt
argument_list|()
expr_stmt|;
block|}
finally|finally
block|{
name|seqIn
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
block|}
block|}
DECL|method|loadRMDelegationTokenState (RMState rmState)
specifier|private
name|void
name|loadRMDelegationTokenState
parameter_list|(
name|RMState
name|rmState
parameter_list|)
throws|throws
name|Exception
block|{
name|List
argument_list|<
name|String
argument_list|>
name|childNodes
init|=
name|getChildren
argument_list|(
name|delegationTokensRootPath
argument_list|)
decl_stmt|;
for|for
control|(
name|String
name|childNodeName
range|:
name|childNodes
control|)
block|{
name|String
name|childNodePath
init|=
name|getNodePath
argument_list|(
name|delegationTokensRootPath
argument_list|,
name|childNodeName
argument_list|)
decl_stmt|;
name|byte
index|[]
name|childData
init|=
name|getData
argument_list|(
name|childNodePath
argument_list|)
decl_stmt|;
if|if
condition|(
name|childData
operator|==
literal|null
condition|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Content of "
operator|+
name|childNodePath
operator|+
literal|" is broken."
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|ByteArrayInputStream
name|is
init|=
operator|new
name|ByteArrayInputStream
argument_list|(
name|childData
argument_list|)
decl_stmt|;
name|DataInputStream
name|fsIn
init|=
operator|new
name|DataInputStream
argument_list|(
name|is
argument_list|)
decl_stmt|;
try|try
block|{
if|if
condition|(
name|childNodeName
operator|.
name|startsWith
argument_list|(
name|DELEGATION_TOKEN_PREFIX
argument_list|)
condition|)
block|{
name|RMDelegationTokenIdentifierData
name|identifierData
init|=
operator|new
name|RMDelegationTokenIdentifierData
argument_list|()
decl_stmt|;
name|identifierData
operator|.
name|readFields
argument_list|(
name|fsIn
argument_list|)
expr_stmt|;
name|RMDelegationTokenIdentifier
name|identifier
init|=
name|identifierData
operator|.
name|getTokenIdentifier
argument_list|()
decl_stmt|;
name|long
name|renewDate
init|=
name|identifierData
operator|.
name|getRenewDate
argument_list|()
decl_stmt|;
name|rmState
operator|.
name|rmSecretManagerState
operator|.
name|delegationTokenState
operator|.
name|put
argument_list|(
name|identifier
argument_list|,
name|renewDate
argument_list|)
expr_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Loaded RMDelegationTokenIdentifier: "
operator|+
name|identifier
operator|+
literal|" renewDate="
operator|+
name|renewDate
argument_list|)
expr_stmt|;
block|}
block|}
block|}
finally|finally
block|{
name|is
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
block|}
block|}
DECL|method|loadRMAppState (RMState rmState)
specifier|private
specifier|synchronized
name|void
name|loadRMAppState
parameter_list|(
name|RMState
name|rmState
parameter_list|)
throws|throws
name|Exception
block|{
name|List
argument_list|<
name|String
argument_list|>
name|childNodes
init|=
name|getChildren
argument_list|(
name|rmAppRoot
argument_list|)
decl_stmt|;
for|for
control|(
name|String
name|childNodeName
range|:
name|childNodes
control|)
block|{
name|String
name|childNodePath
init|=
name|getNodePath
argument_list|(
name|rmAppRoot
argument_list|,
name|childNodeName
argument_list|)
decl_stmt|;
name|byte
index|[]
name|childData
init|=
name|getData
argument_list|(
name|childNodePath
argument_list|)
decl_stmt|;
if|if
condition|(
name|childNodeName
operator|.
name|startsWith
argument_list|(
name|ApplicationId
operator|.
name|appIdStrPrefix
argument_list|)
condition|)
block|{
comment|// application
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Loading application from znode: "
operator|+
name|childNodeName
argument_list|)
expr_stmt|;
block|}
name|ApplicationId
name|appId
init|=
name|ApplicationId
operator|.
name|fromString
argument_list|(
name|childNodeName
argument_list|)
decl_stmt|;
name|ApplicationStateDataPBImpl
name|appState
init|=
operator|new
name|ApplicationStateDataPBImpl
argument_list|(
name|ApplicationStateDataProto
operator|.
name|parseFrom
argument_list|(
name|childData
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|appId
operator|.
name|equals
argument_list|(
name|appState
operator|.
name|getApplicationSubmissionContext
argument_list|()
operator|.
name|getApplicationId
argument_list|()
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|YarnRuntimeException
argument_list|(
literal|"The child node name is different "
operator|+
literal|"from the application id"
argument_list|)
throw|;
block|}
name|rmState
operator|.
name|appState
operator|.
name|put
argument_list|(
name|appId
argument_list|,
name|appState
argument_list|)
expr_stmt|;
name|loadApplicationAttemptState
argument_list|(
name|appState
argument_list|,
name|appId
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Unknown child node with name: "
operator|+
name|childNodeName
argument_list|)
expr_stmt|;
block|}
block|}
block|}
DECL|method|loadApplicationAttemptState (ApplicationStateData appState, ApplicationId appId)
specifier|private
name|void
name|loadApplicationAttemptState
parameter_list|(
name|ApplicationStateData
name|appState
parameter_list|,
name|ApplicationId
name|appId
parameter_list|)
throws|throws
name|Exception
block|{
name|String
name|appPath
init|=
name|getNodePath
argument_list|(
name|rmAppRoot
argument_list|,
name|appId
operator|.
name|toString
argument_list|()
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|attempts
init|=
name|getChildren
argument_list|(
name|appPath
argument_list|)
decl_stmt|;
for|for
control|(
name|String
name|attemptIDStr
range|:
name|attempts
control|)
block|{
if|if
condition|(
name|attemptIDStr
operator|.
name|startsWith
argument_list|(
name|ApplicationAttemptId
operator|.
name|appAttemptIdStrPrefix
argument_list|)
condition|)
block|{
name|String
name|attemptPath
init|=
name|getNodePath
argument_list|(
name|appPath
argument_list|,
name|attemptIDStr
argument_list|)
decl_stmt|;
name|byte
index|[]
name|attemptData
init|=
name|getData
argument_list|(
name|attemptPath
argument_list|)
decl_stmt|;
name|ApplicationAttemptStateDataPBImpl
name|attemptState
init|=
operator|new
name|ApplicationAttemptStateDataPBImpl
argument_list|(
name|ApplicationAttemptStateDataProto
operator|.
name|parseFrom
argument_list|(
name|attemptData
argument_list|)
argument_list|)
decl_stmt|;
name|appState
operator|.
name|attempts
operator|.
name|put
argument_list|(
name|attemptState
operator|.
name|getAttemptId
argument_list|()
argument_list|,
name|attemptState
argument_list|)
expr_stmt|;
block|}
block|}
name|LOG
operator|.
name|debug
argument_list|(
literal|"Done loading applications from ZK state store"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|storeApplicationStateInternal (ApplicationId appId, ApplicationStateData appStateDataPB)
specifier|public
specifier|synchronized
name|void
name|storeApplicationStateInternal
parameter_list|(
name|ApplicationId
name|appId
parameter_list|,
name|ApplicationStateData
name|appStateDataPB
parameter_list|)
throws|throws
name|Exception
block|{
name|String
name|nodeCreatePath
init|=
name|getNodePath
argument_list|(
name|rmAppRoot
argument_list|,
name|appId
operator|.
name|toString
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Storing info for app: "
operator|+
name|appId
operator|+
literal|" at: "
operator|+
name|nodeCreatePath
argument_list|)
expr_stmt|;
block|}
name|byte
index|[]
name|appStateData
init|=
name|appStateDataPB
operator|.
name|getProto
argument_list|()
operator|.
name|toByteArray
argument_list|()
decl_stmt|;
name|safeCreate
argument_list|(
name|nodeCreatePath
argument_list|,
name|appStateData
argument_list|,
name|zkAcl
argument_list|,
name|CreateMode
operator|.
name|PERSISTENT
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|updateApplicationStateInternal (ApplicationId appId, ApplicationStateData appStateDataPB)
specifier|public
specifier|synchronized
name|void
name|updateApplicationStateInternal
parameter_list|(
name|ApplicationId
name|appId
parameter_list|,
name|ApplicationStateData
name|appStateDataPB
parameter_list|)
throws|throws
name|Exception
block|{
name|String
name|nodeUpdatePath
init|=
name|getNodePath
argument_list|(
name|rmAppRoot
argument_list|,
name|appId
operator|.
name|toString
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Storing final state info for app: "
operator|+
name|appId
operator|+
literal|" at: "
operator|+
name|nodeUpdatePath
argument_list|)
expr_stmt|;
block|}
name|byte
index|[]
name|appStateData
init|=
name|appStateDataPB
operator|.
name|getProto
argument_list|()
operator|.
name|toByteArray
argument_list|()
decl_stmt|;
if|if
condition|(
name|exists
argument_list|(
name|nodeUpdatePath
argument_list|)
condition|)
block|{
name|safeSetData
argument_list|(
name|nodeUpdatePath
argument_list|,
name|appStateData
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|safeCreate
argument_list|(
name|nodeUpdatePath
argument_list|,
name|appStateData
argument_list|,
name|zkAcl
argument_list|,
name|CreateMode
operator|.
name|PERSISTENT
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
name|appId
operator|+
literal|" znode didn't exist. Created a new znode to"
operator|+
literal|" update the application state."
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|storeApplicationAttemptStateInternal ( ApplicationAttemptId appAttemptId, ApplicationAttemptStateData attemptStateDataPB)
specifier|public
specifier|synchronized
name|void
name|storeApplicationAttemptStateInternal
parameter_list|(
name|ApplicationAttemptId
name|appAttemptId
parameter_list|,
name|ApplicationAttemptStateData
name|attemptStateDataPB
parameter_list|)
throws|throws
name|Exception
block|{
name|String
name|appDirPath
init|=
name|getNodePath
argument_list|(
name|rmAppRoot
argument_list|,
name|appAttemptId
operator|.
name|getApplicationId
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
decl_stmt|;
name|String
name|nodeCreatePath
init|=
name|getNodePath
argument_list|(
name|appDirPath
argument_list|,
name|appAttemptId
operator|.
name|toString
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Storing info for attempt: "
operator|+
name|appAttemptId
operator|+
literal|" at: "
operator|+
name|nodeCreatePath
argument_list|)
expr_stmt|;
block|}
name|byte
index|[]
name|attemptStateData
init|=
name|attemptStateDataPB
operator|.
name|getProto
argument_list|()
operator|.
name|toByteArray
argument_list|()
decl_stmt|;
name|safeCreate
argument_list|(
name|nodeCreatePath
argument_list|,
name|attemptStateData
argument_list|,
name|zkAcl
argument_list|,
name|CreateMode
operator|.
name|PERSISTENT
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|updateApplicationAttemptStateInternal ( ApplicationAttemptId appAttemptId, ApplicationAttemptStateData attemptStateDataPB)
specifier|public
specifier|synchronized
name|void
name|updateApplicationAttemptStateInternal
parameter_list|(
name|ApplicationAttemptId
name|appAttemptId
parameter_list|,
name|ApplicationAttemptStateData
name|attemptStateDataPB
parameter_list|)
throws|throws
name|Exception
block|{
name|String
name|appIdStr
init|=
name|appAttemptId
operator|.
name|getApplicationId
argument_list|()
operator|.
name|toString
argument_list|()
decl_stmt|;
name|String
name|appAttemptIdStr
init|=
name|appAttemptId
operator|.
name|toString
argument_list|()
decl_stmt|;
name|String
name|appDirPath
init|=
name|getNodePath
argument_list|(
name|rmAppRoot
argument_list|,
name|appIdStr
argument_list|)
decl_stmt|;
name|String
name|nodeUpdatePath
init|=
name|getNodePath
argument_list|(
name|appDirPath
argument_list|,
name|appAttemptIdStr
argument_list|)
decl_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Storing final state info for attempt: "
operator|+
name|appAttemptIdStr
operator|+
literal|" at: "
operator|+
name|nodeUpdatePath
argument_list|)
expr_stmt|;
block|}
name|byte
index|[]
name|attemptStateData
init|=
name|attemptStateDataPB
operator|.
name|getProto
argument_list|()
operator|.
name|toByteArray
argument_list|()
decl_stmt|;
if|if
condition|(
name|exists
argument_list|(
name|nodeUpdatePath
argument_list|)
condition|)
block|{
name|safeSetData
argument_list|(
name|nodeUpdatePath
argument_list|,
name|attemptStateData
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|safeCreate
argument_list|(
name|nodeUpdatePath
argument_list|,
name|attemptStateData
argument_list|,
name|zkAcl
argument_list|,
name|CreateMode
operator|.
name|PERSISTENT
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
name|appAttemptId
operator|+
literal|" znode didn't exist. Created a new znode to"
operator|+
literal|" update the application attempt state."
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|removeApplicationAttemptInternal ( ApplicationAttemptId appAttemptId)
specifier|public
specifier|synchronized
name|void
name|removeApplicationAttemptInternal
parameter_list|(
name|ApplicationAttemptId
name|appAttemptId
parameter_list|)
throws|throws
name|Exception
block|{
name|String
name|appId
init|=
name|appAttemptId
operator|.
name|getApplicationId
argument_list|()
operator|.
name|toString
argument_list|()
decl_stmt|;
name|String
name|appIdRemovePath
init|=
name|getNodePath
argument_list|(
name|rmAppRoot
argument_list|,
name|appId
argument_list|)
decl_stmt|;
name|String
name|attemptIdRemovePath
init|=
name|getNodePath
argument_list|(
name|appIdRemovePath
argument_list|,
name|appAttemptId
operator|.
name|toString
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Removing info for attempt: "
operator|+
name|appAttemptId
operator|+
literal|" at: "
operator|+
name|attemptIdRemovePath
argument_list|)
expr_stmt|;
block|}
name|safeDelete
argument_list|(
name|attemptIdRemovePath
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|removeApplicationStateInternal ( ApplicationStateData appState)
specifier|public
specifier|synchronized
name|void
name|removeApplicationStateInternal
parameter_list|(
name|ApplicationStateData
name|appState
parameter_list|)
throws|throws
name|Exception
block|{
name|String
name|appId
init|=
name|appState
operator|.
name|getApplicationSubmissionContext
argument_list|()
operator|.
name|getApplicationId
argument_list|()
operator|.
name|toString
argument_list|()
decl_stmt|;
name|String
name|appIdRemovePath
init|=
name|getNodePath
argument_list|(
name|rmAppRoot
argument_list|,
name|appId
argument_list|)
decl_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Removing info for app: "
operator|+
name|appId
operator|+
literal|" at: "
operator|+
name|appIdRemovePath
operator|+
literal|" and its attempts."
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|ApplicationAttemptId
name|attemptId
range|:
name|appState
operator|.
name|attempts
operator|.
name|keySet
argument_list|()
control|)
block|{
name|String
name|attemptRemovePath
init|=
name|getNodePath
argument_list|(
name|appIdRemovePath
argument_list|,
name|attemptId
operator|.
name|toString
argument_list|()
argument_list|)
decl_stmt|;
name|safeDelete
argument_list|(
name|attemptRemovePath
argument_list|)
expr_stmt|;
block|}
name|safeDelete
argument_list|(
name|appIdRemovePath
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|storeRMDelegationTokenState ( RMDelegationTokenIdentifier rmDTIdentifier, Long renewDate)
specifier|protected
specifier|synchronized
name|void
name|storeRMDelegationTokenState
parameter_list|(
name|RMDelegationTokenIdentifier
name|rmDTIdentifier
parameter_list|,
name|Long
name|renewDate
parameter_list|)
throws|throws
name|Exception
block|{
name|SafeTransaction
name|trx
init|=
operator|new
name|SafeTransaction
argument_list|()
decl_stmt|;
name|addStoreOrUpdateOps
argument_list|(
name|trx
argument_list|,
name|rmDTIdentifier
argument_list|,
name|renewDate
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|trx
operator|.
name|commit
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|removeRMDelegationTokenState ( RMDelegationTokenIdentifier rmDTIdentifier)
specifier|protected
specifier|synchronized
name|void
name|removeRMDelegationTokenState
parameter_list|(
name|RMDelegationTokenIdentifier
name|rmDTIdentifier
parameter_list|)
throws|throws
name|Exception
block|{
name|String
name|nodeRemovePath
init|=
name|getNodePath
argument_list|(
name|delegationTokensRootPath
argument_list|,
name|DELEGATION_TOKEN_PREFIX
operator|+
name|rmDTIdentifier
operator|.
name|getSequenceNumber
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Removing RMDelegationToken_"
operator|+
name|rmDTIdentifier
operator|.
name|getSequenceNumber
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|safeDelete
argument_list|(
name|nodeRemovePath
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|updateRMDelegationTokenState ( RMDelegationTokenIdentifier rmDTIdentifier, Long renewDate)
specifier|protected
specifier|synchronized
name|void
name|updateRMDelegationTokenState
parameter_list|(
name|RMDelegationTokenIdentifier
name|rmDTIdentifier
parameter_list|,
name|Long
name|renewDate
parameter_list|)
throws|throws
name|Exception
block|{
name|SafeTransaction
name|trx
init|=
operator|new
name|SafeTransaction
argument_list|()
decl_stmt|;
name|String
name|nodeRemovePath
init|=
name|getNodePath
argument_list|(
name|delegationTokensRootPath
argument_list|,
name|DELEGATION_TOKEN_PREFIX
operator|+
name|rmDTIdentifier
operator|.
name|getSequenceNumber
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|exists
argument_list|(
name|nodeRemovePath
argument_list|)
condition|)
block|{
comment|// in case znode exists
name|addStoreOrUpdateOps
argument_list|(
name|trx
argument_list|,
name|rmDTIdentifier
argument_list|,
name|renewDate
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// in case znode doesn't exist
name|addStoreOrUpdateOps
argument_list|(
name|trx
argument_list|,
name|rmDTIdentifier
argument_list|,
name|renewDate
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"Attempted to update a non-existing znode "
operator|+
name|nodeRemovePath
argument_list|)
expr_stmt|;
block|}
name|trx
operator|.
name|commit
argument_list|()
expr_stmt|;
block|}
DECL|method|addStoreOrUpdateOps (SafeTransaction trx, RMDelegationTokenIdentifier rmDTIdentifier, Long renewDate, boolean isUpdate)
specifier|private
name|void
name|addStoreOrUpdateOps
parameter_list|(
name|SafeTransaction
name|trx
parameter_list|,
name|RMDelegationTokenIdentifier
name|rmDTIdentifier
parameter_list|,
name|Long
name|renewDate
parameter_list|,
name|boolean
name|isUpdate
parameter_list|)
throws|throws
name|Exception
block|{
comment|// store RM delegation token
name|String
name|nodeCreatePath
init|=
name|getNodePath
argument_list|(
name|delegationTokensRootPath
argument_list|,
name|DELEGATION_TOKEN_PREFIX
operator|+
name|rmDTIdentifier
operator|.
name|getSequenceNumber
argument_list|()
argument_list|)
decl_stmt|;
name|ByteArrayOutputStream
name|seqOs
init|=
operator|new
name|ByteArrayOutputStream
argument_list|()
decl_stmt|;
name|DataOutputStream
name|seqOut
init|=
operator|new
name|DataOutputStream
argument_list|(
name|seqOs
argument_list|)
decl_stmt|;
name|RMDelegationTokenIdentifierData
name|identifierData
init|=
operator|new
name|RMDelegationTokenIdentifierData
argument_list|(
name|rmDTIdentifier
argument_list|,
name|renewDate
argument_list|)
decl_stmt|;
try|try
block|{
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
operator|(
name|isUpdate
condition|?
literal|"Storing "
else|:
literal|"Updating "
operator|)
operator|+
literal|"RMDelegationToken_"
operator|+
name|rmDTIdentifier
operator|.
name|getSequenceNumber
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|isUpdate
condition|)
block|{
name|trx
operator|.
name|setData
argument_list|(
name|nodeCreatePath
argument_list|,
name|identifierData
operator|.
name|toByteArray
argument_list|()
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|trx
operator|.
name|create
argument_list|(
name|nodeCreatePath
argument_list|,
name|identifierData
operator|.
name|toByteArray
argument_list|()
argument_list|,
name|zkAcl
argument_list|,
name|CreateMode
operator|.
name|PERSISTENT
argument_list|)
expr_stmt|;
comment|// Update Sequence number only while storing DT
name|seqOut
operator|.
name|writeInt
argument_list|(
name|rmDTIdentifier
operator|.
name|getSequenceNumber
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
operator|(
name|isUpdate
condition|?
literal|"Storing "
else|:
literal|"Updating "
operator|)
operator|+
name|dtSequenceNumberPath
operator|+
literal|". SequenceNumber: "
operator|+
name|rmDTIdentifier
operator|.
name|getSequenceNumber
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|trx
operator|.
name|setData
argument_list|(
name|dtSequenceNumberPath
argument_list|,
name|seqOs
operator|.
name|toByteArray
argument_list|()
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
finally|finally
block|{
name|seqOs
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|storeRMDTMasterKeyState ( DelegationKey delegationKey)
specifier|protected
specifier|synchronized
name|void
name|storeRMDTMasterKeyState
parameter_list|(
name|DelegationKey
name|delegationKey
parameter_list|)
throws|throws
name|Exception
block|{
name|String
name|nodeCreatePath
init|=
name|getNodePath
argument_list|(
name|dtMasterKeysRootPath
argument_list|,
name|DELEGATION_KEY_PREFIX
operator|+
name|delegationKey
operator|.
name|getKeyId
argument_list|()
argument_list|)
decl_stmt|;
name|ByteArrayOutputStream
name|os
init|=
operator|new
name|ByteArrayOutputStream
argument_list|()
decl_stmt|;
name|DataOutputStream
name|fsOut
init|=
operator|new
name|DataOutputStream
argument_list|(
name|os
argument_list|)
decl_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Storing RMDelegationKey_"
operator|+
name|delegationKey
operator|.
name|getKeyId
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|delegationKey
operator|.
name|write
argument_list|(
name|fsOut
argument_list|)
expr_stmt|;
try|try
block|{
name|safeCreate
argument_list|(
name|nodeCreatePath
argument_list|,
name|os
operator|.
name|toByteArray
argument_list|()
argument_list|,
name|zkAcl
argument_list|,
name|CreateMode
operator|.
name|PERSISTENT
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|os
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|removeRMDTMasterKeyState ( DelegationKey delegationKey)
specifier|protected
specifier|synchronized
name|void
name|removeRMDTMasterKeyState
parameter_list|(
name|DelegationKey
name|delegationKey
parameter_list|)
throws|throws
name|Exception
block|{
name|String
name|nodeRemovePath
init|=
name|getNodePath
argument_list|(
name|dtMasterKeysRootPath
argument_list|,
name|DELEGATION_KEY_PREFIX
operator|+
name|delegationKey
operator|.
name|getKeyId
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Removing RMDelegationKey_"
operator|+
name|delegationKey
operator|.
name|getKeyId
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|safeDelete
argument_list|(
name|nodeRemovePath
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|deleteStore ()
specifier|public
specifier|synchronized
name|void
name|deleteStore
parameter_list|()
throws|throws
name|Exception
block|{
name|delete
argument_list|(
name|zkRootNodePath
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|removeApplication (ApplicationId removeAppId)
specifier|public
specifier|synchronized
name|void
name|removeApplication
parameter_list|(
name|ApplicationId
name|removeAppId
parameter_list|)
throws|throws
name|Exception
block|{
name|String
name|appIdRemovePath
init|=
name|getNodePath
argument_list|(
name|rmAppRoot
argument_list|,
name|removeAppId
operator|.
name|toString
argument_list|()
argument_list|)
decl_stmt|;
name|delete
argument_list|(
name|appIdRemovePath
argument_list|)
expr_stmt|;
block|}
annotation|@
name|VisibleForTesting
DECL|method|getNodePath (String root, String nodeName)
name|String
name|getNodePath
parameter_list|(
name|String
name|root
parameter_list|,
name|String
name|nodeName
parameter_list|)
block|{
return|return
operator|(
name|root
operator|+
literal|"/"
operator|+
name|nodeName
operator|)
return|;
block|}
annotation|@
name|Override
DECL|method|storeOrUpdateAMRMTokenSecretManagerState ( AMRMTokenSecretManagerState amrmTokenSecretManagerState, boolean isUpdate)
specifier|public
specifier|synchronized
name|void
name|storeOrUpdateAMRMTokenSecretManagerState
parameter_list|(
name|AMRMTokenSecretManagerState
name|amrmTokenSecretManagerState
parameter_list|,
name|boolean
name|isUpdate
parameter_list|)
throws|throws
name|Exception
block|{
name|AMRMTokenSecretManagerState
name|data
init|=
name|AMRMTokenSecretManagerState
operator|.
name|newInstance
argument_list|(
name|amrmTokenSecretManagerState
argument_list|)
decl_stmt|;
name|byte
index|[]
name|stateData
init|=
name|data
operator|.
name|getProto
argument_list|()
operator|.
name|toByteArray
argument_list|()
decl_stmt|;
name|safeSetData
argument_list|(
name|amrmTokenSecretManagerRoot
argument_list|,
name|stateData
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|removeReservationState (String planName, String reservationIdName)
specifier|protected
specifier|synchronized
name|void
name|removeReservationState
parameter_list|(
name|String
name|planName
parameter_list|,
name|String
name|reservationIdName
parameter_list|)
throws|throws
name|Exception
block|{
name|String
name|planNodePath
init|=
name|getNodePath
argument_list|(
name|reservationRoot
argument_list|,
name|planName
argument_list|)
decl_stmt|;
name|String
name|reservationPath
init|=
name|getNodePath
argument_list|(
name|planNodePath
argument_list|,
name|reservationIdName
argument_list|)
decl_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Removing reservationallocation "
operator|+
name|reservationIdName
operator|+
literal|" for"
operator|+
literal|" plan "
operator|+
name|planName
argument_list|)
expr_stmt|;
block|}
name|safeDelete
argument_list|(
name|reservationPath
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|reservationNodes
init|=
name|getChildren
argument_list|(
name|planNodePath
argument_list|)
decl_stmt|;
if|if
condition|(
name|reservationNodes
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|safeDelete
argument_list|(
name|planNodePath
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|storeReservationState ( ReservationAllocationStateProto reservationAllocation, String planName, String reservationIdName)
specifier|protected
specifier|synchronized
name|void
name|storeReservationState
parameter_list|(
name|ReservationAllocationStateProto
name|reservationAllocation
parameter_list|,
name|String
name|planName
parameter_list|,
name|String
name|reservationIdName
parameter_list|)
throws|throws
name|Exception
block|{
name|SafeTransaction
name|trx
init|=
operator|new
name|SafeTransaction
argument_list|()
decl_stmt|;
name|addOrUpdateReservationState
argument_list|(
name|reservationAllocation
argument_list|,
name|planName
argument_list|,
name|reservationIdName
argument_list|,
name|trx
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|trx
operator|.
name|commit
argument_list|()
expr_stmt|;
block|}
DECL|method|addOrUpdateReservationState ( ReservationAllocationStateProto reservationAllocation, String planName, String reservationIdName, SafeTransaction trx, boolean isUpdate)
specifier|private
name|void
name|addOrUpdateReservationState
parameter_list|(
name|ReservationAllocationStateProto
name|reservationAllocation
parameter_list|,
name|String
name|planName
parameter_list|,
name|String
name|reservationIdName
parameter_list|,
name|SafeTransaction
name|trx
parameter_list|,
name|boolean
name|isUpdate
parameter_list|)
throws|throws
name|Exception
block|{
name|String
name|planCreatePath
init|=
name|getNodePath
argument_list|(
name|reservationRoot
argument_list|,
name|planName
argument_list|)
decl_stmt|;
name|String
name|reservationPath
init|=
name|getNodePath
argument_list|(
name|planCreatePath
argument_list|,
name|reservationIdName
argument_list|)
decl_stmt|;
name|byte
index|[]
name|reservationData
init|=
name|reservationAllocation
operator|.
name|toByteArray
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|exists
argument_list|(
name|planCreatePath
argument_list|)
condition|)
block|{
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Creating plan node: "
operator|+
name|planName
operator|+
literal|" at: "
operator|+
name|planCreatePath
argument_list|)
expr_stmt|;
block|}
name|trx
operator|.
name|create
argument_list|(
name|planCreatePath
argument_list|,
literal|null
argument_list|,
name|zkAcl
argument_list|,
name|CreateMode
operator|.
name|PERSISTENT
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|isUpdate
condition|)
block|{
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Updating reservation: "
operator|+
name|reservationIdName
operator|+
literal|" in plan:"
operator|+
name|planName
operator|+
literal|" at: "
operator|+
name|reservationPath
argument_list|)
expr_stmt|;
block|}
name|trx
operator|.
name|setData
argument_list|(
name|reservationPath
argument_list|,
name|reservationData
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Storing reservation: "
operator|+
name|reservationIdName
operator|+
literal|" in plan:"
operator|+
name|planName
operator|+
literal|" at: "
operator|+
name|reservationPath
argument_list|)
expr_stmt|;
block|}
name|trx
operator|.
name|create
argument_list|(
name|reservationPath
argument_list|,
name|reservationData
argument_list|,
name|zkAcl
argument_list|,
name|CreateMode
operator|.
name|PERSISTENT
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**    * Utility function to ensure that the configured base znode exists.    * This recursively creates the znode as well as all of its parents.    */
DECL|method|createRootDirRecursively (String path)
specifier|private
name|void
name|createRootDirRecursively
parameter_list|(
name|String
name|path
parameter_list|)
throws|throws
name|Exception
block|{
name|String
name|pathParts
index|[]
init|=
name|path
operator|.
name|split
argument_list|(
literal|"/"
argument_list|)
decl_stmt|;
name|Preconditions
operator|.
name|checkArgument
argument_list|(
name|pathParts
operator|.
name|length
operator|>=
literal|1
operator|&&
name|pathParts
index|[
literal|0
index|]
operator|.
name|isEmpty
argument_list|()
argument_list|,
literal|"Invalid path: %s"
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|StringBuilder
name|sb
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|1
init|;
name|i
operator|<
name|pathParts
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|sb
operator|.
name|append
argument_list|(
literal|"/"
argument_list|)
operator|.
name|append
argument_list|(
name|pathParts
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|create
argument_list|(
name|sb
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|VisibleForTesting
DECL|method|getData (final String path)
name|byte
index|[]
name|getData
parameter_list|(
specifier|final
name|String
name|path
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|curatorFramework
operator|.
name|getData
argument_list|()
operator|.
name|forPath
argument_list|(
name|path
argument_list|)
return|;
block|}
annotation|@
name|VisibleForTesting
DECL|method|getACL (final String path)
name|List
argument_list|<
name|ACL
argument_list|>
name|getACL
parameter_list|(
specifier|final
name|String
name|path
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|curatorFramework
operator|.
name|getACL
argument_list|()
operator|.
name|forPath
argument_list|(
name|path
argument_list|)
return|;
block|}
DECL|method|getChildren (final String path)
specifier|private
name|List
argument_list|<
name|String
argument_list|>
name|getChildren
parameter_list|(
specifier|final
name|String
name|path
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|curatorFramework
operator|.
name|getChildren
argument_list|()
operator|.
name|forPath
argument_list|(
name|path
argument_list|)
return|;
block|}
DECL|method|exists (final String path)
specifier|private
name|boolean
name|exists
parameter_list|(
specifier|final
name|String
name|path
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|curatorFramework
operator|.
name|checkExists
argument_list|()
operator|.
name|forPath
argument_list|(
name|path
argument_list|)
operator|!=
literal|null
return|;
block|}
annotation|@
name|VisibleForTesting
DECL|method|create (final String path)
name|void
name|create
parameter_list|(
specifier|final
name|String
name|path
parameter_list|)
throws|throws
name|Exception
block|{
if|if
condition|(
operator|!
name|exists
argument_list|(
name|path
argument_list|)
condition|)
block|{
name|curatorFramework
operator|.
name|create
argument_list|()
operator|.
name|withMode
argument_list|(
name|CreateMode
operator|.
name|PERSISTENT
argument_list|)
operator|.
name|withACL
argument_list|(
name|zkAcl
argument_list|)
operator|.
name|forPath
argument_list|(
name|path
argument_list|,
literal|null
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|VisibleForTesting
DECL|method|delete (final String path)
name|void
name|delete
parameter_list|(
specifier|final
name|String
name|path
parameter_list|)
throws|throws
name|Exception
block|{
if|if
condition|(
name|exists
argument_list|(
name|path
argument_list|)
condition|)
block|{
name|curatorFramework
operator|.
name|delete
argument_list|()
operator|.
name|deletingChildrenIfNeeded
argument_list|()
operator|.
name|forPath
argument_list|(
name|path
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|safeCreate (String path, byte[] data, List<ACL> acl, CreateMode mode)
specifier|private
name|void
name|safeCreate
parameter_list|(
name|String
name|path
parameter_list|,
name|byte
index|[]
name|data
parameter_list|,
name|List
argument_list|<
name|ACL
argument_list|>
name|acl
parameter_list|,
name|CreateMode
name|mode
parameter_list|)
throws|throws
name|Exception
block|{
if|if
condition|(
operator|!
name|exists
argument_list|(
name|path
argument_list|)
condition|)
block|{
name|SafeTransaction
name|transaction
init|=
operator|new
name|SafeTransaction
argument_list|()
decl_stmt|;
name|transaction
operator|.
name|create
argument_list|(
name|path
argument_list|,
name|data
argument_list|,
name|acl
argument_list|,
name|mode
argument_list|)
expr_stmt|;
name|transaction
operator|.
name|commit
argument_list|()
expr_stmt|;
block|}
block|}
DECL|method|safeDelete (final String path)
specifier|private
name|void
name|safeDelete
parameter_list|(
specifier|final
name|String
name|path
parameter_list|)
throws|throws
name|Exception
block|{
if|if
condition|(
name|exists
argument_list|(
name|path
argument_list|)
condition|)
block|{
name|SafeTransaction
name|transaction
init|=
operator|new
name|SafeTransaction
argument_list|()
decl_stmt|;
name|transaction
operator|.
name|delete
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|transaction
operator|.
name|commit
argument_list|()
expr_stmt|;
block|}
block|}
DECL|method|safeSetData (String path, byte[] data, int version)
specifier|private
name|void
name|safeSetData
parameter_list|(
name|String
name|path
parameter_list|,
name|byte
index|[]
name|data
parameter_list|,
name|int
name|version
parameter_list|)
throws|throws
name|Exception
block|{
name|SafeTransaction
name|transaction
init|=
operator|new
name|SafeTransaction
argument_list|()
decl_stmt|;
name|transaction
operator|.
name|setData
argument_list|(
name|path
argument_list|,
name|data
argument_list|,
name|version
argument_list|)
expr_stmt|;
name|transaction
operator|.
name|commit
argument_list|()
expr_stmt|;
block|}
comment|/**    * Use curator transactions to ensure zk-operations are performed in an all    * or nothing fashion. This is equivalent to using ZooKeeper#multi.    *    * TODO (YARN-3774): Curator 3.0 introduces CuratorOp similar to Op. We ll    * have to rewrite this inner class when we adopt that.    */
DECL|class|SafeTransaction
specifier|private
class|class
name|SafeTransaction
block|{
DECL|field|transactionFinal
specifier|private
name|CuratorTransactionFinal
name|transactionFinal
decl_stmt|;
DECL|method|SafeTransaction ()
name|SafeTransaction
parameter_list|()
throws|throws
name|Exception
block|{
name|CuratorTransaction
name|transaction
init|=
name|curatorFramework
operator|.
name|inTransaction
argument_list|()
decl_stmt|;
name|transactionFinal
operator|=
name|transaction
operator|.
name|create
argument_list|()
operator|.
name|withMode
argument_list|(
name|CreateMode
operator|.
name|PERSISTENT
argument_list|)
operator|.
name|withACL
argument_list|(
name|zkAcl
argument_list|)
operator|.
name|forPath
argument_list|(
name|fencingNodePath
argument_list|,
operator|new
name|byte
index|[
literal|0
index|]
argument_list|)
operator|.
name|and
argument_list|()
expr_stmt|;
block|}
DECL|method|commit ()
specifier|public
name|void
name|commit
parameter_list|()
throws|throws
name|Exception
block|{
name|transactionFinal
operator|=
name|transactionFinal
operator|.
name|delete
argument_list|()
operator|.
name|forPath
argument_list|(
name|fencingNodePath
argument_list|)
operator|.
name|and
argument_list|()
expr_stmt|;
name|transactionFinal
operator|.
name|commit
argument_list|()
expr_stmt|;
block|}
DECL|method|create (String path, byte[] data, List<ACL> acl, CreateMode mode)
specifier|public
name|void
name|create
parameter_list|(
name|String
name|path
parameter_list|,
name|byte
index|[]
name|data
parameter_list|,
name|List
argument_list|<
name|ACL
argument_list|>
name|acl
parameter_list|,
name|CreateMode
name|mode
parameter_list|)
throws|throws
name|Exception
block|{
name|transactionFinal
operator|=
name|transactionFinal
operator|.
name|create
argument_list|()
operator|.
name|withMode
argument_list|(
name|mode
argument_list|)
operator|.
name|withACL
argument_list|(
name|acl
argument_list|)
operator|.
name|forPath
argument_list|(
name|path
argument_list|,
name|data
argument_list|)
operator|.
name|and
argument_list|()
expr_stmt|;
block|}
DECL|method|delete (String path)
specifier|public
name|void
name|delete
parameter_list|(
name|String
name|path
parameter_list|)
throws|throws
name|Exception
block|{
name|transactionFinal
operator|=
name|transactionFinal
operator|.
name|delete
argument_list|()
operator|.
name|forPath
argument_list|(
name|path
argument_list|)
operator|.
name|and
argument_list|()
expr_stmt|;
block|}
DECL|method|setData (String path, byte[] data, int version)
specifier|public
name|void
name|setData
parameter_list|(
name|String
name|path
parameter_list|,
name|byte
index|[]
name|data
parameter_list|,
name|int
name|version
parameter_list|)
throws|throws
name|Exception
block|{
name|transactionFinal
operator|=
name|transactionFinal
operator|.
name|setData
argument_list|()
operator|.
name|withVersion
argument_list|(
name|version
argument_list|)
operator|.
name|forPath
argument_list|(
name|path
argument_list|,
name|data
argument_list|)
operator|.
name|and
argument_list|()
expr_stmt|;
block|}
block|}
comment|/**    * Helper class that periodically attempts creating a znode to ensure that    * this RM continues to be the Active.    */
DECL|class|VerifyActiveStatusThread
specifier|private
class|class
name|VerifyActiveStatusThread
extends|extends
name|Thread
block|{
DECL|method|VerifyActiveStatusThread ()
name|VerifyActiveStatusThread
parameter_list|()
block|{
name|super
argument_list|(
name|VerifyActiveStatusThread
operator|.
name|class
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|run ()
specifier|public
name|void
name|run
parameter_list|()
block|{
try|try
block|{
while|while
condition|(
literal|true
condition|)
block|{
if|if
condition|(
name|isFencedState
argument_list|()
condition|)
block|{
break|break;
block|}
comment|// Create and delete fencing node
operator|new
name|SafeTransaction
argument_list|()
operator|.
name|commit
argument_list|()
expr_stmt|;
name|Thread
operator|.
name|sleep
argument_list|(
name|zkSessionTimeout
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|ie
parameter_list|)
block|{
name|LOG
operator|.
name|info
argument_list|(
name|VerifyActiveStatusThread
operator|.
name|class
operator|.
name|getName
argument_list|()
operator|+
literal|" thread "
operator|+
literal|"interrupted! Exiting!"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|notifyStoreOperationFailed
argument_list|(
operator|new
name|StoreFencedException
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_class

end_unit

