begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/** * Licensed to the Apache Software Foundation (ASF) under one * or more contributor license agreements.  See the NOTICE file * distributed with this work for additional information * regarding copyright ownership.  The ASF licenses this file * to you under the Apache License, Version 2.0 (the * "License"); you may not use this file except in compliance * with the License.  You may obtain a copy of the License at * *     http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */
end_comment

begin_package
DECL|package|org.apache.hadoop.yarn.server.resourcemanager.scheduler.capacity
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|scheduler
operator|.
name|capacity
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collection
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Comparator
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Iterator
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Set
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|TreeSet
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|Log
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|LogFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|classification
operator|.
name|InterfaceAudience
operator|.
name|Private
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|classification
operator|.
name|InterfaceStability
operator|.
name|Evolving
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|AccessControlException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|UserGroupInformation
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|authorize
operator|.
name|AccessControlList
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|Container
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|ContainerStatus
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|QueueACL
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|QueueInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|QueueState
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|QueueUserACLInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|Resource
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|factories
operator|.
name|RecordFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|factory
operator|.
name|providers
operator|.
name|RecordFactoryProvider
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|rmcontainer
operator|.
name|RMContainer
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|rmcontainer
operator|.
name|RMContainerEventType
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|scheduler
operator|.
name|ActiveUsersManager
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|scheduler
operator|.
name|NodeType
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|scheduler
operator|.
name|QueueMetrics
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|scheduler
operator|.
name|common
operator|.
name|fica
operator|.
name|FiCaSchedulerApp
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|scheduler
operator|.
name|common
operator|.
name|fica
operator|.
name|FiCaSchedulerNode
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|util
operator|.
name|resource
operator|.
name|ResourceCalculator
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|util
operator|.
name|resource
operator|.
name|Resources
import|;
end_import

begin_class
annotation|@
name|Private
annotation|@
name|Evolving
DECL|class|ParentQueue
specifier|public
class|class
name|ParentQueue
implements|implements
name|CSQueue
block|{
DECL|field|LOG
specifier|private
specifier|static
specifier|final
name|Log
name|LOG
init|=
name|LogFactory
operator|.
name|getLog
argument_list|(
name|ParentQueue
operator|.
name|class
argument_list|)
decl_stmt|;
DECL|field|parent
specifier|private
name|CSQueue
name|parent
decl_stmt|;
DECL|field|queueName
specifier|private
specifier|final
name|String
name|queueName
decl_stmt|;
DECL|field|capacity
specifier|private
name|float
name|capacity
decl_stmt|;
DECL|field|maximumCapacity
specifier|private
name|float
name|maximumCapacity
decl_stmt|;
DECL|field|absoluteCapacity
specifier|private
name|float
name|absoluteCapacity
decl_stmt|;
DECL|field|absoluteMaxCapacity
specifier|private
name|float
name|absoluteMaxCapacity
decl_stmt|;
DECL|field|absoluteUsedCapacity
specifier|private
name|float
name|absoluteUsedCapacity
init|=
literal|0.0f
decl_stmt|;
DECL|field|usedCapacity
specifier|private
name|float
name|usedCapacity
init|=
literal|0.0f
decl_stmt|;
DECL|field|childQueues
specifier|private
specifier|final
name|Set
argument_list|<
name|CSQueue
argument_list|>
name|childQueues
decl_stmt|;
DECL|field|queueComparator
specifier|private
specifier|final
name|Comparator
argument_list|<
name|CSQueue
argument_list|>
name|queueComparator
decl_stmt|;
DECL|field|usedResources
specifier|private
name|Resource
name|usedResources
init|=
name|Resources
operator|.
name|createResource
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
decl_stmt|;
DECL|field|rootQueue
specifier|private
specifier|final
name|boolean
name|rootQueue
decl_stmt|;
DECL|field|minimumAllocation
specifier|private
specifier|final
name|Resource
name|minimumAllocation
decl_stmt|;
DECL|field|numApplications
specifier|private
specifier|volatile
name|int
name|numApplications
decl_stmt|;
DECL|field|numContainers
specifier|private
specifier|volatile
name|int
name|numContainers
decl_stmt|;
DECL|field|state
specifier|private
name|QueueState
name|state
decl_stmt|;
DECL|field|metrics
specifier|private
specifier|final
name|QueueMetrics
name|metrics
decl_stmt|;
DECL|field|queueInfo
specifier|private
name|QueueInfo
name|queueInfo
decl_stmt|;
DECL|field|acls
specifier|private
name|Map
argument_list|<
name|QueueACL
argument_list|,
name|AccessControlList
argument_list|>
name|acls
init|=
operator|new
name|HashMap
argument_list|<
name|QueueACL
argument_list|,
name|AccessControlList
argument_list|>
argument_list|()
decl_stmt|;
DECL|field|recordFactory
specifier|private
specifier|final
name|RecordFactory
name|recordFactory
init|=
name|RecordFactoryProvider
operator|.
name|getRecordFactory
argument_list|(
literal|null
argument_list|)
decl_stmt|;
DECL|field|resourceCalculator
specifier|private
specifier|final
name|ResourceCalculator
name|resourceCalculator
decl_stmt|;
DECL|method|ParentQueue (CapacitySchedulerContext cs, String queueName, CSQueue parent, CSQueue old)
specifier|public
name|ParentQueue
parameter_list|(
name|CapacitySchedulerContext
name|cs
parameter_list|,
name|String
name|queueName
parameter_list|,
name|CSQueue
name|parent
parameter_list|,
name|CSQueue
name|old
parameter_list|)
block|{
name|minimumAllocation
operator|=
name|cs
operator|.
name|getMinimumResourceCapability
argument_list|()
expr_stmt|;
name|this
operator|.
name|parent
operator|=
name|parent
expr_stmt|;
name|this
operator|.
name|queueName
operator|=
name|queueName
expr_stmt|;
name|this
operator|.
name|rootQueue
operator|=
operator|(
name|parent
operator|==
literal|null
operator|)
expr_stmt|;
name|this
operator|.
name|resourceCalculator
operator|=
name|cs
operator|.
name|getResourceCalculator
argument_list|()
expr_stmt|;
comment|// must be called after parent and queueName is set
name|this
operator|.
name|metrics
operator|=
name|old
operator|!=
literal|null
condition|?
name|old
operator|.
name|getMetrics
argument_list|()
else|:
name|QueueMetrics
operator|.
name|forQueue
argument_list|(
name|getQueuePath
argument_list|()
argument_list|,
name|parent
argument_list|,
name|cs
operator|.
name|getConfiguration
argument_list|()
operator|.
name|getEnableUserMetrics
argument_list|()
argument_list|,
name|cs
operator|.
name|getConf
argument_list|()
argument_list|)
expr_stmt|;
name|float
name|rawCapacity
init|=
name|cs
operator|.
name|getConfiguration
argument_list|()
operator|.
name|getCapacity
argument_list|(
name|getQueuePath
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|rootQueue
operator|&&
operator|(
name|rawCapacity
operator|!=
name|CapacitySchedulerConfiguration
operator|.
name|MAXIMUM_CAPACITY_VALUE
operator|)
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"Illegal "
operator|+
literal|"capacity of "
operator|+
name|rawCapacity
operator|+
literal|" for queue "
operator|+
name|queueName
operator|+
literal|". Must be "
operator|+
name|CapacitySchedulerConfiguration
operator|.
name|MAXIMUM_CAPACITY_VALUE
argument_list|)
throw|;
block|}
name|float
name|capacity
init|=
operator|(
name|float
operator|)
name|rawCapacity
operator|/
literal|100
decl_stmt|;
name|float
name|parentAbsoluteCapacity
init|=
operator|(
name|rootQueue
operator|)
condition|?
literal|1.0f
else|:
name|parent
operator|.
name|getAbsoluteCapacity
argument_list|()
decl_stmt|;
name|float
name|absoluteCapacity
init|=
name|parentAbsoluteCapacity
operator|*
name|capacity
decl_stmt|;
name|float
name|maximumCapacity
init|=
operator|(
name|float
operator|)
name|cs
operator|.
name|getConfiguration
argument_list|()
operator|.
name|getMaximumCapacity
argument_list|(
name|getQueuePath
argument_list|()
argument_list|)
operator|/
literal|100
decl_stmt|;
name|float
name|absoluteMaxCapacity
init|=
name|CSQueueUtils
operator|.
name|computeAbsoluteMaximumCapacity
argument_list|(
name|maximumCapacity
argument_list|,
name|parent
argument_list|)
decl_stmt|;
name|QueueState
name|state
init|=
name|cs
operator|.
name|getConfiguration
argument_list|()
operator|.
name|getState
argument_list|(
name|getQueuePath
argument_list|()
argument_list|)
decl_stmt|;
name|Map
argument_list|<
name|QueueACL
argument_list|,
name|AccessControlList
argument_list|>
name|acls
init|=
name|cs
operator|.
name|getConfiguration
argument_list|()
operator|.
name|getAcls
argument_list|(
name|getQueuePath
argument_list|()
argument_list|)
decl_stmt|;
name|this
operator|.
name|queueInfo
operator|=
name|recordFactory
operator|.
name|newRecordInstance
argument_list|(
name|QueueInfo
operator|.
name|class
argument_list|)
expr_stmt|;
name|this
operator|.
name|queueInfo
operator|.
name|setQueueName
argument_list|(
name|queueName
argument_list|)
expr_stmt|;
name|this
operator|.
name|queueInfo
operator|.
name|setChildQueues
argument_list|(
operator|new
name|ArrayList
argument_list|<
name|QueueInfo
argument_list|>
argument_list|()
argument_list|)
expr_stmt|;
name|setupQueueConfigs
argument_list|(
name|cs
operator|.
name|getClusterResources
argument_list|()
argument_list|,
name|capacity
argument_list|,
name|absoluteCapacity
argument_list|,
name|maximumCapacity
argument_list|,
name|absoluteMaxCapacity
argument_list|,
name|state
argument_list|,
name|acls
argument_list|)
expr_stmt|;
name|this
operator|.
name|queueComparator
operator|=
name|cs
operator|.
name|getQueueComparator
argument_list|()
expr_stmt|;
name|this
operator|.
name|childQueues
operator|=
operator|new
name|TreeSet
argument_list|<
name|CSQueue
argument_list|>
argument_list|(
name|queueComparator
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Initialized parent-queue "
operator|+
name|queueName
operator|+
literal|" name="
operator|+
name|queueName
operator|+
literal|", fullname="
operator|+
name|getQueuePath
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|setupQueueConfigs ( Resource clusterResource, float capacity, float absoluteCapacity, float maximumCapacity, float absoluteMaxCapacity, QueueState state, Map<QueueACL, AccessControlList> acls )
specifier|private
specifier|synchronized
name|void
name|setupQueueConfigs
parameter_list|(
name|Resource
name|clusterResource
parameter_list|,
name|float
name|capacity
parameter_list|,
name|float
name|absoluteCapacity
parameter_list|,
name|float
name|maximumCapacity
parameter_list|,
name|float
name|absoluteMaxCapacity
parameter_list|,
name|QueueState
name|state
parameter_list|,
name|Map
argument_list|<
name|QueueACL
argument_list|,
name|AccessControlList
argument_list|>
name|acls
parameter_list|)
block|{
comment|// Sanity check
name|CSQueueUtils
operator|.
name|checkMaxCapacity
argument_list|(
name|getQueueName
argument_list|()
argument_list|,
name|capacity
argument_list|,
name|maximumCapacity
argument_list|)
expr_stmt|;
name|CSQueueUtils
operator|.
name|checkAbsoluteCapacities
argument_list|(
name|getQueueName
argument_list|()
argument_list|,
name|absoluteCapacity
argument_list|,
name|absoluteMaxCapacity
argument_list|)
expr_stmt|;
name|this
operator|.
name|capacity
operator|=
name|capacity
expr_stmt|;
name|this
operator|.
name|absoluteCapacity
operator|=
name|absoluteCapacity
expr_stmt|;
name|this
operator|.
name|maximumCapacity
operator|=
name|maximumCapacity
expr_stmt|;
name|this
operator|.
name|absoluteMaxCapacity
operator|=
name|absoluteMaxCapacity
expr_stmt|;
name|this
operator|.
name|state
operator|=
name|state
expr_stmt|;
name|this
operator|.
name|acls
operator|=
name|acls
expr_stmt|;
name|this
operator|.
name|queueInfo
operator|.
name|setCapacity
argument_list|(
name|this
operator|.
name|capacity
argument_list|)
expr_stmt|;
name|this
operator|.
name|queueInfo
operator|.
name|setMaximumCapacity
argument_list|(
name|this
operator|.
name|maximumCapacity
argument_list|)
expr_stmt|;
name|this
operator|.
name|queueInfo
operator|.
name|setQueueState
argument_list|(
name|this
operator|.
name|state
argument_list|)
expr_stmt|;
name|StringBuilder
name|aclsString
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
for|for
control|(
name|Map
operator|.
name|Entry
argument_list|<
name|QueueACL
argument_list|,
name|AccessControlList
argument_list|>
name|e
range|:
name|acls
operator|.
name|entrySet
argument_list|()
control|)
block|{
name|aclsString
operator|.
name|append
argument_list|(
name|e
operator|.
name|getKey
argument_list|()
operator|+
literal|":"
operator|+
name|e
operator|.
name|getValue
argument_list|()
operator|.
name|getAclString
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|// Update metrics
name|CSQueueUtils
operator|.
name|updateQueueStatistics
argument_list|(
name|resourceCalculator
argument_list|,
name|this
argument_list|,
name|parent
argument_list|,
name|clusterResource
argument_list|,
name|minimumAllocation
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
name|queueName
operator|+
literal|", capacity="
operator|+
name|capacity
operator|+
literal|", asboluteCapacity="
operator|+
name|absoluteCapacity
operator|+
literal|", maxCapacity="
operator|+
name|maximumCapacity
operator|+
literal|", asboluteMaxCapacity="
operator|+
name|absoluteMaxCapacity
operator|+
literal|", state="
operator|+
name|state
operator|+
literal|", acls="
operator|+
name|aclsString
argument_list|)
expr_stmt|;
block|}
DECL|field|PRECISION
specifier|private
specifier|static
name|float
name|PRECISION
init|=
literal|0.0005f
decl_stmt|;
comment|// 0.05% precision
DECL|method|setChildQueues (Collection<CSQueue> childQueues)
name|void
name|setChildQueues
parameter_list|(
name|Collection
argument_list|<
name|CSQueue
argument_list|>
name|childQueues
parameter_list|)
block|{
comment|// Validate
name|float
name|childCapacities
init|=
literal|0
decl_stmt|;
for|for
control|(
name|CSQueue
name|queue
range|:
name|childQueues
control|)
block|{
name|childCapacities
operator|+=
name|queue
operator|.
name|getCapacity
argument_list|()
expr_stmt|;
block|}
name|float
name|delta
init|=
name|Math
operator|.
name|abs
argument_list|(
literal|1.0f
operator|-
name|childCapacities
argument_list|)
decl_stmt|;
comment|// crude way to check
comment|// allow capacities being set to 0, and enforce child 0 if parent is 0
if|if
condition|(
operator|(
operator|(
name|capacity
operator|>
literal|0
operator|)
operator|&&
operator|(
name|delta
operator|>
name|PRECISION
operator|)
operator|)
operator|||
operator|(
operator|(
name|capacity
operator|==
literal|0
operator|)
operator|&&
operator|(
name|childCapacities
operator|>
literal|0
operator|)
operator|)
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"Illegal"
operator|+
literal|" capacity of "
operator|+
name|childCapacities
operator|+
literal|" for children of queue "
operator|+
name|queueName
argument_list|)
throw|;
block|}
name|this
operator|.
name|childQueues
operator|.
name|clear
argument_list|()
expr_stmt|;
name|this
operator|.
name|childQueues
operator|.
name|addAll
argument_list|(
name|childQueues
argument_list|)
expr_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"setChildQueues: "
operator|+
name|getChildQueuesToPrint
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|getParent ()
specifier|public
specifier|synchronized
name|CSQueue
name|getParent
parameter_list|()
block|{
return|return
name|parent
return|;
block|}
annotation|@
name|Override
DECL|method|setParent (CSQueue newParentQueue)
specifier|public
specifier|synchronized
name|void
name|setParent
parameter_list|(
name|CSQueue
name|newParentQueue
parameter_list|)
block|{
name|this
operator|.
name|parent
operator|=
operator|(
name|ParentQueue
operator|)
name|newParentQueue
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|getQueueName ()
specifier|public
name|String
name|getQueueName
parameter_list|()
block|{
return|return
name|queueName
return|;
block|}
annotation|@
name|Override
DECL|method|getQueuePath ()
specifier|public
name|String
name|getQueuePath
parameter_list|()
block|{
name|String
name|parentPath
init|=
operator|(
operator|(
name|parent
operator|==
literal|null
operator|)
condition|?
literal|""
else|:
operator|(
name|parent
operator|.
name|getQueuePath
argument_list|()
operator|+
literal|"."
operator|)
operator|)
decl_stmt|;
return|return
name|parentPath
operator|+
name|getQueueName
argument_list|()
return|;
block|}
annotation|@
name|Override
DECL|method|getCapacity ()
specifier|public
specifier|synchronized
name|float
name|getCapacity
parameter_list|()
block|{
return|return
name|capacity
return|;
block|}
annotation|@
name|Override
DECL|method|getAbsoluteCapacity ()
specifier|public
specifier|synchronized
name|float
name|getAbsoluteCapacity
parameter_list|()
block|{
return|return
name|absoluteCapacity
return|;
block|}
annotation|@
name|Override
DECL|method|getAbsoluteMaximumCapacity ()
specifier|public
name|float
name|getAbsoluteMaximumCapacity
parameter_list|()
block|{
return|return
name|absoluteMaxCapacity
return|;
block|}
annotation|@
name|Override
DECL|method|getAbsoluteUsedCapacity ()
specifier|public
specifier|synchronized
name|float
name|getAbsoluteUsedCapacity
parameter_list|()
block|{
return|return
name|absoluteUsedCapacity
return|;
block|}
annotation|@
name|Override
DECL|method|getMaximumCapacity ()
specifier|public
name|float
name|getMaximumCapacity
parameter_list|()
block|{
return|return
name|maximumCapacity
return|;
block|}
annotation|@
name|Override
DECL|method|getActiveUsersManager ()
specifier|public
name|ActiveUsersManager
name|getActiveUsersManager
parameter_list|()
block|{
comment|// Should never be called since all applications are submitted to LeafQueues
return|return
literal|null
return|;
block|}
annotation|@
name|Override
DECL|method|getUsedCapacity ()
specifier|public
specifier|synchronized
name|float
name|getUsedCapacity
parameter_list|()
block|{
return|return
name|usedCapacity
return|;
block|}
annotation|@
name|Override
DECL|method|getUsedResources ()
specifier|public
specifier|synchronized
name|Resource
name|getUsedResources
parameter_list|()
block|{
return|return
name|usedResources
return|;
block|}
annotation|@
name|Override
DECL|method|getChildQueues ()
specifier|public
specifier|synchronized
name|List
argument_list|<
name|CSQueue
argument_list|>
name|getChildQueues
parameter_list|()
block|{
return|return
operator|new
name|ArrayList
argument_list|<
name|CSQueue
argument_list|>
argument_list|(
name|childQueues
argument_list|)
return|;
block|}
DECL|method|getNumContainers ()
specifier|public
specifier|synchronized
name|int
name|getNumContainers
parameter_list|()
block|{
return|return
name|numContainers
return|;
block|}
DECL|method|getNumApplications ()
specifier|public
specifier|synchronized
name|int
name|getNumApplications
parameter_list|()
block|{
return|return
name|numApplications
return|;
block|}
annotation|@
name|Override
DECL|method|getState ()
specifier|public
specifier|synchronized
name|QueueState
name|getState
parameter_list|()
block|{
return|return
name|state
return|;
block|}
annotation|@
name|Override
DECL|method|getQueueAcls ()
specifier|public
specifier|synchronized
name|Map
argument_list|<
name|QueueACL
argument_list|,
name|AccessControlList
argument_list|>
name|getQueueAcls
parameter_list|()
block|{
return|return
operator|new
name|HashMap
argument_list|<
name|QueueACL
argument_list|,
name|AccessControlList
argument_list|>
argument_list|(
name|acls
argument_list|)
return|;
block|}
annotation|@
name|Override
DECL|method|getQueueInfo ( boolean includeChildQueues, boolean recursive)
specifier|public
specifier|synchronized
name|QueueInfo
name|getQueueInfo
parameter_list|(
name|boolean
name|includeChildQueues
parameter_list|,
name|boolean
name|recursive
parameter_list|)
block|{
name|queueInfo
operator|.
name|setCurrentCapacity
argument_list|(
name|usedCapacity
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|QueueInfo
argument_list|>
name|childQueuesInfo
init|=
operator|new
name|ArrayList
argument_list|<
name|QueueInfo
argument_list|>
argument_list|()
decl_stmt|;
if|if
condition|(
name|includeChildQueues
condition|)
block|{
for|for
control|(
name|CSQueue
name|child
range|:
name|childQueues
control|)
block|{
comment|// Get queue information recursively?
name|childQueuesInfo
operator|.
name|add
argument_list|(
name|child
operator|.
name|getQueueInfo
argument_list|(
name|recursive
argument_list|,
name|recursive
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|queueInfo
operator|.
name|setChildQueues
argument_list|(
name|childQueuesInfo
argument_list|)
expr_stmt|;
return|return
name|queueInfo
return|;
block|}
DECL|method|getUserAclInfo ( UserGroupInformation user)
specifier|private
specifier|synchronized
name|QueueUserACLInfo
name|getUserAclInfo
parameter_list|(
name|UserGroupInformation
name|user
parameter_list|)
block|{
name|QueueUserACLInfo
name|userAclInfo
init|=
name|recordFactory
operator|.
name|newRecordInstance
argument_list|(
name|QueueUserACLInfo
operator|.
name|class
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|QueueACL
argument_list|>
name|operations
init|=
operator|new
name|ArrayList
argument_list|<
name|QueueACL
argument_list|>
argument_list|()
decl_stmt|;
for|for
control|(
name|QueueACL
name|operation
range|:
name|QueueACL
operator|.
name|values
argument_list|()
control|)
block|{
if|if
condition|(
name|hasAccess
argument_list|(
name|operation
argument_list|,
name|user
argument_list|)
condition|)
block|{
name|operations
operator|.
name|add
argument_list|(
name|operation
argument_list|)
expr_stmt|;
block|}
block|}
name|userAclInfo
operator|.
name|setQueueName
argument_list|(
name|getQueueName
argument_list|()
argument_list|)
expr_stmt|;
name|userAclInfo
operator|.
name|setUserAcls
argument_list|(
name|operations
argument_list|)
expr_stmt|;
return|return
name|userAclInfo
return|;
block|}
annotation|@
name|Override
DECL|method|getQueueUserAclInfo ( UserGroupInformation user)
specifier|public
specifier|synchronized
name|List
argument_list|<
name|QueueUserACLInfo
argument_list|>
name|getQueueUserAclInfo
parameter_list|(
name|UserGroupInformation
name|user
parameter_list|)
block|{
name|List
argument_list|<
name|QueueUserACLInfo
argument_list|>
name|userAcls
init|=
operator|new
name|ArrayList
argument_list|<
name|QueueUserACLInfo
argument_list|>
argument_list|()
decl_stmt|;
comment|// Add parent queue acls
name|userAcls
operator|.
name|add
argument_list|(
name|getUserAclInfo
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
comment|// Add children queue acls
for|for
control|(
name|CSQueue
name|child
range|:
name|childQueues
control|)
block|{
name|userAcls
operator|.
name|addAll
argument_list|(
name|child
operator|.
name|getQueueUserAclInfo
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|userAcls
return|;
block|}
DECL|method|toString ()
specifier|public
name|String
name|toString
parameter_list|()
block|{
return|return
name|queueName
operator|+
literal|": "
operator|+
literal|"numChildQueue= "
operator|+
name|childQueues
operator|.
name|size
argument_list|()
operator|+
literal|", "
operator|+
literal|"capacity="
operator|+
name|capacity
operator|+
literal|", "
operator|+
literal|"absoluteCapacity="
operator|+
name|absoluteCapacity
operator|+
literal|", "
operator|+
literal|"usedResources="
operator|+
name|usedResources
operator|+
literal|"usedCapacity="
operator|+
name|getUsedCapacity
argument_list|()
operator|+
literal|", "
operator|+
literal|"numApps="
operator|+
name|getNumApplications
argument_list|()
operator|+
literal|", "
operator|+
literal|"numContainers="
operator|+
name|getNumContainers
argument_list|()
return|;
block|}
annotation|@
name|Override
DECL|method|reinitialize ( CSQueue newlyParsedQueue, Resource clusterResource)
specifier|public
specifier|synchronized
name|void
name|reinitialize
parameter_list|(
name|CSQueue
name|newlyParsedQueue
parameter_list|,
name|Resource
name|clusterResource
parameter_list|)
throws|throws
name|IOException
block|{
comment|// Sanity check
if|if
condition|(
operator|!
operator|(
name|newlyParsedQueue
operator|instanceof
name|ParentQueue
operator|)
operator|||
operator|!
name|newlyParsedQueue
operator|.
name|getQueuePath
argument_list|()
operator|.
name|equals
argument_list|(
name|getQueuePath
argument_list|()
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Trying to reinitialize "
operator|+
name|getQueuePath
argument_list|()
operator|+
literal|" from "
operator|+
name|newlyParsedQueue
operator|.
name|getQueuePath
argument_list|()
argument_list|)
throw|;
block|}
name|ParentQueue
name|newlyParsedParentQueue
init|=
operator|(
name|ParentQueue
operator|)
name|newlyParsedQueue
decl_stmt|;
comment|// Set new configs
name|setupQueueConfigs
argument_list|(
name|clusterResource
argument_list|,
name|newlyParsedParentQueue
operator|.
name|capacity
argument_list|,
name|newlyParsedParentQueue
operator|.
name|absoluteCapacity
argument_list|,
name|newlyParsedParentQueue
operator|.
name|maximumCapacity
argument_list|,
name|newlyParsedParentQueue
operator|.
name|absoluteMaxCapacity
argument_list|,
name|newlyParsedParentQueue
operator|.
name|state
argument_list|,
name|newlyParsedParentQueue
operator|.
name|acls
argument_list|)
expr_stmt|;
comment|// Re-configure existing child queues and add new ones
comment|// The CS has already checked to ensure all existing child queues are present!
name|Map
argument_list|<
name|String
argument_list|,
name|CSQueue
argument_list|>
name|currentChildQueues
init|=
name|getQueues
argument_list|(
name|childQueues
argument_list|)
decl_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|CSQueue
argument_list|>
name|newChildQueues
init|=
name|getQueues
argument_list|(
name|newlyParsedParentQueue
operator|.
name|childQueues
argument_list|)
decl_stmt|;
for|for
control|(
name|Map
operator|.
name|Entry
argument_list|<
name|String
argument_list|,
name|CSQueue
argument_list|>
name|e
range|:
name|newChildQueues
operator|.
name|entrySet
argument_list|()
control|)
block|{
name|String
name|newChildQueueName
init|=
name|e
operator|.
name|getKey
argument_list|()
decl_stmt|;
name|CSQueue
name|newChildQueue
init|=
name|e
operator|.
name|getValue
argument_list|()
decl_stmt|;
name|CSQueue
name|childQueue
init|=
name|currentChildQueues
operator|.
name|get
argument_list|(
name|newChildQueueName
argument_list|)
decl_stmt|;
comment|// Check if the child-queue already exists
if|if
condition|(
name|childQueue
operator|!=
literal|null
condition|)
block|{
comment|// Re-init existing child queues
name|childQueue
operator|.
name|reinitialize
argument_list|(
name|newChildQueue
argument_list|,
name|clusterResource
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
name|getQueueName
argument_list|()
operator|+
literal|": re-configured queue: "
operator|+
name|childQueue
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// New child queue, do not re-init
comment|// Set parent to 'this'
name|newChildQueue
operator|.
name|setParent
argument_list|(
name|this
argument_list|)
expr_stmt|;
comment|// Save in list of current child queues
name|currentChildQueues
operator|.
name|put
argument_list|(
name|newChildQueueName
argument_list|,
name|newChildQueue
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
name|getQueueName
argument_list|()
operator|+
literal|": added new child queue: "
operator|+
name|newChildQueue
argument_list|)
expr_stmt|;
block|}
block|}
comment|// Re-sort all queues
name|childQueues
operator|.
name|clear
argument_list|()
expr_stmt|;
name|childQueues
operator|.
name|addAll
argument_list|(
name|currentChildQueues
operator|.
name|values
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|getQueues (Set<CSQueue> queues)
name|Map
argument_list|<
name|String
argument_list|,
name|CSQueue
argument_list|>
name|getQueues
parameter_list|(
name|Set
argument_list|<
name|CSQueue
argument_list|>
name|queues
parameter_list|)
block|{
name|Map
argument_list|<
name|String
argument_list|,
name|CSQueue
argument_list|>
name|queuesMap
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|CSQueue
argument_list|>
argument_list|()
decl_stmt|;
for|for
control|(
name|CSQueue
name|queue
range|:
name|queues
control|)
block|{
name|queuesMap
operator|.
name|put
argument_list|(
name|queue
operator|.
name|getQueueName
argument_list|()
argument_list|,
name|queue
argument_list|)
expr_stmt|;
block|}
return|return
name|queuesMap
return|;
block|}
annotation|@
name|Override
DECL|method|hasAccess (QueueACL acl, UserGroupInformation user)
specifier|public
name|boolean
name|hasAccess
parameter_list|(
name|QueueACL
name|acl
parameter_list|,
name|UserGroupInformation
name|user
parameter_list|)
block|{
synchronized|synchronized
init|(
name|this
init|)
block|{
if|if
condition|(
name|acls
operator|.
name|get
argument_list|(
name|acl
argument_list|)
operator|.
name|isUserAllowed
argument_list|(
name|user
argument_list|)
condition|)
block|{
return|return
literal|true
return|;
block|}
block|}
if|if
condition|(
name|parent
operator|!=
literal|null
condition|)
block|{
return|return
name|parent
operator|.
name|hasAccess
argument_list|(
name|acl
argument_list|,
name|user
argument_list|)
return|;
block|}
return|return
literal|false
return|;
block|}
annotation|@
name|Override
DECL|method|submitApplication (FiCaSchedulerApp application, String user, String queue)
specifier|public
name|void
name|submitApplication
parameter_list|(
name|FiCaSchedulerApp
name|application
parameter_list|,
name|String
name|user
parameter_list|,
name|String
name|queue
parameter_list|)
throws|throws
name|AccessControlException
block|{
synchronized|synchronized
init|(
name|this
init|)
block|{
comment|// Sanity check
if|if
condition|(
name|queue
operator|.
name|equals
argument_list|(
name|queueName
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|AccessControlException
argument_list|(
literal|"Cannot submit application "
operator|+
literal|"to non-leaf queue: "
operator|+
name|queueName
argument_list|)
throw|;
block|}
if|if
condition|(
name|state
operator|!=
name|QueueState
operator|.
name|RUNNING
condition|)
block|{
throw|throw
operator|new
name|AccessControlException
argument_list|(
literal|"Queue "
operator|+
name|getQueuePath
argument_list|()
operator|+
literal|" is STOPPED. Cannot accept submission of application: "
operator|+
name|application
operator|.
name|getApplicationId
argument_list|()
argument_list|)
throw|;
block|}
name|addApplication
argument_list|(
name|application
argument_list|,
name|user
argument_list|)
expr_stmt|;
block|}
comment|// Inform the parent queue
if|if
condition|(
name|parent
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|parent
operator|.
name|submitApplication
argument_list|(
name|application
argument_list|,
name|user
argument_list|,
name|queue
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|AccessControlException
name|ace
parameter_list|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Failed to submit application to parent-queue: "
operator|+
name|parent
operator|.
name|getQueuePath
argument_list|()
argument_list|,
name|ace
argument_list|)
expr_stmt|;
name|removeApplication
argument_list|(
name|application
argument_list|,
name|user
argument_list|)
expr_stmt|;
throw|throw
name|ace
throw|;
block|}
block|}
block|}
DECL|method|addApplication (FiCaSchedulerApp application, String user)
specifier|private
specifier|synchronized
name|void
name|addApplication
parameter_list|(
name|FiCaSchedulerApp
name|application
parameter_list|,
name|String
name|user
parameter_list|)
block|{
operator|++
name|numApplications
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Application added -"
operator|+
literal|" appId: "
operator|+
name|application
operator|.
name|getApplicationId
argument_list|()
operator|+
literal|" user: "
operator|+
name|user
operator|+
literal|" leaf-queue of parent: "
operator|+
name|getQueueName
argument_list|()
operator|+
literal|" #applications: "
operator|+
name|getNumApplications
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|finishApplication (FiCaSchedulerApp application, String queue)
specifier|public
name|void
name|finishApplication
parameter_list|(
name|FiCaSchedulerApp
name|application
parameter_list|,
name|String
name|queue
parameter_list|)
block|{
synchronized|synchronized
init|(
name|this
init|)
block|{
name|removeApplication
argument_list|(
name|application
argument_list|,
name|application
operator|.
name|getUser
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|// Inform the parent queue
if|if
condition|(
name|parent
operator|!=
literal|null
condition|)
block|{
name|parent
operator|.
name|finishApplication
argument_list|(
name|application
argument_list|,
name|queue
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|removeApplication (FiCaSchedulerApp application, String user)
specifier|public
specifier|synchronized
name|void
name|removeApplication
parameter_list|(
name|FiCaSchedulerApp
name|application
parameter_list|,
name|String
name|user
parameter_list|)
block|{
operator|--
name|numApplications
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Application removed -"
operator|+
literal|" appId: "
operator|+
name|application
operator|.
name|getApplicationId
argument_list|()
operator|+
literal|" user: "
operator|+
name|user
operator|+
literal|" leaf-queue of parent: "
operator|+
name|getQueueName
argument_list|()
operator|+
literal|" #applications: "
operator|+
name|getNumApplications
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|setUsedCapacity (float usedCapacity)
specifier|public
specifier|synchronized
name|void
name|setUsedCapacity
parameter_list|(
name|float
name|usedCapacity
parameter_list|)
block|{
name|this
operator|.
name|usedCapacity
operator|=
name|usedCapacity
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|setAbsoluteUsedCapacity (float absUsedCapacity)
specifier|public
specifier|synchronized
name|void
name|setAbsoluteUsedCapacity
parameter_list|(
name|float
name|absUsedCapacity
parameter_list|)
block|{
name|this
operator|.
name|absoluteUsedCapacity
operator|=
name|absUsedCapacity
expr_stmt|;
block|}
comment|/**    * Set maximum capacity - used only for testing.    * @param maximumCapacity new max capacity    */
DECL|method|setMaxCapacity (float maximumCapacity)
specifier|synchronized
name|void
name|setMaxCapacity
parameter_list|(
name|float
name|maximumCapacity
parameter_list|)
block|{
comment|// Sanity check
name|CSQueueUtils
operator|.
name|checkMaxCapacity
argument_list|(
name|getQueueName
argument_list|()
argument_list|,
name|capacity
argument_list|,
name|maximumCapacity
argument_list|)
expr_stmt|;
name|float
name|absMaxCapacity
init|=
name|CSQueueUtils
operator|.
name|computeAbsoluteMaximumCapacity
argument_list|(
name|maximumCapacity
argument_list|,
name|parent
argument_list|)
decl_stmt|;
name|CSQueueUtils
operator|.
name|checkAbsoluteCapacities
argument_list|(
name|getQueueName
argument_list|()
argument_list|,
name|absoluteCapacity
argument_list|,
name|absMaxCapacity
argument_list|)
expr_stmt|;
name|this
operator|.
name|maximumCapacity
operator|=
name|maximumCapacity
expr_stmt|;
name|this
operator|.
name|absoluteMaxCapacity
operator|=
name|absMaxCapacity
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|assignContainers ( Resource clusterResource, FiCaSchedulerNode node)
specifier|public
specifier|synchronized
name|CSAssignment
name|assignContainers
parameter_list|(
name|Resource
name|clusterResource
parameter_list|,
name|FiCaSchedulerNode
name|node
parameter_list|)
block|{
name|CSAssignment
name|assignment
init|=
operator|new
name|CSAssignment
argument_list|(
name|Resources
operator|.
name|createResource
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NodeType
operator|.
name|NODE_LOCAL
argument_list|)
decl_stmt|;
while|while
condition|(
name|canAssign
argument_list|(
name|clusterResource
argument_list|,
name|node
argument_list|)
condition|)
block|{
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Trying to assign containers to child-queue of "
operator|+
name|getQueueName
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|// Are we over maximum-capacity for this queue?
if|if
condition|(
operator|!
name|assignToQueue
argument_list|(
name|clusterResource
argument_list|)
condition|)
block|{
break|break;
block|}
comment|// Schedule
name|CSAssignment
name|assignedToChild
init|=
name|assignContainersToChildQueues
argument_list|(
name|clusterResource
argument_list|,
name|node
argument_list|)
decl_stmt|;
name|assignment
operator|.
name|setType
argument_list|(
name|assignedToChild
operator|.
name|getType
argument_list|()
argument_list|)
expr_stmt|;
comment|// Done if no child-queue assigned anything
if|if
condition|(
name|Resources
operator|.
name|greaterThan
argument_list|(
name|resourceCalculator
argument_list|,
name|clusterResource
argument_list|,
name|assignedToChild
operator|.
name|getResource
argument_list|()
argument_list|,
name|Resources
operator|.
name|none
argument_list|()
argument_list|)
condition|)
block|{
comment|// Track resource utilization for the parent-queue
name|allocateResource
argument_list|(
name|clusterResource
argument_list|,
name|assignedToChild
operator|.
name|getResource
argument_list|()
argument_list|)
expr_stmt|;
comment|// Track resource utilization in this pass of the scheduler
name|Resources
operator|.
name|addTo
argument_list|(
name|assignment
operator|.
name|getResource
argument_list|()
argument_list|,
name|assignedToChild
operator|.
name|getResource
argument_list|()
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"assignedContainer"
operator|+
literal|" queue="
operator|+
name|getQueueName
argument_list|()
operator|+
literal|" usedCapacity="
operator|+
name|getUsedCapacity
argument_list|()
operator|+
literal|" absoluteUsedCapacity="
operator|+
name|getAbsoluteUsedCapacity
argument_list|()
operator|+
literal|" used="
operator|+
name|usedResources
operator|+
literal|" cluster="
operator|+
name|clusterResource
argument_list|)
expr_stmt|;
block|}
else|else
block|{
break|break;
block|}
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"ParentQ="
operator|+
name|getQueueName
argument_list|()
operator|+
literal|" assignedSoFarInThisIteration="
operator|+
name|assignment
operator|.
name|getResource
argument_list|()
operator|+
literal|" usedCapacity="
operator|+
name|getUsedCapacity
argument_list|()
operator|+
literal|" absoluteUsedCapacity="
operator|+
name|getAbsoluteUsedCapacity
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|// Do not assign more than one container if this isn't the root queue
comment|// or if we've already assigned an off-switch container
if|if
condition|(
operator|!
name|rootQueue
operator|||
name|assignment
operator|.
name|getType
argument_list|()
operator|==
name|NodeType
operator|.
name|OFF_SWITCH
condition|)
block|{
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
if|if
condition|(
name|rootQueue
operator|&&
name|assignment
operator|.
name|getType
argument_list|()
operator|==
name|NodeType
operator|.
name|OFF_SWITCH
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Not assigning more than one off-switch container,"
operator|+
literal|" assignments so far: "
operator|+
name|assignment
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
block|}
block|}
return|return
name|assignment
return|;
block|}
DECL|method|assignToQueue (Resource clusterResource)
specifier|private
specifier|synchronized
name|boolean
name|assignToQueue
parameter_list|(
name|Resource
name|clusterResource
parameter_list|)
block|{
comment|// Check how of the cluster's absolute capacity we are currently using...
name|float
name|currentCapacity
init|=
name|Resources
operator|.
name|divide
argument_list|(
name|resourceCalculator
argument_list|,
name|clusterResource
argument_list|,
name|usedResources
argument_list|,
name|clusterResource
argument_list|)
decl_stmt|;
if|if
condition|(
name|currentCapacity
operator|>=
name|absoluteMaxCapacity
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
name|getQueueName
argument_list|()
operator|+
literal|" used="
operator|+
name|usedResources
operator|+
literal|" current-capacity ("
operator|+
name|currentCapacity
operator|+
literal|") "
operator|+
literal|">= max-capacity ("
operator|+
name|absoluteMaxCapacity
operator|+
literal|")"
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
return|return
literal|true
return|;
block|}
DECL|method|canAssign (Resource clusterResource, FiCaSchedulerNode node)
specifier|private
name|boolean
name|canAssign
parameter_list|(
name|Resource
name|clusterResource
parameter_list|,
name|FiCaSchedulerNode
name|node
parameter_list|)
block|{
return|return
operator|(
name|node
operator|.
name|getReservedContainer
argument_list|()
operator|==
literal|null
operator|)
operator|&&
name|Resources
operator|.
name|greaterThanOrEqual
argument_list|(
name|resourceCalculator
argument_list|,
name|clusterResource
argument_list|,
name|node
operator|.
name|getAvailableResource
argument_list|()
argument_list|,
name|minimumAllocation
argument_list|)
return|;
block|}
DECL|method|assignContainersToChildQueues (Resource cluster, FiCaSchedulerNode node)
specifier|synchronized
name|CSAssignment
name|assignContainersToChildQueues
parameter_list|(
name|Resource
name|cluster
parameter_list|,
name|FiCaSchedulerNode
name|node
parameter_list|)
block|{
name|CSAssignment
name|assignment
init|=
operator|new
name|CSAssignment
argument_list|(
name|Resources
operator|.
name|createResource
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NodeType
operator|.
name|NODE_LOCAL
argument_list|)
decl_stmt|;
name|printChildQueues
argument_list|()
expr_stmt|;
comment|// Try to assign to most 'under-served' sub-queue
for|for
control|(
name|Iterator
argument_list|<
name|CSQueue
argument_list|>
name|iter
init|=
name|childQueues
operator|.
name|iterator
argument_list|()
init|;
name|iter
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|CSQueue
name|childQueue
init|=
name|iter
operator|.
name|next
argument_list|()
decl_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Trying to assign to queue: "
operator|+
name|childQueue
operator|.
name|getQueuePath
argument_list|()
operator|+
literal|" stats: "
operator|+
name|childQueue
argument_list|)
expr_stmt|;
block|}
name|assignment
operator|=
name|childQueue
operator|.
name|assignContainers
argument_list|(
name|cluster
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Assigned to queue: "
operator|+
name|childQueue
operator|.
name|getQueuePath
argument_list|()
operator|+
literal|" stats: "
operator|+
name|childQueue
operator|+
literal|" --> "
operator|+
name|assignment
operator|.
name|getResource
argument_list|()
operator|+
literal|", "
operator|+
name|assignment
operator|.
name|getType
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|// If we do assign, remove the queue and re-insert in-order to re-sort
if|if
condition|(
name|Resources
operator|.
name|greaterThan
argument_list|(
name|resourceCalculator
argument_list|,
name|cluster
argument_list|,
name|assignment
operator|.
name|getResource
argument_list|()
argument_list|,
name|Resources
operator|.
name|none
argument_list|()
argument_list|)
condition|)
block|{
comment|// Remove and re-insert to sort
name|iter
operator|.
name|remove
argument_list|()
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Re-sorting assigned queue: "
operator|+
name|childQueue
operator|.
name|getQueuePath
argument_list|()
operator|+
literal|" stats: "
operator|+
name|childQueue
argument_list|)
expr_stmt|;
name|childQueues
operator|.
name|add
argument_list|(
name|childQueue
argument_list|)
expr_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|printChildQueues
argument_list|()
expr_stmt|;
block|}
break|break;
block|}
block|}
return|return
name|assignment
return|;
block|}
DECL|method|getChildQueuesToPrint ()
name|String
name|getChildQueuesToPrint
parameter_list|()
block|{
name|StringBuilder
name|sb
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
for|for
control|(
name|CSQueue
name|q
range|:
name|childQueues
control|)
block|{
name|sb
operator|.
name|append
argument_list|(
name|q
operator|.
name|getQueuePath
argument_list|()
operator|+
literal|"("
operator|+
name|q
operator|.
name|getUsedCapacity
argument_list|()
operator|+
literal|"), "
argument_list|)
expr_stmt|;
block|}
return|return
name|sb
operator|.
name|toString
argument_list|()
return|;
block|}
DECL|method|printChildQueues ()
name|void
name|printChildQueues
parameter_list|()
block|{
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"printChildQueues - queue: "
operator|+
name|getQueuePath
argument_list|()
operator|+
literal|" child-queues: "
operator|+
name|getChildQueuesToPrint
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|completedContainer (Resource clusterResource, FiCaSchedulerApp application, FiCaSchedulerNode node, RMContainer rmContainer, ContainerStatus containerStatus, RMContainerEventType event, CSQueue completedChildQueue)
specifier|public
name|void
name|completedContainer
parameter_list|(
name|Resource
name|clusterResource
parameter_list|,
name|FiCaSchedulerApp
name|application
parameter_list|,
name|FiCaSchedulerNode
name|node
parameter_list|,
name|RMContainer
name|rmContainer
parameter_list|,
name|ContainerStatus
name|containerStatus
parameter_list|,
name|RMContainerEventType
name|event
parameter_list|,
name|CSQueue
name|completedChildQueue
parameter_list|)
block|{
if|if
condition|(
name|application
operator|!=
literal|null
condition|)
block|{
comment|// Careful! Locking order is important!
comment|// Book keeping
synchronized|synchronized
init|(
name|this
init|)
block|{
name|releaseResource
argument_list|(
name|clusterResource
argument_list|,
name|rmContainer
operator|.
name|getContainer
argument_list|()
operator|.
name|getResource
argument_list|()
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"completedContainer"
operator|+
literal|" queue="
operator|+
name|getQueueName
argument_list|()
operator|+
literal|" usedCapacity="
operator|+
name|getUsedCapacity
argument_list|()
operator|+
literal|" absoluteUsedCapacity="
operator|+
name|getAbsoluteUsedCapacity
argument_list|()
operator|+
literal|" used="
operator|+
name|usedResources
operator|+
literal|" cluster="
operator|+
name|clusterResource
argument_list|)
expr_stmt|;
block|}
comment|// reinsert the updated queue
for|for
control|(
name|Iterator
argument_list|<
name|CSQueue
argument_list|>
name|iter
init|=
name|childQueues
operator|.
name|iterator
argument_list|()
init|;
name|iter
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|CSQueue
name|csqueue
init|=
name|iter
operator|.
name|next
argument_list|()
decl_stmt|;
if|if
condition|(
name|csqueue
operator|.
name|equals
argument_list|(
name|completedChildQueue
argument_list|)
condition|)
block|{
name|iter
operator|.
name|remove
argument_list|()
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Re-sorting completed queue: "
operator|+
name|csqueue
operator|.
name|getQueuePath
argument_list|()
operator|+
literal|" stats: "
operator|+
name|csqueue
argument_list|)
expr_stmt|;
name|childQueues
operator|.
name|add
argument_list|(
name|csqueue
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|// Inform the parent
if|if
condition|(
name|parent
operator|!=
literal|null
condition|)
block|{
comment|// complete my parent
name|parent
operator|.
name|completedContainer
argument_list|(
name|clusterResource
argument_list|,
name|application
argument_list|,
name|node
argument_list|,
name|rmContainer
argument_list|,
literal|null
argument_list|,
name|event
argument_list|,
name|this
argument_list|)
expr_stmt|;
block|}
block|}
block|}
DECL|method|allocateResource (Resource clusterResource, Resource resource)
specifier|synchronized
name|void
name|allocateResource
parameter_list|(
name|Resource
name|clusterResource
parameter_list|,
name|Resource
name|resource
parameter_list|)
block|{
name|Resources
operator|.
name|addTo
argument_list|(
name|usedResources
argument_list|,
name|resource
argument_list|)
expr_stmt|;
name|CSQueueUtils
operator|.
name|updateQueueStatistics
argument_list|(
name|resourceCalculator
argument_list|,
name|this
argument_list|,
name|parent
argument_list|,
name|clusterResource
argument_list|,
name|minimumAllocation
argument_list|)
expr_stmt|;
operator|++
name|numContainers
expr_stmt|;
block|}
DECL|method|releaseResource (Resource clusterResource, Resource resource)
specifier|synchronized
name|void
name|releaseResource
parameter_list|(
name|Resource
name|clusterResource
parameter_list|,
name|Resource
name|resource
parameter_list|)
block|{
name|Resources
operator|.
name|subtractFrom
argument_list|(
name|usedResources
argument_list|,
name|resource
argument_list|)
expr_stmt|;
name|CSQueueUtils
operator|.
name|updateQueueStatistics
argument_list|(
name|resourceCalculator
argument_list|,
name|this
argument_list|,
name|parent
argument_list|,
name|clusterResource
argument_list|,
name|minimumAllocation
argument_list|)
expr_stmt|;
operator|--
name|numContainers
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|updateClusterResource (Resource clusterResource)
specifier|public
specifier|synchronized
name|void
name|updateClusterResource
parameter_list|(
name|Resource
name|clusterResource
parameter_list|)
block|{
comment|// Update all children
for|for
control|(
name|CSQueue
name|childQueue
range|:
name|childQueues
control|)
block|{
name|childQueue
operator|.
name|updateClusterResource
argument_list|(
name|clusterResource
argument_list|)
expr_stmt|;
block|}
comment|// Update metrics
name|CSQueueUtils
operator|.
name|updateQueueStatistics
argument_list|(
name|resourceCalculator
argument_list|,
name|this
argument_list|,
name|parent
argument_list|,
name|clusterResource
argument_list|,
name|minimumAllocation
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|getMetrics ()
specifier|public
name|QueueMetrics
name|getMetrics
parameter_list|()
block|{
return|return
name|metrics
return|;
block|}
annotation|@
name|Override
DECL|method|recoverContainer (Resource clusterResource, FiCaSchedulerApp application, Container container)
specifier|public
name|void
name|recoverContainer
parameter_list|(
name|Resource
name|clusterResource
parameter_list|,
name|FiCaSchedulerApp
name|application
parameter_list|,
name|Container
name|container
parameter_list|)
block|{
comment|// Careful! Locking order is important!
synchronized|synchronized
init|(
name|this
init|)
block|{
name|allocateResource
argument_list|(
name|clusterResource
argument_list|,
name|container
operator|.
name|getResource
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|parent
operator|!=
literal|null
condition|)
block|{
name|parent
operator|.
name|recoverContainer
argument_list|(
name|clusterResource
argument_list|,
name|application
argument_list|,
name|container
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_class

end_unit

