begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/**  * Licensed to the Apache Software Foundation (ASF) under one  * or more contributor license agreements.  See the NOTICE file  * distributed with this work for additional information  * regarding copyright ownership.  The ASF licenses this file  * to you under the Apache License, Version 2.0 (the  * "License"); you may not use this file except in compliance  * with the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
DECL|package|org.apache.hadoop.yarn.server.resourcemanager.scheduler
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|scheduler
package|;
end_package

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|metrics2
operator|.
name|lib
operator|.
name|Interns
operator|.
name|info
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|classification
operator|.
name|InterfaceAudience
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|classification
operator|.
name|InterfaceAudience
operator|.
name|Private
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|conf
operator|.
name|Configuration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|metrics2
operator|.
name|MetricsCollector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|metrics2
operator|.
name|MetricsInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|metrics2
operator|.
name|MetricsSource
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|metrics2
operator|.
name|MetricsSystem
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|metrics2
operator|.
name|annotation
operator|.
name|Metric
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|metrics2
operator|.
name|annotation
operator|.
name|Metrics
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|metrics2
operator|.
name|lib
operator|.
name|DefaultMetricsSystem
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|metrics2
operator|.
name|lib
operator|.
name|MetricsRegistry
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|metrics2
operator|.
name|lib
operator|.
name|MutableCounterInt
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|metrics2
operator|.
name|lib
operator|.
name|MutableCounterLong
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|metrics2
operator|.
name|lib
operator|.
name|MutableGaugeInt
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|ApplicationId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|Resource
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|conf
operator|.
name|YarnConfiguration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|rmapp
operator|.
name|RMAppState
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|utils
operator|.
name|BuilderUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|util
operator|.
name|resource
operator|.
name|Resources
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|Logger
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|LoggerFactory
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|base
operator|.
name|Splitter
import|;
end_import

begin_class
annotation|@
name|InterfaceAudience
operator|.
name|Private
annotation|@
name|Metrics
argument_list|(
name|context
operator|=
literal|"yarn"
argument_list|)
DECL|class|QueueMetrics
specifier|public
class|class
name|QueueMetrics
implements|implements
name|MetricsSource
block|{
DECL|field|appsSubmitted
annotation|@
name|Metric
argument_list|(
literal|"# of apps submitted"
argument_list|)
name|MutableCounterInt
name|appsSubmitted
decl_stmt|;
DECL|field|appsRunning
annotation|@
name|Metric
argument_list|(
literal|"# of running apps"
argument_list|)
name|MutableGaugeInt
name|appsRunning
decl_stmt|;
DECL|field|appsPending
annotation|@
name|Metric
argument_list|(
literal|"# of pending apps"
argument_list|)
name|MutableGaugeInt
name|appsPending
decl_stmt|;
DECL|field|appsCompleted
annotation|@
name|Metric
argument_list|(
literal|"# of apps completed"
argument_list|)
name|MutableCounterInt
name|appsCompleted
decl_stmt|;
DECL|field|appsKilled
annotation|@
name|Metric
argument_list|(
literal|"# of apps killed"
argument_list|)
name|MutableCounterInt
name|appsKilled
decl_stmt|;
DECL|field|appsFailed
annotation|@
name|Metric
argument_list|(
literal|"# of apps failed"
argument_list|)
name|MutableCounterInt
name|appsFailed
decl_stmt|;
DECL|field|allocatedMB
annotation|@
name|Metric
argument_list|(
literal|"Allocated memory in MB"
argument_list|)
name|MutableGaugeInt
name|allocatedMB
decl_stmt|;
DECL|field|allocatedVCores
annotation|@
name|Metric
argument_list|(
literal|"Allocated CPU in virtual cores"
argument_list|)
name|MutableGaugeInt
name|allocatedVCores
decl_stmt|;
DECL|field|allocatedContainers
annotation|@
name|Metric
argument_list|(
literal|"# of allocated containers"
argument_list|)
name|MutableGaugeInt
name|allocatedContainers
decl_stmt|;
DECL|field|aggregateContainersAllocated
annotation|@
name|Metric
argument_list|(
literal|"Aggregate # of allocated containers"
argument_list|)
name|MutableCounterLong
name|aggregateContainersAllocated
decl_stmt|;
DECL|field|aggregateContainersReleased
annotation|@
name|Metric
argument_list|(
literal|"Aggregate # of released containers"
argument_list|)
name|MutableCounterLong
name|aggregateContainersReleased
decl_stmt|;
DECL|field|availableMB
annotation|@
name|Metric
argument_list|(
literal|"Available memory in MB"
argument_list|)
name|MutableGaugeInt
name|availableMB
decl_stmt|;
DECL|field|availableVCores
annotation|@
name|Metric
argument_list|(
literal|"Available CPU in virtual cores"
argument_list|)
name|MutableGaugeInt
name|availableVCores
decl_stmt|;
DECL|field|pendingMB
annotation|@
name|Metric
argument_list|(
literal|"Pending memory allocation in MB"
argument_list|)
name|MutableGaugeInt
name|pendingMB
decl_stmt|;
DECL|field|pendingVCores
annotation|@
name|Metric
argument_list|(
literal|"Pending CPU allocation in virtual cores"
argument_list|)
name|MutableGaugeInt
name|pendingVCores
decl_stmt|;
DECL|field|pendingContainers
annotation|@
name|Metric
argument_list|(
literal|"# of pending containers"
argument_list|)
name|MutableGaugeInt
name|pendingContainers
decl_stmt|;
DECL|field|reservedMB
annotation|@
name|Metric
argument_list|(
literal|"# of reserved memory in MB"
argument_list|)
name|MutableGaugeInt
name|reservedMB
decl_stmt|;
DECL|field|reservedVCores
annotation|@
name|Metric
argument_list|(
literal|"Reserved CPU in virtual cores"
argument_list|)
name|MutableGaugeInt
name|reservedVCores
decl_stmt|;
DECL|field|reservedContainers
annotation|@
name|Metric
argument_list|(
literal|"# of reserved containers"
argument_list|)
name|MutableGaugeInt
name|reservedContainers
decl_stmt|;
DECL|field|activeUsers
annotation|@
name|Metric
argument_list|(
literal|"# of active users"
argument_list|)
name|MutableGaugeInt
name|activeUsers
decl_stmt|;
DECL|field|activeApplications
annotation|@
name|Metric
argument_list|(
literal|"# of active applications"
argument_list|)
name|MutableGaugeInt
name|activeApplications
decl_stmt|;
DECL|field|runningTime
specifier|private
specifier|final
name|MutableGaugeInt
index|[]
name|runningTime
decl_stmt|;
DECL|field|runBuckets
specifier|private
name|TimeBucketMetrics
argument_list|<
name|ApplicationId
argument_list|>
name|runBuckets
decl_stmt|;
DECL|field|LOG
specifier|static
specifier|final
name|Logger
name|LOG
init|=
name|LoggerFactory
operator|.
name|getLogger
argument_list|(
name|QueueMetrics
operator|.
name|class
argument_list|)
decl_stmt|;
DECL|field|RECORD_INFO
specifier|static
specifier|final
name|MetricsInfo
name|RECORD_INFO
init|=
name|info
argument_list|(
literal|"QueueMetrics"
argument_list|,
literal|"Metrics for the resource scheduler"
argument_list|)
decl_stmt|;
DECL|field|QUEUE_INFO
specifier|protected
specifier|static
specifier|final
name|MetricsInfo
name|QUEUE_INFO
init|=
name|info
argument_list|(
literal|"Queue"
argument_list|,
literal|"Metrics by queue"
argument_list|)
decl_stmt|;
DECL|field|USER_INFO
specifier|static
specifier|final
name|MetricsInfo
name|USER_INFO
init|=
name|info
argument_list|(
literal|"User"
argument_list|,
literal|"Metrics by user"
argument_list|)
decl_stmt|;
DECL|field|Q_SPLITTER
specifier|static
specifier|final
name|Splitter
name|Q_SPLITTER
init|=
name|Splitter
operator|.
name|on
argument_list|(
literal|'.'
argument_list|)
operator|.
name|omitEmptyStrings
argument_list|()
operator|.
name|trimResults
argument_list|()
decl_stmt|;
DECL|field|registry
specifier|final
name|MetricsRegistry
name|registry
decl_stmt|;
DECL|field|queueName
specifier|final
name|String
name|queueName
decl_stmt|;
DECL|field|parent
specifier|final
name|QueueMetrics
name|parent
decl_stmt|;
DECL|field|metricsSystem
specifier|final
name|MetricsSystem
name|metricsSystem
decl_stmt|;
DECL|field|users
specifier|private
specifier|final
name|Map
argument_list|<
name|String
argument_list|,
name|QueueMetrics
argument_list|>
name|users
decl_stmt|;
DECL|field|conf
specifier|private
specifier|final
name|Configuration
name|conf
decl_stmt|;
DECL|method|QueueMetrics (MetricsSystem ms, String queueName, Queue parent, boolean enableUserMetrics, Configuration conf)
specifier|protected
name|QueueMetrics
parameter_list|(
name|MetricsSystem
name|ms
parameter_list|,
name|String
name|queueName
parameter_list|,
name|Queue
name|parent
parameter_list|,
name|boolean
name|enableUserMetrics
parameter_list|,
name|Configuration
name|conf
parameter_list|)
block|{
name|registry
operator|=
operator|new
name|MetricsRegistry
argument_list|(
name|RECORD_INFO
argument_list|)
expr_stmt|;
name|this
operator|.
name|queueName
operator|=
name|queueName
expr_stmt|;
name|this
operator|.
name|parent
operator|=
name|parent
operator|!=
literal|null
condition|?
name|parent
operator|.
name|getMetrics
argument_list|()
else|:
literal|null
expr_stmt|;
name|this
operator|.
name|users
operator|=
name|enableUserMetrics
condition|?
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|QueueMetrics
argument_list|>
argument_list|()
else|:
literal|null
expr_stmt|;
name|metricsSystem
operator|=
name|ms
expr_stmt|;
name|this
operator|.
name|conf
operator|=
name|conf
expr_stmt|;
name|runningTime
operator|=
name|buildBuckets
argument_list|(
name|conf
argument_list|)
expr_stmt|;
block|}
DECL|method|tag (MetricsInfo info, String value)
specifier|protected
name|QueueMetrics
name|tag
parameter_list|(
name|MetricsInfo
name|info
parameter_list|,
name|String
name|value
parameter_list|)
block|{
name|registry
operator|.
name|tag
argument_list|(
name|info
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
name|this
return|;
block|}
DECL|method|sourceName (String queueName)
specifier|protected
specifier|static
name|StringBuilder
name|sourceName
parameter_list|(
name|String
name|queueName
parameter_list|)
block|{
name|StringBuilder
name|sb
init|=
operator|new
name|StringBuilder
argument_list|(
name|RECORD_INFO
operator|.
name|name
argument_list|()
argument_list|)
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
for|for
control|(
name|String
name|node
range|:
name|Q_SPLITTER
operator|.
name|split
argument_list|(
name|queueName
argument_list|)
control|)
block|{
name|sb
operator|.
name|append
argument_list|(
literal|",q"
argument_list|)
operator|.
name|append
argument_list|(
name|i
operator|++
argument_list|)
operator|.
name|append
argument_list|(
literal|'='
argument_list|)
operator|.
name|append
argument_list|(
name|node
argument_list|)
expr_stmt|;
block|}
return|return
name|sb
return|;
block|}
specifier|public
specifier|synchronized
DECL|method|forQueue (String queueName, Queue parent, boolean enableUserMetrics, Configuration conf)
specifier|static
name|QueueMetrics
name|forQueue
parameter_list|(
name|String
name|queueName
parameter_list|,
name|Queue
name|parent
parameter_list|,
name|boolean
name|enableUserMetrics
parameter_list|,
name|Configuration
name|conf
parameter_list|)
block|{
return|return
name|forQueue
argument_list|(
name|DefaultMetricsSystem
operator|.
name|instance
argument_list|()
argument_list|,
name|queueName
argument_list|,
name|parent
argument_list|,
name|enableUserMetrics
argument_list|,
name|conf
argument_list|)
return|;
block|}
comment|/**    * Helper method to clear cache - used only for unit tests.    */
annotation|@
name|Private
DECL|method|clearQueueMetrics ()
specifier|public
specifier|synchronized
specifier|static
name|void
name|clearQueueMetrics
parameter_list|()
block|{
name|queueMetrics
operator|.
name|clear
argument_list|()
expr_stmt|;
block|}
comment|/**    * Simple metrics cache to help prevent re-registrations.    */
DECL|field|queueMetrics
specifier|protected
specifier|final
specifier|static
name|Map
argument_list|<
name|String
argument_list|,
name|QueueMetrics
argument_list|>
name|queueMetrics
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|QueueMetrics
argument_list|>
argument_list|()
decl_stmt|;
specifier|public
specifier|synchronized
DECL|method|forQueue (MetricsSystem ms, String queueName, Queue parent, boolean enableUserMetrics, Configuration conf)
specifier|static
name|QueueMetrics
name|forQueue
parameter_list|(
name|MetricsSystem
name|ms
parameter_list|,
name|String
name|queueName
parameter_list|,
name|Queue
name|parent
parameter_list|,
name|boolean
name|enableUserMetrics
parameter_list|,
name|Configuration
name|conf
parameter_list|)
block|{
name|QueueMetrics
name|metrics
init|=
name|queueMetrics
operator|.
name|get
argument_list|(
name|queueName
argument_list|)
decl_stmt|;
if|if
condition|(
name|metrics
operator|==
literal|null
condition|)
block|{
name|metrics
operator|=
operator|new
name|QueueMetrics
argument_list|(
name|ms
argument_list|,
name|queueName
argument_list|,
name|parent
argument_list|,
name|enableUserMetrics
argument_list|,
name|conf
argument_list|)
operator|.
name|tag
argument_list|(
name|QUEUE_INFO
argument_list|,
name|queueName
argument_list|)
expr_stmt|;
comment|// Register with the MetricsSystems
if|if
condition|(
name|ms
operator|!=
literal|null
condition|)
block|{
name|metrics
operator|=
name|ms
operator|.
name|register
argument_list|(
name|sourceName
argument_list|(
name|queueName
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|,
literal|"Metrics for queue: "
operator|+
name|queueName
argument_list|,
name|metrics
argument_list|)
expr_stmt|;
block|}
name|queueMetrics
operator|.
name|put
argument_list|(
name|queueName
argument_list|,
name|metrics
argument_list|)
expr_stmt|;
block|}
return|return
name|metrics
return|;
block|}
DECL|method|getUserMetrics (String userName)
specifier|public
specifier|synchronized
name|QueueMetrics
name|getUserMetrics
parameter_list|(
name|String
name|userName
parameter_list|)
block|{
if|if
condition|(
name|users
operator|==
literal|null
condition|)
block|{
return|return
literal|null
return|;
block|}
name|QueueMetrics
name|metrics
init|=
name|users
operator|.
name|get
argument_list|(
name|userName
argument_list|)
decl_stmt|;
if|if
condition|(
name|metrics
operator|==
literal|null
condition|)
block|{
name|metrics
operator|=
operator|new
name|QueueMetrics
argument_list|(
name|metricsSystem
argument_list|,
name|queueName
argument_list|,
literal|null
argument_list|,
literal|false
argument_list|,
name|conf
argument_list|)
expr_stmt|;
name|users
operator|.
name|put
argument_list|(
name|userName
argument_list|,
name|metrics
argument_list|)
expr_stmt|;
name|metricsSystem
operator|.
name|register
argument_list|(
name|sourceName
argument_list|(
name|queueName
argument_list|)
operator|.
name|append
argument_list|(
literal|",user="
argument_list|)
operator|.
name|append
argument_list|(
name|userName
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|,
literal|"Metrics for user '"
operator|+
name|userName
operator|+
literal|"' in queue '"
operator|+
name|queueName
operator|+
literal|"'"
argument_list|,
name|metrics
operator|.
name|tag
argument_list|(
name|QUEUE_INFO
argument_list|,
name|queueName
argument_list|)
operator|.
name|tag
argument_list|(
name|USER_INFO
argument_list|,
name|userName
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|metrics
return|;
block|}
DECL|method|parseInts (String value)
specifier|private
name|ArrayList
argument_list|<
name|Integer
argument_list|>
name|parseInts
parameter_list|(
name|String
name|value
parameter_list|)
block|{
name|ArrayList
argument_list|<
name|Integer
argument_list|>
name|result
init|=
operator|new
name|ArrayList
argument_list|<
name|Integer
argument_list|>
argument_list|()
decl_stmt|;
for|for
control|(
name|String
name|s
range|:
name|value
operator|.
name|split
argument_list|(
literal|","
argument_list|)
control|)
block|{
name|result
operator|.
name|add
argument_list|(
name|Integer
operator|.
name|parseInt
argument_list|(
name|s
operator|.
name|trim
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|result
return|;
block|}
DECL|method|buildBuckets (Configuration conf)
specifier|private
name|MutableGaugeInt
index|[]
name|buildBuckets
parameter_list|(
name|Configuration
name|conf
parameter_list|)
block|{
name|ArrayList
argument_list|<
name|Integer
argument_list|>
name|buckets
init|=
name|parseInts
argument_list|(
name|conf
operator|.
name|get
argument_list|(
name|YarnConfiguration
operator|.
name|RM_METRICS_RUNTIME_BUCKETS
argument_list|,
name|YarnConfiguration
operator|.
name|DEFAULT_RM_METRICS_RUNTIME_BUCKETS
argument_list|)
argument_list|)
decl_stmt|;
name|MutableGaugeInt
index|[]
name|result
init|=
operator|new
name|MutableGaugeInt
index|[
name|buckets
operator|.
name|size
argument_list|()
operator|+
literal|1
index|]
decl_stmt|;
name|result
index|[
literal|0
index|]
operator|=
name|registry
operator|.
name|newGauge
argument_list|(
literal|"running_0"
argument_list|,
literal|""
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|long
index|[]
name|cuts
init|=
operator|new
name|long
index|[
name|buckets
operator|.
name|size
argument_list|()
index|]
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|buckets
operator|.
name|size
argument_list|()
condition|;
operator|++
name|i
control|)
block|{
name|result
index|[
name|i
operator|+
literal|1
index|]
operator|=
name|registry
operator|.
name|newGauge
argument_list|(
literal|"running_"
operator|+
name|buckets
operator|.
name|get
argument_list|(
name|i
argument_list|)
argument_list|,
literal|""
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cuts
index|[
name|i
index|]
operator|=
name|buckets
operator|.
name|get
argument_list|(
name|i
argument_list|)
operator|*
literal|1000L
operator|*
literal|60
expr_stmt|;
comment|// covert from min to ms
block|}
name|this
operator|.
name|runBuckets
operator|=
operator|new
name|TimeBucketMetrics
argument_list|<
name|ApplicationId
argument_list|>
argument_list|(
name|cuts
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
DECL|method|updateRunningTime ()
specifier|private
name|void
name|updateRunningTime
parameter_list|()
block|{
name|int
index|[]
name|counts
init|=
name|runBuckets
operator|.
name|getBucketCounts
argument_list|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|counts
operator|.
name|length
condition|;
operator|++
name|i
control|)
block|{
name|runningTime
index|[
name|i
index|]
operator|.
name|set
argument_list|(
name|counts
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|getMetrics (MetricsCollector collector, boolean all)
specifier|public
name|void
name|getMetrics
parameter_list|(
name|MetricsCollector
name|collector
parameter_list|,
name|boolean
name|all
parameter_list|)
block|{
name|updateRunningTime
argument_list|()
expr_stmt|;
name|registry
operator|.
name|snapshot
argument_list|(
name|collector
operator|.
name|addRecord
argument_list|(
name|registry
operator|.
name|info
argument_list|()
argument_list|)
argument_list|,
name|all
argument_list|)
expr_stmt|;
block|}
DECL|method|submitApp (String user)
specifier|public
name|void
name|submitApp
parameter_list|(
name|String
name|user
parameter_list|)
block|{
name|appsSubmitted
operator|.
name|incr
argument_list|()
expr_stmt|;
name|QueueMetrics
name|userMetrics
init|=
name|getUserMetrics
argument_list|(
name|user
argument_list|)
decl_stmt|;
if|if
condition|(
name|userMetrics
operator|!=
literal|null
condition|)
block|{
name|userMetrics
operator|.
name|submitApp
argument_list|(
name|user
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|parent
operator|!=
literal|null
condition|)
block|{
name|parent
operator|.
name|submitApp
argument_list|(
name|user
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|submitAppAttempt (String user)
specifier|public
name|void
name|submitAppAttempt
parameter_list|(
name|String
name|user
parameter_list|)
block|{
name|appsPending
operator|.
name|incr
argument_list|()
expr_stmt|;
name|QueueMetrics
name|userMetrics
init|=
name|getUserMetrics
argument_list|(
name|user
argument_list|)
decl_stmt|;
if|if
condition|(
name|userMetrics
operator|!=
literal|null
condition|)
block|{
name|userMetrics
operator|.
name|submitAppAttempt
argument_list|(
name|user
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|parent
operator|!=
literal|null
condition|)
block|{
name|parent
operator|.
name|submitAppAttempt
argument_list|(
name|user
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|runAppAttempt (ApplicationId appId, String user)
specifier|public
name|void
name|runAppAttempt
parameter_list|(
name|ApplicationId
name|appId
parameter_list|,
name|String
name|user
parameter_list|)
block|{
name|runBuckets
operator|.
name|add
argument_list|(
name|appId
argument_list|,
name|System
operator|.
name|currentTimeMillis
argument_list|()
argument_list|)
expr_stmt|;
name|appsRunning
operator|.
name|incr
argument_list|()
expr_stmt|;
name|appsPending
operator|.
name|decr
argument_list|()
expr_stmt|;
name|QueueMetrics
name|userMetrics
init|=
name|getUserMetrics
argument_list|(
name|user
argument_list|)
decl_stmt|;
if|if
condition|(
name|userMetrics
operator|!=
literal|null
condition|)
block|{
name|userMetrics
operator|.
name|runAppAttempt
argument_list|(
name|appId
argument_list|,
name|user
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|parent
operator|!=
literal|null
condition|)
block|{
name|parent
operator|.
name|runAppAttempt
argument_list|(
name|appId
argument_list|,
name|user
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|finishAppAttempt ( ApplicationId appId, boolean isPending, String user)
specifier|public
name|void
name|finishAppAttempt
parameter_list|(
name|ApplicationId
name|appId
parameter_list|,
name|boolean
name|isPending
parameter_list|,
name|String
name|user
parameter_list|)
block|{
name|runBuckets
operator|.
name|remove
argument_list|(
name|appId
argument_list|)
expr_stmt|;
if|if
condition|(
name|isPending
condition|)
block|{
name|appsPending
operator|.
name|decr
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|appsRunning
operator|.
name|decr
argument_list|()
expr_stmt|;
block|}
name|QueueMetrics
name|userMetrics
init|=
name|getUserMetrics
argument_list|(
name|user
argument_list|)
decl_stmt|;
if|if
condition|(
name|userMetrics
operator|!=
literal|null
condition|)
block|{
name|userMetrics
operator|.
name|finishAppAttempt
argument_list|(
name|appId
argument_list|,
name|isPending
argument_list|,
name|user
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|parent
operator|!=
literal|null
condition|)
block|{
name|parent
operator|.
name|finishAppAttempt
argument_list|(
name|appId
argument_list|,
name|isPending
argument_list|,
name|user
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|finishApp (String user, RMAppState rmAppFinalState)
specifier|public
name|void
name|finishApp
parameter_list|(
name|String
name|user
parameter_list|,
name|RMAppState
name|rmAppFinalState
parameter_list|)
block|{
switch|switch
condition|(
name|rmAppFinalState
condition|)
block|{
case|case
name|KILLED
case|:
name|appsKilled
operator|.
name|incr
argument_list|()
expr_stmt|;
break|break;
case|case
name|FAILED
case|:
name|appsFailed
operator|.
name|incr
argument_list|()
expr_stmt|;
break|break;
default|default:
name|appsCompleted
operator|.
name|incr
argument_list|()
expr_stmt|;
break|break;
block|}
name|QueueMetrics
name|userMetrics
init|=
name|getUserMetrics
argument_list|(
name|user
argument_list|)
decl_stmt|;
if|if
condition|(
name|userMetrics
operator|!=
literal|null
condition|)
block|{
name|userMetrics
operator|.
name|finishApp
argument_list|(
name|user
argument_list|,
name|rmAppFinalState
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|parent
operator|!=
literal|null
condition|)
block|{
name|parent
operator|.
name|finishApp
argument_list|(
name|user
argument_list|,
name|rmAppFinalState
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**    * Set available resources. To be called by scheduler periodically as    * resources become available.    * @param limit resource limit    */
DECL|method|setAvailableResourcesToQueue (Resource limit)
specifier|public
name|void
name|setAvailableResourcesToQueue
parameter_list|(
name|Resource
name|limit
parameter_list|)
block|{
name|availableMB
operator|.
name|set
argument_list|(
name|limit
operator|.
name|getMemory
argument_list|()
argument_list|)
expr_stmt|;
name|availableVCores
operator|.
name|set
argument_list|(
name|limit
operator|.
name|getVirtualCores
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|/**    * Set available resources. To be called by scheduler periodically as    * resources become available.    * @param user    * @param limit resource limit    */
DECL|method|setAvailableResourcesToUser (String user, Resource limit)
specifier|public
name|void
name|setAvailableResourcesToUser
parameter_list|(
name|String
name|user
parameter_list|,
name|Resource
name|limit
parameter_list|)
block|{
name|QueueMetrics
name|userMetrics
init|=
name|getUserMetrics
argument_list|(
name|user
argument_list|)
decl_stmt|;
if|if
condition|(
name|userMetrics
operator|!=
literal|null
condition|)
block|{
name|userMetrics
operator|.
name|setAvailableResourcesToQueue
argument_list|(
name|limit
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**    * Increment pending resource metrics    * @param user    * @param containers    * @param res the TOTAL delta of resources note this is different from    *            the other APIs which use per container resource    */
DECL|method|incrPendingResources (String user, int containers, Resource res)
specifier|public
name|void
name|incrPendingResources
parameter_list|(
name|String
name|user
parameter_list|,
name|int
name|containers
parameter_list|,
name|Resource
name|res
parameter_list|)
block|{
name|_incrPendingResources
argument_list|(
name|containers
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|QueueMetrics
name|userMetrics
init|=
name|getUserMetrics
argument_list|(
name|user
argument_list|)
decl_stmt|;
if|if
condition|(
name|userMetrics
operator|!=
literal|null
condition|)
block|{
name|userMetrics
operator|.
name|incrPendingResources
argument_list|(
name|user
argument_list|,
name|containers
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|parent
operator|!=
literal|null
condition|)
block|{
name|parent
operator|.
name|incrPendingResources
argument_list|(
name|user
argument_list|,
name|containers
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|_incrPendingResources (int containers, Resource res)
specifier|private
name|void
name|_incrPendingResources
parameter_list|(
name|int
name|containers
parameter_list|,
name|Resource
name|res
parameter_list|)
block|{
name|pendingContainers
operator|.
name|incr
argument_list|(
name|containers
argument_list|)
expr_stmt|;
name|pendingMB
operator|.
name|incr
argument_list|(
name|res
operator|.
name|getMemory
argument_list|()
argument_list|)
expr_stmt|;
name|pendingVCores
operator|.
name|incr
argument_list|(
name|res
operator|.
name|getVirtualCores
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|decrPendingResources (String user, int containers, Resource res)
specifier|public
name|void
name|decrPendingResources
parameter_list|(
name|String
name|user
parameter_list|,
name|int
name|containers
parameter_list|,
name|Resource
name|res
parameter_list|)
block|{
name|_decrPendingResources
argument_list|(
name|containers
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|QueueMetrics
name|userMetrics
init|=
name|getUserMetrics
argument_list|(
name|user
argument_list|)
decl_stmt|;
if|if
condition|(
name|userMetrics
operator|!=
literal|null
condition|)
block|{
name|userMetrics
operator|.
name|decrPendingResources
argument_list|(
name|user
argument_list|,
name|containers
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|parent
operator|!=
literal|null
condition|)
block|{
name|parent
operator|.
name|decrPendingResources
argument_list|(
name|user
argument_list|,
name|containers
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|_decrPendingResources (int containers, Resource res)
specifier|private
name|void
name|_decrPendingResources
parameter_list|(
name|int
name|containers
parameter_list|,
name|Resource
name|res
parameter_list|)
block|{
name|pendingContainers
operator|.
name|decr
argument_list|(
name|containers
argument_list|)
expr_stmt|;
name|pendingMB
operator|.
name|decr
argument_list|(
name|res
operator|.
name|getMemory
argument_list|()
argument_list|)
expr_stmt|;
name|pendingVCores
operator|.
name|decr
argument_list|(
name|res
operator|.
name|getVirtualCores
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|allocateResources (String user, int containers, Resource res)
specifier|public
name|void
name|allocateResources
parameter_list|(
name|String
name|user
parameter_list|,
name|int
name|containers
parameter_list|,
name|Resource
name|res
parameter_list|)
block|{
name|allocatedContainers
operator|.
name|incr
argument_list|(
name|containers
argument_list|)
expr_stmt|;
name|aggregateContainersAllocated
operator|.
name|incr
argument_list|(
name|containers
argument_list|)
expr_stmt|;
name|allocatedMB
operator|.
name|incr
argument_list|(
name|res
operator|.
name|getMemory
argument_list|()
operator|*
name|containers
argument_list|)
expr_stmt|;
name|allocatedVCores
operator|.
name|incr
argument_list|(
name|res
operator|.
name|getVirtualCores
argument_list|()
operator|*
name|containers
argument_list|)
expr_stmt|;
name|_decrPendingResources
argument_list|(
name|containers
argument_list|,
name|Resources
operator|.
name|multiply
argument_list|(
name|res
argument_list|,
name|containers
argument_list|)
argument_list|)
expr_stmt|;
name|QueueMetrics
name|userMetrics
init|=
name|getUserMetrics
argument_list|(
name|user
argument_list|)
decl_stmt|;
if|if
condition|(
name|userMetrics
operator|!=
literal|null
condition|)
block|{
name|userMetrics
operator|.
name|allocateResources
argument_list|(
name|user
argument_list|,
name|containers
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|parent
operator|!=
literal|null
condition|)
block|{
name|parent
operator|.
name|allocateResources
argument_list|(
name|user
argument_list|,
name|containers
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|releaseResources (String user, int containers, Resource res)
specifier|public
name|void
name|releaseResources
parameter_list|(
name|String
name|user
parameter_list|,
name|int
name|containers
parameter_list|,
name|Resource
name|res
parameter_list|)
block|{
name|allocatedContainers
operator|.
name|decr
argument_list|(
name|containers
argument_list|)
expr_stmt|;
name|aggregateContainersReleased
operator|.
name|incr
argument_list|(
name|containers
argument_list|)
expr_stmt|;
name|allocatedMB
operator|.
name|decr
argument_list|(
name|res
operator|.
name|getMemory
argument_list|()
operator|*
name|containers
argument_list|)
expr_stmt|;
name|allocatedVCores
operator|.
name|decr
argument_list|(
name|res
operator|.
name|getVirtualCores
argument_list|()
operator|*
name|containers
argument_list|)
expr_stmt|;
name|QueueMetrics
name|userMetrics
init|=
name|getUserMetrics
argument_list|(
name|user
argument_list|)
decl_stmt|;
if|if
condition|(
name|userMetrics
operator|!=
literal|null
condition|)
block|{
name|userMetrics
operator|.
name|releaseResources
argument_list|(
name|user
argument_list|,
name|containers
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|parent
operator|!=
literal|null
condition|)
block|{
name|parent
operator|.
name|releaseResources
argument_list|(
name|user
argument_list|,
name|containers
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|reserveResource (String user, Resource res)
specifier|public
name|void
name|reserveResource
parameter_list|(
name|String
name|user
parameter_list|,
name|Resource
name|res
parameter_list|)
block|{
name|reservedContainers
operator|.
name|incr
argument_list|()
expr_stmt|;
name|reservedMB
operator|.
name|incr
argument_list|(
name|res
operator|.
name|getMemory
argument_list|()
argument_list|)
expr_stmt|;
name|reservedVCores
operator|.
name|incr
argument_list|(
name|res
operator|.
name|getVirtualCores
argument_list|()
argument_list|)
expr_stmt|;
name|QueueMetrics
name|userMetrics
init|=
name|getUserMetrics
argument_list|(
name|user
argument_list|)
decl_stmt|;
if|if
condition|(
name|userMetrics
operator|!=
literal|null
condition|)
block|{
name|userMetrics
operator|.
name|reserveResource
argument_list|(
name|user
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|parent
operator|!=
literal|null
condition|)
block|{
name|parent
operator|.
name|reserveResource
argument_list|(
name|user
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|unreserveResource (String user, Resource res)
specifier|public
name|void
name|unreserveResource
parameter_list|(
name|String
name|user
parameter_list|,
name|Resource
name|res
parameter_list|)
block|{
name|reservedContainers
operator|.
name|decr
argument_list|()
expr_stmt|;
name|reservedMB
operator|.
name|decr
argument_list|(
name|res
operator|.
name|getMemory
argument_list|()
argument_list|)
expr_stmt|;
name|reservedVCores
operator|.
name|decr
argument_list|(
name|res
operator|.
name|getVirtualCores
argument_list|()
argument_list|)
expr_stmt|;
name|QueueMetrics
name|userMetrics
init|=
name|getUserMetrics
argument_list|(
name|user
argument_list|)
decl_stmt|;
if|if
condition|(
name|userMetrics
operator|!=
literal|null
condition|)
block|{
name|userMetrics
operator|.
name|unreserveResource
argument_list|(
name|user
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|parent
operator|!=
literal|null
condition|)
block|{
name|parent
operator|.
name|unreserveResource
argument_list|(
name|user
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|incrActiveUsers ()
specifier|public
name|void
name|incrActiveUsers
parameter_list|()
block|{
name|activeUsers
operator|.
name|incr
argument_list|()
expr_stmt|;
block|}
DECL|method|decrActiveUsers ()
specifier|public
name|void
name|decrActiveUsers
parameter_list|()
block|{
name|activeUsers
operator|.
name|decr
argument_list|()
expr_stmt|;
block|}
DECL|method|activateApp (String user)
specifier|public
name|void
name|activateApp
parameter_list|(
name|String
name|user
parameter_list|)
block|{
name|activeApplications
operator|.
name|incr
argument_list|()
expr_stmt|;
name|QueueMetrics
name|userMetrics
init|=
name|getUserMetrics
argument_list|(
name|user
argument_list|)
decl_stmt|;
if|if
condition|(
name|userMetrics
operator|!=
literal|null
condition|)
block|{
name|userMetrics
operator|.
name|activateApp
argument_list|(
name|user
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|parent
operator|!=
literal|null
condition|)
block|{
name|parent
operator|.
name|activateApp
argument_list|(
name|user
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|deactivateApp (String user)
specifier|public
name|void
name|deactivateApp
parameter_list|(
name|String
name|user
parameter_list|)
block|{
name|activeApplications
operator|.
name|decr
argument_list|()
expr_stmt|;
name|QueueMetrics
name|userMetrics
init|=
name|getUserMetrics
argument_list|(
name|user
argument_list|)
decl_stmt|;
if|if
condition|(
name|userMetrics
operator|!=
literal|null
condition|)
block|{
name|userMetrics
operator|.
name|deactivateApp
argument_list|(
name|user
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|parent
operator|!=
literal|null
condition|)
block|{
name|parent
operator|.
name|deactivateApp
argument_list|(
name|user
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|getAppsSubmitted ()
specifier|public
name|int
name|getAppsSubmitted
parameter_list|()
block|{
return|return
name|appsSubmitted
operator|.
name|value
argument_list|()
return|;
block|}
DECL|method|getAppsRunning ()
specifier|public
name|int
name|getAppsRunning
parameter_list|()
block|{
return|return
name|appsRunning
operator|.
name|value
argument_list|()
return|;
block|}
DECL|method|getAppsPending ()
specifier|public
name|int
name|getAppsPending
parameter_list|()
block|{
return|return
name|appsPending
operator|.
name|value
argument_list|()
return|;
block|}
DECL|method|getAppsCompleted ()
specifier|public
name|int
name|getAppsCompleted
parameter_list|()
block|{
return|return
name|appsCompleted
operator|.
name|value
argument_list|()
return|;
block|}
DECL|method|getAppsKilled ()
specifier|public
name|int
name|getAppsKilled
parameter_list|()
block|{
return|return
name|appsKilled
operator|.
name|value
argument_list|()
return|;
block|}
DECL|method|getAppsFailed ()
specifier|public
name|int
name|getAppsFailed
parameter_list|()
block|{
return|return
name|appsFailed
operator|.
name|value
argument_list|()
return|;
block|}
DECL|method|getAllocatedResources ()
specifier|public
name|Resource
name|getAllocatedResources
parameter_list|()
block|{
return|return
name|BuilderUtils
operator|.
name|newResource
argument_list|(
name|allocatedMB
operator|.
name|value
argument_list|()
argument_list|,
name|allocatedVCores
operator|.
name|value
argument_list|()
argument_list|)
return|;
block|}
DECL|method|getAllocatedMB ()
specifier|public
name|int
name|getAllocatedMB
parameter_list|()
block|{
return|return
name|allocatedMB
operator|.
name|value
argument_list|()
return|;
block|}
DECL|method|getAllocatedVirtualCores ()
specifier|public
name|int
name|getAllocatedVirtualCores
parameter_list|()
block|{
return|return
name|allocatedVCores
operator|.
name|value
argument_list|()
return|;
block|}
DECL|method|getAllocatedContainers ()
specifier|public
name|int
name|getAllocatedContainers
parameter_list|()
block|{
return|return
name|allocatedContainers
operator|.
name|value
argument_list|()
return|;
block|}
DECL|method|getAvailableMB ()
specifier|public
name|int
name|getAvailableMB
parameter_list|()
block|{
return|return
name|availableMB
operator|.
name|value
argument_list|()
return|;
block|}
DECL|method|getAvailableVirtualCores ()
specifier|public
name|int
name|getAvailableVirtualCores
parameter_list|()
block|{
return|return
name|availableVCores
operator|.
name|value
argument_list|()
return|;
block|}
DECL|method|getPendingMB ()
specifier|public
name|int
name|getPendingMB
parameter_list|()
block|{
return|return
name|pendingMB
operator|.
name|value
argument_list|()
return|;
block|}
DECL|method|getPendingVirtualCores ()
specifier|public
name|int
name|getPendingVirtualCores
parameter_list|()
block|{
return|return
name|pendingVCores
operator|.
name|value
argument_list|()
return|;
block|}
DECL|method|getPendingContainers ()
specifier|public
name|int
name|getPendingContainers
parameter_list|()
block|{
return|return
name|pendingContainers
operator|.
name|value
argument_list|()
return|;
block|}
DECL|method|getReservedMB ()
specifier|public
name|int
name|getReservedMB
parameter_list|()
block|{
return|return
name|reservedMB
operator|.
name|value
argument_list|()
return|;
block|}
DECL|method|getReservedVirtualCores ()
specifier|public
name|int
name|getReservedVirtualCores
parameter_list|()
block|{
return|return
name|reservedVCores
operator|.
name|value
argument_list|()
return|;
block|}
DECL|method|getReservedContainers ()
specifier|public
name|int
name|getReservedContainers
parameter_list|()
block|{
return|return
name|reservedContainers
operator|.
name|value
argument_list|()
return|;
block|}
DECL|method|getActiveUsers ()
specifier|public
name|int
name|getActiveUsers
parameter_list|()
block|{
return|return
name|activeUsers
operator|.
name|value
argument_list|()
return|;
block|}
DECL|method|getActiveApps ()
specifier|public
name|int
name|getActiveApps
parameter_list|()
block|{
return|return
name|activeApplications
operator|.
name|value
argument_list|()
return|;
block|}
block|}
end_class

end_unit

