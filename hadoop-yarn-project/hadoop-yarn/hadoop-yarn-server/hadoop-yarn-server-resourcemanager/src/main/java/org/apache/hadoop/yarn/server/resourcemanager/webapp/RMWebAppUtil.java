begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/** * Licensed to the Apache Software Foundation (ASF) under one * or more contributor license agreements.  See the NOTICE file * distributed with this work for additional information * regarding copyright ownership.  The ASF licenses this file * to you under the Apache License, Version 2.0 (the * "License"); you may not use this file except in compliance * with the License.  You may obtain a copy of the License at * *     http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */
end_comment

begin_package
DECL|package|org.apache.hadoop.yarn.server.resourcemanager.webapp
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|webapp
package|;
end_package

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|Log
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|LogFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|conf
operator|.
name|Configuration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|http
operator|.
name|lib
operator|.
name|StaticUserWebFilter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|AuthenticationFilterInitializer
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|HttpCrossOriginFilterInitializer
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|UserGroupInformation
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|authentication
operator|.
name|server
operator|.
name|KerberosAuthenticationHandler
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|util
operator|.
name|StringUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|conf
operator|.
name|YarnConfiguration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|resourcemanager
operator|.
name|security
operator|.
name|RMDelegationTokenSecretManager
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|security
operator|.
name|http
operator|.
name|RMAuthenticationFilter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|security
operator|.
name|http
operator|.
name|RMAuthenticationFilterInitializer
import|;
end_import

begin_comment
comment|/**  * Util class for ResourceManager WebApp.  */
end_comment

begin_class
DECL|class|RMWebAppUtil
specifier|public
specifier|final
class|class
name|RMWebAppUtil
block|{
DECL|field|LOG
specifier|private
specifier|static
specifier|final
name|Log
name|LOG
init|=
name|LogFactory
operator|.
name|getLog
argument_list|(
name|RMWebAppUtil
operator|.
name|class
argument_list|)
decl_stmt|;
comment|/**    * Private constructor.    */
DECL|method|RMWebAppUtil ()
specifier|private
name|RMWebAppUtil
parameter_list|()
block|{
comment|// not called
block|}
comment|/**    * Helper method to setup filters and authentication for ResourceManager    * WebServices.    *    * Use the customized yarn filter instead of the standard kerberos filter to    * allow users to authenticate using delegation tokens 4 conditions need to be    * satisfied:    *    * 1. security is enabled.    *    * 2. http auth type is set to kerberos.    *    * 3. "yarn.resourcemanager.webapp.use-yarn-filter" override is set to true.    *    * 4. hadoop.http.filter.initializers container    * AuthenticationFilterInitializer.    *    * @param conf RM configuration.    * @param rmDTSecretManager RM specific delegation token secret manager.    **/
DECL|method|setupSecurityAndFilters (Configuration conf, RMDelegationTokenSecretManager rmDTSecretManager)
specifier|public
specifier|static
name|void
name|setupSecurityAndFilters
parameter_list|(
name|Configuration
name|conf
parameter_list|,
name|RMDelegationTokenSecretManager
name|rmDTSecretManager
parameter_list|)
block|{
name|boolean
name|enableCorsFilter
init|=
name|conf
operator|.
name|getBoolean
argument_list|(
name|YarnConfiguration
operator|.
name|RM_WEBAPP_ENABLE_CORS_FILTER
argument_list|,
name|YarnConfiguration
operator|.
name|DEFAULT_RM_WEBAPP_ENABLE_CORS_FILTER
argument_list|)
decl_stmt|;
name|boolean
name|useYarnAuthenticationFilter
init|=
name|conf
operator|.
name|getBoolean
argument_list|(
name|YarnConfiguration
operator|.
name|RM_WEBAPP_DELEGATION_TOKEN_AUTH_FILTER
argument_list|,
name|YarnConfiguration
operator|.
name|DEFAULT_RM_WEBAPP_DELEGATION_TOKEN_AUTH_FILTER
argument_list|)
decl_stmt|;
name|String
name|authPrefix
init|=
literal|"hadoop.http.authentication."
decl_stmt|;
name|String
name|authTypeKey
init|=
name|authPrefix
operator|+
literal|"type"
decl_stmt|;
name|String
name|filterInitializerConfKey
init|=
literal|"hadoop.http.filter.initializers"
decl_stmt|;
name|String
name|actualInitializers
init|=
literal|""
decl_stmt|;
name|Class
argument_list|<
name|?
argument_list|>
index|[]
name|initializersClasses
init|=
name|conf
operator|.
name|getClasses
argument_list|(
name|filterInitializerConfKey
argument_list|)
decl_stmt|;
comment|// setup CORS
if|if
condition|(
name|enableCorsFilter
condition|)
block|{
name|conf
operator|.
name|setBoolean
argument_list|(
name|HttpCrossOriginFilterInitializer
operator|.
name|PREFIX
operator|+
name|HttpCrossOriginFilterInitializer
operator|.
name|ENABLED_SUFFIX
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
name|boolean
name|hasHadoopAuthFilterInitializer
init|=
literal|false
decl_stmt|;
name|boolean
name|hasRMAuthFilterInitializer
init|=
literal|false
decl_stmt|;
if|if
condition|(
name|initializersClasses
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|Class
argument_list|<
name|?
argument_list|>
name|initializer
range|:
name|initializersClasses
control|)
block|{
if|if
condition|(
name|initializer
operator|.
name|getName
argument_list|()
operator|.
name|equals
argument_list|(
name|AuthenticationFilterInitializer
operator|.
name|class
operator|.
name|getName
argument_list|()
argument_list|)
condition|)
block|{
name|hasHadoopAuthFilterInitializer
operator|=
literal|true
expr_stmt|;
block|}
if|if
condition|(
name|initializer
operator|.
name|getName
argument_list|()
operator|.
name|equals
argument_list|(
name|RMAuthenticationFilterInitializer
operator|.
name|class
operator|.
name|getName
argument_list|()
argument_list|)
condition|)
block|{
name|hasRMAuthFilterInitializer
operator|=
literal|true
expr_stmt|;
block|}
block|}
if|if
condition|(
name|UserGroupInformation
operator|.
name|isSecurityEnabled
argument_list|()
operator|&&
name|useYarnAuthenticationFilter
operator|&&
name|hasHadoopAuthFilterInitializer
operator|&&
name|conf
operator|.
name|get
argument_list|(
name|authTypeKey
argument_list|,
literal|""
argument_list|)
operator|.
name|equals
argument_list|(
name|KerberosAuthenticationHandler
operator|.
name|TYPE
argument_list|)
condition|)
block|{
name|ArrayList
argument_list|<
name|String
argument_list|>
name|target
init|=
operator|new
name|ArrayList
argument_list|<
name|String
argument_list|>
argument_list|()
decl_stmt|;
for|for
control|(
name|Class
argument_list|<
name|?
argument_list|>
name|filterInitializer
range|:
name|initializersClasses
control|)
block|{
if|if
condition|(
name|filterInitializer
operator|.
name|getName
argument_list|()
operator|.
name|equals
argument_list|(
name|AuthenticationFilterInitializer
operator|.
name|class
operator|.
name|getName
argument_list|()
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|hasRMAuthFilterInitializer
condition|)
block|{
name|target
operator|.
name|add
argument_list|(
name|RMAuthenticationFilterInitializer
operator|.
name|class
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
block|}
continue|continue;
block|}
name|target
operator|.
name|add
argument_list|(
name|filterInitializer
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|actualInitializers
operator|=
name|StringUtils
operator|.
name|join
argument_list|(
literal|","
argument_list|,
name|target
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Using RM authentication filter(kerberos/delegation-token)"
operator|+
literal|" for RM webapp authentication"
argument_list|)
expr_stmt|;
name|RMAuthenticationFilter
operator|.
name|setDelegationTokenSecretManager
argument_list|(
name|rmDTSecretManager
argument_list|)
expr_stmt|;
name|conf
operator|.
name|set
argument_list|(
name|filterInitializerConfKey
argument_list|,
name|actualInitializers
argument_list|)
expr_stmt|;
block|}
block|}
comment|// if security is not enabled and the default filter initializer has not
comment|// been set, set the initializer to include the
comment|// RMAuthenticationFilterInitializer which in turn will set up the simple
comment|// auth filter.
name|String
name|initializers
init|=
name|conf
operator|.
name|get
argument_list|(
name|filterInitializerConfKey
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|UserGroupInformation
operator|.
name|isSecurityEnabled
argument_list|()
condition|)
block|{
if|if
condition|(
name|initializersClasses
operator|==
literal|null
operator|||
name|initializersClasses
operator|.
name|length
operator|==
literal|0
condition|)
block|{
name|conf
operator|.
name|set
argument_list|(
name|filterInitializerConfKey
argument_list|,
name|RMAuthenticationFilterInitializer
operator|.
name|class
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|conf
operator|.
name|set
argument_list|(
name|authTypeKey
argument_list|,
literal|"simple"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|initializers
operator|.
name|equals
argument_list|(
name|StaticUserWebFilter
operator|.
name|class
operator|.
name|getName
argument_list|()
argument_list|)
condition|)
block|{
name|conf
operator|.
name|set
argument_list|(
name|filterInitializerConfKey
argument_list|,
name|RMAuthenticationFilterInitializer
operator|.
name|class
operator|.
name|getName
argument_list|()
operator|+
literal|","
operator|+
name|initializers
argument_list|)
expr_stmt|;
name|conf
operator|.
name|set
argument_list|(
name|authTypeKey
argument_list|,
literal|"simple"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_class

end_unit

