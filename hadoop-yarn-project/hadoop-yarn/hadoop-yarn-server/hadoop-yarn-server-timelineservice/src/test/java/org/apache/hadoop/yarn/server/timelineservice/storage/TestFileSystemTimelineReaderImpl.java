begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/**  * Licensed to the Apache Software Foundation (ASF) under one  * or more contributor license agreements.  See the NOTICE file  * distributed with this work for additional information  * regarding copyright ownership.  The ASF licenses this file  * to you under the Apache License, Version 2.0 (the  * "License"); you may not use this file except in compliance  * with the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
DECL|package|org.apache.hadoop.yarn.server.timelineservice.storage
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|timelineservice
operator|.
name|storage
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|BufferedWriter
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|File
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|FileWriter
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|PrintWriter
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Arrays
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|EnumSet
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashSet
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Set
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|csv
operator|.
name|CSVFormat
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|csv
operator|.
name|CSVPrinter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|io
operator|.
name|FileUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|conf
operator|.
name|Configuration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|timelineservice
operator|.
name|ApplicationAttemptEntity
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|timelineservice
operator|.
name|ContainerEntity
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|timelineservice
operator|.
name|TimelineEntity
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|timelineservice
operator|.
name|TimelineEntityType
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|timelineservice
operator|.
name|TimelineEvent
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|timelineservice
operator|.
name|TimelineMetric
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|conf
operator|.
name|YarnConfiguration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|timelineservice
operator|.
name|reader
operator|.
name|TimelineDataToRetrieve
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|timelineservice
operator|.
name|reader
operator|.
name|TimelineEntityFilters
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|timelineservice
operator|.
name|reader
operator|.
name|TimelineReaderContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|timelineservice
operator|.
name|reader
operator|.
name|filter
operator|.
name|TimelineCompareFilter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|timelineservice
operator|.
name|reader
operator|.
name|filter
operator|.
name|TimelineCompareOp
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|timelineservice
operator|.
name|reader
operator|.
name|filter
operator|.
name|TimelineExistsFilter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|timelineservice
operator|.
name|reader
operator|.
name|filter
operator|.
name|TimelineFilterList
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|timelineservice
operator|.
name|reader
operator|.
name|filter
operator|.
name|TimelineFilterList
operator|.
name|Operator
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|timelineservice
operator|.
name|reader
operator|.
name|filter
operator|.
name|TimelineKeyValueFilter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|timelineservice
operator|.
name|reader
operator|.
name|filter
operator|.
name|TimelineKeyValuesFilter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|timelineservice
operator|.
name|storage
operator|.
name|TimelineReader
operator|.
name|Field
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|util
operator|.
name|timeline
operator|.
name|TimelineUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|AfterClass
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Assert
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Before
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|BeforeClass
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Test
import|;
end_import

begin_class
DECL|class|TestFileSystemTimelineReaderImpl
specifier|public
class|class
name|TestFileSystemTimelineReaderImpl
block|{
DECL|field|ROOT_DIR
specifier|private
specifier|static
specifier|final
name|String
name|ROOT_DIR
init|=
operator|new
name|File
argument_list|(
literal|"target"
argument_list|,
name|TestFileSystemTimelineReaderImpl
operator|.
name|class
operator|.
name|getSimpleName
argument_list|()
argument_list|)
operator|.
name|getAbsolutePath
argument_list|()
decl_stmt|;
DECL|field|reader
specifier|private
name|FileSystemTimelineReaderImpl
name|reader
decl_stmt|;
annotation|@
name|BeforeClass
DECL|method|setup ()
specifier|public
specifier|static
name|void
name|setup
parameter_list|()
throws|throws
name|Exception
block|{
name|initializeDataDirectory
argument_list|(
name|ROOT_DIR
argument_list|)
expr_stmt|;
block|}
DECL|method|initializeDataDirectory (String rootDir)
specifier|public
specifier|static
name|void
name|initializeDataDirectory
parameter_list|(
name|String
name|rootDir
parameter_list|)
throws|throws
name|Exception
block|{
name|loadEntityData
argument_list|(
name|rootDir
argument_list|)
expr_stmt|;
comment|// Create app flow mapping file.
name|CSVFormat
name|format
init|=
name|CSVFormat
operator|.
name|DEFAULT
operator|.
name|withHeader
argument_list|(
literal|"APP"
argument_list|,
literal|"USER"
argument_list|,
literal|"FLOW"
argument_list|,
literal|"FLOWRUN"
argument_list|)
decl_stmt|;
name|String
name|appFlowMappingFile
init|=
name|rootDir
operator|+
name|File
operator|.
name|separator
operator|+
literal|"entities"
operator|+
name|File
operator|.
name|separator
operator|+
literal|"cluster1"
operator|+
name|File
operator|.
name|separator
operator|+
name|FileSystemTimelineReaderImpl
operator|.
name|APP_FLOW_MAPPING_FILE
decl_stmt|;
try|try
init|(
name|PrintWriter
name|out
init|=
operator|new
name|PrintWriter
argument_list|(
operator|new
name|BufferedWriter
argument_list|(
operator|new
name|FileWriter
argument_list|(
name|appFlowMappingFile
argument_list|,
literal|true
argument_list|)
argument_list|)
argument_list|)
init|;
name|CSVPrinter
name|printer
operator|=
operator|new
name|CSVPrinter
argument_list|(
name|out
argument_list|,
name|format
argument_list|)
init|)
block|{
name|printer
operator|.
name|printRecord
argument_list|(
literal|"app1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printer
operator|.
name|printRecord
argument_list|(
literal|"app2"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1,flow"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printer
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
operator|(
operator|new
name|File
argument_list|(
name|rootDir
argument_list|)
operator|)
operator|.
name|deleteOnExit
argument_list|()
expr_stmt|;
block|}
annotation|@
name|AfterClass
DECL|method|tearDown ()
specifier|public
specifier|static
name|void
name|tearDown
parameter_list|()
throws|throws
name|Exception
block|{
name|FileUtils
operator|.
name|deleteDirectory
argument_list|(
operator|new
name|File
argument_list|(
name|ROOT_DIR
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Before
DECL|method|init ()
specifier|public
name|void
name|init
parameter_list|()
throws|throws
name|Exception
block|{
name|reader
operator|=
operator|new
name|FileSystemTimelineReaderImpl
argument_list|()
expr_stmt|;
name|Configuration
name|conf
init|=
operator|new
name|YarnConfiguration
argument_list|()
decl_stmt|;
name|conf
operator|.
name|set
argument_list|(
name|FileSystemTimelineReaderImpl
operator|.
name|TIMELINE_SERVICE_STORAGE_DIR_ROOT
argument_list|,
name|ROOT_DIR
argument_list|)
expr_stmt|;
name|reader
operator|.
name|init
argument_list|(
name|conf
argument_list|)
expr_stmt|;
block|}
DECL|method|writeEntityFile (TimelineEntity entity, File dir)
specifier|private
specifier|static
name|void
name|writeEntityFile
parameter_list|(
name|TimelineEntity
name|entity
parameter_list|,
name|File
name|dir
parameter_list|)
throws|throws
name|Exception
block|{
if|if
condition|(
operator|!
name|dir
operator|.
name|exists
argument_list|()
condition|)
block|{
if|if
condition|(
operator|!
name|dir
operator|.
name|mkdirs
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Could not create directories for "
operator|+
name|dir
argument_list|)
throw|;
block|}
block|}
name|String
name|fileName
init|=
name|dir
operator|.
name|getAbsolutePath
argument_list|()
operator|+
name|File
operator|.
name|separator
operator|+
name|entity
operator|.
name|getId
argument_list|()
operator|+
literal|".thist"
decl_stmt|;
try|try
init|(
name|PrintWriter
name|out
init|=
operator|new
name|PrintWriter
argument_list|(
operator|new
name|BufferedWriter
argument_list|(
operator|new
name|FileWriter
argument_list|(
name|fileName
argument_list|,
literal|true
argument_list|)
argument_list|)
argument_list|)
init|)
block|{
name|out
operator|.
name|println
argument_list|(
name|TimelineUtils
operator|.
name|dumpTimelineRecordtoJSON
argument_list|(
name|entity
argument_list|)
argument_list|)
expr_stmt|;
name|out
operator|.
name|write
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|out
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
block|}
DECL|method|loadEntityData (String rootDir)
specifier|private
specifier|static
name|void
name|loadEntityData
parameter_list|(
name|String
name|rootDir
parameter_list|)
throws|throws
name|Exception
block|{
name|File
name|appDir
init|=
name|getAppDir
argument_list|(
name|rootDir
argument_list|,
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|"1"
argument_list|,
literal|"app1"
argument_list|,
literal|"app"
argument_list|)
decl_stmt|;
name|TimelineEntity
name|entity11
init|=
operator|new
name|TimelineEntity
argument_list|()
decl_stmt|;
name|entity11
operator|.
name|setId
argument_list|(
literal|"id_1"
argument_list|)
expr_stmt|;
name|entity11
operator|.
name|setType
argument_list|(
literal|"app"
argument_list|)
expr_stmt|;
name|entity11
operator|.
name|setCreatedTime
argument_list|(
literal|1425016502000L
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|info1
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
argument_list|()
decl_stmt|;
name|info1
operator|.
name|put
argument_list|(
literal|"info1"
argument_list|,
literal|"val1"
argument_list|)
expr_stmt|;
name|info1
operator|.
name|put
argument_list|(
literal|"info2"
argument_list|,
literal|"val5"
argument_list|)
expr_stmt|;
name|entity11
operator|.
name|addInfo
argument_list|(
name|info1
argument_list|)
expr_stmt|;
name|TimelineEvent
name|event
init|=
operator|new
name|TimelineEvent
argument_list|()
decl_stmt|;
name|event
operator|.
name|setId
argument_list|(
literal|"event_1"
argument_list|)
expr_stmt|;
name|event
operator|.
name|setTimestamp
argument_list|(
literal|1425016502003L
argument_list|)
expr_stmt|;
name|entity11
operator|.
name|addEvent
argument_list|(
name|event
argument_list|)
expr_stmt|;
name|Set
argument_list|<
name|TimelineMetric
argument_list|>
name|metrics
init|=
operator|new
name|HashSet
argument_list|<
name|TimelineMetric
argument_list|>
argument_list|()
decl_stmt|;
name|TimelineMetric
name|metric1
init|=
operator|new
name|TimelineMetric
argument_list|()
decl_stmt|;
name|metric1
operator|.
name|setId
argument_list|(
literal|"metric1"
argument_list|)
expr_stmt|;
name|metric1
operator|.
name|setType
argument_list|(
name|TimelineMetric
operator|.
name|Type
operator|.
name|SINGLE_VALUE
argument_list|)
expr_stmt|;
name|metric1
operator|.
name|addValue
argument_list|(
literal|1425016502006L
argument_list|,
literal|113
argument_list|)
expr_stmt|;
name|metrics
operator|.
name|add
argument_list|(
name|metric1
argument_list|)
expr_stmt|;
name|TimelineMetric
name|metric2
init|=
operator|new
name|TimelineMetric
argument_list|()
decl_stmt|;
name|metric2
operator|.
name|setId
argument_list|(
literal|"metric2"
argument_list|)
expr_stmt|;
name|metric2
operator|.
name|setType
argument_list|(
name|TimelineMetric
operator|.
name|Type
operator|.
name|TIME_SERIES
argument_list|)
expr_stmt|;
name|metric2
operator|.
name|addValue
argument_list|(
literal|1425016502016L
argument_list|,
literal|34
argument_list|)
expr_stmt|;
name|metrics
operator|.
name|add
argument_list|(
name|metric2
argument_list|)
expr_stmt|;
name|entity11
operator|.
name|setMetrics
argument_list|(
name|metrics
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|configs
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
argument_list|()
decl_stmt|;
name|configs
operator|.
name|put
argument_list|(
literal|"config_1"
argument_list|,
literal|"127"
argument_list|)
expr_stmt|;
name|entity11
operator|.
name|setConfigs
argument_list|(
name|configs
argument_list|)
expr_stmt|;
name|entity11
operator|.
name|addRelatesToEntity
argument_list|(
literal|"flow"
argument_list|,
literal|"flow1"
argument_list|)
expr_stmt|;
name|entity11
operator|.
name|addIsRelatedToEntity
argument_list|(
literal|"type1"
argument_list|,
literal|"tid1_1"
argument_list|)
expr_stmt|;
name|writeEntityFile
argument_list|(
name|entity11
argument_list|,
name|appDir
argument_list|)
expr_stmt|;
name|TimelineEntity
name|entity12
init|=
operator|new
name|TimelineEntity
argument_list|()
decl_stmt|;
name|entity12
operator|.
name|setId
argument_list|(
literal|"id_1"
argument_list|)
expr_stmt|;
name|entity12
operator|.
name|setType
argument_list|(
literal|"app"
argument_list|)
expr_stmt|;
name|configs
operator|.
name|clear
argument_list|()
expr_stmt|;
name|configs
operator|.
name|put
argument_list|(
literal|"config_2"
argument_list|,
literal|"23"
argument_list|)
expr_stmt|;
name|configs
operator|.
name|put
argument_list|(
literal|"config_3"
argument_list|,
literal|"abc"
argument_list|)
expr_stmt|;
name|entity12
operator|.
name|addConfigs
argument_list|(
name|configs
argument_list|)
expr_stmt|;
name|metrics
operator|.
name|clear
argument_list|()
expr_stmt|;
name|TimelineMetric
name|metric12
init|=
operator|new
name|TimelineMetric
argument_list|()
decl_stmt|;
name|metric12
operator|.
name|setId
argument_list|(
literal|"metric2"
argument_list|)
expr_stmt|;
name|metric12
operator|.
name|setType
argument_list|(
name|TimelineMetric
operator|.
name|Type
operator|.
name|TIME_SERIES
argument_list|)
expr_stmt|;
name|metric12
operator|.
name|addValue
argument_list|(
literal|1425016502032L
argument_list|,
literal|48
argument_list|)
expr_stmt|;
name|metric12
operator|.
name|addValue
argument_list|(
literal|1425016502054L
argument_list|,
literal|51
argument_list|)
expr_stmt|;
name|metrics
operator|.
name|add
argument_list|(
name|metric12
argument_list|)
expr_stmt|;
name|TimelineMetric
name|metric3
init|=
operator|new
name|TimelineMetric
argument_list|()
decl_stmt|;
name|metric3
operator|.
name|setId
argument_list|(
literal|"metric3"
argument_list|)
expr_stmt|;
name|metric3
operator|.
name|setType
argument_list|(
name|TimelineMetric
operator|.
name|Type
operator|.
name|SINGLE_VALUE
argument_list|)
expr_stmt|;
name|metric3
operator|.
name|addValue
argument_list|(
literal|1425016502060L
argument_list|,
literal|23L
argument_list|)
expr_stmt|;
name|metrics
operator|.
name|add
argument_list|(
name|metric3
argument_list|)
expr_stmt|;
name|entity12
operator|.
name|setMetrics
argument_list|(
name|metrics
argument_list|)
expr_stmt|;
name|entity12
operator|.
name|addIsRelatedToEntity
argument_list|(
literal|"type1"
argument_list|,
literal|"tid1_2"
argument_list|)
expr_stmt|;
name|entity12
operator|.
name|addIsRelatedToEntity
argument_list|(
literal|"type2"
argument_list|,
literal|"tid2_1`"
argument_list|)
expr_stmt|;
name|TimelineEvent
name|event15
init|=
operator|new
name|TimelineEvent
argument_list|()
decl_stmt|;
name|event15
operator|.
name|setId
argument_list|(
literal|"event_5"
argument_list|)
expr_stmt|;
name|event15
operator|.
name|setTimestamp
argument_list|(
literal|1425016502017L
argument_list|)
expr_stmt|;
name|entity12
operator|.
name|addEvent
argument_list|(
name|event15
argument_list|)
expr_stmt|;
name|writeEntityFile
argument_list|(
name|entity12
argument_list|,
name|appDir
argument_list|)
expr_stmt|;
name|TimelineEntity
name|entity2
init|=
operator|new
name|TimelineEntity
argument_list|()
decl_stmt|;
name|entity2
operator|.
name|setId
argument_list|(
literal|"id_2"
argument_list|)
expr_stmt|;
name|entity2
operator|.
name|setType
argument_list|(
literal|"app"
argument_list|)
expr_stmt|;
name|entity2
operator|.
name|setCreatedTime
argument_list|(
literal|1425016501050L
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|info2
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
argument_list|()
decl_stmt|;
name|info1
operator|.
name|put
argument_list|(
literal|"info2"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|entity2
operator|.
name|addInfo
argument_list|(
name|info2
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|configs2
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
argument_list|()
decl_stmt|;
name|configs2
operator|.
name|put
argument_list|(
literal|"config_1"
argument_list|,
literal|"129"
argument_list|)
expr_stmt|;
name|configs2
operator|.
name|put
argument_list|(
literal|"config_3"
argument_list|,
literal|"def"
argument_list|)
expr_stmt|;
name|entity2
operator|.
name|setConfigs
argument_list|(
name|configs2
argument_list|)
expr_stmt|;
name|TimelineEvent
name|event2
init|=
operator|new
name|TimelineEvent
argument_list|()
decl_stmt|;
name|event2
operator|.
name|setId
argument_list|(
literal|"event_2"
argument_list|)
expr_stmt|;
name|event2
operator|.
name|setTimestamp
argument_list|(
literal|1425016501003L
argument_list|)
expr_stmt|;
name|entity2
operator|.
name|addEvent
argument_list|(
name|event2
argument_list|)
expr_stmt|;
name|Set
argument_list|<
name|TimelineMetric
argument_list|>
name|metrics2
init|=
operator|new
name|HashSet
argument_list|<
name|TimelineMetric
argument_list|>
argument_list|()
decl_stmt|;
name|TimelineMetric
name|metric21
init|=
operator|new
name|TimelineMetric
argument_list|()
decl_stmt|;
name|metric21
operator|.
name|setId
argument_list|(
literal|"metric1"
argument_list|)
expr_stmt|;
name|metric21
operator|.
name|setType
argument_list|(
name|TimelineMetric
operator|.
name|Type
operator|.
name|SINGLE_VALUE
argument_list|)
expr_stmt|;
name|metric21
operator|.
name|addValue
argument_list|(
literal|1425016501006L
argument_list|,
literal|300
argument_list|)
expr_stmt|;
name|metrics2
operator|.
name|add
argument_list|(
name|metric21
argument_list|)
expr_stmt|;
name|TimelineMetric
name|metric22
init|=
operator|new
name|TimelineMetric
argument_list|()
decl_stmt|;
name|metric22
operator|.
name|setId
argument_list|(
literal|"metric2"
argument_list|)
expr_stmt|;
name|metric22
operator|.
name|setType
argument_list|(
name|TimelineMetric
operator|.
name|Type
operator|.
name|TIME_SERIES
argument_list|)
expr_stmt|;
name|metric22
operator|.
name|addValue
argument_list|(
literal|1425016501056L
argument_list|,
literal|31
argument_list|)
expr_stmt|;
name|metric22
operator|.
name|addValue
argument_list|(
literal|1425016501084L
argument_list|,
literal|70
argument_list|)
expr_stmt|;
name|metrics2
operator|.
name|add
argument_list|(
name|metric22
argument_list|)
expr_stmt|;
name|TimelineMetric
name|metric23
init|=
operator|new
name|TimelineMetric
argument_list|()
decl_stmt|;
name|metric23
operator|.
name|setId
argument_list|(
literal|"metric3"
argument_list|)
expr_stmt|;
name|metric23
operator|.
name|setType
argument_list|(
name|TimelineMetric
operator|.
name|Type
operator|.
name|SINGLE_VALUE
argument_list|)
expr_stmt|;
name|metric23
operator|.
name|addValue
argument_list|(
literal|1425016502060L
argument_list|,
literal|23L
argument_list|)
expr_stmt|;
name|metrics2
operator|.
name|add
argument_list|(
name|metric23
argument_list|)
expr_stmt|;
name|entity2
operator|.
name|setMetrics
argument_list|(
name|metrics2
argument_list|)
expr_stmt|;
name|entity2
operator|.
name|addRelatesToEntity
argument_list|(
literal|"flow"
argument_list|,
literal|"flow2"
argument_list|)
expr_stmt|;
name|writeEntityFile
argument_list|(
name|entity2
argument_list|,
name|appDir
argument_list|)
expr_stmt|;
name|TimelineEntity
name|entity3
init|=
operator|new
name|TimelineEntity
argument_list|()
decl_stmt|;
name|entity3
operator|.
name|setId
argument_list|(
literal|"id_3"
argument_list|)
expr_stmt|;
name|entity3
operator|.
name|setType
argument_list|(
literal|"app"
argument_list|)
expr_stmt|;
name|entity3
operator|.
name|setCreatedTime
argument_list|(
literal|1425016501050L
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|info3
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
argument_list|()
decl_stmt|;
name|info3
operator|.
name|put
argument_list|(
literal|"info2"
argument_list|,
literal|3.5
argument_list|)
expr_stmt|;
name|info3
operator|.
name|put
argument_list|(
literal|"info4"
argument_list|,
literal|20
argument_list|)
expr_stmt|;
name|entity3
operator|.
name|addInfo
argument_list|(
name|info3
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|configs3
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
argument_list|()
decl_stmt|;
name|configs3
operator|.
name|put
argument_list|(
literal|"config_1"
argument_list|,
literal|"123"
argument_list|)
expr_stmt|;
name|configs3
operator|.
name|put
argument_list|(
literal|"config_3"
argument_list|,
literal|"abc"
argument_list|)
expr_stmt|;
name|entity3
operator|.
name|setConfigs
argument_list|(
name|configs3
argument_list|)
expr_stmt|;
name|TimelineEvent
name|event3
init|=
operator|new
name|TimelineEvent
argument_list|()
decl_stmt|;
name|event3
operator|.
name|setId
argument_list|(
literal|"event_2"
argument_list|)
expr_stmt|;
name|event3
operator|.
name|setTimestamp
argument_list|(
literal|1425016501003L
argument_list|)
expr_stmt|;
name|entity3
operator|.
name|addEvent
argument_list|(
name|event3
argument_list|)
expr_stmt|;
name|TimelineEvent
name|event4
init|=
operator|new
name|TimelineEvent
argument_list|()
decl_stmt|;
name|event4
operator|.
name|setId
argument_list|(
literal|"event_4"
argument_list|)
expr_stmt|;
name|event4
operator|.
name|setTimestamp
argument_list|(
literal|1425016502006L
argument_list|)
expr_stmt|;
name|entity3
operator|.
name|addEvent
argument_list|(
name|event4
argument_list|)
expr_stmt|;
name|Set
argument_list|<
name|TimelineMetric
argument_list|>
name|metrics3
init|=
operator|new
name|HashSet
argument_list|<
name|TimelineMetric
argument_list|>
argument_list|()
decl_stmt|;
name|TimelineMetric
name|metric31
init|=
operator|new
name|TimelineMetric
argument_list|()
decl_stmt|;
name|metric31
operator|.
name|setId
argument_list|(
literal|"metric1"
argument_list|)
expr_stmt|;
name|metric31
operator|.
name|setType
argument_list|(
name|TimelineMetric
operator|.
name|Type
operator|.
name|SINGLE_VALUE
argument_list|)
expr_stmt|;
name|metric31
operator|.
name|addValue
argument_list|(
literal|1425016501006L
argument_list|,
literal|124
argument_list|)
expr_stmt|;
name|metrics3
operator|.
name|add
argument_list|(
name|metric31
argument_list|)
expr_stmt|;
name|TimelineMetric
name|metric32
init|=
operator|new
name|TimelineMetric
argument_list|()
decl_stmt|;
name|metric32
operator|.
name|setId
argument_list|(
literal|"metric2"
argument_list|)
expr_stmt|;
name|metric32
operator|.
name|setType
argument_list|(
name|TimelineMetric
operator|.
name|Type
operator|.
name|TIME_SERIES
argument_list|)
expr_stmt|;
name|metric32
operator|.
name|addValue
argument_list|(
literal|1425016501056L
argument_list|,
literal|31
argument_list|)
expr_stmt|;
name|metric32
operator|.
name|addValue
argument_list|(
literal|1425016501084L
argument_list|,
literal|74
argument_list|)
expr_stmt|;
name|metrics3
operator|.
name|add
argument_list|(
name|metric32
argument_list|)
expr_stmt|;
name|entity3
operator|.
name|setMetrics
argument_list|(
name|metrics3
argument_list|)
expr_stmt|;
name|entity3
operator|.
name|addIsRelatedToEntity
argument_list|(
literal|"type1"
argument_list|,
literal|"tid1_2"
argument_list|)
expr_stmt|;
name|writeEntityFile
argument_list|(
name|entity3
argument_list|,
name|appDir
argument_list|)
expr_stmt|;
name|TimelineEntity
name|entity4
init|=
operator|new
name|TimelineEntity
argument_list|()
decl_stmt|;
name|entity4
operator|.
name|setId
argument_list|(
literal|"id_4"
argument_list|)
expr_stmt|;
name|entity4
operator|.
name|setType
argument_list|(
literal|"app"
argument_list|)
expr_stmt|;
name|entity4
operator|.
name|setCreatedTime
argument_list|(
literal|1425016502050L
argument_list|)
expr_stmt|;
name|TimelineEvent
name|event44
init|=
operator|new
name|TimelineEvent
argument_list|()
decl_stmt|;
name|event44
operator|.
name|setId
argument_list|(
literal|"event_4"
argument_list|)
expr_stmt|;
name|event44
operator|.
name|setTimestamp
argument_list|(
literal|1425016502003L
argument_list|)
expr_stmt|;
name|entity4
operator|.
name|addEvent
argument_list|(
name|event44
argument_list|)
expr_stmt|;
name|writeEntityFile
argument_list|(
name|entity4
argument_list|,
name|appDir
argument_list|)
expr_stmt|;
name|File
name|attemptDir
init|=
name|getAppDir
argument_list|(
name|rootDir
argument_list|,
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|"1"
argument_list|,
literal|"app1"
argument_list|,
name|TimelineEntityType
operator|.
name|YARN_APPLICATION_ATTEMPT
operator|.
name|toString
argument_list|()
argument_list|)
decl_stmt|;
name|ApplicationAttemptEntity
name|attempt1
init|=
operator|new
name|ApplicationAttemptEntity
argument_list|()
decl_stmt|;
name|attempt1
operator|.
name|setId
argument_list|(
literal|"app-attempt-1"
argument_list|)
expr_stmt|;
name|attempt1
operator|.
name|setCreatedTime
argument_list|(
literal|1425017502003L
argument_list|)
expr_stmt|;
name|writeEntityFile
argument_list|(
name|attempt1
argument_list|,
name|attemptDir
argument_list|)
expr_stmt|;
name|ApplicationAttemptEntity
name|attempt2
init|=
operator|new
name|ApplicationAttemptEntity
argument_list|()
decl_stmt|;
name|attempt2
operator|.
name|setId
argument_list|(
literal|"app-attempt-2"
argument_list|)
expr_stmt|;
name|attempt2
operator|.
name|setCreatedTime
argument_list|(
literal|1425017502004L
argument_list|)
expr_stmt|;
name|writeEntityFile
argument_list|(
name|attempt2
argument_list|,
name|attemptDir
argument_list|)
expr_stmt|;
name|File
name|entityDir
init|=
name|getAppDir
argument_list|(
name|rootDir
argument_list|,
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|"1"
argument_list|,
literal|"app1"
argument_list|,
name|TimelineEntityType
operator|.
name|YARN_CONTAINER
operator|.
name|toString
argument_list|()
argument_list|)
decl_stmt|;
name|ContainerEntity
name|containerEntity1
init|=
operator|new
name|ContainerEntity
argument_list|()
decl_stmt|;
name|containerEntity1
operator|.
name|setId
argument_list|(
literal|"container_1_1"
argument_list|)
expr_stmt|;
name|containerEntity1
operator|.
name|setParent
argument_list|(
name|attempt1
operator|.
name|getIdentifier
argument_list|()
argument_list|)
expr_stmt|;
name|containerEntity1
operator|.
name|setCreatedTime
argument_list|(
literal|1425017502003L
argument_list|)
expr_stmt|;
name|writeEntityFile
argument_list|(
name|containerEntity1
argument_list|,
name|entityDir
argument_list|)
expr_stmt|;
name|ContainerEntity
name|containerEntity2
init|=
operator|new
name|ContainerEntity
argument_list|()
decl_stmt|;
name|containerEntity2
operator|.
name|setId
argument_list|(
literal|"container_2_1"
argument_list|)
expr_stmt|;
name|containerEntity2
operator|.
name|setParent
argument_list|(
name|attempt2
operator|.
name|getIdentifier
argument_list|()
argument_list|)
expr_stmt|;
name|containerEntity2
operator|.
name|setCreatedTime
argument_list|(
literal|1425018502003L
argument_list|)
expr_stmt|;
name|writeEntityFile
argument_list|(
name|containerEntity2
argument_list|,
name|entityDir
argument_list|)
expr_stmt|;
name|ContainerEntity
name|containerEntity3
init|=
operator|new
name|ContainerEntity
argument_list|()
decl_stmt|;
name|containerEntity3
operator|.
name|setId
argument_list|(
literal|"container_2_2"
argument_list|)
expr_stmt|;
name|containerEntity3
operator|.
name|setParent
argument_list|(
name|attempt2
operator|.
name|getIdentifier
argument_list|()
argument_list|)
expr_stmt|;
name|containerEntity3
operator|.
name|setCreatedTime
argument_list|(
literal|1425018502003L
argument_list|)
expr_stmt|;
name|writeEntityFile
argument_list|(
name|containerEntity3
argument_list|,
name|entityDir
argument_list|)
expr_stmt|;
name|File
name|appDir2
init|=
name|getAppDir
argument_list|(
name|rootDir
argument_list|,
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1,flow"
argument_list|,
literal|"1"
argument_list|,
literal|"app2"
argument_list|,
literal|"app"
argument_list|)
decl_stmt|;
name|TimelineEntity
name|entity5
init|=
operator|new
name|TimelineEntity
argument_list|()
decl_stmt|;
name|entity5
operator|.
name|setId
argument_list|(
literal|"id_5"
argument_list|)
expr_stmt|;
name|entity5
operator|.
name|setType
argument_list|(
literal|"app"
argument_list|)
expr_stmt|;
name|entity5
operator|.
name|setCreatedTime
argument_list|(
literal|1425016502050L
argument_list|)
expr_stmt|;
name|writeEntityFile
argument_list|(
name|entity5
argument_list|,
name|appDir2
argument_list|)
expr_stmt|;
block|}
DECL|method|getAppDir (String rootDir, String cluster, String user, String flowName, String flowRunId, String appId, String entityName)
specifier|private
specifier|static
name|File
name|getAppDir
parameter_list|(
name|String
name|rootDir
parameter_list|,
name|String
name|cluster
parameter_list|,
name|String
name|user
parameter_list|,
name|String
name|flowName
parameter_list|,
name|String
name|flowRunId
parameter_list|,
name|String
name|appId
parameter_list|,
name|String
name|entityName
parameter_list|)
block|{
return|return
operator|new
name|File
argument_list|(
name|rootDir
operator|+
name|File
operator|.
name|separator
operator|+
literal|"entities"
operator|+
name|File
operator|.
name|separator
operator|+
name|cluster
operator|+
name|File
operator|.
name|separator
operator|+
name|user
operator|+
name|File
operator|.
name|separator
operator|+
name|flowName
operator|+
name|File
operator|.
name|separator
operator|+
name|flowRunId
operator|+
name|File
operator|.
name|separator
operator|+
name|appId
operator|+
name|File
operator|.
name|separator
operator|+
name|entityName
operator|+
name|File
operator|.
name|separator
argument_list|)
return|;
block|}
annotation|@
name|Test
DECL|method|testGetEntityDefaultView ()
specifier|public
name|void
name|testGetEntityDefaultView
parameter_list|()
throws|throws
name|Exception
block|{
comment|// If no fields are specified, entity is returned with default view i.e.
comment|// only the id, type and created time.
name|TimelineEntity
name|result
init|=
name|reader
operator|.
name|getEntity
argument_list|(
operator|new
name|TimelineReaderContext
argument_list|(
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|1L
argument_list|,
literal|"app1"
argument_list|,
literal|"app"
argument_list|,
literal|"id_1"
argument_list|)
argument_list|,
operator|new
name|TimelineDataToRetrieve
argument_list|(
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
operator|(
operator|new
name|TimelineEntity
operator|.
name|Identifier
argument_list|(
literal|"app"
argument_list|,
literal|"id_1"
argument_list|)
operator|)
operator|.
name|toString
argument_list|()
argument_list|,
name|result
operator|.
name|getIdentifier
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
operator|(
name|Long
operator|)
literal|1425016502000L
argument_list|,
name|result
operator|.
name|getCreatedTime
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|0
argument_list|,
name|result
operator|.
name|getConfigs
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|0
argument_list|,
name|result
operator|.
name|getMetrics
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testGetEntityByClusterAndApp ()
specifier|public
name|void
name|testGetEntityByClusterAndApp
parameter_list|()
throws|throws
name|Exception
block|{
comment|// Cluster and AppId should be enough to get an entity.
name|TimelineEntity
name|result
init|=
name|reader
operator|.
name|getEntity
argument_list|(
operator|new
name|TimelineReaderContext
argument_list|(
literal|"cluster1"
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|"app1"
argument_list|,
literal|"app"
argument_list|,
literal|"id_1"
argument_list|)
argument_list|,
operator|new
name|TimelineDataToRetrieve
argument_list|(
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
operator|(
operator|new
name|TimelineEntity
operator|.
name|Identifier
argument_list|(
literal|"app"
argument_list|,
literal|"id_1"
argument_list|)
operator|)
operator|.
name|toString
argument_list|()
argument_list|,
name|result
operator|.
name|getIdentifier
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
operator|(
name|Long
operator|)
literal|1425016502000L
argument_list|,
name|result
operator|.
name|getCreatedTime
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|0
argument_list|,
name|result
operator|.
name|getConfigs
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|0
argument_list|,
name|result
operator|.
name|getMetrics
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|/** This test checks whether we can handle commas in app flow mapping csv. */
annotation|@
name|Test
DECL|method|testAppFlowMappingCsv ()
specifier|public
name|void
name|testAppFlowMappingCsv
parameter_list|()
throws|throws
name|Exception
block|{
comment|// Test getting an entity by cluster and app where flow entry
comment|// in app flow mapping csv has commas.
name|TimelineEntity
name|result
init|=
name|reader
operator|.
name|getEntity
argument_list|(
operator|new
name|TimelineReaderContext
argument_list|(
literal|"cluster1"
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|"app2"
argument_list|,
literal|"app"
argument_list|,
literal|"id_5"
argument_list|)
argument_list|,
operator|new
name|TimelineDataToRetrieve
argument_list|(
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
operator|(
operator|new
name|TimelineEntity
operator|.
name|Identifier
argument_list|(
literal|"app"
argument_list|,
literal|"id_5"
argument_list|)
operator|)
operator|.
name|toString
argument_list|()
argument_list|,
name|result
operator|.
name|getIdentifier
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
operator|(
name|Long
operator|)
literal|1425016502050L
argument_list|,
name|result
operator|.
name|getCreatedTime
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testGetEntityCustomFields ()
specifier|public
name|void
name|testGetEntityCustomFields
parameter_list|()
throws|throws
name|Exception
block|{
comment|// Specified fields in addition to default view will be returned.
name|TimelineEntity
name|result
init|=
name|reader
operator|.
name|getEntity
argument_list|(
operator|new
name|TimelineReaderContext
argument_list|(
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|1L
argument_list|,
literal|"app1"
argument_list|,
literal|"app"
argument_list|,
literal|"id_1"
argument_list|)
argument_list|,
operator|new
name|TimelineDataToRetrieve
argument_list|(
literal|null
argument_list|,
literal|null
argument_list|,
name|EnumSet
operator|.
name|of
argument_list|(
name|Field
operator|.
name|INFO
argument_list|,
name|Field
operator|.
name|CONFIGS
argument_list|,
name|Field
operator|.
name|METRICS
argument_list|)
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
operator|(
operator|new
name|TimelineEntity
operator|.
name|Identifier
argument_list|(
literal|"app"
argument_list|,
literal|"id_1"
argument_list|)
operator|)
operator|.
name|toString
argument_list|()
argument_list|,
name|result
operator|.
name|getIdentifier
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
operator|(
name|Long
operator|)
literal|1425016502000L
argument_list|,
name|result
operator|.
name|getCreatedTime
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|3
argument_list|,
name|result
operator|.
name|getConfigs
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|3
argument_list|,
name|result
operator|.
name|getMetrics
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|2
argument_list|,
name|result
operator|.
name|getInfo
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
comment|// No events will be returned
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|0
argument_list|,
name|result
operator|.
name|getEvents
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testGetEntityAllFields ()
specifier|public
name|void
name|testGetEntityAllFields
parameter_list|()
throws|throws
name|Exception
block|{
comment|// All fields of TimelineEntity will be returned.
name|TimelineEntity
name|result
init|=
name|reader
operator|.
name|getEntity
argument_list|(
operator|new
name|TimelineReaderContext
argument_list|(
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|1L
argument_list|,
literal|"app1"
argument_list|,
literal|"app"
argument_list|,
literal|"id_1"
argument_list|)
argument_list|,
operator|new
name|TimelineDataToRetrieve
argument_list|(
literal|null
argument_list|,
literal|null
argument_list|,
name|EnumSet
operator|.
name|of
argument_list|(
name|Field
operator|.
name|ALL
argument_list|)
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
operator|(
operator|new
name|TimelineEntity
operator|.
name|Identifier
argument_list|(
literal|"app"
argument_list|,
literal|"id_1"
argument_list|)
operator|)
operator|.
name|toString
argument_list|()
argument_list|,
name|result
operator|.
name|getIdentifier
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
operator|(
name|Long
operator|)
literal|1425016502000L
argument_list|,
name|result
operator|.
name|getCreatedTime
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|3
argument_list|,
name|result
operator|.
name|getConfigs
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|3
argument_list|,
name|result
operator|.
name|getMetrics
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
comment|// All fields including events will be returned.
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|2
argument_list|,
name|result
operator|.
name|getEvents
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testGetAllEntities ()
specifier|public
name|void
name|testGetAllEntities
parameter_list|()
throws|throws
name|Exception
block|{
name|Set
argument_list|<
name|TimelineEntity
argument_list|>
name|result
init|=
name|reader
operator|.
name|getEntities
argument_list|(
operator|new
name|TimelineReaderContext
argument_list|(
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|1L
argument_list|,
literal|"app1"
argument_list|,
literal|"app"
argument_list|,
literal|null
argument_list|)
argument_list|,
operator|new
name|TimelineEntityFilters
operator|.
name|Builder
argument_list|()
operator|.
name|build
argument_list|()
argument_list|,
operator|new
name|TimelineDataToRetrieve
argument_list|(
literal|null
argument_list|,
literal|null
argument_list|,
name|EnumSet
operator|.
name|of
argument_list|(
name|Field
operator|.
name|ALL
argument_list|)
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|)
decl_stmt|;
comment|// All 4 entities will be returned
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|4
argument_list|,
name|result
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testGetEntitiesWithLimit ()
specifier|public
name|void
name|testGetEntitiesWithLimit
parameter_list|()
throws|throws
name|Exception
block|{
name|Set
argument_list|<
name|TimelineEntity
argument_list|>
name|result
init|=
name|reader
operator|.
name|getEntities
argument_list|(
operator|new
name|TimelineReaderContext
argument_list|(
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|1L
argument_list|,
literal|"app1"
argument_list|,
literal|"app"
argument_list|,
literal|null
argument_list|)
argument_list|,
operator|new
name|TimelineEntityFilters
operator|.
name|Builder
argument_list|()
operator|.
name|entityLimit
argument_list|(
literal|2L
argument_list|)
operator|.
name|build
argument_list|()
argument_list|,
operator|new
name|TimelineDataToRetrieve
argument_list|()
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|2
argument_list|,
name|result
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
comment|// Needs to be rewritten once hashcode and equals for
comment|// TimelineEntity is implemented
comment|// Entities with id_1 and id_4 should be returned,
comment|// based on created time, descending.
for|for
control|(
name|TimelineEntity
name|entity
range|:
name|result
control|)
block|{
if|if
condition|(
operator|!
name|entity
operator|.
name|getId
argument_list|()
operator|.
name|equals
argument_list|(
literal|"id_1"
argument_list|)
operator|&&
operator|!
name|entity
operator|.
name|getId
argument_list|()
operator|.
name|equals
argument_list|(
literal|"id_4"
argument_list|)
condition|)
block|{
name|Assert
operator|.
name|fail
argument_list|(
literal|"Entity not sorted by created time"
argument_list|)
expr_stmt|;
block|}
block|}
name|result
operator|=
name|reader
operator|.
name|getEntities
argument_list|(
operator|new
name|TimelineReaderContext
argument_list|(
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|1L
argument_list|,
literal|"app1"
argument_list|,
literal|"app"
argument_list|,
literal|null
argument_list|)
argument_list|,
operator|new
name|TimelineEntityFilters
operator|.
name|Builder
argument_list|()
operator|.
name|entityLimit
argument_list|(
literal|3L
argument_list|)
operator|.
name|build
argument_list|()
argument_list|,
operator|new
name|TimelineDataToRetrieve
argument_list|()
argument_list|)
expr_stmt|;
comment|// Even though 2 entities out of 4 have same created time, one entity
comment|// is left out due to limit
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|3
argument_list|,
name|result
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testGetEntitiesByTimeWindows ()
specifier|public
name|void
name|testGetEntitiesByTimeWindows
parameter_list|()
throws|throws
name|Exception
block|{
comment|// Get entities based on created time start and end time range.
name|Set
argument_list|<
name|TimelineEntity
argument_list|>
name|result
init|=
name|reader
operator|.
name|getEntities
argument_list|(
operator|new
name|TimelineReaderContext
argument_list|(
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|1L
argument_list|,
literal|"app1"
argument_list|,
literal|"app"
argument_list|,
literal|null
argument_list|)
argument_list|,
operator|new
name|TimelineEntityFilters
operator|.
name|Builder
argument_list|()
operator|.
name|createdTimeBegin
argument_list|(
literal|1425016502030L
argument_list|)
operator|.
name|createTimeEnd
argument_list|(
literal|1425016502060L
argument_list|)
operator|.
name|build
argument_list|()
argument_list|,
operator|new
name|TimelineDataToRetrieve
argument_list|()
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|result
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
comment|// Only one entity with ID id_4 should be returned.
for|for
control|(
name|TimelineEntity
name|entity
range|:
name|result
control|)
block|{
if|if
condition|(
operator|!
name|entity
operator|.
name|getId
argument_list|()
operator|.
name|equals
argument_list|(
literal|"id_4"
argument_list|)
condition|)
block|{
name|Assert
operator|.
name|fail
argument_list|(
literal|"Incorrect filtering based on created time range"
argument_list|)
expr_stmt|;
block|}
block|}
comment|// Get entities if only created time end is specified.
name|result
operator|=
name|reader
operator|.
name|getEntities
argument_list|(
operator|new
name|TimelineReaderContext
argument_list|(
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|1L
argument_list|,
literal|"app1"
argument_list|,
literal|"app"
argument_list|,
literal|null
argument_list|)
argument_list|,
operator|new
name|TimelineEntityFilters
operator|.
name|Builder
argument_list|()
operator|.
name|createTimeEnd
argument_list|(
literal|1425016502010L
argument_list|)
operator|.
name|build
argument_list|()
argument_list|,
operator|new
name|TimelineDataToRetrieve
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|3
argument_list|,
name|result
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|TimelineEntity
name|entity
range|:
name|result
control|)
block|{
if|if
condition|(
name|entity
operator|.
name|getId
argument_list|()
operator|.
name|equals
argument_list|(
literal|"id_4"
argument_list|)
condition|)
block|{
name|Assert
operator|.
name|fail
argument_list|(
literal|"Incorrect filtering based on created time range"
argument_list|)
expr_stmt|;
block|}
block|}
comment|// Get entities if only created time start is specified.
name|result
operator|=
name|reader
operator|.
name|getEntities
argument_list|(
operator|new
name|TimelineReaderContext
argument_list|(
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|1L
argument_list|,
literal|"app1"
argument_list|,
literal|"app"
argument_list|,
literal|null
argument_list|)
argument_list|,
operator|new
name|TimelineEntityFilters
operator|.
name|Builder
argument_list|()
operator|.
name|createdTimeBegin
argument_list|(
literal|1425016502010L
argument_list|)
operator|.
name|build
argument_list|()
argument_list|,
operator|new
name|TimelineDataToRetrieve
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|result
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|TimelineEntity
name|entity
range|:
name|result
control|)
block|{
if|if
condition|(
operator|!
name|entity
operator|.
name|getId
argument_list|()
operator|.
name|equals
argument_list|(
literal|"id_4"
argument_list|)
condition|)
block|{
name|Assert
operator|.
name|fail
argument_list|(
literal|"Incorrect filtering based on created time range"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Test
DECL|method|testGetFilteredEntities ()
specifier|public
name|void
name|testGetFilteredEntities
parameter_list|()
throws|throws
name|Exception
block|{
comment|// Get entities based on info filters.
name|TimelineFilterList
name|infoFilterList
init|=
operator|new
name|TimelineFilterList
argument_list|()
decl_stmt|;
name|infoFilterList
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineKeyValueFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|EQUAL
argument_list|,
literal|"info2"
argument_list|,
literal|3.5
argument_list|)
argument_list|)
expr_stmt|;
name|Set
argument_list|<
name|TimelineEntity
argument_list|>
name|result
init|=
name|reader
operator|.
name|getEntities
argument_list|(
operator|new
name|TimelineReaderContext
argument_list|(
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|1L
argument_list|,
literal|"app1"
argument_list|,
literal|"app"
argument_list|,
literal|null
argument_list|)
argument_list|,
operator|new
name|TimelineEntityFilters
operator|.
name|Builder
argument_list|()
operator|.
name|infoFilters
argument_list|(
name|infoFilterList
argument_list|)
operator|.
name|build
argument_list|()
argument_list|,
operator|new
name|TimelineDataToRetrieve
argument_list|()
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|result
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
comment|// Only one entity with ID id_3 should be returned.
for|for
control|(
name|TimelineEntity
name|entity
range|:
name|result
control|)
block|{
if|if
condition|(
operator|!
name|entity
operator|.
name|getId
argument_list|()
operator|.
name|equals
argument_list|(
literal|"id_3"
argument_list|)
condition|)
block|{
name|Assert
operator|.
name|fail
argument_list|(
literal|"Incorrect filtering based on info filters"
argument_list|)
expr_stmt|;
block|}
block|}
comment|// Get entities based on config filters.
name|TimelineFilterList
name|confFilterList
init|=
operator|new
name|TimelineFilterList
argument_list|()
decl_stmt|;
name|confFilterList
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineKeyValueFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|EQUAL
argument_list|,
literal|"config_1"
argument_list|,
literal|"123"
argument_list|)
argument_list|)
expr_stmt|;
name|confFilterList
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineKeyValueFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|EQUAL
argument_list|,
literal|"config_3"
argument_list|,
literal|"abc"
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|reader
operator|.
name|getEntities
argument_list|(
operator|new
name|TimelineReaderContext
argument_list|(
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|1L
argument_list|,
literal|"app1"
argument_list|,
literal|"app"
argument_list|,
literal|null
argument_list|)
argument_list|,
operator|new
name|TimelineEntityFilters
operator|.
name|Builder
argument_list|()
operator|.
name|configFilters
argument_list|(
name|confFilterList
argument_list|)
operator|.
name|build
argument_list|()
argument_list|,
operator|new
name|TimelineDataToRetrieve
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|result
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|TimelineEntity
name|entity
range|:
name|result
control|)
block|{
if|if
condition|(
operator|!
name|entity
operator|.
name|getId
argument_list|()
operator|.
name|equals
argument_list|(
literal|"id_3"
argument_list|)
condition|)
block|{
name|Assert
operator|.
name|fail
argument_list|(
literal|"Incorrect filtering based on config filters"
argument_list|)
expr_stmt|;
block|}
block|}
comment|// Get entities based on event filters.
name|TimelineFilterList
name|eventFilters
init|=
operator|new
name|TimelineFilterList
argument_list|()
decl_stmt|;
name|eventFilters
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineExistsFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|EQUAL
argument_list|,
literal|"event_2"
argument_list|)
argument_list|)
expr_stmt|;
name|eventFilters
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineExistsFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|EQUAL
argument_list|,
literal|"event_4"
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|reader
operator|.
name|getEntities
argument_list|(
operator|new
name|TimelineReaderContext
argument_list|(
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|1L
argument_list|,
literal|"app1"
argument_list|,
literal|"app"
argument_list|,
literal|null
argument_list|)
argument_list|,
operator|new
name|TimelineEntityFilters
operator|.
name|Builder
argument_list|()
operator|.
name|eventFilters
argument_list|(
name|eventFilters
argument_list|)
operator|.
name|build
argument_list|()
argument_list|,
operator|new
name|TimelineDataToRetrieve
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|result
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|TimelineEntity
name|entity
range|:
name|result
control|)
block|{
if|if
condition|(
operator|!
name|entity
operator|.
name|getId
argument_list|()
operator|.
name|equals
argument_list|(
literal|"id_3"
argument_list|)
condition|)
block|{
name|Assert
operator|.
name|fail
argument_list|(
literal|"Incorrect filtering based on event filters"
argument_list|)
expr_stmt|;
block|}
block|}
comment|// Get entities based on metric filters.
name|TimelineFilterList
name|metricFilterList
init|=
operator|new
name|TimelineFilterList
argument_list|()
decl_stmt|;
name|metricFilterList
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineCompareFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|GREATER_OR_EQUAL
argument_list|,
literal|"metric3"
argument_list|,
literal|0L
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|reader
operator|.
name|getEntities
argument_list|(
operator|new
name|TimelineReaderContext
argument_list|(
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|1L
argument_list|,
literal|"app1"
argument_list|,
literal|"app"
argument_list|,
literal|null
argument_list|)
argument_list|,
operator|new
name|TimelineEntityFilters
operator|.
name|Builder
argument_list|()
operator|.
name|metricFilters
argument_list|(
name|metricFilterList
argument_list|)
operator|.
name|build
argument_list|()
argument_list|,
operator|new
name|TimelineDataToRetrieve
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|2
argument_list|,
name|result
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
comment|// Two entities with IDs' id_1 and id_2 should be returned.
for|for
control|(
name|TimelineEntity
name|entity
range|:
name|result
control|)
block|{
if|if
condition|(
operator|!
name|entity
operator|.
name|getId
argument_list|()
operator|.
name|equals
argument_list|(
literal|"id_1"
argument_list|)
operator|&&
operator|!
name|entity
operator|.
name|getId
argument_list|()
operator|.
name|equals
argument_list|(
literal|"id_2"
argument_list|)
condition|)
block|{
name|Assert
operator|.
name|fail
argument_list|(
literal|"Incorrect filtering based on metric filters"
argument_list|)
expr_stmt|;
block|}
block|}
comment|// Get entities based on complex config filters.
name|TimelineFilterList
name|list1
init|=
operator|new
name|TimelineFilterList
argument_list|()
decl_stmt|;
name|list1
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineKeyValueFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|EQUAL
argument_list|,
literal|"config_1"
argument_list|,
literal|"129"
argument_list|)
argument_list|)
expr_stmt|;
name|list1
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineKeyValueFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|EQUAL
argument_list|,
literal|"config_3"
argument_list|,
literal|"def"
argument_list|)
argument_list|)
expr_stmt|;
name|TimelineFilterList
name|list2
init|=
operator|new
name|TimelineFilterList
argument_list|()
decl_stmt|;
name|list2
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineKeyValueFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|EQUAL
argument_list|,
literal|"config_2"
argument_list|,
literal|"23"
argument_list|)
argument_list|)
expr_stmt|;
name|list2
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineKeyValueFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|EQUAL
argument_list|,
literal|"config_3"
argument_list|,
literal|"abc"
argument_list|)
argument_list|)
expr_stmt|;
name|TimelineFilterList
name|confFilterList1
init|=
operator|new
name|TimelineFilterList
argument_list|(
name|Operator
operator|.
name|OR
argument_list|,
name|list1
argument_list|,
name|list2
argument_list|)
decl_stmt|;
name|result
operator|=
name|reader
operator|.
name|getEntities
argument_list|(
operator|new
name|TimelineReaderContext
argument_list|(
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|1L
argument_list|,
literal|"app1"
argument_list|,
literal|"app"
argument_list|,
literal|null
argument_list|)
argument_list|,
operator|new
name|TimelineEntityFilters
operator|.
name|Builder
argument_list|()
operator|.
name|configFilters
argument_list|(
name|confFilterList1
argument_list|)
operator|.
name|build
argument_list|()
argument_list|,
operator|new
name|TimelineDataToRetrieve
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|2
argument_list|,
name|result
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|TimelineEntity
name|entity
range|:
name|result
control|)
block|{
if|if
condition|(
operator|!
name|entity
operator|.
name|getId
argument_list|()
operator|.
name|equals
argument_list|(
literal|"id_1"
argument_list|)
operator|&&
operator|!
name|entity
operator|.
name|getId
argument_list|()
operator|.
name|equals
argument_list|(
literal|"id_2"
argument_list|)
condition|)
block|{
name|Assert
operator|.
name|fail
argument_list|(
literal|"Incorrect filtering based on config filters"
argument_list|)
expr_stmt|;
block|}
block|}
name|TimelineFilterList
name|list3
init|=
operator|new
name|TimelineFilterList
argument_list|()
decl_stmt|;
name|list3
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineKeyValueFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|NOT_EQUAL
argument_list|,
literal|"config_1"
argument_list|,
literal|"123"
argument_list|)
argument_list|)
expr_stmt|;
name|list3
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineKeyValueFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|NOT_EQUAL
argument_list|,
literal|"config_3"
argument_list|,
literal|"abc"
argument_list|)
argument_list|)
expr_stmt|;
name|TimelineFilterList
name|list4
init|=
operator|new
name|TimelineFilterList
argument_list|()
decl_stmt|;
name|list4
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineKeyValueFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|EQUAL
argument_list|,
literal|"config_2"
argument_list|,
literal|"23"
argument_list|)
argument_list|)
expr_stmt|;
name|TimelineFilterList
name|confFilterList2
init|=
operator|new
name|TimelineFilterList
argument_list|(
name|Operator
operator|.
name|OR
argument_list|,
name|list3
argument_list|,
name|list4
argument_list|)
decl_stmt|;
name|result
operator|=
name|reader
operator|.
name|getEntities
argument_list|(
operator|new
name|TimelineReaderContext
argument_list|(
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|1L
argument_list|,
literal|"app1"
argument_list|,
literal|"app"
argument_list|,
literal|null
argument_list|)
argument_list|,
operator|new
name|TimelineEntityFilters
operator|.
name|Builder
argument_list|()
operator|.
name|configFilters
argument_list|(
name|confFilterList2
argument_list|)
operator|.
name|build
argument_list|()
argument_list|,
operator|new
name|TimelineDataToRetrieve
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|2
argument_list|,
name|result
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|TimelineEntity
name|entity
range|:
name|result
control|)
block|{
if|if
condition|(
operator|!
name|entity
operator|.
name|getId
argument_list|()
operator|.
name|equals
argument_list|(
literal|"id_1"
argument_list|)
operator|&&
operator|!
name|entity
operator|.
name|getId
argument_list|()
operator|.
name|equals
argument_list|(
literal|"id_2"
argument_list|)
condition|)
block|{
name|Assert
operator|.
name|fail
argument_list|(
literal|"Incorrect filtering based on config filters"
argument_list|)
expr_stmt|;
block|}
block|}
name|TimelineFilterList
name|confFilterList3
init|=
operator|new
name|TimelineFilterList
argument_list|()
decl_stmt|;
name|confFilterList3
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineKeyValueFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|NOT_EQUAL
argument_list|,
literal|"config_1"
argument_list|,
literal|"127"
argument_list|)
argument_list|)
expr_stmt|;
name|confFilterList3
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineKeyValueFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|NOT_EQUAL
argument_list|,
literal|"config_3"
argument_list|,
literal|"abc"
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|reader
operator|.
name|getEntities
argument_list|(
operator|new
name|TimelineReaderContext
argument_list|(
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|1L
argument_list|,
literal|"app1"
argument_list|,
literal|"app"
argument_list|,
literal|null
argument_list|)
argument_list|,
operator|new
name|TimelineEntityFilters
operator|.
name|Builder
argument_list|()
operator|.
name|configFilters
argument_list|(
name|confFilterList3
argument_list|)
operator|.
name|build
argument_list|()
argument_list|,
operator|new
name|TimelineDataToRetrieve
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|result
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|TimelineEntity
name|entity
range|:
name|result
control|)
block|{
if|if
condition|(
operator|!
name|entity
operator|.
name|getId
argument_list|()
operator|.
name|equals
argument_list|(
literal|"id_2"
argument_list|)
condition|)
block|{
name|Assert
operator|.
name|fail
argument_list|(
literal|"Incorrect filtering based on config filters"
argument_list|)
expr_stmt|;
block|}
block|}
name|TimelineFilterList
name|confFilterList4
init|=
operator|new
name|TimelineFilterList
argument_list|()
decl_stmt|;
name|confFilterList4
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineKeyValueFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|EQUAL
argument_list|,
literal|"config_dummy"
argument_list|,
literal|"dummy"
argument_list|)
argument_list|)
expr_stmt|;
name|confFilterList4
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineKeyValueFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|EQUAL
argument_list|,
literal|"config_3"
argument_list|,
literal|"def"
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|reader
operator|.
name|getEntities
argument_list|(
operator|new
name|TimelineReaderContext
argument_list|(
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|1L
argument_list|,
literal|"app1"
argument_list|,
literal|"app"
argument_list|,
literal|null
argument_list|)
argument_list|,
operator|new
name|TimelineEntityFilters
operator|.
name|Builder
argument_list|()
operator|.
name|configFilters
argument_list|(
name|confFilterList4
argument_list|)
operator|.
name|build
argument_list|()
argument_list|,
operator|new
name|TimelineDataToRetrieve
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|0
argument_list|,
name|result
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|TimelineFilterList
name|confFilterList5
init|=
operator|new
name|TimelineFilterList
argument_list|(
name|Operator
operator|.
name|OR
argument_list|)
decl_stmt|;
name|confFilterList5
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineKeyValueFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|EQUAL
argument_list|,
literal|"config_dummy"
argument_list|,
literal|"dummy"
argument_list|)
argument_list|)
expr_stmt|;
name|confFilterList5
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineKeyValueFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|EQUAL
argument_list|,
literal|"config_3"
argument_list|,
literal|"def"
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|reader
operator|.
name|getEntities
argument_list|(
operator|new
name|TimelineReaderContext
argument_list|(
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|1L
argument_list|,
literal|"app1"
argument_list|,
literal|"app"
argument_list|,
literal|null
argument_list|)
argument_list|,
operator|new
name|TimelineEntityFilters
operator|.
name|Builder
argument_list|()
operator|.
name|configFilters
argument_list|(
name|confFilterList5
argument_list|)
operator|.
name|build
argument_list|()
argument_list|,
operator|new
name|TimelineDataToRetrieve
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|result
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|TimelineEntity
name|entity
range|:
name|result
control|)
block|{
if|if
condition|(
operator|!
name|entity
operator|.
name|getId
argument_list|()
operator|.
name|equals
argument_list|(
literal|"id_2"
argument_list|)
condition|)
block|{
name|Assert
operator|.
name|fail
argument_list|(
literal|"Incorrect filtering based on config filters"
argument_list|)
expr_stmt|;
block|}
block|}
comment|// Get entities based on complex metric filters.
name|TimelineFilterList
name|list6
init|=
operator|new
name|TimelineFilterList
argument_list|()
decl_stmt|;
name|list6
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineCompareFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|GREATER_THAN
argument_list|,
literal|"metric1"
argument_list|,
literal|200
argument_list|)
argument_list|)
expr_stmt|;
name|list6
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineCompareFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|EQUAL
argument_list|,
literal|"metric3"
argument_list|,
literal|23
argument_list|)
argument_list|)
expr_stmt|;
name|TimelineFilterList
name|list7
init|=
operator|new
name|TimelineFilterList
argument_list|()
decl_stmt|;
name|list7
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineCompareFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|GREATER_OR_EQUAL
argument_list|,
literal|"metric2"
argument_list|,
literal|74
argument_list|)
argument_list|)
expr_stmt|;
name|TimelineFilterList
name|metricFilterList1
init|=
operator|new
name|TimelineFilterList
argument_list|(
name|Operator
operator|.
name|OR
argument_list|,
name|list6
argument_list|,
name|list7
argument_list|)
decl_stmt|;
name|result
operator|=
name|reader
operator|.
name|getEntities
argument_list|(
operator|new
name|TimelineReaderContext
argument_list|(
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|1L
argument_list|,
literal|"app1"
argument_list|,
literal|"app"
argument_list|,
literal|null
argument_list|)
argument_list|,
operator|new
name|TimelineEntityFilters
operator|.
name|Builder
argument_list|()
operator|.
name|metricFilters
argument_list|(
name|metricFilterList1
argument_list|)
operator|.
name|build
argument_list|()
argument_list|,
operator|new
name|TimelineDataToRetrieve
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|2
argument_list|,
name|result
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
comment|// Two entities with IDs' id_2 and id_3 should be returned.
for|for
control|(
name|TimelineEntity
name|entity
range|:
name|result
control|)
block|{
if|if
condition|(
operator|!
name|entity
operator|.
name|getId
argument_list|()
operator|.
name|equals
argument_list|(
literal|"id_2"
argument_list|)
operator|&&
operator|!
name|entity
operator|.
name|getId
argument_list|()
operator|.
name|equals
argument_list|(
literal|"id_3"
argument_list|)
condition|)
block|{
name|Assert
operator|.
name|fail
argument_list|(
literal|"Incorrect filtering based on metric filters"
argument_list|)
expr_stmt|;
block|}
block|}
name|TimelineFilterList
name|metricFilterList2
init|=
operator|new
name|TimelineFilterList
argument_list|()
decl_stmt|;
name|metricFilterList2
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineCompareFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|LESS_THAN
argument_list|,
literal|"metric2"
argument_list|,
literal|70
argument_list|)
argument_list|)
expr_stmt|;
name|metricFilterList2
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineCompareFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|LESS_OR_EQUAL
argument_list|,
literal|"metric3"
argument_list|,
literal|23
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|reader
operator|.
name|getEntities
argument_list|(
operator|new
name|TimelineReaderContext
argument_list|(
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|1L
argument_list|,
literal|"app1"
argument_list|,
literal|"app"
argument_list|,
literal|null
argument_list|)
argument_list|,
operator|new
name|TimelineEntityFilters
operator|.
name|Builder
argument_list|()
operator|.
name|metricFilters
argument_list|(
name|metricFilterList2
argument_list|)
operator|.
name|build
argument_list|()
argument_list|,
operator|new
name|TimelineDataToRetrieve
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|result
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|TimelineEntity
name|entity
range|:
name|result
control|)
block|{
if|if
condition|(
operator|!
name|entity
operator|.
name|getId
argument_list|()
operator|.
name|equals
argument_list|(
literal|"id_1"
argument_list|)
condition|)
block|{
name|Assert
operator|.
name|fail
argument_list|(
literal|"Incorrect filtering based on metric filters"
argument_list|)
expr_stmt|;
block|}
block|}
name|TimelineFilterList
name|metricFilterList3
init|=
operator|new
name|TimelineFilterList
argument_list|()
decl_stmt|;
name|metricFilterList3
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineCompareFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|LESS_THAN
argument_list|,
literal|"dummy_metric"
argument_list|,
literal|30
argument_list|)
argument_list|)
expr_stmt|;
name|metricFilterList3
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineCompareFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|LESS_OR_EQUAL
argument_list|,
literal|"metric3"
argument_list|,
literal|23
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|reader
operator|.
name|getEntities
argument_list|(
operator|new
name|TimelineReaderContext
argument_list|(
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|1L
argument_list|,
literal|"app1"
argument_list|,
literal|"app"
argument_list|,
literal|null
argument_list|)
argument_list|,
operator|new
name|TimelineEntityFilters
operator|.
name|Builder
argument_list|()
operator|.
name|metricFilters
argument_list|(
name|metricFilterList3
argument_list|)
operator|.
name|build
argument_list|()
argument_list|,
operator|new
name|TimelineDataToRetrieve
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|0
argument_list|,
name|result
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|TimelineFilterList
name|metricFilterList4
init|=
operator|new
name|TimelineFilterList
argument_list|(
name|Operator
operator|.
name|OR
argument_list|)
decl_stmt|;
name|metricFilterList4
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineCompareFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|LESS_THAN
argument_list|,
literal|"dummy_metric"
argument_list|,
literal|30
argument_list|)
argument_list|)
expr_stmt|;
name|metricFilterList4
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineCompareFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|LESS_OR_EQUAL
argument_list|,
literal|"metric3"
argument_list|,
literal|23
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|reader
operator|.
name|getEntities
argument_list|(
operator|new
name|TimelineReaderContext
argument_list|(
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|1L
argument_list|,
literal|"app1"
argument_list|,
literal|"app"
argument_list|,
literal|null
argument_list|)
argument_list|,
operator|new
name|TimelineEntityFilters
operator|.
name|Builder
argument_list|()
operator|.
name|metricFilters
argument_list|(
name|metricFilterList4
argument_list|)
operator|.
name|build
argument_list|()
argument_list|,
operator|new
name|TimelineDataToRetrieve
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|2
argument_list|,
name|result
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|TimelineEntity
name|entity
range|:
name|result
control|)
block|{
if|if
condition|(
operator|!
name|entity
operator|.
name|getId
argument_list|()
operator|.
name|equals
argument_list|(
literal|"id_1"
argument_list|)
operator|&&
operator|!
name|entity
operator|.
name|getId
argument_list|()
operator|.
name|equals
argument_list|(
literal|"id_2"
argument_list|)
condition|)
block|{
name|Assert
operator|.
name|fail
argument_list|(
literal|"Incorrect filtering based on metric filters"
argument_list|)
expr_stmt|;
block|}
block|}
name|TimelineFilterList
name|metricFilterList5
init|=
operator|new
name|TimelineFilterList
argument_list|(
operator|new
name|TimelineCompareFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|NOT_EQUAL
argument_list|,
literal|"metric2"
argument_list|,
literal|74
argument_list|)
argument_list|)
decl_stmt|;
name|result
operator|=
name|reader
operator|.
name|getEntities
argument_list|(
operator|new
name|TimelineReaderContext
argument_list|(
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|1L
argument_list|,
literal|"app1"
argument_list|,
literal|"app"
argument_list|,
literal|null
argument_list|)
argument_list|,
operator|new
name|TimelineEntityFilters
operator|.
name|Builder
argument_list|()
operator|.
name|metricFilters
argument_list|(
name|metricFilterList5
argument_list|)
operator|.
name|build
argument_list|()
argument_list|,
operator|new
name|TimelineDataToRetrieve
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|2
argument_list|,
name|result
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|TimelineEntity
name|entity
range|:
name|result
control|)
block|{
if|if
condition|(
operator|!
name|entity
operator|.
name|getId
argument_list|()
operator|.
name|equals
argument_list|(
literal|"id_1"
argument_list|)
operator|&&
operator|!
name|entity
operator|.
name|getId
argument_list|()
operator|.
name|equals
argument_list|(
literal|"id_2"
argument_list|)
condition|)
block|{
name|Assert
operator|.
name|fail
argument_list|(
literal|"Incorrect filtering based on metric filters"
argument_list|)
expr_stmt|;
block|}
block|}
name|TimelineFilterList
name|infoFilterList1
init|=
operator|new
name|TimelineFilterList
argument_list|()
decl_stmt|;
name|infoFilterList1
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineKeyValueFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|EQUAL
argument_list|,
literal|"info2"
argument_list|,
literal|3.5
argument_list|)
argument_list|)
expr_stmt|;
name|infoFilterList1
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineKeyValueFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|NOT_EQUAL
argument_list|,
literal|"info4"
argument_list|,
literal|20
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|reader
operator|.
name|getEntities
argument_list|(
operator|new
name|TimelineReaderContext
argument_list|(
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|1L
argument_list|,
literal|"app1"
argument_list|,
literal|"app"
argument_list|,
literal|null
argument_list|)
argument_list|,
operator|new
name|TimelineEntityFilters
operator|.
name|Builder
argument_list|()
operator|.
name|infoFilters
argument_list|(
name|infoFilterList1
argument_list|)
operator|.
name|build
argument_list|()
argument_list|,
operator|new
name|TimelineDataToRetrieve
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|0
argument_list|,
name|result
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|TimelineFilterList
name|infoFilterList2
init|=
operator|new
name|TimelineFilterList
argument_list|(
name|Operator
operator|.
name|OR
argument_list|)
decl_stmt|;
name|infoFilterList2
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineKeyValueFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|EQUAL
argument_list|,
literal|"info2"
argument_list|,
literal|3.5
argument_list|)
argument_list|)
expr_stmt|;
name|infoFilterList2
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineKeyValueFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|EQUAL
argument_list|,
literal|"info1"
argument_list|,
literal|"val1"
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|reader
operator|.
name|getEntities
argument_list|(
operator|new
name|TimelineReaderContext
argument_list|(
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|1L
argument_list|,
literal|"app1"
argument_list|,
literal|"app"
argument_list|,
literal|null
argument_list|)
argument_list|,
operator|new
name|TimelineEntityFilters
operator|.
name|Builder
argument_list|()
operator|.
name|infoFilters
argument_list|(
name|infoFilterList2
argument_list|)
operator|.
name|build
argument_list|()
argument_list|,
operator|new
name|TimelineDataToRetrieve
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|2
argument_list|,
name|result
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|TimelineEntity
name|entity
range|:
name|result
control|)
block|{
if|if
condition|(
operator|!
name|entity
operator|.
name|getId
argument_list|()
operator|.
name|equals
argument_list|(
literal|"id_1"
argument_list|)
operator|&&
operator|!
name|entity
operator|.
name|getId
argument_list|()
operator|.
name|equals
argument_list|(
literal|"id_3"
argument_list|)
condition|)
block|{
name|Assert
operator|.
name|fail
argument_list|(
literal|"Incorrect filtering based on info filters"
argument_list|)
expr_stmt|;
block|}
block|}
name|TimelineFilterList
name|infoFilterList3
init|=
operator|new
name|TimelineFilterList
argument_list|()
decl_stmt|;
name|infoFilterList3
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineKeyValueFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|EQUAL
argument_list|,
literal|"dummy_info"
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|infoFilterList3
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineKeyValueFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|EQUAL
argument_list|,
literal|"info2"
argument_list|,
literal|"val5"
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|reader
operator|.
name|getEntities
argument_list|(
operator|new
name|TimelineReaderContext
argument_list|(
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|1L
argument_list|,
literal|"app1"
argument_list|,
literal|"app"
argument_list|,
literal|null
argument_list|)
argument_list|,
operator|new
name|TimelineEntityFilters
operator|.
name|Builder
argument_list|()
operator|.
name|infoFilters
argument_list|(
name|infoFilterList3
argument_list|)
operator|.
name|build
argument_list|()
argument_list|,
operator|new
name|TimelineDataToRetrieve
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|0
argument_list|,
name|result
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|TimelineFilterList
name|infoFilterList4
init|=
operator|new
name|TimelineFilterList
argument_list|(
name|Operator
operator|.
name|OR
argument_list|)
decl_stmt|;
name|infoFilterList4
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineKeyValueFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|EQUAL
argument_list|,
literal|"dummy_info"
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|infoFilterList4
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineKeyValueFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|EQUAL
argument_list|,
literal|"info2"
argument_list|,
literal|"val5"
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|reader
operator|.
name|getEntities
argument_list|(
operator|new
name|TimelineReaderContext
argument_list|(
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|1L
argument_list|,
literal|"app1"
argument_list|,
literal|"app"
argument_list|,
literal|null
argument_list|)
argument_list|,
operator|new
name|TimelineEntityFilters
operator|.
name|Builder
argument_list|()
operator|.
name|infoFilters
argument_list|(
name|infoFilterList4
argument_list|)
operator|.
name|build
argument_list|()
argument_list|,
operator|new
name|TimelineDataToRetrieve
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|result
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|TimelineEntity
name|entity
range|:
name|result
control|)
block|{
if|if
condition|(
operator|!
name|entity
operator|.
name|getId
argument_list|()
operator|.
name|equals
argument_list|(
literal|"id_1"
argument_list|)
condition|)
block|{
name|Assert
operator|.
name|fail
argument_list|(
literal|"Incorrect filtering based on info filters"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Test
DECL|method|testGetEntitiesByRelations ()
specifier|public
name|void
name|testGetEntitiesByRelations
parameter_list|()
throws|throws
name|Exception
block|{
comment|// Get entities based on relatesTo.
name|TimelineFilterList
name|relatesTo
init|=
operator|new
name|TimelineFilterList
argument_list|(
name|Operator
operator|.
name|OR
argument_list|)
decl_stmt|;
name|Set
argument_list|<
name|Object
argument_list|>
name|relatesToIds
init|=
operator|new
name|HashSet
argument_list|<
name|Object
argument_list|>
argument_list|(
name|Arrays
operator|.
name|asList
argument_list|(
operator|(
name|Object
operator|)
literal|"flow1"
argument_list|)
argument_list|)
decl_stmt|;
name|relatesTo
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineKeyValuesFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|EQUAL
argument_list|,
literal|"flow"
argument_list|,
name|relatesToIds
argument_list|)
argument_list|)
expr_stmt|;
name|Set
argument_list|<
name|TimelineEntity
argument_list|>
name|result
init|=
name|reader
operator|.
name|getEntities
argument_list|(
operator|new
name|TimelineReaderContext
argument_list|(
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|1L
argument_list|,
literal|"app1"
argument_list|,
literal|"app"
argument_list|,
literal|null
argument_list|)
argument_list|,
operator|new
name|TimelineEntityFilters
operator|.
name|Builder
argument_list|()
operator|.
name|relatesTo
argument_list|(
name|relatesTo
argument_list|)
operator|.
name|build
argument_list|()
argument_list|,
operator|new
name|TimelineDataToRetrieve
argument_list|()
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|result
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
comment|// Only one entity with ID id_1 should be returned.
for|for
control|(
name|TimelineEntity
name|entity
range|:
name|result
control|)
block|{
if|if
condition|(
operator|!
name|entity
operator|.
name|getId
argument_list|()
operator|.
name|equals
argument_list|(
literal|"id_1"
argument_list|)
condition|)
block|{
name|Assert
operator|.
name|fail
argument_list|(
literal|"Incorrect filtering based on relatesTo"
argument_list|)
expr_stmt|;
block|}
block|}
comment|// Get entities based on isRelatedTo.
name|TimelineFilterList
name|isRelatedTo
init|=
operator|new
name|TimelineFilterList
argument_list|(
name|Operator
operator|.
name|OR
argument_list|)
decl_stmt|;
name|Set
argument_list|<
name|Object
argument_list|>
name|isRelatedToIds
init|=
operator|new
name|HashSet
argument_list|<
name|Object
argument_list|>
argument_list|(
name|Arrays
operator|.
name|asList
argument_list|(
operator|(
name|Object
operator|)
literal|"tid1_2"
argument_list|)
argument_list|)
decl_stmt|;
name|isRelatedTo
operator|.
name|addFilter
argument_list|(
operator|new
name|TimelineKeyValuesFilter
argument_list|(
name|TimelineCompareOp
operator|.
name|EQUAL
argument_list|,
literal|"type1"
argument_list|,
name|isRelatedToIds
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|reader
operator|.
name|getEntities
argument_list|(
operator|new
name|TimelineReaderContext
argument_list|(
literal|"cluster1"
argument_list|,
literal|"user1"
argument_list|,
literal|"flow1"
argument_list|,
literal|1L
argument_list|,
literal|"app1"
argument_list|,
literal|"app"
argument_list|,
literal|null
argument_list|)
argument_list|,
operator|new
name|TimelineEntityFilters
operator|.
name|Builder
argument_list|()
operator|.
name|isRelatedTo
argument_list|(
name|isRelatedTo
argument_list|)
operator|.
name|build
argument_list|()
argument_list|,
operator|new
name|TimelineDataToRetrieve
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|2
argument_list|,
name|result
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
comment|// Two entities with IDs' id_1 and id_3 should be returned.
for|for
control|(
name|TimelineEntity
name|entity
range|:
name|result
control|)
block|{
if|if
condition|(
operator|!
name|entity
operator|.
name|getId
argument_list|()
operator|.
name|equals
argument_list|(
literal|"id_1"
argument_list|)
operator|&&
operator|!
name|entity
operator|.
name|getId
argument_list|()
operator|.
name|equals
argument_list|(
literal|"id_3"
argument_list|)
condition|)
block|{
name|Assert
operator|.
name|fail
argument_list|(
literal|"Incorrect filtering based on isRelatedTo"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_class

end_unit

