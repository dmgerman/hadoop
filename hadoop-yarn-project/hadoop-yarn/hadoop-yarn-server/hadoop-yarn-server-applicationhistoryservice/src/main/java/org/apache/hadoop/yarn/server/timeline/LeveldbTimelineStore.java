begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/**  * Licensed to the Apache Software Foundation (ASF) under one  * or more contributor license agreements.  See the NOTICE file  * distributed with this work for additional information  * regarding copyright ownership.  The ASF licenses this file  * to you under the Apache License, Version 2.0 (the  * "License"); you may not use this file except in compliance  * with the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
DECL|package|org.apache.hadoop.yarn.server.timeline
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|timeline
package|;
end_package

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|annotations
operator|.
name|VisibleForTesting
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|base
operator|.
name|Preconditions
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|collections
operator|.
name|map
operator|.
name|LRUMap
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|io
operator|.
name|FileUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|classification
operator|.
name|InterfaceAudience
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|classification
operator|.
name|InterfaceAudience
operator|.
name|Private
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|classification
operator|.
name|InterfaceStability
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|conf
operator|.
name|Configuration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|FileSystem
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|Path
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|permission
operator|.
name|FsPermission
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|IOUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|WritableComparator
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|service
operator|.
name|AbstractService
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|util
operator|.
name|Time
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|timeline
operator|.
name|*
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|timeline
operator|.
name|TimelineEvents
operator|.
name|EventsOfOneEntity
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|timeline
operator|.
name|TimelinePutResponse
operator|.
name|TimelinePutError
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|conf
operator|.
name|YarnConfiguration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|proto
operator|.
name|YarnServerCommonProtos
operator|.
name|VersionProto
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|records
operator|.
name|Version
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|records
operator|.
name|impl
operator|.
name|pb
operator|.
name|VersionPBImpl
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|timeline
operator|.
name|TimelineDataManager
operator|.
name|CheckAcl
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|timeline
operator|.
name|util
operator|.
name|LeveldbUtils
operator|.
name|KeyBuilder
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|timeline
operator|.
name|util
operator|.
name|LeveldbUtils
operator|.
name|KeyParser
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|utils
operator|.
name|LeveldbIterator
import|;
end_import

begin_import
import|import
name|org
operator|.
name|fusesource
operator|.
name|leveldbjni
operator|.
name|JniDBFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|iq80
operator|.
name|leveldb
operator|.
name|*
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|LoggerFactory
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|File
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|nio
operator|.
name|charset
operator|.
name|Charset
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|*
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
operator|.
name|Entry
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|locks
operator|.
name|ReentrantLock
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|locks
operator|.
name|ReentrantReadWriteLock
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|timeline
operator|.
name|GenericObjectMapper
operator|.
name|readReverseOrderedLong
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|timeline
operator|.
name|GenericObjectMapper
operator|.
name|writeReverseOrderedLong
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|timeline
operator|.
name|TimelineDataManager
operator|.
name|DEFAULT_DOMAIN_ID
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|timeline
operator|.
name|util
operator|.
name|LeveldbUtils
operator|.
name|prefixMatches
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|fusesource
operator|.
name|leveldbjni
operator|.
name|JniDBFactory
operator|.
name|bytes
import|;
end_import

begin_comment
comment|/**  *<p>An implementation of an application timeline store backed by leveldb.</p>  *  *<p>There are three sections of the db, the start time section,  * the entity section, and the indexed entity section.</p>  *  *<p>The start time section is used to retrieve the unique start time for  * a given entity. Its values each contain a start time while its keys are of  * the form:</p>  *<pre>  *   START_TIME_LOOKUP_PREFIX + entity type + entity id</pre>  *  *<p>The entity section is ordered by entity type, then entity start time  * descending, then entity ID. There are four sub-sections of the entity  * section: events, primary filters, related entities,  * and other info. The event entries have event info serialized into their  * values. The other info entries have values corresponding to the values of  * the other info name/value map for the entry (note the names are contained  * in the key). All other entries have empty values. The key structure is as  * follows:</p>  *<pre>  *   ENTITY_ENTRY_PREFIX + entity type + revstarttime + entity id  *  *   ENTITY_ENTRY_PREFIX + entity type + revstarttime + entity id +  *     EVENTS_COLUMN + reveventtimestamp + eventtype  *  *   ENTITY_ENTRY_PREFIX + entity type + revstarttime + entity id +  *     PRIMARY_FILTERS_COLUMN + name + value  *  *   ENTITY_ENTRY_PREFIX + entity type + revstarttime + entity id +  *     OTHER_INFO_COLUMN + name  *  *   ENTITY_ENTRY_PREFIX + entity type + revstarttime + entity id +  *     RELATED_ENTITIES_COLUMN + relatedentity type + relatedentity id  *  *   ENTITY_ENTRY_PREFIX + entity type + revstarttime + entity id +  *     DOMAIN_ID_COLUMN  *  *   ENTITY_ENTRY_PREFIX + entity type + revstarttime + entity id +  *     INVISIBLE_REVERSE_RELATED_ENTITIES_COLUMN + relatedentity type +  *     relatedentity id</pre>  *  *<p>The indexed entity section contains a primary filter name and primary  * filter value as the prefix. Within a given name/value, entire entity  * entries are stored in the same format as described in the entity section  * above (below, "key" represents any one of the possible entity entry keys  * described above).</p>  *<pre>  *   INDEXED_ENTRY_PREFIX + primaryfilter name + primaryfilter value +  *     key</pre>  */
end_comment

begin_class
annotation|@
name|InterfaceAudience
operator|.
name|Private
annotation|@
name|InterfaceStability
operator|.
name|Unstable
DECL|class|LeveldbTimelineStore
specifier|public
class|class
name|LeveldbTimelineStore
extends|extends
name|AbstractService
implements|implements
name|TimelineStore
block|{
DECL|field|LOG
specifier|private
specifier|static
specifier|final
name|org
operator|.
name|slf4j
operator|.
name|Logger
name|LOG
init|=
name|LoggerFactory
operator|.
name|getLogger
argument_list|(
name|LeveldbTimelineStore
operator|.
name|class
argument_list|)
decl_stmt|;
annotation|@
name|Private
annotation|@
name|VisibleForTesting
DECL|field|FILENAME
specifier|static
specifier|final
name|String
name|FILENAME
init|=
literal|"leveldb-timeline-store.ldb"
decl_stmt|;
annotation|@
name|VisibleForTesting
comment|//Extension to FILENAME where backup will be stored in case we need to
comment|//call LevelDb recovery
DECL|field|BACKUP_EXT
specifier|static
specifier|final
name|String
name|BACKUP_EXT
init|=
literal|".backup-"
decl_stmt|;
DECL|field|START_TIME_LOOKUP_PREFIX
specifier|private
specifier|static
specifier|final
name|byte
index|[]
name|START_TIME_LOOKUP_PREFIX
init|=
literal|"k"
operator|.
name|getBytes
argument_list|(
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
decl_stmt|;
DECL|field|ENTITY_ENTRY_PREFIX
specifier|private
specifier|static
specifier|final
name|byte
index|[]
name|ENTITY_ENTRY_PREFIX
init|=
literal|"e"
operator|.
name|getBytes
argument_list|(
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
decl_stmt|;
DECL|field|INDEXED_ENTRY_PREFIX
specifier|private
specifier|static
specifier|final
name|byte
index|[]
name|INDEXED_ENTRY_PREFIX
init|=
literal|"i"
operator|.
name|getBytes
argument_list|(
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
decl_stmt|;
DECL|field|EVENTS_COLUMN
specifier|private
specifier|static
specifier|final
name|byte
index|[]
name|EVENTS_COLUMN
init|=
literal|"e"
operator|.
name|getBytes
argument_list|(
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
decl_stmt|;
DECL|field|PRIMARY_FILTERS_COLUMN
specifier|private
specifier|static
specifier|final
name|byte
index|[]
name|PRIMARY_FILTERS_COLUMN
init|=
literal|"f"
operator|.
name|getBytes
argument_list|(
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
decl_stmt|;
DECL|field|OTHER_INFO_COLUMN
specifier|private
specifier|static
specifier|final
name|byte
index|[]
name|OTHER_INFO_COLUMN
init|=
literal|"i"
operator|.
name|getBytes
argument_list|(
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
decl_stmt|;
DECL|field|RELATED_ENTITIES_COLUMN
specifier|private
specifier|static
specifier|final
name|byte
index|[]
name|RELATED_ENTITIES_COLUMN
init|=
literal|"r"
operator|.
name|getBytes
argument_list|(
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
decl_stmt|;
DECL|field|INVISIBLE_REVERSE_RELATED_ENTITIES_COLUMN
specifier|private
specifier|static
specifier|final
name|byte
index|[]
name|INVISIBLE_REVERSE_RELATED_ENTITIES_COLUMN
init|=
literal|"z"
operator|.
name|getBytes
argument_list|(
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
decl_stmt|;
DECL|field|DOMAIN_ID_COLUMN
specifier|private
specifier|static
specifier|final
name|byte
index|[]
name|DOMAIN_ID_COLUMN
init|=
literal|"d"
operator|.
name|getBytes
argument_list|(
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
decl_stmt|;
DECL|field|DOMAIN_ENTRY_PREFIX
specifier|private
specifier|static
specifier|final
name|byte
index|[]
name|DOMAIN_ENTRY_PREFIX
init|=
literal|"d"
operator|.
name|getBytes
argument_list|(
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
decl_stmt|;
DECL|field|OWNER_LOOKUP_PREFIX
specifier|private
specifier|static
specifier|final
name|byte
index|[]
name|OWNER_LOOKUP_PREFIX
init|=
literal|"o"
operator|.
name|getBytes
argument_list|(
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
decl_stmt|;
DECL|field|DESCRIPTION_COLUMN
specifier|private
specifier|static
specifier|final
name|byte
index|[]
name|DESCRIPTION_COLUMN
init|=
literal|"d"
operator|.
name|getBytes
argument_list|(
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
decl_stmt|;
DECL|field|OWNER_COLUMN
specifier|private
specifier|static
specifier|final
name|byte
index|[]
name|OWNER_COLUMN
init|=
literal|"o"
operator|.
name|getBytes
argument_list|(
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
decl_stmt|;
DECL|field|READER_COLUMN
specifier|private
specifier|static
specifier|final
name|byte
index|[]
name|READER_COLUMN
init|=
literal|"r"
operator|.
name|getBytes
argument_list|(
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
decl_stmt|;
DECL|field|WRITER_COLUMN
specifier|private
specifier|static
specifier|final
name|byte
index|[]
name|WRITER_COLUMN
init|=
literal|"w"
operator|.
name|getBytes
argument_list|(
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
decl_stmt|;
DECL|field|TIMESTAMP_COLUMN
specifier|private
specifier|static
specifier|final
name|byte
index|[]
name|TIMESTAMP_COLUMN
init|=
literal|"t"
operator|.
name|getBytes
argument_list|(
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
decl_stmt|;
DECL|field|EMPTY_BYTES
specifier|private
specifier|static
specifier|final
name|byte
index|[]
name|EMPTY_BYTES
init|=
operator|new
name|byte
index|[
literal|0
index|]
decl_stmt|;
DECL|field|TIMELINE_STORE_VERSION_KEY
specifier|private
specifier|static
specifier|final
name|String
name|TIMELINE_STORE_VERSION_KEY
init|=
literal|"timeline-store-version"
decl_stmt|;
DECL|field|CURRENT_VERSION_INFO
specifier|private
specifier|static
specifier|final
name|Version
name|CURRENT_VERSION_INFO
init|=
name|Version
operator|.
name|newInstance
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|)
decl_stmt|;
annotation|@
name|Private
annotation|@
name|VisibleForTesting
DECL|field|LEVELDB_DIR_UMASK
specifier|static
specifier|final
name|FsPermission
name|LEVELDB_DIR_UMASK
init|=
name|FsPermission
operator|.
name|createImmutable
argument_list|(
operator|(
name|short
operator|)
literal|0700
argument_list|)
decl_stmt|;
DECL|field|startTimeWriteCache
specifier|private
name|Map
argument_list|<
name|EntityIdentifier
argument_list|,
name|StartAndInsertTime
argument_list|>
name|startTimeWriteCache
decl_stmt|;
DECL|field|startTimeReadCache
specifier|private
name|Map
argument_list|<
name|EntityIdentifier
argument_list|,
name|Long
argument_list|>
name|startTimeReadCache
decl_stmt|;
comment|/**    * Per-entity locks are obtained when writing.    */
DECL|field|writeLocks
specifier|private
specifier|final
name|LockMap
argument_list|<
name|EntityIdentifier
argument_list|>
name|writeLocks
init|=
operator|new
name|LockMap
argument_list|<
name|EntityIdentifier
argument_list|>
argument_list|()
decl_stmt|;
DECL|field|deleteLock
specifier|private
specifier|final
name|ReentrantReadWriteLock
name|deleteLock
init|=
operator|new
name|ReentrantReadWriteLock
argument_list|()
decl_stmt|;
DECL|field|db
specifier|private
name|DB
name|db
decl_stmt|;
DECL|field|deletionThread
specifier|private
name|Thread
name|deletionThread
decl_stmt|;
DECL|method|LeveldbTimelineStore ()
specifier|public
name|LeveldbTimelineStore
parameter_list|()
block|{
name|super
argument_list|(
name|LeveldbTimelineStore
operator|.
name|class
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|field|factory
specifier|private
name|JniDBFactory
name|factory
decl_stmt|;
annotation|@
name|VisibleForTesting
DECL|method|setFactory (JniDBFactory fact)
name|void
name|setFactory
parameter_list|(
name|JniDBFactory
name|fact
parameter_list|)
block|{
name|this
operator|.
name|factory
operator|=
name|fact
expr_stmt|;
block|}
annotation|@
name|Override
annotation|@
name|SuppressWarnings
argument_list|(
literal|"unchecked"
argument_list|)
DECL|method|serviceInit (Configuration conf)
specifier|protected
name|void
name|serviceInit
parameter_list|(
name|Configuration
name|conf
parameter_list|)
throws|throws
name|Exception
block|{
name|Preconditions
operator|.
name|checkArgument
argument_list|(
name|conf
operator|.
name|getLong
argument_list|(
name|YarnConfiguration
operator|.
name|TIMELINE_SERVICE_TTL_MS
argument_list|,
name|YarnConfiguration
operator|.
name|DEFAULT_TIMELINE_SERVICE_TTL_MS
argument_list|)
operator|>
literal|0
argument_list|,
literal|"%s property value should be greater than zero"
argument_list|,
name|YarnConfiguration
operator|.
name|TIMELINE_SERVICE_TTL_MS
argument_list|)
expr_stmt|;
name|Preconditions
operator|.
name|checkArgument
argument_list|(
name|conf
operator|.
name|getLong
argument_list|(
name|YarnConfiguration
operator|.
name|TIMELINE_SERVICE_LEVELDB_TTL_INTERVAL_MS
argument_list|,
name|YarnConfiguration
operator|.
name|DEFAULT_TIMELINE_SERVICE_LEVELDB_TTL_INTERVAL_MS
argument_list|)
operator|>
literal|0
argument_list|,
literal|"%s property value should be greater than zero"
argument_list|,
name|YarnConfiguration
operator|.
name|TIMELINE_SERVICE_LEVELDB_TTL_INTERVAL_MS
argument_list|)
expr_stmt|;
name|Preconditions
operator|.
name|checkArgument
argument_list|(
name|conf
operator|.
name|getLong
argument_list|(
name|YarnConfiguration
operator|.
name|TIMELINE_SERVICE_LEVELDB_READ_CACHE_SIZE
argument_list|,
name|YarnConfiguration
operator|.
name|DEFAULT_TIMELINE_SERVICE_LEVELDB_READ_CACHE_SIZE
argument_list|)
operator|>=
literal|0
argument_list|,
literal|"%s property value should be greater than or equal to zero"
argument_list|,
name|YarnConfiguration
operator|.
name|TIMELINE_SERVICE_LEVELDB_READ_CACHE_SIZE
argument_list|)
expr_stmt|;
name|Preconditions
operator|.
name|checkArgument
argument_list|(
name|conf
operator|.
name|getLong
argument_list|(
name|YarnConfiguration
operator|.
name|TIMELINE_SERVICE_LEVELDB_START_TIME_READ_CACHE_SIZE
argument_list|,
name|YarnConfiguration
operator|.
name|DEFAULT_TIMELINE_SERVICE_LEVELDB_START_TIME_READ_CACHE_SIZE
argument_list|)
operator|>
literal|0
argument_list|,
literal|" %s property value should be greater than zero"
argument_list|,
name|YarnConfiguration
operator|.
name|TIMELINE_SERVICE_LEVELDB_START_TIME_READ_CACHE_SIZE
argument_list|)
expr_stmt|;
name|Preconditions
operator|.
name|checkArgument
argument_list|(
name|conf
operator|.
name|getLong
argument_list|(
name|YarnConfiguration
operator|.
name|TIMELINE_SERVICE_LEVELDB_START_TIME_WRITE_CACHE_SIZE
argument_list|,
name|YarnConfiguration
operator|.
name|DEFAULT_TIMELINE_SERVICE_LEVELDB_START_TIME_WRITE_CACHE_SIZE
argument_list|)
operator|>
literal|0
argument_list|,
literal|"%s property value should be greater than zero"
argument_list|,
name|YarnConfiguration
operator|.
name|TIMELINE_SERVICE_LEVELDB_START_TIME_WRITE_CACHE_SIZE
argument_list|)
expr_stmt|;
name|Options
name|options
init|=
operator|new
name|Options
argument_list|()
decl_stmt|;
name|options
operator|.
name|createIfMissing
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|options
operator|.
name|cacheSize
argument_list|(
name|conf
operator|.
name|getLong
argument_list|(
name|YarnConfiguration
operator|.
name|TIMELINE_SERVICE_LEVELDB_READ_CACHE_SIZE
argument_list|,
name|YarnConfiguration
operator|.
name|DEFAULT_TIMELINE_SERVICE_LEVELDB_READ_CACHE_SIZE
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|factory
operator|==
literal|null
condition|)
block|{
name|factory
operator|=
operator|new
name|JniDBFactory
argument_list|()
expr_stmt|;
block|}
name|Path
name|dbPath
init|=
operator|new
name|Path
argument_list|(
name|conf
operator|.
name|get
argument_list|(
name|YarnConfiguration
operator|.
name|TIMELINE_SERVICE_LEVELDB_PATH
argument_list|)
argument_list|,
name|FILENAME
argument_list|)
decl_stmt|;
name|FileSystem
name|localFS
init|=
literal|null
decl_stmt|;
try|try
block|{
name|localFS
operator|=
name|FileSystem
operator|.
name|getLocal
argument_list|(
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|localFS
operator|.
name|exists
argument_list|(
name|dbPath
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|localFS
operator|.
name|mkdirs
argument_list|(
name|dbPath
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Couldn't create directory for leveldb "
operator|+
literal|"timeline store "
operator|+
name|dbPath
argument_list|)
throw|;
block|}
name|localFS
operator|.
name|setPermission
argument_list|(
name|dbPath
argument_list|,
name|LEVELDB_DIR_UMASK
argument_list|)
expr_stmt|;
block|}
block|}
finally|finally
block|{
name|IOUtils
operator|.
name|cleanupWithLogger
argument_list|(
name|LOG
argument_list|,
name|localFS
argument_list|)
expr_stmt|;
block|}
name|LOG
operator|.
name|info
argument_list|(
literal|"Using leveldb path "
operator|+
name|dbPath
argument_list|)
expr_stmt|;
try|try
block|{
name|db
operator|=
name|factory
operator|.
name|open
argument_list|(
operator|new
name|File
argument_list|(
name|dbPath
operator|.
name|toString
argument_list|()
argument_list|)
argument_list|,
name|options
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ioe
parameter_list|)
block|{
name|File
name|dbFile
init|=
operator|new
name|File
argument_list|(
name|dbPath
operator|.
name|toString
argument_list|()
argument_list|)
decl_stmt|;
name|File
name|backupPath
init|=
operator|new
name|File
argument_list|(
name|dbPath
operator|.
name|toString
argument_list|()
operator|+
name|BACKUP_EXT
operator|+
name|Time
operator|.
name|monotonicNow
argument_list|()
argument_list|)
decl_stmt|;
name|LOG
operator|.
name|warn
argument_list|(
literal|"Incurred exception while loading LevelDb database. Backing "
operator|+
literal|"up at "
operator|+
name|backupPath
argument_list|,
name|ioe
argument_list|)
expr_stmt|;
name|FileUtils
operator|.
name|copyDirectory
argument_list|(
name|dbFile
argument_list|,
name|backupPath
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|warn
argument_list|(
literal|"Going to try repair"
argument_list|)
expr_stmt|;
name|factory
operator|.
name|repair
argument_list|(
name|dbFile
argument_list|,
name|options
argument_list|)
expr_stmt|;
name|db
operator|=
name|factory
operator|.
name|open
argument_list|(
name|dbFile
argument_list|,
name|options
argument_list|)
expr_stmt|;
block|}
name|checkVersion
argument_list|()
expr_stmt|;
name|startTimeWriteCache
operator|=
name|Collections
operator|.
name|synchronizedMap
argument_list|(
operator|new
name|LRUMap
argument_list|(
name|getStartTimeWriteCacheSize
argument_list|(
name|conf
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|startTimeReadCache
operator|=
name|Collections
operator|.
name|synchronizedMap
argument_list|(
operator|new
name|LRUMap
argument_list|(
name|getStartTimeReadCacheSize
argument_list|(
name|conf
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|.
name|getBoolean
argument_list|(
name|YarnConfiguration
operator|.
name|TIMELINE_SERVICE_TTL_ENABLE
argument_list|,
literal|true
argument_list|)
condition|)
block|{
name|deletionThread
operator|=
operator|new
name|EntityDeletionThread
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|deletionThread
operator|.
name|start
argument_list|()
expr_stmt|;
block|}
name|super
operator|.
name|serviceInit
argument_list|(
name|conf
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|serviceStop ()
specifier|protected
name|void
name|serviceStop
parameter_list|()
throws|throws
name|Exception
block|{
if|if
condition|(
name|deletionThread
operator|!=
literal|null
condition|)
block|{
name|deletionThread
operator|.
name|interrupt
argument_list|()
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Waiting for deletion thread to complete its current action"
argument_list|)
expr_stmt|;
try|try
block|{
name|deletionThread
operator|.
name|join
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Interrupted while waiting for deletion thread to complete,"
operator|+
literal|" closing db now"
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
name|IOUtils
operator|.
name|cleanupWithLogger
argument_list|(
name|LOG
argument_list|,
name|db
argument_list|)
expr_stmt|;
name|super
operator|.
name|serviceStop
argument_list|()
expr_stmt|;
block|}
DECL|class|StartAndInsertTime
specifier|private
specifier|static
class|class
name|StartAndInsertTime
block|{
DECL|field|startTime
specifier|final
name|long
name|startTime
decl_stmt|;
DECL|field|insertTime
specifier|final
name|long
name|insertTime
decl_stmt|;
DECL|method|StartAndInsertTime (long startTime, long insertTime)
specifier|public
name|StartAndInsertTime
parameter_list|(
name|long
name|startTime
parameter_list|,
name|long
name|insertTime
parameter_list|)
block|{
name|this
operator|.
name|startTime
operator|=
name|startTime
expr_stmt|;
name|this
operator|.
name|insertTime
operator|=
name|insertTime
expr_stmt|;
block|}
block|}
DECL|class|EntityDeletionThread
specifier|private
class|class
name|EntityDeletionThread
extends|extends
name|Thread
block|{
DECL|field|ttl
specifier|private
specifier|final
name|long
name|ttl
decl_stmt|;
DECL|field|ttlInterval
specifier|private
specifier|final
name|long
name|ttlInterval
decl_stmt|;
DECL|method|EntityDeletionThread (Configuration conf)
specifier|public
name|EntityDeletionThread
parameter_list|(
name|Configuration
name|conf
parameter_list|)
block|{
name|ttl
operator|=
name|conf
operator|.
name|getLong
argument_list|(
name|YarnConfiguration
operator|.
name|TIMELINE_SERVICE_TTL_MS
argument_list|,
name|YarnConfiguration
operator|.
name|DEFAULT_TIMELINE_SERVICE_TTL_MS
argument_list|)
expr_stmt|;
name|ttlInterval
operator|=
name|conf
operator|.
name|getLong
argument_list|(
name|YarnConfiguration
operator|.
name|TIMELINE_SERVICE_LEVELDB_TTL_INTERVAL_MS
argument_list|,
name|YarnConfiguration
operator|.
name|DEFAULT_TIMELINE_SERVICE_LEVELDB_TTL_INTERVAL_MS
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Starting deletion thread with ttl "
operator|+
name|ttl
operator|+
literal|" and cycle "
operator|+
literal|"interval "
operator|+
name|ttlInterval
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|run ()
specifier|public
name|void
name|run
parameter_list|()
block|{
while|while
condition|(
literal|true
condition|)
block|{
name|long
name|timestamp
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|ttl
decl_stmt|;
try|try
block|{
name|discardOldEntities
argument_list|(
name|timestamp
argument_list|)
expr_stmt|;
name|Thread
operator|.
name|sleep
argument_list|(
name|ttlInterval
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
name|e
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Deletion thread received interrupt, exiting"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
DECL|class|LockMap
specifier|private
specifier|static
class|class
name|LockMap
parameter_list|<
name|K
parameter_list|>
block|{
DECL|class|CountingReentrantLock
specifier|private
specifier|static
class|class
name|CountingReentrantLock
parameter_list|<
name|K
parameter_list|>
extends|extends
name|ReentrantLock
block|{
DECL|field|serialVersionUID
specifier|private
specifier|static
specifier|final
name|long
name|serialVersionUID
init|=
literal|1L
decl_stmt|;
DECL|field|count
specifier|private
name|int
name|count
decl_stmt|;
DECL|field|key
specifier|private
name|K
name|key
decl_stmt|;
DECL|method|CountingReentrantLock (K key)
name|CountingReentrantLock
parameter_list|(
name|K
name|key
parameter_list|)
block|{
name|super
argument_list|()
expr_stmt|;
name|this
operator|.
name|count
operator|=
literal|0
expr_stmt|;
name|this
operator|.
name|key
operator|=
name|key
expr_stmt|;
block|}
block|}
DECL|field|locks
specifier|private
name|Map
argument_list|<
name|K
argument_list|,
name|CountingReentrantLock
argument_list|<
name|K
argument_list|>
argument_list|>
name|locks
init|=
operator|new
name|HashMap
argument_list|<
name|K
argument_list|,
name|CountingReentrantLock
argument_list|<
name|K
argument_list|>
argument_list|>
argument_list|()
decl_stmt|;
DECL|method|getLock (K key)
specifier|synchronized
name|CountingReentrantLock
argument_list|<
name|K
argument_list|>
name|getLock
parameter_list|(
name|K
name|key
parameter_list|)
block|{
name|CountingReentrantLock
argument_list|<
name|K
argument_list|>
name|lock
init|=
name|locks
operator|.
name|get
argument_list|(
name|key
argument_list|)
decl_stmt|;
if|if
condition|(
name|lock
operator|==
literal|null
condition|)
block|{
name|lock
operator|=
operator|new
name|CountingReentrantLock
argument_list|<
name|K
argument_list|>
argument_list|(
name|key
argument_list|)
expr_stmt|;
name|locks
operator|.
name|put
argument_list|(
name|key
argument_list|,
name|lock
argument_list|)
expr_stmt|;
block|}
name|lock
operator|.
name|count
operator|++
expr_stmt|;
return|return
name|lock
return|;
block|}
DECL|method|returnLock (CountingReentrantLock<K> lock)
specifier|synchronized
name|void
name|returnLock
parameter_list|(
name|CountingReentrantLock
argument_list|<
name|K
argument_list|>
name|lock
parameter_list|)
block|{
if|if
condition|(
name|lock
operator|.
name|count
operator|==
literal|0
condition|)
block|{
throw|throw
operator|new
name|IllegalStateException
argument_list|(
literal|"Returned lock more times than it "
operator|+
literal|"was retrieved"
argument_list|)
throw|;
block|}
name|lock
operator|.
name|count
operator|--
expr_stmt|;
if|if
condition|(
name|lock
operator|.
name|count
operator|==
literal|0
condition|)
block|{
name|locks
operator|.
name|remove
argument_list|(
name|lock
operator|.
name|key
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Override
DECL|method|getEntity (String entityId, String entityType, EnumSet<Field> fields)
specifier|public
name|TimelineEntity
name|getEntity
parameter_list|(
name|String
name|entityId
parameter_list|,
name|String
name|entityType
parameter_list|,
name|EnumSet
argument_list|<
name|Field
argument_list|>
name|fields
parameter_list|)
throws|throws
name|IOException
block|{
name|Long
name|revStartTime
init|=
name|getStartTimeLong
argument_list|(
name|entityId
argument_list|,
name|entityType
argument_list|)
decl_stmt|;
if|if
condition|(
name|revStartTime
operator|==
literal|null
condition|)
block|{
return|return
literal|null
return|;
block|}
name|byte
index|[]
name|prefix
init|=
name|KeyBuilder
operator|.
name|newInstance
argument_list|()
operator|.
name|add
argument_list|(
name|ENTITY_ENTRY_PREFIX
argument_list|)
operator|.
name|add
argument_list|(
name|entityType
argument_list|)
operator|.
name|add
argument_list|(
name|writeReverseOrderedLong
argument_list|(
name|revStartTime
argument_list|)
argument_list|)
operator|.
name|add
argument_list|(
name|entityId
argument_list|)
operator|.
name|getBytesForLookup
argument_list|()
decl_stmt|;
name|LeveldbIterator
name|iterator
init|=
literal|null
decl_stmt|;
try|try
block|{
name|iterator
operator|=
operator|new
name|LeveldbIterator
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|iterator
operator|.
name|seek
argument_list|(
name|prefix
argument_list|)
expr_stmt|;
if|if
condition|(
name|fields
operator|==
literal|null
condition|)
block|{
name|fields
operator|=
name|EnumSet
operator|.
name|allOf
argument_list|(
name|Field
operator|.
name|class
argument_list|)
expr_stmt|;
block|}
return|return
name|getEntity
argument_list|(
name|entityId
argument_list|,
name|entityType
argument_list|,
name|revStartTime
argument_list|,
name|fields
argument_list|,
name|iterator
argument_list|,
name|prefix
argument_list|,
name|prefix
operator|.
name|length
argument_list|)
return|;
block|}
catch|catch
parameter_list|(
name|DBException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
name|IOUtils
operator|.
name|cleanupWithLogger
argument_list|(
name|LOG
argument_list|,
name|iterator
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**    * Read entity from a db iterator.  If no information is found in the    * specified fields for this entity, return null.    */
DECL|method|getEntity (String entityId, String entityType, Long startTime, EnumSet<Field> fields, LeveldbIterator iterator, byte[] prefix, int prefixlen)
specifier|private
specifier|static
name|TimelineEntity
name|getEntity
parameter_list|(
name|String
name|entityId
parameter_list|,
name|String
name|entityType
parameter_list|,
name|Long
name|startTime
parameter_list|,
name|EnumSet
argument_list|<
name|Field
argument_list|>
name|fields
parameter_list|,
name|LeveldbIterator
name|iterator
parameter_list|,
name|byte
index|[]
name|prefix
parameter_list|,
name|int
name|prefixlen
parameter_list|)
throws|throws
name|IOException
block|{
name|TimelineEntity
name|entity
init|=
operator|new
name|TimelineEntity
argument_list|()
decl_stmt|;
name|boolean
name|events
init|=
literal|false
decl_stmt|;
name|boolean
name|lastEvent
init|=
literal|false
decl_stmt|;
if|if
condition|(
name|fields
operator|.
name|contains
argument_list|(
name|Field
operator|.
name|EVENTS
argument_list|)
condition|)
block|{
name|events
operator|=
literal|true
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fields
operator|.
name|contains
argument_list|(
name|Field
operator|.
name|LAST_EVENT_ONLY
argument_list|)
condition|)
block|{
name|lastEvent
operator|=
literal|true
expr_stmt|;
block|}
else|else
block|{
name|entity
operator|.
name|setEvents
argument_list|(
literal|null
argument_list|)
expr_stmt|;
block|}
name|boolean
name|relatedEntities
init|=
literal|false
decl_stmt|;
if|if
condition|(
name|fields
operator|.
name|contains
argument_list|(
name|Field
operator|.
name|RELATED_ENTITIES
argument_list|)
condition|)
block|{
name|relatedEntities
operator|=
literal|true
expr_stmt|;
block|}
else|else
block|{
name|entity
operator|.
name|setRelatedEntities
argument_list|(
literal|null
argument_list|)
expr_stmt|;
block|}
name|boolean
name|primaryFilters
init|=
literal|false
decl_stmt|;
if|if
condition|(
name|fields
operator|.
name|contains
argument_list|(
name|Field
operator|.
name|PRIMARY_FILTERS
argument_list|)
condition|)
block|{
name|primaryFilters
operator|=
literal|true
expr_stmt|;
block|}
else|else
block|{
name|entity
operator|.
name|setPrimaryFilters
argument_list|(
literal|null
argument_list|)
expr_stmt|;
block|}
name|boolean
name|otherInfo
init|=
literal|false
decl_stmt|;
if|if
condition|(
name|fields
operator|.
name|contains
argument_list|(
name|Field
operator|.
name|OTHER_INFO
argument_list|)
condition|)
block|{
name|otherInfo
operator|=
literal|true
expr_stmt|;
block|}
else|else
block|{
name|entity
operator|.
name|setOtherInfo
argument_list|(
literal|null
argument_list|)
expr_stmt|;
block|}
comment|// iterate through the entity's entry, parsing information if it is part
comment|// of a requested field
for|for
control|(
init|;
name|iterator
operator|.
name|hasNext
argument_list|()
condition|;
name|iterator
operator|.
name|next
argument_list|()
control|)
block|{
name|byte
index|[]
name|key
init|=
name|iterator
operator|.
name|peekNext
argument_list|()
operator|.
name|getKey
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|prefixMatches
argument_list|(
name|prefix
argument_list|,
name|prefixlen
argument_list|,
name|key
argument_list|)
condition|)
block|{
break|break;
block|}
if|if
condition|(
name|key
operator|.
name|length
operator|==
name|prefixlen
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|key
index|[
name|prefixlen
index|]
operator|==
name|PRIMARY_FILTERS_COLUMN
index|[
literal|0
index|]
condition|)
block|{
if|if
condition|(
name|primaryFilters
condition|)
block|{
name|addPrimaryFilter
argument_list|(
name|entity
argument_list|,
name|key
argument_list|,
name|prefixlen
operator|+
name|PRIMARY_FILTERS_COLUMN
operator|.
name|length
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|key
index|[
name|prefixlen
index|]
operator|==
name|OTHER_INFO_COLUMN
index|[
literal|0
index|]
condition|)
block|{
if|if
condition|(
name|otherInfo
condition|)
block|{
name|entity
operator|.
name|addOtherInfo
argument_list|(
name|parseRemainingKey
argument_list|(
name|key
argument_list|,
name|prefixlen
operator|+
name|OTHER_INFO_COLUMN
operator|.
name|length
argument_list|)
argument_list|,
name|GenericObjectMapper
operator|.
name|read
argument_list|(
name|iterator
operator|.
name|peekNext
argument_list|()
operator|.
name|getValue
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|key
index|[
name|prefixlen
index|]
operator|==
name|RELATED_ENTITIES_COLUMN
index|[
literal|0
index|]
condition|)
block|{
if|if
condition|(
name|relatedEntities
condition|)
block|{
name|addRelatedEntity
argument_list|(
name|entity
argument_list|,
name|key
argument_list|,
name|prefixlen
operator|+
name|RELATED_ENTITIES_COLUMN
operator|.
name|length
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|key
index|[
name|prefixlen
index|]
operator|==
name|EVENTS_COLUMN
index|[
literal|0
index|]
condition|)
block|{
if|if
condition|(
name|events
operator|||
operator|(
name|lastEvent
operator|&&
name|entity
operator|.
name|getEvents
argument_list|()
operator|.
name|size
argument_list|()
operator|==
literal|0
operator|)
condition|)
block|{
name|TimelineEvent
name|event
init|=
name|getEntityEvent
argument_list|(
literal|null
argument_list|,
name|key
argument_list|,
name|prefixlen
operator|+
name|EVENTS_COLUMN
operator|.
name|length
argument_list|,
name|iterator
operator|.
name|peekNext
argument_list|()
operator|.
name|getValue
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|event
operator|!=
literal|null
condition|)
block|{
name|entity
operator|.
name|addEvent
argument_list|(
name|event
argument_list|)
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|key
index|[
name|prefixlen
index|]
operator|==
name|DOMAIN_ID_COLUMN
index|[
literal|0
index|]
condition|)
block|{
name|byte
index|[]
name|v
init|=
name|iterator
operator|.
name|peekNext
argument_list|()
operator|.
name|getValue
argument_list|()
decl_stmt|;
name|String
name|domainId
init|=
operator|new
name|String
argument_list|(
name|v
argument_list|,
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
decl_stmt|;
name|entity
operator|.
name|setDomainId
argument_list|(
name|domainId
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|key
index|[
name|prefixlen
index|]
operator|!=
name|INVISIBLE_REVERSE_RELATED_ENTITIES_COLUMN
index|[
literal|0
index|]
condition|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"Found unexpected column for entity %s of "
operator|+
literal|"type %s (0x%02x)"
argument_list|,
name|entityId
argument_list|,
name|entityType
argument_list|,
name|key
index|[
name|prefixlen
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|entity
operator|.
name|setEntityId
argument_list|(
name|entityId
argument_list|)
expr_stmt|;
name|entity
operator|.
name|setEntityType
argument_list|(
name|entityType
argument_list|)
expr_stmt|;
name|entity
operator|.
name|setStartTime
argument_list|(
name|startTime
argument_list|)
expr_stmt|;
return|return
name|entity
return|;
block|}
annotation|@
name|Override
DECL|method|getEntityTimelines (String entityType, SortedSet<String> entityIds, Long limit, Long windowStart, Long windowEnd, Set<String> eventType)
specifier|public
name|TimelineEvents
name|getEntityTimelines
parameter_list|(
name|String
name|entityType
parameter_list|,
name|SortedSet
argument_list|<
name|String
argument_list|>
name|entityIds
parameter_list|,
name|Long
name|limit
parameter_list|,
name|Long
name|windowStart
parameter_list|,
name|Long
name|windowEnd
parameter_list|,
name|Set
argument_list|<
name|String
argument_list|>
name|eventType
parameter_list|)
throws|throws
name|IOException
block|{
name|TimelineEvents
name|events
init|=
operator|new
name|TimelineEvents
argument_list|()
decl_stmt|;
if|if
condition|(
name|entityIds
operator|==
literal|null
operator|||
name|entityIds
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
return|return
name|events
return|;
block|}
comment|// create a lexicographically-ordered map from start time to entities
name|Map
argument_list|<
name|byte
index|[]
argument_list|,
name|List
argument_list|<
name|EntityIdentifier
argument_list|>
argument_list|>
name|startTimeMap
init|=
operator|new
name|TreeMap
argument_list|<
name|byte
index|[]
argument_list|,
name|List
argument_list|<
name|EntityIdentifier
argument_list|>
argument_list|>
argument_list|(
operator|new
name|Comparator
argument_list|<
name|byte
index|[]
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|int
name|compare
parameter_list|(
name|byte
index|[]
name|o1
parameter_list|,
name|byte
index|[]
name|o2
parameter_list|)
block|{
return|return
name|WritableComparator
operator|.
name|compareBytes
argument_list|(
name|o1
argument_list|,
literal|0
argument_list|,
name|o1
operator|.
name|length
argument_list|,
name|o2
argument_list|,
literal|0
argument_list|,
name|o2
operator|.
name|length
argument_list|)
return|;
block|}
block|}
argument_list|)
decl_stmt|;
name|LeveldbIterator
name|iterator
init|=
literal|null
decl_stmt|;
try|try
block|{
comment|// look up start times for the specified entities
comment|// skip entities with no start time
for|for
control|(
name|String
name|entityId
range|:
name|entityIds
control|)
block|{
name|byte
index|[]
name|startTime
init|=
name|getStartTime
argument_list|(
name|entityId
argument_list|,
name|entityType
argument_list|)
decl_stmt|;
if|if
condition|(
name|startTime
operator|!=
literal|null
condition|)
block|{
name|List
argument_list|<
name|EntityIdentifier
argument_list|>
name|entities
init|=
name|startTimeMap
operator|.
name|get
argument_list|(
name|startTime
argument_list|)
decl_stmt|;
if|if
condition|(
name|entities
operator|==
literal|null
condition|)
block|{
name|entities
operator|=
operator|new
name|ArrayList
argument_list|<
name|EntityIdentifier
argument_list|>
argument_list|()
expr_stmt|;
name|startTimeMap
operator|.
name|put
argument_list|(
name|startTime
argument_list|,
name|entities
argument_list|)
expr_stmt|;
block|}
name|entities
operator|.
name|add
argument_list|(
operator|new
name|EntityIdentifier
argument_list|(
name|entityId
argument_list|,
name|entityType
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|Entry
argument_list|<
name|byte
index|[]
argument_list|,
name|List
argument_list|<
name|EntityIdentifier
argument_list|>
argument_list|>
name|entry
range|:
name|startTimeMap
operator|.
name|entrySet
argument_list|()
control|)
block|{
comment|// look up the events matching the given parameters (limit,
comment|// start time, end time, event types) for entities whose start times
comment|// were found and add the entities to the return list
name|byte
index|[]
name|revStartTime
init|=
name|entry
operator|.
name|getKey
argument_list|()
decl_stmt|;
for|for
control|(
name|EntityIdentifier
name|entityIdentifier
range|:
name|entry
operator|.
name|getValue
argument_list|()
control|)
block|{
name|EventsOfOneEntity
name|entity
init|=
operator|new
name|EventsOfOneEntity
argument_list|()
decl_stmt|;
name|entity
operator|.
name|setEntityId
argument_list|(
name|entityIdentifier
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|entity
operator|.
name|setEntityType
argument_list|(
name|entityType
argument_list|)
expr_stmt|;
name|events
operator|.
name|addEvent
argument_list|(
name|entity
argument_list|)
expr_stmt|;
name|KeyBuilder
name|kb
init|=
name|KeyBuilder
operator|.
name|newInstance
argument_list|()
operator|.
name|add
argument_list|(
name|ENTITY_ENTRY_PREFIX
argument_list|)
operator|.
name|add
argument_list|(
name|entityType
argument_list|)
operator|.
name|add
argument_list|(
name|revStartTime
argument_list|)
operator|.
name|add
argument_list|(
name|entityIdentifier
operator|.
name|getId
argument_list|()
argument_list|)
operator|.
name|add
argument_list|(
name|EVENTS_COLUMN
argument_list|)
decl_stmt|;
name|byte
index|[]
name|prefix
init|=
name|kb
operator|.
name|getBytesForLookup
argument_list|()
decl_stmt|;
if|if
condition|(
name|windowEnd
operator|==
literal|null
condition|)
block|{
name|windowEnd
operator|=
name|Long
operator|.
name|MAX_VALUE
expr_stmt|;
block|}
name|byte
index|[]
name|revts
init|=
name|writeReverseOrderedLong
argument_list|(
name|windowEnd
argument_list|)
decl_stmt|;
name|kb
operator|.
name|add
argument_list|(
name|revts
argument_list|)
expr_stmt|;
name|byte
index|[]
name|first
init|=
name|kb
operator|.
name|getBytesForLookup
argument_list|()
decl_stmt|;
name|byte
index|[]
name|last
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|windowStart
operator|!=
literal|null
condition|)
block|{
name|last
operator|=
name|KeyBuilder
operator|.
name|newInstance
argument_list|()
operator|.
name|add
argument_list|(
name|prefix
argument_list|)
operator|.
name|add
argument_list|(
name|writeReverseOrderedLong
argument_list|(
name|windowStart
argument_list|)
argument_list|)
operator|.
name|getBytesForLookup
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|limit
operator|==
literal|null
condition|)
block|{
name|limit
operator|=
name|DEFAULT_LIMIT
expr_stmt|;
block|}
name|iterator
operator|=
operator|new
name|LeveldbIterator
argument_list|(
name|db
argument_list|)
expr_stmt|;
for|for
control|(
name|iterator
operator|.
name|seek
argument_list|(
name|first
argument_list|)
init|;
name|entity
operator|.
name|getEvents
argument_list|()
operator|.
name|size
argument_list|()
operator|<
name|limit
operator|&&
name|iterator
operator|.
name|hasNext
argument_list|()
condition|;
name|iterator
operator|.
name|next
argument_list|()
control|)
block|{
name|byte
index|[]
name|key
init|=
name|iterator
operator|.
name|peekNext
argument_list|()
operator|.
name|getKey
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|prefixMatches
argument_list|(
name|prefix
argument_list|,
name|prefix
operator|.
name|length
argument_list|,
name|key
argument_list|)
operator|||
operator|(
name|last
operator|!=
literal|null
operator|&&
name|WritableComparator
operator|.
name|compareBytes
argument_list|(
name|key
argument_list|,
literal|0
argument_list|,
name|key
operator|.
name|length
argument_list|,
name|last
argument_list|,
literal|0
argument_list|,
name|last
operator|.
name|length
argument_list|)
operator|>
literal|0
operator|)
condition|)
block|{
break|break;
block|}
name|TimelineEvent
name|event
init|=
name|getEntityEvent
argument_list|(
name|eventType
argument_list|,
name|key
argument_list|,
name|prefix
operator|.
name|length
argument_list|,
name|iterator
operator|.
name|peekNext
argument_list|()
operator|.
name|getValue
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|event
operator|!=
literal|null
condition|)
block|{
name|entity
operator|.
name|addEvent
argument_list|(
name|event
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
catch|catch
parameter_list|(
name|DBException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
name|IOUtils
operator|.
name|cleanupWithLogger
argument_list|(
name|LOG
argument_list|,
name|iterator
argument_list|)
expr_stmt|;
block|}
return|return
name|events
return|;
block|}
annotation|@
name|Override
DECL|method|getEntities (String entityType, Long limit, Long windowStart, Long windowEnd, String fromId, Long fromTs, NameValuePair primaryFilter, Collection<NameValuePair> secondaryFilters, EnumSet<Field> fields, CheckAcl checkAcl)
specifier|public
name|TimelineEntities
name|getEntities
parameter_list|(
name|String
name|entityType
parameter_list|,
name|Long
name|limit
parameter_list|,
name|Long
name|windowStart
parameter_list|,
name|Long
name|windowEnd
parameter_list|,
name|String
name|fromId
parameter_list|,
name|Long
name|fromTs
parameter_list|,
name|NameValuePair
name|primaryFilter
parameter_list|,
name|Collection
argument_list|<
name|NameValuePair
argument_list|>
name|secondaryFilters
parameter_list|,
name|EnumSet
argument_list|<
name|Field
argument_list|>
name|fields
parameter_list|,
name|CheckAcl
name|checkAcl
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
name|primaryFilter
operator|==
literal|null
condition|)
block|{
comment|// if no primary filter is specified, prefix the lookup with
comment|// ENTITY_ENTRY_PREFIX
return|return
name|getEntityByTime
argument_list|(
name|ENTITY_ENTRY_PREFIX
argument_list|,
name|entityType
argument_list|,
name|limit
argument_list|,
name|windowStart
argument_list|,
name|windowEnd
argument_list|,
name|fromId
argument_list|,
name|fromTs
argument_list|,
name|secondaryFilters
argument_list|,
name|fields
argument_list|,
name|checkAcl
argument_list|)
return|;
block|}
else|else
block|{
comment|// if a primary filter is specified, prefix the lookup with
comment|// INDEXED_ENTRY_PREFIX + primaryFilterName + primaryFilterValue +
comment|// ENTITY_ENTRY_PREFIX
name|byte
index|[]
name|base
init|=
name|KeyBuilder
operator|.
name|newInstance
argument_list|()
operator|.
name|add
argument_list|(
name|INDEXED_ENTRY_PREFIX
argument_list|)
operator|.
name|add
argument_list|(
name|primaryFilter
operator|.
name|getName
argument_list|()
argument_list|)
operator|.
name|add
argument_list|(
name|GenericObjectMapper
operator|.
name|write
argument_list|(
name|primaryFilter
operator|.
name|getValue
argument_list|()
argument_list|)
argument_list|,
literal|true
argument_list|)
operator|.
name|add
argument_list|(
name|ENTITY_ENTRY_PREFIX
argument_list|)
operator|.
name|getBytesForLookup
argument_list|()
decl_stmt|;
return|return
name|getEntityByTime
argument_list|(
name|base
argument_list|,
name|entityType
argument_list|,
name|limit
argument_list|,
name|windowStart
argument_list|,
name|windowEnd
argument_list|,
name|fromId
argument_list|,
name|fromTs
argument_list|,
name|secondaryFilters
argument_list|,
name|fields
argument_list|,
name|checkAcl
argument_list|)
return|;
block|}
block|}
comment|/**    * Retrieves a list of entities satisfying given parameters.    *    * @param base A byte array prefix for the lookup    * @param entityType The type of the entity    * @param limit A limit on the number of entities to return    * @param starttime The earliest entity start time to retrieve (exclusive)    * @param endtime The latest entity start time to retrieve (inclusive)    * @param fromId Retrieve entities starting with this entity    * @param fromTs Ignore entities with insert timestamp later than this ts    * @param secondaryFilters Filter pairs that the entities should match    * @param fields The set of fields to retrieve    * @return A list of entities    * @throws IOException    */
DECL|method|getEntityByTime (byte[] base, String entityType, Long limit, Long starttime, Long endtime, String fromId, Long fromTs, Collection<NameValuePair> secondaryFilters, EnumSet<Field> fields, CheckAcl checkAcl)
specifier|private
name|TimelineEntities
name|getEntityByTime
parameter_list|(
name|byte
index|[]
name|base
parameter_list|,
name|String
name|entityType
parameter_list|,
name|Long
name|limit
parameter_list|,
name|Long
name|starttime
parameter_list|,
name|Long
name|endtime
parameter_list|,
name|String
name|fromId
parameter_list|,
name|Long
name|fromTs
parameter_list|,
name|Collection
argument_list|<
name|NameValuePair
argument_list|>
name|secondaryFilters
parameter_list|,
name|EnumSet
argument_list|<
name|Field
argument_list|>
name|fields
parameter_list|,
name|CheckAcl
name|checkAcl
parameter_list|)
throws|throws
name|IOException
block|{
comment|// Even if other info and primary filter fields are not included, we
comment|// still need to load them to match secondary filters when they are
comment|// non-empty
if|if
condition|(
name|fields
operator|==
literal|null
condition|)
block|{
name|fields
operator|=
name|EnumSet
operator|.
name|allOf
argument_list|(
name|Field
operator|.
name|class
argument_list|)
expr_stmt|;
block|}
name|boolean
name|addPrimaryFilters
init|=
literal|false
decl_stmt|;
name|boolean
name|addOtherInfo
init|=
literal|false
decl_stmt|;
if|if
condition|(
name|secondaryFilters
operator|!=
literal|null
operator|&&
name|secondaryFilters
operator|.
name|size
argument_list|()
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|fields
operator|.
name|contains
argument_list|(
name|Field
operator|.
name|PRIMARY_FILTERS
argument_list|)
condition|)
block|{
name|fields
operator|.
name|add
argument_list|(
name|Field
operator|.
name|PRIMARY_FILTERS
argument_list|)
expr_stmt|;
name|addPrimaryFilters
operator|=
literal|true
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|fields
operator|.
name|contains
argument_list|(
name|Field
operator|.
name|OTHER_INFO
argument_list|)
condition|)
block|{
name|fields
operator|.
name|add
argument_list|(
name|Field
operator|.
name|OTHER_INFO
argument_list|)
expr_stmt|;
name|addOtherInfo
operator|=
literal|true
expr_stmt|;
block|}
block|}
name|LeveldbIterator
name|iterator
init|=
literal|null
decl_stmt|;
try|try
block|{
name|KeyBuilder
name|kb
init|=
name|KeyBuilder
operator|.
name|newInstance
argument_list|()
operator|.
name|add
argument_list|(
name|base
argument_list|)
operator|.
name|add
argument_list|(
name|entityType
argument_list|)
decl_stmt|;
comment|// only db keys matching the prefix (base + entity type) will be parsed
name|byte
index|[]
name|prefix
init|=
name|kb
operator|.
name|getBytesForLookup
argument_list|()
decl_stmt|;
if|if
condition|(
name|endtime
operator|==
literal|null
condition|)
block|{
comment|// if end time is null, place no restriction on end time
name|endtime
operator|=
name|Long
operator|.
name|MAX_VALUE
expr_stmt|;
block|}
comment|// construct a first key that will be seeked to using end time or fromId
name|byte
index|[]
name|first
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|fromId
operator|!=
literal|null
condition|)
block|{
name|Long
name|fromIdStartTime
init|=
name|getStartTimeLong
argument_list|(
name|fromId
argument_list|,
name|entityType
argument_list|)
decl_stmt|;
if|if
condition|(
name|fromIdStartTime
operator|==
literal|null
condition|)
block|{
comment|// no start time for provided id, so return empty entities
return|return
operator|new
name|TimelineEntities
argument_list|()
return|;
block|}
if|if
condition|(
name|fromIdStartTime
operator|<=
name|endtime
condition|)
block|{
comment|// if provided id's start time falls before the end of the window,
comment|// use it to construct the seek key
name|first
operator|=
name|kb
operator|.
name|add
argument_list|(
name|writeReverseOrderedLong
argument_list|(
name|fromIdStartTime
argument_list|)
argument_list|)
operator|.
name|add
argument_list|(
name|fromId
argument_list|)
operator|.
name|getBytesForLookup
argument_list|()
expr_stmt|;
block|}
block|}
comment|// if seek key wasn't constructed using fromId, construct it using end ts
if|if
condition|(
name|first
operator|==
literal|null
condition|)
block|{
name|first
operator|=
name|kb
operator|.
name|add
argument_list|(
name|writeReverseOrderedLong
argument_list|(
name|endtime
argument_list|)
argument_list|)
operator|.
name|getBytesForLookup
argument_list|()
expr_stmt|;
block|}
name|byte
index|[]
name|last
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|starttime
operator|!=
literal|null
condition|)
block|{
comment|// if start time is not null, set a last key that will not be
comment|// iterated past
name|last
operator|=
name|KeyBuilder
operator|.
name|newInstance
argument_list|()
operator|.
name|add
argument_list|(
name|base
argument_list|)
operator|.
name|add
argument_list|(
name|entityType
argument_list|)
operator|.
name|add
argument_list|(
name|writeReverseOrderedLong
argument_list|(
name|starttime
argument_list|)
argument_list|)
operator|.
name|getBytesForLookup
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|limit
operator|==
literal|null
condition|)
block|{
comment|// if limit is not specified, use the default
name|limit
operator|=
name|DEFAULT_LIMIT
expr_stmt|;
block|}
name|TimelineEntities
name|entities
init|=
operator|new
name|TimelineEntities
argument_list|()
decl_stmt|;
name|iterator
operator|=
operator|new
name|LeveldbIterator
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|iterator
operator|.
name|seek
argument_list|(
name|first
argument_list|)
expr_stmt|;
comment|// iterate until one of the following conditions is met: limit is
comment|// reached, there are no more keys, the key prefix no longer matches,
comment|// or a start time has been specified and reached/exceeded
while|while
condition|(
name|entities
operator|.
name|getEntities
argument_list|()
operator|.
name|size
argument_list|()
operator|<
name|limit
operator|&&
name|iterator
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|byte
index|[]
name|key
init|=
name|iterator
operator|.
name|peekNext
argument_list|()
operator|.
name|getKey
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|prefixMatches
argument_list|(
name|prefix
argument_list|,
name|prefix
operator|.
name|length
argument_list|,
name|key
argument_list|)
operator|||
operator|(
name|last
operator|!=
literal|null
operator|&&
name|WritableComparator
operator|.
name|compareBytes
argument_list|(
name|key
argument_list|,
literal|0
argument_list|,
name|key
operator|.
name|length
argument_list|,
name|last
argument_list|,
literal|0
argument_list|,
name|last
operator|.
name|length
argument_list|)
operator|>
literal|0
operator|)
condition|)
block|{
break|break;
block|}
comment|// read the start time and entity id from the current key
name|KeyParser
name|kp
init|=
operator|new
name|KeyParser
argument_list|(
name|key
argument_list|,
name|prefix
operator|.
name|length
argument_list|)
decl_stmt|;
name|Long
name|startTime
init|=
name|kp
operator|.
name|getNextLong
argument_list|()
decl_stmt|;
name|String
name|entityId
init|=
name|kp
operator|.
name|getNextString
argument_list|()
decl_stmt|;
if|if
condition|(
name|fromTs
operator|!=
literal|null
condition|)
block|{
name|long
name|insertTime
init|=
name|readReverseOrderedLong
argument_list|(
name|iterator
operator|.
name|peekNext
argument_list|()
operator|.
name|getValue
argument_list|()
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|insertTime
operator|>
name|fromTs
condition|)
block|{
name|byte
index|[]
name|firstKey
init|=
name|key
decl_stmt|;
while|while
condition|(
name|iterator
operator|.
name|hasNext
argument_list|()
operator|&&
name|prefixMatches
argument_list|(
name|firstKey
argument_list|,
name|kp
operator|.
name|getOffset
argument_list|()
argument_list|,
name|key
argument_list|)
condition|)
block|{
name|iterator
operator|.
name|next
argument_list|()
expr_stmt|;
name|key
operator|=
name|iterator
operator|.
name|peekNext
argument_list|()
operator|.
name|getKey
argument_list|()
expr_stmt|;
block|}
continue|continue;
block|}
block|}
comment|// parse the entity that owns this key, iterating over all keys for
comment|// the entity
name|TimelineEntity
name|entity
init|=
name|getEntity
argument_list|(
name|entityId
argument_list|,
name|entityType
argument_list|,
name|startTime
argument_list|,
name|fields
argument_list|,
name|iterator
argument_list|,
name|key
argument_list|,
name|kp
operator|.
name|getOffset
argument_list|()
argument_list|)
decl_stmt|;
comment|// determine if the retrieved entity matches the provided secondary
comment|// filters, and if so add it to the list of entities to return
name|boolean
name|filterPassed
init|=
literal|true
decl_stmt|;
if|if
condition|(
name|secondaryFilters
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|NameValuePair
name|filter
range|:
name|secondaryFilters
control|)
block|{
name|Object
name|v
init|=
name|entity
operator|.
name|getOtherInfo
argument_list|()
operator|.
name|get
argument_list|(
name|filter
operator|.
name|getName
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|v
operator|==
literal|null
condition|)
block|{
name|Set
argument_list|<
name|Object
argument_list|>
name|vs
init|=
name|entity
operator|.
name|getPrimaryFilters
argument_list|()
operator|.
name|get
argument_list|(
name|filter
operator|.
name|getName
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|vs
operator|==
literal|null
operator|||
operator|!
name|vs
operator|.
name|contains
argument_list|(
name|filter
operator|.
name|getValue
argument_list|()
argument_list|)
condition|)
block|{
name|filterPassed
operator|=
literal|false
expr_stmt|;
break|break;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|v
operator|.
name|equals
argument_list|(
name|filter
operator|.
name|getValue
argument_list|()
argument_list|)
condition|)
block|{
name|filterPassed
operator|=
literal|false
expr_stmt|;
break|break;
block|}
block|}
block|}
if|if
condition|(
name|filterPassed
condition|)
block|{
if|if
condition|(
name|entity
operator|.
name|getDomainId
argument_list|()
operator|==
literal|null
condition|)
block|{
name|entity
operator|.
name|setDomainId
argument_list|(
name|DEFAULT_DOMAIN_ID
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|checkAcl
operator|==
literal|null
operator|||
name|checkAcl
operator|.
name|check
argument_list|(
name|entity
argument_list|)
condition|)
block|{
comment|// Remove primary filter and other info if they are added for
comment|// matching secondary filters
if|if
condition|(
name|addPrimaryFilters
condition|)
block|{
name|entity
operator|.
name|setPrimaryFilters
argument_list|(
literal|null
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|addOtherInfo
condition|)
block|{
name|entity
operator|.
name|setOtherInfo
argument_list|(
literal|null
argument_list|)
expr_stmt|;
block|}
name|entities
operator|.
name|addEntity
argument_list|(
name|entity
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return
name|entities
return|;
block|}
catch|catch
parameter_list|(
name|DBException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
name|IOUtils
operator|.
name|cleanupWithLogger
argument_list|(
name|LOG
argument_list|,
name|iterator
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**    * Handle error and set it in response.    */
DECL|method|handleError (TimelineEntity entity, TimelinePutResponse response, final int errorCode)
specifier|private
specifier|static
name|void
name|handleError
parameter_list|(
name|TimelineEntity
name|entity
parameter_list|,
name|TimelinePutResponse
name|response
parameter_list|,
specifier|final
name|int
name|errorCode
parameter_list|)
block|{
name|TimelinePutError
name|error
init|=
operator|new
name|TimelinePutError
argument_list|()
decl_stmt|;
name|error
operator|.
name|setEntityId
argument_list|(
name|entity
operator|.
name|getEntityId
argument_list|()
argument_list|)
expr_stmt|;
name|error
operator|.
name|setEntityType
argument_list|(
name|entity
operator|.
name|getEntityType
argument_list|()
argument_list|)
expr_stmt|;
name|error
operator|.
name|setErrorCode
argument_list|(
name|errorCode
argument_list|)
expr_stmt|;
name|response
operator|.
name|addError
argument_list|(
name|error
argument_list|)
expr_stmt|;
block|}
comment|/**    * Put a single entity.  If there is an error, add a TimelinePutError to the    * given response.    */
DECL|method|put (TimelineEntity entity, TimelinePutResponse response, boolean allowEmptyDomainId)
specifier|private
name|void
name|put
parameter_list|(
name|TimelineEntity
name|entity
parameter_list|,
name|TimelinePutResponse
name|response
parameter_list|,
name|boolean
name|allowEmptyDomainId
parameter_list|)
block|{
name|LockMap
operator|.
name|CountingReentrantLock
argument_list|<
name|EntityIdentifier
argument_list|>
name|lock
init|=
name|writeLocks
operator|.
name|getLock
argument_list|(
operator|new
name|EntityIdentifier
argument_list|(
name|entity
operator|.
name|getEntityId
argument_list|()
argument_list|,
name|entity
operator|.
name|getEntityType
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|lock
operator|.
name|lock
argument_list|()
expr_stmt|;
name|WriteBatch
name|writeBatch
init|=
literal|null
decl_stmt|;
name|List
argument_list|<
name|EntityIdentifier
argument_list|>
name|relatedEntitiesWithoutStartTimes
init|=
operator|new
name|ArrayList
argument_list|<
name|EntityIdentifier
argument_list|>
argument_list|()
decl_stmt|;
name|byte
index|[]
name|revStartTime
init|=
literal|null
decl_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|Set
argument_list|<
name|Object
argument_list|>
argument_list|>
name|primaryFilters
init|=
literal|null
decl_stmt|;
try|try
block|{
name|writeBatch
operator|=
name|db
operator|.
name|createWriteBatch
argument_list|()
expr_stmt|;
name|List
argument_list|<
name|TimelineEvent
argument_list|>
name|events
init|=
name|entity
operator|.
name|getEvents
argument_list|()
decl_stmt|;
comment|// look up the start time for the entity
name|StartAndInsertTime
name|startAndInsertTime
init|=
name|getAndSetStartTime
argument_list|(
name|entity
operator|.
name|getEntityId
argument_list|()
argument_list|,
name|entity
operator|.
name|getEntityType
argument_list|()
argument_list|,
name|entity
operator|.
name|getStartTime
argument_list|()
argument_list|,
name|events
argument_list|)
decl_stmt|;
if|if
condition|(
name|startAndInsertTime
operator|==
literal|null
condition|)
block|{
comment|// if no start time is found, add an error and return
name|handleError
argument_list|(
name|entity
argument_list|,
name|response
argument_list|,
name|TimelinePutError
operator|.
name|NO_START_TIME
argument_list|)
expr_stmt|;
return|return;
block|}
name|revStartTime
operator|=
name|writeReverseOrderedLong
argument_list|(
name|startAndInsertTime
operator|.
name|startTime
argument_list|)
expr_stmt|;
name|primaryFilters
operator|=
name|entity
operator|.
name|getPrimaryFilters
argument_list|()
expr_stmt|;
comment|// write entity marker
name|byte
index|[]
name|markerKey
init|=
name|createEntityMarkerKey
argument_list|(
name|entity
operator|.
name|getEntityId
argument_list|()
argument_list|,
name|entity
operator|.
name|getEntityType
argument_list|()
argument_list|,
name|revStartTime
argument_list|)
decl_stmt|;
name|byte
index|[]
name|markerValue
init|=
name|writeReverseOrderedLong
argument_list|(
name|startAndInsertTime
operator|.
name|insertTime
argument_list|)
decl_stmt|;
name|writeBatch
operator|.
name|put
argument_list|(
name|markerKey
argument_list|,
name|markerValue
argument_list|)
expr_stmt|;
name|writePrimaryFilterEntries
argument_list|(
name|writeBatch
argument_list|,
name|primaryFilters
argument_list|,
name|markerKey
argument_list|,
name|markerValue
argument_list|)
expr_stmt|;
comment|// write event entries
if|if
condition|(
name|events
operator|!=
literal|null
operator|&&
operator|!
name|events
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
for|for
control|(
name|TimelineEvent
name|event
range|:
name|events
control|)
block|{
name|byte
index|[]
name|revts
init|=
name|writeReverseOrderedLong
argument_list|(
name|event
operator|.
name|getTimestamp
argument_list|()
argument_list|)
decl_stmt|;
name|byte
index|[]
name|key
init|=
name|createEntityEventKey
argument_list|(
name|entity
operator|.
name|getEntityId
argument_list|()
argument_list|,
name|entity
operator|.
name|getEntityType
argument_list|()
argument_list|,
name|revStartTime
argument_list|,
name|revts
argument_list|,
name|event
operator|.
name|getEventType
argument_list|()
argument_list|)
decl_stmt|;
name|byte
index|[]
name|value
init|=
name|GenericObjectMapper
operator|.
name|write
argument_list|(
name|event
operator|.
name|getEventInfo
argument_list|()
argument_list|)
decl_stmt|;
name|writeBatch
operator|.
name|put
argument_list|(
name|key
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|writePrimaryFilterEntries
argument_list|(
name|writeBatch
argument_list|,
name|primaryFilters
argument_list|,
name|key
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
block|}
comment|// write related entity entries
name|Map
argument_list|<
name|String
argument_list|,
name|Set
argument_list|<
name|String
argument_list|>
argument_list|>
name|relatedEntities
init|=
name|entity
operator|.
name|getRelatedEntities
argument_list|()
decl_stmt|;
if|if
condition|(
name|relatedEntities
operator|!=
literal|null
operator|&&
operator|!
name|relatedEntities
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
for|for
control|(
name|Entry
argument_list|<
name|String
argument_list|,
name|Set
argument_list|<
name|String
argument_list|>
argument_list|>
name|relatedEntityList
range|:
name|relatedEntities
operator|.
name|entrySet
argument_list|()
control|)
block|{
name|String
name|relatedEntityType
init|=
name|relatedEntityList
operator|.
name|getKey
argument_list|()
decl_stmt|;
for|for
control|(
name|String
name|relatedEntityId
range|:
name|relatedEntityList
operator|.
name|getValue
argument_list|()
control|)
block|{
comment|// invisible "reverse" entries (entity -> related entity)
name|byte
index|[]
name|key
init|=
name|createReverseRelatedEntityKey
argument_list|(
name|entity
operator|.
name|getEntityId
argument_list|()
argument_list|,
name|entity
operator|.
name|getEntityType
argument_list|()
argument_list|,
name|revStartTime
argument_list|,
name|relatedEntityId
argument_list|,
name|relatedEntityType
argument_list|)
decl_stmt|;
name|writeBatch
operator|.
name|put
argument_list|(
name|key
argument_list|,
name|EMPTY_BYTES
argument_list|)
expr_stmt|;
comment|// look up start time of related entity
name|byte
index|[]
name|relatedEntityStartTime
init|=
name|getStartTime
argument_list|(
name|relatedEntityId
argument_list|,
name|relatedEntityType
argument_list|)
decl_stmt|;
comment|// delay writing the related entity if no start time is found
if|if
condition|(
name|relatedEntityStartTime
operator|==
literal|null
condition|)
block|{
name|relatedEntitiesWithoutStartTimes
operator|.
name|add
argument_list|(
operator|new
name|EntityIdentifier
argument_list|(
name|relatedEntityId
argument_list|,
name|relatedEntityType
argument_list|)
argument_list|)
expr_stmt|;
continue|continue;
block|}
else|else
block|{
comment|// This is the existing entity
name|byte
index|[]
name|domainIdBytes
init|=
name|db
operator|.
name|get
argument_list|(
name|createDomainIdKey
argument_list|(
name|relatedEntityId
argument_list|,
name|relatedEntityType
argument_list|,
name|relatedEntityStartTime
argument_list|)
argument_list|)
decl_stmt|;
comment|// The timeline data created by the server before 2.6 won't have
comment|// the domain field. We assume this timeline data is in the
comment|// default timeline domain.
name|String
name|domainId
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|domainIdBytes
operator|==
literal|null
condition|)
block|{
name|domainId
operator|=
name|TimelineDataManager
operator|.
name|DEFAULT_DOMAIN_ID
expr_stmt|;
block|}
else|else
block|{
name|domainId
operator|=
operator|new
name|String
argument_list|(
name|domainIdBytes
argument_list|,
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|domainId
operator|.
name|equals
argument_list|(
name|entity
operator|.
name|getDomainId
argument_list|()
argument_list|)
condition|)
block|{
comment|// in this case the entity will be put, but the relation will be
comment|// ignored
name|handleError
argument_list|(
name|entity
argument_list|,
name|response
argument_list|,
name|TimelinePutError
operator|.
name|FORBIDDEN_RELATION
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
comment|// write "forward" entry (related entity -> entity)
name|key
operator|=
name|createRelatedEntityKey
argument_list|(
name|relatedEntityId
argument_list|,
name|relatedEntityType
argument_list|,
name|relatedEntityStartTime
argument_list|,
name|entity
operator|.
name|getEntityId
argument_list|()
argument_list|,
name|entity
operator|.
name|getEntityType
argument_list|()
argument_list|)
expr_stmt|;
name|writeBatch
operator|.
name|put
argument_list|(
name|key
argument_list|,
name|EMPTY_BYTES
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|// write primary filter entries
if|if
condition|(
name|primaryFilters
operator|!=
literal|null
operator|&&
operator|!
name|primaryFilters
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
for|for
control|(
name|Entry
argument_list|<
name|String
argument_list|,
name|Set
argument_list|<
name|Object
argument_list|>
argument_list|>
name|primaryFilter
range|:
name|primaryFilters
operator|.
name|entrySet
argument_list|()
control|)
block|{
for|for
control|(
name|Object
name|primaryFilterValue
range|:
name|primaryFilter
operator|.
name|getValue
argument_list|()
control|)
block|{
name|byte
index|[]
name|key
init|=
name|createPrimaryFilterKey
argument_list|(
name|entity
operator|.
name|getEntityId
argument_list|()
argument_list|,
name|entity
operator|.
name|getEntityType
argument_list|()
argument_list|,
name|revStartTime
argument_list|,
name|primaryFilter
operator|.
name|getKey
argument_list|()
argument_list|,
name|primaryFilterValue
argument_list|)
decl_stmt|;
name|writeBatch
operator|.
name|put
argument_list|(
name|key
argument_list|,
name|EMPTY_BYTES
argument_list|)
expr_stmt|;
name|writePrimaryFilterEntries
argument_list|(
name|writeBatch
argument_list|,
name|primaryFilters
argument_list|,
name|key
argument_list|,
name|EMPTY_BYTES
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|// write other info entries
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|otherInfo
init|=
name|entity
operator|.
name|getOtherInfo
argument_list|()
decl_stmt|;
if|if
condition|(
name|otherInfo
operator|!=
literal|null
operator|&&
operator|!
name|otherInfo
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
for|for
control|(
name|Entry
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|i
range|:
name|otherInfo
operator|.
name|entrySet
argument_list|()
control|)
block|{
name|byte
index|[]
name|key
init|=
name|createOtherInfoKey
argument_list|(
name|entity
operator|.
name|getEntityId
argument_list|()
argument_list|,
name|entity
operator|.
name|getEntityType
argument_list|()
argument_list|,
name|revStartTime
argument_list|,
name|i
operator|.
name|getKey
argument_list|()
argument_list|)
decl_stmt|;
name|byte
index|[]
name|value
init|=
name|GenericObjectMapper
operator|.
name|write
argument_list|(
name|i
operator|.
name|getValue
argument_list|()
argument_list|)
decl_stmt|;
name|writeBatch
operator|.
name|put
argument_list|(
name|key
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|writePrimaryFilterEntries
argument_list|(
name|writeBatch
argument_list|,
name|primaryFilters
argument_list|,
name|key
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
block|}
comment|// write domain id entry
name|byte
index|[]
name|key
init|=
name|createDomainIdKey
argument_list|(
name|entity
operator|.
name|getEntityId
argument_list|()
argument_list|,
name|entity
operator|.
name|getEntityType
argument_list|()
argument_list|,
name|revStartTime
argument_list|)
decl_stmt|;
if|if
condition|(
name|entity
operator|.
name|getDomainId
argument_list|()
operator|==
literal|null
operator|||
name|entity
operator|.
name|getDomainId
argument_list|()
operator|.
name|length
argument_list|()
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|allowEmptyDomainId
condition|)
block|{
name|handleError
argument_list|(
name|entity
argument_list|,
name|response
argument_list|,
name|TimelinePutError
operator|.
name|NO_DOMAIN
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
name|writeBatch
operator|.
name|put
argument_list|(
name|key
argument_list|,
name|entity
operator|.
name|getDomainId
argument_list|()
operator|.
name|getBytes
argument_list|(
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|writePrimaryFilterEntries
argument_list|(
name|writeBatch
argument_list|,
name|primaryFilters
argument_list|,
name|key
argument_list|,
name|entity
operator|.
name|getDomainId
argument_list|()
operator|.
name|getBytes
argument_list|(
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|db
operator|.
name|write
argument_list|(
name|writeBatch
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|DBException
name|de
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Error putting entity "
operator|+
name|entity
operator|.
name|getEntityId
argument_list|()
operator|+
literal|" of type "
operator|+
name|entity
operator|.
name|getEntityType
argument_list|()
argument_list|,
name|de
argument_list|)
expr_stmt|;
name|handleError
argument_list|(
name|entity
argument_list|,
name|response
argument_list|,
name|TimelinePutError
operator|.
name|IO_EXCEPTION
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Error putting entity "
operator|+
name|entity
operator|.
name|getEntityId
argument_list|()
operator|+
literal|" of type "
operator|+
name|entity
operator|.
name|getEntityType
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|handleError
argument_list|(
name|entity
argument_list|,
name|response
argument_list|,
name|TimelinePutError
operator|.
name|IO_EXCEPTION
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|lock
operator|.
name|unlock
argument_list|()
expr_stmt|;
name|writeLocks
operator|.
name|returnLock
argument_list|(
name|lock
argument_list|)
expr_stmt|;
name|IOUtils
operator|.
name|cleanupWithLogger
argument_list|(
name|LOG
argument_list|,
name|writeBatch
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|EntityIdentifier
name|relatedEntity
range|:
name|relatedEntitiesWithoutStartTimes
control|)
block|{
name|lock
operator|=
name|writeLocks
operator|.
name|getLock
argument_list|(
name|relatedEntity
argument_list|)
expr_stmt|;
name|lock
operator|.
name|lock
argument_list|()
expr_stmt|;
try|try
block|{
name|StartAndInsertTime
name|relatedEntityStartAndInsertTime
init|=
name|getAndSetStartTime
argument_list|(
name|relatedEntity
operator|.
name|getId
argument_list|()
argument_list|,
name|relatedEntity
operator|.
name|getType
argument_list|()
argument_list|,
name|readReverseOrderedLong
argument_list|(
name|revStartTime
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|null
argument_list|)
decl_stmt|;
if|if
condition|(
name|relatedEntityStartAndInsertTime
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Error setting start time for related entity"
argument_list|)
throw|;
block|}
name|byte
index|[]
name|relatedEntityStartTime
init|=
name|writeReverseOrderedLong
argument_list|(
name|relatedEntityStartAndInsertTime
operator|.
name|startTime
argument_list|)
decl_stmt|;
comment|// This is the new entity, the domain should be the same
name|byte
index|[]
name|key
init|=
name|createDomainIdKey
argument_list|(
name|relatedEntity
operator|.
name|getId
argument_list|()
argument_list|,
name|relatedEntity
operator|.
name|getType
argument_list|()
argument_list|,
name|relatedEntityStartTime
argument_list|)
decl_stmt|;
name|db
operator|.
name|put
argument_list|(
name|key
argument_list|,
name|entity
operator|.
name|getDomainId
argument_list|()
operator|.
name|getBytes
argument_list|(
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|db
operator|.
name|put
argument_list|(
name|createRelatedEntityKey
argument_list|(
name|relatedEntity
operator|.
name|getId
argument_list|()
argument_list|,
name|relatedEntity
operator|.
name|getType
argument_list|()
argument_list|,
name|relatedEntityStartTime
argument_list|,
name|entity
operator|.
name|getEntityId
argument_list|()
argument_list|,
name|entity
operator|.
name|getEntityType
argument_list|()
argument_list|)
argument_list|,
name|EMPTY_BYTES
argument_list|)
expr_stmt|;
name|db
operator|.
name|put
argument_list|(
name|createEntityMarkerKey
argument_list|(
name|relatedEntity
operator|.
name|getId
argument_list|()
argument_list|,
name|relatedEntity
operator|.
name|getType
argument_list|()
argument_list|,
name|relatedEntityStartTime
argument_list|)
argument_list|,
name|writeReverseOrderedLong
argument_list|(
name|relatedEntityStartAndInsertTime
operator|.
name|insertTime
argument_list|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|DBException
name|de
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Error putting related entity "
operator|+
name|relatedEntity
operator|.
name|getId
argument_list|()
operator|+
literal|" of type "
operator|+
name|relatedEntity
operator|.
name|getType
argument_list|()
operator|+
literal|" for entity "
operator|+
name|entity
operator|.
name|getEntityId
argument_list|()
operator|+
literal|" of type "
operator|+
name|entity
operator|.
name|getEntityType
argument_list|()
argument_list|,
name|de
argument_list|)
expr_stmt|;
name|handleError
argument_list|(
name|entity
argument_list|,
name|response
argument_list|,
name|TimelinePutError
operator|.
name|IO_EXCEPTION
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Error putting related entity "
operator|+
name|relatedEntity
operator|.
name|getId
argument_list|()
operator|+
literal|" of type "
operator|+
name|relatedEntity
operator|.
name|getType
argument_list|()
operator|+
literal|" for entity "
operator|+
name|entity
operator|.
name|getEntityId
argument_list|()
operator|+
literal|" of type "
operator|+
name|entity
operator|.
name|getEntityType
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|handleError
argument_list|(
name|entity
argument_list|,
name|response
argument_list|,
name|TimelinePutError
operator|.
name|IO_EXCEPTION
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|lock
operator|.
name|unlock
argument_list|()
expr_stmt|;
name|writeLocks
operator|.
name|returnLock
argument_list|(
name|lock
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/**    * For a given key / value pair that has been written to the db,    * write additional entries to the db for each primary filter.    */
DECL|method|writePrimaryFilterEntries (WriteBatch writeBatch, Map<String, Set<Object>> primaryFilters, byte[] key, byte[] value)
specifier|private
specifier|static
name|void
name|writePrimaryFilterEntries
parameter_list|(
name|WriteBatch
name|writeBatch
parameter_list|,
name|Map
argument_list|<
name|String
argument_list|,
name|Set
argument_list|<
name|Object
argument_list|>
argument_list|>
name|primaryFilters
parameter_list|,
name|byte
index|[]
name|key
parameter_list|,
name|byte
index|[]
name|value
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
name|primaryFilters
operator|!=
literal|null
operator|&&
operator|!
name|primaryFilters
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
for|for
control|(
name|Entry
argument_list|<
name|String
argument_list|,
name|Set
argument_list|<
name|Object
argument_list|>
argument_list|>
name|pf
range|:
name|primaryFilters
operator|.
name|entrySet
argument_list|()
control|)
block|{
for|for
control|(
name|Object
name|pfval
range|:
name|pf
operator|.
name|getValue
argument_list|()
control|)
block|{
name|writeBatch
operator|.
name|put
argument_list|(
name|addPrimaryFilterToKey
argument_list|(
name|pf
operator|.
name|getKey
argument_list|()
argument_list|,
name|pfval
argument_list|,
name|key
argument_list|)
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
annotation|@
name|Override
DECL|method|put (TimelineEntities entities)
specifier|public
name|TimelinePutResponse
name|put
parameter_list|(
name|TimelineEntities
name|entities
parameter_list|)
block|{
name|deleteLock
operator|.
name|readLock
argument_list|()
operator|.
name|lock
argument_list|()
expr_stmt|;
try|try
block|{
name|TimelinePutResponse
name|response
init|=
operator|new
name|TimelinePutResponse
argument_list|()
decl_stmt|;
for|for
control|(
name|TimelineEntity
name|entity
range|:
name|entities
operator|.
name|getEntities
argument_list|()
control|)
block|{
name|put
argument_list|(
name|entity
argument_list|,
name|response
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
return|return
name|response
return|;
block|}
finally|finally
block|{
name|deleteLock
operator|.
name|readLock
argument_list|()
operator|.
name|unlock
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Private
annotation|@
name|VisibleForTesting
DECL|method|putWithNoDomainId (TimelineEntities entities)
specifier|public
name|TimelinePutResponse
name|putWithNoDomainId
parameter_list|(
name|TimelineEntities
name|entities
parameter_list|)
block|{
name|deleteLock
operator|.
name|readLock
argument_list|()
operator|.
name|lock
argument_list|()
expr_stmt|;
try|try
block|{
name|TimelinePutResponse
name|response
init|=
operator|new
name|TimelinePutResponse
argument_list|()
decl_stmt|;
for|for
control|(
name|TimelineEntity
name|entity
range|:
name|entities
operator|.
name|getEntities
argument_list|()
control|)
block|{
name|put
argument_list|(
name|entity
argument_list|,
name|response
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
return|return
name|response
return|;
block|}
finally|finally
block|{
name|deleteLock
operator|.
name|readLock
argument_list|()
operator|.
name|unlock
argument_list|()
expr_stmt|;
block|}
block|}
comment|/**    * Get the unique start time for a given entity as a byte array that sorts    * the timestamps in reverse order (see {@link    * GenericObjectMapper#writeReverseOrderedLong(long)}).    *    * @param entityId The id of the entity    * @param entityType The type of the entity    * @return A byte array, null if not found    * @throws IOException    */
DECL|method|getStartTime (String entityId, String entityType)
specifier|private
name|byte
index|[]
name|getStartTime
parameter_list|(
name|String
name|entityId
parameter_list|,
name|String
name|entityType
parameter_list|)
throws|throws
name|IOException
block|{
name|Long
name|l
init|=
name|getStartTimeLong
argument_list|(
name|entityId
argument_list|,
name|entityType
argument_list|)
decl_stmt|;
return|return
name|l
operator|==
literal|null
condition|?
literal|null
else|:
name|writeReverseOrderedLong
argument_list|(
name|l
argument_list|)
return|;
block|}
comment|/**    * Get the unique start time for a given entity as a Long.    *    * @param entityId The id of the entity    * @param entityType The type of the entity    * @return A Long, null if not found    * @throws IOException    */
DECL|method|getStartTimeLong (String entityId, String entityType)
specifier|private
name|Long
name|getStartTimeLong
parameter_list|(
name|String
name|entityId
parameter_list|,
name|String
name|entityType
parameter_list|)
throws|throws
name|IOException
block|{
name|EntityIdentifier
name|entity
init|=
operator|new
name|EntityIdentifier
argument_list|(
name|entityId
argument_list|,
name|entityType
argument_list|)
decl_stmt|;
try|try
block|{
comment|// start time is not provided, so try to look it up
if|if
condition|(
name|startTimeReadCache
operator|.
name|containsKey
argument_list|(
name|entity
argument_list|)
condition|)
block|{
comment|// found the start time in the cache
return|return
name|startTimeReadCache
operator|.
name|get
argument_list|(
name|entity
argument_list|)
return|;
block|}
else|else
block|{
comment|// try to look up the start time in the db
name|byte
index|[]
name|b
init|=
name|createStartTimeLookupKey
argument_list|(
name|entity
operator|.
name|getId
argument_list|()
argument_list|,
name|entity
operator|.
name|getType
argument_list|()
argument_list|)
decl_stmt|;
name|byte
index|[]
name|v
init|=
name|db
operator|.
name|get
argument_list|(
name|b
argument_list|)
decl_stmt|;
if|if
condition|(
name|v
operator|==
literal|null
condition|)
block|{
comment|// did not find the start time in the db
return|return
literal|null
return|;
block|}
else|else
block|{
comment|// found the start time in the db
name|Long
name|l
init|=
name|readReverseOrderedLong
argument_list|(
name|v
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|startTimeReadCache
operator|.
name|put
argument_list|(
name|entity
argument_list|,
name|l
argument_list|)
expr_stmt|;
return|return
name|l
return|;
block|}
block|}
block|}
catch|catch
parameter_list|(
name|DBException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
comment|/**    * Get the unique start time for a given entity as a byte array that sorts    * the timestamps in reverse order (see {@link    * GenericObjectMapper#writeReverseOrderedLong(long)}). If the start time    * doesn't exist, set it based on the information provided. Should only be    * called when a lock has been obtained on the entity.    *    * @param entityId The id of the entity    * @param entityType The type of the entity    * @param startTime The start time of the entity, or null    * @param events A list of events for the entity, or null    * @return A StartAndInsertTime    * @throws IOException    */
DECL|method|getAndSetStartTime (String entityId, String entityType, Long startTime, List<TimelineEvent> events)
specifier|private
name|StartAndInsertTime
name|getAndSetStartTime
parameter_list|(
name|String
name|entityId
parameter_list|,
name|String
name|entityType
parameter_list|,
name|Long
name|startTime
parameter_list|,
name|List
argument_list|<
name|TimelineEvent
argument_list|>
name|events
parameter_list|)
throws|throws
name|IOException
block|{
name|EntityIdentifier
name|entity
init|=
operator|new
name|EntityIdentifier
argument_list|(
name|entityId
argument_list|,
name|entityType
argument_list|)
decl_stmt|;
if|if
condition|(
name|startTime
operator|==
literal|null
condition|)
block|{
comment|// start time is not provided, so try to look it up
if|if
condition|(
name|startTimeWriteCache
operator|.
name|containsKey
argument_list|(
name|entity
argument_list|)
condition|)
block|{
comment|// found the start time in the cache
return|return
name|startTimeWriteCache
operator|.
name|get
argument_list|(
name|entity
argument_list|)
return|;
block|}
else|else
block|{
if|if
condition|(
name|events
operator|!=
literal|null
condition|)
block|{
comment|// prepare a start time from events in case it is needed
name|Long
name|min
init|=
name|Long
operator|.
name|MAX_VALUE
decl_stmt|;
for|for
control|(
name|TimelineEvent
name|e
range|:
name|events
control|)
block|{
if|if
condition|(
name|min
operator|>
name|e
operator|.
name|getTimestamp
argument_list|()
condition|)
block|{
name|min
operator|=
name|e
operator|.
name|getTimestamp
argument_list|()
expr_stmt|;
block|}
block|}
name|startTime
operator|=
name|min
expr_stmt|;
block|}
return|return
name|checkStartTimeInDb
argument_list|(
name|entity
argument_list|,
name|startTime
argument_list|)
return|;
block|}
block|}
else|else
block|{
comment|// start time is provided
if|if
condition|(
name|startTimeWriteCache
operator|.
name|containsKey
argument_list|(
name|entity
argument_list|)
condition|)
block|{
comment|// always use start time from cache if it exists
return|return
name|startTimeWriteCache
operator|.
name|get
argument_list|(
name|entity
argument_list|)
return|;
block|}
else|else
block|{
comment|// check the provided start time matches the db
return|return
name|checkStartTimeInDb
argument_list|(
name|entity
argument_list|,
name|startTime
argument_list|)
return|;
block|}
block|}
block|}
comment|/**    * Checks db for start time and returns it if it exists.  If it doesn't    * exist, writes the suggested start time (if it is not null).  This is    * only called when the start time is not found in the cache,    * so it adds it back into the cache if it is found. Should only be called    * when a lock has been obtained on the entity.    */
DECL|method|checkStartTimeInDb (EntityIdentifier entity, Long suggestedStartTime)
specifier|private
name|StartAndInsertTime
name|checkStartTimeInDb
parameter_list|(
name|EntityIdentifier
name|entity
parameter_list|,
name|Long
name|suggestedStartTime
parameter_list|)
throws|throws
name|IOException
block|{
name|StartAndInsertTime
name|startAndInsertTime
init|=
literal|null
decl_stmt|;
comment|// create lookup key for start time
name|byte
index|[]
name|b
init|=
name|createStartTimeLookupKey
argument_list|(
name|entity
operator|.
name|getId
argument_list|()
argument_list|,
name|entity
operator|.
name|getType
argument_list|()
argument_list|)
decl_stmt|;
try|try
block|{
comment|// retrieve value for key
name|byte
index|[]
name|v
init|=
name|db
operator|.
name|get
argument_list|(
name|b
argument_list|)
decl_stmt|;
if|if
condition|(
name|v
operator|==
literal|null
condition|)
block|{
comment|// start time doesn't exist in db
if|if
condition|(
name|suggestedStartTime
operator|==
literal|null
condition|)
block|{
return|return
literal|null
return|;
block|}
name|startAndInsertTime
operator|=
operator|new
name|StartAndInsertTime
argument_list|(
name|suggestedStartTime
argument_list|,
name|System
operator|.
name|currentTimeMillis
argument_list|()
argument_list|)
expr_stmt|;
comment|// write suggested start time
name|v
operator|=
operator|new
name|byte
index|[
literal|16
index|]
expr_stmt|;
name|writeReverseOrderedLong
argument_list|(
name|suggestedStartTime
argument_list|,
name|v
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|writeReverseOrderedLong
argument_list|(
name|startAndInsertTime
operator|.
name|insertTime
argument_list|,
name|v
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|WriteOptions
name|writeOptions
init|=
operator|new
name|WriteOptions
argument_list|()
decl_stmt|;
name|writeOptions
operator|.
name|sync
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|db
operator|.
name|put
argument_list|(
name|b
argument_list|,
name|v
argument_list|,
name|writeOptions
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// found start time in db, so ignore suggested start time
name|startAndInsertTime
operator|=
operator|new
name|StartAndInsertTime
argument_list|(
name|readReverseOrderedLong
argument_list|(
name|v
argument_list|,
literal|0
argument_list|)
argument_list|,
name|readReverseOrderedLong
argument_list|(
name|v
argument_list|,
literal|8
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|DBException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
name|e
argument_list|)
throw|;
block|}
name|startTimeWriteCache
operator|.
name|put
argument_list|(
name|entity
argument_list|,
name|startAndInsertTime
argument_list|)
expr_stmt|;
name|startTimeReadCache
operator|.
name|put
argument_list|(
name|entity
argument_list|,
name|startAndInsertTime
operator|.
name|startTime
argument_list|)
expr_stmt|;
return|return
name|startAndInsertTime
return|;
block|}
comment|/**    * Creates a key for looking up the start time of a given entity,    * of the form START_TIME_LOOKUP_PREFIX + entity type + entity id.    */
DECL|method|createStartTimeLookupKey (String entityId, String entityType)
specifier|private
specifier|static
name|byte
index|[]
name|createStartTimeLookupKey
parameter_list|(
name|String
name|entityId
parameter_list|,
name|String
name|entityType
parameter_list|)
throws|throws
name|IOException
block|{
return|return
name|KeyBuilder
operator|.
name|newInstance
argument_list|()
operator|.
name|add
argument_list|(
name|START_TIME_LOOKUP_PREFIX
argument_list|)
operator|.
name|add
argument_list|(
name|entityType
argument_list|)
operator|.
name|add
argument_list|(
name|entityId
argument_list|)
operator|.
name|getBytes
argument_list|()
return|;
block|}
comment|/**    * Creates an entity marker, serializing ENTITY_ENTRY_PREFIX + entity type +    * revstarttime + entity id.    */
DECL|method|createEntityMarkerKey (String entityId, String entityType, byte[] revStartTime)
specifier|private
specifier|static
name|byte
index|[]
name|createEntityMarkerKey
parameter_list|(
name|String
name|entityId
parameter_list|,
name|String
name|entityType
parameter_list|,
name|byte
index|[]
name|revStartTime
parameter_list|)
throws|throws
name|IOException
block|{
return|return
name|KeyBuilder
operator|.
name|newInstance
argument_list|()
operator|.
name|add
argument_list|(
name|ENTITY_ENTRY_PREFIX
argument_list|)
operator|.
name|add
argument_list|(
name|entityType
argument_list|)
operator|.
name|add
argument_list|(
name|revStartTime
argument_list|)
operator|.
name|add
argument_list|(
name|entityId
argument_list|)
operator|.
name|getBytesForLookup
argument_list|()
return|;
block|}
comment|/**    * Creates an index entry for the given key of the form    * INDEXED_ENTRY_PREFIX + primaryfiltername + primaryfiltervalue + key.    */
DECL|method|addPrimaryFilterToKey (String primaryFilterName, Object primaryFilterValue, byte[] key)
specifier|private
specifier|static
name|byte
index|[]
name|addPrimaryFilterToKey
parameter_list|(
name|String
name|primaryFilterName
parameter_list|,
name|Object
name|primaryFilterValue
parameter_list|,
name|byte
index|[]
name|key
parameter_list|)
throws|throws
name|IOException
block|{
return|return
name|KeyBuilder
operator|.
name|newInstance
argument_list|()
operator|.
name|add
argument_list|(
name|INDEXED_ENTRY_PREFIX
argument_list|)
operator|.
name|add
argument_list|(
name|primaryFilterName
argument_list|)
operator|.
name|add
argument_list|(
name|GenericObjectMapper
operator|.
name|write
argument_list|(
name|primaryFilterValue
argument_list|)
argument_list|,
literal|true
argument_list|)
operator|.
name|add
argument_list|(
name|key
argument_list|)
operator|.
name|getBytes
argument_list|()
return|;
block|}
comment|/**    * Creates an event key, serializing ENTITY_ENTRY_PREFIX + entity type +    * revstarttime + entity id + EVENTS_COLUMN + reveventtimestamp + event type.    */
DECL|method|createEntityEventKey (String entityId, String entityType, byte[] revStartTime, byte[] revEventTimestamp, String eventType)
specifier|private
specifier|static
name|byte
index|[]
name|createEntityEventKey
parameter_list|(
name|String
name|entityId
parameter_list|,
name|String
name|entityType
parameter_list|,
name|byte
index|[]
name|revStartTime
parameter_list|,
name|byte
index|[]
name|revEventTimestamp
parameter_list|,
name|String
name|eventType
parameter_list|)
throws|throws
name|IOException
block|{
return|return
name|KeyBuilder
operator|.
name|newInstance
argument_list|()
operator|.
name|add
argument_list|(
name|ENTITY_ENTRY_PREFIX
argument_list|)
operator|.
name|add
argument_list|(
name|entityType
argument_list|)
operator|.
name|add
argument_list|(
name|revStartTime
argument_list|)
operator|.
name|add
argument_list|(
name|entityId
argument_list|)
operator|.
name|add
argument_list|(
name|EVENTS_COLUMN
argument_list|)
operator|.
name|add
argument_list|(
name|revEventTimestamp
argument_list|)
operator|.
name|add
argument_list|(
name|eventType
argument_list|)
operator|.
name|getBytes
argument_list|()
return|;
block|}
comment|/**    * Creates an event object from the given key, offset, and value.  If the    * event type is not contained in the specified set of event types,    * returns null.    */
DECL|method|getEntityEvent (Set<String> eventTypes, byte[] key, int offset, byte[] value)
specifier|private
specifier|static
name|TimelineEvent
name|getEntityEvent
parameter_list|(
name|Set
argument_list|<
name|String
argument_list|>
name|eventTypes
parameter_list|,
name|byte
index|[]
name|key
parameter_list|,
name|int
name|offset
parameter_list|,
name|byte
index|[]
name|value
parameter_list|)
throws|throws
name|IOException
block|{
name|KeyParser
name|kp
init|=
operator|new
name|KeyParser
argument_list|(
name|key
argument_list|,
name|offset
argument_list|)
decl_stmt|;
name|long
name|ts
init|=
name|kp
operator|.
name|getNextLong
argument_list|()
decl_stmt|;
name|String
name|tstype
init|=
name|kp
operator|.
name|getNextString
argument_list|()
decl_stmt|;
if|if
condition|(
name|eventTypes
operator|==
literal|null
operator|||
name|eventTypes
operator|.
name|contains
argument_list|(
name|tstype
argument_list|)
condition|)
block|{
name|TimelineEvent
name|event
init|=
operator|new
name|TimelineEvent
argument_list|()
decl_stmt|;
name|event
operator|.
name|setTimestamp
argument_list|(
name|ts
argument_list|)
expr_stmt|;
name|event
operator|.
name|setEventType
argument_list|(
name|tstype
argument_list|)
expr_stmt|;
name|Object
name|o
init|=
name|GenericObjectMapper
operator|.
name|read
argument_list|(
name|value
argument_list|)
decl_stmt|;
if|if
condition|(
name|o
operator|==
literal|null
condition|)
block|{
name|event
operator|.
name|setEventInfo
argument_list|(
literal|null
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|o
operator|instanceof
name|Map
condition|)
block|{
annotation|@
name|SuppressWarnings
argument_list|(
literal|"unchecked"
argument_list|)
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|m
init|=
operator|(
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
operator|)
name|o
decl_stmt|;
name|event
operator|.
name|setEventInfo
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
else|else
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Couldn't deserialize event info map"
argument_list|)
throw|;
block|}
return|return
name|event
return|;
block|}
return|return
literal|null
return|;
block|}
comment|/**    * Creates a primary filter key, serializing ENTITY_ENTRY_PREFIX +    * entity type + revstarttime + entity id + PRIMARY_FILTERS_COLUMN + name +    * value.    */
DECL|method|createPrimaryFilterKey (String entityId, String entityType, byte[] revStartTime, String name, Object value)
specifier|private
specifier|static
name|byte
index|[]
name|createPrimaryFilterKey
parameter_list|(
name|String
name|entityId
parameter_list|,
name|String
name|entityType
parameter_list|,
name|byte
index|[]
name|revStartTime
parameter_list|,
name|String
name|name
parameter_list|,
name|Object
name|value
parameter_list|)
throws|throws
name|IOException
block|{
return|return
name|KeyBuilder
operator|.
name|newInstance
argument_list|()
operator|.
name|add
argument_list|(
name|ENTITY_ENTRY_PREFIX
argument_list|)
operator|.
name|add
argument_list|(
name|entityType
argument_list|)
operator|.
name|add
argument_list|(
name|revStartTime
argument_list|)
operator|.
name|add
argument_list|(
name|entityId
argument_list|)
operator|.
name|add
argument_list|(
name|PRIMARY_FILTERS_COLUMN
argument_list|)
operator|.
name|add
argument_list|(
name|name
argument_list|)
operator|.
name|add
argument_list|(
name|GenericObjectMapper
operator|.
name|write
argument_list|(
name|value
argument_list|)
argument_list|)
operator|.
name|getBytes
argument_list|()
return|;
block|}
comment|/**    * Parses the primary filter from the given key at the given offset and    * adds it to the given entity.    */
DECL|method|addPrimaryFilter (TimelineEntity entity, byte[] key, int offset)
specifier|private
specifier|static
name|void
name|addPrimaryFilter
parameter_list|(
name|TimelineEntity
name|entity
parameter_list|,
name|byte
index|[]
name|key
parameter_list|,
name|int
name|offset
parameter_list|)
throws|throws
name|IOException
block|{
name|KeyParser
name|kp
init|=
operator|new
name|KeyParser
argument_list|(
name|key
argument_list|,
name|offset
argument_list|)
decl_stmt|;
name|String
name|name
init|=
name|kp
operator|.
name|getNextString
argument_list|()
decl_stmt|;
name|Object
name|value
init|=
name|GenericObjectMapper
operator|.
name|read
argument_list|(
name|key
argument_list|,
name|kp
operator|.
name|getOffset
argument_list|()
argument_list|)
decl_stmt|;
name|entity
operator|.
name|addPrimaryFilter
argument_list|(
name|name
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
comment|/**    * Creates an other info key, serializing ENTITY_ENTRY_PREFIX + entity type +    * revstarttime + entity id + OTHER_INFO_COLUMN + name.    */
DECL|method|createOtherInfoKey (String entityId, String entityType, byte[] revStartTime, String name)
specifier|private
specifier|static
name|byte
index|[]
name|createOtherInfoKey
parameter_list|(
name|String
name|entityId
parameter_list|,
name|String
name|entityType
parameter_list|,
name|byte
index|[]
name|revStartTime
parameter_list|,
name|String
name|name
parameter_list|)
throws|throws
name|IOException
block|{
return|return
name|KeyBuilder
operator|.
name|newInstance
argument_list|()
operator|.
name|add
argument_list|(
name|ENTITY_ENTRY_PREFIX
argument_list|)
operator|.
name|add
argument_list|(
name|entityType
argument_list|)
operator|.
name|add
argument_list|(
name|revStartTime
argument_list|)
operator|.
name|add
argument_list|(
name|entityId
argument_list|)
operator|.
name|add
argument_list|(
name|OTHER_INFO_COLUMN
argument_list|)
operator|.
name|add
argument_list|(
name|name
argument_list|)
operator|.
name|getBytes
argument_list|()
return|;
block|}
comment|/**    * Creates a string representation of the byte array from the given offset    * to the end of the array (for parsing other info keys).    */
DECL|method|parseRemainingKey (byte[] b, int offset)
specifier|private
specifier|static
name|String
name|parseRemainingKey
parameter_list|(
name|byte
index|[]
name|b
parameter_list|,
name|int
name|offset
parameter_list|)
block|{
return|return
operator|new
name|String
argument_list|(
name|b
argument_list|,
name|offset
argument_list|,
name|b
operator|.
name|length
operator|-
name|offset
argument_list|,
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
return|;
block|}
comment|/**    * Creates a related entity key, serializing ENTITY_ENTRY_PREFIX +    * entity type + revstarttime + entity id + RELATED_ENTITIES_COLUMN +    * relatedentity type + relatedentity id.    */
DECL|method|createRelatedEntityKey (String entityId, String entityType, byte[] revStartTime, String relatedEntityId, String relatedEntityType)
specifier|private
specifier|static
name|byte
index|[]
name|createRelatedEntityKey
parameter_list|(
name|String
name|entityId
parameter_list|,
name|String
name|entityType
parameter_list|,
name|byte
index|[]
name|revStartTime
parameter_list|,
name|String
name|relatedEntityId
parameter_list|,
name|String
name|relatedEntityType
parameter_list|)
throws|throws
name|IOException
block|{
return|return
name|KeyBuilder
operator|.
name|newInstance
argument_list|()
operator|.
name|add
argument_list|(
name|ENTITY_ENTRY_PREFIX
argument_list|)
operator|.
name|add
argument_list|(
name|entityType
argument_list|)
operator|.
name|add
argument_list|(
name|revStartTime
argument_list|)
operator|.
name|add
argument_list|(
name|entityId
argument_list|)
operator|.
name|add
argument_list|(
name|RELATED_ENTITIES_COLUMN
argument_list|)
operator|.
name|add
argument_list|(
name|relatedEntityType
argument_list|)
operator|.
name|add
argument_list|(
name|relatedEntityId
argument_list|)
operator|.
name|getBytes
argument_list|()
return|;
block|}
comment|/**    * Parses the related entity from the given key at the given offset and    * adds it to the given entity.    */
DECL|method|addRelatedEntity (TimelineEntity entity, byte[] key, int offset)
specifier|private
specifier|static
name|void
name|addRelatedEntity
parameter_list|(
name|TimelineEntity
name|entity
parameter_list|,
name|byte
index|[]
name|key
parameter_list|,
name|int
name|offset
parameter_list|)
throws|throws
name|IOException
block|{
name|KeyParser
name|kp
init|=
operator|new
name|KeyParser
argument_list|(
name|key
argument_list|,
name|offset
argument_list|)
decl_stmt|;
name|String
name|type
init|=
name|kp
operator|.
name|getNextString
argument_list|()
decl_stmt|;
name|String
name|id
init|=
name|kp
operator|.
name|getNextString
argument_list|()
decl_stmt|;
name|entity
operator|.
name|addRelatedEntity
argument_list|(
name|type
argument_list|,
name|id
argument_list|)
expr_stmt|;
block|}
comment|/**    * Creates a reverse related entity key, serializing ENTITY_ENTRY_PREFIX +    * entity type + revstarttime + entity id +    * INVISIBLE_REVERSE_RELATED_ENTITIES_COLUMN +    * relatedentity type + relatedentity id.    */
DECL|method|createReverseRelatedEntityKey (String entityId, String entityType, byte[] revStartTime, String relatedEntityId, String relatedEntityType)
specifier|private
specifier|static
name|byte
index|[]
name|createReverseRelatedEntityKey
parameter_list|(
name|String
name|entityId
parameter_list|,
name|String
name|entityType
parameter_list|,
name|byte
index|[]
name|revStartTime
parameter_list|,
name|String
name|relatedEntityId
parameter_list|,
name|String
name|relatedEntityType
parameter_list|)
throws|throws
name|IOException
block|{
return|return
name|KeyBuilder
operator|.
name|newInstance
argument_list|()
operator|.
name|add
argument_list|(
name|ENTITY_ENTRY_PREFIX
argument_list|)
operator|.
name|add
argument_list|(
name|entityType
argument_list|)
operator|.
name|add
argument_list|(
name|revStartTime
argument_list|)
operator|.
name|add
argument_list|(
name|entityId
argument_list|)
operator|.
name|add
argument_list|(
name|INVISIBLE_REVERSE_RELATED_ENTITIES_COLUMN
argument_list|)
operator|.
name|add
argument_list|(
name|relatedEntityType
argument_list|)
operator|.
name|add
argument_list|(
name|relatedEntityId
argument_list|)
operator|.
name|getBytes
argument_list|()
return|;
block|}
comment|/**    * Creates a domain id key, serializing ENTITY_ENTRY_PREFIX +    * entity type + revstarttime + entity id + DOMAIN_ID_COLUMN.    */
DECL|method|createDomainIdKey (String entityId, String entityType, byte[] revStartTime)
specifier|private
specifier|static
name|byte
index|[]
name|createDomainIdKey
parameter_list|(
name|String
name|entityId
parameter_list|,
name|String
name|entityType
parameter_list|,
name|byte
index|[]
name|revStartTime
parameter_list|)
throws|throws
name|IOException
block|{
return|return
name|KeyBuilder
operator|.
name|newInstance
argument_list|()
operator|.
name|add
argument_list|(
name|ENTITY_ENTRY_PREFIX
argument_list|)
operator|.
name|add
argument_list|(
name|entityType
argument_list|)
operator|.
name|add
argument_list|(
name|revStartTime
argument_list|)
operator|.
name|add
argument_list|(
name|entityId
argument_list|)
operator|.
name|add
argument_list|(
name|DOMAIN_ID_COLUMN
argument_list|)
operator|.
name|getBytes
argument_list|()
return|;
block|}
comment|/**    * Clears the cache to test reloading start times from leveldb (only for    * testing).    */
annotation|@
name|VisibleForTesting
DECL|method|clearStartTimeCache ()
name|void
name|clearStartTimeCache
parameter_list|()
block|{
name|startTimeWriteCache
operator|.
name|clear
argument_list|()
expr_stmt|;
name|startTimeReadCache
operator|.
name|clear
argument_list|()
expr_stmt|;
block|}
annotation|@
name|VisibleForTesting
DECL|method|getStartTimeReadCacheSize (Configuration conf)
specifier|static
name|int
name|getStartTimeReadCacheSize
parameter_list|(
name|Configuration
name|conf
parameter_list|)
block|{
return|return
name|conf
operator|.
name|getInt
argument_list|(
name|YarnConfiguration
operator|.
name|TIMELINE_SERVICE_LEVELDB_START_TIME_READ_CACHE_SIZE
argument_list|,
name|YarnConfiguration
operator|.
name|DEFAULT_TIMELINE_SERVICE_LEVELDB_START_TIME_READ_CACHE_SIZE
argument_list|)
return|;
block|}
annotation|@
name|VisibleForTesting
DECL|method|getStartTimeWriteCacheSize (Configuration conf)
specifier|static
name|int
name|getStartTimeWriteCacheSize
parameter_list|(
name|Configuration
name|conf
parameter_list|)
block|{
return|return
name|conf
operator|.
name|getInt
argument_list|(
name|YarnConfiguration
operator|.
name|TIMELINE_SERVICE_LEVELDB_START_TIME_WRITE_CACHE_SIZE
argument_list|,
name|YarnConfiguration
operator|.
name|DEFAULT_TIMELINE_SERVICE_LEVELDB_START_TIME_WRITE_CACHE_SIZE
argument_list|)
return|;
block|}
annotation|@
name|VisibleForTesting
DECL|method|getEntityTypes ()
name|List
argument_list|<
name|String
argument_list|>
name|getEntityTypes
parameter_list|()
throws|throws
name|IOException
block|{
name|LeveldbIterator
name|iterator
init|=
literal|null
decl_stmt|;
try|try
block|{
name|iterator
operator|=
name|getDbIterator
argument_list|(
literal|false
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|entityTypes
init|=
operator|new
name|ArrayList
argument_list|<
name|String
argument_list|>
argument_list|()
decl_stmt|;
name|iterator
operator|.
name|seek
argument_list|(
name|ENTITY_ENTRY_PREFIX
argument_list|)
expr_stmt|;
while|while
condition|(
name|iterator
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|byte
index|[]
name|key
init|=
name|iterator
operator|.
name|peekNext
argument_list|()
operator|.
name|getKey
argument_list|()
decl_stmt|;
if|if
condition|(
name|key
index|[
literal|0
index|]
operator|!=
name|ENTITY_ENTRY_PREFIX
index|[
literal|0
index|]
condition|)
block|{
break|break;
block|}
name|KeyParser
name|kp
init|=
operator|new
name|KeyParser
argument_list|(
name|key
argument_list|,
name|ENTITY_ENTRY_PREFIX
operator|.
name|length
argument_list|)
decl_stmt|;
name|String
name|entityType
init|=
name|kp
operator|.
name|getNextString
argument_list|()
decl_stmt|;
name|entityTypes
operator|.
name|add
argument_list|(
name|entityType
argument_list|)
expr_stmt|;
name|byte
index|[]
name|lookupKey
init|=
name|KeyBuilder
operator|.
name|newInstance
argument_list|()
operator|.
name|add
argument_list|(
name|ENTITY_ENTRY_PREFIX
argument_list|)
operator|.
name|add
argument_list|(
name|entityType
argument_list|)
operator|.
name|getBytesForLookup
argument_list|()
decl_stmt|;
if|if
condition|(
name|lookupKey
index|[
name|lookupKey
operator|.
name|length
operator|-
literal|1
index|]
operator|!=
literal|0x0
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Found unexpected end byte in lookup key"
argument_list|)
throw|;
block|}
name|lookupKey
index|[
name|lookupKey
operator|.
name|length
operator|-
literal|1
index|]
operator|=
literal|0x1
expr_stmt|;
name|iterator
operator|.
name|seek
argument_list|(
name|lookupKey
argument_list|)
expr_stmt|;
block|}
return|return
name|entityTypes
return|;
block|}
catch|catch
parameter_list|(
name|DBException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
name|IOUtils
operator|.
name|cleanupWithLogger
argument_list|(
name|LOG
argument_list|,
name|iterator
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**    * Finds all keys in the db that have a given prefix and deletes them on    * the given write batch.    */
DECL|method|deleteKeysWithPrefix (WriteBatch writeBatch, byte[] prefix, LeveldbIterator iterator)
specifier|private
name|void
name|deleteKeysWithPrefix
parameter_list|(
name|WriteBatch
name|writeBatch
parameter_list|,
name|byte
index|[]
name|prefix
parameter_list|,
name|LeveldbIterator
name|iterator
parameter_list|)
block|{
for|for
control|(
name|iterator
operator|.
name|seek
argument_list|(
name|prefix
argument_list|)
init|;
name|iterator
operator|.
name|hasNext
argument_list|()
condition|;
name|iterator
operator|.
name|next
argument_list|()
control|)
block|{
name|byte
index|[]
name|key
init|=
name|iterator
operator|.
name|peekNext
argument_list|()
operator|.
name|getKey
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|prefixMatches
argument_list|(
name|prefix
argument_list|,
name|prefix
operator|.
name|length
argument_list|,
name|key
argument_list|)
condition|)
block|{
break|break;
block|}
name|writeBatch
operator|.
name|delete
argument_list|(
name|key
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|VisibleForTesting
DECL|method|deleteNextEntity (String entityType, byte[] reverseTimestamp, LeveldbIterator iterator, LeveldbIterator pfIterator, boolean seeked)
name|boolean
name|deleteNextEntity
parameter_list|(
name|String
name|entityType
parameter_list|,
name|byte
index|[]
name|reverseTimestamp
parameter_list|,
name|LeveldbIterator
name|iterator
parameter_list|,
name|LeveldbIterator
name|pfIterator
parameter_list|,
name|boolean
name|seeked
parameter_list|)
throws|throws
name|IOException
block|{
name|WriteBatch
name|writeBatch
init|=
literal|null
decl_stmt|;
try|try
block|{
name|KeyBuilder
name|kb
init|=
name|KeyBuilder
operator|.
name|newInstance
argument_list|()
operator|.
name|add
argument_list|(
name|ENTITY_ENTRY_PREFIX
argument_list|)
operator|.
name|add
argument_list|(
name|entityType
argument_list|)
decl_stmt|;
name|byte
index|[]
name|typePrefix
init|=
name|kb
operator|.
name|getBytesForLookup
argument_list|()
decl_stmt|;
name|kb
operator|.
name|add
argument_list|(
name|reverseTimestamp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|seeked
condition|)
block|{
name|iterator
operator|.
name|seek
argument_list|(
name|kb
operator|.
name|getBytesForLookup
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|iterator
operator|.
name|hasNext
argument_list|()
condition|)
block|{
return|return
literal|false
return|;
block|}
name|byte
index|[]
name|entityKey
init|=
name|iterator
operator|.
name|peekNext
argument_list|()
operator|.
name|getKey
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|prefixMatches
argument_list|(
name|typePrefix
argument_list|,
name|typePrefix
operator|.
name|length
argument_list|,
name|entityKey
argument_list|)
condition|)
block|{
return|return
literal|false
return|;
block|}
comment|// read the start time and entity id from the current key
name|KeyParser
name|kp
init|=
operator|new
name|KeyParser
argument_list|(
name|entityKey
argument_list|,
name|typePrefix
operator|.
name|length
operator|+
literal|8
argument_list|)
decl_stmt|;
name|String
name|entityId
init|=
name|kp
operator|.
name|getNextString
argument_list|()
decl_stmt|;
name|int
name|prefixlen
init|=
name|kp
operator|.
name|getOffset
argument_list|()
decl_stmt|;
name|byte
index|[]
name|deletePrefix
init|=
operator|new
name|byte
index|[
name|prefixlen
index|]
decl_stmt|;
name|System
operator|.
name|arraycopy
argument_list|(
name|entityKey
argument_list|,
literal|0
argument_list|,
name|deletePrefix
argument_list|,
literal|0
argument_list|,
name|prefixlen
argument_list|)
expr_stmt|;
name|writeBatch
operator|=
name|db
operator|.
name|createWriteBatch
argument_list|()
expr_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Deleting entity type:"
operator|+
name|entityType
operator|+
literal|" id:"
operator|+
name|entityId
argument_list|)
expr_stmt|;
block|}
comment|// remove start time from cache and db
name|writeBatch
operator|.
name|delete
argument_list|(
name|createStartTimeLookupKey
argument_list|(
name|entityId
argument_list|,
name|entityType
argument_list|)
argument_list|)
expr_stmt|;
name|EntityIdentifier
name|entityIdentifier
init|=
operator|new
name|EntityIdentifier
argument_list|(
name|entityId
argument_list|,
name|entityType
argument_list|)
decl_stmt|;
name|startTimeReadCache
operator|.
name|remove
argument_list|(
name|entityIdentifier
argument_list|)
expr_stmt|;
name|startTimeWriteCache
operator|.
name|remove
argument_list|(
name|entityIdentifier
argument_list|)
expr_stmt|;
comment|// delete current entity
for|for
control|(
init|;
name|iterator
operator|.
name|hasNext
argument_list|()
condition|;
name|iterator
operator|.
name|next
argument_list|()
control|)
block|{
name|byte
index|[]
name|key
init|=
name|iterator
operator|.
name|peekNext
argument_list|()
operator|.
name|getKey
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|prefixMatches
argument_list|(
name|entityKey
argument_list|,
name|prefixlen
argument_list|,
name|key
argument_list|)
condition|)
block|{
break|break;
block|}
name|writeBatch
operator|.
name|delete
argument_list|(
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|.
name|length
operator|==
name|prefixlen
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|key
index|[
name|prefixlen
index|]
operator|==
name|PRIMARY_FILTERS_COLUMN
index|[
literal|0
index|]
condition|)
block|{
name|kp
operator|=
operator|new
name|KeyParser
argument_list|(
name|key
argument_list|,
name|prefixlen
operator|+
name|PRIMARY_FILTERS_COLUMN
operator|.
name|length
argument_list|)
expr_stmt|;
name|String
name|name
init|=
name|kp
operator|.
name|getNextString
argument_list|()
decl_stmt|;
name|Object
name|value
init|=
name|GenericObjectMapper
operator|.
name|read
argument_list|(
name|key
argument_list|,
name|kp
operator|.
name|getOffset
argument_list|()
argument_list|)
decl_stmt|;
name|deleteKeysWithPrefix
argument_list|(
name|writeBatch
argument_list|,
name|addPrimaryFilterToKey
argument_list|(
name|name
argument_list|,
name|value
argument_list|,
name|deletePrefix
argument_list|)
argument_list|,
name|pfIterator
argument_list|)
expr_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Deleting entity type:"
operator|+
name|entityType
operator|+
literal|" id:"
operator|+
name|entityId
operator|+
literal|" primary filter entry "
operator|+
name|name
operator|+
literal|" "
operator|+
name|value
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|key
index|[
name|prefixlen
index|]
operator|==
name|RELATED_ENTITIES_COLUMN
index|[
literal|0
index|]
condition|)
block|{
name|kp
operator|=
operator|new
name|KeyParser
argument_list|(
name|key
argument_list|,
name|prefixlen
operator|+
name|RELATED_ENTITIES_COLUMN
operator|.
name|length
argument_list|)
expr_stmt|;
name|String
name|type
init|=
name|kp
operator|.
name|getNextString
argument_list|()
decl_stmt|;
name|String
name|id
init|=
name|kp
operator|.
name|getNextString
argument_list|()
decl_stmt|;
name|byte
index|[]
name|relatedEntityStartTime
init|=
name|getStartTime
argument_list|(
name|id
argument_list|,
name|type
argument_list|)
decl_stmt|;
if|if
condition|(
name|relatedEntityStartTime
operator|==
literal|null
condition|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Found no start time for "
operator|+
literal|"related entity "
operator|+
name|id
operator|+
literal|" of type "
operator|+
name|type
operator|+
literal|" while "
operator|+
literal|"deleting "
operator|+
name|entityId
operator|+
literal|" of type "
operator|+
name|entityType
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|writeBatch
operator|.
name|delete
argument_list|(
name|createReverseRelatedEntityKey
argument_list|(
name|id
argument_list|,
name|type
argument_list|,
name|relatedEntityStartTime
argument_list|,
name|entityId
argument_list|,
name|entityType
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Deleting entity type:"
operator|+
name|entityType
operator|+
literal|" id:"
operator|+
name|entityId
operator|+
literal|" from invisible reverse related entity "
operator|+
literal|"entry of type:"
operator|+
name|type
operator|+
literal|" id:"
operator|+
name|id
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|key
index|[
name|prefixlen
index|]
operator|==
name|INVISIBLE_REVERSE_RELATED_ENTITIES_COLUMN
index|[
literal|0
index|]
condition|)
block|{
name|kp
operator|=
operator|new
name|KeyParser
argument_list|(
name|key
argument_list|,
name|prefixlen
operator|+
name|INVISIBLE_REVERSE_RELATED_ENTITIES_COLUMN
operator|.
name|length
argument_list|)
expr_stmt|;
name|String
name|type
init|=
name|kp
operator|.
name|getNextString
argument_list|()
decl_stmt|;
name|String
name|id
init|=
name|kp
operator|.
name|getNextString
argument_list|()
decl_stmt|;
name|byte
index|[]
name|relatedEntityStartTime
init|=
name|getStartTime
argument_list|(
name|id
argument_list|,
name|type
argument_list|)
decl_stmt|;
if|if
condition|(
name|relatedEntityStartTime
operator|==
literal|null
condition|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Found no start time for reverse "
operator|+
literal|"related entity "
operator|+
name|id
operator|+
literal|" of type "
operator|+
name|type
operator|+
literal|" while "
operator|+
literal|"deleting "
operator|+
name|entityId
operator|+
literal|" of type "
operator|+
name|entityType
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|writeBatch
operator|.
name|delete
argument_list|(
name|createRelatedEntityKey
argument_list|(
name|id
argument_list|,
name|type
argument_list|,
name|relatedEntityStartTime
argument_list|,
name|entityId
argument_list|,
name|entityType
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Deleting entity type:"
operator|+
name|entityType
operator|+
literal|" id:"
operator|+
name|entityId
operator|+
literal|" from related entity entry of type:"
operator|+
name|type
operator|+
literal|" id:"
operator|+
name|id
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|WriteOptions
name|writeOptions
init|=
operator|new
name|WriteOptions
argument_list|()
decl_stmt|;
name|writeOptions
operator|.
name|sync
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|db
operator|.
name|write
argument_list|(
name|writeBatch
argument_list|,
name|writeOptions
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
catch|catch
parameter_list|(
name|DBException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
name|IOUtils
operator|.
name|cleanupWithLogger
argument_list|(
name|LOG
argument_list|,
name|writeBatch
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**    * Discards entities with start timestamp less than or equal to the given    * timestamp.    */
annotation|@
name|VisibleForTesting
DECL|method|discardOldEntities (long timestamp)
name|void
name|discardOldEntities
parameter_list|(
name|long
name|timestamp
parameter_list|)
throws|throws
name|IOException
throws|,
name|InterruptedException
block|{
name|byte
index|[]
name|reverseTimestamp
init|=
name|writeReverseOrderedLong
argument_list|(
name|timestamp
argument_list|)
decl_stmt|;
name|long
name|totalCount
init|=
literal|0
decl_stmt|;
name|long
name|t1
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
try|try
block|{
name|List
argument_list|<
name|String
argument_list|>
name|entityTypes
init|=
name|getEntityTypes
argument_list|()
decl_stmt|;
for|for
control|(
name|String
name|entityType
range|:
name|entityTypes
control|)
block|{
name|LeveldbIterator
name|iterator
init|=
literal|null
decl_stmt|;
name|LeveldbIterator
name|pfIterator
init|=
literal|null
decl_stmt|;
name|long
name|typeCount
init|=
literal|0
decl_stmt|;
name|deleteLock
operator|.
name|writeLock
argument_list|()
operator|.
name|lock
argument_list|()
expr_stmt|;
try|try
block|{
name|iterator
operator|=
name|getDbIterator
argument_list|(
literal|false
argument_list|)
expr_stmt|;
name|pfIterator
operator|=
name|getDbIterator
argument_list|(
literal|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|deletionThread
operator|!=
literal|null
operator|&&
name|deletionThread
operator|.
name|isInterrupted
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|InterruptedException
argument_list|()
throw|;
block|}
name|boolean
name|seeked
init|=
literal|false
decl_stmt|;
while|while
condition|(
name|deleteNextEntity
argument_list|(
name|entityType
argument_list|,
name|reverseTimestamp
argument_list|,
name|iterator
argument_list|,
name|pfIterator
argument_list|,
name|seeked
argument_list|)
condition|)
block|{
name|typeCount
operator|++
expr_stmt|;
name|totalCount
operator|++
expr_stmt|;
name|seeked
operator|=
literal|true
expr_stmt|;
if|if
condition|(
name|deletionThread
operator|!=
literal|null
operator|&&
name|deletionThread
operator|.
name|isInterrupted
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|InterruptedException
argument_list|()
throw|;
block|}
block|}
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Got IOException while deleting entities for type "
operator|+
name|entityType
operator|+
literal|", continuing to next type"
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|IOUtils
operator|.
name|cleanupWithLogger
argument_list|(
name|LOG
argument_list|,
name|iterator
argument_list|,
name|pfIterator
argument_list|)
expr_stmt|;
name|deleteLock
operator|.
name|writeLock
argument_list|()
operator|.
name|unlock
argument_list|()
expr_stmt|;
if|if
condition|(
name|typeCount
operator|>
literal|0
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Deleted "
operator|+
name|typeCount
operator|+
literal|" entities of type "
operator|+
name|entityType
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
finally|finally
block|{
name|long
name|t2
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Discarded "
operator|+
name|totalCount
operator|+
literal|" entities for timestamp "
operator|+
name|timestamp
operator|+
literal|" and earlier in "
operator|+
operator|(
name|t2
operator|-
name|t1
operator|)
operator|/
literal|1000.0
operator|+
literal|" seconds"
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|VisibleForTesting
DECL|method|getDbIterator (boolean fillCache)
name|LeveldbIterator
name|getDbIterator
parameter_list|(
name|boolean
name|fillCache
parameter_list|)
block|{
name|ReadOptions
name|readOptions
init|=
operator|new
name|ReadOptions
argument_list|()
decl_stmt|;
name|readOptions
operator|.
name|fillCache
argument_list|(
name|fillCache
argument_list|)
expr_stmt|;
return|return
operator|new
name|LeveldbIterator
argument_list|(
name|db
argument_list|,
name|readOptions
argument_list|)
return|;
block|}
DECL|method|loadVersion ()
name|Version
name|loadVersion
parameter_list|()
throws|throws
name|IOException
block|{
try|try
block|{
name|byte
index|[]
name|data
init|=
name|db
operator|.
name|get
argument_list|(
name|bytes
argument_list|(
name|TIMELINE_STORE_VERSION_KEY
argument_list|)
argument_list|)
decl_stmt|;
comment|// if version is not stored previously, treat it as CURRENT_VERSION_INFO.
if|if
condition|(
name|data
operator|==
literal|null
operator|||
name|data
operator|.
name|length
operator|==
literal|0
condition|)
block|{
return|return
name|getCurrentVersion
argument_list|()
return|;
block|}
name|Version
name|version
init|=
operator|new
name|VersionPBImpl
argument_list|(
name|VersionProto
operator|.
name|parseFrom
argument_list|(
name|data
argument_list|)
argument_list|)
decl_stmt|;
return|return
name|version
return|;
block|}
catch|catch
parameter_list|(
name|DBException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
comment|// Only used for test
annotation|@
name|VisibleForTesting
DECL|method|storeVersion (Version state)
name|void
name|storeVersion
parameter_list|(
name|Version
name|state
parameter_list|)
throws|throws
name|IOException
block|{
name|dbStoreVersion
argument_list|(
name|state
argument_list|)
expr_stmt|;
block|}
DECL|method|dbStoreVersion (Version state)
specifier|private
name|void
name|dbStoreVersion
parameter_list|(
name|Version
name|state
parameter_list|)
throws|throws
name|IOException
block|{
name|String
name|key
init|=
name|TIMELINE_STORE_VERSION_KEY
decl_stmt|;
name|byte
index|[]
name|data
init|=
operator|(
operator|(
name|VersionPBImpl
operator|)
name|state
operator|)
operator|.
name|getProto
argument_list|()
operator|.
name|toByteArray
argument_list|()
decl_stmt|;
try|try
block|{
name|db
operator|.
name|put
argument_list|(
name|bytes
argument_list|(
name|key
argument_list|)
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|DBException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
DECL|method|getCurrentVersion ()
name|Version
name|getCurrentVersion
parameter_list|()
block|{
return|return
name|CURRENT_VERSION_INFO
return|;
block|}
comment|/**    * 1) Versioning timeline store: major.minor. For e.g. 1.0, 1.1, 1.2...1.25, 2.0 etc.    * 2) Any incompatible change of TS-store is a major upgrade, and any    *    compatible change of TS-store is a minor upgrade.    * 3) Within a minor upgrade, say 1.1 to 1.2:    *    overwrite the version info and proceed as normal.    * 4) Within a major upgrade, say 1.2 to 2.0:    *    throw exception and indicate user to use a separate upgrade tool to    *    upgrade timeline store or remove incompatible old state.    */
DECL|method|checkVersion ()
specifier|private
name|void
name|checkVersion
parameter_list|()
throws|throws
name|IOException
block|{
name|Version
name|loadedVersion
init|=
name|loadVersion
argument_list|()
decl_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Loaded timeline store version info "
operator|+
name|loadedVersion
argument_list|)
expr_stmt|;
if|if
condition|(
name|loadedVersion
operator|.
name|equals
argument_list|(
name|getCurrentVersion
argument_list|()
argument_list|)
condition|)
block|{
return|return;
block|}
if|if
condition|(
name|loadedVersion
operator|.
name|isCompatibleTo
argument_list|(
name|getCurrentVersion
argument_list|()
argument_list|)
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Storing timeline store version info "
operator|+
name|getCurrentVersion
argument_list|()
argument_list|)
expr_stmt|;
name|dbStoreVersion
argument_list|(
name|CURRENT_VERSION_INFO
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|String
name|incompatibleMessage
init|=
literal|"Incompatible version for timeline store: expecting version "
operator|+
name|getCurrentVersion
argument_list|()
operator|+
literal|", but loading version "
operator|+
name|loadedVersion
decl_stmt|;
name|LOG
operator|.
name|error
argument_list|(
name|incompatibleMessage
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|IOException
argument_list|(
name|incompatibleMessage
argument_list|)
throw|;
block|}
block|}
comment|//TODO: make data retention work with the domain data as well
annotation|@
name|Override
DECL|method|put (TimelineDomain domain)
specifier|public
name|void
name|put
parameter_list|(
name|TimelineDomain
name|domain
parameter_list|)
throws|throws
name|IOException
block|{
name|WriteBatch
name|writeBatch
init|=
literal|null
decl_stmt|;
try|try
block|{
name|writeBatch
operator|=
name|db
operator|.
name|createWriteBatch
argument_list|()
expr_stmt|;
if|if
condition|(
name|domain
operator|.
name|getId
argument_list|()
operator|==
literal|null
operator|||
name|domain
operator|.
name|getId
argument_list|()
operator|.
name|length
argument_list|()
operator|==
literal|0
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"Domain doesn't have an ID"
argument_list|)
throw|;
block|}
if|if
condition|(
name|domain
operator|.
name|getOwner
argument_list|()
operator|==
literal|null
operator|||
name|domain
operator|.
name|getOwner
argument_list|()
operator|.
name|length
argument_list|()
operator|==
literal|0
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"Domain doesn't have an owner."
argument_list|)
throw|;
block|}
comment|// Write description
name|byte
index|[]
name|domainEntryKey
init|=
name|createDomainEntryKey
argument_list|(
name|domain
operator|.
name|getId
argument_list|()
argument_list|,
name|DESCRIPTION_COLUMN
argument_list|)
decl_stmt|;
name|byte
index|[]
name|ownerLookupEntryKey
init|=
name|createOwnerLookupKey
argument_list|(
name|domain
operator|.
name|getOwner
argument_list|()
argument_list|,
name|domain
operator|.
name|getId
argument_list|()
argument_list|,
name|DESCRIPTION_COLUMN
argument_list|)
decl_stmt|;
if|if
condition|(
name|domain
operator|.
name|getDescription
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|writeBatch
operator|.
name|put
argument_list|(
name|domainEntryKey
argument_list|,
name|domain
operator|.
name|getDescription
argument_list|()
operator|.
name|getBytes
argument_list|(
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|writeBatch
operator|.
name|put
argument_list|(
name|ownerLookupEntryKey
argument_list|,
name|domain
operator|.
name|getDescription
argument_list|()
operator|.
name|getBytes
argument_list|(
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|writeBatch
operator|.
name|put
argument_list|(
name|domainEntryKey
argument_list|,
name|EMPTY_BYTES
argument_list|)
expr_stmt|;
name|writeBatch
operator|.
name|put
argument_list|(
name|ownerLookupEntryKey
argument_list|,
name|EMPTY_BYTES
argument_list|)
expr_stmt|;
block|}
comment|// Write owner
name|domainEntryKey
operator|=
name|createDomainEntryKey
argument_list|(
name|domain
operator|.
name|getId
argument_list|()
argument_list|,
name|OWNER_COLUMN
argument_list|)
expr_stmt|;
name|ownerLookupEntryKey
operator|=
name|createOwnerLookupKey
argument_list|(
name|domain
operator|.
name|getOwner
argument_list|()
argument_list|,
name|domain
operator|.
name|getId
argument_list|()
argument_list|,
name|OWNER_COLUMN
argument_list|)
expr_stmt|;
comment|// Null check for owner is done before
name|writeBatch
operator|.
name|put
argument_list|(
name|domainEntryKey
argument_list|,
name|domain
operator|.
name|getOwner
argument_list|()
operator|.
name|getBytes
argument_list|(
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|writeBatch
operator|.
name|put
argument_list|(
name|ownerLookupEntryKey
argument_list|,
name|domain
operator|.
name|getOwner
argument_list|()
operator|.
name|getBytes
argument_list|(
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|// Write readers
name|domainEntryKey
operator|=
name|createDomainEntryKey
argument_list|(
name|domain
operator|.
name|getId
argument_list|()
argument_list|,
name|READER_COLUMN
argument_list|)
expr_stmt|;
name|ownerLookupEntryKey
operator|=
name|createOwnerLookupKey
argument_list|(
name|domain
operator|.
name|getOwner
argument_list|()
argument_list|,
name|domain
operator|.
name|getId
argument_list|()
argument_list|,
name|READER_COLUMN
argument_list|)
expr_stmt|;
if|if
condition|(
name|domain
operator|.
name|getReaders
argument_list|()
operator|!=
literal|null
operator|&&
name|domain
operator|.
name|getReaders
argument_list|()
operator|.
name|length
argument_list|()
operator|>
literal|0
condition|)
block|{
name|writeBatch
operator|.
name|put
argument_list|(
name|domainEntryKey
argument_list|,
name|domain
operator|.
name|getReaders
argument_list|()
operator|.
name|getBytes
argument_list|(
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|writeBatch
operator|.
name|put
argument_list|(
name|ownerLookupEntryKey
argument_list|,
name|domain
operator|.
name|getReaders
argument_list|()
operator|.
name|getBytes
argument_list|(
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|writeBatch
operator|.
name|put
argument_list|(
name|domainEntryKey
argument_list|,
name|EMPTY_BYTES
argument_list|)
expr_stmt|;
name|writeBatch
operator|.
name|put
argument_list|(
name|ownerLookupEntryKey
argument_list|,
name|EMPTY_BYTES
argument_list|)
expr_stmt|;
block|}
comment|// Write writers
name|domainEntryKey
operator|=
name|createDomainEntryKey
argument_list|(
name|domain
operator|.
name|getId
argument_list|()
argument_list|,
name|WRITER_COLUMN
argument_list|)
expr_stmt|;
name|ownerLookupEntryKey
operator|=
name|createOwnerLookupKey
argument_list|(
name|domain
operator|.
name|getOwner
argument_list|()
argument_list|,
name|domain
operator|.
name|getId
argument_list|()
argument_list|,
name|WRITER_COLUMN
argument_list|)
expr_stmt|;
if|if
condition|(
name|domain
operator|.
name|getWriters
argument_list|()
operator|!=
literal|null
operator|&&
name|domain
operator|.
name|getWriters
argument_list|()
operator|.
name|length
argument_list|()
operator|>
literal|0
condition|)
block|{
name|writeBatch
operator|.
name|put
argument_list|(
name|domainEntryKey
argument_list|,
name|domain
operator|.
name|getWriters
argument_list|()
operator|.
name|getBytes
argument_list|(
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|writeBatch
operator|.
name|put
argument_list|(
name|ownerLookupEntryKey
argument_list|,
name|domain
operator|.
name|getWriters
argument_list|()
operator|.
name|getBytes
argument_list|(
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|writeBatch
operator|.
name|put
argument_list|(
name|domainEntryKey
argument_list|,
name|EMPTY_BYTES
argument_list|)
expr_stmt|;
name|writeBatch
operator|.
name|put
argument_list|(
name|ownerLookupEntryKey
argument_list|,
name|EMPTY_BYTES
argument_list|)
expr_stmt|;
block|}
comment|// Write creation time and modification time
comment|// We put both timestamps together because they are always retrieved
comment|// together, and store them in the same way as we did for the entity's
comment|// start time and insert time.
name|domainEntryKey
operator|=
name|createDomainEntryKey
argument_list|(
name|domain
operator|.
name|getId
argument_list|()
argument_list|,
name|TIMESTAMP_COLUMN
argument_list|)
expr_stmt|;
name|ownerLookupEntryKey
operator|=
name|createOwnerLookupKey
argument_list|(
name|domain
operator|.
name|getOwner
argument_list|()
argument_list|,
name|domain
operator|.
name|getId
argument_list|()
argument_list|,
name|TIMESTAMP_COLUMN
argument_list|)
expr_stmt|;
name|long
name|currentTimestamp
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|byte
index|[]
name|timestamps
init|=
name|db
operator|.
name|get
argument_list|(
name|domainEntryKey
argument_list|)
decl_stmt|;
if|if
condition|(
name|timestamps
operator|==
literal|null
condition|)
block|{
name|timestamps
operator|=
operator|new
name|byte
index|[
literal|16
index|]
expr_stmt|;
name|writeReverseOrderedLong
argument_list|(
name|currentTimestamp
argument_list|,
name|timestamps
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|writeReverseOrderedLong
argument_list|(
name|currentTimestamp
argument_list|,
name|timestamps
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|writeReverseOrderedLong
argument_list|(
name|currentTimestamp
argument_list|,
name|timestamps
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
name|writeBatch
operator|.
name|put
argument_list|(
name|domainEntryKey
argument_list|,
name|timestamps
argument_list|)
expr_stmt|;
name|writeBatch
operator|.
name|put
argument_list|(
name|ownerLookupEntryKey
argument_list|,
name|timestamps
argument_list|)
expr_stmt|;
name|db
operator|.
name|write
argument_list|(
name|writeBatch
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|DBException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
name|IOUtils
operator|.
name|cleanupWithLogger
argument_list|(
name|LOG
argument_list|,
name|writeBatch
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**    * Creates a domain entity key with column name suffix,    * of the form DOMAIN_ENTRY_PREFIX + domain id + column name.    */
DECL|method|createDomainEntryKey (String domainId, byte[] columnName)
specifier|private
specifier|static
name|byte
index|[]
name|createDomainEntryKey
parameter_list|(
name|String
name|domainId
parameter_list|,
name|byte
index|[]
name|columnName
parameter_list|)
throws|throws
name|IOException
block|{
return|return
name|KeyBuilder
operator|.
name|newInstance
argument_list|()
operator|.
name|add
argument_list|(
name|DOMAIN_ENTRY_PREFIX
argument_list|)
operator|.
name|add
argument_list|(
name|domainId
argument_list|)
operator|.
name|add
argument_list|(
name|columnName
argument_list|)
operator|.
name|getBytes
argument_list|()
return|;
block|}
comment|/**    * Creates an owner lookup key with column name suffix,    * of the form OWNER_LOOKUP_PREFIX + owner + domain id + column name.    */
DECL|method|createOwnerLookupKey ( String owner, String domainId, byte[] columnName)
specifier|private
specifier|static
name|byte
index|[]
name|createOwnerLookupKey
parameter_list|(
name|String
name|owner
parameter_list|,
name|String
name|domainId
parameter_list|,
name|byte
index|[]
name|columnName
parameter_list|)
throws|throws
name|IOException
block|{
return|return
name|KeyBuilder
operator|.
name|newInstance
argument_list|()
operator|.
name|add
argument_list|(
name|OWNER_LOOKUP_PREFIX
argument_list|)
operator|.
name|add
argument_list|(
name|owner
argument_list|)
operator|.
name|add
argument_list|(
name|domainId
argument_list|)
operator|.
name|add
argument_list|(
name|columnName
argument_list|)
operator|.
name|getBytes
argument_list|()
return|;
block|}
annotation|@
name|Override
DECL|method|getDomain (String domainId)
specifier|public
name|TimelineDomain
name|getDomain
parameter_list|(
name|String
name|domainId
parameter_list|)
throws|throws
name|IOException
block|{
name|LeveldbIterator
name|iterator
init|=
literal|null
decl_stmt|;
try|try
block|{
name|byte
index|[]
name|prefix
init|=
name|KeyBuilder
operator|.
name|newInstance
argument_list|()
operator|.
name|add
argument_list|(
name|DOMAIN_ENTRY_PREFIX
argument_list|)
operator|.
name|add
argument_list|(
name|domainId
argument_list|)
operator|.
name|getBytesForLookup
argument_list|()
decl_stmt|;
name|iterator
operator|=
operator|new
name|LeveldbIterator
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|iterator
operator|.
name|seek
argument_list|(
name|prefix
argument_list|)
expr_stmt|;
return|return
name|getTimelineDomain
argument_list|(
name|iterator
argument_list|,
name|domainId
argument_list|,
name|prefix
argument_list|)
return|;
block|}
catch|catch
parameter_list|(
name|DBException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
name|IOUtils
operator|.
name|cleanupWithLogger
argument_list|(
name|LOG
argument_list|,
name|iterator
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|getDomains (String owner)
specifier|public
name|TimelineDomains
name|getDomains
parameter_list|(
name|String
name|owner
parameter_list|)
throws|throws
name|IOException
block|{
name|LeveldbIterator
name|iterator
init|=
literal|null
decl_stmt|;
try|try
block|{
name|byte
index|[]
name|prefix
init|=
name|KeyBuilder
operator|.
name|newInstance
argument_list|()
operator|.
name|add
argument_list|(
name|OWNER_LOOKUP_PREFIX
argument_list|)
operator|.
name|add
argument_list|(
name|owner
argument_list|)
operator|.
name|getBytesForLookup
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|TimelineDomain
argument_list|>
name|domains
init|=
operator|new
name|ArrayList
argument_list|<
name|TimelineDomain
argument_list|>
argument_list|()
decl_stmt|;
for|for
control|(
name|iterator
operator|=
operator|new
name|LeveldbIterator
argument_list|(
name|db
argument_list|)
operator|,
name|iterator
operator|.
name|seek
argument_list|(
name|prefix
argument_list|)
init|;
name|iterator
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|byte
index|[]
name|key
init|=
name|iterator
operator|.
name|peekNext
argument_list|()
operator|.
name|getKey
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|prefixMatches
argument_list|(
name|prefix
argument_list|,
name|prefix
operator|.
name|length
argument_list|,
name|key
argument_list|)
condition|)
block|{
break|break;
block|}
comment|// Iterator to parse the rows of an individual domain
name|KeyParser
name|kp
init|=
operator|new
name|KeyParser
argument_list|(
name|key
argument_list|,
name|prefix
operator|.
name|length
argument_list|)
decl_stmt|;
name|String
name|domainId
init|=
name|kp
operator|.
name|getNextString
argument_list|()
decl_stmt|;
name|byte
index|[]
name|prefixExt
init|=
name|KeyBuilder
operator|.
name|newInstance
argument_list|()
operator|.
name|add
argument_list|(
name|OWNER_LOOKUP_PREFIX
argument_list|)
operator|.
name|add
argument_list|(
name|owner
argument_list|)
operator|.
name|add
argument_list|(
name|domainId
argument_list|)
operator|.
name|getBytesForLookup
argument_list|()
decl_stmt|;
name|TimelineDomain
name|domainToReturn
init|=
name|getTimelineDomain
argument_list|(
name|iterator
argument_list|,
name|domainId
argument_list|,
name|prefixExt
argument_list|)
decl_stmt|;
if|if
condition|(
name|domainToReturn
operator|!=
literal|null
condition|)
block|{
name|domains
operator|.
name|add
argument_list|(
name|domainToReturn
argument_list|)
expr_stmt|;
block|}
block|}
comment|// Sort the domains to return
name|Collections
operator|.
name|sort
argument_list|(
name|domains
argument_list|,
operator|new
name|Comparator
argument_list|<
name|TimelineDomain
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|int
name|compare
parameter_list|(
name|TimelineDomain
name|domain1
parameter_list|,
name|TimelineDomain
name|domain2
parameter_list|)
block|{
name|int
name|result
init|=
name|domain2
operator|.
name|getCreatedTime
argument_list|()
operator|.
name|compareTo
argument_list|(
name|domain1
operator|.
name|getCreatedTime
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|result
operator|==
literal|0
condition|)
block|{
return|return
name|domain2
operator|.
name|getModifiedTime
argument_list|()
operator|.
name|compareTo
argument_list|(
name|domain1
operator|.
name|getModifiedTime
argument_list|()
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|result
return|;
block|}
block|}
block|}
argument_list|)
expr_stmt|;
name|TimelineDomains
name|domainsToReturn
init|=
operator|new
name|TimelineDomains
argument_list|()
decl_stmt|;
name|domainsToReturn
operator|.
name|addDomains
argument_list|(
name|domains
argument_list|)
expr_stmt|;
return|return
name|domainsToReturn
return|;
block|}
catch|catch
parameter_list|(
name|DBException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
name|IOUtils
operator|.
name|cleanupWithLogger
argument_list|(
name|LOG
argument_list|,
name|iterator
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|getTimelineDomain ( LeveldbIterator iterator, String domainId, byte[] prefix)
specifier|private
specifier|static
name|TimelineDomain
name|getTimelineDomain
parameter_list|(
name|LeveldbIterator
name|iterator
parameter_list|,
name|String
name|domainId
parameter_list|,
name|byte
index|[]
name|prefix
parameter_list|)
throws|throws
name|IOException
block|{
comment|// Iterate over all the rows whose key starts with prefix to retrieve the
comment|// domain information.
name|TimelineDomain
name|domain
init|=
operator|new
name|TimelineDomain
argument_list|()
decl_stmt|;
name|domain
operator|.
name|setId
argument_list|(
name|domainId
argument_list|)
expr_stmt|;
name|boolean
name|noRows
init|=
literal|true
decl_stmt|;
for|for
control|(
init|;
name|iterator
operator|.
name|hasNext
argument_list|()
condition|;
name|iterator
operator|.
name|next
argument_list|()
control|)
block|{
name|byte
index|[]
name|key
init|=
name|iterator
operator|.
name|peekNext
argument_list|()
operator|.
name|getKey
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|prefixMatches
argument_list|(
name|prefix
argument_list|,
name|prefix
operator|.
name|length
argument_list|,
name|key
argument_list|)
condition|)
block|{
break|break;
block|}
if|if
condition|(
name|noRows
condition|)
block|{
name|noRows
operator|=
literal|false
expr_stmt|;
block|}
name|byte
index|[]
name|value
init|=
name|iterator
operator|.
name|peekNext
argument_list|()
operator|.
name|getValue
argument_list|()
decl_stmt|;
if|if
condition|(
name|value
operator|!=
literal|null
operator|&&
name|value
operator|.
name|length
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|key
index|[
name|prefix
operator|.
name|length
index|]
operator|==
name|DESCRIPTION_COLUMN
index|[
literal|0
index|]
condition|)
block|{
name|domain
operator|.
name|setDescription
argument_list|(
operator|new
name|String
argument_list|(
name|value
argument_list|,
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|key
index|[
name|prefix
operator|.
name|length
index|]
operator|==
name|OWNER_COLUMN
index|[
literal|0
index|]
condition|)
block|{
name|domain
operator|.
name|setOwner
argument_list|(
operator|new
name|String
argument_list|(
name|value
argument_list|,
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|key
index|[
name|prefix
operator|.
name|length
index|]
operator|==
name|READER_COLUMN
index|[
literal|0
index|]
condition|)
block|{
name|domain
operator|.
name|setReaders
argument_list|(
operator|new
name|String
argument_list|(
name|value
argument_list|,
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|key
index|[
name|prefix
operator|.
name|length
index|]
operator|==
name|WRITER_COLUMN
index|[
literal|0
index|]
condition|)
block|{
name|domain
operator|.
name|setWriters
argument_list|(
operator|new
name|String
argument_list|(
name|value
argument_list|,
name|Charset
operator|.
name|forName
argument_list|(
literal|"UTF-8"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|key
index|[
name|prefix
operator|.
name|length
index|]
operator|==
name|TIMESTAMP_COLUMN
index|[
literal|0
index|]
condition|)
block|{
name|domain
operator|.
name|setCreatedTime
argument_list|(
name|readReverseOrderedLong
argument_list|(
name|value
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|domain
operator|.
name|setModifiedTime
argument_list|(
name|readReverseOrderedLong
argument_list|(
name|value
argument_list|,
literal|8
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Unrecognized domain column: "
operator|+
name|key
index|[
name|prefix
operator|.
name|length
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|noRows
condition|)
block|{
return|return
literal|null
return|;
block|}
else|else
block|{
return|return
name|domain
return|;
block|}
block|}
block|}
end_class

end_unit

