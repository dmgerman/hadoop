begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/** * Licensed to the Apache Software Foundation (ASF) under one * or more contributor license agreements.  See the NOTICE file * distributed with this work for additional information * regarding copyright ownership.  The ASF licenses this file * to you under the Apache License, Version 2.0 (the * "License"); you may not use this file except in compliance * with the License.  You may obtain a copy of the License at * *     http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */
end_comment

begin_package
DECL|package|org.apache.hadoop.yarn.server.nodemanager
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
package|;
end_package

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|annotations
operator|.
name|VisibleForTesting
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|base
operator|.
name|Optional
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|Log
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|LogFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|conf
operator|.
name|Configuration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|Path
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|UserGroupInformation
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|util
operator|.
name|ReflectionUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|util
operator|.
name|StringUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|ApplicationConstants
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|ContainerId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|conf
operator|.
name|YarnConfiguration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|containermanager
operator|.
name|container
operator|.
name|Container
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|containermanager
operator|.
name|container
operator|.
name|ContainerDiagnosticsUpdateEvent
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|containermanager
operator|.
name|linux
operator|.
name|privileged
operator|.
name|PrivilegedOperation
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|containermanager
operator|.
name|linux
operator|.
name|privileged
operator|.
name|PrivilegedOperationException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|containermanager
operator|.
name|linux
operator|.
name|privileged
operator|.
name|PrivilegedOperationExecutor
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|containermanager
operator|.
name|linux
operator|.
name|resources
operator|.
name|ResourceHandler
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|containermanager
operator|.
name|linux
operator|.
name|resources
operator|.
name|ResourceHandlerException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|containermanager
operator|.
name|linux
operator|.
name|resources
operator|.
name|ResourceHandlerModule
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|containermanager
operator|.
name|linux
operator|.
name|runtime
operator|.
name|DefaultLinuxContainerRuntime
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|containermanager
operator|.
name|linux
operator|.
name|runtime
operator|.
name|DelegatingLinuxContainerRuntime
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|containermanager
operator|.
name|linux
operator|.
name|runtime
operator|.
name|DockerLinuxContainerRuntime
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|containermanager
operator|.
name|linux
operator|.
name|runtime
operator|.
name|LinuxContainerRuntime
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|containermanager
operator|.
name|localizer
operator|.
name|ContainerLocalizer
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|containermanager
operator|.
name|runtime
operator|.
name|ContainerExecutionException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|containermanager
operator|.
name|runtime
operator|.
name|ContainerRuntimeContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|executor
operator|.
name|ContainerLivenessContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|executor
operator|.
name|ContainerReacquisitionContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|executor
operator|.
name|ContainerSignalContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|executor
operator|.
name|ContainerStartContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|executor
operator|.
name|DeletionAsUserContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|executor
operator|.
name|LocalizerStartContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|util
operator|.
name|CgroupsLCEResourcesHandler
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|util
operator|.
name|DefaultLCEResourcesHandler
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|util
operator|.
name|LCEResourcesHandler
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|File
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|InetSocketAddress
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Arrays
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|regex
operator|.
name|Pattern
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|containermanager
operator|.
name|linux
operator|.
name|runtime
operator|.
name|LinuxContainerRuntimeConstants
operator|.
name|*
import|;
end_import

begin_comment
comment|/**  *<p>This class provides {@link Container} execution using a native  * {@code container-executor} binary. By using a helper written it native code,  * this class is able to do several things that the  * {@link DefaultContainerExecutor} cannot, such as execution of applications  * as the applications' owners, provide localization that takes advantage of  * mapping the application owner to a UID on the execution host, resource  * management through Linux CGROUPS, and Docker support.</p>  *  *<p>If {@code hadoop.security.authetication} is set to {@code simple},  * then the  * {@code yarn.nodemanager.linux-container-executor.nonsecure-mode.limit-users}  * property will determine whether the {@code LinuxContainerExecutor} runs  * processes as the application owner or as the default user, as set in the  * {@code yarn.nodemanager.linux-container-executor.nonsecure-mode.local-user}  * property.</p>  *  *<p>The {@code LinuxContainerExecutor} will manage applications through an  * appropriate {@link LinuxContainerRuntime} instance. This class uses a  * {@link DelegatingLinuxContainerRuntime} instance, which will delegate calls  * to either a {@link DefaultLinuxContainerRuntime} instance or a  * {@link DockerLinuxContainerRuntime} instance, depending on the job's  * configuration.</p>  *  * @see LinuxContainerRuntime  * @see DelegatingLinuxContainerRuntime  * @see DefaultLinuxContainerRuntime  * @see DockerLinuxContainerRuntime  * @see DockerLinuxContainerRuntime#isDockerContainerRequested  */
end_comment

begin_class
DECL|class|LinuxContainerExecutor
specifier|public
class|class
name|LinuxContainerExecutor
extends|extends
name|ContainerExecutor
block|{
DECL|field|LOG
specifier|private
specifier|static
specifier|final
name|Log
name|LOG
init|=
name|LogFactory
operator|.
name|getLog
argument_list|(
name|LinuxContainerExecutor
operator|.
name|class
argument_list|)
decl_stmt|;
DECL|field|nonsecureLocalUser
specifier|private
name|String
name|nonsecureLocalUser
decl_stmt|;
DECL|field|nonsecureLocalUserPattern
specifier|private
name|Pattern
name|nonsecureLocalUserPattern
decl_stmt|;
DECL|field|resourcesHandler
specifier|private
name|LCEResourcesHandler
name|resourcesHandler
decl_stmt|;
DECL|field|containerSchedPriorityIsSet
specifier|private
name|boolean
name|containerSchedPriorityIsSet
init|=
literal|false
decl_stmt|;
DECL|field|containerSchedPriorityAdjustment
specifier|private
name|int
name|containerSchedPriorityAdjustment
init|=
literal|0
decl_stmt|;
DECL|field|containerLimitUsers
specifier|private
name|boolean
name|containerLimitUsers
decl_stmt|;
DECL|field|resourceHandlerChain
specifier|private
name|ResourceHandler
name|resourceHandlerChain
decl_stmt|;
DECL|field|linuxContainerRuntime
specifier|private
name|LinuxContainerRuntime
name|linuxContainerRuntime
decl_stmt|;
comment|/**    * Default constructor to allow for creation through reflection.    */
DECL|method|LinuxContainerExecutor ()
specifier|public
name|LinuxContainerExecutor
parameter_list|()
block|{   }
comment|/**    * Create a LinuxContainerExecutor with a provided    * {@link LinuxContainerRuntime}.  Used primarily for testing.    *    * @param linuxContainerRuntime the runtime to use    */
DECL|method|LinuxContainerExecutor (LinuxContainerRuntime linuxContainerRuntime)
specifier|public
name|LinuxContainerExecutor
parameter_list|(
name|LinuxContainerRuntime
name|linuxContainerRuntime
parameter_list|)
block|{
name|this
operator|.
name|linuxContainerRuntime
operator|=
name|linuxContainerRuntime
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|setConf (Configuration conf)
specifier|public
name|void
name|setConf
parameter_list|(
name|Configuration
name|conf
parameter_list|)
block|{
name|super
operator|.
name|setConf
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|resourcesHandler
operator|=
name|getResourcesHandler
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|containerSchedPriorityIsSet
operator|=
literal|false
expr_stmt|;
if|if
condition|(
name|conf
operator|.
name|get
argument_list|(
name|YarnConfiguration
operator|.
name|NM_CONTAINER_EXECUTOR_SCHED_PRIORITY
argument_list|)
operator|!=
literal|null
condition|)
block|{
name|containerSchedPriorityIsSet
operator|=
literal|true
expr_stmt|;
name|containerSchedPriorityAdjustment
operator|=
name|conf
operator|.
name|getInt
argument_list|(
name|YarnConfiguration
operator|.
name|NM_CONTAINER_EXECUTOR_SCHED_PRIORITY
argument_list|,
name|YarnConfiguration
operator|.
name|DEFAULT_NM_CONTAINER_EXECUTOR_SCHED_PRIORITY
argument_list|)
expr_stmt|;
block|}
name|nonsecureLocalUser
operator|=
name|conf
operator|.
name|get
argument_list|(
name|YarnConfiguration
operator|.
name|NM_NONSECURE_MODE_LOCAL_USER_KEY
argument_list|,
name|YarnConfiguration
operator|.
name|DEFAULT_NM_NONSECURE_MODE_LOCAL_USER
argument_list|)
expr_stmt|;
name|nonsecureLocalUserPattern
operator|=
name|Pattern
operator|.
name|compile
argument_list|(
name|conf
operator|.
name|get
argument_list|(
name|YarnConfiguration
operator|.
name|NM_NONSECURE_MODE_USER_PATTERN_KEY
argument_list|,
name|YarnConfiguration
operator|.
name|DEFAULT_NM_NONSECURE_MODE_USER_PATTERN
argument_list|)
argument_list|)
expr_stmt|;
name|containerLimitUsers
operator|=
name|conf
operator|.
name|getBoolean
argument_list|(
name|YarnConfiguration
operator|.
name|NM_NONSECURE_MODE_LIMIT_USERS
argument_list|,
name|YarnConfiguration
operator|.
name|DEFAULT_NM_NONSECURE_MODE_LIMIT_USERS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|containerLimitUsers
condition|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
name|YarnConfiguration
operator|.
name|NM_NONSECURE_MODE_LIMIT_USERS
operator|+
literal|": impersonation without authentication enabled"
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|getResourcesHandler (Configuration conf)
specifier|private
name|LCEResourcesHandler
name|getResourcesHandler
parameter_list|(
name|Configuration
name|conf
parameter_list|)
block|{
name|LCEResourcesHandler
name|handler
init|=
name|ReflectionUtils
operator|.
name|newInstance
argument_list|(
name|conf
operator|.
name|getClass
argument_list|(
name|YarnConfiguration
operator|.
name|NM_LINUX_CONTAINER_RESOURCES_HANDLER
argument_list|,
name|DefaultLCEResourcesHandler
operator|.
name|class
argument_list|,
name|LCEResourcesHandler
operator|.
name|class
argument_list|)
argument_list|,
name|conf
argument_list|)
decl_stmt|;
comment|// Stop using CgroupsLCEResourcesHandler
comment|// use the resource handler chain instead
comment|// ResourceHandlerModule will create the cgroup cpu module if
comment|// CgroupsLCEResourcesHandler is set
if|if
condition|(
name|handler
operator|instanceof
name|CgroupsLCEResourcesHandler
condition|)
block|{
name|handler
operator|=
name|ReflectionUtils
operator|.
name|newInstance
argument_list|(
name|DefaultLCEResourcesHandler
operator|.
name|class
argument_list|,
name|conf
argument_list|)
expr_stmt|;
block|}
name|handler
operator|.
name|setConf
argument_list|(
name|conf
argument_list|)
expr_stmt|;
return|return
name|handler
return|;
block|}
DECL|method|verifyUsernamePattern (String user)
name|void
name|verifyUsernamePattern
parameter_list|(
name|String
name|user
parameter_list|)
block|{
if|if
condition|(
operator|!
name|UserGroupInformation
operator|.
name|isSecurityEnabled
argument_list|()
operator|&&
operator|!
name|nonsecureLocalUserPattern
operator|.
name|matcher
argument_list|(
name|user
argument_list|)
operator|.
name|matches
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"Invalid user name '"
operator|+
name|user
operator|+
literal|"',"
operator|+
literal|" it must match '"
operator|+
name|nonsecureLocalUserPattern
operator|.
name|pattern
argument_list|()
operator|+
literal|"'"
argument_list|)
throw|;
block|}
block|}
DECL|method|getRunAsUser (String user)
name|String
name|getRunAsUser
parameter_list|(
name|String
name|user
parameter_list|)
block|{
if|if
condition|(
name|UserGroupInformation
operator|.
name|isSecurityEnabled
argument_list|()
operator|||
operator|!
name|containerLimitUsers
condition|)
block|{
return|return
name|user
return|;
block|}
else|else
block|{
return|return
name|nonsecureLocalUser
return|;
block|}
block|}
comment|/**    * Get the path to the {@code container-executor} binary. The path will    * be absolute.    *    * @param conf the {@link Configuration}    * @return the path to the {@code container-executor} binary    */
DECL|method|getContainerExecutorExecutablePath (Configuration conf)
specifier|protected
name|String
name|getContainerExecutorExecutablePath
parameter_list|(
name|Configuration
name|conf
parameter_list|)
block|{
name|String
name|yarnHomeEnvVar
init|=
name|System
operator|.
name|getenv
argument_list|(
name|ApplicationConstants
operator|.
name|Environment
operator|.
name|HADOOP_YARN_HOME
operator|.
name|key
argument_list|()
argument_list|)
decl_stmt|;
name|File
name|hadoopBin
init|=
operator|new
name|File
argument_list|(
name|yarnHomeEnvVar
argument_list|,
literal|"bin"
argument_list|)
decl_stmt|;
name|String
name|defaultPath
init|=
operator|new
name|File
argument_list|(
name|hadoopBin
argument_list|,
literal|"container-executor"
argument_list|)
operator|.
name|getAbsolutePath
argument_list|()
decl_stmt|;
return|return
literal|null
operator|==
name|conf
condition|?
name|defaultPath
else|:
name|conf
operator|.
name|get
argument_list|(
name|YarnConfiguration
operator|.
name|NM_LINUX_CONTAINER_EXECUTOR_PATH
argument_list|,
name|defaultPath
argument_list|)
return|;
block|}
comment|/**    * Add a niceness level to the process that will be executed.  Adds    * {@code -n<nice>} to the given command. The niceness level will be    * taken from the    * {@code yarn.nodemanager.container-executer.os.sched.prioity} property.    *    * @param command the command to which to add the niceness setting.    */
DECL|method|addSchedPriorityCommand (List<String> command)
specifier|protected
name|void
name|addSchedPriorityCommand
parameter_list|(
name|List
argument_list|<
name|String
argument_list|>
name|command
parameter_list|)
block|{
if|if
condition|(
name|containerSchedPriorityIsSet
condition|)
block|{
name|command
operator|.
name|addAll
argument_list|(
name|Arrays
operator|.
name|asList
argument_list|(
literal|"nice"
argument_list|,
literal|"-n"
argument_list|,
name|Integer
operator|.
name|toString
argument_list|(
name|containerSchedPriorityAdjustment
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|init ()
specifier|public
name|void
name|init
parameter_list|()
throws|throws
name|IOException
block|{
name|Configuration
name|conf
init|=
name|super
operator|.
name|getConf
argument_list|()
decl_stmt|;
comment|// Send command to executor which will just start up,
comment|// verify configuration/permissions and exit
try|try
block|{
name|PrivilegedOperation
name|checkSetupOp
init|=
operator|new
name|PrivilegedOperation
argument_list|(
name|PrivilegedOperation
operator|.
name|OperationType
operator|.
name|CHECK_SETUP
argument_list|)
decl_stmt|;
name|PrivilegedOperationExecutor
name|privilegedOperationExecutor
init|=
name|PrivilegedOperationExecutor
operator|.
name|getInstance
argument_list|(
name|conf
argument_list|)
decl_stmt|;
name|privilegedOperationExecutor
operator|.
name|executePrivilegedOperation
argument_list|(
name|checkSetupOp
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|PrivilegedOperationException
name|e
parameter_list|)
block|{
name|int
name|exitCode
init|=
name|e
operator|.
name|getExitCode
argument_list|()
decl_stmt|;
name|LOG
operator|.
name|warn
argument_list|(
literal|"Exit code from container executor initialization is : "
operator|+
name|exitCode
argument_list|,
name|e
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Linux container executor not configured properly"
operator|+
literal|" (error="
operator|+
name|exitCode
operator|+
literal|")"
argument_list|,
name|e
argument_list|)
throw|;
block|}
try|try
block|{
name|resourceHandlerChain
operator|=
name|ResourceHandlerModule
operator|.
name|getConfiguredResourceHandlerChain
argument_list|(
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Resource handler chain enabled = "
operator|+
operator|(
name|resourceHandlerChain
operator|==
literal|null
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|resourceHandlerChain
operator|!=
literal|null
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Bootstrapping resource handler chain"
argument_list|)
expr_stmt|;
name|resourceHandlerChain
operator|.
name|bootstrap
argument_list|(
name|conf
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|ResourceHandlerException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Failed to bootstrap configured resource subsystems! "
argument_list|,
name|e
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Failed to bootstrap configured resource subsystems!"
argument_list|)
throw|;
block|}
try|try
block|{
if|if
condition|(
name|linuxContainerRuntime
operator|==
literal|null
condition|)
block|{
name|LinuxContainerRuntime
name|runtime
init|=
operator|new
name|DelegatingLinuxContainerRuntime
argument_list|()
decl_stmt|;
name|runtime
operator|.
name|initialize
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|this
operator|.
name|linuxContainerRuntime
operator|=
name|runtime
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|ContainerExecutionException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Failed to initialize linux container runtime(s)!"
argument_list|,
name|e
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Failed to initialize linux container runtime(s)!"
argument_list|)
throw|;
block|}
name|resourcesHandler
operator|.
name|init
argument_list|(
name|this
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|startLocalizer (LocalizerStartContext ctx)
specifier|public
name|void
name|startLocalizer
parameter_list|(
name|LocalizerStartContext
name|ctx
parameter_list|)
throws|throws
name|IOException
throws|,
name|InterruptedException
block|{
name|Path
name|nmPrivateContainerTokensPath
init|=
name|ctx
operator|.
name|getNmPrivateContainerTokens
argument_list|()
decl_stmt|;
name|InetSocketAddress
name|nmAddr
init|=
name|ctx
operator|.
name|getNmAddr
argument_list|()
decl_stmt|;
name|String
name|user
init|=
name|ctx
operator|.
name|getUser
argument_list|()
decl_stmt|;
name|String
name|appId
init|=
name|ctx
operator|.
name|getAppId
argument_list|()
decl_stmt|;
name|String
name|locId
init|=
name|ctx
operator|.
name|getLocId
argument_list|()
decl_stmt|;
name|LocalDirsHandlerService
name|dirsHandler
init|=
name|ctx
operator|.
name|getDirsHandler
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|localDirs
init|=
name|dirsHandler
operator|.
name|getLocalDirs
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|logDirs
init|=
name|dirsHandler
operator|.
name|getLogDirs
argument_list|()
decl_stmt|;
name|verifyUsernamePattern
argument_list|(
name|user
argument_list|)
expr_stmt|;
name|String
name|runAsUser
init|=
name|getRunAsUser
argument_list|(
name|user
argument_list|)
decl_stmt|;
name|PrivilegedOperation
name|initializeContainerOp
init|=
operator|new
name|PrivilegedOperation
argument_list|(
name|PrivilegedOperation
operator|.
name|OperationType
operator|.
name|INITIALIZE_CONTAINER
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|prefixCommands
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|addSchedPriorityCommand
argument_list|(
name|prefixCommands
argument_list|)
expr_stmt|;
name|initializeContainerOp
operator|.
name|appendArgs
argument_list|(
name|runAsUser
argument_list|,
name|user
argument_list|,
name|Integer
operator|.
name|toString
argument_list|(
name|PrivilegedOperation
operator|.
name|RunAsUserCommand
operator|.
name|INITIALIZE_CONTAINER
operator|.
name|getValue
argument_list|()
argument_list|)
argument_list|,
name|appId
argument_list|,
name|nmPrivateContainerTokensPath
operator|.
name|toUri
argument_list|()
operator|.
name|getPath
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|,
name|StringUtils
operator|.
name|join
argument_list|(
name|PrivilegedOperation
operator|.
name|LINUX_FILE_PATH_SEPARATOR
argument_list|,
name|localDirs
argument_list|)
argument_list|,
name|StringUtils
operator|.
name|join
argument_list|(
name|PrivilegedOperation
operator|.
name|LINUX_FILE_PATH_SEPARATOR
argument_list|,
name|logDirs
argument_list|)
argument_list|)
expr_stmt|;
name|File
name|jvm
init|=
comment|// use same jvm as parent
operator|new
name|File
argument_list|(
operator|new
name|File
argument_list|(
name|System
operator|.
name|getProperty
argument_list|(
literal|"java.home"
argument_list|)
argument_list|,
literal|"bin"
argument_list|)
argument_list|,
literal|"java"
argument_list|)
decl_stmt|;
name|initializeContainerOp
operator|.
name|appendArgs
argument_list|(
name|jvm
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|initializeContainerOp
operator|.
name|appendArgs
argument_list|(
literal|"-classpath"
argument_list|)
expr_stmt|;
name|initializeContainerOp
operator|.
name|appendArgs
argument_list|(
name|System
operator|.
name|getProperty
argument_list|(
literal|"java.class.path"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|javaLibPath
init|=
name|System
operator|.
name|getProperty
argument_list|(
literal|"java.library.path"
argument_list|)
decl_stmt|;
if|if
condition|(
name|javaLibPath
operator|!=
literal|null
condition|)
block|{
name|initializeContainerOp
operator|.
name|appendArgs
argument_list|(
literal|"-Djava.library.path="
operator|+
name|javaLibPath
argument_list|)
expr_stmt|;
block|}
name|initializeContainerOp
operator|.
name|appendArgs
argument_list|(
name|ContainerLocalizer
operator|.
name|getJavaOpts
argument_list|(
name|getConf
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|localizerArgs
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|buildMainArgs
argument_list|(
name|localizerArgs
argument_list|,
name|user
argument_list|,
name|appId
argument_list|,
name|locId
argument_list|,
name|nmAddr
argument_list|,
name|localDirs
argument_list|)
expr_stmt|;
name|initializeContainerOp
operator|.
name|appendArgs
argument_list|(
name|localizerArgs
argument_list|)
expr_stmt|;
try|try
block|{
name|Configuration
name|conf
init|=
name|super
operator|.
name|getConf
argument_list|()
decl_stmt|;
name|PrivilegedOperationExecutor
name|privilegedOperationExecutor
init|=
name|PrivilegedOperationExecutor
operator|.
name|getInstance
argument_list|(
name|conf
argument_list|)
decl_stmt|;
name|privilegedOperationExecutor
operator|.
name|executePrivilegedOperation
argument_list|(
name|prefixCommands
argument_list|,
name|initializeContainerOp
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|false
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|PrivilegedOperationException
name|e
parameter_list|)
block|{
name|int
name|exitCode
init|=
name|e
operator|.
name|getExitCode
argument_list|()
decl_stmt|;
name|LOG
operator|.
name|warn
argument_list|(
literal|"Exit code from container "
operator|+
name|locId
operator|+
literal|" startLocalizer is : "
operator|+
name|exitCode
argument_list|,
name|e
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Application "
operator|+
name|appId
operator|+
literal|" initialization failed"
operator|+
literal|" (exitCode="
operator|+
name|exitCode
operator|+
literal|") with output: "
operator|+
name|e
operator|.
name|getOutput
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
comment|/**    * Set up the {@link ContainerLocalizer}.    *    * @param command the current ShellCommandExecutor command line    * @param user localization user    * @param appId localized app id    * @param locId localizer id    * @param nmAddr nodemanager address    * @param localDirs list of local dirs    * @see ContainerLocalizer#buildMainArgs    */
annotation|@
name|VisibleForTesting
DECL|method|buildMainArgs (List<String> command, String user, String appId, String locId, InetSocketAddress nmAddr, List<String> localDirs)
specifier|public
name|void
name|buildMainArgs
parameter_list|(
name|List
argument_list|<
name|String
argument_list|>
name|command
parameter_list|,
name|String
name|user
parameter_list|,
name|String
name|appId
parameter_list|,
name|String
name|locId
parameter_list|,
name|InetSocketAddress
name|nmAddr
parameter_list|,
name|List
argument_list|<
name|String
argument_list|>
name|localDirs
parameter_list|)
block|{
name|ContainerLocalizer
operator|.
name|buildMainArgs
argument_list|(
name|command
argument_list|,
name|user
argument_list|,
name|appId
argument_list|,
name|locId
argument_list|,
name|nmAddr
argument_list|,
name|localDirs
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|launchContainer (ContainerStartContext ctx)
specifier|public
name|int
name|launchContainer
parameter_list|(
name|ContainerStartContext
name|ctx
parameter_list|)
throws|throws
name|IOException
block|{
name|Container
name|container
init|=
name|ctx
operator|.
name|getContainer
argument_list|()
decl_stmt|;
name|Path
name|nmPrivateContainerScriptPath
init|=
name|ctx
operator|.
name|getNmPrivateContainerScriptPath
argument_list|()
decl_stmt|;
name|Path
name|nmPrivateTokensPath
init|=
name|ctx
operator|.
name|getNmPrivateTokensPath
argument_list|()
decl_stmt|;
name|String
name|user
init|=
name|ctx
operator|.
name|getUser
argument_list|()
decl_stmt|;
name|String
name|appId
init|=
name|ctx
operator|.
name|getAppId
argument_list|()
decl_stmt|;
name|Path
name|containerWorkDir
init|=
name|ctx
operator|.
name|getContainerWorkDir
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|localDirs
init|=
name|ctx
operator|.
name|getLocalDirs
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|logDirs
init|=
name|ctx
operator|.
name|getLogDirs
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|filecacheDirs
init|=
name|ctx
operator|.
name|getFilecacheDirs
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|userLocalDirs
init|=
name|ctx
operator|.
name|getUserLocalDirs
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|containerLocalDirs
init|=
name|ctx
operator|.
name|getContainerLocalDirs
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|containerLogDirs
init|=
name|ctx
operator|.
name|getContainerLogDirs
argument_list|()
decl_stmt|;
name|Map
argument_list|<
name|Path
argument_list|,
name|List
argument_list|<
name|String
argument_list|>
argument_list|>
name|localizedResources
init|=
name|ctx
operator|.
name|getLocalizedResources
argument_list|()
decl_stmt|;
name|verifyUsernamePattern
argument_list|(
name|user
argument_list|)
expr_stmt|;
name|String
name|runAsUser
init|=
name|getRunAsUser
argument_list|(
name|user
argument_list|)
decl_stmt|;
name|ContainerId
name|containerId
init|=
name|container
operator|.
name|getContainerId
argument_list|()
decl_stmt|;
name|String
name|containerIdStr
init|=
name|containerId
operator|.
name|toString
argument_list|()
decl_stmt|;
name|resourcesHandler
operator|.
name|preExecute
argument_list|(
name|containerId
argument_list|,
name|container
operator|.
name|getResource
argument_list|()
argument_list|)
expr_stmt|;
name|String
name|resourcesOptions
init|=
name|resourcesHandler
operator|.
name|getResourcesOption
argument_list|(
name|containerId
argument_list|)
decl_stmt|;
name|String
name|tcCommandFile
init|=
literal|null
decl_stmt|;
try|try
block|{
if|if
condition|(
name|resourceHandlerChain
operator|!=
literal|null
condition|)
block|{
name|List
argument_list|<
name|PrivilegedOperation
argument_list|>
name|ops
init|=
name|resourceHandlerChain
operator|.
name|preStart
argument_list|(
name|container
argument_list|)
decl_stmt|;
if|if
condition|(
name|ops
operator|!=
literal|null
condition|)
block|{
name|List
argument_list|<
name|PrivilegedOperation
argument_list|>
name|resourceOps
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|resourceOps
operator|.
name|add
argument_list|(
operator|new
name|PrivilegedOperation
argument_list|(
name|PrivilegedOperation
operator|.
name|OperationType
operator|.
name|ADD_PID_TO_CGROUP
argument_list|,
name|resourcesOptions
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|PrivilegedOperation
name|op
range|:
name|ops
control|)
block|{
switch|switch
condition|(
name|op
operator|.
name|getOperationType
argument_list|()
condition|)
block|{
case|case
name|ADD_PID_TO_CGROUP
case|:
name|resourceOps
operator|.
name|add
argument_list|(
name|op
argument_list|)
expr_stmt|;
break|break;
case|case
name|TC_MODIFY_STATE
case|:
name|tcCommandFile
operator|=
name|op
operator|.
name|getArguments
argument_list|()
operator|.
name|get
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
name|LOG
operator|.
name|warn
argument_list|(
literal|"PrivilegedOperation type unsupported in launch: "
operator|+
name|op
operator|.
name|getOperationType
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|resourceOps
operator|.
name|size
argument_list|()
operator|>
literal|1
condition|)
block|{
comment|//squash resource operations
try|try
block|{
name|PrivilegedOperation
name|operation
init|=
name|PrivilegedOperationExecutor
operator|.
name|squashCGroupOperations
argument_list|(
name|resourceOps
argument_list|)
decl_stmt|;
name|resourcesOptions
operator|=
name|operation
operator|.
name|getArguments
argument_list|()
operator|.
name|get
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|PrivilegedOperationException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Failed to squash cgroup operations!"
argument_list|,
name|e
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|ResourceHandlerException
argument_list|(
literal|"Failed to squash cgroup operations!"
argument_list|)
throw|;
block|}
block|}
block|}
block|}
block|}
catch|catch
parameter_list|(
name|ResourceHandlerException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"ResourceHandlerChain.preStart() failed!"
argument_list|,
name|e
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|IOException
argument_list|(
literal|"ResourceHandlerChain.preStart() failed!"
argument_list|,
name|e
argument_list|)
throw|;
block|}
try|try
block|{
name|Path
name|pidFilePath
init|=
name|getPidFilePath
argument_list|(
name|containerId
argument_list|)
decl_stmt|;
if|if
condition|(
name|pidFilePath
operator|!=
literal|null
condition|)
block|{
name|List
argument_list|<
name|String
argument_list|>
name|prefixCommands
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|ContainerRuntimeContext
operator|.
name|Builder
name|builder
init|=
operator|new
name|ContainerRuntimeContext
operator|.
name|Builder
argument_list|(
name|container
argument_list|)
decl_stmt|;
name|addSchedPriorityCommand
argument_list|(
name|prefixCommands
argument_list|)
expr_stmt|;
if|if
condition|(
name|prefixCommands
operator|.
name|size
argument_list|()
operator|>
literal|0
condition|)
block|{
name|builder
operator|.
name|setExecutionAttribute
argument_list|(
name|CONTAINER_LAUNCH_PREFIX_COMMANDS
argument_list|,
name|prefixCommands
argument_list|)
expr_stmt|;
block|}
name|builder
operator|.
name|setExecutionAttribute
argument_list|(
name|LOCALIZED_RESOURCES
argument_list|,
name|localizedResources
argument_list|)
operator|.
name|setExecutionAttribute
argument_list|(
name|RUN_AS_USER
argument_list|,
name|runAsUser
argument_list|)
operator|.
name|setExecutionAttribute
argument_list|(
name|USER
argument_list|,
name|user
argument_list|)
operator|.
name|setExecutionAttribute
argument_list|(
name|APPID
argument_list|,
name|appId
argument_list|)
operator|.
name|setExecutionAttribute
argument_list|(
name|CONTAINER_ID_STR
argument_list|,
name|containerIdStr
argument_list|)
operator|.
name|setExecutionAttribute
argument_list|(
name|CONTAINER_WORK_DIR
argument_list|,
name|containerWorkDir
argument_list|)
operator|.
name|setExecutionAttribute
argument_list|(
name|NM_PRIVATE_CONTAINER_SCRIPT_PATH
argument_list|,
name|nmPrivateContainerScriptPath
argument_list|)
operator|.
name|setExecutionAttribute
argument_list|(
name|NM_PRIVATE_TOKENS_PATH
argument_list|,
name|nmPrivateTokensPath
argument_list|)
operator|.
name|setExecutionAttribute
argument_list|(
name|PID_FILE_PATH
argument_list|,
name|pidFilePath
argument_list|)
operator|.
name|setExecutionAttribute
argument_list|(
name|LOCAL_DIRS
argument_list|,
name|localDirs
argument_list|)
operator|.
name|setExecutionAttribute
argument_list|(
name|LOG_DIRS
argument_list|,
name|logDirs
argument_list|)
operator|.
name|setExecutionAttribute
argument_list|(
name|FILECACHE_DIRS
argument_list|,
name|filecacheDirs
argument_list|)
operator|.
name|setExecutionAttribute
argument_list|(
name|USER_LOCAL_DIRS
argument_list|,
name|userLocalDirs
argument_list|)
operator|.
name|setExecutionAttribute
argument_list|(
name|CONTAINER_LOCAL_DIRS
argument_list|,
name|containerLocalDirs
argument_list|)
operator|.
name|setExecutionAttribute
argument_list|(
name|CONTAINER_LOG_DIRS
argument_list|,
name|containerLogDirs
argument_list|)
operator|.
name|setExecutionAttribute
argument_list|(
name|RESOURCES_OPTIONS
argument_list|,
name|resourcesOptions
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcCommandFile
operator|!=
literal|null
condition|)
block|{
name|builder
operator|.
name|setExecutionAttribute
argument_list|(
name|TC_COMMAND_FILE
argument_list|,
name|tcCommandFile
argument_list|)
expr_stmt|;
block|}
name|linuxContainerRuntime
operator|.
name|launchContainer
argument_list|(
name|builder
operator|.
name|build
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Container was marked as inactive. Returning terminated error"
argument_list|)
expr_stmt|;
return|return
name|ExitCode
operator|.
name|TERMINATED
operator|.
name|getExitCode
argument_list|()
return|;
block|}
block|}
catch|catch
parameter_list|(
name|ContainerExecutionException
name|e
parameter_list|)
block|{
name|int
name|exitCode
init|=
name|e
operator|.
name|getExitCode
argument_list|()
decl_stmt|;
name|LOG
operator|.
name|warn
argument_list|(
literal|"Exit code from container "
operator|+
name|containerId
operator|+
literal|" is : "
operator|+
name|exitCode
argument_list|)
expr_stmt|;
comment|// 143 (SIGTERM) and 137 (SIGKILL) exit codes means the container was
comment|// terminated/killed forcefully. In all other cases, log the
comment|// output
if|if
condition|(
name|exitCode
operator|!=
name|ExitCode
operator|.
name|FORCE_KILLED
operator|.
name|getExitCode
argument_list|()
operator|&&
name|exitCode
operator|!=
name|ExitCode
operator|.
name|TERMINATED
operator|.
name|getExitCode
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Exception from container-launch with container ID: "
operator|+
name|containerId
operator|+
literal|" and exit code: "
operator|+
name|exitCode
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"Exception from container-launch.\n"
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"Container id: "
operator|+
name|containerId
operator|+
literal|"\n"
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"Exit code: "
operator|+
name|exitCode
operator|+
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|Optional
operator|.
name|fromNullable
argument_list|(
name|e
operator|.
name|getErrorOutput
argument_list|()
argument_list|)
operator|.
name|or
argument_list|(
literal|""
argument_list|)
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|builder
operator|.
name|append
argument_list|(
literal|"Exception message: "
operator|+
name|e
operator|.
name|getErrorOutput
argument_list|()
operator|+
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|builder
operator|.
name|append
argument_list|(
literal|"Stack trace: "
operator|+
name|StringUtils
operator|.
name|stringifyException
argument_list|(
name|e
argument_list|)
operator|+
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|e
operator|.
name|getOutput
argument_list|()
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|builder
operator|.
name|append
argument_list|(
literal|"Shell output: "
operator|+
name|e
operator|.
name|getOutput
argument_list|()
operator|+
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|String
name|diagnostics
init|=
name|builder
operator|.
name|toString
argument_list|()
decl_stmt|;
name|logOutput
argument_list|(
name|diagnostics
argument_list|)
expr_stmt|;
name|container
operator|.
name|handle
argument_list|(
operator|new
name|ContainerDiagnosticsUpdateEvent
argument_list|(
name|containerId
argument_list|,
name|diagnostics
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|container
operator|.
name|handle
argument_list|(
operator|new
name|ContainerDiagnosticsUpdateEvent
argument_list|(
name|containerId
argument_list|,
literal|"Container killed on request. Exit code is "
operator|+
name|exitCode
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|exitCode
return|;
block|}
finally|finally
block|{
name|resourcesHandler
operator|.
name|postExecute
argument_list|(
name|containerId
argument_list|)
expr_stmt|;
try|try
block|{
if|if
condition|(
name|resourceHandlerChain
operator|!=
literal|null
condition|)
block|{
name|resourceHandlerChain
operator|.
name|postComplete
argument_list|(
name|containerId
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|ResourceHandlerException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"ResourceHandlerChain.postComplete failed for "
operator|+
literal|"containerId: "
operator|+
name|containerId
operator|+
literal|". Exception: "
operator|+
name|e
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
annotation|@
name|Override
DECL|method|getIpAndHost (Container container)
specifier|public
name|String
index|[]
name|getIpAndHost
parameter_list|(
name|Container
name|container
parameter_list|)
block|{
return|return
name|linuxContainerRuntime
operator|.
name|getIpAndHost
argument_list|(
name|container
argument_list|)
return|;
block|}
annotation|@
name|Override
DECL|method|reacquireContainer (ContainerReacquisitionContext ctx)
specifier|public
name|int
name|reacquireContainer
parameter_list|(
name|ContainerReacquisitionContext
name|ctx
parameter_list|)
throws|throws
name|IOException
throws|,
name|InterruptedException
block|{
name|ContainerId
name|containerId
init|=
name|ctx
operator|.
name|getContainerId
argument_list|()
decl_stmt|;
try|try
block|{
comment|//Resource handler chain needs to reacquire container state
comment|//as well
if|if
condition|(
name|resourceHandlerChain
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|resourceHandlerChain
operator|.
name|reacquireContainer
argument_list|(
name|containerId
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|ResourceHandlerException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"ResourceHandlerChain.reacquireContainer failed for "
operator|+
literal|"containerId: "
operator|+
name|containerId
operator|+
literal|" Exception: "
operator|+
name|e
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|super
operator|.
name|reacquireContainer
argument_list|(
name|ctx
argument_list|)
return|;
block|}
finally|finally
block|{
name|resourcesHandler
operator|.
name|postExecute
argument_list|(
name|containerId
argument_list|)
expr_stmt|;
if|if
condition|(
name|resourceHandlerChain
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|resourceHandlerChain
operator|.
name|postComplete
argument_list|(
name|containerId
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|ResourceHandlerException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"ResourceHandlerChain.postComplete failed for "
operator|+
literal|"containerId: "
operator|+
name|containerId
operator|+
literal|" Exception: "
operator|+
name|e
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
annotation|@
name|Override
DECL|method|signalContainer (ContainerSignalContext ctx)
specifier|public
name|boolean
name|signalContainer
parameter_list|(
name|ContainerSignalContext
name|ctx
parameter_list|)
throws|throws
name|IOException
block|{
name|Container
name|container
init|=
name|ctx
operator|.
name|getContainer
argument_list|()
decl_stmt|;
name|String
name|user
init|=
name|ctx
operator|.
name|getUser
argument_list|()
decl_stmt|;
name|String
name|pid
init|=
name|ctx
operator|.
name|getPid
argument_list|()
decl_stmt|;
name|Signal
name|signal
init|=
name|ctx
operator|.
name|getSignal
argument_list|()
decl_stmt|;
name|verifyUsernamePattern
argument_list|(
name|user
argument_list|)
expr_stmt|;
name|String
name|runAsUser
init|=
name|getRunAsUser
argument_list|(
name|user
argument_list|)
decl_stmt|;
name|ContainerRuntimeContext
name|runtimeContext
init|=
operator|new
name|ContainerRuntimeContext
operator|.
name|Builder
argument_list|(
name|container
argument_list|)
operator|.
name|setExecutionAttribute
argument_list|(
name|RUN_AS_USER
argument_list|,
name|runAsUser
argument_list|)
operator|.
name|setExecutionAttribute
argument_list|(
name|USER
argument_list|,
name|user
argument_list|)
operator|.
name|setExecutionAttribute
argument_list|(
name|PID
argument_list|,
name|pid
argument_list|)
operator|.
name|setExecutionAttribute
argument_list|(
name|SIGNAL
argument_list|,
name|signal
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
try|try
block|{
name|linuxContainerRuntime
operator|.
name|signalContainer
argument_list|(
name|runtimeContext
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|ContainerExecutionException
name|e
parameter_list|)
block|{
name|int
name|retCode
init|=
name|e
operator|.
name|getExitCode
argument_list|()
decl_stmt|;
if|if
condition|(
name|retCode
operator|==
name|PrivilegedOperation
operator|.
name|ResultCode
operator|.
name|INVALID_CONTAINER_PID
operator|.
name|getValue
argument_list|()
condition|)
block|{
return|return
literal|false
return|;
block|}
name|LOG
operator|.
name|warn
argument_list|(
literal|"Error in signalling container "
operator|+
name|pid
operator|+
literal|" with "
operator|+
name|signal
operator|+
literal|"; exit = "
operator|+
name|retCode
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|logOutput
argument_list|(
name|e
operator|.
name|getOutput
argument_list|()
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Problem signalling container "
operator|+
name|pid
operator|+
literal|" with "
operator|+
name|signal
operator|+
literal|"; output: "
operator|+
name|e
operator|.
name|getOutput
argument_list|()
operator|+
literal|" and exitCode: "
operator|+
name|retCode
argument_list|,
name|e
argument_list|)
throw|;
block|}
return|return
literal|true
return|;
block|}
annotation|@
name|Override
DECL|method|deleteAsUser (DeletionAsUserContext ctx)
specifier|public
name|void
name|deleteAsUser
parameter_list|(
name|DeletionAsUserContext
name|ctx
parameter_list|)
block|{
name|String
name|user
init|=
name|ctx
operator|.
name|getUser
argument_list|()
decl_stmt|;
name|Path
name|dir
init|=
name|ctx
operator|.
name|getSubDir
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|Path
argument_list|>
name|baseDirs
init|=
name|ctx
operator|.
name|getBasedirs
argument_list|()
decl_stmt|;
name|verifyUsernamePattern
argument_list|(
name|user
argument_list|)
expr_stmt|;
name|String
name|runAsUser
init|=
name|getRunAsUser
argument_list|(
name|user
argument_list|)
decl_stmt|;
name|String
name|dirString
init|=
name|dir
operator|==
literal|null
condition|?
literal|""
else|:
name|dir
operator|.
name|toUri
argument_list|()
operator|.
name|getPath
argument_list|()
decl_stmt|;
name|PrivilegedOperation
name|deleteAsUserOp
init|=
operator|new
name|PrivilegedOperation
argument_list|(
name|PrivilegedOperation
operator|.
name|OperationType
operator|.
name|DELETE_AS_USER
argument_list|,
operator|(
name|String
operator|)
literal|null
argument_list|)
decl_stmt|;
name|deleteAsUserOp
operator|.
name|appendArgs
argument_list|(
name|runAsUser
argument_list|,
name|user
argument_list|,
name|Integer
operator|.
name|toString
argument_list|(
name|PrivilegedOperation
operator|.
name|RunAsUserCommand
operator|.
name|DELETE_AS_USER
operator|.
name|getValue
argument_list|()
argument_list|)
argument_list|,
name|dirString
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|pathsToDelete
init|=
operator|new
name|ArrayList
argument_list|<
name|String
argument_list|>
argument_list|()
decl_stmt|;
if|if
condition|(
name|baseDirs
operator|==
literal|null
operator|||
name|baseDirs
operator|.
name|size
argument_list|()
operator|==
literal|0
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Deleting absolute path : "
operator|+
name|dir
argument_list|)
expr_stmt|;
name|pathsToDelete
operator|.
name|add
argument_list|(
name|dirString
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|Path
name|baseDir
range|:
name|baseDirs
control|)
block|{
name|Path
name|del
init|=
name|dir
operator|==
literal|null
condition|?
name|baseDir
else|:
operator|new
name|Path
argument_list|(
name|baseDir
argument_list|,
name|dir
argument_list|)
decl_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Deleting path : "
operator|+
name|del
argument_list|)
expr_stmt|;
name|pathsToDelete
operator|.
name|add
argument_list|(
name|del
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|deleteAsUserOp
operator|.
name|appendArgs
argument_list|(
name|baseDir
operator|.
name|toUri
argument_list|()
operator|.
name|getPath
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
try|try
block|{
name|Configuration
name|conf
init|=
name|super
operator|.
name|getConf
argument_list|()
decl_stmt|;
name|PrivilegedOperationExecutor
name|privilegedOperationExecutor
init|=
name|PrivilegedOperationExecutor
operator|.
name|getInstance
argument_list|(
name|conf
argument_list|)
decl_stmt|;
name|privilegedOperationExecutor
operator|.
name|executePrivilegedOperation
argument_list|(
name|deleteAsUserOp
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|PrivilegedOperationException
name|e
parameter_list|)
block|{
name|int
name|exitCode
init|=
name|e
operator|.
name|getExitCode
argument_list|()
decl_stmt|;
name|LOG
operator|.
name|error
argument_list|(
literal|"DeleteAsUser for "
operator|+
name|StringUtils
operator|.
name|join
argument_list|(
literal|" "
argument_list|,
name|pathsToDelete
argument_list|)
operator|+
literal|" returned with exit code: "
operator|+
name|exitCode
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|readDirAsUser (String user, Path dir)
specifier|protected
name|File
index|[]
name|readDirAsUser
parameter_list|(
name|String
name|user
parameter_list|,
name|Path
name|dir
parameter_list|)
block|{
name|List
argument_list|<
name|File
argument_list|>
name|files
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|PrivilegedOperation
name|listAsUserOp
init|=
operator|new
name|PrivilegedOperation
argument_list|(
name|PrivilegedOperation
operator|.
name|OperationType
operator|.
name|LIST_AS_USER
argument_list|,
operator|(
name|String
operator|)
literal|null
argument_list|)
decl_stmt|;
name|String
name|runAsUser
init|=
name|getRunAsUser
argument_list|(
name|user
argument_list|)
decl_stmt|;
name|String
name|dirString
init|=
literal|""
decl_stmt|;
if|if
condition|(
name|dir
operator|!=
literal|null
condition|)
block|{
name|dirString
operator|=
name|dir
operator|.
name|toUri
argument_list|()
operator|.
name|getPath
argument_list|()
expr_stmt|;
block|}
name|listAsUserOp
operator|.
name|appendArgs
argument_list|(
name|runAsUser
argument_list|,
name|user
argument_list|,
name|Integer
operator|.
name|toString
argument_list|(
name|PrivilegedOperation
operator|.
name|RunAsUserCommand
operator|.
name|LIST_AS_USER
operator|.
name|getValue
argument_list|()
argument_list|)
argument_list|,
name|dirString
argument_list|)
expr_stmt|;
try|try
block|{
name|PrivilegedOperationExecutor
name|privOpExecutor
init|=
name|PrivilegedOperationExecutor
operator|.
name|getInstance
argument_list|(
name|super
operator|.
name|getConf
argument_list|()
argument_list|)
decl_stmt|;
name|String
name|results
init|=
name|privOpExecutor
operator|.
name|executePrivilegedOperation
argument_list|(
name|listAsUserOp
argument_list|,
literal|true
argument_list|)
decl_stmt|;
for|for
control|(
name|String
name|file
range|:
name|results
operator|.
name|split
argument_list|(
literal|"\n"
argument_list|)
control|)
block|{
comment|// The container-executor always dumps its log output to stdout, which
comment|// includes 3 lines that start with "main : "
if|if
condition|(
operator|!
name|file
operator|.
name|startsWith
argument_list|(
literal|"main :"
argument_list|)
condition|)
block|{
name|files
operator|.
name|add
argument_list|(
operator|new
name|File
argument_list|(
operator|new
name|File
argument_list|(
name|dirString
argument_list|)
argument_list|,
name|file
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
catch|catch
parameter_list|(
name|PrivilegedOperationException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"ListAsUser for "
operator|+
name|dir
operator|+
literal|" returned with exit code: "
operator|+
name|e
operator|.
name|getExitCode
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
return|return
name|files
operator|.
name|toArray
argument_list|(
operator|new
name|File
index|[
name|files
operator|.
name|size
argument_list|()
index|]
argument_list|)
return|;
block|}
annotation|@
name|Override
DECL|method|symLink (String target, String symlink)
specifier|public
name|void
name|symLink
parameter_list|(
name|String
name|target
parameter_list|,
name|String
name|symlink
parameter_list|)
block|{    }
annotation|@
name|Override
DECL|method|isContainerAlive (ContainerLivenessContext ctx)
specifier|public
name|boolean
name|isContainerAlive
parameter_list|(
name|ContainerLivenessContext
name|ctx
parameter_list|)
throws|throws
name|IOException
block|{
name|String
name|user
init|=
name|ctx
operator|.
name|getUser
argument_list|()
decl_stmt|;
name|String
name|pid
init|=
name|ctx
operator|.
name|getPid
argument_list|()
decl_stmt|;
name|Container
name|container
init|=
name|ctx
operator|.
name|getContainer
argument_list|()
decl_stmt|;
comment|// Send a test signal to the process as the user to see if it's alive
return|return
name|signalContainer
argument_list|(
operator|new
name|ContainerSignalContext
operator|.
name|Builder
argument_list|()
operator|.
name|setContainer
argument_list|(
name|container
argument_list|)
operator|.
name|setUser
argument_list|(
name|user
argument_list|)
operator|.
name|setPid
argument_list|(
name|pid
argument_list|)
operator|.
name|setSignal
argument_list|(
name|Signal
operator|.
name|NULL
argument_list|)
operator|.
name|build
argument_list|()
argument_list|)
return|;
block|}
comment|/**    * Mount a CGROUPS controller at the requested mount point and create    * a hierarchy for the NodeManager to manage.    *    * @param cgroupKVs a key-value pair of the form    * {@code controller=mount-path}    * @param hierarchy the top directory of the hierarchy for the NodeManager    * @throws IOException if there is a problem mounting the CGROUPS    */
DECL|method|mountCgroups (List<String> cgroupKVs, String hierarchy)
specifier|public
name|void
name|mountCgroups
parameter_list|(
name|List
argument_list|<
name|String
argument_list|>
name|cgroupKVs
parameter_list|,
name|String
name|hierarchy
parameter_list|)
throws|throws
name|IOException
block|{
try|try
block|{
name|PrivilegedOperation
name|mountCGroupsOp
init|=
operator|new
name|PrivilegedOperation
argument_list|(
name|PrivilegedOperation
operator|.
name|OperationType
operator|.
name|MOUNT_CGROUPS
argument_list|,
name|hierarchy
argument_list|)
decl_stmt|;
name|Configuration
name|conf
init|=
name|super
operator|.
name|getConf
argument_list|()
decl_stmt|;
name|mountCGroupsOp
operator|.
name|appendArgs
argument_list|(
name|cgroupKVs
argument_list|)
expr_stmt|;
name|PrivilegedOperationExecutor
name|privilegedOperationExecutor
init|=
name|PrivilegedOperationExecutor
operator|.
name|getInstance
argument_list|(
name|conf
argument_list|)
decl_stmt|;
name|privilegedOperationExecutor
operator|.
name|executePrivilegedOperation
argument_list|(
name|mountCGroupsOp
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|PrivilegedOperationException
name|e
parameter_list|)
block|{
name|int
name|exitCode
init|=
name|e
operator|.
name|getExitCode
argument_list|()
decl_stmt|;
name|LOG
operator|.
name|warn
argument_list|(
literal|"Exception in LinuxContainerExecutor mountCgroups "
argument_list|,
name|e
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Problem mounting cgroups "
operator|+
name|cgroupKVs
operator|+
literal|"; exit code = "
operator|+
name|exitCode
operator|+
literal|" and output: "
operator|+
name|e
operator|.
name|getOutput
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
block|}
end_class

end_unit

