begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/** * Licensed to the Apache Software Foundation (ASF) under one * or more contributor license agreements.  See the NOTICE file * distributed with this work for additional information * regarding copyright ownership.  The ASF licenses this file * to you under the Apache License, Version 2.0 (the * "License"); you may not use this file except in compliance * with the License.  You may obtain a copy of the License at * *     http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */
end_comment

begin_package
DECL|package|org.apache.hadoop.yarn.server.nodemanager
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
package|;
end_package

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|utils
operator|.
name|YarnServerBuilderUtils
operator|.
name|newNodeHeartbeatResponse
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|mockito
operator|.
name|Mockito
operator|.
name|mock
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|mockito
operator|.
name|Mockito
operator|.
name|when
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|EOFException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|File
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|InetAddress
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|InetSocketAddress
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|UnknownHostException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|nio
operator|.
name|ByteBuffer
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collections
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashSet
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|LinkedList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Set
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ConcurrentMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|CountDownLatch
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|CyclicBarrier
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ExecutorService
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|TimeUnit
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|atomic
operator|.
name|AtomicBoolean
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|atomic
operator|.
name|AtomicInteger
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|Log
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|LogFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|conf
operator|.
name|Configuration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|FileContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|Path
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|DataOutputBuffer
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|Text
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|retry
operator|.
name|RetryPolicy
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|retry
operator|.
name|RetryProxy
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|metrics2
operator|.
name|lib
operator|.
name|DefaultMetricsSystem
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|net
operator|.
name|NetUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|net
operator|.
name|ServerSocketUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|Credentials
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|token
operator|.
name|delegation
operator|.
name|web
operator|.
name|DelegationTokenIdentifier
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|service
operator|.
name|Service
operator|.
name|STATE
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|service
operator|.
name|ServiceOperations
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|util
operator|.
name|concurrent
operator|.
name|HadoopExecutors
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|protocolrecords
operator|.
name|SignalContainerRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|ApplicationAttemptId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|ApplicationId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|ContainerId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|ContainerLaunchContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|ContainerState
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|ContainerStatus
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|NodeId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|Resource
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|SignalContainerCommand
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|Token
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|client
operator|.
name|RMProxy
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|conf
operator|.
name|HAUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|conf
operator|.
name|YarnConfiguration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|event
operator|.
name|Dispatcher
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|event
operator|.
name|Event
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|event
operator|.
name|EventHandler
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|exceptions
operator|.
name|YarnException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|exceptions
operator|.
name|YarnRuntimeException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|factories
operator|.
name|RecordFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|factory
operator|.
name|providers
operator|.
name|RecordFactoryProvider
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|proto
operator|.
name|YarnServerCommonServiceProtos
operator|.
name|NodeHeartbeatResponseProto
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|security
operator|.
name|ContainerTokenIdentifier
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|api
operator|.
name|ResourceTracker
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|api
operator|.
name|protocolrecords
operator|.
name|NodeHeartbeatRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|api
operator|.
name|protocolrecords
operator|.
name|NodeHeartbeatResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|api
operator|.
name|protocolrecords
operator|.
name|RegisterNodeManagerRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|api
operator|.
name|protocolrecords
operator|.
name|RegisterNodeManagerResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|api
operator|.
name|protocolrecords
operator|.
name|UnRegisterNodeManagerRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|api
operator|.
name|protocolrecords
operator|.
name|UnRegisterNodeManagerResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|api
operator|.
name|protocolrecords
operator|.
name|impl
operator|.
name|pb
operator|.
name|NodeHeartbeatResponsePBImpl
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|api
operator|.
name|records
operator|.
name|MasterKey
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|api
operator|.
name|records
operator|.
name|NodeAction
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|api
operator|.
name|records
operator|.
name|NodeStatus
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|api
operator|.
name|records
operator|.
name|impl
operator|.
name|pb
operator|.
name|MasterKeyPBImpl
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|CommonConfigurationKeysPublic
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|NodeManager
operator|.
name|NMContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|containermanager
operator|.
name|ContainerManagerImpl
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|containermanager
operator|.
name|application
operator|.
name|Application
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|containermanager
operator|.
name|application
operator|.
name|ApplicationState
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|containermanager
operator|.
name|container
operator|.
name|Container
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|containermanager
operator|.
name|container
operator|.
name|ContainerImpl
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|metrics
operator|.
name|NodeManagerMetrics
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|recovery
operator|.
name|NMNullStateStoreService
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|recovery
operator|.
name|NMStateStoreService
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|security
operator|.
name|NMContainerTokenSecretManager
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|security
operator|.
name|NMTokenSecretManagerInNM
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|security
operator|.
name|ApplicationACLsManager
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|utils
operator|.
name|BuilderUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|utils
operator|.
name|YarnServerBuilderUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|After
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Assert
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Before
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Test
import|;
end_import

begin_class
annotation|@
name|SuppressWarnings
argument_list|(
literal|"rawtypes"
argument_list|)
DECL|class|TestNodeStatusUpdater
specifier|public
class|class
name|TestNodeStatusUpdater
block|{
comment|// temp fix until metrics system can auto-detect itself running in unit test:
static|static
block|{
name|DefaultMetricsSystem
operator|.
name|setMiniClusterMode
argument_list|(
literal|true
argument_list|)
expr_stmt|;
block|}
DECL|field|LOG
specifier|static
specifier|final
name|Log
name|LOG
init|=
name|LogFactory
operator|.
name|getLog
argument_list|(
name|TestNodeStatusUpdater
operator|.
name|class
argument_list|)
decl_stmt|;
DECL|field|basedir
specifier|static
specifier|final
name|File
name|basedir
init|=
operator|new
name|File
argument_list|(
literal|"target"
argument_list|,
name|TestNodeStatusUpdater
operator|.
name|class
operator|.
name|getName
argument_list|()
argument_list|)
decl_stmt|;
DECL|field|nmLocalDir
specifier|static
specifier|final
name|File
name|nmLocalDir
init|=
operator|new
name|File
argument_list|(
name|basedir
argument_list|,
literal|"nm0"
argument_list|)
decl_stmt|;
DECL|field|tmpDir
specifier|static
specifier|final
name|File
name|tmpDir
init|=
operator|new
name|File
argument_list|(
name|basedir
argument_list|,
literal|"tmpDir"
argument_list|)
decl_stmt|;
DECL|field|remoteLogsDir
specifier|static
specifier|final
name|File
name|remoteLogsDir
init|=
operator|new
name|File
argument_list|(
name|basedir
argument_list|,
literal|"remotelogs"
argument_list|)
decl_stmt|;
DECL|field|logsDir
specifier|static
specifier|final
name|File
name|logsDir
init|=
operator|new
name|File
argument_list|(
name|basedir
argument_list|,
literal|"logs"
argument_list|)
decl_stmt|;
DECL|field|recordFactory
specifier|private
specifier|static
specifier|final
name|RecordFactory
name|recordFactory
init|=
name|RecordFactoryProvider
operator|.
name|getRecordFactory
argument_list|(
literal|null
argument_list|)
decl_stmt|;
DECL|field|heartBeatID
specifier|volatile
name|int
name|heartBeatID
init|=
literal|0
decl_stmt|;
DECL|field|nmStartError
specifier|volatile
name|Throwable
name|nmStartError
init|=
literal|null
decl_stmt|;
DECL|field|registeredNodes
specifier|private
specifier|final
name|List
argument_list|<
name|NodeId
argument_list|>
name|registeredNodes
init|=
operator|new
name|ArrayList
argument_list|<
name|NodeId
argument_list|>
argument_list|()
decl_stmt|;
DECL|field|triggered
specifier|private
name|boolean
name|triggered
init|=
literal|false
decl_stmt|;
DECL|field|conf
specifier|private
name|Configuration
name|conf
decl_stmt|;
DECL|field|nm
specifier|private
name|NodeManager
name|nm
decl_stmt|;
DECL|field|assertionFailedInThread
specifier|private
name|AtomicBoolean
name|assertionFailedInThread
init|=
operator|new
name|AtomicBoolean
argument_list|(
literal|false
argument_list|)
decl_stmt|;
annotation|@
name|Before
DECL|method|setUp ()
specifier|public
name|void
name|setUp
parameter_list|()
throws|throws
name|IOException
block|{
name|nmLocalDir
operator|.
name|mkdirs
argument_list|()
expr_stmt|;
name|tmpDir
operator|.
name|mkdirs
argument_list|()
expr_stmt|;
name|logsDir
operator|.
name|mkdirs
argument_list|()
expr_stmt|;
name|remoteLogsDir
operator|.
name|mkdirs
argument_list|()
expr_stmt|;
name|conf
operator|=
name|createNMConfig
argument_list|()
expr_stmt|;
block|}
annotation|@
name|After
DECL|method|tearDown ()
specifier|public
name|void
name|tearDown
parameter_list|()
block|{
name|this
operator|.
name|registeredNodes
operator|.
name|clear
argument_list|()
expr_stmt|;
name|heartBeatID
operator|=
literal|0
expr_stmt|;
name|ServiceOperations
operator|.
name|stop
argument_list|(
name|nm
argument_list|)
expr_stmt|;
name|assertionFailedInThread
operator|.
name|set
argument_list|(
literal|false
argument_list|)
expr_stmt|;
name|DefaultMetricsSystem
operator|.
name|shutdown
argument_list|()
expr_stmt|;
block|}
DECL|method|createMasterKey ()
specifier|public
specifier|static
name|MasterKey
name|createMasterKey
parameter_list|()
block|{
name|MasterKey
name|masterKey
init|=
operator|new
name|MasterKeyPBImpl
argument_list|()
decl_stmt|;
name|masterKey
operator|.
name|setKeyId
argument_list|(
literal|123
argument_list|)
expr_stmt|;
name|masterKey
operator|.
name|setBytes
argument_list|(
name|ByteBuffer
operator|.
name|wrap
argument_list|(
operator|new
name|byte
index|[]
block|{
operator|new
name|Integer
argument_list|(
literal|123
argument_list|)
operator|.
name|byteValue
argument_list|()
block|}
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|masterKey
return|;
block|}
DECL|class|MyResourceTracker
specifier|private
class|class
name|MyResourceTracker
implements|implements
name|ResourceTracker
block|{
DECL|field|context
specifier|private
specifier|final
name|Context
name|context
decl_stmt|;
DECL|field|signalContainer
specifier|private
name|boolean
name|signalContainer
decl_stmt|;
DECL|method|MyResourceTracker (Context context, boolean signalContainer)
specifier|public
name|MyResourceTracker
parameter_list|(
name|Context
name|context
parameter_list|,
name|boolean
name|signalContainer
parameter_list|)
block|{
name|this
operator|.
name|context
operator|=
name|context
expr_stmt|;
name|this
operator|.
name|signalContainer
operator|=
name|signalContainer
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|registerNodeManager ( RegisterNodeManagerRequest request)
specifier|public
name|RegisterNodeManagerResponse
name|registerNodeManager
parameter_list|(
name|RegisterNodeManagerRequest
name|request
parameter_list|)
throws|throws
name|YarnException
throws|,
name|IOException
block|{
name|NodeId
name|nodeId
init|=
name|request
operator|.
name|getNodeId
argument_list|()
decl_stmt|;
name|Resource
name|resource
init|=
name|request
operator|.
name|getResource
argument_list|()
decl_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Registering "
operator|+
name|nodeId
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
comment|// NOTE: this really should be checking against the config value
name|InetSocketAddress
name|expected
init|=
name|NetUtils
operator|.
name|getConnectAddress
argument_list|(
name|conf
operator|.
name|getSocketAddr
argument_list|(
name|YarnConfiguration
operator|.
name|NM_ADDRESS
argument_list|,
literal|null
argument_list|,
operator|-
literal|1
argument_list|)
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
name|NetUtils
operator|.
name|getHostPortString
argument_list|(
name|expected
argument_list|)
argument_list|,
name|nodeId
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|5
operator|*
literal|1024
argument_list|,
name|resource
operator|.
name|getMemorySize
argument_list|()
argument_list|)
expr_stmt|;
name|registeredNodes
operator|.
name|add
argument_list|(
name|nodeId
argument_list|)
expr_stmt|;
name|RegisterNodeManagerResponse
name|response
init|=
name|recordFactory
operator|.
name|newRecordInstance
argument_list|(
name|RegisterNodeManagerResponse
operator|.
name|class
argument_list|)
decl_stmt|;
name|response
operator|.
name|setContainerTokenMasterKey
argument_list|(
name|createMasterKey
argument_list|()
argument_list|)
expr_stmt|;
name|response
operator|.
name|setNMTokenMasterKey
argument_list|(
name|createMasterKey
argument_list|()
argument_list|)
expr_stmt|;
return|return
name|response
return|;
block|}
DECL|method|getAppToContainerStatusMap ( List<ContainerStatus> containers)
specifier|private
name|Map
argument_list|<
name|ApplicationId
argument_list|,
name|List
argument_list|<
name|ContainerStatus
argument_list|>
argument_list|>
name|getAppToContainerStatusMap
parameter_list|(
name|List
argument_list|<
name|ContainerStatus
argument_list|>
name|containers
parameter_list|)
block|{
name|Map
argument_list|<
name|ApplicationId
argument_list|,
name|List
argument_list|<
name|ContainerStatus
argument_list|>
argument_list|>
name|map
init|=
operator|new
name|HashMap
argument_list|<
name|ApplicationId
argument_list|,
name|List
argument_list|<
name|ContainerStatus
argument_list|>
argument_list|>
argument_list|()
decl_stmt|;
for|for
control|(
name|ContainerStatus
name|cs
range|:
name|containers
control|)
block|{
name|ApplicationId
name|applicationId
init|=
name|cs
operator|.
name|getContainerId
argument_list|()
operator|.
name|getApplicationAttemptId
argument_list|()
operator|.
name|getApplicationId
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|ContainerStatus
argument_list|>
name|appContainers
init|=
name|map
operator|.
name|get
argument_list|(
name|applicationId
argument_list|)
decl_stmt|;
if|if
condition|(
name|appContainers
operator|==
literal|null
condition|)
block|{
name|appContainers
operator|=
operator|new
name|ArrayList
argument_list|<
name|ContainerStatus
argument_list|>
argument_list|()
expr_stmt|;
name|map
operator|.
name|put
argument_list|(
name|applicationId
argument_list|,
name|appContainers
argument_list|)
expr_stmt|;
block|}
name|appContainers
operator|.
name|add
argument_list|(
name|cs
argument_list|)
expr_stmt|;
block|}
return|return
name|map
return|;
block|}
annotation|@
name|Override
DECL|method|nodeHeartbeat (NodeHeartbeatRequest request)
specifier|public
name|NodeHeartbeatResponse
name|nodeHeartbeat
parameter_list|(
name|NodeHeartbeatRequest
name|request
parameter_list|)
throws|throws
name|YarnException
throws|,
name|IOException
block|{
name|NodeStatus
name|nodeStatus
init|=
name|request
operator|.
name|getNodeStatus
argument_list|()
decl_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Got heartbeat number "
operator|+
name|heartBeatID
argument_list|)
expr_stmt|;
name|NodeManagerMetrics
name|mockMetrics
init|=
name|mock
argument_list|(
name|NodeManagerMetrics
operator|.
name|class
argument_list|)
decl_stmt|;
name|Dispatcher
name|mockDispatcher
init|=
name|mock
argument_list|(
name|Dispatcher
operator|.
name|class
argument_list|)
decl_stmt|;
annotation|@
name|SuppressWarnings
argument_list|(
literal|"unchecked"
argument_list|)
name|EventHandler
argument_list|<
name|Event
argument_list|>
name|mockEventHandler
init|=
name|mock
argument_list|(
name|EventHandler
operator|.
name|class
argument_list|)
decl_stmt|;
name|when
argument_list|(
name|mockDispatcher
operator|.
name|getEventHandler
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|mockEventHandler
argument_list|)
expr_stmt|;
name|NMStateStoreService
name|stateStore
init|=
operator|new
name|NMNullStateStoreService
argument_list|()
decl_stmt|;
name|nodeStatus
operator|.
name|setResponseId
argument_list|(
name|heartBeatID
operator|++
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|ApplicationId
argument_list|,
name|List
argument_list|<
name|ContainerStatus
argument_list|>
argument_list|>
name|appToContainers
init|=
name|getAppToContainerStatusMap
argument_list|(
name|nodeStatus
operator|.
name|getContainersStatuses
argument_list|()
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|SignalContainerRequest
argument_list|>
name|containersToSignal
init|=
literal|null
decl_stmt|;
name|ApplicationId
name|appId1
init|=
name|ApplicationId
operator|.
name|newInstance
argument_list|(
literal|0
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|ApplicationId
name|appId2
init|=
name|ApplicationId
operator|.
name|newInstance
argument_list|(
literal|0
argument_list|,
literal|2
argument_list|)
decl_stmt|;
name|ContainerId
name|firstContainerID
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|heartBeatID
operator|==
literal|1
condition|)
block|{
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|0
argument_list|,
name|nodeStatus
operator|.
name|getContainersStatuses
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
comment|// Give a container to the NM.
name|ApplicationAttemptId
name|appAttemptID
init|=
name|ApplicationAttemptId
operator|.
name|newInstance
argument_list|(
name|appId1
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|firstContainerID
operator|=
name|ContainerId
operator|.
name|newContainerId
argument_list|(
name|appAttemptID
argument_list|,
name|heartBeatID
argument_list|)
expr_stmt|;
name|ContainerLaunchContext
name|launchContext
init|=
name|recordFactory
operator|.
name|newRecordInstance
argument_list|(
name|ContainerLaunchContext
operator|.
name|class
argument_list|)
decl_stmt|;
name|Resource
name|resource
init|=
name|BuilderUtils
operator|.
name|newResource
argument_list|(
literal|2
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|long
name|currentTime
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|String
name|user
init|=
literal|"testUser"
decl_stmt|;
name|ContainerTokenIdentifier
name|containerToken
init|=
name|BuilderUtils
operator|.
name|newContainerTokenIdentifier
argument_list|(
name|BuilderUtils
operator|.
name|newContainerToken
argument_list|(
name|firstContainerID
argument_list|,
literal|0
argument_list|,
name|InetAddress
operator|.
name|getByName
argument_list|(
literal|"localhost"
argument_list|)
operator|.
name|getCanonicalHostName
argument_list|()
argument_list|,
literal|1234
argument_list|,
name|user
argument_list|,
name|resource
argument_list|,
name|currentTime
operator|+
literal|10000
argument_list|,
literal|123
argument_list|,
literal|"password"
operator|.
name|getBytes
argument_list|()
argument_list|,
name|currentTime
argument_list|)
argument_list|)
decl_stmt|;
name|Context
name|context
init|=
name|mock
argument_list|(
name|Context
operator|.
name|class
argument_list|)
decl_stmt|;
name|when
argument_list|(
name|context
operator|.
name|getNMStateStore
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|stateStore
argument_list|)
expr_stmt|;
name|Container
name|container
init|=
operator|new
name|ContainerImpl
argument_list|(
name|conf
argument_list|,
name|mockDispatcher
argument_list|,
name|launchContext
argument_list|,
literal|null
argument_list|,
name|mockMetrics
argument_list|,
name|containerToken
argument_list|,
name|context
argument_list|)
decl_stmt|;
name|this
operator|.
name|context
operator|.
name|getContainers
argument_list|()
operator|.
name|put
argument_list|(
name|firstContainerID
argument_list|,
name|container
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|heartBeatID
operator|==
literal|2
condition|)
block|{
comment|// Checks on the RM end
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Number of applications should only be one!"
argument_list|,
literal|1
argument_list|,
name|nodeStatus
operator|.
name|getContainersStatuses
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Number of container for the app should be one!"
argument_list|,
literal|1
argument_list|,
name|appToContainers
operator|.
name|get
argument_list|(
name|appId1
argument_list|)
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
comment|// Checks on the NM end
name|ConcurrentMap
argument_list|<
name|ContainerId
argument_list|,
name|Container
argument_list|>
name|activeContainers
init|=
name|this
operator|.
name|context
operator|.
name|getContainers
argument_list|()
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|activeContainers
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|this
operator|.
name|signalContainer
condition|)
block|{
name|containersToSignal
operator|=
operator|new
name|ArrayList
argument_list|<
name|SignalContainerRequest
argument_list|>
argument_list|()
expr_stmt|;
name|SignalContainerRequest
name|signalReq
init|=
name|recordFactory
operator|.
name|newRecordInstance
argument_list|(
name|SignalContainerRequest
operator|.
name|class
argument_list|)
decl_stmt|;
name|signalReq
operator|.
name|setContainerId
argument_list|(
name|firstContainerID
argument_list|)
expr_stmt|;
name|signalReq
operator|.
name|setCommand
argument_list|(
name|SignalContainerCommand
operator|.
name|OUTPUT_THREAD_DUMP
argument_list|)
expr_stmt|;
name|containersToSignal
operator|.
name|add
argument_list|(
name|signalReq
argument_list|)
expr_stmt|;
block|}
comment|// Give another container to the NM.
name|ApplicationAttemptId
name|appAttemptID
init|=
name|ApplicationAttemptId
operator|.
name|newInstance
argument_list|(
name|appId2
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|ContainerId
name|secondContainerID
init|=
name|ContainerId
operator|.
name|newContainerId
argument_list|(
name|appAttemptID
argument_list|,
name|heartBeatID
argument_list|)
decl_stmt|;
name|ContainerLaunchContext
name|launchContext
init|=
name|recordFactory
operator|.
name|newRecordInstance
argument_list|(
name|ContainerLaunchContext
operator|.
name|class
argument_list|)
decl_stmt|;
name|long
name|currentTime
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|String
name|user
init|=
literal|"testUser"
decl_stmt|;
name|Resource
name|resource
init|=
name|BuilderUtils
operator|.
name|newResource
argument_list|(
literal|3
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|ContainerTokenIdentifier
name|containerToken
init|=
name|BuilderUtils
operator|.
name|newContainerTokenIdentifier
argument_list|(
name|BuilderUtils
operator|.
name|newContainerToken
argument_list|(
name|secondContainerID
argument_list|,
literal|0
argument_list|,
name|InetAddress
operator|.
name|getByName
argument_list|(
literal|"localhost"
argument_list|)
operator|.
name|getCanonicalHostName
argument_list|()
argument_list|,
literal|1234
argument_list|,
name|user
argument_list|,
name|resource
argument_list|,
name|currentTime
operator|+
literal|10000
argument_list|,
literal|123
argument_list|,
literal|"password"
operator|.
name|getBytes
argument_list|()
argument_list|,
name|currentTime
argument_list|)
argument_list|)
decl_stmt|;
name|Context
name|context
init|=
name|mock
argument_list|(
name|Context
operator|.
name|class
argument_list|)
decl_stmt|;
name|when
argument_list|(
name|context
operator|.
name|getNMStateStore
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|stateStore
argument_list|)
expr_stmt|;
name|Container
name|container
init|=
operator|new
name|ContainerImpl
argument_list|(
name|conf
argument_list|,
name|mockDispatcher
argument_list|,
name|launchContext
argument_list|,
literal|null
argument_list|,
name|mockMetrics
argument_list|,
name|containerToken
argument_list|,
name|context
argument_list|)
decl_stmt|;
name|this
operator|.
name|context
operator|.
name|getContainers
argument_list|()
operator|.
name|put
argument_list|(
name|secondContainerID
argument_list|,
name|container
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|heartBeatID
operator|==
literal|3
condition|)
block|{
comment|// Checks on the RM end
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Number of applications should have two!"
argument_list|,
literal|2
argument_list|,
name|appToContainers
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Number of container for the app-1 should be only one!"
argument_list|,
literal|1
argument_list|,
name|appToContainers
operator|.
name|get
argument_list|(
name|appId1
argument_list|)
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Number of container for the app-2 should be only one!"
argument_list|,
literal|1
argument_list|,
name|appToContainers
operator|.
name|get
argument_list|(
name|appId2
argument_list|)
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
comment|// Checks on the NM end
name|ConcurrentMap
argument_list|<
name|ContainerId
argument_list|,
name|Container
argument_list|>
name|activeContainers
init|=
name|this
operator|.
name|context
operator|.
name|getContainers
argument_list|()
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|2
argument_list|,
name|activeContainers
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|NodeHeartbeatResponse
name|nhResponse
init|=
name|YarnServerBuilderUtils
operator|.
name|newNodeHeartbeatResponse
argument_list|(
name|heartBeatID
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|1000L
argument_list|)
decl_stmt|;
if|if
condition|(
name|containersToSignal
operator|!=
literal|null
condition|)
block|{
name|nhResponse
operator|.
name|addAllContainersToSignal
argument_list|(
name|containersToSignal
argument_list|)
expr_stmt|;
block|}
return|return
name|nhResponse
return|;
block|}
annotation|@
name|Override
DECL|method|unRegisterNodeManager ( UnRegisterNodeManagerRequest request)
specifier|public
name|UnRegisterNodeManagerResponse
name|unRegisterNodeManager
parameter_list|(
name|UnRegisterNodeManagerRequest
name|request
parameter_list|)
throws|throws
name|YarnException
throws|,
name|IOException
block|{
return|return
name|recordFactory
operator|.
name|newRecordInstance
argument_list|(
name|UnRegisterNodeManagerResponse
operator|.
name|class
argument_list|)
return|;
block|}
block|}
DECL|class|MyContainerManager
specifier|private
class|class
name|MyContainerManager
extends|extends
name|ContainerManagerImpl
block|{
DECL|field|signaled
specifier|public
name|boolean
name|signaled
init|=
literal|false
decl_stmt|;
DECL|method|MyContainerManager (Context context, ContainerExecutor exec, DeletionService deletionContext, NodeStatusUpdater nodeStatusUpdater, NodeManagerMetrics metrics, LocalDirsHandlerService dirsHandler)
specifier|public
name|MyContainerManager
parameter_list|(
name|Context
name|context
parameter_list|,
name|ContainerExecutor
name|exec
parameter_list|,
name|DeletionService
name|deletionContext
parameter_list|,
name|NodeStatusUpdater
name|nodeStatusUpdater
parameter_list|,
name|NodeManagerMetrics
name|metrics
parameter_list|,
name|LocalDirsHandlerService
name|dirsHandler
parameter_list|)
block|{
name|super
argument_list|(
name|context
argument_list|,
name|exec
argument_list|,
name|deletionContext
argument_list|,
name|nodeStatusUpdater
argument_list|,
name|metrics
argument_list|,
name|dirsHandler
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|handle (ContainerManagerEvent event)
specifier|public
name|void
name|handle
parameter_list|(
name|ContainerManagerEvent
name|event
parameter_list|)
block|{
if|if
condition|(
name|event
operator|.
name|getType
argument_list|()
operator|==
name|ContainerManagerEventType
operator|.
name|SIGNAL_CONTAINERS
condition|)
block|{
name|signaled
operator|=
literal|true
expr_stmt|;
block|}
block|}
block|}
DECL|class|MyNodeStatusUpdater
specifier|private
class|class
name|MyNodeStatusUpdater
extends|extends
name|NodeStatusUpdaterImpl
block|{
DECL|field|resourceTracker
specifier|public
name|ResourceTracker
name|resourceTracker
decl_stmt|;
DECL|field|context
specifier|private
name|Context
name|context
decl_stmt|;
DECL|method|MyNodeStatusUpdater (Context context, Dispatcher dispatcher, NodeHealthCheckerService healthChecker, NodeManagerMetrics metrics)
specifier|public
name|MyNodeStatusUpdater
parameter_list|(
name|Context
name|context
parameter_list|,
name|Dispatcher
name|dispatcher
parameter_list|,
name|NodeHealthCheckerService
name|healthChecker
parameter_list|,
name|NodeManagerMetrics
name|metrics
parameter_list|)
block|{
name|this
argument_list|(
name|context
argument_list|,
name|dispatcher
argument_list|,
name|healthChecker
argument_list|,
name|metrics
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
DECL|method|MyNodeStatusUpdater (Context context, Dispatcher dispatcher, NodeHealthCheckerService healthChecker, NodeManagerMetrics metrics, boolean signalContainer)
specifier|public
name|MyNodeStatusUpdater
parameter_list|(
name|Context
name|context
parameter_list|,
name|Dispatcher
name|dispatcher
parameter_list|,
name|NodeHealthCheckerService
name|healthChecker
parameter_list|,
name|NodeManagerMetrics
name|metrics
parameter_list|,
name|boolean
name|signalContainer
parameter_list|)
block|{
name|super
argument_list|(
name|context
argument_list|,
name|dispatcher
argument_list|,
name|healthChecker
argument_list|,
name|metrics
argument_list|)
expr_stmt|;
name|this
operator|.
name|context
operator|=
name|context
expr_stmt|;
name|resourceTracker
operator|=
operator|new
name|MyResourceTracker
argument_list|(
name|this
operator|.
name|context
argument_list|,
name|signalContainer
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|getRMClient ()
specifier|protected
name|ResourceTracker
name|getRMClient
parameter_list|()
block|{
return|return
name|resourceTracker
return|;
block|}
annotation|@
name|Override
DECL|method|stopRMProxy ()
specifier|protected
name|void
name|stopRMProxy
parameter_list|()
block|{
return|return;
block|}
block|}
comment|// Test NodeStatusUpdater sends the right container statuses each time it
comment|// heart beats.
DECL|class|MyNodeStatusUpdater2
specifier|private
class|class
name|MyNodeStatusUpdater2
extends|extends
name|NodeStatusUpdaterImpl
block|{
DECL|field|resourceTracker
specifier|public
name|ResourceTracker
name|resourceTracker
decl_stmt|;
DECL|method|MyNodeStatusUpdater2 (Context context, Dispatcher dispatcher, NodeHealthCheckerService healthChecker, NodeManagerMetrics metrics)
specifier|public
name|MyNodeStatusUpdater2
parameter_list|(
name|Context
name|context
parameter_list|,
name|Dispatcher
name|dispatcher
parameter_list|,
name|NodeHealthCheckerService
name|healthChecker
parameter_list|,
name|NodeManagerMetrics
name|metrics
parameter_list|)
block|{
name|super
argument_list|(
name|context
argument_list|,
name|dispatcher
argument_list|,
name|healthChecker
argument_list|,
name|metrics
argument_list|)
expr_stmt|;
name|resourceTracker
operator|=
operator|new
name|MyResourceTracker4
argument_list|(
name|context
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|getRMClient ()
specifier|protected
name|ResourceTracker
name|getRMClient
parameter_list|()
block|{
return|return
name|resourceTracker
return|;
block|}
annotation|@
name|Override
DECL|method|stopRMProxy ()
specifier|protected
name|void
name|stopRMProxy
parameter_list|()
block|{
return|return;
block|}
block|}
DECL|class|MyNodeStatusUpdater3
specifier|private
class|class
name|MyNodeStatusUpdater3
extends|extends
name|NodeStatusUpdaterImpl
block|{
DECL|field|resourceTracker
specifier|public
name|ResourceTracker
name|resourceTracker
decl_stmt|;
DECL|field|context
specifier|private
name|Context
name|context
decl_stmt|;
DECL|method|MyNodeStatusUpdater3 (Context context, Dispatcher dispatcher, NodeHealthCheckerService healthChecker, NodeManagerMetrics metrics)
specifier|public
name|MyNodeStatusUpdater3
parameter_list|(
name|Context
name|context
parameter_list|,
name|Dispatcher
name|dispatcher
parameter_list|,
name|NodeHealthCheckerService
name|healthChecker
parameter_list|,
name|NodeManagerMetrics
name|metrics
parameter_list|)
block|{
name|super
argument_list|(
name|context
argument_list|,
name|dispatcher
argument_list|,
name|healthChecker
argument_list|,
name|metrics
argument_list|)
expr_stmt|;
name|this
operator|.
name|context
operator|=
name|context
expr_stmt|;
name|this
operator|.
name|resourceTracker
operator|=
operator|new
name|MyResourceTracker3
argument_list|(
name|this
operator|.
name|context
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|getRMClient ()
specifier|protected
name|ResourceTracker
name|getRMClient
parameter_list|()
block|{
return|return
name|resourceTracker
return|;
block|}
annotation|@
name|Override
DECL|method|stopRMProxy ()
specifier|protected
name|void
name|stopRMProxy
parameter_list|()
block|{
return|return;
block|}
annotation|@
name|Override
DECL|method|isTokenKeepAliveEnabled (Configuration conf)
specifier|protected
name|boolean
name|isTokenKeepAliveEnabled
parameter_list|(
name|Configuration
name|conf
parameter_list|)
block|{
return|return
literal|true
return|;
block|}
block|}
DECL|class|MyNodeStatusUpdater4
specifier|private
class|class
name|MyNodeStatusUpdater4
extends|extends
name|NodeStatusUpdaterImpl
block|{
DECL|field|rmStartIntervalMS
specifier|private
specifier|final
name|long
name|rmStartIntervalMS
decl_stmt|;
DECL|field|rmNeverStart
specifier|private
specifier|final
name|boolean
name|rmNeverStart
decl_stmt|;
DECL|field|resourceTracker
specifier|public
name|ResourceTracker
name|resourceTracker
decl_stmt|;
DECL|method|MyNodeStatusUpdater4 (Context context, Dispatcher dispatcher, NodeHealthCheckerService healthChecker, NodeManagerMetrics metrics, long rmStartIntervalMS, boolean rmNeverStart)
specifier|public
name|MyNodeStatusUpdater4
parameter_list|(
name|Context
name|context
parameter_list|,
name|Dispatcher
name|dispatcher
parameter_list|,
name|NodeHealthCheckerService
name|healthChecker
parameter_list|,
name|NodeManagerMetrics
name|metrics
parameter_list|,
name|long
name|rmStartIntervalMS
parameter_list|,
name|boolean
name|rmNeverStart
parameter_list|)
block|{
name|super
argument_list|(
name|context
argument_list|,
name|dispatcher
argument_list|,
name|healthChecker
argument_list|,
name|metrics
argument_list|)
expr_stmt|;
name|this
operator|.
name|rmStartIntervalMS
operator|=
name|rmStartIntervalMS
expr_stmt|;
name|this
operator|.
name|rmNeverStart
operator|=
name|rmNeverStart
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|serviceStart ()
specifier|protected
name|void
name|serviceStart
parameter_list|()
throws|throws
name|Exception
block|{
comment|//record the startup time
name|super
operator|.
name|serviceStart
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|getRMClient ()
specifier|protected
name|ResourceTracker
name|getRMClient
parameter_list|()
throws|throws
name|IOException
block|{
name|RetryPolicy
name|retryPolicy
init|=
name|RMProxy
operator|.
name|createRetryPolicy
argument_list|(
name|conf
argument_list|,
name|HAUtil
operator|.
name|isHAEnabled
argument_list|(
name|conf
argument_list|)
argument_list|)
decl_stmt|;
name|resourceTracker
operator|=
operator|(
name|ResourceTracker
operator|)
name|RetryProxy
operator|.
name|create
argument_list|(
name|ResourceTracker
operator|.
name|class
argument_list|,
operator|new
name|MyResourceTracker6
argument_list|(
name|rmStartIntervalMS
argument_list|,
name|rmNeverStart
argument_list|)
argument_list|,
name|retryPolicy
argument_list|)
expr_stmt|;
return|return
name|resourceTracker
return|;
block|}
DECL|method|isTriggered ()
specifier|private
name|boolean
name|isTriggered
parameter_list|()
block|{
return|return
name|triggered
return|;
block|}
annotation|@
name|Override
DECL|method|stopRMProxy ()
specifier|protected
name|void
name|stopRMProxy
parameter_list|()
block|{
return|return;
block|}
block|}
DECL|class|MyNodeStatusUpdater5
specifier|private
class|class
name|MyNodeStatusUpdater5
extends|extends
name|NodeStatusUpdaterImpl
block|{
DECL|field|resourceTracker
specifier|private
name|ResourceTracker
name|resourceTracker
decl_stmt|;
DECL|field|conf
specifier|private
name|Configuration
name|conf
decl_stmt|;
DECL|method|MyNodeStatusUpdater5 (Context context, Dispatcher dispatcher, NodeHealthCheckerService healthChecker, NodeManagerMetrics metrics, Configuration conf)
specifier|public
name|MyNodeStatusUpdater5
parameter_list|(
name|Context
name|context
parameter_list|,
name|Dispatcher
name|dispatcher
parameter_list|,
name|NodeHealthCheckerService
name|healthChecker
parameter_list|,
name|NodeManagerMetrics
name|metrics
parameter_list|,
name|Configuration
name|conf
parameter_list|)
block|{
name|super
argument_list|(
name|context
argument_list|,
name|dispatcher
argument_list|,
name|healthChecker
argument_list|,
name|metrics
argument_list|)
expr_stmt|;
name|resourceTracker
operator|=
operator|new
name|MyResourceTracker5
argument_list|()
expr_stmt|;
name|this
operator|.
name|conf
operator|=
name|conf
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|getRMClient ()
specifier|protected
name|ResourceTracker
name|getRMClient
parameter_list|()
block|{
name|RetryPolicy
name|retryPolicy
init|=
name|RMProxy
operator|.
name|createRetryPolicy
argument_list|(
name|conf
argument_list|,
name|HAUtil
operator|.
name|isHAEnabled
argument_list|(
name|conf
argument_list|)
argument_list|)
decl_stmt|;
return|return
operator|(
name|ResourceTracker
operator|)
name|RetryProxy
operator|.
name|create
argument_list|(
name|ResourceTracker
operator|.
name|class
argument_list|,
name|resourceTracker
argument_list|,
name|retryPolicy
argument_list|)
return|;
block|}
annotation|@
name|Override
DECL|method|stopRMProxy ()
specifier|protected
name|void
name|stopRMProxy
parameter_list|()
block|{
return|return;
block|}
block|}
DECL|class|MyNodeStatusUpdater6
specifier|private
class|class
name|MyNodeStatusUpdater6
extends|extends
name|NodeStatusUpdaterImpl
block|{
DECL|field|rmStartIntervalMS
specifier|private
specifier|final
name|long
name|rmStartIntervalMS
decl_stmt|;
DECL|field|rmNeverStart
specifier|private
specifier|final
name|boolean
name|rmNeverStart
decl_stmt|;
DECL|field|resourceTracker
specifier|public
name|ResourceTracker
name|resourceTracker
decl_stmt|;
DECL|method|MyNodeStatusUpdater6 (Context context, Dispatcher dispatcher, NodeHealthCheckerService healthChecker, NodeManagerMetrics metrics, long rmStartIntervalMS, boolean rmNeverStart)
specifier|public
name|MyNodeStatusUpdater6
parameter_list|(
name|Context
name|context
parameter_list|,
name|Dispatcher
name|dispatcher
parameter_list|,
name|NodeHealthCheckerService
name|healthChecker
parameter_list|,
name|NodeManagerMetrics
name|metrics
parameter_list|,
name|long
name|rmStartIntervalMS
parameter_list|,
name|boolean
name|rmNeverStart
parameter_list|)
block|{
name|super
argument_list|(
name|context
argument_list|,
name|dispatcher
argument_list|,
name|healthChecker
argument_list|,
name|metrics
argument_list|)
expr_stmt|;
name|this
operator|.
name|rmStartIntervalMS
operator|=
name|rmStartIntervalMS
expr_stmt|;
name|this
operator|.
name|rmNeverStart
operator|=
name|rmNeverStart
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|serviceStart ()
specifier|protected
name|void
name|serviceStart
parameter_list|()
throws|throws
name|Exception
block|{
comment|//record the startup time
name|super
operator|.
name|serviceStart
argument_list|()
expr_stmt|;
block|}
DECL|method|isTriggered ()
specifier|private
name|boolean
name|isTriggered
parameter_list|()
block|{
return|return
name|triggered
return|;
block|}
annotation|@
name|Override
DECL|method|stopRMProxy ()
specifier|protected
name|void
name|stopRMProxy
parameter_list|()
block|{
return|return;
block|}
block|}
DECL|class|MyNodeManager
specifier|private
class|class
name|MyNodeManager
extends|extends
name|NodeManager
block|{
DECL|field|nodeStatusUpdater
specifier|private
name|MyNodeStatusUpdater3
name|nodeStatusUpdater
decl_stmt|;
annotation|@
name|Override
DECL|method|createNodeStatusUpdater (Context context, Dispatcher dispatcher, NodeHealthCheckerService healthChecker)
specifier|protected
name|NodeStatusUpdater
name|createNodeStatusUpdater
parameter_list|(
name|Context
name|context
parameter_list|,
name|Dispatcher
name|dispatcher
parameter_list|,
name|NodeHealthCheckerService
name|healthChecker
parameter_list|)
block|{
name|this
operator|.
name|nodeStatusUpdater
operator|=
operator|new
name|MyNodeStatusUpdater3
argument_list|(
name|context
argument_list|,
name|dispatcher
argument_list|,
name|healthChecker
argument_list|,
name|metrics
argument_list|)
expr_stmt|;
return|return
name|this
operator|.
name|nodeStatusUpdater
return|;
block|}
DECL|method|getNodeStatusUpdater ()
specifier|public
name|MyNodeStatusUpdater3
name|getNodeStatusUpdater
parameter_list|()
block|{
return|return
name|this
operator|.
name|nodeStatusUpdater
return|;
block|}
block|}
DECL|class|MyNodeManager2
specifier|private
class|class
name|MyNodeManager2
extends|extends
name|NodeManager
block|{
DECL|field|isStopped
specifier|public
name|boolean
name|isStopped
init|=
literal|false
decl_stmt|;
DECL|field|nodeStatusUpdater
specifier|private
name|NodeStatusUpdater
name|nodeStatusUpdater
decl_stmt|;
DECL|field|syncBarrier
specifier|private
name|CyclicBarrier
name|syncBarrier
decl_stmt|;
DECL|field|conf
specifier|private
name|Configuration
name|conf
decl_stmt|;
DECL|method|MyNodeManager2 (CyclicBarrier syncBarrier, Configuration conf)
specifier|public
name|MyNodeManager2
parameter_list|(
name|CyclicBarrier
name|syncBarrier
parameter_list|,
name|Configuration
name|conf
parameter_list|)
block|{
name|this
operator|.
name|syncBarrier
operator|=
name|syncBarrier
expr_stmt|;
name|this
operator|.
name|conf
operator|=
name|conf
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|createNodeStatusUpdater (Context context, Dispatcher dispatcher, NodeHealthCheckerService healthChecker)
specifier|protected
name|NodeStatusUpdater
name|createNodeStatusUpdater
parameter_list|(
name|Context
name|context
parameter_list|,
name|Dispatcher
name|dispatcher
parameter_list|,
name|NodeHealthCheckerService
name|healthChecker
parameter_list|)
block|{
name|nodeStatusUpdater
operator|=
operator|new
name|MyNodeStatusUpdater5
argument_list|(
name|context
argument_list|,
name|dispatcher
argument_list|,
name|healthChecker
argument_list|,
name|metrics
argument_list|,
name|conf
argument_list|)
expr_stmt|;
return|return
name|nodeStatusUpdater
return|;
block|}
annotation|@
name|Override
DECL|method|serviceStop ()
specifier|protected
name|void
name|serviceStop
parameter_list|()
throws|throws
name|Exception
block|{
comment|// Make sure that all containers are started before starting shutdown
name|syncBarrier
operator|.
name|await
argument_list|(
literal|10000
argument_list|,
name|TimeUnit
operator|.
name|MILLISECONDS
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Called stooppppp"
argument_list|)
expr_stmt|;
name|super
operator|.
name|serviceStop
argument_list|()
expr_stmt|;
name|isStopped
operator|=
literal|true
expr_stmt|;
name|ConcurrentMap
argument_list|<
name|ApplicationId
argument_list|,
name|Application
argument_list|>
name|applications
init|=
name|getNMContext
argument_list|()
operator|.
name|getApplications
argument_list|()
decl_stmt|;
comment|// ensure that applications are empty
if|if
condition|(
operator|!
name|applications
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|assertionFailedInThread
operator|.
name|set
argument_list|(
literal|true
argument_list|)
expr_stmt|;
block|}
name|syncBarrier
operator|.
name|await
argument_list|(
literal|10000
argument_list|,
name|TimeUnit
operator|.
name|MILLISECONDS
argument_list|)
expr_stmt|;
block|}
block|}
comment|//
DECL|class|MyResourceTracker2
specifier|private
class|class
name|MyResourceTracker2
implements|implements
name|ResourceTracker
block|{
DECL|field|heartBeatNodeAction
specifier|public
name|NodeAction
name|heartBeatNodeAction
init|=
name|NodeAction
operator|.
name|NORMAL
decl_stmt|;
DECL|field|registerNodeAction
specifier|public
name|NodeAction
name|registerNodeAction
init|=
name|NodeAction
operator|.
name|NORMAL
decl_stmt|;
DECL|field|shutDownMessage
specifier|public
name|String
name|shutDownMessage
init|=
literal|""
decl_stmt|;
DECL|field|rmVersion
specifier|public
name|String
name|rmVersion
init|=
literal|"3.0.1"
decl_stmt|;
annotation|@
name|Override
DECL|method|registerNodeManager ( RegisterNodeManagerRequest request)
specifier|public
name|RegisterNodeManagerResponse
name|registerNodeManager
parameter_list|(
name|RegisterNodeManagerRequest
name|request
parameter_list|)
throws|throws
name|YarnException
throws|,
name|IOException
block|{
name|RegisterNodeManagerResponse
name|response
init|=
name|recordFactory
operator|.
name|newRecordInstance
argument_list|(
name|RegisterNodeManagerResponse
operator|.
name|class
argument_list|)
decl_stmt|;
name|response
operator|.
name|setNodeAction
argument_list|(
name|registerNodeAction
argument_list|)
expr_stmt|;
name|response
operator|.
name|setContainerTokenMasterKey
argument_list|(
name|createMasterKey
argument_list|()
argument_list|)
expr_stmt|;
name|response
operator|.
name|setNMTokenMasterKey
argument_list|(
name|createMasterKey
argument_list|()
argument_list|)
expr_stmt|;
name|response
operator|.
name|setDiagnosticsMessage
argument_list|(
name|shutDownMessage
argument_list|)
expr_stmt|;
name|response
operator|.
name|setRMVersion
argument_list|(
name|rmVersion
argument_list|)
expr_stmt|;
return|return
name|response
return|;
block|}
annotation|@
name|Override
DECL|method|nodeHeartbeat (NodeHeartbeatRequest request)
specifier|public
name|NodeHeartbeatResponse
name|nodeHeartbeat
parameter_list|(
name|NodeHeartbeatRequest
name|request
parameter_list|)
throws|throws
name|YarnException
throws|,
name|IOException
block|{
name|NodeStatus
name|nodeStatus
init|=
name|request
operator|.
name|getNodeStatus
argument_list|()
decl_stmt|;
name|nodeStatus
operator|.
name|setResponseId
argument_list|(
name|heartBeatID
operator|++
argument_list|)
expr_stmt|;
name|NodeHeartbeatResponse
name|nhResponse
init|=
name|YarnServerBuilderUtils
operator|.
name|newNodeHeartbeatResponse
argument_list|(
name|heartBeatID
argument_list|,
name|heartBeatNodeAction
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|1000L
argument_list|)
decl_stmt|;
name|nhResponse
operator|.
name|setDiagnosticsMessage
argument_list|(
name|shutDownMessage
argument_list|)
expr_stmt|;
return|return
name|nhResponse
return|;
block|}
annotation|@
name|Override
DECL|method|unRegisterNodeManager ( UnRegisterNodeManagerRequest request)
specifier|public
name|UnRegisterNodeManagerResponse
name|unRegisterNodeManager
parameter_list|(
name|UnRegisterNodeManagerRequest
name|request
parameter_list|)
throws|throws
name|YarnException
throws|,
name|IOException
block|{
return|return
name|recordFactory
operator|.
name|newRecordInstance
argument_list|(
name|UnRegisterNodeManagerResponse
operator|.
name|class
argument_list|)
return|;
block|}
block|}
DECL|class|MyResourceTracker3
specifier|private
class|class
name|MyResourceTracker3
implements|implements
name|ResourceTracker
block|{
DECL|field|heartBeatNodeAction
specifier|public
name|NodeAction
name|heartBeatNodeAction
init|=
name|NodeAction
operator|.
name|NORMAL
decl_stmt|;
DECL|field|registerNodeAction
specifier|public
name|NodeAction
name|registerNodeAction
init|=
name|NodeAction
operator|.
name|NORMAL
decl_stmt|;
DECL|field|keepAliveRequests
specifier|private
name|Map
argument_list|<
name|ApplicationId
argument_list|,
name|List
argument_list|<
name|Long
argument_list|>
argument_list|>
name|keepAliveRequests
init|=
operator|new
name|HashMap
argument_list|<
name|ApplicationId
argument_list|,
name|List
argument_list|<
name|Long
argument_list|>
argument_list|>
argument_list|()
decl_stmt|;
DECL|field|appId
specifier|private
name|ApplicationId
name|appId
init|=
name|BuilderUtils
operator|.
name|newApplicationId
argument_list|(
literal|1
argument_list|,
literal|1
argument_list|)
decl_stmt|;
DECL|field|context
specifier|private
specifier|final
name|Context
name|context
decl_stmt|;
DECL|method|MyResourceTracker3 (Context context)
name|MyResourceTracker3
parameter_list|(
name|Context
name|context
parameter_list|)
block|{
name|this
operator|.
name|context
operator|=
name|context
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|registerNodeManager ( RegisterNodeManagerRequest request)
specifier|public
name|RegisterNodeManagerResponse
name|registerNodeManager
parameter_list|(
name|RegisterNodeManagerRequest
name|request
parameter_list|)
throws|throws
name|YarnException
throws|,
name|IOException
block|{
name|RegisterNodeManagerResponse
name|response
init|=
name|recordFactory
operator|.
name|newRecordInstance
argument_list|(
name|RegisterNodeManagerResponse
operator|.
name|class
argument_list|)
decl_stmt|;
name|response
operator|.
name|setNodeAction
argument_list|(
name|registerNodeAction
argument_list|)
expr_stmt|;
name|response
operator|.
name|setContainerTokenMasterKey
argument_list|(
name|createMasterKey
argument_list|()
argument_list|)
expr_stmt|;
name|response
operator|.
name|setNMTokenMasterKey
argument_list|(
name|createMasterKey
argument_list|()
argument_list|)
expr_stmt|;
return|return
name|response
return|;
block|}
annotation|@
name|Override
DECL|method|nodeHeartbeat (NodeHeartbeatRequest request)
specifier|public
name|NodeHeartbeatResponse
name|nodeHeartbeat
parameter_list|(
name|NodeHeartbeatRequest
name|request
parameter_list|)
throws|throws
name|YarnException
throws|,
name|IOException
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Got heartBeatId: ["
operator|+
name|heartBeatID
operator|+
literal|"]"
argument_list|)
expr_stmt|;
name|NodeStatus
name|nodeStatus
init|=
name|request
operator|.
name|getNodeStatus
argument_list|()
decl_stmt|;
name|nodeStatus
operator|.
name|setResponseId
argument_list|(
name|heartBeatID
operator|++
argument_list|)
expr_stmt|;
name|NodeHeartbeatResponse
name|nhResponse
init|=
name|YarnServerBuilderUtils
operator|.
name|newNodeHeartbeatResponse
argument_list|(
name|heartBeatID
argument_list|,
name|heartBeatNodeAction
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|1000L
argument_list|)
decl_stmt|;
if|if
condition|(
name|nodeStatus
operator|.
name|getKeepAliveApplications
argument_list|()
operator|!=
literal|null
operator|&&
name|nodeStatus
operator|.
name|getKeepAliveApplications
argument_list|()
operator|.
name|size
argument_list|()
operator|>
literal|0
condition|)
block|{
for|for
control|(
name|ApplicationId
name|appId
range|:
name|nodeStatus
operator|.
name|getKeepAliveApplications
argument_list|()
control|)
block|{
name|List
argument_list|<
name|Long
argument_list|>
name|list
init|=
name|keepAliveRequests
operator|.
name|get
argument_list|(
name|appId
argument_list|)
decl_stmt|;
if|if
condition|(
name|list
operator|==
literal|null
condition|)
block|{
name|list
operator|=
operator|new
name|LinkedList
argument_list|<
name|Long
argument_list|>
argument_list|()
expr_stmt|;
name|keepAliveRequests
operator|.
name|put
argument_list|(
name|appId
argument_list|,
name|list
argument_list|)
expr_stmt|;
block|}
name|list
operator|.
name|add
argument_list|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|heartBeatID
operator|==
literal|2
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Sending FINISH_APP for application: ["
operator|+
name|appId
operator|+
literal|"]"
argument_list|)
expr_stmt|;
name|this
operator|.
name|context
operator|.
name|getApplications
argument_list|()
operator|.
name|put
argument_list|(
name|appId
argument_list|,
name|mock
argument_list|(
name|Application
operator|.
name|class
argument_list|)
argument_list|)
expr_stmt|;
name|nhResponse
operator|.
name|addAllApplicationsToCleanup
argument_list|(
name|Collections
operator|.
name|singletonList
argument_list|(
name|appId
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|nhResponse
return|;
block|}
annotation|@
name|Override
DECL|method|unRegisterNodeManager ( UnRegisterNodeManagerRequest request)
specifier|public
name|UnRegisterNodeManagerResponse
name|unRegisterNodeManager
parameter_list|(
name|UnRegisterNodeManagerRequest
name|request
parameter_list|)
throws|throws
name|YarnException
throws|,
name|IOException
block|{
return|return
name|recordFactory
operator|.
name|newRecordInstance
argument_list|(
name|UnRegisterNodeManagerResponse
operator|.
name|class
argument_list|)
return|;
block|}
block|}
comment|// Test NodeStatusUpdater sends the right container statuses each time it
comment|// heart beats.
DECL|field|expectedCredentials
specifier|private
name|Credentials
name|expectedCredentials
init|=
operator|new
name|Credentials
argument_list|()
decl_stmt|;
DECL|class|MyResourceTracker4
specifier|private
class|class
name|MyResourceTracker4
implements|implements
name|ResourceTracker
block|{
DECL|field|registerNodeAction
specifier|public
name|NodeAction
name|registerNodeAction
init|=
name|NodeAction
operator|.
name|NORMAL
decl_stmt|;
DECL|field|heartBeatNodeAction
specifier|public
name|NodeAction
name|heartBeatNodeAction
init|=
name|NodeAction
operator|.
name|NORMAL
decl_stmt|;
DECL|field|context
specifier|private
name|Context
name|context
decl_stmt|;
DECL|field|containerStatus2
specifier|private
specifier|final
name|ContainerStatus
name|containerStatus2
init|=
name|createContainerStatus
argument_list|(
literal|2
argument_list|,
name|ContainerState
operator|.
name|RUNNING
argument_list|)
decl_stmt|;
DECL|field|containerStatus3
specifier|private
specifier|final
name|ContainerStatus
name|containerStatus3
init|=
name|createContainerStatus
argument_list|(
literal|3
argument_list|,
name|ContainerState
operator|.
name|COMPLETE
argument_list|)
decl_stmt|;
DECL|field|containerStatus4
specifier|private
specifier|final
name|ContainerStatus
name|containerStatus4
init|=
name|createContainerStatus
argument_list|(
literal|4
argument_list|,
name|ContainerState
operator|.
name|RUNNING
argument_list|)
decl_stmt|;
DECL|field|containerStatus5
specifier|private
specifier|final
name|ContainerStatus
name|containerStatus5
init|=
name|createContainerStatus
argument_list|(
literal|5
argument_list|,
name|ContainerState
operator|.
name|COMPLETE
argument_list|)
decl_stmt|;
DECL|method|MyResourceTracker4 (Context context)
specifier|public
name|MyResourceTracker4
parameter_list|(
name|Context
name|context
parameter_list|)
block|{
comment|// create app Credentials
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|token
operator|.
name|Token
argument_list|<
name|DelegationTokenIdentifier
argument_list|>
name|token1
init|=
operator|new
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|token
operator|.
name|Token
argument_list|<
name|DelegationTokenIdentifier
argument_list|>
argument_list|()
decl_stmt|;
name|token1
operator|.
name|setKind
argument_list|(
operator|new
name|Text
argument_list|(
literal|"kind1"
argument_list|)
argument_list|)
expr_stmt|;
name|expectedCredentials
operator|.
name|addToken
argument_list|(
operator|new
name|Text
argument_list|(
literal|"token1"
argument_list|)
argument_list|,
name|token1
argument_list|)
expr_stmt|;
name|this
operator|.
name|context
operator|=
name|context
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|registerNodeManager ( RegisterNodeManagerRequest request)
specifier|public
name|RegisterNodeManagerResponse
name|registerNodeManager
parameter_list|(
name|RegisterNodeManagerRequest
name|request
parameter_list|)
throws|throws
name|YarnException
throws|,
name|IOException
block|{
name|RegisterNodeManagerResponse
name|response
init|=
name|recordFactory
operator|.
name|newRecordInstance
argument_list|(
name|RegisterNodeManagerResponse
operator|.
name|class
argument_list|)
decl_stmt|;
name|response
operator|.
name|setNodeAction
argument_list|(
name|registerNodeAction
argument_list|)
expr_stmt|;
name|response
operator|.
name|setContainerTokenMasterKey
argument_list|(
name|createMasterKey
argument_list|()
argument_list|)
expr_stmt|;
name|response
operator|.
name|setNMTokenMasterKey
argument_list|(
name|createMasterKey
argument_list|()
argument_list|)
expr_stmt|;
return|return
name|response
return|;
block|}
annotation|@
name|Override
DECL|method|nodeHeartbeat (NodeHeartbeatRequest request)
specifier|public
name|NodeHeartbeatResponse
name|nodeHeartbeat
parameter_list|(
name|NodeHeartbeatRequest
name|request
parameter_list|)
throws|throws
name|YarnException
throws|,
name|IOException
block|{
name|List
argument_list|<
name|ContainerId
argument_list|>
name|finishedContainersPulledByAM
init|=
operator|new
name|ArrayList
argument_list|<
name|ContainerId
argument_list|>
argument_list|()
decl_stmt|;
try|try
block|{
if|if
condition|(
name|heartBeatID
operator|==
literal|0
condition|)
block|{
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|0
argument_list|,
name|request
operator|.
name|getNodeStatus
argument_list|()
operator|.
name|getContainersStatuses
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|0
argument_list|,
name|context
operator|.
name|getContainers
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|heartBeatID
operator|==
literal|1
condition|)
block|{
name|List
argument_list|<
name|ContainerStatus
argument_list|>
name|statuses
init|=
name|request
operator|.
name|getNodeStatus
argument_list|()
operator|.
name|getContainersStatuses
argument_list|()
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|2
argument_list|,
name|statuses
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|2
argument_list|,
name|context
operator|.
name|getContainers
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|boolean
name|container2Exist
init|=
literal|false
decl_stmt|,
name|container3Exist
init|=
literal|false
decl_stmt|;
for|for
control|(
name|ContainerStatus
name|status
range|:
name|statuses
control|)
block|{
if|if
condition|(
name|status
operator|.
name|getContainerId
argument_list|()
operator|.
name|equals
argument_list|(
name|containerStatus2
operator|.
name|getContainerId
argument_list|()
argument_list|)
condition|)
block|{
name|Assert
operator|.
name|assertTrue
argument_list|(
name|status
operator|.
name|getState
argument_list|()
operator|.
name|equals
argument_list|(
name|containerStatus2
operator|.
name|getState
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|container2Exist
operator|=
literal|true
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|.
name|getContainerId
argument_list|()
operator|.
name|equals
argument_list|(
name|containerStatus3
operator|.
name|getContainerId
argument_list|()
argument_list|)
condition|)
block|{
name|Assert
operator|.
name|assertTrue
argument_list|(
name|status
operator|.
name|getState
argument_list|()
operator|.
name|equals
argument_list|(
name|containerStatus3
operator|.
name|getState
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|container3Exist
operator|=
literal|true
expr_stmt|;
block|}
block|}
name|Assert
operator|.
name|assertTrue
argument_list|(
name|container2Exist
operator|&&
name|container3Exist
argument_list|)
expr_stmt|;
comment|// should throw exception that can be retried by the
comment|// nodeStatusUpdaterRunnable, otherwise nm just shuts down and the
comment|// test passes.
throw|throw
operator|new
name|YarnRuntimeException
argument_list|(
literal|"Lost the heartbeat response"
argument_list|)
throw|;
block|}
elseif|else
if|if
condition|(
name|heartBeatID
operator|==
literal|2
operator|||
name|heartBeatID
operator|==
literal|3
condition|)
block|{
name|List
argument_list|<
name|ContainerStatus
argument_list|>
name|statuses
init|=
name|request
operator|.
name|getNodeStatus
argument_list|()
operator|.
name|getContainersStatuses
argument_list|()
decl_stmt|;
if|if
condition|(
name|heartBeatID
operator|==
literal|2
condition|)
block|{
comment|// NM should send completed containers again, since the last
comment|// heartbeat is lost.
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|4
argument_list|,
name|statuses
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// NM should not send completed containers again, since the last
comment|// heartbeat is successful.
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|2
argument_list|,
name|statuses
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|4
argument_list|,
name|context
operator|.
name|getContainers
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|boolean
name|container2Exist
init|=
literal|false
decl_stmt|,
name|container3Exist
init|=
literal|false
decl_stmt|,
name|container4Exist
init|=
literal|false
decl_stmt|,
name|container5Exist
init|=
literal|false
decl_stmt|;
for|for
control|(
name|ContainerStatus
name|status
range|:
name|statuses
control|)
block|{
if|if
condition|(
name|status
operator|.
name|getContainerId
argument_list|()
operator|.
name|equals
argument_list|(
name|containerStatus2
operator|.
name|getContainerId
argument_list|()
argument_list|)
condition|)
block|{
name|Assert
operator|.
name|assertTrue
argument_list|(
name|status
operator|.
name|getState
argument_list|()
operator|.
name|equals
argument_list|(
name|containerStatus2
operator|.
name|getState
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|container2Exist
operator|=
literal|true
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|.
name|getContainerId
argument_list|()
operator|.
name|equals
argument_list|(
name|containerStatus3
operator|.
name|getContainerId
argument_list|()
argument_list|)
condition|)
block|{
name|Assert
operator|.
name|assertTrue
argument_list|(
name|status
operator|.
name|getState
argument_list|()
operator|.
name|equals
argument_list|(
name|containerStatus3
operator|.
name|getState
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|container3Exist
operator|=
literal|true
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|.
name|getContainerId
argument_list|()
operator|.
name|equals
argument_list|(
name|containerStatus4
operator|.
name|getContainerId
argument_list|()
argument_list|)
condition|)
block|{
name|Assert
operator|.
name|assertTrue
argument_list|(
name|status
operator|.
name|getState
argument_list|()
operator|.
name|equals
argument_list|(
name|containerStatus4
operator|.
name|getState
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|container4Exist
operator|=
literal|true
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|.
name|getContainerId
argument_list|()
operator|.
name|equals
argument_list|(
name|containerStatus5
operator|.
name|getContainerId
argument_list|()
argument_list|)
condition|)
block|{
name|Assert
operator|.
name|assertTrue
argument_list|(
name|status
operator|.
name|getState
argument_list|()
operator|.
name|equals
argument_list|(
name|containerStatus5
operator|.
name|getState
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|container5Exist
operator|=
literal|true
expr_stmt|;
block|}
block|}
if|if
condition|(
name|heartBeatID
operator|==
literal|2
condition|)
block|{
name|Assert
operator|.
name|assertTrue
argument_list|(
name|container2Exist
operator|&&
name|container3Exist
operator|&&
name|container4Exist
operator|&&
name|container5Exist
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// NM do not send completed containers again
name|Assert
operator|.
name|assertTrue
argument_list|(
name|container2Exist
operator|&&
operator|!
name|container3Exist
operator|&&
name|container4Exist
operator|&&
operator|!
name|container5Exist
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|heartBeatID
operator|==
literal|3
condition|)
block|{
name|finishedContainersPulledByAM
operator|.
name|add
argument_list|(
name|containerStatus3
operator|.
name|getContainerId
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|heartBeatID
operator|==
literal|4
condition|)
block|{
name|List
argument_list|<
name|ContainerStatus
argument_list|>
name|statuses
init|=
name|request
operator|.
name|getNodeStatus
argument_list|()
operator|.
name|getContainersStatuses
argument_list|()
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|2
argument_list|,
name|statuses
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
comment|// Container 3 is acked by AM, hence removed from context
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|3
argument_list|,
name|context
operator|.
name|getContainers
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|boolean
name|container3Exist
init|=
literal|false
decl_stmt|;
for|for
control|(
name|ContainerStatus
name|status
range|:
name|statuses
control|)
block|{
if|if
condition|(
name|status
operator|.
name|getContainerId
argument_list|()
operator|.
name|equals
argument_list|(
name|containerStatus3
operator|.
name|getContainerId
argument_list|()
argument_list|)
condition|)
block|{
name|container3Exist
operator|=
literal|true
expr_stmt|;
block|}
block|}
name|Assert
operator|.
name|assertFalse
argument_list|(
name|container3Exist
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|AssertionError
name|error
parameter_list|)
block|{
name|error
operator|.
name|printStackTrace
argument_list|()
expr_stmt|;
name|assertionFailedInThread
operator|.
name|set
argument_list|(
literal|true
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|heartBeatID
operator|++
expr_stmt|;
block|}
name|NodeStatus
name|nodeStatus
init|=
name|request
operator|.
name|getNodeStatus
argument_list|()
decl_stmt|;
name|nodeStatus
operator|.
name|setResponseId
argument_list|(
name|heartBeatID
argument_list|)
expr_stmt|;
name|NodeHeartbeatResponse
name|nhResponse
init|=
name|YarnServerBuilderUtils
operator|.
name|newNodeHeartbeatResponse
argument_list|(
name|heartBeatID
argument_list|,
name|heartBeatNodeAction
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|1000L
argument_list|)
decl_stmt|;
name|nhResponse
operator|.
name|addContainersToBeRemovedFromNM
argument_list|(
name|finishedContainersPulledByAM
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|ApplicationId
argument_list|,
name|ByteBuffer
argument_list|>
name|appCredentials
init|=
operator|new
name|HashMap
argument_list|<
name|ApplicationId
argument_list|,
name|ByteBuffer
argument_list|>
argument_list|()
decl_stmt|;
name|DataOutputBuffer
name|dob
init|=
operator|new
name|DataOutputBuffer
argument_list|()
decl_stmt|;
name|expectedCredentials
operator|.
name|writeTokenStorageToStream
argument_list|(
name|dob
argument_list|)
expr_stmt|;
name|ByteBuffer
name|byteBuffer1
init|=
name|ByteBuffer
operator|.
name|wrap
argument_list|(
name|dob
operator|.
name|getData
argument_list|()
argument_list|,
literal|0
argument_list|,
name|dob
operator|.
name|getLength
argument_list|()
argument_list|)
decl_stmt|;
name|appCredentials
operator|.
name|put
argument_list|(
name|ApplicationId
operator|.
name|newInstance
argument_list|(
literal|1234
argument_list|,
literal|1
argument_list|)
argument_list|,
name|byteBuffer1
argument_list|)
expr_stmt|;
name|nhResponse
operator|.
name|setSystemCredentialsForApps
argument_list|(
name|appCredentials
argument_list|)
expr_stmt|;
return|return
name|nhResponse
return|;
block|}
annotation|@
name|Override
DECL|method|unRegisterNodeManager ( UnRegisterNodeManagerRequest request)
specifier|public
name|UnRegisterNodeManagerResponse
name|unRegisterNodeManager
parameter_list|(
name|UnRegisterNodeManagerRequest
name|request
parameter_list|)
throws|throws
name|YarnException
throws|,
name|IOException
block|{
return|return
name|recordFactory
operator|.
name|newRecordInstance
argument_list|(
name|UnRegisterNodeManagerResponse
operator|.
name|class
argument_list|)
return|;
block|}
block|}
DECL|class|MyResourceTracker5
specifier|private
class|class
name|MyResourceTracker5
implements|implements
name|ResourceTracker
block|{
DECL|field|registerNodeAction
specifier|public
name|NodeAction
name|registerNodeAction
init|=
name|NodeAction
operator|.
name|NORMAL
decl_stmt|;
annotation|@
name|Override
DECL|method|registerNodeManager ( RegisterNodeManagerRequest request)
specifier|public
name|RegisterNodeManagerResponse
name|registerNodeManager
parameter_list|(
name|RegisterNodeManagerRequest
name|request
parameter_list|)
throws|throws
name|YarnException
throws|,
name|IOException
block|{
name|RegisterNodeManagerResponse
name|response
init|=
name|recordFactory
operator|.
name|newRecordInstance
argument_list|(
name|RegisterNodeManagerResponse
operator|.
name|class
argument_list|)
decl_stmt|;
name|response
operator|.
name|setNodeAction
argument_list|(
name|registerNodeAction
argument_list|)
expr_stmt|;
name|response
operator|.
name|setContainerTokenMasterKey
argument_list|(
name|createMasterKey
argument_list|()
argument_list|)
expr_stmt|;
name|response
operator|.
name|setNMTokenMasterKey
argument_list|(
name|createMasterKey
argument_list|()
argument_list|)
expr_stmt|;
return|return
name|response
return|;
block|}
annotation|@
name|Override
DECL|method|nodeHeartbeat (NodeHeartbeatRequest request)
specifier|public
name|NodeHeartbeatResponse
name|nodeHeartbeat
parameter_list|(
name|NodeHeartbeatRequest
name|request
parameter_list|)
throws|throws
name|YarnException
throws|,
name|IOException
block|{
name|heartBeatID
operator|++
expr_stmt|;
if|if
condition|(
name|heartBeatID
operator|==
literal|1
condition|)
block|{
comment|// EOFException should be retried as well.
throw|throw
operator|new
name|EOFException
argument_list|(
literal|"NodeHeartbeat exception"
argument_list|)
throw|;
block|}
else|else
block|{
throw|throw
operator|new
name|java
operator|.
name|net
operator|.
name|ConnectException
argument_list|(
literal|"NodeHeartbeat exception"
argument_list|)
throw|;
block|}
block|}
annotation|@
name|Override
DECL|method|unRegisterNodeManager ( UnRegisterNodeManagerRequest request)
specifier|public
name|UnRegisterNodeManagerResponse
name|unRegisterNodeManager
parameter_list|(
name|UnRegisterNodeManagerRequest
name|request
parameter_list|)
throws|throws
name|YarnException
throws|,
name|IOException
block|{
return|return
name|recordFactory
operator|.
name|newRecordInstance
argument_list|(
name|UnRegisterNodeManagerResponse
operator|.
name|class
argument_list|)
return|;
block|}
block|}
DECL|class|MyResourceTracker6
specifier|private
class|class
name|MyResourceTracker6
implements|implements
name|ResourceTracker
block|{
DECL|field|rmStartIntervalMS
specifier|private
name|long
name|rmStartIntervalMS
decl_stmt|;
DECL|field|rmNeverStart
specifier|private
name|boolean
name|rmNeverStart
decl_stmt|;
DECL|field|waitStartTime
specifier|private
specifier|final
name|long
name|waitStartTime
decl_stmt|;
DECL|method|MyResourceTracker6 (long rmStartIntervalMS, boolean rmNeverStart)
specifier|public
name|MyResourceTracker6
parameter_list|(
name|long
name|rmStartIntervalMS
parameter_list|,
name|boolean
name|rmNeverStart
parameter_list|)
block|{
name|this
operator|.
name|rmStartIntervalMS
operator|=
name|rmStartIntervalMS
expr_stmt|;
name|this
operator|.
name|rmNeverStart
operator|=
name|rmNeverStart
expr_stmt|;
name|this
operator|.
name|waitStartTime
operator|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|registerNodeManager ( RegisterNodeManagerRequest request)
specifier|public
name|RegisterNodeManagerResponse
name|registerNodeManager
parameter_list|(
name|RegisterNodeManagerRequest
name|request
parameter_list|)
throws|throws
name|YarnException
throws|,
name|IOException
throws|,
name|IOException
block|{
if|if
condition|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|waitStartTime
operator|<=
name|rmStartIntervalMS
operator|||
name|rmNeverStart
condition|)
block|{
throw|throw
operator|new
name|java
operator|.
name|net
operator|.
name|ConnectException
argument_list|(
literal|"Faking RM start failure as start "
operator|+
literal|"delay timer has not expired."
argument_list|)
throw|;
block|}
else|else
block|{
name|NodeId
name|nodeId
init|=
name|request
operator|.
name|getNodeId
argument_list|()
decl_stmt|;
name|Resource
name|resource
init|=
name|request
operator|.
name|getResource
argument_list|()
decl_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Registering "
operator|+
name|nodeId
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
comment|// NOTE: this really should be checking against the config value
name|InetSocketAddress
name|expected
init|=
name|NetUtils
operator|.
name|getConnectAddress
argument_list|(
name|conf
operator|.
name|getSocketAddr
argument_list|(
name|YarnConfiguration
operator|.
name|NM_ADDRESS
argument_list|,
literal|null
argument_list|,
operator|-
literal|1
argument_list|)
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
name|NetUtils
operator|.
name|getHostPortString
argument_list|(
name|expected
argument_list|)
argument_list|,
name|nodeId
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|5
operator|*
literal|1024
argument_list|,
name|resource
operator|.
name|getMemorySize
argument_list|()
argument_list|)
expr_stmt|;
name|registeredNodes
operator|.
name|add
argument_list|(
name|nodeId
argument_list|)
expr_stmt|;
name|RegisterNodeManagerResponse
name|response
init|=
name|recordFactory
operator|.
name|newRecordInstance
argument_list|(
name|RegisterNodeManagerResponse
operator|.
name|class
argument_list|)
decl_stmt|;
name|triggered
operator|=
literal|true
expr_stmt|;
return|return
name|response
return|;
block|}
block|}
annotation|@
name|Override
DECL|method|nodeHeartbeat (NodeHeartbeatRequest request)
specifier|public
name|NodeHeartbeatResponse
name|nodeHeartbeat
parameter_list|(
name|NodeHeartbeatRequest
name|request
parameter_list|)
throws|throws
name|YarnException
throws|,
name|IOException
block|{
name|NodeStatus
name|nodeStatus
init|=
name|request
operator|.
name|getNodeStatus
argument_list|()
decl_stmt|;
name|nodeStatus
operator|.
name|setResponseId
argument_list|(
name|heartBeatID
operator|++
argument_list|)
expr_stmt|;
name|NodeHeartbeatResponse
name|nhResponse
init|=
name|YarnServerBuilderUtils
operator|.
name|newNodeHeartbeatResponse
argument_list|(
name|heartBeatID
argument_list|,
name|NodeAction
operator|.
name|NORMAL
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|1000L
argument_list|)
decl_stmt|;
return|return
name|nhResponse
return|;
block|}
annotation|@
name|Override
DECL|method|unRegisterNodeManager ( UnRegisterNodeManagerRequest request)
specifier|public
name|UnRegisterNodeManagerResponse
name|unRegisterNodeManager
parameter_list|(
name|UnRegisterNodeManagerRequest
name|request
parameter_list|)
throws|throws
name|YarnException
throws|,
name|IOException
block|{
return|return
name|recordFactory
operator|.
name|newRecordInstance
argument_list|(
name|UnRegisterNodeManagerResponse
operator|.
name|class
argument_list|)
return|;
block|}
block|}
annotation|@
name|Before
DECL|method|clearError ()
specifier|public
name|void
name|clearError
parameter_list|()
block|{
name|nmStartError
operator|=
literal|null
expr_stmt|;
block|}
annotation|@
name|After
DECL|method|deleteBaseDir ()
specifier|public
name|void
name|deleteBaseDir
parameter_list|()
throws|throws
name|IOException
block|{
name|FileContext
name|lfs
init|=
name|FileContext
operator|.
name|getLocalFSFileContext
argument_list|()
decl_stmt|;
name|lfs
operator|.
name|delete
argument_list|(
operator|new
name|Path
argument_list|(
name|basedir
operator|.
name|getPath
argument_list|()
argument_list|)
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
argument_list|(
name|timeout
operator|=
literal|90000
argument_list|)
DECL|method|testRecentlyFinishedContainers ()
specifier|public
name|void
name|testRecentlyFinishedContainers
parameter_list|()
throws|throws
name|Exception
block|{
name|NodeManager
name|nm
init|=
operator|new
name|NodeManager
argument_list|()
decl_stmt|;
name|YarnConfiguration
name|conf
init|=
operator|new
name|YarnConfiguration
argument_list|()
decl_stmt|;
name|conf
operator|.
name|set
argument_list|(
name|NodeStatusUpdaterImpl
operator|.
name|YARN_NODEMANAGER_DURATION_TO_TRACK_STOPPED_CONTAINERS
argument_list|,
literal|"10000"
argument_list|)
expr_stmt|;
name|nm
operator|.
name|init
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|NodeStatusUpdaterImpl
name|nodeStatusUpdater
init|=
operator|(
name|NodeStatusUpdaterImpl
operator|)
name|nm
operator|.
name|getNodeStatusUpdater
argument_list|()
decl_stmt|;
name|ApplicationId
name|appId
init|=
name|ApplicationId
operator|.
name|newInstance
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|ApplicationAttemptId
name|appAttemptId
init|=
name|ApplicationAttemptId
operator|.
name|newInstance
argument_list|(
name|appId
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|ContainerId
name|cId
init|=
name|ContainerId
operator|.
name|newContainerId
argument_list|(
name|appAttemptId
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|nm
operator|.
name|getNMContext
argument_list|()
operator|.
name|getApplications
argument_list|()
operator|.
name|putIfAbsent
argument_list|(
name|appId
argument_list|,
name|mock
argument_list|(
name|Application
operator|.
name|class
argument_list|)
argument_list|)
expr_stmt|;
name|nm
operator|.
name|getNMContext
argument_list|()
operator|.
name|getContainers
argument_list|()
operator|.
name|putIfAbsent
argument_list|(
name|cId
argument_list|,
name|mock
argument_list|(
name|Container
operator|.
name|class
argument_list|)
argument_list|)
expr_stmt|;
name|nodeStatusUpdater
operator|.
name|addCompletedContainer
argument_list|(
name|cId
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
name|nodeStatusUpdater
operator|.
name|isContainerRecentlyStopped
argument_list|(
name|cId
argument_list|)
argument_list|)
expr_stmt|;
name|nm
operator|.
name|getNMContext
argument_list|()
operator|.
name|getContainers
argument_list|()
operator|.
name|remove
argument_list|(
name|cId
argument_list|)
expr_stmt|;
name|long
name|time1
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|int
name|waitInterval
init|=
literal|15
decl_stmt|;
while|while
condition|(
name|waitInterval
operator|--
operator|>
literal|0
operator|&&
name|nodeStatusUpdater
operator|.
name|isContainerRecentlyStopped
argument_list|(
name|cId
argument_list|)
condition|)
block|{
name|nodeStatusUpdater
operator|.
name|removeVeryOldStoppedContainersFromCache
argument_list|()
expr_stmt|;
name|Thread
operator|.
name|sleep
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
name|long
name|time2
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
comment|// By this time the container will be removed from cache. need to verify.
name|Assert
operator|.
name|assertFalse
argument_list|(
name|nodeStatusUpdater
operator|.
name|isContainerRecentlyStopped
argument_list|(
name|cId
argument_list|)
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
operator|(
name|time2
operator|-
name|time1
operator|)
operator|>=
literal|10000
operator|&&
operator|(
name|time2
operator|-
name|time1
operator|)
operator|<=
literal|250000
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
argument_list|(
name|timeout
operator|=
literal|90000
argument_list|)
DECL|method|testRemovePreviousCompletedContainersFromContext ()
specifier|public
name|void
name|testRemovePreviousCompletedContainersFromContext
parameter_list|()
throws|throws
name|Exception
block|{
name|NodeManager
name|nm
init|=
operator|new
name|NodeManager
argument_list|()
decl_stmt|;
name|YarnConfiguration
name|conf
init|=
operator|new
name|YarnConfiguration
argument_list|()
decl_stmt|;
name|conf
operator|.
name|set
argument_list|(
name|NodeStatusUpdaterImpl
operator|.
name|YARN_NODEMANAGER_DURATION_TO_TRACK_STOPPED_CONTAINERS
argument_list|,
literal|"10000"
argument_list|)
expr_stmt|;
name|nm
operator|.
name|init
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|NodeStatusUpdaterImpl
name|nodeStatusUpdater
init|=
operator|(
name|NodeStatusUpdaterImpl
operator|)
name|nm
operator|.
name|getNodeStatusUpdater
argument_list|()
decl_stmt|;
name|ApplicationId
name|appId
init|=
name|ApplicationId
operator|.
name|newInstance
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|ApplicationAttemptId
name|appAttemptId
init|=
name|ApplicationAttemptId
operator|.
name|newInstance
argument_list|(
name|appId
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|ContainerId
name|cId
init|=
name|ContainerId
operator|.
name|newContainerId
argument_list|(
name|appAttemptId
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|Token
name|containerToken
init|=
name|BuilderUtils
operator|.
name|newContainerToken
argument_list|(
name|cId
argument_list|,
literal|0
argument_list|,
literal|"anyHost"
argument_list|,
literal|1234
argument_list|,
literal|"anyUser"
argument_list|,
name|BuilderUtils
operator|.
name|newResource
argument_list|(
literal|1024
argument_list|,
literal|1
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|123
argument_list|,
literal|"password"
operator|.
name|getBytes
argument_list|()
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|Container
name|anyCompletedContainer
init|=
operator|new
name|ContainerImpl
argument_list|(
name|conf
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
name|BuilderUtils
operator|.
name|newContainerTokenIdentifier
argument_list|(
name|containerToken
argument_list|)
argument_list|,
name|nm
operator|.
name|getNMContext
argument_list|()
argument_list|)
block|{
annotation|@
name|Override
specifier|public
name|ContainerState
name|getCurrentState
parameter_list|()
block|{
return|return
name|ContainerState
operator|.
name|COMPLETE
return|;
block|}
annotation|@
name|Override
specifier|public
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|containermanager
operator|.
name|container
operator|.
name|ContainerState
name|getContainerState
parameter_list|()
block|{
return|return
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|containermanager
operator|.
name|container
operator|.
name|ContainerState
operator|.
name|DONE
return|;
block|}
block|}
decl_stmt|;
name|ContainerId
name|runningContainerId
init|=
name|ContainerId
operator|.
name|newContainerId
argument_list|(
name|appAttemptId
argument_list|,
literal|3
argument_list|)
decl_stmt|;
name|Token
name|runningContainerToken
init|=
name|BuilderUtils
operator|.
name|newContainerToken
argument_list|(
name|runningContainerId
argument_list|,
literal|0
argument_list|,
literal|"anyHost"
argument_list|,
literal|1234
argument_list|,
literal|"anyUser"
argument_list|,
name|BuilderUtils
operator|.
name|newResource
argument_list|(
literal|1024
argument_list|,
literal|1
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|123
argument_list|,
literal|"password"
operator|.
name|getBytes
argument_list|()
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|Container
name|runningContainer
init|=
operator|new
name|ContainerImpl
argument_list|(
name|conf
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
name|BuilderUtils
operator|.
name|newContainerTokenIdentifier
argument_list|(
name|runningContainerToken
argument_list|)
argument_list|,
name|nm
operator|.
name|getNMContext
argument_list|()
argument_list|)
block|{
annotation|@
name|Override
specifier|public
name|ContainerState
name|getCurrentState
parameter_list|()
block|{
return|return
name|ContainerState
operator|.
name|RUNNING
return|;
block|}
annotation|@
name|Override
specifier|public
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|containermanager
operator|.
name|container
operator|.
name|ContainerState
name|getContainerState
parameter_list|()
block|{
return|return
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|containermanager
operator|.
name|container
operator|.
name|ContainerState
operator|.
name|RUNNING
return|;
block|}
block|}
decl_stmt|;
name|nm
operator|.
name|getNMContext
argument_list|()
operator|.
name|getApplications
argument_list|()
operator|.
name|putIfAbsent
argument_list|(
name|appId
argument_list|,
name|mock
argument_list|(
name|Application
operator|.
name|class
argument_list|)
argument_list|)
expr_stmt|;
name|nm
operator|.
name|getNMContext
argument_list|()
operator|.
name|getContainers
argument_list|()
operator|.
name|put
argument_list|(
name|cId
argument_list|,
name|anyCompletedContainer
argument_list|)
expr_stmt|;
name|nm
operator|.
name|getNMContext
argument_list|()
operator|.
name|getContainers
argument_list|()
operator|.
name|put
argument_list|(
name|runningContainerId
argument_list|,
name|runningContainer
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|2
argument_list|,
name|nodeStatusUpdater
operator|.
name|getContainerStatuses
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|ContainerId
argument_list|>
name|ackedContainers
init|=
operator|new
name|ArrayList
argument_list|<
name|ContainerId
argument_list|>
argument_list|()
decl_stmt|;
name|ackedContainers
operator|.
name|add
argument_list|(
name|cId
argument_list|)
expr_stmt|;
name|ackedContainers
operator|.
name|add
argument_list|(
name|runningContainerId
argument_list|)
expr_stmt|;
name|nodeStatusUpdater
operator|.
name|removeOrTrackCompletedContainersFromContext
argument_list|(
name|ackedContainers
argument_list|)
expr_stmt|;
name|Set
argument_list|<
name|ContainerId
argument_list|>
name|containerIdSet
init|=
operator|new
name|HashSet
argument_list|<
name|ContainerId
argument_list|>
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|ContainerStatus
argument_list|>
name|containerStatuses
init|=
name|nodeStatusUpdater
operator|.
name|getContainerStatuses
argument_list|()
decl_stmt|;
for|for
control|(
name|ContainerStatus
name|status
range|:
name|containerStatuses
control|)
block|{
name|containerIdSet
operator|.
name|add
argument_list|(
name|status
operator|.
name|getContainerId
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|containerStatuses
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
comment|// completed container is removed;
name|Assert
operator|.
name|assertFalse
argument_list|(
name|containerIdSet
operator|.
name|contains
argument_list|(
name|cId
argument_list|)
argument_list|)
expr_stmt|;
comment|// running container is not removed;
name|Assert
operator|.
name|assertTrue
argument_list|(
name|containerIdSet
operator|.
name|contains
argument_list|(
name|runningContainerId
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
argument_list|(
name|timeout
operator|=
literal|10000
argument_list|)
DECL|method|testCompletedContainersIsRecentlyStopped ()
specifier|public
name|void
name|testCompletedContainersIsRecentlyStopped
parameter_list|()
throws|throws
name|Exception
block|{
name|NodeManager
name|nm
init|=
operator|new
name|NodeManager
argument_list|()
decl_stmt|;
name|nm
operator|.
name|init
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|NodeStatusUpdaterImpl
name|nodeStatusUpdater
init|=
operator|(
name|NodeStatusUpdaterImpl
operator|)
name|nm
operator|.
name|getNodeStatusUpdater
argument_list|()
decl_stmt|;
name|ApplicationId
name|appId
init|=
name|ApplicationId
operator|.
name|newInstance
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|Application
name|completedApp
init|=
name|mock
argument_list|(
name|Application
operator|.
name|class
argument_list|)
decl_stmt|;
name|when
argument_list|(
name|completedApp
operator|.
name|getApplicationState
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|ApplicationState
operator|.
name|FINISHED
argument_list|)
expr_stmt|;
name|ApplicationAttemptId
name|appAttemptId
init|=
name|ApplicationAttemptId
operator|.
name|newInstance
argument_list|(
name|appId
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|ContainerId
name|containerId
init|=
name|ContainerId
operator|.
name|newContainerId
argument_list|(
name|appAttemptId
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|Token
name|containerToken
init|=
name|BuilderUtils
operator|.
name|newContainerToken
argument_list|(
name|containerId
argument_list|,
literal|0
argument_list|,
literal|"host"
argument_list|,
literal|1234
argument_list|,
literal|"user"
argument_list|,
name|BuilderUtils
operator|.
name|newResource
argument_list|(
literal|1024
argument_list|,
literal|1
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|123
argument_list|,
literal|"password"
operator|.
name|getBytes
argument_list|()
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|Container
name|completedContainer
init|=
operator|new
name|ContainerImpl
argument_list|(
name|conf
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
name|BuilderUtils
operator|.
name|newContainerTokenIdentifier
argument_list|(
name|containerToken
argument_list|)
argument_list|,
name|nm
operator|.
name|getNMContext
argument_list|()
argument_list|)
block|{
annotation|@
name|Override
specifier|public
name|ContainerState
name|getCurrentState
parameter_list|()
block|{
return|return
name|ContainerState
operator|.
name|COMPLETE
return|;
block|}
block|}
decl_stmt|;
name|nm
operator|.
name|getNMContext
argument_list|()
operator|.
name|getApplications
argument_list|()
operator|.
name|putIfAbsent
argument_list|(
name|appId
argument_list|,
name|completedApp
argument_list|)
expr_stmt|;
name|nm
operator|.
name|getNMContext
argument_list|()
operator|.
name|getContainers
argument_list|()
operator|.
name|put
argument_list|(
name|containerId
argument_list|,
name|completedContainer
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|nodeStatusUpdater
operator|.
name|getContainerStatuses
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
name|nodeStatusUpdater
operator|.
name|isContainerRecentlyStopped
argument_list|(
name|containerId
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testCleanedupApplicationContainerCleanup ()
specifier|public
name|void
name|testCleanedupApplicationContainerCleanup
parameter_list|()
throws|throws
name|IOException
block|{
name|NodeManager
name|nm
init|=
operator|new
name|NodeManager
argument_list|()
decl_stmt|;
name|YarnConfiguration
name|conf
init|=
operator|new
name|YarnConfiguration
argument_list|()
decl_stmt|;
name|conf
operator|.
name|set
argument_list|(
name|NodeStatusUpdaterImpl
operator|.
name|YARN_NODEMANAGER_DURATION_TO_TRACK_STOPPED_CONTAINERS
argument_list|,
literal|"1000000"
argument_list|)
expr_stmt|;
name|nm
operator|.
name|init
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|NodeStatusUpdaterImpl
name|nodeStatusUpdater
init|=
operator|(
name|NodeStatusUpdaterImpl
operator|)
name|nm
operator|.
name|getNodeStatusUpdater
argument_list|()
decl_stmt|;
name|ApplicationId
name|appId
init|=
name|ApplicationId
operator|.
name|newInstance
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|ApplicationAttemptId
name|appAttemptId
init|=
name|ApplicationAttemptId
operator|.
name|newInstance
argument_list|(
name|appId
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|ContainerId
name|cId
init|=
name|ContainerId
operator|.
name|newContainerId
argument_list|(
name|appAttemptId
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|Token
name|containerToken
init|=
name|BuilderUtils
operator|.
name|newContainerToken
argument_list|(
name|cId
argument_list|,
literal|0
argument_list|,
literal|"anyHost"
argument_list|,
literal|1234
argument_list|,
literal|"anyUser"
argument_list|,
name|BuilderUtils
operator|.
name|newResource
argument_list|(
literal|1024
argument_list|,
literal|1
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|123
argument_list|,
literal|"password"
operator|.
name|getBytes
argument_list|()
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|Container
name|anyCompletedContainer
init|=
operator|new
name|ContainerImpl
argument_list|(
name|conf
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
name|BuilderUtils
operator|.
name|newContainerTokenIdentifier
argument_list|(
name|containerToken
argument_list|)
argument_list|,
name|nm
operator|.
name|getNMContext
argument_list|()
argument_list|)
block|{
annotation|@
name|Override
specifier|public
name|ContainerState
name|getCurrentState
parameter_list|()
block|{
return|return
name|ContainerState
operator|.
name|COMPLETE
return|;
block|}
block|}
decl_stmt|;
name|Application
name|application
init|=
name|mock
argument_list|(
name|Application
operator|.
name|class
argument_list|)
decl_stmt|;
name|when
argument_list|(
name|application
operator|.
name|getApplicationState
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|ApplicationState
operator|.
name|RUNNING
argument_list|)
expr_stmt|;
name|nm
operator|.
name|getNMContext
argument_list|()
operator|.
name|getApplications
argument_list|()
operator|.
name|putIfAbsent
argument_list|(
name|appId
argument_list|,
name|application
argument_list|)
expr_stmt|;
name|nm
operator|.
name|getNMContext
argument_list|()
operator|.
name|getContainers
argument_list|()
operator|.
name|put
argument_list|(
name|cId
argument_list|,
name|anyCompletedContainer
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|nodeStatusUpdater
operator|.
name|getContainerStatuses
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|when
argument_list|(
name|application
operator|.
name|getApplicationState
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|ApplicationState
operator|.
name|FINISHING_CONTAINERS_WAIT
argument_list|)
expr_stmt|;
comment|// The completed container will be saved in case of lost heartbeat.
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|nodeStatusUpdater
operator|.
name|getContainerStatuses
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|nodeStatusUpdater
operator|.
name|getContainerStatuses
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|nm
operator|.
name|getNMContext
argument_list|()
operator|.
name|getContainers
argument_list|()
operator|.
name|put
argument_list|(
name|cId
argument_list|,
name|anyCompletedContainer
argument_list|)
expr_stmt|;
name|nm
operator|.
name|getNMContext
argument_list|()
operator|.
name|getApplications
argument_list|()
operator|.
name|remove
argument_list|(
name|appId
argument_list|)
expr_stmt|;
comment|// The completed container will be saved in case of lost heartbeat.
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|nodeStatusUpdater
operator|.
name|getContainerStatuses
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|nodeStatusUpdater
operator|.
name|getContainerStatuses
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testNMRegistration ()
specifier|public
name|void
name|testNMRegistration
parameter_list|()
throws|throws
name|InterruptedException
throws|,
name|IOException
block|{
name|nm
operator|=
operator|new
name|NodeManager
argument_list|()
block|{
annotation|@
name|Override
specifier|protected
name|NodeStatusUpdater
name|createNodeStatusUpdater
parameter_list|(
name|Context
name|context
parameter_list|,
name|Dispatcher
name|dispatcher
parameter_list|,
name|NodeHealthCheckerService
name|healthChecker
parameter_list|)
block|{
return|return
operator|new
name|MyNodeStatusUpdater
argument_list|(
name|context
argument_list|,
name|dispatcher
argument_list|,
name|healthChecker
argument_list|,
name|metrics
argument_list|)
return|;
block|}
block|}
expr_stmt|;
name|YarnConfiguration
name|conf
init|=
name|createNMConfig
argument_list|()
decl_stmt|;
name|nm
operator|.
name|init
argument_list|(
name|conf
argument_list|)
expr_stmt|;
comment|// verify that the last service is the nodeStatusUpdater (ie registration
comment|// with RM)
name|Object
index|[]
name|services
init|=
name|nm
operator|.
name|getServices
argument_list|()
operator|.
name|toArray
argument_list|()
decl_stmt|;
name|Object
name|lastService
init|=
name|services
index|[
name|services
operator|.
name|length
operator|-
literal|1
index|]
decl_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
literal|"last service is NOT the node status updater"
argument_list|,
name|lastService
operator|instanceof
name|NodeStatusUpdater
argument_list|)
expr_stmt|;
operator|new
name|Thread
argument_list|()
block|{
specifier|public
name|void
name|run
parameter_list|()
block|{
try|try
block|{
name|nm
operator|.
name|start
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
name|TestNodeStatusUpdater
operator|.
name|this
operator|.
name|nmStartError
operator|=
name|e
expr_stmt|;
throw|throw
operator|new
name|YarnRuntimeException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
block|}
operator|.
name|start
argument_list|()
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|" ----- thread already started.."
operator|+
name|nm
operator|.
name|getServiceState
argument_list|()
argument_list|)
expr_stmt|;
name|int
name|waitCount
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|nm
operator|.
name|getServiceState
argument_list|()
operator|==
name|STATE
operator|.
name|INITED
operator|&&
name|waitCount
operator|++
operator|!=
literal|50
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Waiting for NM to start.."
argument_list|)
expr_stmt|;
if|if
condition|(
name|nmStartError
operator|!=
literal|null
condition|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Error during startup. "
argument_list|,
name|nmStartError
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|fail
argument_list|(
name|nmStartError
operator|.
name|getCause
argument_list|()
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|Thread
operator|.
name|sleep
argument_list|(
literal|2000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nm
operator|.
name|getServiceState
argument_list|()
operator|!=
name|STATE
operator|.
name|STARTED
condition|)
block|{
comment|// NM could have failed.
name|Assert
operator|.
name|fail
argument_list|(
literal|"NodeManager failed to start"
argument_list|)
expr_stmt|;
block|}
name|waitCount
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|heartBeatID
operator|<=
literal|3
operator|&&
name|waitCount
operator|++
operator|!=
literal|200
condition|)
block|{
name|Thread
operator|.
name|sleep
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
name|Assert
operator|.
name|assertFalse
argument_list|(
name|heartBeatID
operator|<=
literal|3
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Number of registered NMs is wrong!!"
argument_list|,
literal|1
argument_list|,
name|this
operator|.
name|registeredNodes
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|nm
operator|.
name|stop
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testStopReentrant ()
specifier|public
name|void
name|testStopReentrant
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|AtomicInteger
name|numCleanups
init|=
operator|new
name|AtomicInteger
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|nm
operator|=
operator|new
name|NodeManager
argument_list|()
block|{
annotation|@
name|Override
specifier|protected
name|NodeStatusUpdater
name|createNodeStatusUpdater
parameter_list|(
name|Context
name|context
parameter_list|,
name|Dispatcher
name|dispatcher
parameter_list|,
name|NodeHealthCheckerService
name|healthChecker
parameter_list|)
block|{
name|MyNodeStatusUpdater
name|myNodeStatusUpdater
init|=
operator|new
name|MyNodeStatusUpdater
argument_list|(
name|context
argument_list|,
name|dispatcher
argument_list|,
name|healthChecker
argument_list|,
name|metrics
argument_list|)
decl_stmt|;
name|MyResourceTracker2
name|myResourceTracker2
init|=
operator|new
name|MyResourceTracker2
argument_list|()
decl_stmt|;
name|myResourceTracker2
operator|.
name|heartBeatNodeAction
operator|=
name|NodeAction
operator|.
name|SHUTDOWN
expr_stmt|;
name|myNodeStatusUpdater
operator|.
name|resourceTracker
operator|=
name|myResourceTracker2
expr_stmt|;
return|return
name|myNodeStatusUpdater
return|;
block|}
annotation|@
name|Override
specifier|protected
name|ContainerManagerImpl
name|createContainerManager
parameter_list|(
name|Context
name|context
parameter_list|,
name|ContainerExecutor
name|exec
parameter_list|,
name|DeletionService
name|del
parameter_list|,
name|NodeStatusUpdater
name|nodeStatusUpdater
parameter_list|,
name|ApplicationACLsManager
name|aclsManager
parameter_list|,
name|LocalDirsHandlerService
name|dirsHandler
parameter_list|)
block|{
return|return
operator|new
name|ContainerManagerImpl
argument_list|(
name|context
argument_list|,
name|exec
argument_list|,
name|del
argument_list|,
name|nodeStatusUpdater
argument_list|,
name|metrics
argument_list|,
name|dirsHandler
argument_list|)
block|{
annotation|@
name|Override
specifier|public
name|void
name|cleanUpApplicationsOnNMShutDown
parameter_list|()
block|{
name|super
operator|.
name|cleanUpApplicationsOnNMShutDown
argument_list|()
expr_stmt|;
name|numCleanups
operator|.
name|incrementAndGet
argument_list|()
expr_stmt|;
block|}
block|}
return|;
block|}
block|}
expr_stmt|;
name|YarnConfiguration
name|conf
init|=
name|createNMConfig
argument_list|()
decl_stmt|;
name|nm
operator|.
name|init
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|nm
operator|.
name|start
argument_list|()
expr_stmt|;
name|int
name|waitCount
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|heartBeatID
operator|<
literal|1
operator|&&
name|waitCount
operator|++
operator|!=
literal|200
condition|)
block|{
name|Thread
operator|.
name|sleep
argument_list|(
literal|500
argument_list|)
expr_stmt|;
block|}
name|Assert
operator|.
name|assertFalse
argument_list|(
name|heartBeatID
operator|<
literal|1
argument_list|)
expr_stmt|;
comment|// Meanwhile call stop directly as the shutdown hook would
name|nm
operator|.
name|stop
argument_list|()
expr_stmt|;
comment|// NM takes a while to reach the STOPPED state.
name|waitCount
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|nm
operator|.
name|getServiceState
argument_list|()
operator|!=
name|STATE
operator|.
name|STOPPED
operator|&&
name|waitCount
operator|++
operator|!=
literal|20
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Waiting for NM to stop.."
argument_list|)
expr_stmt|;
name|Thread
operator|.
name|sleep
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
name|Assert
operator|.
name|assertEquals
argument_list|(
name|STATE
operator|.
name|STOPPED
argument_list|,
name|nm
operator|.
name|getServiceState
argument_list|()
argument_list|)
expr_stmt|;
comment|// It further takes a while after NM reached the STOPPED state.
name|waitCount
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|numCleanups
operator|.
name|get
argument_list|()
operator|==
literal|0
operator|&&
name|waitCount
operator|++
operator|!=
literal|20
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Waiting for NM shutdown.."
argument_list|)
expr_stmt|;
name|Thread
operator|.
name|sleep
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|numCleanups
operator|.
name|get
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testNodeDecommision ()
specifier|public
name|void
name|testNodeDecommision
parameter_list|()
throws|throws
name|Exception
block|{
name|nm
operator|=
name|getNodeManager
argument_list|(
name|NodeAction
operator|.
name|SHUTDOWN
argument_list|)
expr_stmt|;
name|YarnConfiguration
name|conf
init|=
name|createNMConfig
argument_list|()
decl_stmt|;
name|nm
operator|.
name|init
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
name|STATE
operator|.
name|INITED
argument_list|,
name|nm
operator|.
name|getServiceState
argument_list|()
argument_list|)
expr_stmt|;
name|nm
operator|.
name|start
argument_list|()
expr_stmt|;
name|int
name|waitCount
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|heartBeatID
operator|<
literal|1
operator|&&
name|waitCount
operator|++
operator|!=
literal|200
condition|)
block|{
name|Thread
operator|.
name|sleep
argument_list|(
literal|500
argument_list|)
expr_stmt|;
block|}
name|Assert
operator|.
name|assertFalse
argument_list|(
name|heartBeatID
operator|<
literal|1
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
name|nm
operator|.
name|getNMContext
argument_list|()
operator|.
name|getDecommissioned
argument_list|()
argument_list|)
expr_stmt|;
comment|// NM takes a while to reach the STOPPED state.
name|waitCount
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|nm
operator|.
name|getServiceState
argument_list|()
operator|!=
name|STATE
operator|.
name|STOPPED
operator|&&
name|waitCount
operator|++
operator|!=
literal|20
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Waiting for NM to stop.."
argument_list|)
expr_stmt|;
name|Thread
operator|.
name|sleep
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
name|Assert
operator|.
name|assertEquals
argument_list|(
name|STATE
operator|.
name|STOPPED
argument_list|,
name|nm
operator|.
name|getServiceState
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|class|NodeManagerWithCustomNodeStatusUpdater
specifier|private
specifier|abstract
class|class
name|NodeManagerWithCustomNodeStatusUpdater
extends|extends
name|NodeManager
block|{
DECL|field|updater
specifier|private
name|NodeStatusUpdater
name|updater
decl_stmt|;
DECL|method|NodeManagerWithCustomNodeStatusUpdater ()
specifier|private
name|NodeManagerWithCustomNodeStatusUpdater
parameter_list|()
block|{     }
annotation|@
name|Override
DECL|method|createNodeStatusUpdater (Context context, Dispatcher dispatcher, NodeHealthCheckerService healthChecker)
specifier|protected
name|NodeStatusUpdater
name|createNodeStatusUpdater
parameter_list|(
name|Context
name|context
parameter_list|,
name|Dispatcher
name|dispatcher
parameter_list|,
name|NodeHealthCheckerService
name|healthChecker
parameter_list|)
block|{
name|updater
operator|=
name|createUpdater
argument_list|(
name|context
argument_list|,
name|dispatcher
argument_list|,
name|healthChecker
argument_list|)
expr_stmt|;
return|return
name|updater
return|;
block|}
DECL|method|getUpdater ()
specifier|public
name|NodeStatusUpdater
name|getUpdater
parameter_list|()
block|{
return|return
name|updater
return|;
block|}
DECL|method|createUpdater (Context context, Dispatcher dispatcher, NodeHealthCheckerService healthChecker)
specifier|abstract
name|NodeStatusUpdater
name|createUpdater
parameter_list|(
name|Context
name|context
parameter_list|,
name|Dispatcher
name|dispatcher
parameter_list|,
name|NodeHealthCheckerService
name|healthChecker
parameter_list|)
function_decl|;
block|}
annotation|@
name|Test
DECL|method|testNMShutdownForRegistrationFailure ()
specifier|public
name|void
name|testNMShutdownForRegistrationFailure
parameter_list|()
throws|throws
name|Exception
block|{
name|nm
operator|=
operator|new
name|NodeManagerWithCustomNodeStatusUpdater
argument_list|()
block|{
annotation|@
name|Override
specifier|protected
name|NodeStatusUpdater
name|createUpdater
parameter_list|(
name|Context
name|context
parameter_list|,
name|Dispatcher
name|dispatcher
parameter_list|,
name|NodeHealthCheckerService
name|healthChecker
parameter_list|)
block|{
name|MyNodeStatusUpdater
name|nodeStatusUpdater
init|=
operator|new
name|MyNodeStatusUpdater
argument_list|(
name|context
argument_list|,
name|dispatcher
argument_list|,
name|healthChecker
argument_list|,
name|metrics
argument_list|)
decl_stmt|;
name|MyResourceTracker2
name|myResourceTracker2
init|=
operator|new
name|MyResourceTracker2
argument_list|()
decl_stmt|;
name|myResourceTracker2
operator|.
name|registerNodeAction
operator|=
name|NodeAction
operator|.
name|SHUTDOWN
expr_stmt|;
name|myResourceTracker2
operator|.
name|shutDownMessage
operator|=
literal|"RM Shutting Down Node"
expr_stmt|;
name|nodeStatusUpdater
operator|.
name|resourceTracker
operator|=
name|myResourceTracker2
expr_stmt|;
return|return
name|nodeStatusUpdater
return|;
block|}
block|}
expr_stmt|;
name|verifyNodeStartFailure
argument_list|(
literal|"Received SHUTDOWN signal from Resourcemanager, "
operator|+
literal|"Registration of NodeManager failed, "
operator|+
literal|"Message from ResourceManager: RM Shutting Down Node"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
argument_list|(
name|timeout
operator|=
literal|100000
argument_list|)
DECL|method|testNMRMConnectionConf ()
specifier|public
name|void
name|testNMRMConnectionConf
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|long
name|delta
init|=
literal|50000
decl_stmt|;
specifier|final
name|long
name|nmRmConnectionWaitMs
init|=
literal|100
decl_stmt|;
specifier|final
name|long
name|nmRmRetryInterval
init|=
literal|100
decl_stmt|;
specifier|final
name|long
name|connectionWaitMs
init|=
operator|-
literal|1
decl_stmt|;
specifier|final
name|long
name|connectionRetryIntervalMs
init|=
literal|1000
decl_stmt|;
comment|//Waiting for rmStartIntervalMS, RM will be started
specifier|final
name|long
name|rmStartIntervalMS
init|=
literal|2
operator|*
literal|1000
decl_stmt|;
name|conf
operator|.
name|setLong
argument_list|(
name|YarnConfiguration
operator|.
name|NM_RESOURCEMANAGER_CONNECT_MAX_WAIT_MS
argument_list|,
name|nmRmConnectionWaitMs
argument_list|)
expr_stmt|;
name|conf
operator|.
name|setLong
argument_list|(
name|YarnConfiguration
operator|.
name|NM_RESOURCEMANAGER_CONNECT_RETRY_INTERVAL_MS
argument_list|,
name|nmRmRetryInterval
argument_list|)
expr_stmt|;
name|conf
operator|.
name|setLong
argument_list|(
name|YarnConfiguration
operator|.
name|RESOURCEMANAGER_CONNECT_MAX_WAIT_MS
argument_list|,
name|connectionWaitMs
argument_list|)
expr_stmt|;
name|conf
operator|.
name|setLong
argument_list|(
name|YarnConfiguration
operator|.
name|RESOURCEMANAGER_CONNECT_RETRY_INTERVAL_MS
argument_list|,
name|connectionRetryIntervalMs
argument_list|)
expr_stmt|;
name|conf
operator|.
name|setInt
argument_list|(
name|CommonConfigurationKeysPublic
operator|.
name|IPC_CLIENT_CONNECT_MAX_RETRIES_KEY
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|//Test NM try to connect to RM Several times, but finally fail
name|NodeManagerWithCustomNodeStatusUpdater
name|nmWithUpdater
decl_stmt|;
name|nm
operator|=
name|nmWithUpdater
operator|=
operator|new
name|NodeManagerWithCustomNodeStatusUpdater
argument_list|()
block|{
annotation|@
name|Override
specifier|protected
name|NodeStatusUpdater
name|createUpdater
parameter_list|(
name|Context
name|context
parameter_list|,
name|Dispatcher
name|dispatcher
parameter_list|,
name|NodeHealthCheckerService
name|healthChecker
parameter_list|)
block|{
name|NodeStatusUpdater
name|nodeStatusUpdater
init|=
operator|new
name|MyNodeStatusUpdater6
argument_list|(
name|context
argument_list|,
name|dispatcher
argument_list|,
name|healthChecker
argument_list|,
name|metrics
argument_list|,
name|rmStartIntervalMS
argument_list|,
literal|true
argument_list|)
decl_stmt|;
return|return
name|nodeStatusUpdater
return|;
block|}
block|}
expr_stmt|;
name|nm
operator|.
name|init
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|long
name|waitStartTime
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
try|try
block|{
name|nm
operator|.
name|start
argument_list|()
expr_stmt|;
name|Assert
operator|.
name|fail
argument_list|(
literal|"NM should have failed to start due to RM connect failure"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|long
name|t
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|long
name|duration
init|=
name|t
operator|-
name|waitStartTime
decl_stmt|;
name|boolean
name|waitTimeValid
init|=
operator|(
name|duration
operator|>=
name|nmRmConnectionWaitMs
operator|)
operator|&&
operator|(
name|duration
operator|<
operator|(
name|nmRmConnectionWaitMs
operator|+
name|delta
operator|)
operator|)
decl_stmt|;
if|if
condition|(
operator|!
name|waitTimeValid
condition|)
block|{
comment|// throw exception if NM doesn't retry long enough
throw|throw
operator|new
name|Exception
argument_list|(
literal|"NM should have tried re-connecting to RM during "
operator|+
literal|"period of at least "
operator|+
name|nmRmConnectionWaitMs
operator|+
literal|" ms, but "
operator|+
literal|"stopped retrying within "
operator|+
operator|(
name|nmRmConnectionWaitMs
operator|+
name|delta
operator|)
operator|+
literal|" ms: "
operator|+
name|e
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
block|}
annotation|@
name|Test
argument_list|(
name|timeout
operator|=
literal|150000
argument_list|)
DECL|method|testNMConnectionToRM ()
specifier|public
name|void
name|testNMConnectionToRM
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|long
name|delta
init|=
literal|50000
decl_stmt|;
specifier|final
name|long
name|connectionWaitMs
init|=
literal|5000
decl_stmt|;
specifier|final
name|long
name|connectionRetryIntervalMs
init|=
literal|1000
decl_stmt|;
comment|//Waiting for rmStartIntervalMS, RM will be started
specifier|final
name|long
name|rmStartIntervalMS
init|=
literal|2
operator|*
literal|1000
decl_stmt|;
name|conf
operator|.
name|setLong
argument_list|(
name|YarnConfiguration
operator|.
name|RESOURCEMANAGER_CONNECT_MAX_WAIT_MS
argument_list|,
name|connectionWaitMs
argument_list|)
expr_stmt|;
name|conf
operator|.
name|setLong
argument_list|(
name|YarnConfiguration
operator|.
name|RESOURCEMANAGER_CONNECT_RETRY_INTERVAL_MS
argument_list|,
name|connectionRetryIntervalMs
argument_list|)
expr_stmt|;
comment|//Test NM try to connect to RM Several times, but finally fail
name|NodeManagerWithCustomNodeStatusUpdater
name|nmWithUpdater
decl_stmt|;
name|nm
operator|=
name|nmWithUpdater
operator|=
operator|new
name|NodeManagerWithCustomNodeStatusUpdater
argument_list|()
block|{
annotation|@
name|Override
specifier|protected
name|NodeStatusUpdater
name|createUpdater
parameter_list|(
name|Context
name|context
parameter_list|,
name|Dispatcher
name|dispatcher
parameter_list|,
name|NodeHealthCheckerService
name|healthChecker
parameter_list|)
block|{
name|NodeStatusUpdater
name|nodeStatusUpdater
init|=
operator|new
name|MyNodeStatusUpdater4
argument_list|(
name|context
argument_list|,
name|dispatcher
argument_list|,
name|healthChecker
argument_list|,
name|metrics
argument_list|,
name|rmStartIntervalMS
argument_list|,
literal|true
argument_list|)
decl_stmt|;
return|return
name|nodeStatusUpdater
return|;
block|}
block|}
expr_stmt|;
name|nm
operator|.
name|init
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|long
name|waitStartTime
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
try|try
block|{
name|nm
operator|.
name|start
argument_list|()
expr_stmt|;
name|Assert
operator|.
name|fail
argument_list|(
literal|"NM should have failed to start due to RM connect failure"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|long
name|t
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|long
name|duration
init|=
name|t
operator|-
name|waitStartTime
decl_stmt|;
name|boolean
name|waitTimeValid
init|=
operator|(
name|duration
operator|>=
name|connectionWaitMs
operator|)
operator|&&
operator|(
name|duration
operator|<
operator|(
name|connectionWaitMs
operator|+
name|delta
operator|)
operator|)
decl_stmt|;
if|if
condition|(
operator|!
name|waitTimeValid
condition|)
block|{
comment|//either the exception was too early, or it had a different cause.
comment|//reject with the inner stack trace
throw|throw
operator|new
name|Exception
argument_list|(
literal|"NM should have tried re-connecting to RM during "
operator|+
literal|"period of at least "
operator|+
name|connectionWaitMs
operator|+
literal|" ms, but "
operator|+
literal|"stopped retrying within "
operator|+
operator|(
name|connectionWaitMs
operator|+
name|delta
operator|)
operator|+
literal|" ms: "
operator|+
name|e
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
comment|//Test NM connect to RM, fail at first several attempts,
comment|//but finally success.
name|nm
operator|=
name|nmWithUpdater
operator|=
operator|new
name|NodeManagerWithCustomNodeStatusUpdater
argument_list|()
block|{
annotation|@
name|Override
specifier|protected
name|NodeStatusUpdater
name|createUpdater
parameter_list|(
name|Context
name|context
parameter_list|,
name|Dispatcher
name|dispatcher
parameter_list|,
name|NodeHealthCheckerService
name|healthChecker
parameter_list|)
block|{
name|NodeStatusUpdater
name|nodeStatusUpdater
init|=
operator|new
name|MyNodeStatusUpdater4
argument_list|(
name|context
argument_list|,
name|dispatcher
argument_list|,
name|healthChecker
argument_list|,
name|metrics
argument_list|,
name|rmStartIntervalMS
argument_list|,
literal|false
argument_list|)
decl_stmt|;
return|return
name|nodeStatusUpdater
return|;
block|}
block|}
expr_stmt|;
name|nm
operator|.
name|init
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|NodeStatusUpdater
name|updater
init|=
name|nmWithUpdater
operator|.
name|getUpdater
argument_list|()
decl_stmt|;
name|Assert
operator|.
name|assertNotNull
argument_list|(
literal|"Updater not yet created "
argument_list|,
name|updater
argument_list|)
expr_stmt|;
name|waitStartTime
operator|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
expr_stmt|;
try|try
block|{
name|nm
operator|.
name|start
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|ex
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"NM should have started successfully "
operator|+
literal|"after connecting to RM."
argument_list|,
name|ex
argument_list|)
expr_stmt|;
throw|throw
name|ex
throw|;
block|}
name|long
name|duration
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|waitStartTime
decl_stmt|;
name|MyNodeStatusUpdater4
name|myUpdater
init|=
operator|(
name|MyNodeStatusUpdater4
operator|)
name|updater
decl_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
literal|"NM started before updater triggered"
argument_list|,
name|myUpdater
operator|.
name|isTriggered
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
literal|"NM should have connected to RM after "
operator|+
literal|"the start interval of "
operator|+
name|rmStartIntervalMS
operator|+
literal|": actual "
operator|+
name|duration
operator|+
literal|" "
operator|+
name|myUpdater
argument_list|,
operator|(
name|duration
operator|>=
name|rmStartIntervalMS
operator|)
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
literal|"NM should have connected to RM less than "
operator|+
operator|(
name|rmStartIntervalMS
operator|+
name|delta
operator|)
operator|+
literal|" milliseconds of RM starting up: actual "
operator|+
name|duration
operator|+
literal|" "
operator|+
name|myUpdater
argument_list|,
operator|(
name|duration
operator|<
operator|(
name|rmStartIntervalMS
operator|+
name|delta
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/**    * Verifies that if for some reason NM fails to start ContainerManager RPC    * server, RM is oblivious to NM's presence. The behaviour is like this    * because otherwise, NM will report to RM even if all its servers are not    * started properly, RM will think that the NM is alive and will retire the NM    * only after NM_EXPIRY interval. See MAPREDUCE-2749.    */
annotation|@
name|Test
DECL|method|testNoRegistrationWhenNMServicesFail ()
specifier|public
name|void
name|testNoRegistrationWhenNMServicesFail
parameter_list|()
throws|throws
name|Exception
block|{
name|nm
operator|=
operator|new
name|NodeManager
argument_list|()
block|{
annotation|@
name|Override
specifier|protected
name|NodeStatusUpdater
name|createNodeStatusUpdater
parameter_list|(
name|Context
name|context
parameter_list|,
name|Dispatcher
name|dispatcher
parameter_list|,
name|NodeHealthCheckerService
name|healthChecker
parameter_list|)
block|{
return|return
operator|new
name|MyNodeStatusUpdater
argument_list|(
name|context
argument_list|,
name|dispatcher
argument_list|,
name|healthChecker
argument_list|,
name|metrics
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|protected
name|ContainerManagerImpl
name|createContainerManager
parameter_list|(
name|Context
name|context
parameter_list|,
name|ContainerExecutor
name|exec
parameter_list|,
name|DeletionService
name|del
parameter_list|,
name|NodeStatusUpdater
name|nodeStatusUpdater
parameter_list|,
name|ApplicationACLsManager
name|aclsManager
parameter_list|,
name|LocalDirsHandlerService
name|diskhandler
parameter_list|)
block|{
return|return
operator|new
name|ContainerManagerImpl
argument_list|(
name|context
argument_list|,
name|exec
argument_list|,
name|del
argument_list|,
name|nodeStatusUpdater
argument_list|,
name|metrics
argument_list|,
name|diskhandler
argument_list|)
block|{
annotation|@
name|Override
specifier|protected
name|void
name|serviceStart
parameter_list|()
block|{
comment|// Simulating failure of starting RPC server
throw|throw
operator|new
name|YarnRuntimeException
argument_list|(
literal|"Starting of RPC Server failed"
argument_list|)
throw|;
block|}
block|}
return|;
block|}
block|}
expr_stmt|;
name|verifyNodeStartFailure
argument_list|(
literal|"Starting of RPC Server failed"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testApplicationKeepAlive ()
specifier|public
name|void
name|testApplicationKeepAlive
parameter_list|()
throws|throws
name|Exception
block|{
name|MyNodeManager
name|nm
init|=
operator|new
name|MyNodeManager
argument_list|()
decl_stmt|;
try|try
block|{
name|YarnConfiguration
name|conf
init|=
name|createNMConfig
argument_list|()
decl_stmt|;
name|conf
operator|.
name|setBoolean
argument_list|(
name|YarnConfiguration
operator|.
name|LOG_AGGREGATION_ENABLED
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|conf
operator|.
name|setLong
argument_list|(
name|YarnConfiguration
operator|.
name|RM_NM_EXPIRY_INTERVAL_MS
argument_list|,
literal|4000l
argument_list|)
expr_stmt|;
name|nm
operator|.
name|init
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|nm
operator|.
name|start
argument_list|()
expr_stmt|;
comment|// HB 2 -> app cancelled by RM.
while|while
condition|(
name|heartBeatID
operator|<
literal|12
condition|)
block|{
name|Thread
operator|.
name|sleep
argument_list|(
literal|1000l
argument_list|)
expr_stmt|;
block|}
name|MyResourceTracker3
name|rt
init|=
operator|(
name|MyResourceTracker3
operator|)
name|nm
operator|.
name|getNodeStatusUpdater
argument_list|()
operator|.
name|getRMClient
argument_list|()
decl_stmt|;
name|rt
operator|.
name|context
operator|.
name|getApplications
argument_list|()
operator|.
name|remove
argument_list|(
name|rt
operator|.
name|appId
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|rt
operator|.
name|keepAliveRequests
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|int
name|numKeepAliveRequests
init|=
name|rt
operator|.
name|keepAliveRequests
operator|.
name|get
argument_list|(
name|rt
operator|.
name|appId
argument_list|)
operator|.
name|size
argument_list|()
decl_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Number of Keep Alive Requests: ["
operator|+
name|numKeepAliveRequests
operator|+
literal|"]"
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
name|numKeepAliveRequests
operator|==
literal|2
operator|||
name|numKeepAliveRequests
operator|==
literal|3
argument_list|)
expr_stmt|;
while|while
condition|(
name|heartBeatID
operator|<
literal|20
condition|)
block|{
name|Thread
operator|.
name|sleep
argument_list|(
literal|1000l
argument_list|)
expr_stmt|;
block|}
name|int
name|numKeepAliveRequests2
init|=
name|rt
operator|.
name|keepAliveRequests
operator|.
name|get
argument_list|(
name|rt
operator|.
name|appId
argument_list|)
operator|.
name|size
argument_list|()
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
name|numKeepAliveRequests
argument_list|,
name|numKeepAliveRequests2
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
name|nm
operator|.
name|getServiceState
argument_list|()
operator|==
name|STATE
operator|.
name|STARTED
condition|)
name|nm
operator|.
name|stop
argument_list|()
expr_stmt|;
block|}
block|}
comment|/**    * Test completed containerStatus get back up when heart beat lost, and will    * be sent via next heart beat.    */
annotation|@
name|Test
argument_list|(
name|timeout
operator|=
literal|200000
argument_list|)
DECL|method|testCompletedContainerStatusBackup ()
specifier|public
name|void
name|testCompletedContainerStatusBackup
parameter_list|()
throws|throws
name|Exception
block|{
name|nm
operator|=
operator|new
name|NodeManager
argument_list|()
block|{
annotation|@
name|Override
specifier|protected
name|NodeStatusUpdater
name|createNodeStatusUpdater
parameter_list|(
name|Context
name|context
parameter_list|,
name|Dispatcher
name|dispatcher
parameter_list|,
name|NodeHealthCheckerService
name|healthChecker
parameter_list|)
block|{
name|MyNodeStatusUpdater2
name|myNodeStatusUpdater
init|=
operator|new
name|MyNodeStatusUpdater2
argument_list|(
name|context
argument_list|,
name|dispatcher
argument_list|,
name|healthChecker
argument_list|,
name|metrics
argument_list|)
decl_stmt|;
return|return
name|myNodeStatusUpdater
return|;
block|}
annotation|@
name|Override
specifier|protected
name|NMContext
name|createNMContext
parameter_list|(
name|NMContainerTokenSecretManager
name|containerTokenSecretManager
parameter_list|,
name|NMTokenSecretManagerInNM
name|nmTokenSecretManager
parameter_list|,
name|NMStateStoreService
name|store
parameter_list|,
name|boolean
name|isDistributedSchedulingEnabled
parameter_list|,
name|Configuration
name|config
parameter_list|)
block|{
return|return
operator|new
name|MyNMContext
argument_list|(
name|containerTokenSecretManager
argument_list|,
name|nmTokenSecretManager
argument_list|,
name|config
argument_list|)
return|;
block|}
block|}
expr_stmt|;
name|YarnConfiguration
name|conf
init|=
name|createNMConfig
argument_list|()
decl_stmt|;
name|nm
operator|.
name|init
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|nm
operator|.
name|start
argument_list|()
expr_stmt|;
name|int
name|waitCount
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|heartBeatID
operator|<=
literal|4
operator|&&
name|waitCount
operator|++
operator|!=
literal|20
condition|)
block|{
name|Thread
operator|.
name|sleep
argument_list|(
literal|500
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|heartBeatID
operator|<=
literal|4
condition|)
block|{
name|Assert
operator|.
name|fail
argument_list|(
literal|"Failed to get all heartbeats in time, "
operator|+
literal|"heartbeatID:"
operator|+
name|heartBeatID
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|assertionFailedInThread
operator|.
name|get
argument_list|()
condition|)
block|{
name|Assert
operator|.
name|fail
argument_list|(
literal|"ContainerStatus Backup failed"
argument_list|)
expr_stmt|;
block|}
name|Assert
operator|.
name|assertNotNull
argument_list|(
name|nm
operator|.
name|getNMContext
argument_list|()
operator|.
name|getSystemCredentialsForApps
argument_list|()
operator|.
name|get
argument_list|(
name|ApplicationId
operator|.
name|newInstance
argument_list|(
literal|1234
argument_list|,
literal|1
argument_list|)
argument_list|)
operator|.
name|getToken
argument_list|(
operator|new
name|Text
argument_list|(
literal|"token1"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|nm
operator|.
name|stop
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
argument_list|(
name|timeout
operator|=
literal|200000
argument_list|)
DECL|method|testNodeStatusUpdaterRetryAndNMShutdown ()
specifier|public
name|void
name|testNodeStatusUpdaterRetryAndNMShutdown
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|long
name|connectionWaitSecs
init|=
literal|1000
decl_stmt|;
specifier|final
name|long
name|connectionRetryIntervalMs
init|=
literal|1000
decl_stmt|;
name|int
name|port
init|=
name|ServerSocketUtil
operator|.
name|getPort
argument_list|(
literal|49156
argument_list|,
literal|10
argument_list|)
decl_stmt|;
name|YarnConfiguration
name|conf
init|=
name|createNMConfig
argument_list|(
name|port
argument_list|)
decl_stmt|;
name|conf
operator|.
name|setLong
argument_list|(
name|YarnConfiguration
operator|.
name|RESOURCEMANAGER_CONNECT_MAX_WAIT_MS
argument_list|,
name|connectionWaitSecs
argument_list|)
expr_stmt|;
name|conf
operator|.
name|setLong
argument_list|(
name|YarnConfiguration
operator|.
name|RESOURCEMANAGER_CONNECT_RETRY_INTERVAL_MS
argument_list|,
name|connectionRetryIntervalMs
argument_list|)
expr_stmt|;
name|conf
operator|.
name|setLong
argument_list|(
name|YarnConfiguration
operator|.
name|NM_SLEEP_DELAY_BEFORE_SIGKILL_MS
argument_list|,
literal|5000
argument_list|)
expr_stmt|;
name|conf
operator|.
name|setLong
argument_list|(
name|YarnConfiguration
operator|.
name|NM_LOG_RETAIN_SECONDS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CyclicBarrier
name|syncBarrier
init|=
operator|new
name|CyclicBarrier
argument_list|(
literal|2
argument_list|)
decl_stmt|;
name|nm
operator|=
operator|new
name|MyNodeManager2
argument_list|(
name|syncBarrier
argument_list|,
name|conf
argument_list|)
expr_stmt|;
name|nm
operator|.
name|init
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|nm
operator|.
name|start
argument_list|()
expr_stmt|;
comment|// start a container
name|ContainerId
name|cId
init|=
name|TestNodeManagerShutdown
operator|.
name|createContainerId
argument_list|()
decl_stmt|;
name|FileContext
name|localFS
init|=
name|FileContext
operator|.
name|getLocalFSFileContext
argument_list|()
decl_stmt|;
name|TestNodeManagerShutdown
operator|.
name|startContainer
argument_list|(
name|nm
argument_list|,
name|cId
argument_list|,
name|localFS
argument_list|,
name|nmLocalDir
argument_list|,
operator|new
name|File
argument_list|(
literal|"start_file.txt"
argument_list|)
argument_list|,
name|port
argument_list|)
expr_stmt|;
try|try
block|{
comment|// Wait until we start stopping
name|syncBarrier
operator|.
name|await
argument_list|(
literal|10000
argument_list|,
name|TimeUnit
operator|.
name|MILLISECONDS
argument_list|)
expr_stmt|;
comment|// Wait until we finish stopping
name|syncBarrier
operator|.
name|await
argument_list|(
literal|10000
argument_list|,
name|TimeUnit
operator|.
name|MILLISECONDS
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{     }
name|Assert
operator|.
name|assertFalse
argument_list|(
literal|"Containers not cleaned up when NM stopped"
argument_list|,
name|assertionFailedInThread
operator|.
name|get
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
operator|(
operator|(
name|MyNodeManager2
operator|)
name|nm
operator|)
operator|.
name|isStopped
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
literal|"calculate heartBeatCount based on"
operator|+
literal|" connectionWaitSecs and RetryIntervalSecs"
argument_list|,
name|heartBeatID
operator|==
literal|2
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testRMVersionLessThanMinimum ()
specifier|public
name|void
name|testRMVersionLessThanMinimum
parameter_list|()
throws|throws
name|InterruptedException
throws|,
name|IOException
block|{
specifier|final
name|AtomicInteger
name|numCleanups
init|=
operator|new
name|AtomicInteger
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|YarnConfiguration
name|conf
init|=
name|createNMConfig
argument_list|()
decl_stmt|;
name|conf
operator|.
name|set
argument_list|(
name|YarnConfiguration
operator|.
name|NM_RESOURCEMANAGER_MINIMUM_VERSION
argument_list|,
literal|"3.0.0"
argument_list|)
expr_stmt|;
name|nm
operator|=
operator|new
name|NodeManager
argument_list|()
block|{
annotation|@
name|Override
specifier|protected
name|NodeStatusUpdater
name|createNodeStatusUpdater
parameter_list|(
name|Context
name|context
parameter_list|,
name|Dispatcher
name|dispatcher
parameter_list|,
name|NodeHealthCheckerService
name|healthChecker
parameter_list|)
block|{
name|MyNodeStatusUpdater
name|myNodeStatusUpdater
init|=
operator|new
name|MyNodeStatusUpdater
argument_list|(
name|context
argument_list|,
name|dispatcher
argument_list|,
name|healthChecker
argument_list|,
name|metrics
argument_list|)
decl_stmt|;
name|MyResourceTracker2
name|myResourceTracker2
init|=
operator|new
name|MyResourceTracker2
argument_list|()
decl_stmt|;
name|myResourceTracker2
operator|.
name|heartBeatNodeAction
operator|=
name|NodeAction
operator|.
name|NORMAL
expr_stmt|;
name|myResourceTracker2
operator|.
name|rmVersion
operator|=
literal|"3.0.0"
expr_stmt|;
name|myNodeStatusUpdater
operator|.
name|resourceTracker
operator|=
name|myResourceTracker2
expr_stmt|;
return|return
name|myNodeStatusUpdater
return|;
block|}
annotation|@
name|Override
specifier|protected
name|ContainerManagerImpl
name|createContainerManager
parameter_list|(
name|Context
name|context
parameter_list|,
name|ContainerExecutor
name|exec
parameter_list|,
name|DeletionService
name|del
parameter_list|,
name|NodeStatusUpdater
name|nodeStatusUpdater
parameter_list|,
name|ApplicationACLsManager
name|aclsManager
parameter_list|,
name|LocalDirsHandlerService
name|dirsHandler
parameter_list|)
block|{
return|return
operator|new
name|ContainerManagerImpl
argument_list|(
name|context
argument_list|,
name|exec
argument_list|,
name|del
argument_list|,
name|nodeStatusUpdater
argument_list|,
name|metrics
argument_list|,
name|dirsHandler
argument_list|)
block|{
annotation|@
name|Override
specifier|public
name|void
name|cleanUpApplicationsOnNMShutDown
parameter_list|()
block|{
name|super
operator|.
name|cleanUpApplicationsOnNMShutDown
argument_list|()
expr_stmt|;
name|numCleanups
operator|.
name|incrementAndGet
argument_list|()
expr_stmt|;
block|}
block|}
return|;
block|}
block|}
expr_stmt|;
name|nm
operator|.
name|init
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|nm
operator|.
name|start
argument_list|()
expr_stmt|;
comment|// NM takes a while to reach the STARTED state.
name|int
name|waitCount
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|nm
operator|.
name|getServiceState
argument_list|()
operator|!=
name|STATE
operator|.
name|STARTED
operator|&&
name|waitCount
operator|++
operator|!=
literal|20
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Waiting for NM to stop.."
argument_list|)
expr_stmt|;
name|Thread
operator|.
name|sleep
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
name|Assert
operator|.
name|assertTrue
argument_list|(
name|nm
operator|.
name|getServiceState
argument_list|()
operator|==
name|STATE
operator|.
name|STARTED
argument_list|)
expr_stmt|;
name|nm
operator|.
name|stop
argument_list|()
expr_stmt|;
block|}
comment|//Verify that signalContainer request can be dispatched from
comment|//NodeStatusUpdaterImpl to ContainerManagerImpl.
annotation|@
name|Test
DECL|method|testSignalContainerToContainerManager ()
specifier|public
name|void
name|testSignalContainerToContainerManager
parameter_list|()
throws|throws
name|Exception
block|{
name|nm
operator|=
operator|new
name|NodeManager
argument_list|()
block|{
annotation|@
name|Override
specifier|protected
name|NodeStatusUpdater
name|createNodeStatusUpdater
parameter_list|(
name|Context
name|context
parameter_list|,
name|Dispatcher
name|dispatcher
parameter_list|,
name|NodeHealthCheckerService
name|healthChecker
parameter_list|)
block|{
return|return
operator|new
name|MyNodeStatusUpdater
argument_list|(
name|context
argument_list|,
name|dispatcher
argument_list|,
name|healthChecker
argument_list|,
name|metrics
argument_list|,
literal|true
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|protected
name|ContainerManagerImpl
name|createContainerManager
parameter_list|(
name|Context
name|context
parameter_list|,
name|ContainerExecutor
name|exec
parameter_list|,
name|DeletionService
name|del
parameter_list|,
name|NodeStatusUpdater
name|nodeStatusUpdater
parameter_list|,
name|ApplicationACLsManager
name|aclsManager
parameter_list|,
name|LocalDirsHandlerService
name|diskhandler
parameter_list|)
block|{
return|return
operator|new
name|MyContainerManager
argument_list|(
name|context
argument_list|,
name|exec
argument_list|,
name|del
argument_list|,
name|nodeStatusUpdater
argument_list|,
name|metrics
argument_list|,
name|diskhandler
argument_list|)
return|;
block|}
block|}
expr_stmt|;
name|YarnConfiguration
name|conf
init|=
name|createNMConfig
argument_list|()
decl_stmt|;
name|nm
operator|.
name|init
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|nm
operator|.
name|start
argument_list|()
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|" ----- thread already started.."
operator|+
name|nm
operator|.
name|getServiceState
argument_list|()
argument_list|)
expr_stmt|;
name|int
name|waitCount
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|nm
operator|.
name|getServiceState
argument_list|()
operator|==
name|STATE
operator|.
name|INITED
operator|&&
name|waitCount
operator|++
operator|!=
literal|20
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Waiting for NM to start.."
argument_list|)
expr_stmt|;
if|if
condition|(
name|nmStartError
operator|!=
literal|null
condition|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Error during startup. "
argument_list|,
name|nmStartError
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|fail
argument_list|(
name|nmStartError
operator|.
name|getCause
argument_list|()
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|Thread
operator|.
name|sleep
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nm
operator|.
name|getServiceState
argument_list|()
operator|!=
name|STATE
operator|.
name|STARTED
condition|)
block|{
comment|// NM could have failed.
name|Assert
operator|.
name|fail
argument_list|(
literal|"NodeManager failed to start"
argument_list|)
expr_stmt|;
block|}
name|waitCount
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|heartBeatID
operator|<=
literal|3
operator|&&
name|waitCount
operator|++
operator|!=
literal|20
condition|)
block|{
name|Thread
operator|.
name|sleep
argument_list|(
literal|500
argument_list|)
expr_stmt|;
block|}
name|Assert
operator|.
name|assertFalse
argument_list|(
name|heartBeatID
operator|<=
literal|3
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Number of registered NMs is wrong!!"
argument_list|,
literal|1
argument_list|,
name|this
operator|.
name|registeredNodes
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|MyContainerManager
name|containerManager
init|=
operator|(
name|MyContainerManager
operator|)
name|nm
operator|.
name|getContainerManager
argument_list|()
decl_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
name|containerManager
operator|.
name|signaled
argument_list|)
expr_stmt|;
name|nm
operator|.
name|stop
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testConcurrentAccessToSystemCredentials ()
specifier|public
name|void
name|testConcurrentAccessToSystemCredentials
parameter_list|()
block|{
specifier|final
name|Map
argument_list|<
name|ApplicationId
argument_list|,
name|ByteBuffer
argument_list|>
name|testCredentials
init|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
decl_stmt|;
name|ByteBuffer
name|byteBuffer
init|=
name|ByteBuffer
operator|.
name|wrap
argument_list|(
operator|new
name|byte
index|[
literal|300
index|]
argument_list|)
decl_stmt|;
name|ApplicationId
name|applicationId
init|=
name|ApplicationId
operator|.
name|newInstance
argument_list|(
literal|123456
argument_list|,
literal|120
argument_list|)
decl_stmt|;
name|testCredentials
operator|.
name|put
argument_list|(
name|applicationId
argument_list|,
name|byteBuffer
argument_list|)
expr_stmt|;
specifier|final
name|List
argument_list|<
name|Throwable
argument_list|>
name|exceptions
init|=
name|Collections
operator|.
name|synchronizedList
argument_list|(
operator|new
name|ArrayList
argument_list|<
name|Throwable
argument_list|>
argument_list|()
argument_list|)
decl_stmt|;
specifier|final
name|int
name|NUM_THREADS
init|=
literal|10
decl_stmt|;
specifier|final
name|CountDownLatch
name|allDone
init|=
operator|new
name|CountDownLatch
argument_list|(
name|NUM_THREADS
argument_list|)
decl_stmt|;
specifier|final
name|ExecutorService
name|threadPool
init|=
name|HadoopExecutors
operator|.
name|newFixedThreadPool
argument_list|(
name|NUM_THREADS
argument_list|)
decl_stmt|;
specifier|final
name|AtomicBoolean
name|stop
init|=
operator|new
name|AtomicBoolean
argument_list|(
literal|false
argument_list|)
decl_stmt|;
try|try
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|NUM_THREADS
condition|;
name|i
operator|++
control|)
block|{
name|threadPool
operator|.
name|submit
argument_list|(
operator|new
name|Runnable
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|run
parameter_list|()
block|{
try|try
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|100
operator|&&
operator|!
name|stop
operator|.
name|get
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|NodeHeartbeatResponse
name|nodeHeartBeatResponse
init|=
name|newNodeHeartbeatResponse
argument_list|(
literal|0
argument_list|,
name|NodeAction
operator|.
name|NORMAL
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|nodeHeartBeatResponse
operator|.
name|setSystemCredentialsForApps
argument_list|(
name|testCredentials
argument_list|)
expr_stmt|;
name|NodeHeartbeatResponseProto
name|proto
init|=
operator|(
operator|(
name|NodeHeartbeatResponsePBImpl
operator|)
name|nodeHeartBeatResponse
operator|)
operator|.
name|getProto
argument_list|()
decl_stmt|;
name|Assert
operator|.
name|assertNotNull
argument_list|(
name|proto
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|Throwable
name|t
parameter_list|)
block|{
name|exceptions
operator|.
name|add
argument_list|(
name|t
argument_list|)
expr_stmt|;
name|stop
operator|.
name|set
argument_list|(
literal|true
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|allDone
operator|.
name|countDown
argument_list|()
expr_stmt|;
block|}
block|}
block|}
argument_list|)
expr_stmt|;
block|}
name|int
name|testTimeout
init|=
literal|2
decl_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
literal|"Timeout waiting for more than "
operator|+
name|testTimeout
operator|+
literal|" "
operator|+
literal|"seconds"
argument_list|,
name|allDone
operator|.
name|await
argument_list|(
name|testTimeout
argument_list|,
name|TimeUnit
operator|.
name|SECONDS
argument_list|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|ie
parameter_list|)
block|{
name|exceptions
operator|.
name|add
argument_list|(
name|ie
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|threadPool
operator|.
name|shutdownNow
argument_list|()
expr_stmt|;
block|}
name|Assert
operator|.
name|assertTrue
argument_list|(
literal|"Test failed with exception(s)"
operator|+
name|exceptions
argument_list|,
name|exceptions
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|// Add new containers info into NM context each time node heart beats.
DECL|class|MyNMContext
specifier|private
class|class
name|MyNMContext
extends|extends
name|NMContext
block|{
DECL|method|MyNMContext ( NMContainerTokenSecretManager containerTokenSecretManager, NMTokenSecretManagerInNM nmTokenSecretManager, Configuration conf)
specifier|public
name|MyNMContext
parameter_list|(
name|NMContainerTokenSecretManager
name|containerTokenSecretManager
parameter_list|,
name|NMTokenSecretManagerInNM
name|nmTokenSecretManager
parameter_list|,
name|Configuration
name|conf
parameter_list|)
block|{
name|super
argument_list|(
name|containerTokenSecretManager
argument_list|,
name|nmTokenSecretManager
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
operator|new
name|NMNullStateStoreService
argument_list|()
argument_list|,
literal|false
argument_list|,
name|conf
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|getContainers ()
specifier|public
name|ConcurrentMap
argument_list|<
name|ContainerId
argument_list|,
name|Container
argument_list|>
name|getContainers
parameter_list|()
block|{
if|if
condition|(
name|heartBeatID
operator|==
literal|0
condition|)
block|{
return|return
name|containers
return|;
block|}
elseif|else
if|if
condition|(
name|heartBeatID
operator|==
literal|1
condition|)
block|{
name|ContainerStatus
name|containerStatus2
init|=
name|createContainerStatus
argument_list|(
literal|2
argument_list|,
name|ContainerState
operator|.
name|RUNNING
argument_list|)
decl_stmt|;
name|putMockContainer
argument_list|(
name|containerStatus2
argument_list|)
expr_stmt|;
name|ContainerStatus
name|containerStatus3
init|=
name|createContainerStatus
argument_list|(
literal|3
argument_list|,
name|ContainerState
operator|.
name|COMPLETE
argument_list|)
decl_stmt|;
name|putMockContainer
argument_list|(
name|containerStatus3
argument_list|)
expr_stmt|;
return|return
name|containers
return|;
block|}
elseif|else
if|if
condition|(
name|heartBeatID
operator|==
literal|2
condition|)
block|{
name|ContainerStatus
name|containerStatus4
init|=
name|createContainerStatus
argument_list|(
literal|4
argument_list|,
name|ContainerState
operator|.
name|RUNNING
argument_list|)
decl_stmt|;
name|putMockContainer
argument_list|(
name|containerStatus4
argument_list|)
expr_stmt|;
name|ContainerStatus
name|containerStatus5
init|=
name|createContainerStatus
argument_list|(
literal|5
argument_list|,
name|ContainerState
operator|.
name|COMPLETE
argument_list|)
decl_stmt|;
name|putMockContainer
argument_list|(
name|containerStatus5
argument_list|)
expr_stmt|;
return|return
name|containers
return|;
block|}
elseif|else
if|if
condition|(
name|heartBeatID
operator|==
literal|3
operator|||
name|heartBeatID
operator|==
literal|4
condition|)
block|{
return|return
name|containers
return|;
block|}
else|else
block|{
name|containers
operator|.
name|clear
argument_list|()
expr_stmt|;
return|return
name|containers
return|;
block|}
block|}
DECL|method|putMockContainer (ContainerStatus containerStatus)
specifier|private
name|void
name|putMockContainer
parameter_list|(
name|ContainerStatus
name|containerStatus
parameter_list|)
block|{
name|Container
name|container
init|=
name|getMockContainer
argument_list|(
name|containerStatus
argument_list|)
decl_stmt|;
name|containers
operator|.
name|put
argument_list|(
name|containerStatus
operator|.
name|getContainerId
argument_list|()
argument_list|,
name|container
argument_list|)
expr_stmt|;
name|applications
operator|.
name|putIfAbsent
argument_list|(
name|containerStatus
operator|.
name|getContainerId
argument_list|()
operator|.
name|getApplicationAttemptId
argument_list|()
operator|.
name|getApplicationId
argument_list|()
argument_list|,
name|mock
argument_list|(
name|Application
operator|.
name|class
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|createContainerStatus (int id, ContainerState containerState)
specifier|public
specifier|static
name|ContainerStatus
name|createContainerStatus
parameter_list|(
name|int
name|id
parameter_list|,
name|ContainerState
name|containerState
parameter_list|)
block|{
name|ApplicationId
name|applicationId
init|=
name|ApplicationId
operator|.
name|newInstance
argument_list|(
literal|0
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|ApplicationAttemptId
name|applicationAttemptId
init|=
name|ApplicationAttemptId
operator|.
name|newInstance
argument_list|(
name|applicationId
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|ContainerId
name|contaierId
init|=
name|ContainerId
operator|.
name|newContainerId
argument_list|(
name|applicationAttemptId
argument_list|,
name|id
argument_list|)
decl_stmt|;
name|ContainerStatus
name|containerStatus
init|=
name|BuilderUtils
operator|.
name|newContainerStatus
argument_list|(
name|contaierId
argument_list|,
name|containerState
argument_list|,
literal|"test_containerStatus: id="
operator|+
name|id
operator|+
literal|", containerState: "
operator|+
name|containerState
argument_list|,
literal|0
argument_list|,
name|Resource
operator|.
name|newInstance
argument_list|(
literal|1024
argument_list|,
literal|1
argument_list|)
argument_list|)
decl_stmt|;
return|return
name|containerStatus
return|;
block|}
DECL|method|getMockContainer (ContainerStatus containerStatus)
specifier|public
specifier|static
name|Container
name|getMockContainer
parameter_list|(
name|ContainerStatus
name|containerStatus
parameter_list|)
block|{
name|ContainerImpl
name|container
init|=
name|mock
argument_list|(
name|ContainerImpl
operator|.
name|class
argument_list|)
decl_stmt|;
name|when
argument_list|(
name|container
operator|.
name|cloneAndGetContainerStatus
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|containerStatus
argument_list|)
expr_stmt|;
name|when
argument_list|(
name|container
operator|.
name|getCurrentState
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|containerStatus
operator|.
name|getState
argument_list|()
argument_list|)
expr_stmt|;
name|when
argument_list|(
name|container
operator|.
name|getContainerId
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|containerStatus
operator|.
name|getContainerId
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|containerStatus
operator|.
name|getState
argument_list|()
operator|.
name|equals
argument_list|(
name|ContainerState
operator|.
name|COMPLETE
argument_list|)
condition|)
block|{
name|when
argument_list|(
name|container
operator|.
name|getContainerState
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|containermanager
operator|.
name|container
operator|.
name|ContainerState
operator|.
name|DONE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|containerStatus
operator|.
name|getState
argument_list|()
operator|.
name|equals
argument_list|(
name|ContainerState
operator|.
name|RUNNING
argument_list|)
condition|)
block|{
name|when
argument_list|(
name|container
operator|.
name|getContainerState
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|containermanager
operator|.
name|container
operator|.
name|ContainerState
operator|.
name|RUNNING
argument_list|)
expr_stmt|;
block|}
return|return
name|container
return|;
block|}
DECL|method|verifyNodeStartFailure (String errMessage)
specifier|private
name|void
name|verifyNodeStartFailure
parameter_list|(
name|String
name|errMessage
parameter_list|)
throws|throws
name|Exception
block|{
name|Assert
operator|.
name|assertNotNull
argument_list|(
literal|"nm is null"
argument_list|,
name|nm
argument_list|)
expr_stmt|;
name|YarnConfiguration
name|conf
init|=
name|createNMConfig
argument_list|()
decl_stmt|;
name|nm
operator|.
name|init
argument_list|(
name|conf
argument_list|)
expr_stmt|;
try|try
block|{
name|nm
operator|.
name|start
argument_list|()
expr_stmt|;
name|Assert
operator|.
name|fail
argument_list|(
literal|"NM should have failed to start. Didn't get exception!!"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
comment|//the version in trunk looked in the cause for equality
comment|// and assumed failures were nested.
comment|//this version assumes that error strings propagate to the base and
comment|//use a contains() test only. It should be less brittle
if|if
condition|(
operator|!
name|e
operator|.
name|getMessage
argument_list|()
operator|.
name|contains
argument_list|(
name|errMessage
argument_list|)
condition|)
block|{
throw|throw
name|e
throw|;
block|}
block|}
comment|// the service should be stopped
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"NM state is wrong!"
argument_list|,
name|STATE
operator|.
name|STOPPED
argument_list|,
name|nm
operator|.
name|getServiceState
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Number of registered nodes is wrong!"
argument_list|,
literal|0
argument_list|,
name|this
operator|.
name|registeredNodes
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|createNMConfig (int port)
specifier|private
name|YarnConfiguration
name|createNMConfig
parameter_list|(
name|int
name|port
parameter_list|)
throws|throws
name|IOException
block|{
name|YarnConfiguration
name|conf
init|=
operator|new
name|YarnConfiguration
argument_list|()
decl_stmt|;
name|String
name|localhostAddress
init|=
literal|null
decl_stmt|;
try|try
block|{
name|localhostAddress
operator|=
name|InetAddress
operator|.
name|getByName
argument_list|(
literal|"localhost"
argument_list|)
operator|.
name|getCanonicalHostName
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|UnknownHostException
name|e
parameter_list|)
block|{
name|Assert
operator|.
name|fail
argument_list|(
literal|"Unable to get localhost address: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|conf
operator|.
name|setInt
argument_list|(
name|YarnConfiguration
operator|.
name|NM_PMEM_MB
argument_list|,
literal|5
operator|*
literal|1024
argument_list|)
expr_stmt|;
comment|// 5GB
name|conf
operator|.
name|set
argument_list|(
name|YarnConfiguration
operator|.
name|NM_ADDRESS
argument_list|,
name|localhostAddress
operator|+
literal|":"
operator|+
name|port
argument_list|)
expr_stmt|;
name|conf
operator|.
name|set
argument_list|(
name|YarnConfiguration
operator|.
name|NM_LOCALIZER_ADDRESS
argument_list|,
name|localhostAddress
operator|+
literal|":"
operator|+
name|ServerSocketUtil
operator|.
name|getPort
argument_list|(
literal|49160
argument_list|,
literal|10
argument_list|)
argument_list|)
expr_stmt|;
name|conf
operator|.
name|set
argument_list|(
name|YarnConfiguration
operator|.
name|NM_LOG_DIRS
argument_list|,
name|logsDir
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
expr_stmt|;
name|conf
operator|.
name|set
argument_list|(
name|YarnConfiguration
operator|.
name|NM_REMOTE_APP_LOG_DIR
argument_list|,
name|remoteLogsDir
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
expr_stmt|;
name|conf
operator|.
name|set
argument_list|(
name|YarnConfiguration
operator|.
name|NM_LOCAL_DIRS
argument_list|,
name|nmLocalDir
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
expr_stmt|;
name|conf
operator|.
name|setLong
argument_list|(
name|YarnConfiguration
operator|.
name|NM_LOG_RETAIN_SECONDS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|conf
return|;
block|}
DECL|method|createNMConfig ()
specifier|private
name|YarnConfiguration
name|createNMConfig
parameter_list|()
throws|throws
name|IOException
block|{
return|return
name|createNMConfig
argument_list|(
name|ServerSocketUtil
operator|.
name|getPort
argument_list|(
literal|49170
argument_list|,
literal|10
argument_list|)
argument_list|)
return|;
block|}
DECL|method|getNodeManager (final NodeAction nodeHeartBeatAction)
specifier|private
name|NodeManager
name|getNodeManager
parameter_list|(
specifier|final
name|NodeAction
name|nodeHeartBeatAction
parameter_list|)
block|{
return|return
operator|new
name|NodeManager
argument_list|()
block|{
annotation|@
name|Override
specifier|protected
name|NodeStatusUpdater
name|createNodeStatusUpdater
parameter_list|(
name|Context
name|context
parameter_list|,
name|Dispatcher
name|dispatcher
parameter_list|,
name|NodeHealthCheckerService
name|healthChecker
parameter_list|)
block|{
name|MyNodeStatusUpdater
name|myNodeStatusUpdater
init|=
operator|new
name|MyNodeStatusUpdater
argument_list|(
name|context
argument_list|,
name|dispatcher
argument_list|,
name|healthChecker
argument_list|,
name|metrics
argument_list|)
decl_stmt|;
name|MyResourceTracker2
name|myResourceTracker2
init|=
operator|new
name|MyResourceTracker2
argument_list|()
decl_stmt|;
name|myResourceTracker2
operator|.
name|heartBeatNodeAction
operator|=
name|nodeHeartBeatAction
expr_stmt|;
name|myNodeStatusUpdater
operator|.
name|resourceTracker
operator|=
name|myResourceTracker2
expr_stmt|;
return|return
name|myNodeStatusUpdater
return|;
block|}
block|}
return|;
block|}
block|}
end_class

end_unit

