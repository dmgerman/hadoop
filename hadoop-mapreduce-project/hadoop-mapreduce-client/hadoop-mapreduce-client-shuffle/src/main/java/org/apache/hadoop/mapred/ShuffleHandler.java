begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/** * Licensed to the Apache Software Foundation (ASF) under one * or more contributor license agreements.  See the NOTICE file * distributed with this work for additional information * regarding copyright ownership.  The ASF licenses this file * to you under the Apache License, Version 2.0 (the * "License"); you may not use this file except in compliance * with the License.  You may obtain a copy of the License at * *     http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */
end_comment

begin_package
DECL|package|org.apache.hadoop.mapred
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|mapred
package|;
end_package

begin_import
import|import static
name|org
operator|.
name|fusesource
operator|.
name|leveldbjni
operator|.
name|JniDBFactory
operator|.
name|asString
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|fusesource
operator|.
name|leveldbjni
operator|.
name|JniDBFactory
operator|.
name|bytes
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|buffer
operator|.
name|ChannelBuffers
operator|.
name|wrappedBuffer
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|handler
operator|.
name|codec
operator|.
name|http
operator|.
name|HttpHeaders
operator|.
name|Names
operator|.
name|CONTENT_TYPE
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|handler
operator|.
name|codec
operator|.
name|http
operator|.
name|HttpMethod
operator|.
name|GET
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|handler
operator|.
name|codec
operator|.
name|http
operator|.
name|HttpResponseStatus
operator|.
name|BAD_REQUEST
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|handler
operator|.
name|codec
operator|.
name|http
operator|.
name|HttpResponseStatus
operator|.
name|FORBIDDEN
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|handler
operator|.
name|codec
operator|.
name|http
operator|.
name|HttpResponseStatus
operator|.
name|INTERNAL_SERVER_ERROR
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|handler
operator|.
name|codec
operator|.
name|http
operator|.
name|HttpResponseStatus
operator|.
name|METHOD_NOT_ALLOWED
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|handler
operator|.
name|codec
operator|.
name|http
operator|.
name|HttpResponseStatus
operator|.
name|NOT_FOUND
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|handler
operator|.
name|codec
operator|.
name|http
operator|.
name|HttpResponseStatus
operator|.
name|OK
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|handler
operator|.
name|codec
operator|.
name|http
operator|.
name|HttpResponseStatus
operator|.
name|UNAUTHORIZED
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|handler
operator|.
name|codec
operator|.
name|http
operator|.
name|HttpVersion
operator|.
name|HTTP_1_1
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|File
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|FileNotFoundException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|RandomAccessFile
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|InetSocketAddress
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URL
import|;
end_import

begin_import
import|import
name|java
operator|.
name|nio
operator|.
name|ByteBuffer
import|;
end_import

begin_import
import|import
name|java
operator|.
name|nio
operator|.
name|channels
operator|.
name|ClosedChannelException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collections
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ConcurrentHashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ExecutionException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ThreadFactory
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|TimeUnit
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|atomic
operator|.
name|AtomicInteger
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|regex
operator|.
name|Pattern
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|crypto
operator|.
name|SecretKey
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|Log
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|LogFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|conf
operator|.
name|Configuration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|LocalDirAllocator
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|Path
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|DataInputByteBuffer
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|DataOutputBuffer
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|ReadaheadPool
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|SecureIOUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|Text
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|mapred
operator|.
name|proto
operator|.
name|ShuffleHandlerRecoveryProtos
operator|.
name|JobShuffleInfoProto
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|mapreduce
operator|.
name|MRConfig
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|mapreduce
operator|.
name|security
operator|.
name|SecureShuffleUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|mapreduce
operator|.
name|security
operator|.
name|token
operator|.
name|JobTokenIdentifier
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|mapreduce
operator|.
name|security
operator|.
name|token
operator|.
name|JobTokenSecretManager
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|mapreduce
operator|.
name|task
operator|.
name|reduce
operator|.
name|ShuffleHeader
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|metrics2
operator|.
name|MetricsSystem
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|metrics2
operator|.
name|annotation
operator|.
name|Metric
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|metrics2
operator|.
name|annotation
operator|.
name|Metrics
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|metrics2
operator|.
name|lib
operator|.
name|DefaultMetricsSystem
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|metrics2
operator|.
name|lib
operator|.
name|MutableCounterInt
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|metrics2
operator|.
name|lib
operator|.
name|MutableCounterLong
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|metrics2
operator|.
name|lib
operator|.
name|MutableGaugeInt
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|proto
operator|.
name|SecurityProtos
operator|.
name|TokenProto
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|ssl
operator|.
name|SSLFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|security
operator|.
name|token
operator|.
name|Token
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|util
operator|.
name|Shell
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|util
operator|.
name|concurrent
operator|.
name|HadoopExecutors
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|ApplicationId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|conf
operator|.
name|YarnConfiguration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|proto
operator|.
name|YarnServerCommonProtos
operator|.
name|VersionProto
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|api
operator|.
name|ApplicationInitializationContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|api
operator|.
name|ApplicationTerminationContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|api
operator|.
name|AuxiliaryService
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|nodemanager
operator|.
name|containermanager
operator|.
name|localizer
operator|.
name|ContainerLocalizer
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|records
operator|.
name|Version
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|records
operator|.
name|impl
operator|.
name|pb
operator|.
name|VersionPBImpl
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|server
operator|.
name|utils
operator|.
name|LeveldbIterator
import|;
end_import

begin_import
import|import
name|org
operator|.
name|fusesource
operator|.
name|leveldbjni
operator|.
name|JniDBFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|fusesource
operator|.
name|leveldbjni
operator|.
name|internal
operator|.
name|NativeDB
import|;
end_import

begin_import
import|import
name|org
operator|.
name|iq80
operator|.
name|leveldb
operator|.
name|DB
import|;
end_import

begin_import
import|import
name|org
operator|.
name|iq80
operator|.
name|leveldb
operator|.
name|DBException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|iq80
operator|.
name|leveldb
operator|.
name|Logger
import|;
end_import

begin_import
import|import
name|org
operator|.
name|iq80
operator|.
name|leveldb
operator|.
name|Options
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|bootstrap
operator|.
name|ServerBootstrap
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|buffer
operator|.
name|ChannelBuffers
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|Channel
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|ChannelFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|ChannelFuture
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|ChannelFutureListener
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|ChannelHandler
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|ChannelHandlerContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|ChannelPipeline
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|ChannelPipelineFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|ChannelStateEvent
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|Channels
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|ExceptionEvent
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|MessageEvent
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|SimpleChannelUpstreamHandler
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|group
operator|.
name|ChannelGroup
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|group
operator|.
name|DefaultChannelGroup
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|socket
operator|.
name|nio
operator|.
name|NioServerSocketChannelFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|handler
operator|.
name|codec
operator|.
name|frame
operator|.
name|TooLongFrameException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|handler
operator|.
name|codec
operator|.
name|http
operator|.
name|DefaultHttpResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|handler
operator|.
name|codec
operator|.
name|http
operator|.
name|HttpChunkAggregator
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|handler
operator|.
name|codec
operator|.
name|http
operator|.
name|HttpRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|handler
operator|.
name|codec
operator|.
name|http
operator|.
name|HttpRequestDecoder
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|handler
operator|.
name|codec
operator|.
name|http
operator|.
name|HttpResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|handler
operator|.
name|codec
operator|.
name|http
operator|.
name|HttpResponseEncoder
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|handler
operator|.
name|codec
operator|.
name|http
operator|.
name|HttpResponseStatus
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|handler
operator|.
name|codec
operator|.
name|http
operator|.
name|QueryStringDecoder
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|handler
operator|.
name|ssl
operator|.
name|SslHandler
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|handler
operator|.
name|stream
operator|.
name|ChunkedWriteHandler
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|handler
operator|.
name|timeout
operator|.
name|IdleState
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|handler
operator|.
name|timeout
operator|.
name|IdleStateAwareChannelHandler
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|handler
operator|.
name|timeout
operator|.
name|IdleStateEvent
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|handler
operator|.
name|timeout
operator|.
name|IdleStateHandler
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|util
operator|.
name|CharsetUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|util
operator|.
name|HashedWheelTimer
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|util
operator|.
name|Timer
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jetty
operator|.
name|http
operator|.
name|HttpHeader
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|annotations
operator|.
name|VisibleForTesting
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|base
operator|.
name|Charsets
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|cache
operator|.
name|CacheBuilder
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|cache
operator|.
name|CacheLoader
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|cache
operator|.
name|LoadingCache
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|cache
operator|.
name|RemovalListener
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|cache
operator|.
name|RemovalNotification
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|cache
operator|.
name|Weigher
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ThreadFactoryBuilder
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|protobuf
operator|.
name|ByteString
import|;
end_import

begin_class
DECL|class|ShuffleHandler
specifier|public
class|class
name|ShuffleHandler
extends|extends
name|AuxiliaryService
block|{
DECL|field|LOG
specifier|private
specifier|static
specifier|final
name|Log
name|LOG
init|=
name|LogFactory
operator|.
name|getLog
argument_list|(
name|ShuffleHandler
operator|.
name|class
argument_list|)
decl_stmt|;
DECL|field|AUDITLOG
specifier|private
specifier|static
specifier|final
name|Log
name|AUDITLOG
init|=
name|LogFactory
operator|.
name|getLog
argument_list|(
name|ShuffleHandler
operator|.
name|class
operator|.
name|getName
argument_list|()
operator|+
literal|".audit"
argument_list|)
decl_stmt|;
DECL|field|SHUFFLE_MANAGE_OS_CACHE
specifier|public
specifier|static
specifier|final
name|String
name|SHUFFLE_MANAGE_OS_CACHE
init|=
literal|"mapreduce.shuffle.manage.os.cache"
decl_stmt|;
DECL|field|DEFAULT_SHUFFLE_MANAGE_OS_CACHE
specifier|public
specifier|static
specifier|final
name|boolean
name|DEFAULT_SHUFFLE_MANAGE_OS_CACHE
init|=
literal|true
decl_stmt|;
DECL|field|SHUFFLE_READAHEAD_BYTES
specifier|public
specifier|static
specifier|final
name|String
name|SHUFFLE_READAHEAD_BYTES
init|=
literal|"mapreduce.shuffle.readahead.bytes"
decl_stmt|;
DECL|field|DEFAULT_SHUFFLE_READAHEAD_BYTES
specifier|public
specifier|static
specifier|final
name|int
name|DEFAULT_SHUFFLE_READAHEAD_BYTES
init|=
literal|4
operator|*
literal|1024
operator|*
literal|1024
decl_stmt|;
comment|// pattern to identify errors related to the client closing the socket early
comment|// idea borrowed from Netty SslHandler
DECL|field|IGNORABLE_ERROR_MESSAGE
specifier|private
specifier|static
specifier|final
name|Pattern
name|IGNORABLE_ERROR_MESSAGE
init|=
name|Pattern
operator|.
name|compile
argument_list|(
literal|"^.*(?:connection.*reset|connection.*closed|broken.*pipe).*$"
argument_list|,
name|Pattern
operator|.
name|CASE_INSENSITIVE
argument_list|)
decl_stmt|;
DECL|field|STATE_DB_NAME
specifier|private
specifier|static
specifier|final
name|String
name|STATE_DB_NAME
init|=
literal|"mapreduce_shuffle_state"
decl_stmt|;
DECL|field|STATE_DB_SCHEMA_VERSION_KEY
specifier|private
specifier|static
specifier|final
name|String
name|STATE_DB_SCHEMA_VERSION_KEY
init|=
literal|"shuffle-schema-version"
decl_stmt|;
DECL|field|CURRENT_VERSION_INFO
specifier|protected
specifier|static
specifier|final
name|Version
name|CURRENT_VERSION_INFO
init|=
name|Version
operator|.
name|newInstance
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|)
decl_stmt|;
DECL|field|DATA_FILE_NAME
specifier|private
specifier|static
specifier|final
name|String
name|DATA_FILE_NAME
init|=
literal|"file.out"
decl_stmt|;
DECL|field|INDEX_FILE_NAME
specifier|private
specifier|static
specifier|final
name|String
name|INDEX_FILE_NAME
init|=
literal|"file.out.index"
decl_stmt|;
DECL|field|TOO_MANY_REQ_STATUS
specifier|public
specifier|static
specifier|final
name|HttpResponseStatus
name|TOO_MANY_REQ_STATUS
init|=
operator|new
name|HttpResponseStatus
argument_list|(
literal|429
argument_list|,
literal|"TOO MANY REQUESTS"
argument_list|)
decl_stmt|;
comment|// This should kept in sync with Fetcher.FETCH_RETRY_DELAY_DEFAULT
DECL|field|FETCH_RETRY_DELAY
specifier|public
specifier|static
specifier|final
name|long
name|FETCH_RETRY_DELAY
init|=
literal|1000L
decl_stmt|;
DECL|field|RETRY_AFTER_HEADER
specifier|public
specifier|static
specifier|final
name|String
name|RETRY_AFTER_HEADER
init|=
literal|"Retry-After"
decl_stmt|;
DECL|field|port
specifier|private
name|int
name|port
decl_stmt|;
DECL|field|selector
specifier|private
name|ChannelFactory
name|selector
decl_stmt|;
DECL|field|accepted
specifier|private
specifier|final
name|ChannelGroup
name|accepted
init|=
operator|new
name|DefaultChannelGroup
argument_list|()
decl_stmt|;
DECL|field|pipelineFact
specifier|protected
name|HttpPipelineFactory
name|pipelineFact
decl_stmt|;
DECL|field|sslFileBufferSize
specifier|private
name|int
name|sslFileBufferSize
decl_stmt|;
comment|/**    * Should the shuffle use posix_fadvise calls to manage the OS cache during    * sendfile    */
DECL|field|manageOsCache
specifier|private
name|boolean
name|manageOsCache
decl_stmt|;
DECL|field|readaheadLength
specifier|private
name|int
name|readaheadLength
decl_stmt|;
DECL|field|maxShuffleConnections
specifier|private
name|int
name|maxShuffleConnections
decl_stmt|;
DECL|field|shuffleBufferSize
specifier|private
name|int
name|shuffleBufferSize
decl_stmt|;
DECL|field|shuffleTransferToAllowed
specifier|private
name|boolean
name|shuffleTransferToAllowed
decl_stmt|;
DECL|field|maxSessionOpenFiles
specifier|private
name|int
name|maxSessionOpenFiles
decl_stmt|;
DECL|field|readaheadPool
specifier|private
name|ReadaheadPool
name|readaheadPool
init|=
name|ReadaheadPool
operator|.
name|getInstance
argument_list|()
decl_stmt|;
DECL|field|userRsrc
specifier|private
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|userRsrc
decl_stmt|;
DECL|field|secretManager
specifier|private
name|JobTokenSecretManager
name|secretManager
decl_stmt|;
DECL|field|stateDb
specifier|private
name|DB
name|stateDb
init|=
literal|null
decl_stmt|;
DECL|field|MAPREDUCE_SHUFFLE_SERVICEID
specifier|public
specifier|static
specifier|final
name|String
name|MAPREDUCE_SHUFFLE_SERVICEID
init|=
literal|"mapreduce_shuffle"
decl_stmt|;
DECL|field|SHUFFLE_PORT_CONFIG_KEY
specifier|public
specifier|static
specifier|final
name|String
name|SHUFFLE_PORT_CONFIG_KEY
init|=
literal|"mapreduce.shuffle.port"
decl_stmt|;
DECL|field|DEFAULT_SHUFFLE_PORT
specifier|public
specifier|static
specifier|final
name|int
name|DEFAULT_SHUFFLE_PORT
init|=
literal|13562
decl_stmt|;
DECL|field|SHUFFLE_LISTEN_QUEUE_SIZE
specifier|public
specifier|static
specifier|final
name|String
name|SHUFFLE_LISTEN_QUEUE_SIZE
init|=
literal|"mapreduce.shuffle.listen.queue.size"
decl_stmt|;
DECL|field|DEFAULT_SHUFFLE_LISTEN_QUEUE_SIZE
specifier|public
specifier|static
specifier|final
name|int
name|DEFAULT_SHUFFLE_LISTEN_QUEUE_SIZE
init|=
literal|128
decl_stmt|;
DECL|field|SHUFFLE_CONNECTION_KEEP_ALIVE_ENABLED
specifier|public
specifier|static
specifier|final
name|String
name|SHUFFLE_CONNECTION_KEEP_ALIVE_ENABLED
init|=
literal|"mapreduce.shuffle.connection-keep-alive.enable"
decl_stmt|;
DECL|field|DEFAULT_SHUFFLE_CONNECTION_KEEP_ALIVE_ENABLED
specifier|public
specifier|static
specifier|final
name|boolean
name|DEFAULT_SHUFFLE_CONNECTION_KEEP_ALIVE_ENABLED
init|=
literal|false
decl_stmt|;
DECL|field|SHUFFLE_CONNECTION_KEEP_ALIVE_TIME_OUT
specifier|public
specifier|static
specifier|final
name|String
name|SHUFFLE_CONNECTION_KEEP_ALIVE_TIME_OUT
init|=
literal|"mapreduce.shuffle.connection-keep-alive.timeout"
decl_stmt|;
DECL|field|DEFAULT_SHUFFLE_CONNECTION_KEEP_ALIVE_TIME_OUT
specifier|public
specifier|static
specifier|final
name|int
name|DEFAULT_SHUFFLE_CONNECTION_KEEP_ALIVE_TIME_OUT
init|=
literal|5
decl_stmt|;
comment|//seconds
DECL|field|SHUFFLE_MAPOUTPUT_META_INFO_CACHE_SIZE
specifier|public
specifier|static
specifier|final
name|String
name|SHUFFLE_MAPOUTPUT_META_INFO_CACHE_SIZE
init|=
literal|"mapreduce.shuffle.mapoutput-info.meta.cache.size"
decl_stmt|;
DECL|field|DEFAULT_SHUFFLE_MAPOUTPUT_META_INFO_CACHE_SIZE
specifier|public
specifier|static
specifier|final
name|int
name|DEFAULT_SHUFFLE_MAPOUTPUT_META_INFO_CACHE_SIZE
init|=
literal|1000
decl_stmt|;
DECL|field|CONNECTION_CLOSE
specifier|public
specifier|static
specifier|final
name|String
name|CONNECTION_CLOSE
init|=
literal|"close"
decl_stmt|;
DECL|field|SUFFLE_SSL_FILE_BUFFER_SIZE_KEY
specifier|public
specifier|static
specifier|final
name|String
name|SUFFLE_SSL_FILE_BUFFER_SIZE_KEY
init|=
literal|"mapreduce.shuffle.ssl.file.buffer.size"
decl_stmt|;
DECL|field|DEFAULT_SUFFLE_SSL_FILE_BUFFER_SIZE
specifier|public
specifier|static
specifier|final
name|int
name|DEFAULT_SUFFLE_SSL_FILE_BUFFER_SIZE
init|=
literal|60
operator|*
literal|1024
decl_stmt|;
DECL|field|MAX_SHUFFLE_CONNECTIONS
specifier|public
specifier|static
specifier|final
name|String
name|MAX_SHUFFLE_CONNECTIONS
init|=
literal|"mapreduce.shuffle.max.connections"
decl_stmt|;
DECL|field|DEFAULT_MAX_SHUFFLE_CONNECTIONS
specifier|public
specifier|static
specifier|final
name|int
name|DEFAULT_MAX_SHUFFLE_CONNECTIONS
init|=
literal|0
decl_stmt|;
comment|// 0 implies no limit
DECL|field|MAX_SHUFFLE_THREADS
specifier|public
specifier|static
specifier|final
name|String
name|MAX_SHUFFLE_THREADS
init|=
literal|"mapreduce.shuffle.max.threads"
decl_stmt|;
comment|// 0 implies Netty default of 2 * number of available processors
DECL|field|DEFAULT_MAX_SHUFFLE_THREADS
specifier|public
specifier|static
specifier|final
name|int
name|DEFAULT_MAX_SHUFFLE_THREADS
init|=
literal|0
decl_stmt|;
DECL|field|SHUFFLE_BUFFER_SIZE
specifier|public
specifier|static
specifier|final
name|String
name|SHUFFLE_BUFFER_SIZE
init|=
literal|"mapreduce.shuffle.transfer.buffer.size"
decl_stmt|;
DECL|field|DEFAULT_SHUFFLE_BUFFER_SIZE
specifier|public
specifier|static
specifier|final
name|int
name|DEFAULT_SHUFFLE_BUFFER_SIZE
init|=
literal|128
operator|*
literal|1024
decl_stmt|;
DECL|field|SHUFFLE_TRANSFERTO_ALLOWED
specifier|public
specifier|static
specifier|final
name|String
name|SHUFFLE_TRANSFERTO_ALLOWED
init|=
literal|"mapreduce.shuffle.transferTo.allowed"
decl_stmt|;
DECL|field|DEFAULT_SHUFFLE_TRANSFERTO_ALLOWED
specifier|public
specifier|static
specifier|final
name|boolean
name|DEFAULT_SHUFFLE_TRANSFERTO_ALLOWED
init|=
literal|true
decl_stmt|;
DECL|field|WINDOWS_DEFAULT_SHUFFLE_TRANSFERTO_ALLOWED
specifier|public
specifier|static
specifier|final
name|boolean
name|WINDOWS_DEFAULT_SHUFFLE_TRANSFERTO_ALLOWED
init|=
literal|false
decl_stmt|;
DECL|field|TIMEOUT_HANDLER
specifier|private
specifier|static
specifier|final
name|String
name|TIMEOUT_HANDLER
init|=
literal|"timeout"
decl_stmt|;
comment|/* the maximum number of files a single GET request can    open simultaneously during shuffle    */
DECL|field|SHUFFLE_MAX_SESSION_OPEN_FILES
specifier|public
specifier|static
specifier|final
name|String
name|SHUFFLE_MAX_SESSION_OPEN_FILES
init|=
literal|"mapreduce.shuffle.max.session-open-files"
decl_stmt|;
DECL|field|DEFAULT_SHUFFLE_MAX_SESSION_OPEN_FILES
specifier|public
specifier|static
specifier|final
name|int
name|DEFAULT_SHUFFLE_MAX_SESSION_OPEN_FILES
init|=
literal|3
decl_stmt|;
DECL|field|connectionKeepAliveEnabled
name|boolean
name|connectionKeepAliveEnabled
init|=
literal|false
decl_stmt|;
DECL|field|connectionKeepAliveTimeOut
specifier|private
name|int
name|connectionKeepAliveTimeOut
decl_stmt|;
DECL|field|mapOutputMetaInfoCacheSize
specifier|private
name|int
name|mapOutputMetaInfoCacheSize
decl_stmt|;
DECL|field|timer
specifier|private
name|Timer
name|timer
decl_stmt|;
annotation|@
name|Metrics
argument_list|(
name|about
operator|=
literal|"Shuffle output metrics"
argument_list|,
name|context
operator|=
literal|"mapred"
argument_list|)
DECL|class|ShuffleMetrics
specifier|static
class|class
name|ShuffleMetrics
implements|implements
name|ChannelFutureListener
block|{
annotation|@
name|Metric
argument_list|(
literal|"Shuffle output in bytes"
argument_list|)
DECL|field|shuffleOutputBytes
name|MutableCounterLong
name|shuffleOutputBytes
decl_stmt|;
annotation|@
name|Metric
argument_list|(
literal|"# of failed shuffle outputs"
argument_list|)
DECL|field|shuffleOutputsFailed
name|MutableCounterInt
name|shuffleOutputsFailed
decl_stmt|;
annotation|@
name|Metric
argument_list|(
literal|"# of succeeeded shuffle outputs"
argument_list|)
DECL|field|shuffleOutputsOK
name|MutableCounterInt
name|shuffleOutputsOK
decl_stmt|;
annotation|@
name|Metric
argument_list|(
literal|"# of current shuffle connections"
argument_list|)
DECL|field|shuffleConnections
name|MutableGaugeInt
name|shuffleConnections
decl_stmt|;
annotation|@
name|Override
DECL|method|operationComplete (ChannelFuture future)
specifier|public
name|void
name|operationComplete
parameter_list|(
name|ChannelFuture
name|future
parameter_list|)
throws|throws
name|Exception
block|{
if|if
condition|(
name|future
operator|.
name|isSuccess
argument_list|()
condition|)
block|{
name|shuffleOutputsOK
operator|.
name|incr
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|shuffleOutputsFailed
operator|.
name|incr
argument_list|()
expr_stmt|;
block|}
name|shuffleConnections
operator|.
name|decr
argument_list|()
expr_stmt|;
block|}
block|}
DECL|field|metrics
specifier|final
name|ShuffleMetrics
name|metrics
decl_stmt|;
DECL|class|ReduceMapFileCount
class|class
name|ReduceMapFileCount
implements|implements
name|ChannelFutureListener
block|{
DECL|field|reduceContext
specifier|private
name|ReduceContext
name|reduceContext
decl_stmt|;
DECL|method|ReduceMapFileCount (ReduceContext rc)
specifier|public
name|ReduceMapFileCount
parameter_list|(
name|ReduceContext
name|rc
parameter_list|)
block|{
name|this
operator|.
name|reduceContext
operator|=
name|rc
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|operationComplete (ChannelFuture future)
specifier|public
name|void
name|operationComplete
parameter_list|(
name|ChannelFuture
name|future
parameter_list|)
throws|throws
name|Exception
block|{
if|if
condition|(
operator|!
name|future
operator|.
name|isSuccess
argument_list|()
condition|)
block|{
name|future
operator|.
name|getChannel
argument_list|()
operator|.
name|close
argument_list|()
expr_stmt|;
return|return;
block|}
name|int
name|waitCount
init|=
name|this
operator|.
name|reduceContext
operator|.
name|getMapsToWait
argument_list|()
operator|.
name|decrementAndGet
argument_list|()
decl_stmt|;
if|if
condition|(
name|waitCount
operator|==
literal|0
condition|)
block|{
name|metrics
operator|.
name|operationComplete
argument_list|(
name|future
argument_list|)
expr_stmt|;
comment|// Let the idle timer handler close keep-alive connections
if|if
condition|(
name|reduceContext
operator|.
name|getKeepAlive
argument_list|()
condition|)
block|{
name|ChannelPipeline
name|pipeline
init|=
name|future
operator|.
name|getChannel
argument_list|()
operator|.
name|getPipeline
argument_list|()
decl_stmt|;
name|TimeoutHandler
name|timeoutHandler
init|=
operator|(
name|TimeoutHandler
operator|)
name|pipeline
operator|.
name|get
argument_list|(
name|TIMEOUT_HANDLER
argument_list|)
decl_stmt|;
name|timeoutHandler
operator|.
name|setEnabledTimeout
argument_list|(
literal|true
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|future
operator|.
name|getChannel
argument_list|()
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
block|}
else|else
block|{
name|pipelineFact
operator|.
name|getSHUFFLE
argument_list|()
operator|.
name|sendMap
argument_list|(
name|reduceContext
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/**    * Maintain parameters per messageReceived() Netty context.    * Allows sendMapOutput calls from operationComplete()    */
DECL|class|ReduceContext
specifier|private
specifier|static
class|class
name|ReduceContext
block|{
DECL|field|mapIds
specifier|private
name|List
argument_list|<
name|String
argument_list|>
name|mapIds
decl_stmt|;
DECL|field|mapsToWait
specifier|private
name|AtomicInteger
name|mapsToWait
decl_stmt|;
DECL|field|mapsToSend
specifier|private
name|AtomicInteger
name|mapsToSend
decl_stmt|;
DECL|field|reduceId
specifier|private
name|int
name|reduceId
decl_stmt|;
DECL|field|ctx
specifier|private
name|ChannelHandlerContext
name|ctx
decl_stmt|;
DECL|field|user
specifier|private
name|String
name|user
decl_stmt|;
DECL|field|infoMap
specifier|private
name|Map
argument_list|<
name|String
argument_list|,
name|Shuffle
operator|.
name|MapOutputInfo
argument_list|>
name|infoMap
decl_stmt|;
DECL|field|jobId
specifier|private
name|String
name|jobId
decl_stmt|;
DECL|field|keepAlive
specifier|private
specifier|final
name|boolean
name|keepAlive
decl_stmt|;
DECL|method|ReduceContext (List<String> mapIds, int rId, ChannelHandlerContext context, String usr, Map<String, Shuffle.MapOutputInfo> mapOutputInfoMap, String jobId, boolean keepAlive)
specifier|public
name|ReduceContext
parameter_list|(
name|List
argument_list|<
name|String
argument_list|>
name|mapIds
parameter_list|,
name|int
name|rId
parameter_list|,
name|ChannelHandlerContext
name|context
parameter_list|,
name|String
name|usr
parameter_list|,
name|Map
argument_list|<
name|String
argument_list|,
name|Shuffle
operator|.
name|MapOutputInfo
argument_list|>
name|mapOutputInfoMap
parameter_list|,
name|String
name|jobId
parameter_list|,
name|boolean
name|keepAlive
parameter_list|)
block|{
name|this
operator|.
name|mapIds
operator|=
name|mapIds
expr_stmt|;
name|this
operator|.
name|reduceId
operator|=
name|rId
expr_stmt|;
comment|/**       * Atomic count for tracking the no. of map outputs that are yet to       * complete. Multiple futureListeners' operationComplete() can decrement       * this value asynchronously. It is used to decide when the channel should       * be closed.       */
name|this
operator|.
name|mapsToWait
operator|=
operator|new
name|AtomicInteger
argument_list|(
name|mapIds
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
comment|/**       * Atomic count for tracking the no. of map outputs that have been sent.       * Multiple sendMap() calls can increment this value       * asynchronously. Used to decide which mapId should be sent next.       */
name|this
operator|.
name|mapsToSend
operator|=
operator|new
name|AtomicInteger
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|this
operator|.
name|ctx
operator|=
name|context
expr_stmt|;
name|this
operator|.
name|user
operator|=
name|usr
expr_stmt|;
name|this
operator|.
name|infoMap
operator|=
name|mapOutputInfoMap
expr_stmt|;
name|this
operator|.
name|jobId
operator|=
name|jobId
expr_stmt|;
name|this
operator|.
name|keepAlive
operator|=
name|keepAlive
expr_stmt|;
block|}
DECL|method|getReduceId ()
specifier|public
name|int
name|getReduceId
parameter_list|()
block|{
return|return
name|reduceId
return|;
block|}
DECL|method|getCtx ()
specifier|public
name|ChannelHandlerContext
name|getCtx
parameter_list|()
block|{
return|return
name|ctx
return|;
block|}
DECL|method|getUser ()
specifier|public
name|String
name|getUser
parameter_list|()
block|{
return|return
name|user
return|;
block|}
DECL|method|getInfoMap ()
specifier|public
name|Map
argument_list|<
name|String
argument_list|,
name|Shuffle
operator|.
name|MapOutputInfo
argument_list|>
name|getInfoMap
parameter_list|()
block|{
return|return
name|infoMap
return|;
block|}
DECL|method|getJobId ()
specifier|public
name|String
name|getJobId
parameter_list|()
block|{
return|return
name|jobId
return|;
block|}
DECL|method|getMapIds ()
specifier|public
name|List
argument_list|<
name|String
argument_list|>
name|getMapIds
parameter_list|()
block|{
return|return
name|mapIds
return|;
block|}
DECL|method|getMapsToSend ()
specifier|public
name|AtomicInteger
name|getMapsToSend
parameter_list|()
block|{
return|return
name|mapsToSend
return|;
block|}
DECL|method|getMapsToWait ()
specifier|public
name|AtomicInteger
name|getMapsToWait
parameter_list|()
block|{
return|return
name|mapsToWait
return|;
block|}
DECL|method|getKeepAlive ()
specifier|public
name|boolean
name|getKeepAlive
parameter_list|()
block|{
return|return
name|keepAlive
return|;
block|}
block|}
DECL|method|ShuffleHandler (MetricsSystem ms)
name|ShuffleHandler
parameter_list|(
name|MetricsSystem
name|ms
parameter_list|)
block|{
name|super
argument_list|(
name|MAPREDUCE_SHUFFLE_SERVICEID
argument_list|)
expr_stmt|;
name|metrics
operator|=
name|ms
operator|.
name|register
argument_list|(
operator|new
name|ShuffleMetrics
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|ShuffleHandler ()
specifier|public
name|ShuffleHandler
parameter_list|()
block|{
name|this
argument_list|(
name|DefaultMetricsSystem
operator|.
name|instance
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|/**    * Serialize the shuffle port into a ByteBuffer for use later on.    * @param port the port to be sent to the ApplciationMaster    * @return the serialized form of the port.    */
DECL|method|serializeMetaData (int port)
specifier|public
specifier|static
name|ByteBuffer
name|serializeMetaData
parameter_list|(
name|int
name|port
parameter_list|)
throws|throws
name|IOException
block|{
comment|//TODO these bytes should be versioned
name|DataOutputBuffer
name|port_dob
init|=
operator|new
name|DataOutputBuffer
argument_list|()
decl_stmt|;
name|port_dob
operator|.
name|writeInt
argument_list|(
name|port
argument_list|)
expr_stmt|;
return|return
name|ByteBuffer
operator|.
name|wrap
argument_list|(
name|port_dob
operator|.
name|getData
argument_list|()
argument_list|,
literal|0
argument_list|,
name|port_dob
operator|.
name|getLength
argument_list|()
argument_list|)
return|;
block|}
comment|/**    * A helper function to deserialize the metadata returned by ShuffleHandler.    * @param meta the metadata returned by the ShuffleHandler    * @return the port the Shuffle Handler is listening on to serve shuffle data.    */
DECL|method|deserializeMetaData (ByteBuffer meta)
specifier|public
specifier|static
name|int
name|deserializeMetaData
parameter_list|(
name|ByteBuffer
name|meta
parameter_list|)
throws|throws
name|IOException
block|{
comment|//TODO this should be returning a class not just an int
name|DataInputByteBuffer
name|in
init|=
operator|new
name|DataInputByteBuffer
argument_list|()
decl_stmt|;
name|in
operator|.
name|reset
argument_list|(
name|meta
argument_list|)
expr_stmt|;
name|int
name|port
init|=
name|in
operator|.
name|readInt
argument_list|()
decl_stmt|;
return|return
name|port
return|;
block|}
comment|/**    * A helper function to serialize the JobTokenIdentifier to be sent to the    * ShuffleHandler as ServiceData.    * @param jobToken the job token to be used for authentication of    * shuffle data requests.    * @return the serialized version of the jobToken.    */
DECL|method|serializeServiceData (Token<JobTokenIdentifier> jobToken)
specifier|public
specifier|static
name|ByteBuffer
name|serializeServiceData
parameter_list|(
name|Token
argument_list|<
name|JobTokenIdentifier
argument_list|>
name|jobToken
parameter_list|)
throws|throws
name|IOException
block|{
comment|//TODO these bytes should be versioned
name|DataOutputBuffer
name|jobToken_dob
init|=
operator|new
name|DataOutputBuffer
argument_list|()
decl_stmt|;
name|jobToken
operator|.
name|write
argument_list|(
name|jobToken_dob
argument_list|)
expr_stmt|;
return|return
name|ByteBuffer
operator|.
name|wrap
argument_list|(
name|jobToken_dob
operator|.
name|getData
argument_list|()
argument_list|,
literal|0
argument_list|,
name|jobToken_dob
operator|.
name|getLength
argument_list|()
argument_list|)
return|;
block|}
DECL|method|deserializeServiceData (ByteBuffer secret)
specifier|static
name|Token
argument_list|<
name|JobTokenIdentifier
argument_list|>
name|deserializeServiceData
parameter_list|(
name|ByteBuffer
name|secret
parameter_list|)
throws|throws
name|IOException
block|{
name|DataInputByteBuffer
name|in
init|=
operator|new
name|DataInputByteBuffer
argument_list|()
decl_stmt|;
name|in
operator|.
name|reset
argument_list|(
name|secret
argument_list|)
expr_stmt|;
name|Token
argument_list|<
name|JobTokenIdentifier
argument_list|>
name|jt
init|=
operator|new
name|Token
argument_list|<
name|JobTokenIdentifier
argument_list|>
argument_list|()
decl_stmt|;
name|jt
operator|.
name|readFields
argument_list|(
name|in
argument_list|)
expr_stmt|;
return|return
name|jt
return|;
block|}
annotation|@
name|Override
DECL|method|initializeApplication (ApplicationInitializationContext context)
specifier|public
name|void
name|initializeApplication
parameter_list|(
name|ApplicationInitializationContext
name|context
parameter_list|)
block|{
name|String
name|user
init|=
name|context
operator|.
name|getUser
argument_list|()
decl_stmt|;
name|ApplicationId
name|appId
init|=
name|context
operator|.
name|getApplicationId
argument_list|()
decl_stmt|;
name|ByteBuffer
name|secret
init|=
name|context
operator|.
name|getApplicationDataForService
argument_list|()
decl_stmt|;
comment|// TODO these bytes should be versioned
try|try
block|{
name|Token
argument_list|<
name|JobTokenIdentifier
argument_list|>
name|jt
init|=
name|deserializeServiceData
argument_list|(
name|secret
argument_list|)
decl_stmt|;
comment|// TODO: Once SHuffle is out of NM, this can use MR APIs
name|JobID
name|jobId
init|=
operator|new
name|JobID
argument_list|(
name|Long
operator|.
name|toString
argument_list|(
name|appId
operator|.
name|getClusterTimestamp
argument_list|()
argument_list|)
argument_list|,
name|appId
operator|.
name|getId
argument_list|()
argument_list|)
decl_stmt|;
name|recordJobShuffleInfo
argument_list|(
name|jobId
argument_list|,
name|user
argument_list|,
name|jt
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Error during initApp"
argument_list|,
name|e
argument_list|)
expr_stmt|;
comment|// TODO add API to AuxiliaryServices to report failures
block|}
block|}
annotation|@
name|Override
DECL|method|stopApplication (ApplicationTerminationContext context)
specifier|public
name|void
name|stopApplication
parameter_list|(
name|ApplicationTerminationContext
name|context
parameter_list|)
block|{
name|ApplicationId
name|appId
init|=
name|context
operator|.
name|getApplicationId
argument_list|()
decl_stmt|;
name|JobID
name|jobId
init|=
operator|new
name|JobID
argument_list|(
name|Long
operator|.
name|toString
argument_list|(
name|appId
operator|.
name|getClusterTimestamp
argument_list|()
argument_list|)
argument_list|,
name|appId
operator|.
name|getId
argument_list|()
argument_list|)
decl_stmt|;
try|try
block|{
name|removeJobShuffleInfo
argument_list|(
name|jobId
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Error during stopApp"
argument_list|,
name|e
argument_list|)
expr_stmt|;
comment|// TODO add API to AuxiliaryServices to report failures
block|}
block|}
annotation|@
name|Override
DECL|method|serviceInit (Configuration conf)
specifier|protected
name|void
name|serviceInit
parameter_list|(
name|Configuration
name|conf
parameter_list|)
throws|throws
name|Exception
block|{
name|manageOsCache
operator|=
name|conf
operator|.
name|getBoolean
argument_list|(
name|SHUFFLE_MANAGE_OS_CACHE
argument_list|,
name|DEFAULT_SHUFFLE_MANAGE_OS_CACHE
argument_list|)
expr_stmt|;
name|readaheadLength
operator|=
name|conf
operator|.
name|getInt
argument_list|(
name|SHUFFLE_READAHEAD_BYTES
argument_list|,
name|DEFAULT_SHUFFLE_READAHEAD_BYTES
argument_list|)
expr_stmt|;
name|maxShuffleConnections
operator|=
name|conf
operator|.
name|getInt
argument_list|(
name|MAX_SHUFFLE_CONNECTIONS
argument_list|,
name|DEFAULT_MAX_SHUFFLE_CONNECTIONS
argument_list|)
expr_stmt|;
name|int
name|maxShuffleThreads
init|=
name|conf
operator|.
name|getInt
argument_list|(
name|MAX_SHUFFLE_THREADS
argument_list|,
name|DEFAULT_MAX_SHUFFLE_THREADS
argument_list|)
decl_stmt|;
if|if
condition|(
name|maxShuffleThreads
operator|==
literal|0
condition|)
block|{
name|maxShuffleThreads
operator|=
literal|2
operator|*
name|Runtime
operator|.
name|getRuntime
argument_list|()
operator|.
name|availableProcessors
argument_list|()
expr_stmt|;
block|}
name|shuffleBufferSize
operator|=
name|conf
operator|.
name|getInt
argument_list|(
name|SHUFFLE_BUFFER_SIZE
argument_list|,
name|DEFAULT_SHUFFLE_BUFFER_SIZE
argument_list|)
expr_stmt|;
name|shuffleTransferToAllowed
operator|=
name|conf
operator|.
name|getBoolean
argument_list|(
name|SHUFFLE_TRANSFERTO_ALLOWED
argument_list|,
operator|(
name|Shell
operator|.
name|WINDOWS
operator|)
condition|?
name|WINDOWS_DEFAULT_SHUFFLE_TRANSFERTO_ALLOWED
else|:
name|DEFAULT_SHUFFLE_TRANSFERTO_ALLOWED
argument_list|)
expr_stmt|;
name|maxSessionOpenFiles
operator|=
name|conf
operator|.
name|getInt
argument_list|(
name|SHUFFLE_MAX_SESSION_OPEN_FILES
argument_list|,
name|DEFAULT_SHUFFLE_MAX_SESSION_OPEN_FILES
argument_list|)
expr_stmt|;
name|ThreadFactory
name|bossFactory
init|=
operator|new
name|ThreadFactoryBuilder
argument_list|()
operator|.
name|setNameFormat
argument_list|(
literal|"ShuffleHandler Netty Boss #%d"
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
name|ThreadFactory
name|workerFactory
init|=
operator|new
name|ThreadFactoryBuilder
argument_list|()
operator|.
name|setNameFormat
argument_list|(
literal|"ShuffleHandler Netty Worker #%d"
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
name|selector
operator|=
operator|new
name|NioServerSocketChannelFactory
argument_list|(
name|HadoopExecutors
operator|.
name|newCachedThreadPool
argument_list|(
name|bossFactory
argument_list|)
argument_list|,
name|HadoopExecutors
operator|.
name|newCachedThreadPool
argument_list|(
name|workerFactory
argument_list|)
argument_list|,
name|maxShuffleThreads
argument_list|)
expr_stmt|;
name|super
operator|.
name|serviceInit
argument_list|(
operator|new
name|Configuration
argument_list|(
name|conf
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|// TODO change AbstractService to throw InterruptedException
annotation|@
name|Override
DECL|method|serviceStart ()
specifier|protected
name|void
name|serviceStart
parameter_list|()
throws|throws
name|Exception
block|{
name|Configuration
name|conf
init|=
name|getConfig
argument_list|()
decl_stmt|;
name|userRsrc
operator|=
operator|new
name|ConcurrentHashMap
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
argument_list|()
expr_stmt|;
name|secretManager
operator|=
operator|new
name|JobTokenSecretManager
argument_list|()
expr_stmt|;
name|recoverState
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|ServerBootstrap
name|bootstrap
init|=
operator|new
name|ServerBootstrap
argument_list|(
name|selector
argument_list|)
decl_stmt|;
comment|// Timer is shared across entire factory and must be released separately
name|timer
operator|=
operator|new
name|HashedWheelTimer
argument_list|()
expr_stmt|;
try|try
block|{
name|pipelineFact
operator|=
operator|new
name|HttpPipelineFactory
argument_list|(
name|conf
argument_list|,
name|timer
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|ex
parameter_list|)
block|{
throw|throw
operator|new
name|RuntimeException
argument_list|(
name|ex
argument_list|)
throw|;
block|}
name|bootstrap
operator|.
name|setOption
argument_list|(
literal|"backlog"
argument_list|,
name|conf
operator|.
name|getInt
argument_list|(
name|SHUFFLE_LISTEN_QUEUE_SIZE
argument_list|,
name|DEFAULT_SHUFFLE_LISTEN_QUEUE_SIZE
argument_list|)
argument_list|)
expr_stmt|;
name|bootstrap
operator|.
name|setOption
argument_list|(
literal|"child.keepAlive"
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|bootstrap
operator|.
name|setPipelineFactory
argument_list|(
name|pipelineFact
argument_list|)
expr_stmt|;
name|port
operator|=
name|conf
operator|.
name|getInt
argument_list|(
name|SHUFFLE_PORT_CONFIG_KEY
argument_list|,
name|DEFAULT_SHUFFLE_PORT
argument_list|)
expr_stmt|;
name|Channel
name|ch
init|=
name|bootstrap
operator|.
name|bind
argument_list|(
operator|new
name|InetSocketAddress
argument_list|(
name|port
argument_list|)
argument_list|)
decl_stmt|;
name|accepted
operator|.
name|add
argument_list|(
name|ch
argument_list|)
expr_stmt|;
name|port
operator|=
operator|(
operator|(
name|InetSocketAddress
operator|)
name|ch
operator|.
name|getLocalAddress
argument_list|()
operator|)
operator|.
name|getPort
argument_list|()
expr_stmt|;
name|conf
operator|.
name|set
argument_list|(
name|SHUFFLE_PORT_CONFIG_KEY
argument_list|,
name|Integer
operator|.
name|toString
argument_list|(
name|port
argument_list|)
argument_list|)
expr_stmt|;
name|pipelineFact
operator|.
name|SHUFFLE
operator|.
name|setPort
argument_list|(
name|port
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
name|getName
argument_list|()
operator|+
literal|" listening on port "
operator|+
name|port
argument_list|)
expr_stmt|;
name|super
operator|.
name|serviceStart
argument_list|()
expr_stmt|;
name|sslFileBufferSize
operator|=
name|conf
operator|.
name|getInt
argument_list|(
name|SUFFLE_SSL_FILE_BUFFER_SIZE_KEY
argument_list|,
name|DEFAULT_SUFFLE_SSL_FILE_BUFFER_SIZE
argument_list|)
expr_stmt|;
name|connectionKeepAliveEnabled
operator|=
name|conf
operator|.
name|getBoolean
argument_list|(
name|SHUFFLE_CONNECTION_KEEP_ALIVE_ENABLED
argument_list|,
name|DEFAULT_SHUFFLE_CONNECTION_KEEP_ALIVE_ENABLED
argument_list|)
expr_stmt|;
name|connectionKeepAliveTimeOut
operator|=
name|Math
operator|.
name|max
argument_list|(
literal|1
argument_list|,
name|conf
operator|.
name|getInt
argument_list|(
name|SHUFFLE_CONNECTION_KEEP_ALIVE_TIME_OUT
argument_list|,
name|DEFAULT_SHUFFLE_CONNECTION_KEEP_ALIVE_TIME_OUT
argument_list|)
argument_list|)
expr_stmt|;
name|mapOutputMetaInfoCacheSize
operator|=
name|Math
operator|.
name|max
argument_list|(
literal|1
argument_list|,
name|conf
operator|.
name|getInt
argument_list|(
name|SHUFFLE_MAPOUTPUT_META_INFO_CACHE_SIZE
argument_list|,
name|DEFAULT_SHUFFLE_MAPOUTPUT_META_INFO_CACHE_SIZE
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|serviceStop ()
specifier|protected
name|void
name|serviceStop
parameter_list|()
throws|throws
name|Exception
block|{
name|accepted
operator|.
name|close
argument_list|()
operator|.
name|awaitUninterruptibly
argument_list|(
literal|10
argument_list|,
name|TimeUnit
operator|.
name|SECONDS
argument_list|)
expr_stmt|;
if|if
condition|(
name|selector
operator|!=
literal|null
condition|)
block|{
name|ServerBootstrap
name|bootstrap
init|=
operator|new
name|ServerBootstrap
argument_list|(
name|selector
argument_list|)
decl_stmt|;
name|bootstrap
operator|.
name|releaseExternalResources
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|pipelineFact
operator|!=
literal|null
condition|)
block|{
name|pipelineFact
operator|.
name|destroy
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|timer
operator|!=
literal|null
condition|)
block|{
comment|// Release this shared timer resource
name|timer
operator|.
name|stop
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|stateDb
operator|!=
literal|null
condition|)
block|{
name|stateDb
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
name|super
operator|.
name|serviceStop
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|getMetaData ()
specifier|public
specifier|synchronized
name|ByteBuffer
name|getMetaData
parameter_list|()
block|{
try|try
block|{
return|return
name|serializeMetaData
argument_list|(
name|port
argument_list|)
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Error during getMeta"
argument_list|,
name|e
argument_list|)
expr_stmt|;
comment|// TODO add API to AuxiliaryServices to report failures
return|return
literal|null
return|;
block|}
block|}
DECL|method|getShuffle (Configuration conf)
specifier|protected
name|Shuffle
name|getShuffle
parameter_list|(
name|Configuration
name|conf
parameter_list|)
block|{
return|return
operator|new
name|Shuffle
argument_list|(
name|conf
argument_list|)
return|;
block|}
DECL|method|recoverState (Configuration conf)
specifier|private
name|void
name|recoverState
parameter_list|(
name|Configuration
name|conf
parameter_list|)
throws|throws
name|IOException
block|{
name|Path
name|recoveryRoot
init|=
name|getRecoveryPath
argument_list|()
decl_stmt|;
if|if
condition|(
name|recoveryRoot
operator|!=
literal|null
condition|)
block|{
name|startStore
argument_list|(
name|recoveryRoot
argument_list|)
expr_stmt|;
name|Pattern
name|jobPattern
init|=
name|Pattern
operator|.
name|compile
argument_list|(
name|JobID
operator|.
name|JOBID_REGEX
argument_list|)
decl_stmt|;
name|LeveldbIterator
name|iter
init|=
literal|null
decl_stmt|;
try|try
block|{
name|iter
operator|=
operator|new
name|LeveldbIterator
argument_list|(
name|stateDb
argument_list|)
expr_stmt|;
name|iter
operator|.
name|seek
argument_list|(
name|bytes
argument_list|(
name|JobID
operator|.
name|JOB
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|iter
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|Map
operator|.
name|Entry
argument_list|<
name|byte
index|[]
argument_list|,
name|byte
index|[]
argument_list|>
name|entry
init|=
name|iter
operator|.
name|next
argument_list|()
decl_stmt|;
name|String
name|key
init|=
name|asString
argument_list|(
name|entry
operator|.
name|getKey
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|jobPattern
operator|.
name|matcher
argument_list|(
name|key
argument_list|)
operator|.
name|matches
argument_list|()
condition|)
block|{
break|break;
block|}
name|recoverJobShuffleInfo
argument_list|(
name|key
argument_list|,
name|entry
operator|.
name|getValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|DBException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Database error during recovery"
argument_list|,
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
if|if
condition|(
name|iter
operator|!=
literal|null
condition|)
block|{
name|iter
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
block|}
block|}
block|}
DECL|method|startStore (Path recoveryRoot)
specifier|private
name|void
name|startStore
parameter_list|(
name|Path
name|recoveryRoot
parameter_list|)
throws|throws
name|IOException
block|{
name|Options
name|options
init|=
operator|new
name|Options
argument_list|()
decl_stmt|;
name|options
operator|.
name|createIfMissing
argument_list|(
literal|false
argument_list|)
expr_stmt|;
name|options
operator|.
name|logger
argument_list|(
operator|new
name|LevelDBLogger
argument_list|()
argument_list|)
expr_stmt|;
name|Path
name|dbPath
init|=
operator|new
name|Path
argument_list|(
name|recoveryRoot
argument_list|,
name|STATE_DB_NAME
argument_list|)
decl_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Using state database at "
operator|+
name|dbPath
operator|+
literal|" for recovery"
argument_list|)
expr_stmt|;
name|File
name|dbfile
init|=
operator|new
name|File
argument_list|(
name|dbPath
operator|.
name|toString
argument_list|()
argument_list|)
decl_stmt|;
try|try
block|{
name|stateDb
operator|=
name|JniDBFactory
operator|.
name|factory
operator|.
name|open
argument_list|(
name|dbfile
argument_list|,
name|options
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|NativeDB
operator|.
name|DBException
name|e
parameter_list|)
block|{
if|if
condition|(
name|e
operator|.
name|isNotFound
argument_list|()
operator|||
name|e
operator|.
name|getMessage
argument_list|()
operator|.
name|contains
argument_list|(
literal|" does not exist "
argument_list|)
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Creating state database at "
operator|+
name|dbfile
argument_list|)
expr_stmt|;
name|options
operator|.
name|createIfMissing
argument_list|(
literal|true
argument_list|)
expr_stmt|;
try|try
block|{
name|stateDb
operator|=
name|JniDBFactory
operator|.
name|factory
operator|.
name|open
argument_list|(
name|dbfile
argument_list|,
name|options
argument_list|)
expr_stmt|;
name|storeVersion
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|DBException
name|dbExc
parameter_list|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Unable to create state store"
argument_list|,
name|dbExc
argument_list|)
throw|;
block|}
block|}
else|else
block|{
throw|throw
name|e
throw|;
block|}
block|}
name|checkVersion
argument_list|()
expr_stmt|;
block|}
annotation|@
name|VisibleForTesting
DECL|method|loadVersion ()
name|Version
name|loadVersion
parameter_list|()
throws|throws
name|IOException
block|{
name|byte
index|[]
name|data
init|=
name|stateDb
operator|.
name|get
argument_list|(
name|bytes
argument_list|(
name|STATE_DB_SCHEMA_VERSION_KEY
argument_list|)
argument_list|)
decl_stmt|;
comment|// if version is not stored previously, treat it as CURRENT_VERSION_INFO.
if|if
condition|(
name|data
operator|==
literal|null
operator|||
name|data
operator|.
name|length
operator|==
literal|0
condition|)
block|{
return|return
name|getCurrentVersion
argument_list|()
return|;
block|}
name|Version
name|version
init|=
operator|new
name|VersionPBImpl
argument_list|(
name|VersionProto
operator|.
name|parseFrom
argument_list|(
name|data
argument_list|)
argument_list|)
decl_stmt|;
return|return
name|version
return|;
block|}
DECL|method|storeSchemaVersion (Version version)
specifier|private
name|void
name|storeSchemaVersion
parameter_list|(
name|Version
name|version
parameter_list|)
throws|throws
name|IOException
block|{
name|String
name|key
init|=
name|STATE_DB_SCHEMA_VERSION_KEY
decl_stmt|;
name|byte
index|[]
name|data
init|=
operator|(
operator|(
name|VersionPBImpl
operator|)
name|version
operator|)
operator|.
name|getProto
argument_list|()
operator|.
name|toByteArray
argument_list|()
decl_stmt|;
try|try
block|{
name|stateDb
operator|.
name|put
argument_list|(
name|bytes
argument_list|(
name|key
argument_list|)
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|DBException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
DECL|method|storeVersion ()
specifier|private
name|void
name|storeVersion
parameter_list|()
throws|throws
name|IOException
block|{
name|storeSchemaVersion
argument_list|(
name|CURRENT_VERSION_INFO
argument_list|)
expr_stmt|;
block|}
comment|// Only used for test
annotation|@
name|VisibleForTesting
DECL|method|storeVersion (Version version)
name|void
name|storeVersion
parameter_list|(
name|Version
name|version
parameter_list|)
throws|throws
name|IOException
block|{
name|storeSchemaVersion
argument_list|(
name|version
argument_list|)
expr_stmt|;
block|}
DECL|method|getCurrentVersion ()
specifier|protected
name|Version
name|getCurrentVersion
parameter_list|()
block|{
return|return
name|CURRENT_VERSION_INFO
return|;
block|}
comment|/**    * 1) Versioning scheme: major.minor. For e.g. 1.0, 1.1, 1.2...1.25, 2.0 etc.    * 2) Any incompatible change of DB schema is a major upgrade, and any    *    compatible change of DB schema is a minor upgrade.    * 3) Within a minor upgrade, say 1.1 to 1.2:    *    overwrite the version info and proceed as normal.    * 4) Within a major upgrade, say 1.2 to 2.0:    *    throw exception and indicate user to use a separate upgrade tool to    *    upgrade shuffle info or remove incompatible old state.    */
DECL|method|checkVersion ()
specifier|private
name|void
name|checkVersion
parameter_list|()
throws|throws
name|IOException
block|{
name|Version
name|loadedVersion
init|=
name|loadVersion
argument_list|()
decl_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Loaded state DB schema version info "
operator|+
name|loadedVersion
argument_list|)
expr_stmt|;
if|if
condition|(
name|loadedVersion
operator|.
name|equals
argument_list|(
name|getCurrentVersion
argument_list|()
argument_list|)
condition|)
block|{
return|return;
block|}
if|if
condition|(
name|loadedVersion
operator|.
name|isCompatibleTo
argument_list|(
name|getCurrentVersion
argument_list|()
argument_list|)
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Storing state DB schema version info "
operator|+
name|getCurrentVersion
argument_list|()
argument_list|)
expr_stmt|;
name|storeVersion
argument_list|()
expr_stmt|;
block|}
else|else
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Incompatible version for state DB schema: expecting DB schema version "
operator|+
name|getCurrentVersion
argument_list|()
operator|+
literal|", but loading version "
operator|+
name|loadedVersion
argument_list|)
throw|;
block|}
block|}
DECL|method|addJobToken (JobID jobId, String user, Token<JobTokenIdentifier> jobToken)
specifier|private
name|void
name|addJobToken
parameter_list|(
name|JobID
name|jobId
parameter_list|,
name|String
name|user
parameter_list|,
name|Token
argument_list|<
name|JobTokenIdentifier
argument_list|>
name|jobToken
parameter_list|)
block|{
name|userRsrc
operator|.
name|put
argument_list|(
name|jobId
operator|.
name|toString
argument_list|()
argument_list|,
name|user
argument_list|)
expr_stmt|;
name|secretManager
operator|.
name|addTokenForJob
argument_list|(
name|jobId
operator|.
name|toString
argument_list|()
argument_list|,
name|jobToken
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Added token for "
operator|+
name|jobId
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|recoverJobShuffleInfo (String jobIdStr, byte[] data)
specifier|private
name|void
name|recoverJobShuffleInfo
parameter_list|(
name|String
name|jobIdStr
parameter_list|,
name|byte
index|[]
name|data
parameter_list|)
throws|throws
name|IOException
block|{
name|JobID
name|jobId
decl_stmt|;
try|try
block|{
name|jobId
operator|=
name|JobID
operator|.
name|forName
argument_list|(
name|jobIdStr
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IllegalArgumentException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Bad job ID "
operator|+
name|jobIdStr
operator|+
literal|" in state store"
argument_list|,
name|e
argument_list|)
throw|;
block|}
name|JobShuffleInfoProto
name|proto
init|=
name|JobShuffleInfoProto
operator|.
name|parseFrom
argument_list|(
name|data
argument_list|)
decl_stmt|;
name|String
name|user
init|=
name|proto
operator|.
name|getUser
argument_list|()
decl_stmt|;
name|TokenProto
name|tokenProto
init|=
name|proto
operator|.
name|getJobToken
argument_list|()
decl_stmt|;
name|Token
argument_list|<
name|JobTokenIdentifier
argument_list|>
name|jobToken
init|=
operator|new
name|Token
argument_list|<
name|JobTokenIdentifier
argument_list|>
argument_list|(
name|tokenProto
operator|.
name|getIdentifier
argument_list|()
operator|.
name|toByteArray
argument_list|()
argument_list|,
name|tokenProto
operator|.
name|getPassword
argument_list|()
operator|.
name|toByteArray
argument_list|()
argument_list|,
operator|new
name|Text
argument_list|(
name|tokenProto
operator|.
name|getKind
argument_list|()
argument_list|)
argument_list|,
operator|new
name|Text
argument_list|(
name|tokenProto
operator|.
name|getService
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|addJobToken
argument_list|(
name|jobId
argument_list|,
name|user
argument_list|,
name|jobToken
argument_list|)
expr_stmt|;
block|}
DECL|method|recordJobShuffleInfo (JobID jobId, String user, Token<JobTokenIdentifier> jobToken)
specifier|private
name|void
name|recordJobShuffleInfo
parameter_list|(
name|JobID
name|jobId
parameter_list|,
name|String
name|user
parameter_list|,
name|Token
argument_list|<
name|JobTokenIdentifier
argument_list|>
name|jobToken
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
name|stateDb
operator|!=
literal|null
condition|)
block|{
name|TokenProto
name|tokenProto
init|=
name|TokenProto
operator|.
name|newBuilder
argument_list|()
operator|.
name|setIdentifier
argument_list|(
name|ByteString
operator|.
name|copyFrom
argument_list|(
name|jobToken
operator|.
name|getIdentifier
argument_list|()
argument_list|)
argument_list|)
operator|.
name|setPassword
argument_list|(
name|ByteString
operator|.
name|copyFrom
argument_list|(
name|jobToken
operator|.
name|getPassword
argument_list|()
argument_list|)
argument_list|)
operator|.
name|setKind
argument_list|(
name|jobToken
operator|.
name|getKind
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
operator|.
name|setService
argument_list|(
name|jobToken
operator|.
name|getService
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
name|JobShuffleInfoProto
name|proto
init|=
name|JobShuffleInfoProto
operator|.
name|newBuilder
argument_list|()
operator|.
name|setUser
argument_list|(
name|user
argument_list|)
operator|.
name|setJobToken
argument_list|(
name|tokenProto
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
try|try
block|{
name|stateDb
operator|.
name|put
argument_list|(
name|bytes
argument_list|(
name|jobId
operator|.
name|toString
argument_list|()
argument_list|)
argument_list|,
name|proto
operator|.
name|toByteArray
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|DBException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Error storing "
operator|+
name|jobId
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
name|addJobToken
argument_list|(
name|jobId
argument_list|,
name|user
argument_list|,
name|jobToken
argument_list|)
expr_stmt|;
block|}
DECL|method|removeJobShuffleInfo (JobID jobId)
specifier|private
name|void
name|removeJobShuffleInfo
parameter_list|(
name|JobID
name|jobId
parameter_list|)
throws|throws
name|IOException
block|{
name|String
name|jobIdStr
init|=
name|jobId
operator|.
name|toString
argument_list|()
decl_stmt|;
name|secretManager
operator|.
name|removeTokenForJob
argument_list|(
name|jobIdStr
argument_list|)
expr_stmt|;
name|userRsrc
operator|.
name|remove
argument_list|(
name|jobIdStr
argument_list|)
expr_stmt|;
if|if
condition|(
name|stateDb
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|stateDb
operator|.
name|delete
argument_list|(
name|bytes
argument_list|(
name|jobIdStr
argument_list|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|DBException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Unable to remove "
operator|+
name|jobId
operator|+
literal|" from state store"
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
block|}
DECL|class|LevelDBLogger
specifier|private
specifier|static
class|class
name|LevelDBLogger
implements|implements
name|Logger
block|{
DECL|field|LOG
specifier|private
specifier|static
specifier|final
name|Log
name|LOG
init|=
name|LogFactory
operator|.
name|getLog
argument_list|(
name|LevelDBLogger
operator|.
name|class
argument_list|)
decl_stmt|;
annotation|@
name|Override
DECL|method|log (String message)
specifier|public
name|void
name|log
parameter_list|(
name|String
name|message
parameter_list|)
block|{
name|LOG
operator|.
name|info
argument_list|(
name|message
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|TimeoutHandler
specifier|static
class|class
name|TimeoutHandler
extends|extends
name|IdleStateAwareChannelHandler
block|{
DECL|field|enabledTimeout
specifier|private
name|boolean
name|enabledTimeout
decl_stmt|;
DECL|method|setEnabledTimeout (boolean enabledTimeout)
name|void
name|setEnabledTimeout
parameter_list|(
name|boolean
name|enabledTimeout
parameter_list|)
block|{
name|this
operator|.
name|enabledTimeout
operator|=
name|enabledTimeout
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|channelIdle (ChannelHandlerContext ctx, IdleStateEvent e)
specifier|public
name|void
name|channelIdle
parameter_list|(
name|ChannelHandlerContext
name|ctx
parameter_list|,
name|IdleStateEvent
name|e
parameter_list|)
block|{
if|if
condition|(
name|e
operator|.
name|getState
argument_list|()
operator|==
name|IdleState
operator|.
name|WRITER_IDLE
operator|&&
name|enabledTimeout
condition|)
block|{
name|e
operator|.
name|getChannel
argument_list|()
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
block|}
block|}
DECL|class|HttpPipelineFactory
class|class
name|HttpPipelineFactory
implements|implements
name|ChannelPipelineFactory
block|{
DECL|field|SHUFFLE
specifier|final
name|Shuffle
name|SHUFFLE
decl_stmt|;
DECL|field|sslFactory
specifier|private
name|SSLFactory
name|sslFactory
decl_stmt|;
DECL|field|idleStateHandler
specifier|private
specifier|final
name|ChannelHandler
name|idleStateHandler
decl_stmt|;
DECL|method|HttpPipelineFactory (Configuration conf, Timer timer)
specifier|public
name|HttpPipelineFactory
parameter_list|(
name|Configuration
name|conf
parameter_list|,
name|Timer
name|timer
parameter_list|)
throws|throws
name|Exception
block|{
name|SHUFFLE
operator|=
name|getShuffle
argument_list|(
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|.
name|getBoolean
argument_list|(
name|MRConfig
operator|.
name|SHUFFLE_SSL_ENABLED_KEY
argument_list|,
name|MRConfig
operator|.
name|SHUFFLE_SSL_ENABLED_DEFAULT
argument_list|)
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Encrypted shuffle is enabled."
argument_list|)
expr_stmt|;
name|sslFactory
operator|=
operator|new
name|SSLFactory
argument_list|(
name|SSLFactory
operator|.
name|Mode
operator|.
name|SERVER
argument_list|,
name|conf
argument_list|)
expr_stmt|;
name|sslFactory
operator|.
name|init
argument_list|()
expr_stmt|;
block|}
name|this
operator|.
name|idleStateHandler
operator|=
operator|new
name|IdleStateHandler
argument_list|(
name|timer
argument_list|,
literal|0
argument_list|,
name|connectionKeepAliveTimeOut
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
DECL|method|getSHUFFLE ()
specifier|public
name|Shuffle
name|getSHUFFLE
parameter_list|()
block|{
return|return
name|SHUFFLE
return|;
block|}
DECL|method|destroy ()
specifier|public
name|void
name|destroy
parameter_list|()
block|{
if|if
condition|(
name|sslFactory
operator|!=
literal|null
condition|)
block|{
name|sslFactory
operator|.
name|destroy
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|getPipeline ()
specifier|public
name|ChannelPipeline
name|getPipeline
parameter_list|()
throws|throws
name|Exception
block|{
name|ChannelPipeline
name|pipeline
init|=
name|Channels
operator|.
name|pipeline
argument_list|()
decl_stmt|;
if|if
condition|(
name|sslFactory
operator|!=
literal|null
condition|)
block|{
name|pipeline
operator|.
name|addLast
argument_list|(
literal|"ssl"
argument_list|,
operator|new
name|SslHandler
argument_list|(
name|sslFactory
operator|.
name|createSSLEngine
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|pipeline
operator|.
name|addLast
argument_list|(
literal|"decoder"
argument_list|,
operator|new
name|HttpRequestDecoder
argument_list|()
argument_list|)
expr_stmt|;
name|pipeline
operator|.
name|addLast
argument_list|(
literal|"aggregator"
argument_list|,
operator|new
name|HttpChunkAggregator
argument_list|(
literal|1
operator|<<
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|pipeline
operator|.
name|addLast
argument_list|(
literal|"encoder"
argument_list|,
operator|new
name|HttpResponseEncoder
argument_list|()
argument_list|)
expr_stmt|;
name|pipeline
operator|.
name|addLast
argument_list|(
literal|"chunking"
argument_list|,
operator|new
name|ChunkedWriteHandler
argument_list|()
argument_list|)
expr_stmt|;
name|pipeline
operator|.
name|addLast
argument_list|(
literal|"shuffle"
argument_list|,
name|SHUFFLE
argument_list|)
expr_stmt|;
name|pipeline
operator|.
name|addLast
argument_list|(
literal|"idle"
argument_list|,
name|idleStateHandler
argument_list|)
expr_stmt|;
name|pipeline
operator|.
name|addLast
argument_list|(
name|TIMEOUT_HANDLER
argument_list|,
operator|new
name|TimeoutHandler
argument_list|()
argument_list|)
expr_stmt|;
return|return
name|pipeline
return|;
comment|// TODO factor security manager into pipeline
comment|// TODO factor out encode/decode to permit binary shuffle
comment|// TODO factor out decode of index to permit alt. models
block|}
block|}
DECL|class|Shuffle
class|class
name|Shuffle
extends|extends
name|SimpleChannelUpstreamHandler
block|{
DECL|field|MAX_WEIGHT
specifier|private
specifier|static
specifier|final
name|int
name|MAX_WEIGHT
init|=
literal|10
operator|*
literal|1024
operator|*
literal|1024
decl_stmt|;
DECL|field|EXPIRE_AFTER_ACCESS_MINUTES
specifier|private
specifier|static
specifier|final
name|int
name|EXPIRE_AFTER_ACCESS_MINUTES
init|=
literal|5
decl_stmt|;
DECL|field|ALLOWED_CONCURRENCY
specifier|private
specifier|static
specifier|final
name|int
name|ALLOWED_CONCURRENCY
init|=
literal|16
decl_stmt|;
DECL|field|conf
specifier|private
specifier|final
name|Configuration
name|conf
decl_stmt|;
DECL|field|indexCache
specifier|private
specifier|final
name|IndexCache
name|indexCache
decl_stmt|;
DECL|field|lDirAlloc
specifier|private
specifier|final
name|LocalDirAllocator
name|lDirAlloc
init|=
operator|new
name|LocalDirAllocator
argument_list|(
name|YarnConfiguration
operator|.
name|NM_LOCAL_DIRS
argument_list|)
decl_stmt|;
DECL|field|port
specifier|private
name|int
name|port
decl_stmt|;
DECL|field|pathCache
specifier|private
specifier|final
name|LoadingCache
argument_list|<
name|AttemptPathIdentifier
argument_list|,
name|AttemptPathInfo
argument_list|>
name|pathCache
init|=
name|CacheBuilder
operator|.
name|newBuilder
argument_list|()
operator|.
name|expireAfterAccess
argument_list|(
name|EXPIRE_AFTER_ACCESS_MINUTES
argument_list|,
name|TimeUnit
operator|.
name|MINUTES
argument_list|)
operator|.
name|softValues
argument_list|()
operator|.
name|concurrencyLevel
argument_list|(
name|ALLOWED_CONCURRENCY
argument_list|)
operator|.
name|removalListener
argument_list|(
operator|new
name|RemovalListener
argument_list|<
name|AttemptPathIdentifier
argument_list|,
name|AttemptPathInfo
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|onRemoval
parameter_list|(
name|RemovalNotification
argument_list|<
name|AttemptPathIdentifier
argument_list|,
name|AttemptPathInfo
argument_list|>
name|notification
parameter_list|)
block|{
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"PathCache Eviction: "
operator|+
name|notification
operator|.
name|getKey
argument_list|()
operator|+
literal|", Reason="
operator|+
name|notification
operator|.
name|getCause
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
block|}
argument_list|)
operator|.
name|maximumWeight
argument_list|(
name|MAX_WEIGHT
argument_list|)
operator|.
name|weigher
argument_list|(
operator|new
name|Weigher
argument_list|<
name|AttemptPathIdentifier
argument_list|,
name|AttemptPathInfo
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|int
name|weigh
parameter_list|(
name|AttemptPathIdentifier
name|key
parameter_list|,
name|AttemptPathInfo
name|value
parameter_list|)
block|{
return|return
name|key
operator|.
name|jobId
operator|.
name|length
argument_list|()
operator|+
name|key
operator|.
name|user
operator|.
name|length
argument_list|()
operator|+
name|key
operator|.
name|attemptId
operator|.
name|length
argument_list|()
operator|+
name|value
operator|.
name|indexPath
operator|.
name|toString
argument_list|()
operator|.
name|length
argument_list|()
operator|+
name|value
operator|.
name|dataPath
operator|.
name|toString
argument_list|()
operator|.
name|length
argument_list|()
return|;
block|}
block|}
argument_list|)
operator|.
name|build
argument_list|(
operator|new
name|CacheLoader
argument_list|<
name|AttemptPathIdentifier
argument_list|,
name|AttemptPathInfo
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|AttemptPathInfo
name|load
parameter_list|(
name|AttemptPathIdentifier
name|key
parameter_list|)
throws|throws
name|Exception
block|{
name|String
name|base
init|=
name|getBaseLocation
argument_list|(
name|key
operator|.
name|jobId
argument_list|,
name|key
operator|.
name|user
argument_list|)
decl_stmt|;
name|String
name|attemptBase
init|=
name|base
operator|+
name|key
operator|.
name|attemptId
decl_stmt|;
name|Path
name|indexFileName
init|=
name|lDirAlloc
operator|.
name|getLocalPathToRead
argument_list|(
name|attemptBase
operator|+
literal|"/"
operator|+
name|INDEX_FILE_NAME
argument_list|,
name|conf
argument_list|)
decl_stmt|;
name|Path
name|mapOutputFileName
init|=
name|lDirAlloc
operator|.
name|getLocalPathToRead
argument_list|(
name|attemptBase
operator|+
literal|"/"
operator|+
name|DATA_FILE_NAME
argument_list|,
name|conf
argument_list|)
decl_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Loaded : "
operator|+
name|key
operator|+
literal|" via loader"
argument_list|)
expr_stmt|;
block|}
return|return
operator|new
name|AttemptPathInfo
argument_list|(
name|indexFileName
argument_list|,
name|mapOutputFileName
argument_list|)
return|;
block|}
block|}
argument_list|)
decl_stmt|;
DECL|method|Shuffle (Configuration conf)
specifier|public
name|Shuffle
parameter_list|(
name|Configuration
name|conf
parameter_list|)
block|{
name|this
operator|.
name|conf
operator|=
name|conf
expr_stmt|;
name|indexCache
operator|=
operator|new
name|IndexCache
argument_list|(
operator|new
name|JobConf
argument_list|(
name|conf
argument_list|)
argument_list|)
expr_stmt|;
name|this
operator|.
name|port
operator|=
name|conf
operator|.
name|getInt
argument_list|(
name|SHUFFLE_PORT_CONFIG_KEY
argument_list|,
name|DEFAULT_SHUFFLE_PORT
argument_list|)
expr_stmt|;
block|}
DECL|method|setPort (int port)
specifier|public
name|void
name|setPort
parameter_list|(
name|int
name|port
parameter_list|)
block|{
name|this
operator|.
name|port
operator|=
name|port
expr_stmt|;
block|}
DECL|method|splitMaps (List<String> mapq)
specifier|private
name|List
argument_list|<
name|String
argument_list|>
name|splitMaps
parameter_list|(
name|List
argument_list|<
name|String
argument_list|>
name|mapq
parameter_list|)
block|{
if|if
condition|(
literal|null
operator|==
name|mapq
condition|)
block|{
return|return
literal|null
return|;
block|}
specifier|final
name|List
argument_list|<
name|String
argument_list|>
name|ret
init|=
operator|new
name|ArrayList
argument_list|<
name|String
argument_list|>
argument_list|()
decl_stmt|;
for|for
control|(
name|String
name|s
range|:
name|mapq
control|)
block|{
name|Collections
operator|.
name|addAll
argument_list|(
name|ret
argument_list|,
name|s
operator|.
name|split
argument_list|(
literal|","
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
annotation|@
name|Override
DECL|method|channelOpen (ChannelHandlerContext ctx, ChannelStateEvent evt)
specifier|public
name|void
name|channelOpen
parameter_list|(
name|ChannelHandlerContext
name|ctx
parameter_list|,
name|ChannelStateEvent
name|evt
parameter_list|)
throws|throws
name|Exception
block|{
if|if
condition|(
operator|(
name|maxShuffleConnections
operator|>
literal|0
operator|)
operator|&&
operator|(
name|accepted
operator|.
name|size
argument_list|()
operator|>=
name|maxShuffleConnections
operator|)
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"Current number of shuffle connections (%d) is "
operator|+
literal|"greater than or equal to the max allowed shuffle connections (%d)"
argument_list|,
name|accepted
operator|.
name|size
argument_list|()
argument_list|,
name|maxShuffleConnections
argument_list|)
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|headers
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
argument_list|(
literal|1
argument_list|)
decl_stmt|;
comment|// notify fetchers to backoff for a while before closing the connection
comment|// if the shuffle connection limit is hit. Fetchers are expected to
comment|// handle this notification gracefully, that is, not treating this as a
comment|// fetch failure.
name|headers
operator|.
name|put
argument_list|(
name|RETRY_AFTER_HEADER
argument_list|,
name|String
operator|.
name|valueOf
argument_list|(
name|FETCH_RETRY_DELAY
argument_list|)
argument_list|)
expr_stmt|;
name|sendError
argument_list|(
name|ctx
argument_list|,
literal|""
argument_list|,
name|TOO_MANY_REQ_STATUS
argument_list|,
name|headers
argument_list|)
expr_stmt|;
return|return;
block|}
name|accepted
operator|.
name|add
argument_list|(
name|evt
operator|.
name|getChannel
argument_list|()
argument_list|)
expr_stmt|;
name|super
operator|.
name|channelOpen
argument_list|(
name|ctx
argument_list|,
name|evt
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|messageReceived (ChannelHandlerContext ctx, MessageEvent evt)
specifier|public
name|void
name|messageReceived
parameter_list|(
name|ChannelHandlerContext
name|ctx
parameter_list|,
name|MessageEvent
name|evt
parameter_list|)
throws|throws
name|Exception
block|{
name|HttpRequest
name|request
init|=
operator|(
name|HttpRequest
operator|)
name|evt
operator|.
name|getMessage
argument_list|()
decl_stmt|;
if|if
condition|(
name|request
operator|.
name|getMethod
argument_list|()
operator|!=
name|GET
condition|)
block|{
name|sendError
argument_list|(
name|ctx
argument_list|,
name|METHOD_NOT_ALLOWED
argument_list|)
expr_stmt|;
return|return;
block|}
comment|// Check whether the shuffle version is compatible
if|if
condition|(
operator|!
name|ShuffleHeader
operator|.
name|DEFAULT_HTTP_HEADER_NAME
operator|.
name|equals
argument_list|(
name|request
operator|.
name|headers
argument_list|()
operator|!=
literal|null
condition|?
name|request
operator|.
name|headers
argument_list|()
operator|.
name|get
argument_list|(
name|ShuffleHeader
operator|.
name|HTTP_HEADER_NAME
argument_list|)
else|:
literal|null
argument_list|)
operator|||
operator|!
name|ShuffleHeader
operator|.
name|DEFAULT_HTTP_HEADER_VERSION
operator|.
name|equals
argument_list|(
name|request
operator|.
name|headers
argument_list|()
operator|!=
literal|null
condition|?
name|request
operator|.
name|headers
argument_list|()
operator|.
name|get
argument_list|(
name|ShuffleHeader
operator|.
name|HTTP_HEADER_VERSION
argument_list|)
else|:
literal|null
argument_list|)
condition|)
block|{
name|sendError
argument_list|(
name|ctx
argument_list|,
literal|"Incompatible shuffle request version"
argument_list|,
name|BAD_REQUEST
argument_list|)
expr_stmt|;
block|}
specifier|final
name|Map
argument_list|<
name|String
argument_list|,
name|List
argument_list|<
name|String
argument_list|>
argument_list|>
name|q
init|=
operator|new
name|QueryStringDecoder
argument_list|(
name|request
operator|.
name|getUri
argument_list|()
argument_list|)
operator|.
name|getParameters
argument_list|()
decl_stmt|;
specifier|final
name|List
argument_list|<
name|String
argument_list|>
name|keepAliveList
init|=
name|q
operator|.
name|get
argument_list|(
literal|"keepAlive"
argument_list|)
decl_stmt|;
name|boolean
name|keepAliveParam
init|=
literal|false
decl_stmt|;
if|if
condition|(
name|keepAliveList
operator|!=
literal|null
operator|&&
name|keepAliveList
operator|.
name|size
argument_list|()
operator|==
literal|1
condition|)
block|{
name|keepAliveParam
operator|=
name|Boolean
operator|.
name|valueOf
argument_list|(
name|keepAliveList
operator|.
name|get
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"KeepAliveParam : "
operator|+
name|keepAliveList
operator|+
literal|" : "
operator|+
name|keepAliveParam
argument_list|)
expr_stmt|;
block|}
block|}
specifier|final
name|List
argument_list|<
name|String
argument_list|>
name|mapIds
init|=
name|splitMaps
argument_list|(
name|q
operator|.
name|get
argument_list|(
literal|"map"
argument_list|)
argument_list|)
decl_stmt|;
specifier|final
name|List
argument_list|<
name|String
argument_list|>
name|reduceQ
init|=
name|q
operator|.
name|get
argument_list|(
literal|"reduce"
argument_list|)
decl_stmt|;
specifier|final
name|List
argument_list|<
name|String
argument_list|>
name|jobQ
init|=
name|q
operator|.
name|get
argument_list|(
literal|"job"
argument_list|)
decl_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"RECV: "
operator|+
name|request
operator|.
name|getUri
argument_list|()
operator|+
literal|"\n  mapId: "
operator|+
name|mapIds
operator|+
literal|"\n  reduceId: "
operator|+
name|reduceQ
operator|+
literal|"\n  jobId: "
operator|+
name|jobQ
operator|+
literal|"\n  keepAlive: "
operator|+
name|keepAliveParam
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mapIds
operator|==
literal|null
operator|||
name|reduceQ
operator|==
literal|null
operator|||
name|jobQ
operator|==
literal|null
condition|)
block|{
name|sendError
argument_list|(
name|ctx
argument_list|,
literal|"Required param job, map and reduce"
argument_list|,
name|BAD_REQUEST
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|reduceQ
operator|.
name|size
argument_list|()
operator|!=
literal|1
operator|||
name|jobQ
operator|.
name|size
argument_list|()
operator|!=
literal|1
condition|)
block|{
name|sendError
argument_list|(
name|ctx
argument_list|,
literal|"Too many job/reduce parameters"
argument_list|,
name|BAD_REQUEST
argument_list|)
expr_stmt|;
return|return;
block|}
comment|// this audit log is disabled by default,
comment|// to turn it on please enable this audit log
comment|// on log4j.properties by uncommenting the setting
if|if
condition|(
name|AUDITLOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|AUDITLOG
operator|.
name|debug
argument_list|(
literal|"shuffle for "
operator|+
name|jobQ
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|+
literal|" mappers: "
operator|+
name|mapIds
operator|+
literal|" reducer "
operator|+
name|reduceQ
operator|.
name|get
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|int
name|reduceId
decl_stmt|;
name|String
name|jobId
decl_stmt|;
try|try
block|{
name|reduceId
operator|=
name|Integer
operator|.
name|parseInt
argument_list|(
name|reduceQ
operator|.
name|get
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|jobId
operator|=
name|jobQ
operator|.
name|get
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|NumberFormatException
name|e
parameter_list|)
block|{
name|sendError
argument_list|(
name|ctx
argument_list|,
literal|"Bad reduce parameter"
argument_list|,
name|BAD_REQUEST
argument_list|)
expr_stmt|;
return|return;
block|}
catch|catch
parameter_list|(
name|IllegalArgumentException
name|e
parameter_list|)
block|{
name|sendError
argument_list|(
name|ctx
argument_list|,
literal|"Bad job parameter"
argument_list|,
name|BAD_REQUEST
argument_list|)
expr_stmt|;
return|return;
block|}
specifier|final
name|String
name|reqUri
init|=
name|request
operator|.
name|getUri
argument_list|()
decl_stmt|;
if|if
condition|(
literal|null
operator|==
name|reqUri
condition|)
block|{
comment|// TODO? add upstream?
name|sendError
argument_list|(
name|ctx
argument_list|,
name|FORBIDDEN
argument_list|)
expr_stmt|;
return|return;
block|}
name|HttpResponse
name|response
init|=
operator|new
name|DefaultHttpResponse
argument_list|(
name|HTTP_1_1
argument_list|,
name|OK
argument_list|)
decl_stmt|;
try|try
block|{
name|verifyRequest
argument_list|(
name|jobId
argument_list|,
name|ctx
argument_list|,
name|request
argument_list|,
name|response
argument_list|,
operator|new
name|URL
argument_list|(
literal|"http"
argument_list|,
literal|""
argument_list|,
name|this
operator|.
name|port
argument_list|,
name|reqUri
argument_list|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Shuffle failure "
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|sendError
argument_list|(
name|ctx
argument_list|,
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|UNAUTHORIZED
argument_list|)
expr_stmt|;
return|return;
block|}
name|Map
argument_list|<
name|String
argument_list|,
name|MapOutputInfo
argument_list|>
name|mapOutputInfoMap
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|MapOutputInfo
argument_list|>
argument_list|()
decl_stmt|;
name|Channel
name|ch
init|=
name|evt
operator|.
name|getChannel
argument_list|()
decl_stmt|;
name|ChannelPipeline
name|pipeline
init|=
name|ch
operator|.
name|getPipeline
argument_list|()
decl_stmt|;
name|TimeoutHandler
name|timeoutHandler
init|=
operator|(
name|TimeoutHandler
operator|)
name|pipeline
operator|.
name|get
argument_list|(
name|TIMEOUT_HANDLER
argument_list|)
decl_stmt|;
name|timeoutHandler
operator|.
name|setEnabledTimeout
argument_list|(
literal|false
argument_list|)
expr_stmt|;
name|String
name|user
init|=
name|userRsrc
operator|.
name|get
argument_list|(
name|jobId
argument_list|)
decl_stmt|;
try|try
block|{
name|populateHeaders
argument_list|(
name|mapIds
argument_list|,
name|jobId
argument_list|,
name|user
argument_list|,
name|reduceId
argument_list|,
name|request
argument_list|,
name|response
argument_list|,
name|keepAliveParam
argument_list|,
name|mapOutputInfoMap
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|ch
operator|.
name|write
argument_list|(
name|response
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|error
argument_list|(
literal|"Shuffle error in populating headers :"
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|String
name|errorMessage
init|=
name|getErrorMessage
argument_list|(
name|e
argument_list|)
decl_stmt|;
name|sendError
argument_list|(
name|ctx
argument_list|,
name|errorMessage
argument_list|,
name|INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|ch
operator|.
name|write
argument_list|(
name|response
argument_list|)
expr_stmt|;
comment|//Initialize one ReduceContext object per messageReceived call
name|boolean
name|keepAlive
init|=
name|keepAliveParam
operator|||
name|connectionKeepAliveEnabled
decl_stmt|;
name|ReduceContext
name|reduceContext
init|=
operator|new
name|ReduceContext
argument_list|(
name|mapIds
argument_list|,
name|reduceId
argument_list|,
name|ctx
argument_list|,
name|user
argument_list|,
name|mapOutputInfoMap
argument_list|,
name|jobId
argument_list|,
name|keepAlive
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|Math
operator|.
name|min
argument_list|(
name|maxSessionOpenFiles
argument_list|,
name|mapIds
operator|.
name|size
argument_list|()
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|ChannelFuture
name|nextMap
init|=
name|sendMap
argument_list|(
name|reduceContext
argument_list|)
decl_stmt|;
if|if
condition|(
name|nextMap
operator|==
literal|null
condition|)
block|{
return|return;
block|}
block|}
block|}
comment|/**      * Calls sendMapOutput for the mapId pointed by ReduceContext.mapsToSend      * and increments it. This method is first called by messageReceived()      * maxSessionOpenFiles times and then on the completion of every      * sendMapOutput operation. This limits the number of open files on a node,      * which can get really large(exhausting file descriptors on the NM) if all      * sendMapOutputs are called in one go, as was done previous to this change.      * @param reduceContext used to call sendMapOutput with correct params.      * @return the ChannelFuture of the sendMapOutput, can be null.      */
DECL|method|sendMap (ReduceContext reduceContext)
specifier|public
name|ChannelFuture
name|sendMap
parameter_list|(
name|ReduceContext
name|reduceContext
parameter_list|)
throws|throws
name|Exception
block|{
name|ChannelFuture
name|nextMap
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|reduceContext
operator|.
name|getMapsToSend
argument_list|()
operator|.
name|get
argument_list|()
operator|<
name|reduceContext
operator|.
name|getMapIds
argument_list|()
operator|.
name|size
argument_list|()
condition|)
block|{
name|int
name|nextIndex
init|=
name|reduceContext
operator|.
name|getMapsToSend
argument_list|()
operator|.
name|getAndIncrement
argument_list|()
decl_stmt|;
name|String
name|mapId
init|=
name|reduceContext
operator|.
name|getMapIds
argument_list|()
operator|.
name|get
argument_list|(
name|nextIndex
argument_list|)
decl_stmt|;
try|try
block|{
name|MapOutputInfo
name|info
init|=
name|reduceContext
operator|.
name|getInfoMap
argument_list|()
operator|.
name|get
argument_list|(
name|mapId
argument_list|)
decl_stmt|;
if|if
condition|(
name|info
operator|==
literal|null
condition|)
block|{
name|info
operator|=
name|getMapOutputInfo
argument_list|(
name|mapId
argument_list|,
name|reduceContext
operator|.
name|getReduceId
argument_list|()
argument_list|,
name|reduceContext
operator|.
name|getJobId
argument_list|()
argument_list|,
name|reduceContext
operator|.
name|getUser
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|nextMap
operator|=
name|sendMapOutput
argument_list|(
name|reduceContext
operator|.
name|getCtx
argument_list|()
argument_list|,
name|reduceContext
operator|.
name|getCtx
argument_list|()
operator|.
name|getChannel
argument_list|()
argument_list|,
name|reduceContext
operator|.
name|getUser
argument_list|()
argument_list|,
name|mapId
argument_list|,
name|reduceContext
operator|.
name|getReduceId
argument_list|()
argument_list|,
name|info
argument_list|)
expr_stmt|;
if|if
condition|(
literal|null
operator|==
name|nextMap
condition|)
block|{
name|sendError
argument_list|(
name|reduceContext
operator|.
name|getCtx
argument_list|()
argument_list|,
name|NOT_FOUND
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
name|nextMap
operator|.
name|addListener
argument_list|(
operator|new
name|ReduceMapFileCount
argument_list|(
name|reduceContext
argument_list|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Shuffle error :"
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|String
name|errorMessage
init|=
name|getErrorMessage
argument_list|(
name|e
argument_list|)
decl_stmt|;
name|sendError
argument_list|(
name|reduceContext
operator|.
name|getCtx
argument_list|()
argument_list|,
name|errorMessage
argument_list|,
name|INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
block|}
return|return
name|nextMap
return|;
block|}
DECL|method|getErrorMessage (Throwable t)
specifier|private
name|String
name|getErrorMessage
parameter_list|(
name|Throwable
name|t
parameter_list|)
block|{
name|StringBuffer
name|sb
init|=
operator|new
name|StringBuffer
argument_list|(
name|t
operator|.
name|getMessage
argument_list|()
argument_list|)
decl_stmt|;
while|while
condition|(
name|t
operator|.
name|getCause
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|sb
operator|.
name|append
argument_list|(
name|t
operator|.
name|getCause
argument_list|()
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
name|t
operator|=
name|t
operator|.
name|getCause
argument_list|()
expr_stmt|;
block|}
return|return
name|sb
operator|.
name|toString
argument_list|()
return|;
block|}
DECL|method|getBaseLocation (String jobId, String user)
specifier|private
name|String
name|getBaseLocation
parameter_list|(
name|String
name|jobId
parameter_list|,
name|String
name|user
parameter_list|)
block|{
specifier|final
name|JobID
name|jobID
init|=
name|JobID
operator|.
name|forName
argument_list|(
name|jobId
argument_list|)
decl_stmt|;
specifier|final
name|ApplicationId
name|appID
init|=
name|ApplicationId
operator|.
name|newInstance
argument_list|(
name|Long
operator|.
name|parseLong
argument_list|(
name|jobID
operator|.
name|getJtIdentifier
argument_list|()
argument_list|)
argument_list|,
name|jobID
operator|.
name|getId
argument_list|()
argument_list|)
decl_stmt|;
specifier|final
name|String
name|baseStr
init|=
name|ContainerLocalizer
operator|.
name|USERCACHE
operator|+
literal|"/"
operator|+
name|user
operator|+
literal|"/"
operator|+
name|ContainerLocalizer
operator|.
name|APPCACHE
operator|+
literal|"/"
operator|+
name|appID
operator|.
name|toString
argument_list|()
operator|+
literal|"/output"
operator|+
literal|"/"
decl_stmt|;
return|return
name|baseStr
return|;
block|}
DECL|method|getMapOutputInfo (String mapId, int reduce, String jobId, String user)
specifier|protected
name|MapOutputInfo
name|getMapOutputInfo
parameter_list|(
name|String
name|mapId
parameter_list|,
name|int
name|reduce
parameter_list|,
name|String
name|jobId
parameter_list|,
name|String
name|user
parameter_list|)
throws|throws
name|IOException
block|{
name|AttemptPathInfo
name|pathInfo
decl_stmt|;
try|try
block|{
name|AttemptPathIdentifier
name|identifier
init|=
operator|new
name|AttemptPathIdentifier
argument_list|(
name|jobId
argument_list|,
name|user
argument_list|,
name|mapId
argument_list|)
decl_stmt|;
name|pathInfo
operator|=
name|pathCache
operator|.
name|get
argument_list|(
name|identifier
argument_list|)
expr_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Retrieved pathInfo for "
operator|+
name|identifier
operator|+
literal|" check for corresponding loaded messages to determine whether"
operator|+
literal|" it was loaded or cached"
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|ExecutionException
name|e
parameter_list|)
block|{
if|if
condition|(
name|e
operator|.
name|getCause
argument_list|()
operator|instanceof
name|IOException
condition|)
block|{
throw|throw
operator|(
name|IOException
operator|)
name|e
operator|.
name|getCause
argument_list|()
throw|;
block|}
else|else
block|{
throw|throw
operator|new
name|RuntimeException
argument_list|(
name|e
operator|.
name|getCause
argument_list|()
argument_list|)
throw|;
block|}
block|}
name|IndexRecord
name|info
init|=
name|indexCache
operator|.
name|getIndexInformation
argument_list|(
name|mapId
argument_list|,
name|reduce
argument_list|,
name|pathInfo
operator|.
name|indexPath
argument_list|,
name|user
argument_list|)
decl_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"getMapOutputInfo: jobId="
operator|+
name|jobId
operator|+
literal|", mapId="
operator|+
name|mapId
operator|+
literal|",dataFile="
operator|+
name|pathInfo
operator|.
name|dataPath
operator|+
literal|", indexFile="
operator|+
name|pathInfo
operator|.
name|indexPath
argument_list|)
expr_stmt|;
block|}
name|MapOutputInfo
name|outputInfo
init|=
operator|new
name|MapOutputInfo
argument_list|(
name|pathInfo
operator|.
name|dataPath
argument_list|,
name|info
argument_list|)
decl_stmt|;
return|return
name|outputInfo
return|;
block|}
DECL|method|populateHeaders (List<String> mapIds, String jobId, String user, int reduce, HttpRequest request, HttpResponse response, boolean keepAliveParam, Map<String, MapOutputInfo> mapOutputInfoMap)
specifier|protected
name|void
name|populateHeaders
parameter_list|(
name|List
argument_list|<
name|String
argument_list|>
name|mapIds
parameter_list|,
name|String
name|jobId
parameter_list|,
name|String
name|user
parameter_list|,
name|int
name|reduce
parameter_list|,
name|HttpRequest
name|request
parameter_list|,
name|HttpResponse
name|response
parameter_list|,
name|boolean
name|keepAliveParam
parameter_list|,
name|Map
argument_list|<
name|String
argument_list|,
name|MapOutputInfo
argument_list|>
name|mapOutputInfoMap
parameter_list|)
throws|throws
name|IOException
block|{
name|long
name|contentLength
init|=
literal|0
decl_stmt|;
for|for
control|(
name|String
name|mapId
range|:
name|mapIds
control|)
block|{
name|MapOutputInfo
name|outputInfo
init|=
name|getMapOutputInfo
argument_list|(
name|mapId
argument_list|,
name|reduce
argument_list|,
name|jobId
argument_list|,
name|user
argument_list|)
decl_stmt|;
if|if
condition|(
name|mapOutputInfoMap
operator|.
name|size
argument_list|()
operator|<
name|mapOutputMetaInfoCacheSize
condition|)
block|{
name|mapOutputInfoMap
operator|.
name|put
argument_list|(
name|mapId
argument_list|,
name|outputInfo
argument_list|)
expr_stmt|;
block|}
name|ShuffleHeader
name|header
init|=
operator|new
name|ShuffleHeader
argument_list|(
name|mapId
argument_list|,
name|outputInfo
operator|.
name|indexRecord
operator|.
name|partLength
argument_list|,
name|outputInfo
operator|.
name|indexRecord
operator|.
name|rawLength
argument_list|,
name|reduce
argument_list|)
decl_stmt|;
name|DataOutputBuffer
name|dob
init|=
operator|new
name|DataOutputBuffer
argument_list|()
decl_stmt|;
name|header
operator|.
name|write
argument_list|(
name|dob
argument_list|)
expr_stmt|;
name|contentLength
operator|+=
name|outputInfo
operator|.
name|indexRecord
operator|.
name|partLength
expr_stmt|;
name|contentLength
operator|+=
name|dob
operator|.
name|getLength
argument_list|()
expr_stmt|;
block|}
comment|// Now set the response headers.
name|setResponseHeaders
argument_list|(
name|response
argument_list|,
name|keepAliveParam
argument_list|,
name|contentLength
argument_list|)
expr_stmt|;
block|}
DECL|method|setResponseHeaders (HttpResponse response, boolean keepAliveParam, long contentLength)
specifier|protected
name|void
name|setResponseHeaders
parameter_list|(
name|HttpResponse
name|response
parameter_list|,
name|boolean
name|keepAliveParam
parameter_list|,
name|long
name|contentLength
parameter_list|)
block|{
if|if
condition|(
operator|!
name|connectionKeepAliveEnabled
operator|&&
operator|!
name|keepAliveParam
condition|)
block|{
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Setting connection close header..."
argument_list|)
expr_stmt|;
block|}
name|response
operator|.
name|headers
argument_list|()
operator|.
name|set
argument_list|(
name|HttpHeader
operator|.
name|CONNECTION
operator|.
name|asString
argument_list|()
argument_list|,
name|CONNECTION_CLOSE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|response
operator|.
name|headers
argument_list|()
operator|.
name|set
argument_list|(
name|HttpHeader
operator|.
name|CONTENT_LENGTH
operator|.
name|asString
argument_list|()
argument_list|,
name|String
operator|.
name|valueOf
argument_list|(
name|contentLength
argument_list|)
argument_list|)
expr_stmt|;
name|response
operator|.
name|headers
argument_list|()
operator|.
name|set
argument_list|(
name|HttpHeader
operator|.
name|CONNECTION
operator|.
name|asString
argument_list|()
argument_list|,
name|HttpHeader
operator|.
name|KEEP_ALIVE
operator|.
name|asString
argument_list|()
argument_list|)
expr_stmt|;
name|response
operator|.
name|headers
argument_list|()
operator|.
name|set
argument_list|(
name|HttpHeader
operator|.
name|KEEP_ALIVE
operator|.
name|asString
argument_list|()
argument_list|,
literal|"timeout="
operator|+
name|connectionKeepAliveTimeOut
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Content Length in shuffle : "
operator|+
name|contentLength
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|MapOutputInfo
class|class
name|MapOutputInfo
block|{
DECL|field|mapOutputFileName
specifier|final
name|Path
name|mapOutputFileName
decl_stmt|;
DECL|field|indexRecord
specifier|final
name|IndexRecord
name|indexRecord
decl_stmt|;
DECL|method|MapOutputInfo (Path mapOutputFileName, IndexRecord indexRecord)
name|MapOutputInfo
parameter_list|(
name|Path
name|mapOutputFileName
parameter_list|,
name|IndexRecord
name|indexRecord
parameter_list|)
block|{
name|this
operator|.
name|mapOutputFileName
operator|=
name|mapOutputFileName
expr_stmt|;
name|this
operator|.
name|indexRecord
operator|=
name|indexRecord
expr_stmt|;
block|}
block|}
DECL|method|verifyRequest (String appid, ChannelHandlerContext ctx, HttpRequest request, HttpResponse response, URL requestUri)
specifier|protected
name|void
name|verifyRequest
parameter_list|(
name|String
name|appid
parameter_list|,
name|ChannelHandlerContext
name|ctx
parameter_list|,
name|HttpRequest
name|request
parameter_list|,
name|HttpResponse
name|response
parameter_list|,
name|URL
name|requestUri
parameter_list|)
throws|throws
name|IOException
block|{
name|SecretKey
name|tokenSecret
init|=
name|secretManager
operator|.
name|retrieveTokenSecret
argument_list|(
name|appid
argument_list|)
decl_stmt|;
if|if
condition|(
literal|null
operator|==
name|tokenSecret
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Request for unknown token "
operator|+
name|appid
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|IOException
argument_list|(
literal|"could not find jobid"
argument_list|)
throw|;
block|}
comment|// string to encrypt
name|String
name|enc_str
init|=
name|SecureShuffleUtils
operator|.
name|buildMsgFrom
argument_list|(
name|requestUri
argument_list|)
decl_stmt|;
comment|// hash from the fetcher
name|String
name|urlHashStr
init|=
name|request
operator|.
name|headers
argument_list|()
operator|.
name|get
argument_list|(
name|SecureShuffleUtils
operator|.
name|HTTP_HEADER_URL_HASH
argument_list|)
decl_stmt|;
if|if
condition|(
name|urlHashStr
operator|==
literal|null
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Missing header hash for "
operator|+
name|appid
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|IOException
argument_list|(
literal|"fetcher cannot be authenticated"
argument_list|)
throw|;
block|}
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|int
name|len
init|=
name|urlHashStr
operator|.
name|length
argument_list|()
decl_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"verifying request. enc_str="
operator|+
name|enc_str
operator|+
literal|"; hash=..."
operator|+
name|urlHashStr
operator|.
name|substring
argument_list|(
name|len
operator|-
name|len
operator|/
literal|2
argument_list|,
name|len
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|// verify - throws exception
name|SecureShuffleUtils
operator|.
name|verifyReply
argument_list|(
name|urlHashStr
argument_list|,
name|enc_str
argument_list|,
name|tokenSecret
argument_list|)
expr_stmt|;
comment|// verification passed - encode the reply
name|String
name|reply
init|=
name|SecureShuffleUtils
operator|.
name|generateHash
argument_list|(
name|urlHashStr
operator|.
name|getBytes
argument_list|(
name|Charsets
operator|.
name|UTF_8
argument_list|)
argument_list|,
name|tokenSecret
argument_list|)
decl_stmt|;
name|response
operator|.
name|headers
argument_list|()
operator|.
name|set
argument_list|(
name|SecureShuffleUtils
operator|.
name|HTTP_HEADER_REPLY_URL_HASH
argument_list|,
name|reply
argument_list|)
expr_stmt|;
comment|// Put shuffle version into http header
name|response
operator|.
name|headers
argument_list|()
operator|.
name|set
argument_list|(
name|ShuffleHeader
operator|.
name|HTTP_HEADER_NAME
argument_list|,
name|ShuffleHeader
operator|.
name|DEFAULT_HTTP_HEADER_NAME
argument_list|)
expr_stmt|;
name|response
operator|.
name|headers
argument_list|()
operator|.
name|set
argument_list|(
name|ShuffleHeader
operator|.
name|HTTP_HEADER_VERSION
argument_list|,
name|ShuffleHeader
operator|.
name|DEFAULT_HTTP_HEADER_VERSION
argument_list|)
expr_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|int
name|len
init|=
name|reply
operator|.
name|length
argument_list|()
decl_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"Fetcher request verfied. enc_str="
operator|+
name|enc_str
operator|+
literal|";reply="
operator|+
name|reply
operator|.
name|substring
argument_list|(
name|len
operator|-
name|len
operator|/
literal|2
argument_list|,
name|len
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|sendMapOutput (ChannelHandlerContext ctx, Channel ch, String user, String mapId, int reduce, MapOutputInfo mapOutputInfo)
specifier|protected
name|ChannelFuture
name|sendMapOutput
parameter_list|(
name|ChannelHandlerContext
name|ctx
parameter_list|,
name|Channel
name|ch
parameter_list|,
name|String
name|user
parameter_list|,
name|String
name|mapId
parameter_list|,
name|int
name|reduce
parameter_list|,
name|MapOutputInfo
name|mapOutputInfo
parameter_list|)
throws|throws
name|IOException
block|{
specifier|final
name|IndexRecord
name|info
init|=
name|mapOutputInfo
operator|.
name|indexRecord
decl_stmt|;
specifier|final
name|ShuffleHeader
name|header
init|=
operator|new
name|ShuffleHeader
argument_list|(
name|mapId
argument_list|,
name|info
operator|.
name|partLength
argument_list|,
name|info
operator|.
name|rawLength
argument_list|,
name|reduce
argument_list|)
decl_stmt|;
specifier|final
name|DataOutputBuffer
name|dob
init|=
operator|new
name|DataOutputBuffer
argument_list|()
decl_stmt|;
name|header
operator|.
name|write
argument_list|(
name|dob
argument_list|)
expr_stmt|;
name|ch
operator|.
name|write
argument_list|(
name|wrappedBuffer
argument_list|(
name|dob
operator|.
name|getData
argument_list|()
argument_list|,
literal|0
argument_list|,
name|dob
operator|.
name|getLength
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
specifier|final
name|File
name|spillfile
init|=
operator|new
name|File
argument_list|(
name|mapOutputInfo
operator|.
name|mapOutputFileName
operator|.
name|toString
argument_list|()
argument_list|)
decl_stmt|;
name|RandomAccessFile
name|spill
decl_stmt|;
try|try
block|{
name|spill
operator|=
name|SecureIOUtils
operator|.
name|openForRandomRead
argument_list|(
name|spillfile
argument_list|,
literal|"r"
argument_list|,
name|user
argument_list|,
literal|null
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|FileNotFoundException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|info
argument_list|(
name|spillfile
operator|+
literal|" not found"
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
name|ChannelFuture
name|writeFuture
decl_stmt|;
if|if
condition|(
name|ch
operator|.
name|getPipeline
argument_list|()
operator|.
name|get
argument_list|(
name|SslHandler
operator|.
name|class
argument_list|)
operator|==
literal|null
condition|)
block|{
specifier|final
name|FadvisedFileRegion
name|partition
init|=
operator|new
name|FadvisedFileRegion
argument_list|(
name|spill
argument_list|,
name|info
operator|.
name|startOffset
argument_list|,
name|info
operator|.
name|partLength
argument_list|,
name|manageOsCache
argument_list|,
name|readaheadLength
argument_list|,
name|readaheadPool
argument_list|,
name|spillfile
operator|.
name|getAbsolutePath
argument_list|()
argument_list|,
name|shuffleBufferSize
argument_list|,
name|shuffleTransferToAllowed
argument_list|)
decl_stmt|;
name|writeFuture
operator|=
name|ch
operator|.
name|write
argument_list|(
name|partition
argument_list|)
expr_stmt|;
name|writeFuture
operator|.
name|addListener
argument_list|(
operator|new
name|ChannelFutureListener
argument_list|()
block|{
comment|// TODO error handling; distinguish IO/connection failures,
comment|//      attribute to appropriate spill output
annotation|@
name|Override
specifier|public
name|void
name|operationComplete
parameter_list|(
name|ChannelFuture
name|future
parameter_list|)
block|{
if|if
condition|(
name|future
operator|.
name|isSuccess
argument_list|()
condition|)
block|{
name|partition
operator|.
name|transferSuccessful
argument_list|()
expr_stmt|;
block|}
name|partition
operator|.
name|releaseExternalResources
argument_list|()
expr_stmt|;
block|}
block|}
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// HTTPS cannot be done with zero copy.
specifier|final
name|FadvisedChunkedFile
name|chunk
init|=
operator|new
name|FadvisedChunkedFile
argument_list|(
name|spill
argument_list|,
name|info
operator|.
name|startOffset
argument_list|,
name|info
operator|.
name|partLength
argument_list|,
name|sslFileBufferSize
argument_list|,
name|manageOsCache
argument_list|,
name|readaheadLength
argument_list|,
name|readaheadPool
argument_list|,
name|spillfile
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
decl_stmt|;
name|writeFuture
operator|=
name|ch
operator|.
name|write
argument_list|(
name|chunk
argument_list|)
expr_stmt|;
block|}
name|metrics
operator|.
name|shuffleConnections
operator|.
name|incr
argument_list|()
expr_stmt|;
name|metrics
operator|.
name|shuffleOutputBytes
operator|.
name|incr
argument_list|(
name|info
operator|.
name|partLength
argument_list|)
expr_stmt|;
comment|// optimistic
return|return
name|writeFuture
return|;
block|}
DECL|method|sendError (ChannelHandlerContext ctx, HttpResponseStatus status)
specifier|protected
name|void
name|sendError
parameter_list|(
name|ChannelHandlerContext
name|ctx
parameter_list|,
name|HttpResponseStatus
name|status
parameter_list|)
block|{
name|sendError
argument_list|(
name|ctx
argument_list|,
literal|""
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
DECL|method|sendError (ChannelHandlerContext ctx, String message, HttpResponseStatus status)
specifier|protected
name|void
name|sendError
parameter_list|(
name|ChannelHandlerContext
name|ctx
parameter_list|,
name|String
name|message
parameter_list|,
name|HttpResponseStatus
name|status
parameter_list|)
block|{
name|sendError
argument_list|(
name|ctx
argument_list|,
name|message
argument_list|,
name|status
argument_list|,
name|Collections
operator|.
expr|<
name|String
argument_list|,
name|String
operator|>
name|emptyMap
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|sendError (ChannelHandlerContext ctx, String msg, HttpResponseStatus status, Map<String, String> headers)
specifier|protected
name|void
name|sendError
parameter_list|(
name|ChannelHandlerContext
name|ctx
parameter_list|,
name|String
name|msg
parameter_list|,
name|HttpResponseStatus
name|status
parameter_list|,
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|headers
parameter_list|)
block|{
name|HttpResponse
name|response
init|=
operator|new
name|DefaultHttpResponse
argument_list|(
name|HTTP_1_1
argument_list|,
name|status
argument_list|)
decl_stmt|;
name|response
operator|.
name|headers
argument_list|()
operator|.
name|set
argument_list|(
name|CONTENT_TYPE
argument_list|,
literal|"text/plain; charset=UTF-8"
argument_list|)
expr_stmt|;
comment|// Put shuffle version into http header
name|response
operator|.
name|headers
argument_list|()
operator|.
name|set
argument_list|(
name|ShuffleHeader
operator|.
name|HTTP_HEADER_NAME
argument_list|,
name|ShuffleHeader
operator|.
name|DEFAULT_HTTP_HEADER_NAME
argument_list|)
expr_stmt|;
name|response
operator|.
name|headers
argument_list|()
operator|.
name|set
argument_list|(
name|ShuffleHeader
operator|.
name|HTTP_HEADER_VERSION
argument_list|,
name|ShuffleHeader
operator|.
name|DEFAULT_HTTP_HEADER_VERSION
argument_list|)
expr_stmt|;
for|for
control|(
name|Map
operator|.
name|Entry
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|header
range|:
name|headers
operator|.
name|entrySet
argument_list|()
control|)
block|{
name|response
operator|.
name|headers
argument_list|()
operator|.
name|set
argument_list|(
name|header
operator|.
name|getKey
argument_list|()
argument_list|,
name|header
operator|.
name|getValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|response
operator|.
name|setContent
argument_list|(
name|ChannelBuffers
operator|.
name|copiedBuffer
argument_list|(
name|msg
argument_list|,
name|CharsetUtil
operator|.
name|UTF_8
argument_list|)
argument_list|)
expr_stmt|;
comment|// Close the connection as soon as the error message is sent.
name|ctx
operator|.
name|getChannel
argument_list|()
operator|.
name|write
argument_list|(
name|response
argument_list|)
operator|.
name|addListener
argument_list|(
name|ChannelFutureListener
operator|.
name|CLOSE
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|exceptionCaught (ChannelHandlerContext ctx, ExceptionEvent e)
specifier|public
name|void
name|exceptionCaught
parameter_list|(
name|ChannelHandlerContext
name|ctx
parameter_list|,
name|ExceptionEvent
name|e
parameter_list|)
throws|throws
name|Exception
block|{
name|Channel
name|ch
init|=
name|e
operator|.
name|getChannel
argument_list|()
decl_stmt|;
name|Throwable
name|cause
init|=
name|e
operator|.
name|getCause
argument_list|()
decl_stmt|;
if|if
condition|(
name|cause
operator|instanceof
name|TooLongFrameException
condition|)
block|{
name|sendError
argument_list|(
name|ctx
argument_list|,
name|BAD_REQUEST
argument_list|)
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
name|cause
operator|instanceof
name|IOException
condition|)
block|{
if|if
condition|(
name|cause
operator|instanceof
name|ClosedChannelException
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Ignoring closed channel error"
argument_list|,
name|cause
argument_list|)
expr_stmt|;
return|return;
block|}
name|String
name|message
init|=
name|String
operator|.
name|valueOf
argument_list|(
name|cause
operator|.
name|getMessage
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|IGNORABLE_ERROR_MESSAGE
operator|.
name|matcher
argument_list|(
name|message
argument_list|)
operator|.
name|matches
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Ignoring client socket close"
argument_list|,
name|cause
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|LOG
operator|.
name|error
argument_list|(
literal|"Shuffle error: "
argument_list|,
name|cause
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|.
name|isConnected
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Shuffle error "
operator|+
name|e
argument_list|)
expr_stmt|;
name|sendError
argument_list|(
name|ctx
argument_list|,
name|INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
block|}
block|}
block|}
DECL|class|AttemptPathInfo
specifier|static
class|class
name|AttemptPathInfo
block|{
comment|// TODO Change this over to just store local dir indices, instead of the
comment|// entire path. Far more efficient.
DECL|field|indexPath
specifier|private
specifier|final
name|Path
name|indexPath
decl_stmt|;
DECL|field|dataPath
specifier|private
specifier|final
name|Path
name|dataPath
decl_stmt|;
DECL|method|AttemptPathInfo (Path indexPath, Path dataPath)
specifier|public
name|AttemptPathInfo
parameter_list|(
name|Path
name|indexPath
parameter_list|,
name|Path
name|dataPath
parameter_list|)
block|{
name|this
operator|.
name|indexPath
operator|=
name|indexPath
expr_stmt|;
name|this
operator|.
name|dataPath
operator|=
name|dataPath
expr_stmt|;
block|}
block|}
DECL|class|AttemptPathIdentifier
specifier|static
class|class
name|AttemptPathIdentifier
block|{
DECL|field|jobId
specifier|private
specifier|final
name|String
name|jobId
decl_stmt|;
DECL|field|user
specifier|private
specifier|final
name|String
name|user
decl_stmt|;
DECL|field|attemptId
specifier|private
specifier|final
name|String
name|attemptId
decl_stmt|;
DECL|method|AttemptPathIdentifier (String jobId, String user, String attemptId)
specifier|public
name|AttemptPathIdentifier
parameter_list|(
name|String
name|jobId
parameter_list|,
name|String
name|user
parameter_list|,
name|String
name|attemptId
parameter_list|)
block|{
name|this
operator|.
name|jobId
operator|=
name|jobId
expr_stmt|;
name|this
operator|.
name|user
operator|=
name|user
expr_stmt|;
name|this
operator|.
name|attemptId
operator|=
name|attemptId
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|equals (Object o)
specifier|public
name|boolean
name|equals
parameter_list|(
name|Object
name|o
parameter_list|)
block|{
if|if
condition|(
name|this
operator|==
name|o
condition|)
block|{
return|return
literal|true
return|;
block|}
if|if
condition|(
name|o
operator|==
literal|null
operator|||
name|getClass
argument_list|()
operator|!=
name|o
operator|.
name|getClass
argument_list|()
condition|)
block|{
return|return
literal|false
return|;
block|}
name|AttemptPathIdentifier
name|that
init|=
operator|(
name|AttemptPathIdentifier
operator|)
name|o
decl_stmt|;
if|if
condition|(
operator|!
name|attemptId
operator|.
name|equals
argument_list|(
name|that
operator|.
name|attemptId
argument_list|)
condition|)
block|{
return|return
literal|false
return|;
block|}
if|if
condition|(
operator|!
name|jobId
operator|.
name|equals
argument_list|(
name|that
operator|.
name|jobId
argument_list|)
condition|)
block|{
return|return
literal|false
return|;
block|}
return|return
literal|true
return|;
block|}
annotation|@
name|Override
DECL|method|hashCode ()
specifier|public
name|int
name|hashCode
parameter_list|()
block|{
name|int
name|result
init|=
name|jobId
operator|.
name|hashCode
argument_list|()
decl_stmt|;
name|result
operator|=
literal|31
operator|*
name|result
operator|+
name|attemptId
operator|.
name|hashCode
argument_list|()
expr_stmt|;
return|return
name|result
return|;
block|}
annotation|@
name|Override
DECL|method|toString ()
specifier|public
name|String
name|toString
parameter_list|()
block|{
return|return
literal|"AttemptPathIdentifier{"
operator|+
literal|"attemptId='"
operator|+
name|attemptId
operator|+
literal|'\''
operator|+
literal|", jobId='"
operator|+
name|jobId
operator|+
literal|'\''
operator|+
literal|'}'
return|;
block|}
block|}
block|}
end_class

end_unit

