begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/**  * Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with this  * work for additional information regarding copyright ownership.  The ASF  * licenses this file to you under the Apache License, Version 2.0 (the  * "License"); you may not use this file except in compliance with the License.  * You may obtain a copy of the License at  *<p>  * http://www.apache.org/licenses/LICENSE-2.0  *<p>  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT  * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the  * License for the specific language governing permissions and limitations under  * the License.  */
end_comment

begin_package
DECL|package|org.apache.hadoop.ozone.container.common
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|ozone
operator|.
name|container
operator|.
name|common
package|;
end_package

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|conf
operator|.
name|Configuration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|FileUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdds
operator|.
name|HddsConfigKeys
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdds
operator|.
name|conf
operator|.
name|OzoneConfiguration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdds
operator|.
name|protocol
operator|.
name|proto
operator|.
name|StorageContainerDatanodeProtocolProtos
operator|.
name|CloseContainerCommandProto
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdds
operator|.
name|protocol
operator|.
name|proto
operator|.
name|StorageContainerDatanodeProtocolProtos
operator|.
name|CommandStatus
operator|.
name|Status
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdds
operator|.
name|protocol
operator|.
name|proto
operator|.
name|StorageContainerDatanodeProtocolProtos
operator|.
name|DeleteBlocksCommandProto
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdds
operator|.
name|protocol
operator|.
name|proto
operator|.
name|StorageContainerDatanodeProtocolProtos
operator|.
name|DeletedBlocksTransaction
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdds
operator|.
name|protocol
operator|.
name|proto
operator|.
name|StorageContainerDatanodeProtocolProtos
operator|.
name|ReplicateContainerCommandProto
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdds
operator|.
name|protocol
operator|.
name|proto
operator|.
name|StorageContainerDatanodeProtocolProtos
operator|.
name|SCMCommandProto
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdds
operator|.
name|protocol
operator|.
name|proto
operator|.
name|StorageContainerDatanodeProtocolProtos
operator|.
name|SCMCommandProto
operator|.
name|Type
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdds
operator|.
name|scm
operator|.
name|TestUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdds
operator|.
name|scm
operator|.
name|VersionInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdds
operator|.
name|protocol
operator|.
name|DatanodeDetails
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdds
operator|.
name|protocol
operator|.
name|proto
operator|.
name|HddsProtos
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdds
operator|.
name|protocol
operator|.
name|proto
operator|.
name|StorageContainerDatanodeProtocolProtos
operator|.
name|SCMHeartbeatRequestProto
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdds
operator|.
name|protocol
operator|.
name|proto
operator|.
name|StorageContainerDatanodeProtocolProtos
operator|.
name|SCMHeartbeatResponseProto
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdds
operator|.
name|protocol
operator|.
name|proto
operator|.
name|StorageContainerDatanodeProtocolProtos
operator|.
name|SCMRegisteredResponseProto
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdds
operator|.
name|protocol
operator|.
name|proto
operator|.
name|StorageContainerDatanodeProtocolProtos
operator|.
name|StorageReportProto
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdds
operator|.
name|protocol
operator|.
name|proto
operator|.
name|StorageContainerDatanodeProtocolProtos
operator|.
name|SCMVersionResponseProto
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdds
operator|.
name|scm
operator|.
name|pipeline
operator|.
name|PipelineID
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|ipc
operator|.
name|RPC
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|ozone
operator|.
name|OzoneConfigKeys
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|ozone
operator|.
name|container
operator|.
name|common
operator|.
name|statemachine
operator|.
name|DatanodeStateMachine
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|ozone
operator|.
name|container
operator|.
name|common
operator|.
name|statemachine
operator|.
name|EndpointStateMachine
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|ozone
operator|.
name|container
operator|.
name|common
operator|.
name|statemachine
operator|.
name|StateContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|ozone
operator|.
name|container
operator|.
name|common
operator|.
name|states
operator|.
name|endpoint
operator|.
name|HeartbeatEndpointTask
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|ozone
operator|.
name|container
operator|.
name|common
operator|.
name|states
operator|.
name|endpoint
operator|.
name|RegisterEndpointTask
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|ozone
operator|.
name|container
operator|.
name|common
operator|.
name|states
operator|.
name|endpoint
operator|.
name|VersionEndpointTask
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|ozone
operator|.
name|container
operator|.
name|common
operator|.
name|volume
operator|.
name|HddsVolume
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|ozone
operator|.
name|container
operator|.
name|ozoneimpl
operator|.
name|ContainerController
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|ozone
operator|.
name|container
operator|.
name|ozoneimpl
operator|.
name|OzoneContainer
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|ozone
operator|.
name|protocol
operator|.
name|commands
operator|.
name|CommandStatus
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|test
operator|.
name|GenericTestUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|test
operator|.
name|PathUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|util
operator|.
name|Time
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|AfterClass
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Assert
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|BeforeClass
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Test
import|;
end_import

begin_import
import|import
name|org
operator|.
name|mockito
operator|.
name|Mockito
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdds
operator|.
name|HddsConfigKeys
operator|.
name|OZONE_METADATA_DIRS
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|mockito
operator|.
name|Mockito
operator|.
name|mock
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|File
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|InetSocketAddress
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|UUID
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hdfs
operator|.
name|DFSConfigKeys
operator|.
name|DFS_DATANODE_DATA_DIR_KEY
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|ozone
operator|.
name|container
operator|.
name|common
operator|.
name|ContainerTestUtils
operator|.
name|createEndpoint
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|hamcrest
operator|.
name|Matchers
operator|.
name|lessThanOrEqualTo
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|mockito
operator|.
name|Mockito
operator|.
name|when
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|junit
operator|.
name|Assert
operator|.
name|assertTrue
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|junit
operator|.
name|Assert
operator|.
name|assertEquals
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|junit
operator|.
name|Assert
operator|.
name|assertNotNull
import|;
end_import

begin_comment
comment|/**  * Tests the endpoints.  */
end_comment

begin_class
DECL|class|TestEndPoint
specifier|public
class|class
name|TestEndPoint
block|{
DECL|field|serverAddress
specifier|private
specifier|static
name|InetSocketAddress
name|serverAddress
decl_stmt|;
DECL|field|scmServer
specifier|private
specifier|static
name|RPC
operator|.
name|Server
name|scmServer
decl_stmt|;
DECL|field|scmServerImpl
specifier|private
specifier|static
name|ScmTestMock
name|scmServerImpl
decl_stmt|;
DECL|field|testDir
specifier|private
specifier|static
name|File
name|testDir
decl_stmt|;
DECL|field|config
specifier|private
specifier|static
name|Configuration
name|config
decl_stmt|;
annotation|@
name|AfterClass
DECL|method|tearDown ()
specifier|public
specifier|static
name|void
name|tearDown
parameter_list|()
throws|throws
name|Exception
block|{
if|if
condition|(
name|scmServer
operator|!=
literal|null
condition|)
block|{
name|scmServer
operator|.
name|stop
argument_list|()
expr_stmt|;
block|}
name|FileUtil
operator|.
name|fullyDelete
argument_list|(
name|testDir
argument_list|)
expr_stmt|;
block|}
annotation|@
name|BeforeClass
DECL|method|setUp ()
specifier|public
specifier|static
name|void
name|setUp
parameter_list|()
throws|throws
name|Exception
block|{
name|serverAddress
operator|=
name|SCMTestUtils
operator|.
name|getReuseableAddress
argument_list|()
expr_stmt|;
name|scmServerImpl
operator|=
operator|new
name|ScmTestMock
argument_list|()
expr_stmt|;
name|scmServer
operator|=
name|SCMTestUtils
operator|.
name|startScmRpcServer
argument_list|(
name|SCMTestUtils
operator|.
name|getConf
argument_list|()
argument_list|,
name|scmServerImpl
argument_list|,
name|serverAddress
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|testDir
operator|=
name|PathUtils
operator|.
name|getTestDir
argument_list|(
name|TestEndPoint
operator|.
name|class
argument_list|)
expr_stmt|;
name|config
operator|=
name|SCMTestUtils
operator|.
name|getConf
argument_list|()
expr_stmt|;
name|config
operator|.
name|set
argument_list|(
name|DFS_DATANODE_DATA_DIR_KEY
argument_list|,
name|testDir
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
expr_stmt|;
name|config
operator|.
name|set
argument_list|(
name|OZONE_METADATA_DIRS
argument_list|,
name|testDir
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
expr_stmt|;
name|config
operator|.
name|setBoolean
argument_list|(
name|OzoneConfigKeys
operator|.
name|DFS_CONTAINER_RATIS_IPC_RANDOM_PORT
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|config
operator|.
name|set
argument_list|(
name|HddsConfigKeys
operator|.
name|HDDS_COMMAND_STATUS_REPORT_INTERVAL
argument_list|,
literal|"1s"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
comment|/**    * This test asserts that we are able to make a version call to SCM server    * and gets back the expected values.    */
DECL|method|testGetVersion ()
specifier|public
name|void
name|testGetVersion
parameter_list|()
throws|throws
name|Exception
block|{
try|try
init|(
name|EndpointStateMachine
name|rpcEndPoint
init|=
name|createEndpoint
argument_list|(
name|SCMTestUtils
operator|.
name|getConf
argument_list|()
argument_list|,
name|serverAddress
argument_list|,
literal|1000
argument_list|)
init|)
block|{
name|SCMVersionResponseProto
name|responseProto
init|=
name|rpcEndPoint
operator|.
name|getEndPoint
argument_list|()
operator|.
name|getVersion
argument_list|(
literal|null
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertNotNull
argument_list|(
name|responseProto
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
name|VersionInfo
operator|.
name|DESCRIPTION_KEY
argument_list|,
name|responseProto
operator|.
name|getKeys
argument_list|(
literal|0
argument_list|)
operator|.
name|getKey
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
name|VersionInfo
operator|.
name|getLatestVersion
argument_list|()
operator|.
name|getDescription
argument_list|()
argument_list|,
name|responseProto
operator|.
name|getKeys
argument_list|(
literal|0
argument_list|)
operator|.
name|getValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Test
comment|/**    * We make getVersion RPC call, but via the VersionEndpointTask which is    * how the state machine would make the call.    */
DECL|method|testGetVersionTask ()
specifier|public
name|void
name|testGetVersionTask
parameter_list|()
throws|throws
name|Exception
block|{
name|OzoneConfiguration
name|conf
init|=
name|SCMTestUtils
operator|.
name|getConf
argument_list|()
decl_stmt|;
try|try
init|(
name|EndpointStateMachine
name|rpcEndPoint
init|=
name|createEndpoint
argument_list|(
name|conf
argument_list|,
name|serverAddress
argument_list|,
literal|1000
argument_list|)
init|)
block|{
name|DatanodeDetails
name|datanodeDetails
init|=
name|TestUtils
operator|.
name|randomDatanodeDetails
argument_list|()
decl_stmt|;
name|OzoneContainer
name|ozoneContainer
init|=
operator|new
name|OzoneContainer
argument_list|(
name|datanodeDetails
argument_list|,
name|conf
argument_list|,
name|getContext
argument_list|(
name|datanodeDetails
argument_list|)
argument_list|,
literal|null
argument_list|)
decl_stmt|;
name|rpcEndPoint
operator|.
name|setState
argument_list|(
name|EndpointStateMachine
operator|.
name|EndPointStates
operator|.
name|GETVERSION
argument_list|)
expr_stmt|;
name|VersionEndpointTask
name|versionTask
init|=
operator|new
name|VersionEndpointTask
argument_list|(
name|rpcEndPoint
argument_list|,
name|conf
argument_list|,
name|ozoneContainer
argument_list|)
decl_stmt|;
name|EndpointStateMachine
operator|.
name|EndPointStates
name|newState
init|=
name|versionTask
operator|.
name|call
argument_list|()
decl_stmt|;
comment|// if version call worked the endpoint should automatically move to the
comment|// next state.
name|Assert
operator|.
name|assertEquals
argument_list|(
name|EndpointStateMachine
operator|.
name|EndPointStates
operator|.
name|REGISTER
argument_list|,
name|newState
argument_list|)
expr_stmt|;
comment|// Now rpcEndpoint should remember the version it got from SCM
name|Assert
operator|.
name|assertNotNull
argument_list|(
name|rpcEndPoint
operator|.
name|getVersion
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Test
DECL|method|testCheckVersionResponse ()
specifier|public
name|void
name|testCheckVersionResponse
parameter_list|()
throws|throws
name|Exception
block|{
name|OzoneConfiguration
name|conf
init|=
name|SCMTestUtils
operator|.
name|getConf
argument_list|()
decl_stmt|;
try|try
init|(
name|EndpointStateMachine
name|rpcEndPoint
init|=
name|createEndpoint
argument_list|(
name|conf
argument_list|,
name|serverAddress
argument_list|,
literal|1000
argument_list|)
init|)
block|{
name|GenericTestUtils
operator|.
name|LogCapturer
name|logCapturer
init|=
name|GenericTestUtils
operator|.
name|LogCapturer
operator|.
name|captureLogs
argument_list|(
name|VersionEndpointTask
operator|.
name|LOG
argument_list|)
decl_stmt|;
name|DatanodeDetails
name|datanodeDetails
init|=
name|TestUtils
operator|.
name|randomDatanodeDetails
argument_list|()
decl_stmt|;
name|OzoneContainer
name|ozoneContainer
init|=
operator|new
name|OzoneContainer
argument_list|(
name|datanodeDetails
argument_list|,
name|conf
argument_list|,
name|getContext
argument_list|(
name|datanodeDetails
argument_list|)
argument_list|,
literal|null
argument_list|)
decl_stmt|;
name|rpcEndPoint
operator|.
name|setState
argument_list|(
name|EndpointStateMachine
operator|.
name|EndPointStates
operator|.
name|GETVERSION
argument_list|)
expr_stmt|;
name|VersionEndpointTask
name|versionTask
init|=
operator|new
name|VersionEndpointTask
argument_list|(
name|rpcEndPoint
argument_list|,
name|conf
argument_list|,
name|ozoneContainer
argument_list|)
decl_stmt|;
name|EndpointStateMachine
operator|.
name|EndPointStates
name|newState
init|=
name|versionTask
operator|.
name|call
argument_list|()
decl_stmt|;
comment|// if version call worked the endpoint should automatically move to the
comment|// next state.
name|Assert
operator|.
name|assertEquals
argument_list|(
name|EndpointStateMachine
operator|.
name|EndPointStates
operator|.
name|REGISTER
argument_list|,
name|newState
argument_list|)
expr_stmt|;
comment|// Now rpcEndpoint should remember the version it got from SCM
name|Assert
operator|.
name|assertNotNull
argument_list|(
name|rpcEndPoint
operator|.
name|getVersion
argument_list|()
argument_list|)
expr_stmt|;
comment|// Now change server scmId, so datanode scmId  will be
comment|// different from SCM server response scmId
name|String
name|newScmId
init|=
name|UUID
operator|.
name|randomUUID
argument_list|()
operator|.
name|toString
argument_list|()
decl_stmt|;
name|scmServerImpl
operator|.
name|setScmId
argument_list|(
name|newScmId
argument_list|)
expr_stmt|;
name|rpcEndPoint
operator|.
name|setState
argument_list|(
name|EndpointStateMachine
operator|.
name|EndPointStates
operator|.
name|GETVERSION
argument_list|)
expr_stmt|;
name|newState
operator|=
name|versionTask
operator|.
name|call
argument_list|()
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
name|EndpointStateMachine
operator|.
name|EndPointStates
operator|.
name|SHUTDOWN
argument_list|,
name|newState
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|HddsVolume
argument_list|>
name|volumesList
init|=
name|ozoneContainer
operator|.
name|getVolumeSet
argument_list|()
operator|.
name|getFailedVolumesList
argument_list|()
decl_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
name|volumesList
operator|.
name|size
argument_list|()
operator|==
literal|1
argument_list|)
expr_stmt|;
name|File
name|expectedScmDir
init|=
operator|new
name|File
argument_list|(
name|volumesList
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|.
name|getHddsRootDir
argument_list|()
argument_list|,
name|scmServerImpl
operator|.
name|getScmId
argument_list|()
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
name|logCapturer
operator|.
name|getOutput
argument_list|()
operator|.
name|contains
argument_list|(
literal|"expected scm "
operator|+
literal|"directory "
operator|+
name|expectedScmDir
operator|.
name|getAbsolutePath
argument_list|()
operator|+
literal|" does not "
operator|+
literal|"exist"
argument_list|)
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
name|ozoneContainer
operator|.
name|getVolumeSet
argument_list|()
operator|.
name|getVolumesList
argument_list|()
operator|.
name|size
argument_list|()
operator|==
literal|0
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
name|ozoneContainer
operator|.
name|getVolumeSet
argument_list|()
operator|.
name|getFailedVolumesList
argument_list|()
operator|.
name|size
argument_list|()
operator|==
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Test
comment|/**    * This test makes a call to end point where there is no SCM server. We    * expect that versionTask should be able to handle it.    */
DECL|method|testGetVersionToInvalidEndpoint ()
specifier|public
name|void
name|testGetVersionToInvalidEndpoint
parameter_list|()
throws|throws
name|Exception
block|{
name|OzoneConfiguration
name|conf
init|=
name|SCMTestUtils
operator|.
name|getConf
argument_list|()
decl_stmt|;
name|InetSocketAddress
name|nonExistentServerAddress
init|=
name|SCMTestUtils
operator|.
name|getReuseableAddress
argument_list|()
decl_stmt|;
try|try
init|(
name|EndpointStateMachine
name|rpcEndPoint
init|=
name|createEndpoint
argument_list|(
name|conf
argument_list|,
name|nonExistentServerAddress
argument_list|,
literal|1000
argument_list|)
init|)
block|{
name|rpcEndPoint
operator|.
name|setState
argument_list|(
name|EndpointStateMachine
operator|.
name|EndPointStates
operator|.
name|GETVERSION
argument_list|)
expr_stmt|;
name|DatanodeDetails
name|datanodeDetails
init|=
name|TestUtils
operator|.
name|randomDatanodeDetails
argument_list|()
decl_stmt|;
name|OzoneContainer
name|ozoneContainer
init|=
operator|new
name|OzoneContainer
argument_list|(
name|datanodeDetails
argument_list|,
name|conf
argument_list|,
name|getContext
argument_list|(
name|datanodeDetails
argument_list|)
argument_list|,
literal|null
argument_list|)
decl_stmt|;
name|VersionEndpointTask
name|versionTask
init|=
operator|new
name|VersionEndpointTask
argument_list|(
name|rpcEndPoint
argument_list|,
name|conf
argument_list|,
name|ozoneContainer
argument_list|)
decl_stmt|;
name|EndpointStateMachine
operator|.
name|EndPointStates
name|newState
init|=
name|versionTask
operator|.
name|call
argument_list|()
decl_stmt|;
comment|// This version call did NOT work, so endpoint should remain in the same
comment|// state.
name|Assert
operator|.
name|assertEquals
argument_list|(
name|EndpointStateMachine
operator|.
name|EndPointStates
operator|.
name|GETVERSION
argument_list|,
name|newState
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Test
comment|/**    * This test makes a getVersionRPC call, but the DummyStorageServer is    * going to respond little slowly. We will assert that we are still in the    * GETVERSION state after the timeout.    */
DECL|method|testGetVersionAssertRpcTimeOut ()
specifier|public
name|void
name|testGetVersionAssertRpcTimeOut
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|long
name|rpcTimeout
init|=
literal|1000
decl_stmt|;
specifier|final
name|long
name|tolerance
init|=
literal|100
decl_stmt|;
name|OzoneConfiguration
name|conf
init|=
name|SCMTestUtils
operator|.
name|getConf
argument_list|()
decl_stmt|;
try|try
init|(
name|EndpointStateMachine
name|rpcEndPoint
init|=
name|createEndpoint
argument_list|(
name|conf
argument_list|,
name|serverAddress
argument_list|,
operator|(
name|int
operator|)
name|rpcTimeout
argument_list|)
init|)
block|{
name|rpcEndPoint
operator|.
name|setState
argument_list|(
name|EndpointStateMachine
operator|.
name|EndPointStates
operator|.
name|GETVERSION
argument_list|)
expr_stmt|;
name|DatanodeDetails
name|datanodeDetails
init|=
name|TestUtils
operator|.
name|randomDatanodeDetails
argument_list|()
decl_stmt|;
name|OzoneContainer
name|ozoneContainer
init|=
operator|new
name|OzoneContainer
argument_list|(
name|datanodeDetails
argument_list|,
name|conf
argument_list|,
name|getContext
argument_list|(
name|datanodeDetails
argument_list|)
argument_list|,
literal|null
argument_list|)
decl_stmt|;
name|VersionEndpointTask
name|versionTask
init|=
operator|new
name|VersionEndpointTask
argument_list|(
name|rpcEndPoint
argument_list|,
name|conf
argument_list|,
name|ozoneContainer
argument_list|)
decl_stmt|;
name|scmServerImpl
operator|.
name|setRpcResponseDelay
argument_list|(
literal|1500
argument_list|)
expr_stmt|;
name|long
name|start
init|=
name|Time
operator|.
name|monotonicNow
argument_list|()
decl_stmt|;
name|EndpointStateMachine
operator|.
name|EndPointStates
name|newState
init|=
name|versionTask
operator|.
name|call
argument_list|()
decl_stmt|;
name|long
name|end
init|=
name|Time
operator|.
name|monotonicNow
argument_list|()
decl_stmt|;
name|scmServerImpl
operator|.
name|setRpcResponseDelay
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertThat
argument_list|(
name|end
operator|-
name|start
argument_list|,
name|lessThanOrEqualTo
argument_list|(
name|rpcTimeout
operator|+
name|tolerance
argument_list|)
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
name|EndpointStateMachine
operator|.
name|EndPointStates
operator|.
name|GETVERSION
argument_list|,
name|newState
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Test
DECL|method|testRegister ()
specifier|public
name|void
name|testRegister
parameter_list|()
throws|throws
name|Exception
block|{
name|DatanodeDetails
name|nodeToRegister
init|=
name|TestUtils
operator|.
name|randomDatanodeDetails
argument_list|()
decl_stmt|;
try|try
init|(
name|EndpointStateMachine
name|rpcEndPoint
init|=
name|createEndpoint
argument_list|(
name|SCMTestUtils
operator|.
name|getConf
argument_list|()
argument_list|,
name|serverAddress
argument_list|,
literal|1000
argument_list|)
init|)
block|{
name|SCMRegisteredResponseProto
name|responseProto
init|=
name|rpcEndPoint
operator|.
name|getEndPoint
argument_list|()
operator|.
name|register
argument_list|(
name|nodeToRegister
operator|.
name|getProtoBufMessage
argument_list|()
argument_list|,
name|TestUtils
operator|.
name|createNodeReport
argument_list|(
name|getStorageReports
argument_list|(
name|nodeToRegister
operator|.
name|getUuid
argument_list|()
argument_list|)
argument_list|)
argument_list|,
name|TestUtils
operator|.
name|getRandomContainerReports
argument_list|(
literal|10
argument_list|)
argument_list|,
name|TestUtils
operator|.
name|getRandomPipelineReports
argument_list|()
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertNotNull
argument_list|(
name|responseProto
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
name|nodeToRegister
operator|.
name|getUuidString
argument_list|()
argument_list|,
name|responseProto
operator|.
name|getDatanodeUUID
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertNotNull
argument_list|(
name|responseProto
operator|.
name|getClusterID
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|10
argument_list|,
name|scmServerImpl
operator|.
name|getContainerCountsForDatanode
argument_list|(
name|nodeToRegister
argument_list|)
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|scmServerImpl
operator|.
name|getNodeReportsCount
argument_list|(
name|nodeToRegister
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|getStorageReports (UUID id)
specifier|private
name|StorageReportProto
name|getStorageReports
parameter_list|(
name|UUID
name|id
parameter_list|)
block|{
name|String
name|storagePath
init|=
name|testDir
operator|.
name|getAbsolutePath
argument_list|()
operator|+
literal|"/"
operator|+
name|id
decl_stmt|;
return|return
name|TestUtils
operator|.
name|createStorageReport
argument_list|(
name|id
argument_list|,
name|storagePath
argument_list|,
literal|100
argument_list|,
literal|10
argument_list|,
literal|90
argument_list|,
literal|null
argument_list|)
return|;
block|}
DECL|method|registerTaskHelper (InetSocketAddress scmAddress, int rpcTimeout, boolean clearDatanodeDetails)
specifier|private
name|EndpointStateMachine
name|registerTaskHelper
parameter_list|(
name|InetSocketAddress
name|scmAddress
parameter_list|,
name|int
name|rpcTimeout
parameter_list|,
name|boolean
name|clearDatanodeDetails
parameter_list|)
throws|throws
name|Exception
block|{
name|Configuration
name|conf
init|=
name|SCMTestUtils
operator|.
name|getConf
argument_list|()
decl_stmt|;
name|EndpointStateMachine
name|rpcEndPoint
init|=
name|createEndpoint
argument_list|(
name|conf
argument_list|,
name|scmAddress
argument_list|,
name|rpcTimeout
argument_list|)
decl_stmt|;
name|rpcEndPoint
operator|.
name|setState
argument_list|(
name|EndpointStateMachine
operator|.
name|EndPointStates
operator|.
name|REGISTER
argument_list|)
expr_stmt|;
name|OzoneContainer
name|ozoneContainer
init|=
name|mock
argument_list|(
name|OzoneContainer
operator|.
name|class
argument_list|)
decl_stmt|;
name|when
argument_list|(
name|ozoneContainer
operator|.
name|getNodeReport
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|TestUtils
operator|.
name|createNodeReport
argument_list|(
name|getStorageReports
argument_list|(
name|UUID
operator|.
name|randomUUID
argument_list|()
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|ContainerController
name|controller
init|=
name|Mockito
operator|.
name|mock
argument_list|(
name|ContainerController
operator|.
name|class
argument_list|)
decl_stmt|;
name|when
argument_list|(
name|controller
operator|.
name|getContainerReport
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|TestUtils
operator|.
name|getRandomContainerReports
argument_list|(
literal|10
argument_list|)
argument_list|)
expr_stmt|;
name|when
argument_list|(
name|ozoneContainer
operator|.
name|getController
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|controller
argument_list|)
expr_stmt|;
name|when
argument_list|(
name|ozoneContainer
operator|.
name|getPipelineReport
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|TestUtils
operator|.
name|getRandomPipelineReports
argument_list|()
argument_list|)
expr_stmt|;
name|RegisterEndpointTask
name|endpointTask
init|=
operator|new
name|RegisterEndpointTask
argument_list|(
name|rpcEndPoint
argument_list|,
name|conf
argument_list|,
name|ozoneContainer
argument_list|,
name|mock
argument_list|(
name|StateContext
operator|.
name|class
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|clearDatanodeDetails
condition|)
block|{
name|DatanodeDetails
name|datanodeDetails
init|=
name|TestUtils
operator|.
name|randomDatanodeDetails
argument_list|()
decl_stmt|;
name|endpointTask
operator|.
name|setDatanodeDetails
argument_list|(
name|datanodeDetails
argument_list|)
expr_stmt|;
block|}
name|endpointTask
operator|.
name|call
argument_list|()
expr_stmt|;
return|return
name|rpcEndPoint
return|;
block|}
annotation|@
name|Test
DECL|method|testRegisterTask ()
specifier|public
name|void
name|testRegisterTask
parameter_list|()
throws|throws
name|Exception
block|{
try|try
init|(
name|EndpointStateMachine
name|rpcEndpoint
init|=
name|registerTaskHelper
argument_list|(
name|serverAddress
argument_list|,
literal|1000
argument_list|,
literal|false
argument_list|)
init|)
block|{
comment|// Successful register should move us to Heartbeat state.
name|Assert
operator|.
name|assertEquals
argument_list|(
name|EndpointStateMachine
operator|.
name|EndPointStates
operator|.
name|HEARTBEAT
argument_list|,
name|rpcEndpoint
operator|.
name|getState
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Test
DECL|method|testRegisterToInvalidEndpoint ()
specifier|public
name|void
name|testRegisterToInvalidEndpoint
parameter_list|()
throws|throws
name|Exception
block|{
name|InetSocketAddress
name|address
init|=
name|SCMTestUtils
operator|.
name|getReuseableAddress
argument_list|()
decl_stmt|;
try|try
init|(
name|EndpointStateMachine
name|rpcEndpoint
init|=
name|registerTaskHelper
argument_list|(
name|address
argument_list|,
literal|1000
argument_list|,
literal|false
argument_list|)
init|)
block|{
name|Assert
operator|.
name|assertEquals
argument_list|(
name|EndpointStateMachine
operator|.
name|EndPointStates
operator|.
name|REGISTER
argument_list|,
name|rpcEndpoint
operator|.
name|getState
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Test
DECL|method|testRegisterNoContainerID ()
specifier|public
name|void
name|testRegisterNoContainerID
parameter_list|()
throws|throws
name|Exception
block|{
name|InetSocketAddress
name|address
init|=
name|SCMTestUtils
operator|.
name|getReuseableAddress
argument_list|()
decl_stmt|;
try|try
init|(
name|EndpointStateMachine
name|rpcEndpoint
init|=
name|registerTaskHelper
argument_list|(
name|address
argument_list|,
literal|1000
argument_list|,
literal|true
argument_list|)
init|)
block|{
comment|// No Container ID, therefore we tell the datanode that we would like to
comment|// shutdown.
name|Assert
operator|.
name|assertEquals
argument_list|(
name|EndpointStateMachine
operator|.
name|EndPointStates
operator|.
name|SHUTDOWN
argument_list|,
name|rpcEndpoint
operator|.
name|getState
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Test
DECL|method|testRegisterRpcTimeout ()
specifier|public
name|void
name|testRegisterRpcTimeout
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|long
name|rpcTimeout
init|=
literal|1000
decl_stmt|;
specifier|final
name|long
name|tolerance
init|=
literal|200
decl_stmt|;
name|scmServerImpl
operator|.
name|setRpcResponseDelay
argument_list|(
literal|1500
argument_list|)
expr_stmt|;
name|long
name|start
init|=
name|Time
operator|.
name|monotonicNow
argument_list|()
decl_stmt|;
name|registerTaskHelper
argument_list|(
name|serverAddress
argument_list|,
literal|1000
argument_list|,
literal|false
argument_list|)
operator|.
name|close
argument_list|()
expr_stmt|;
name|long
name|end
init|=
name|Time
operator|.
name|monotonicNow
argument_list|()
decl_stmt|;
name|scmServerImpl
operator|.
name|setRpcResponseDelay
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertThat
argument_list|(
name|end
operator|-
name|start
argument_list|,
name|lessThanOrEqualTo
argument_list|(
name|rpcTimeout
operator|+
name|tolerance
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testHeartbeat ()
specifier|public
name|void
name|testHeartbeat
parameter_list|()
throws|throws
name|Exception
block|{
name|DatanodeDetails
name|dataNode
init|=
name|TestUtils
operator|.
name|randomDatanodeDetails
argument_list|()
decl_stmt|;
try|try
init|(
name|EndpointStateMachine
name|rpcEndPoint
init|=
name|createEndpoint
argument_list|(
name|SCMTestUtils
operator|.
name|getConf
argument_list|()
argument_list|,
name|serverAddress
argument_list|,
literal|1000
argument_list|)
init|)
block|{
name|SCMHeartbeatRequestProto
name|request
init|=
name|SCMHeartbeatRequestProto
operator|.
name|newBuilder
argument_list|()
operator|.
name|setDatanodeDetails
argument_list|(
name|dataNode
operator|.
name|getProtoBufMessage
argument_list|()
argument_list|)
operator|.
name|setNodeReport
argument_list|(
name|TestUtils
operator|.
name|createNodeReport
argument_list|(
name|getStorageReports
argument_list|(
name|UUID
operator|.
name|randomUUID
argument_list|()
argument_list|)
argument_list|)
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
name|SCMHeartbeatResponseProto
name|responseProto
init|=
name|rpcEndPoint
operator|.
name|getEndPoint
argument_list|()
operator|.
name|sendHeartbeat
argument_list|(
name|request
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertNotNull
argument_list|(
name|responseProto
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|0
argument_list|,
name|responseProto
operator|.
name|getCommandsCount
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Test
DECL|method|testHeartbeatWithCommandStatusReport ()
specifier|public
name|void
name|testHeartbeatWithCommandStatusReport
parameter_list|()
throws|throws
name|Exception
block|{
name|DatanodeDetails
name|dataNode
init|=
name|TestUtils
operator|.
name|randomDatanodeDetails
argument_list|()
decl_stmt|;
try|try
init|(
name|EndpointStateMachine
name|rpcEndPoint
init|=
name|createEndpoint
argument_list|(
name|SCMTestUtils
operator|.
name|getConf
argument_list|()
argument_list|,
name|serverAddress
argument_list|,
literal|1000
argument_list|)
init|)
block|{
comment|// Add some scmCommands for heartbeat response
name|addScmCommands
argument_list|()
expr_stmt|;
name|SCMHeartbeatRequestProto
name|request
init|=
name|SCMHeartbeatRequestProto
operator|.
name|newBuilder
argument_list|()
operator|.
name|setDatanodeDetails
argument_list|(
name|dataNode
operator|.
name|getProtoBufMessage
argument_list|()
argument_list|)
operator|.
name|setNodeReport
argument_list|(
name|TestUtils
operator|.
name|createNodeReport
argument_list|(
name|getStorageReports
argument_list|(
name|UUID
operator|.
name|randomUUID
argument_list|()
argument_list|)
argument_list|)
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
name|SCMHeartbeatResponseProto
name|responseProto
init|=
name|rpcEndPoint
operator|.
name|getEndPoint
argument_list|()
operator|.
name|sendHeartbeat
argument_list|(
name|request
argument_list|)
decl_stmt|;
name|assertNotNull
argument_list|(
name|responseProto
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|3
argument_list|,
name|responseProto
operator|.
name|getCommandsCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|0
argument_list|,
name|scmServerImpl
operator|.
name|getCommandStatusReportCount
argument_list|()
argument_list|)
expr_stmt|;
comment|// Send heartbeat again from heartbeat endpoint task
specifier|final
name|StateContext
name|stateContext
init|=
name|heartbeatTaskHelper
argument_list|(
name|serverAddress
argument_list|,
literal|3000
argument_list|)
decl_stmt|;
name|Map
argument_list|<
name|Long
argument_list|,
name|CommandStatus
argument_list|>
name|map
init|=
name|stateContext
operator|.
name|getCommandStatusMap
argument_list|()
decl_stmt|;
name|assertNotNull
argument_list|(
name|map
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Should have 1 objects"
argument_list|,
literal|1
argument_list|,
name|map
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|map
operator|.
name|containsKey
argument_list|(
literal|3L
argument_list|)
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|Type
operator|.
name|deleteBlocksCommand
argument_list|,
name|map
operator|.
name|get
argument_list|(
literal|3L
argument_list|)
operator|.
name|getType
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|Status
operator|.
name|PENDING
argument_list|,
name|map
operator|.
name|get
argument_list|(
literal|3L
argument_list|)
operator|.
name|getStatus
argument_list|()
argument_list|)
expr_stmt|;
name|scmServerImpl
operator|.
name|clearScmCommandRequests
argument_list|()
expr_stmt|;
block|}
block|}
DECL|method|addScmCommands ()
specifier|private
name|void
name|addScmCommands
parameter_list|()
block|{
name|SCMCommandProto
name|closeCommand
init|=
name|SCMCommandProto
operator|.
name|newBuilder
argument_list|()
operator|.
name|setCloseContainerCommandProto
argument_list|(
name|CloseContainerCommandProto
operator|.
name|newBuilder
argument_list|()
operator|.
name|setCmdId
argument_list|(
literal|1
argument_list|)
operator|.
name|setContainerID
argument_list|(
literal|1
argument_list|)
operator|.
name|setPipelineID
argument_list|(
name|PipelineID
operator|.
name|randomId
argument_list|()
operator|.
name|getProtobuf
argument_list|()
argument_list|)
operator|.
name|build
argument_list|()
argument_list|)
operator|.
name|setCommandType
argument_list|(
name|Type
operator|.
name|closeContainerCommand
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
name|SCMCommandProto
name|replicationCommand
init|=
name|SCMCommandProto
operator|.
name|newBuilder
argument_list|()
operator|.
name|setReplicateContainerCommandProto
argument_list|(
name|ReplicateContainerCommandProto
operator|.
name|newBuilder
argument_list|()
operator|.
name|setCmdId
argument_list|(
literal|2
argument_list|)
operator|.
name|setContainerID
argument_list|(
literal|2
argument_list|)
operator|.
name|build
argument_list|()
argument_list|)
operator|.
name|setCommandType
argument_list|(
name|Type
operator|.
name|replicateContainerCommand
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
name|SCMCommandProto
name|deleteBlockCommand
init|=
name|SCMCommandProto
operator|.
name|newBuilder
argument_list|()
operator|.
name|setDeleteBlocksCommandProto
argument_list|(
name|DeleteBlocksCommandProto
operator|.
name|newBuilder
argument_list|()
operator|.
name|setCmdId
argument_list|(
literal|3
argument_list|)
operator|.
name|addDeletedBlocksTransactions
argument_list|(
name|DeletedBlocksTransaction
operator|.
name|newBuilder
argument_list|()
operator|.
name|setContainerID
argument_list|(
literal|45
argument_list|)
operator|.
name|setCount
argument_list|(
literal|1
argument_list|)
operator|.
name|setTxID
argument_list|(
literal|23
argument_list|)
operator|.
name|build
argument_list|()
argument_list|)
operator|.
name|build
argument_list|()
argument_list|)
operator|.
name|setCommandType
argument_list|(
name|Type
operator|.
name|deleteBlocksCommand
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
name|scmServerImpl
operator|.
name|addScmCommandRequest
argument_list|(
name|closeCommand
argument_list|)
expr_stmt|;
name|scmServerImpl
operator|.
name|addScmCommandRequest
argument_list|(
name|deleteBlockCommand
argument_list|)
expr_stmt|;
name|scmServerImpl
operator|.
name|addScmCommandRequest
argument_list|(
name|replicationCommand
argument_list|)
expr_stmt|;
block|}
DECL|method|heartbeatTaskHelper (InetSocketAddress scmAddress, int rpcTimeout)
specifier|private
name|StateContext
name|heartbeatTaskHelper
parameter_list|(
name|InetSocketAddress
name|scmAddress
parameter_list|,
name|int
name|rpcTimeout
parameter_list|)
throws|throws
name|Exception
block|{
name|Configuration
name|conf
init|=
name|SCMTestUtils
operator|.
name|getConf
argument_list|()
decl_stmt|;
name|conf
operator|.
name|set
argument_list|(
name|DFS_DATANODE_DATA_DIR_KEY
argument_list|,
name|testDir
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
expr_stmt|;
name|conf
operator|.
name|set
argument_list|(
name|OZONE_METADATA_DIRS
argument_list|,
name|testDir
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
expr_stmt|;
comment|// Mini Ozone cluster will not come up if the port is not true, since
comment|// Ratis will exit if the server port cannot be bound. We can remove this
comment|// hard coding once we fix the Ratis default behaviour.
name|conf
operator|.
name|setBoolean
argument_list|(
name|OzoneConfigKeys
operator|.
name|DFS_CONTAINER_RATIS_IPC_RANDOM_PORT
argument_list|,
literal|true
argument_list|)
expr_stmt|;
comment|// Create a datanode state machine for stateConext used by endpoint task
try|try
init|(
name|DatanodeStateMachine
name|stateMachine
init|=
operator|new
name|DatanodeStateMachine
argument_list|(
name|TestUtils
operator|.
name|randomDatanodeDetails
argument_list|()
argument_list|,
name|conf
argument_list|,
literal|null
argument_list|)
init|;
name|EndpointStateMachine
name|rpcEndPoint
operator|=
name|createEndpoint
argument_list|(
name|conf
argument_list|,
name|scmAddress
argument_list|,
name|rpcTimeout
argument_list|)
init|)
block|{
name|HddsProtos
operator|.
name|DatanodeDetailsProto
name|datanodeDetailsProto
init|=
name|TestUtils
operator|.
name|randomDatanodeDetails
argument_list|()
operator|.
name|getProtoBufMessage
argument_list|()
decl_stmt|;
name|rpcEndPoint
operator|.
name|setState
argument_list|(
name|EndpointStateMachine
operator|.
name|EndPointStates
operator|.
name|HEARTBEAT
argument_list|)
expr_stmt|;
specifier|final
name|StateContext
name|stateContext
init|=
operator|new
name|StateContext
argument_list|(
name|conf
argument_list|,
name|DatanodeStateMachine
operator|.
name|DatanodeStates
operator|.
name|RUNNING
argument_list|,
name|stateMachine
argument_list|)
decl_stmt|;
name|HeartbeatEndpointTask
name|endpointTask
init|=
operator|new
name|HeartbeatEndpointTask
argument_list|(
name|rpcEndPoint
argument_list|,
name|conf
argument_list|,
name|stateContext
argument_list|)
decl_stmt|;
name|endpointTask
operator|.
name|setDatanodeDetailsProto
argument_list|(
name|datanodeDetailsProto
argument_list|)
expr_stmt|;
name|endpointTask
operator|.
name|call
argument_list|()
expr_stmt|;
name|Assert
operator|.
name|assertNotNull
argument_list|(
name|endpointTask
operator|.
name|getDatanodeDetailsProto
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
name|EndpointStateMachine
operator|.
name|EndPointStates
operator|.
name|HEARTBEAT
argument_list|,
name|rpcEndPoint
operator|.
name|getState
argument_list|()
argument_list|)
expr_stmt|;
return|return
name|stateContext
return|;
block|}
block|}
annotation|@
name|Test
DECL|method|testHeartbeatTask ()
specifier|public
name|void
name|testHeartbeatTask
parameter_list|()
throws|throws
name|Exception
block|{
name|heartbeatTaskHelper
argument_list|(
name|serverAddress
argument_list|,
literal|1000
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testHeartbeatTaskToInvalidNode ()
specifier|public
name|void
name|testHeartbeatTaskToInvalidNode
parameter_list|()
throws|throws
name|Exception
block|{
name|InetSocketAddress
name|invalidAddress
init|=
name|SCMTestUtils
operator|.
name|getReuseableAddress
argument_list|()
decl_stmt|;
name|heartbeatTaskHelper
argument_list|(
name|invalidAddress
argument_list|,
literal|1000
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testHeartbeatTaskRpcTimeOut ()
specifier|public
name|void
name|testHeartbeatTaskRpcTimeOut
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|long
name|rpcTimeout
init|=
literal|1000
decl_stmt|;
specifier|final
name|long
name|tolerance
init|=
literal|200
decl_stmt|;
name|scmServerImpl
operator|.
name|setRpcResponseDelay
argument_list|(
literal|1500
argument_list|)
expr_stmt|;
name|long
name|start
init|=
name|Time
operator|.
name|monotonicNow
argument_list|()
decl_stmt|;
name|InetSocketAddress
name|invalidAddress
init|=
name|SCMTestUtils
operator|.
name|getReuseableAddress
argument_list|()
decl_stmt|;
name|heartbeatTaskHelper
argument_list|(
name|invalidAddress
argument_list|,
literal|1000
argument_list|)
expr_stmt|;
name|long
name|end
init|=
name|Time
operator|.
name|monotonicNow
argument_list|()
decl_stmt|;
name|scmServerImpl
operator|.
name|setRpcResponseDelay
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertThat
argument_list|(
name|end
operator|-
name|start
argument_list|,
name|lessThanOrEqualTo
argument_list|(
name|rpcTimeout
operator|+
name|tolerance
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|getContext (DatanodeDetails datanodeDetails)
specifier|private
name|StateContext
name|getContext
parameter_list|(
name|DatanodeDetails
name|datanodeDetails
parameter_list|)
block|{
name|DatanodeStateMachine
name|stateMachine
init|=
name|Mockito
operator|.
name|mock
argument_list|(
name|DatanodeStateMachine
operator|.
name|class
argument_list|)
decl_stmt|;
name|StateContext
name|context
init|=
name|Mockito
operator|.
name|mock
argument_list|(
name|StateContext
operator|.
name|class
argument_list|)
decl_stmt|;
name|Mockito
operator|.
name|when
argument_list|(
name|stateMachine
operator|.
name|getDatanodeDetails
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|datanodeDetails
argument_list|)
expr_stmt|;
name|Mockito
operator|.
name|when
argument_list|(
name|context
operator|.
name|getParent
argument_list|()
argument_list|)
operator|.
name|thenReturn
argument_list|(
name|stateMachine
argument_list|)
expr_stmt|;
return|return
name|context
return|;
block|}
block|}
end_class

end_unit

